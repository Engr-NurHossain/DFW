using HS.Entities;
using Rotativa;
using System;
using System.IO;
using System.Collections.Generic;
using System.Linq;
using System.Drawing;
using System.Web;
using System.Web.Mvc;
using Rotativa.Options;
using HS.Web.UI.Helper;
using System.Configuration;
using HS.Payments.RecurringBilling;
using HS.Payments.CustomerProfiles;
using AuthorizeNet.Api.Contracts.V1;
using Newtonsoft.Json;
using System.Text.RegularExpressions;
using HS.Framework;
using HS.Alarm.CustomerManager;
using HtmlAgilityPack;
using System.Net;
using HS.Framework.Utils;
using System.Reflection;
using HS.Web.UI.Controllers;
using Forte.Entities;
using Forte;
using System.Globalization;
using HS.Kickbox.Models;
using System.Net.Http;
using HS.Entities.Custom;
using System.Xml.Linq;
using System.Text;

using HS.Web.UI.Models;
using PermissionList = HS.Framework.UserPermissions;
using PermissionChecker = HS.Web.UI.Helper.PermissionHelper;
using System.Web.Routing;
using System.Data;
using System.Net.Mail;
using System.Net.Mime;
using NLog;
using OS.AWS.S3;
using OS.AWS.S3.Services;
using System.Threading;
using iTextSharp.text.pdf.qrcode;
using System.Threading.Tasks;

namespace HS.Web.UI.Controllers
{
    public class CustomerController : BaseController
    {
        public CustomerController()
        {
            logger = LogManager.GetCurrentClassLogger();
        }

        [Authorize]
        // GET: Customer
        public ActionResult Index(int? id)
        {
            if (!base.SetLayoutCommons())
            {
                return RedirectToAction("Logout", "Login");
            }
            if (id.HasValue)
            {
                ViewBag.id = id.Value;
            }
            else
            {
                ViewBag.id = 0;
            }

            return View();
        }
        [Authorize]
        public PartialViewResult CustomerCreditBalanceTransactions(Guid CustomerId)
        {
            List<CustomerCredit> Model = _Util.Facade.TransactionFacade.GetCustomerCreditListByCustomerId(CustomerId);
            ViewBag.TotalCreditAmount = _Util.Facade.TransactionFacade.GetCustomerCreditAmountByCustomerId(CustomerId);
            var creditReasons = _Util.Facade.LookupFacade.GetLookupByKey("CreditReasons").Select(x =>
       new
       {
           Text = x.DisplayText.ToString(),
           Value = x.DataValue.ToString()
       }).ToList();

            ViewBag.CreditReasons = JsonConvert.SerializeObject(creditReasons);
            var creditTypes = _Util.Facade.LookupFacade.GetLookupByKey("CreditType").Select(x =>
        new
        {
            Text = x.DisplayText.ToString(),
            Value = x.DataValue.ToString()
        }).ToList();
         
            ViewBag.CreditType = JsonConvert.SerializeObject(creditTypes);
            return PartialView("_CustomerCreditBalanceTransactions", Model);
        }
        public PartialViewResult CustomerPartial(string firstdate, string lastdate)
        {
            var currentLoggedIn = ((HS.Web.UI.Helper.CustomPrincipal)(User));

            ViewBag.firstdate = firstdate;
            ViewBag.lastdate = lastdate;
            if (currentLoggedIn != null)
            {
                //return PartialView("_Customer");
                return PartialView("_Customer");
            }
            else
            {
                return PartialView();
            }
        }

        public PartialViewResult CustomerPartialLite(string firstdate, string lastdate)
        {
            var CurrentUser = ((HS.Web.UI.Helper.CustomPrincipal)(User));

            //ViewBag.firstdate = firstdate;
            //ViewBag.lastdate = lastdate;

            #region Customer Header Generate
            //CustomerHeaderMoneyAndfliterBar customerHeaderMoneyAndfliterBarModel = new CustomerHeaderMoneyAndfliterBar();
            //customerHeaderMoneyAndfliterBarModel.CustomerHeaderfliterBarModel = new CustomerHeaderfliterBar();
            //customerHeaderMoneyAndfliterBarModel.CustomerHeaderMoneyBarModel = new CustomerHeaderMoneyBar();

            //var CurrentLoggedInUser = (HS.Web.UI.Helper.CustomPrincipal)User;
            //string tmmr = CurrentLoggedInUser.UserTags;
            //if (IsPermitted(UserPermissions.CustomerPermissions.CustomerSummmery))
            //{
            //    var ispermit = IsPermitted(UserPermissions.CustomerPermissions.ShowAllCustomerList);
            //    customerHeaderMoneyAndfliterBarModel.CustomerHeaderMoneyBarModel = _Util.Facade.CustomerFacade.GetAllCustomerCountTotalRMREstimateAmountByCompanyId(CurrentLoggedInUser.CompanyId.Value, tmmr, CurrentLoggedInUser.UserId, ispermit);

            //}
            //customerHeaderMoneyAndfliterBarModel.Firstdate = firstdate;
            //customerHeaderMoneyAndfliterBarModel.Lastdate = lastdate;
            //int PageSize = 15;
            //int totalcustomer = int.Parse( customerHeaderMoneyAndfliterBarModel.CustomerHeaderMoneyBarModel.CustomerCount);
            //ViewBag.PageNumber = 1;
            //ViewBag.OutOfNumber = 0;
            //ViewBag.order = null;
            //if (ViewBag.order == null)
            //{
            //    ViewBag.order = 0;
            //}
            //if (totalcustomer > 0)
            //{
            //    ViewBag.OutOfNumber = totalcustomer;
            //}

            //if ((int)ViewBag.PageNumber * PageSize > (int)ViewBag.OutOfNumber)
            //{
            //    ViewBag.CurrentNumber = (int)ViewBag.OutOfNumber;
            //}
            //else
            //{
            //    ViewBag.CurrentNumber = (int)ViewBag.PageNumber * PageSize;
            //}
            //ViewBag.PageCount = Math.Ceiling((double)ViewBag.OutOfNumber / PageSize);


            #endregion
            string path = Server.MapPath(string.Format(AppConfig.CustomerTemplateFile, CurrentUser.CompanyId.ToString()));
            if (Session["ExistPath"] == null)
            {
                GenerateCustsomerList();
                Session["ExistPath"] = "True";
            }
            return PartialView("_CustomerLite");


        }
        public PartialViewResult ServiceProductPartial()
        {
            return PartialView("_ServiceProduct");
        }
        [Authorize]
        public PartialViewResult CustomerSnapshot(int id)
        {
            var currentLoggedIn = ((HS.Web.UI.Helper.CustomPrincipal)(User));
            //bool result = _Util.Facade.CustomerFacade.CustomerIsInCompany(id, currentLoggedIn.CompanyId.Value);
            //if (!result)
            //{
            //    return PartialView("~/Views/Shared/_AccessDenied.cshtml");
            //}
            Customer Customer = _Util.Facade.CustomerFacade.GetById(id);
            if (Customer == null)
            {
                return PartialView("~/Views/Shared/_AccessDenied.cshtml");
            }
            List<CustomerSnapshot> CustomerSnapshot = _Util.Facade.CustomerSnapshotFacade.GetAllCustomerSnapshotByCustomerIdAndCompanyId(Customer.CustomerId, currentLoggedIn.CompanyId.Value);

            return PartialView("_CustomerSnapshot", CustomerSnapshot);
        }
        [Authorize]
        public PartialViewResult ProductCategoryPartial()
        {
            if (!base.IsPermitted(UserPermissions.MenuPermissions.QuickMenuProductsProductCatagories))
            {
                return PartialView("~/Views/Shared/_AccessDenied.cshtml");
            }
            //var currentLoggedIn = ((HS.Web.UI.Helper.CustomPrincipal)(User));
            //List<EquipmentType> ProductCataegory = _Util.Facade.EquipmentTypeFacade.GetAllProductCategoryByCompanyId(currentLoggedIn.CompanyId.Value).OrderBy(x => x.Name).ToList();
            return PartialView("_ProductCategory");
        }
        [Authorize]
        public PartialViewResult ProductCategoryListLoadPartial(string SearchText, int PageNo, string OrderBy)
        {
            var currentLoggedIn = ((HS.Web.UI.Helper.CustomPrincipal)(User));
            int PageItem = 10;
            int OutOfNumber = 0;
            int CurrentNumber = 0;
            int PageCount = 1;
            List<int> IdList = new List<int>();
            List<EquipmentTypeListViewByFilterModel> ParentList = new List<EquipmentTypeListViewByFilterModel>();
            List<EquipmentTypeListViewByFilterModel> ChildList = new List<EquipmentTypeListViewByFilterModel>();
            List<EquipmentTypeListViewByFilterModel> StoreList = new List<EquipmentTypeListViewByFilterModel>();
            List<EquipmentTypeListViewByFilterModel> ResultModel = _Util.Facade.EquipmentTypeFacade.GetAllProductCategoryByUserFilter(currentLoggedIn.CompanyId.Value);
            if (ResultModel != null && ResultModel.Count > 0)
            {
                if (!string.IsNullOrEmpty(SearchText) && !string.IsNullOrWhiteSpace(SearchText))
                {
                    StoreList = ResultModel;
                    ResultModel = ResultModel.Where(x => x.Name.Contains(SearchText)).Select(y => y).ToList();
                }
                if (OrderBy.ToLower() == "desc")
                {
                    ParentList = ResultModel.Where(x => x.ParentId == 0).OrderByDescending(y => y.Name).ToList();
                    ChildList = ResultModel.Where(x => x.ParentId > 0).OrderByDescending(y => y.Name).ToList();
                }
                else
                {
                    ParentList = ResultModel.Where(x => x.ParentId == 0).OrderBy(y => y.Name).ToList();
                    ChildList = ResultModel.Where(x => x.ParentId > 0).OrderBy(y => y.Name).ToList();
                }
                if (PageNo < 1) { PageNo = 1; }
                int ItemCountNumber = ParentList.Count;
                int skip = PageItem * (PageNo - 1);
                if (skip < ItemCountNumber)
                {
                    ParentList = ParentList.Select(p => p).Skip(skip).Take(PageItem).ToList();
                }
                else
                {
                    ParentList = ParentList.Select(p => p).Take(PageItem).ToList();
                }

                if (ParentList != null && ParentList.Count > 0 && ChildList != null && ChildList.Count > 0)
                {
                    foreach (var item in ChildList)
                    {
                        string[] ArrValue = item.CategoryId.Split('>');
                        foreach (var category in ParentList)
                        {
                            if (ArrValue[0] == category.Id.ToString() && ArrValue.Length > 1)
                            {
                                for (int i = 1; i < ArrValue.Length; i++)
                                {
                                    int IntValue = 0;
                                    if (int.TryParse(ArrValue[i], out IntValue))
                                    {
                                        IdList.Add(IntValue);
                                    }
                                }
                            }
                        }
                    }
                }
                else if (ParentList.Count == 0 && ChildList != null && ChildList.Count > 0)
                {
                    foreach (var item in ChildList)
                    {
                        string[] ArrValue = item.CategoryId.Split('>');
                        if (ArrValue.Length > 0)
                        {
                            for (int i = 0; i < ArrValue.Length; i++)
                            {
                                int IntValue = 0;
                                if (int.TryParse(ArrValue[i], out IntValue))
                                {
                                    IdList.Add(IntValue);
                                }
                            }
                        }
                    }
                }
                int ParentCount = ParentList.Count;
                IdList = IdList.GroupBy(x => x).Where(g => g.Count() > 0).Select(y => y.Key).ToList();
                if (StoreList != null && ResultModel != null && StoreList.Count > ResultModel.Count)
                {
                    if (OrderBy.ToLower() == "desc")
                    {
                        ResultModel = StoreList.Where(x => IdList.Contains(x.Id)).OrderByDescending(y => y.Name).ToList();
                    }
                    else
                    {
                        ResultModel = StoreList.Where(x => IdList.Contains(x.Id)).OrderBy(y => y.Name).ToList();
                    }
                }
                else
                {
                    ResultModel = ResultModel.Where(x => IdList.Contains(x.Id)).ToList();
                }
                ParentList.AddRange(ResultModel);
                if (ParentCount == 0)
                {
                    ItemCountNumber = ParentList.Count;
                    ParentCount = ItemCountNumber;
                }
                if (ItemCountNumber > PageItem)
                {
                    string PageCountNumber = (Convert.ToDouble(ItemCountNumber) / Convert.ToDouble(PageItem)).ToString("N2");
                    if (float.Parse(PageCountNumber) % 1 != 0) { PageCount = Convert.ToInt32(float.Parse(PageCountNumber) + 1); }
                    else { PageCount = Convert.ToInt32(float.Parse(PageCountNumber)); }
                    if (PageNo > 1)
                    {
                        int NumberValue = (PageNo - 1) * PageItem;
                        CurrentNumber = NumberValue + ParentCount;
                        OutOfNumber = ItemCountNumber;
                    }
                    else
                    {
                        CurrentNumber = PageItem;
                        OutOfNumber = ItemCountNumber;
                    }

                }
                else
                {
                    CurrentNumber = ParentCount;
                    OutOfNumber = ItemCountNumber;
                }
            }
            ViewBag.PageNumber = PageNo;
            ViewBag.PageCount = PageCount;
            ViewBag.CurrentNumber = CurrentNumber;
            ViewBag.OutOfNumber = OutOfNumber;
            ViewBag.OrderBy = OrderBy;
            return PartialView("_ProductCategoryPartial", ParentList);
        }
        public PartialViewResult CustomersListPartial(string firstdate, string lastdate)
        {

            var CurrentLoggedInUser = (HS.Web.UI.Helper.CustomPrincipal)User;
            string tmmr = CurrentLoggedInUser.UserTags;
            //if (CurrentLoggedInUser.UserId != new Guid())
            //{
            //    var objemployee = _Util.Facade.EmployeeFacade.GetEmployeeRoleByEmployeeIdAndCompanyId(CurrentLoggedInUser.UserId, CurrentLoggedInUser.CompanyId.Value);
            //    if (objemployee != null)
            //    {
            //        tmmr = objemployee.Tag;
            //    }
            //}
            //List<Customer> customers = _Util.Facade.CustomerFacade.GetAllCustomersByCompanyId(CurrentLoggedInUser.CompanyId.Value);
            //  List<Customer> customers = _Util.Facade.CustomerFacade.GetAllCustomerListByCompanyId(CurrentLoggedInUser.CompanyId.Value);

            CustomerHeaderMoneyAndfliterBar customerHeaderMoneyAndfliterBarModel = new CustomerHeaderMoneyAndfliterBar();
            customerHeaderMoneyAndfliterBarModel.CustomerHeaderfliterBarModel = new CustomerHeaderfliterBar();
            customerHeaderMoneyAndfliterBarModel.CustomerHeaderMoneyBarModel = new CustomerHeaderMoneyBar();


            if (IsPermitted(UserPermissions.CustomerPermissions.CustomerSummmery))
            {
                var ispermit = IsPermitted(UserPermissions.CustomerPermissions.ShowAllCustomerList);
                customerHeaderMoneyAndfliterBarModel.CustomerHeaderMoneyBarModel = _Util.Facade.CustomerFacade.GetAllCustomerCountTotalRMREstimateAmountByCompanyId(CurrentLoggedInUser.CompanyId.Value, tmmr, CurrentLoggedInUser.UserId, ispermit);

            }

            customerHeaderMoneyAndfliterBarModel.Firstdate = firstdate;
            customerHeaderMoneyAndfliterBarModel.Lastdate = lastdate;



            #region Sales Person List
            List<SelectListItem> SalesList = new List<SelectListItem>();
            if (IsPermitted(UserPermissions.MyCompanyPermissions.ShowAllSalesPerson))
            {
                SalesList.Add(new SelectListItem()
                {
                    Text = "Sales People",
                    Value = "-1"
                });
                List<Employee> EmployeeDropDown = _Util.Facade.EmployeeFacade.GetEmployeeByCompanyIdAndTag(CurrentLoggedInUser.CompanyId.Value, LabelHelper.UserTags.SalesPerson, new Guid(), LabelHelper.UserTags.Partner);
                if (EmployeeDropDown != null && EmployeeDropDown.Count > 0)
                {
                    SalesList.AddRange(EmployeeDropDown.OrderBy(x => x.FirstName).Select(x => new SelectListItem()
                    {
                        Text = x.FirstName.ToString() + " " + x.LastName.ToString(),
                        Value = x.UserId.ToString()
                    }).ToList());
                }




                //ViewBag.LeadUserList = SalesList;
                customerHeaderMoneyAndfliterBarModel.CustomerHeaderfliterBarModel.SalesUserList = SalesList;

            }
            else
            {
                SalesList.Add(new SelectListItem()
                {
                    Text = "Sales People",
                    Value = "-1"
                });
                List<Employee> emplst = _Util.Facade.EmployeeFacade.GetEmployeeByCompanyIdAndTag(CurrentLoggedInUser.CompanyId.Value, LabelHelper.UserTags.SalesPerson, new Guid(), LabelHelper.UserTags.Partner);
                if (emplst.Where(x => x.UserId == CurrentLoggedInUser.UserId).Count() > 0)
                {
                    var objemp = _Util.Facade.EmployeeFacade.GetEmployeeByEmployeeId(CurrentLoggedInUser.UserId);
                    if (objemp != null)
                    {
                        SalesList.Add(new SelectListItem()
                        {
                            Text = objemp.FirstName.ToString() + " " + objemp.LastName.ToString(),
                            Value = objemp.UserId.ToString()
                        });
                    }
                }
                //ViewBag.LeadUserList = SalesList;
                customerHeaderMoneyAndfliterBarModel.CustomerHeaderfliterBarModel.SalesUserList = SalesList;
            }
            #endregion

            #region Technician List

            if (IsPermitted(UserPermissions.CustomerPermissions.TechFilter))
            {
                List<SelectListItem> TechList = new List<SelectListItem>();
                if (CurrentLoggedInUser.UserRole == LabelHelper.UserTypes.Admin || CurrentLoggedInUser.UserRole == LabelHelper.UserTypes.SysAdmin)
                {
                    TechList.Add(new SelectListItem()
                    {
                        Text = "Technician",
                        Value = "-1"
                    });
                    List<Employee> EmployeeList = _Util.Facade.EmployeeFacade.GetEmployeeByCompanyIdAndTag(CurrentLoggedInUser.CompanyId.Value, LabelHelper.UserTags.Technicians, new Guid());
                    if (EmployeeList != null && EmployeeList.Count > 0)
                    {
                        TechList.AddRange(EmployeeList.OrderBy(x => x.FirstName).Select(x => new SelectListItem()
                        {
                            Text = x.FirstName.ToString() + " " + x.LastName.ToString(),
                            Value = x.UserId.ToString()
                        }).ToList());
                    }

                    //ViewBag.LeadUserList = SalesList;
                    customerHeaderMoneyAndfliterBarModel.CustomerHeaderfliterBarModel.TechUserList = TechList;

                }
                else
                {
                    SalesList.Add(new SelectListItem()
                    {
                        Text = "Technician",
                        Value = "-1"
                    });
                    List<Employee> emplst = _Util.Facade.EmployeeFacade.GetEmployeeByCompanyIdAndTag(CurrentLoggedInUser.CompanyId.Value, LabelHelper.UserTags.Technicians, new Guid());
                    if (emplst.Where(x => x.UserId == CurrentLoggedInUser.UserId).Count() > 0)
                    {
                        var objemp = _Util.Facade.EmployeeFacade.GetEmployeeByEmployeeId(CurrentLoggedInUser.UserId);
                        if (objemp != null)
                        {
                            TechList.Add(new SelectListItem()
                            {
                                Text = objemp.FirstName.ToString() + " " + objemp.LastName.ToString(),
                                Value = objemp.UserId.ToString()
                            });
                        }
                    }
                    //ViewBag.LeadUserList = SalesList;
                    customerHeaderMoneyAndfliterBarModel.CustomerHeaderfliterBarModel.TechUserList = TechList;
                }
            }


            #endregion

            //ViewBag.LeadSourceList

            #region LeadSource

            // No used found
            //List<SelectListItem> LeadSourceList = _Util.Facade.LookupFacade.GetLookupByKeyWithParent("LeadSource").Select(x =>
            //               new SelectListItem()
            //               {
            //                   Text = x.DisplayText.ToString(),
            //                   Value = x.DataValue.ToString()
            //               }).ToList();

            customerHeaderMoneyAndfliterBarModel.CustomerHeaderfliterBarModel.CustomerStatusFilter = _Util.Facade.LookupFacade.GetLookupByKey("CustomerStatusFilter").OrderBy(x => x.DisplayText).Select(x =>
                       new SelectListItem()
                       {
                           Text = x.DisplayText.ToString(),
                           Value = x.DataValue.ToString()
                       }).ToList();

            //if (LeadSourceList.Count() > 0)
            //{
            //    LeadSourceList[0].Text = "Lead Source";
            //}
            //customerHeaderfliterBarModel.LeadSourceList = LeadSourceList;

            #endregion

            #region OthersCustomerFilter

            customerHeaderMoneyAndfliterBarModel.CustomerHeaderfliterBarModel.OthersCustomerFilter = _Util.Facade.LookupFacade.GetLookupByKey("OthersCustomerFilter").Select(x =>
                      new SelectListItem()
                      {
                          Text = x.DisplayText.ToString(),
                          Value = x.DataValue.ToString()
                      }).ToList();


            #endregion


            #region Payment Method
            if (IsPermitted(UserPermissions.CustomerPermissions.CustomerPayMethodFilter))
            {
                List<SelectListItem> PaymentMethodList = _Util.Facade.LookupFacade.GetLookupByKey("PaymentMethod").Select(x =>
                            new SelectListItem()
                            {
                                Text = x.DisplayText.ToString(),
                                Value = x.DataValue.ToString()
                            }).ToList();
                if (PaymentMethodList.Count() > 0)
                {
                    PaymentMethodList[0].Text = "Payment Method";
                }
                customerHeaderMoneyAndfliterBarModel.CustomerHeaderfliterBarModel.PaymentMethodList = PaymentMethodList;


            }

            #endregion

            #region Funding Company

            List<SelectListItem> FundingCompanyList = _Util.Facade.LookupFacade.GetLookupByKey("FundingCompany").Select(x =>
                             new SelectListItem()
                             {
                                 Text = x.DisplayText.ToString(),
                                 Value = x.DataValue.ToString()
                             }).ToList();
            if (FundingCompanyList.Count() > 0)
            {
                FundingCompanyList[0].Text = "Funding Company";

            }
            customerHeaderMoneyAndfliterBarModel.CustomerHeaderfliterBarModel.FundingCompanyList = FundingCompanyList;
            #endregion

            #region CompanyBranchList
            List<SelectListItem> BranchList = new List<SelectListItem>();
            BranchList.Add(new SelectListItem()
            {
                Text = "Select Branch",
                Value = "-1"
            });


            List<CompanyBranch> CompanyBranchList = _Util.Facade.CompanyBranchFacade.GetAllCompanyBranchByCompanyId(CurrentLoggedInUser.CompanyId.Value);
            if (CompanyBranchList != null && CompanyBranchList.Count > 0)
            {
                BranchList.AddRange(CompanyBranchList.OrderBy(x => x.Id.ToString() != "-1").ThenBy(x => x.Name).Select(x => new SelectListItem()
                {
                    Text = x.Name + (string.IsNullOrWhiteSpace(x.Region) ? "" : ">" + x.Region) + (string.IsNullOrWhiteSpace(x.Division) ? "" : ">" + x.Division),
                    Value = x.Id.ToString()
                }).ToList());
            }
            #endregion

            customerHeaderMoneyAndfliterBarModel.CustomerHeaderfliterBarModel.BranchList = BranchList;

            if (IsPermitted(UserPermissions.CustomerPermissions.PackageFilter))
            {
                List<SelectListItem> PackageList = new List<SelectListItem>();
                PackageList.Add(new SelectListItem()
                {
                    Text = "Select Package",
                    Value = "-1"
                });
                List<Package> PackageDropDown = _Util.Facade.PackageFacade.GetAllPackageByCompanyId(CurrentLoggedInUser.CompanyId.Value);
                if (PackageDropDown != null && PackageDropDown.Count > 0)
                {
                    PackageList.AddRange(PackageDropDown.OrderBy(x => x.Name).Select(x => new SelectListItem()
                    {
                        Text = x.Name,
                        Value = x.Name
                    }).ToList());
                }

                customerHeaderMoneyAndfliterBarModel.CustomerHeaderfliterBarModel.PackageList = PackageList;

            }

            return PartialView("_CustomersList", customerHeaderMoneyAndfliterBarModel);
        }
        public PartialViewResult CustomersListLitePartial(string firstdate, string lastdate)
        {

            var CurrentLoggedInUser = (HS.Web.UI.Helper.CustomPrincipal)User;
            string tmmr = CurrentLoggedInUser.UserTags;
            //if (CurrentLoggedInUser.UserId != new Guid())
            //{
            //    var objemployee = _Util.Facade.EmployeeFacade.GetEmployeeRoleByEmployeeIdAndCompanyId(CurrentLoggedInUser.UserId, CurrentLoggedInUser.CompanyId.Value);
            //    if (objemployee != null)
            //    {
            //        tmmr = objemployee.Tag;
            //    }
            //}
            //List<Customer> customers = _Util.Facade.CustomerFacade.GetAllCustomersByCompanyId(CurrentLoggedInUser.CompanyId.Value);
            //  List<Customer> customers = _Util.Facade.CustomerFacade.GetAllCustomerListByCompanyId(CurrentLoggedInUser.CompanyId.Value);

            CustomerHeaderMoneyAndfliterBar customerHeaderMoneyAndfliterBarModel = new CustomerHeaderMoneyAndfliterBar();
            customerHeaderMoneyAndfliterBarModel.CustomerHeaderfliterBarModel = new CustomerHeaderfliterBar();
            customerHeaderMoneyAndfliterBarModel.CustomerHeaderMoneyBarModel = new CustomerHeaderMoneyBar();


            if (IsPermitted(UserPermissions.CustomerPermissions.CustomerSummmery))
            {
                var ispermit = IsPermitted(UserPermissions.CustomerPermissions.ShowAllCustomerList);
                customerHeaderMoneyAndfliterBarModel.CustomerHeaderMoneyBarModel = _Util.Facade.CustomerFacade.GetAllCustomerCountTotalRMREstimateAmountByCompanyId(CurrentLoggedInUser.CompanyId.Value, tmmr, CurrentLoggedInUser.UserId, ispermit);

            }

            customerHeaderMoneyAndfliterBarModel.Firstdate = firstdate;
            customerHeaderMoneyAndfliterBarModel.Lastdate = lastdate;



            #region Sales Person List
            List<SelectListItem> SalesList = new List<SelectListItem>();
            if (IsPermitted(UserPermissions.MyCompanyPermissions.ShowAllSalesPerson))
            {
                SalesList.Add(new SelectListItem()
                {
                    Text = "Sales People",
                    Value = "-1"
                });
                List<Employee> EmployeeDropDown = _Util.Facade.EmployeeFacade.GetEmployeeByCompanyIdAndTag(CurrentLoggedInUser.CompanyId.Value, LabelHelper.UserTags.SalesPerson, new Guid(), LabelHelper.UserTags.Partner);
                if (EmployeeDropDown != null && EmployeeDropDown.Count > 0)
                {
                    SalesList.AddRange(EmployeeDropDown.OrderBy(x => x.FirstName).Select(x => new SelectListItem()
                    {
                        Text = x.FirstName.ToString() + " " + x.LastName.ToString(),
                        Value = x.UserId.ToString()
                    }).ToList());
                }




                //ViewBag.LeadUserList = SalesList;
                customerHeaderMoneyAndfliterBarModel.CustomerHeaderfliterBarModel.SalesUserList = SalesList;

            }
            else
            {
                SalesList.Add(new SelectListItem()
                {
                    Text = "Sales People",
                    Value = "-1"
                });
                List<Employee> emplst = _Util.Facade.EmployeeFacade.GetEmployeeByCompanyIdAndTag(CurrentLoggedInUser.CompanyId.Value, LabelHelper.UserTags.SalesPerson, new Guid(), LabelHelper.UserTags.Partner);
                if (emplst.Where(x => x.UserId == CurrentLoggedInUser.UserId).Count() > 0)
                {
                    var objemp = _Util.Facade.EmployeeFacade.GetEmployeeByEmployeeId(CurrentLoggedInUser.UserId);
                    if (objemp != null)
                    {
                        SalesList.Add(new SelectListItem()
                        {
                            Text = objemp.FirstName.ToString() + " " + objemp.LastName.ToString(),
                            Value = objemp.UserId.ToString()
                        });
                    }
                }
                //ViewBag.LeadUserList = SalesList;
                customerHeaderMoneyAndfliterBarModel.CustomerHeaderfliterBarModel.SalesUserList = SalesList;
            }
            #endregion

            #region Technician List

            if (IsPermitted(UserPermissions.CustomerPermissions.TechFilter))
            {
                List<SelectListItem> TechList = new List<SelectListItem>();
                if (CurrentLoggedInUser.UserRole == LabelHelper.UserTypes.Admin || CurrentLoggedInUser.UserRole == LabelHelper.UserTypes.SysAdmin)
                {
                    TechList.Add(new SelectListItem()
                    {
                        Text = "Technician",
                        Value = "-1"
                    });
                    List<Employee> EmployeeList = _Util.Facade.EmployeeFacade.GetEmployeeByCompanyIdAndTag(CurrentLoggedInUser.CompanyId.Value, LabelHelper.UserTags.Technicians, new Guid());
                    if (EmployeeList != null && EmployeeList.Count > 0)
                    {
                        TechList.AddRange(EmployeeList.OrderBy(x => x.FirstName).Select(x => new SelectListItem()
                        {
                            Text = x.FirstName.ToString() + " " + x.LastName.ToString(),
                            Value = x.UserId.ToString()
                        }).ToList());
                    }

                    //ViewBag.LeadUserList = SalesList;
                    customerHeaderMoneyAndfliterBarModel.CustomerHeaderfliterBarModel.TechUserList = TechList;

                }
                else
                {
                    SalesList.Add(new SelectListItem()
                    {
                        Text = "Technician",
                        Value = "-1"
                    });
                    List<Employee> emplst = _Util.Facade.EmployeeFacade.GetEmployeeByCompanyIdAndTag(CurrentLoggedInUser.CompanyId.Value, LabelHelper.UserTags.Technicians, new Guid());
                    if (emplst.Where(x => x.UserId == CurrentLoggedInUser.UserId).Count() > 0)
                    {
                        var objemp = _Util.Facade.EmployeeFacade.GetEmployeeByEmployeeId(CurrentLoggedInUser.UserId);
                        if (objemp != null)
                        {
                            TechList.Add(new SelectListItem()
                            {
                                Text = objemp.FirstName.ToString() + " " + objemp.LastName.ToString(),
                                Value = objemp.UserId.ToString()
                            });
                        }
                    }
                    //ViewBag.LeadUserList = SalesList;
                    customerHeaderMoneyAndfliterBarModel.CustomerHeaderfliterBarModel.TechUserList = TechList;
                }
            }


            #endregion

            //ViewBag.LeadSourceList

            #region LeadSource

            // No used found
            //List<SelectListItem> LeadSourceList = _Util.Facade.LookupFacade.GetLookupByKeyWithParent("LeadSource").Select(x =>
            //               new SelectListItem()
            //               {
            //                   Text = x.DisplayText.ToString(),
            //                   Value = x.DataValue.ToString()
            //               }).ToList();

            customerHeaderMoneyAndfliterBarModel.CustomerHeaderfliterBarModel.CustomerStatusFilter = _Util.Facade.LookupFacade.GetLookupByKey("CustomerStatusFilter").OrderBy(x => x.DisplayText).Select(x =>
                       new SelectListItem()
                       {
                           Text = x.DisplayText.ToString(),
                           Value = x.DataValue.ToString()
                       }).ToList();

            //if (LeadSourceList.Count() > 0)
            //{
            //    LeadSourceList[0].Text = "Lead Source";
            //}
            //customerHeaderfliterBarModel.LeadSourceList = LeadSourceList;

            #endregion

            #region OthersCustomerFilter

            customerHeaderMoneyAndfliterBarModel.CustomerHeaderfliterBarModel.OthersCustomerFilter = _Util.Facade.LookupFacade.GetLookupByKey("OthersCustomerFilter").Select(x =>
                      new SelectListItem()
                      {
                          Text = x.DisplayText.ToString(),
                          Value = x.DataValue.ToString()
                      }).ToList();


            #endregion


            #region Payment Method
            if (IsPermitted(UserPermissions.CustomerPermissions.CustomerPayMethodFilter))
            {
                List<SelectListItem> PaymentMethodList = _Util.Facade.LookupFacade.GetLookupByKey("PaymentMethod").Select(x =>
                            new SelectListItem()
                            {
                                Text = x.DisplayText.ToString(),
                                Value = x.DataValue.ToString()
                            }).ToList();
                if (PaymentMethodList.Count() > 0)
                {
                    PaymentMethodList[0].Text = "Payment Method";
                }
                customerHeaderMoneyAndfliterBarModel.CustomerHeaderfliterBarModel.PaymentMethodList = PaymentMethodList;


            }

            #endregion

            #region Funding Company

            List<SelectListItem> FundingCompanyList = _Util.Facade.LookupFacade.GetLookupByKey("FundingCompany").Select(x =>
                             new SelectListItem()
                             {
                                 Text = x.DisplayText.ToString(),
                                 Value = x.DataValue.ToString()
                             }).ToList();
            if (FundingCompanyList.Count() > 0)
            {
                FundingCompanyList[0].Text = "Funding Company";

            }
            customerHeaderMoneyAndfliterBarModel.CustomerHeaderfliterBarModel.FundingCompanyList = FundingCompanyList;
            #endregion

            #region CompanyBranchList
            List<SelectListItem> BranchList = new List<SelectListItem>();
            BranchList.Add(new SelectListItem()
            {
                Text = "Select Branch",
                Value = "-1"
            });


            List<CompanyBranch> CompanyBranchList = _Util.Facade.CompanyBranchFacade.GetAllCompanyBranchByCompanyId(CurrentLoggedInUser.CompanyId.Value);
            if (CompanyBranchList != null && CompanyBranchList.Count > 0)
            {
                BranchList.AddRange(CompanyBranchList.OrderBy(x => x.Id.ToString() != "-1").ThenBy(x => x.Name).Select(x => new SelectListItem()
                {
                    Text = x.Name + (string.IsNullOrWhiteSpace(x.Region) ? "" : ">" + x.Region) + (string.IsNullOrWhiteSpace(x.Division) ? "" : ">" + x.Division),
                    Value = x.Id.ToString()
                }).ToList());
            }
            #endregion

            customerHeaderMoneyAndfliterBarModel.CustomerHeaderfliterBarModel.BranchList = BranchList;

            if (IsPermitted(UserPermissions.CustomerPermissions.PackageFilter))
            {
                List<SelectListItem> PackageList = new List<SelectListItem>();
                PackageList.Add(new SelectListItem()
                {
                    Text = "Select Package",
                    Value = "-1"
                });
                List<Package> PackageDropDown = _Util.Facade.PackageFacade.GetAllPackageByCompanyId(CurrentLoggedInUser.CompanyId.Value);
                if (PackageDropDown != null && PackageDropDown.Count > 0)
                {
                    PackageList.AddRange(PackageDropDown.OrderBy(x => x.Name).Select(x => new SelectListItem()
                    {
                        Text = x.Name,
                        Value = x.Name
                    }).ToList());
                }

                customerHeaderMoneyAndfliterBarModel.CustomerHeaderfliterBarModel.PackageList = PackageList;

            }

            return PartialView("_CustomersListLite", customerHeaderMoneyAndfliterBarModel);
        }
        public JsonResult AddTicket(Ticket Ticket, Guid[] Assigned)
        {
            var CurrentUser = (HS.Web.UI.Helper.CustomPrincipal)User;
            string Message = "";

            #region Check
            //UserList Check
            List<Guid> AssignedList = new List<Guid>();
            if (Assigned != null)
            {
                AssignedList.AddRange(Assigned);
            }
            //if (UserList != null)
            //{
            //    AssignedList.AddRange(UserList);
            //}
            if (AssignedList.Count() > 0)
            {
                List<TicketSchedule> TicketSchedules = _Util.Facade.TicketFacade.GetTicketSchedulesByUserListAndAppoinmentDate(AssignedList, Ticket.CompletionDate);

                int ticketStartTime = -1;
                int ticketEndTime = -1;

                if (TicketSchedules.Where(x => x.TicketId != Ticket.TicketId && (x.StartTime == "-1" || x.EndTime == "-1")).Count() > 0)
                {
                    return Json(new { result = false, message = string.Format("One or more user has schedules on that day. You can't schedule for all day.") });
                }
                foreach (var item in TicketSchedules.Where(x => x.TicketId != Ticket.TicketId))
                {
                    int startTime = -1;
                    int endTime = -1;

                    int.TryParse(item.StartTime.Replace(":", ""), out startTime);
                    int.TryParse(item.EndTime.Replace(":", ""), out endTime);

                    if (startTime == -1 || endTime == -1)
                    {
                        return Json(new { result = false, message = string.Format("{0} has all day schedule.", item.EmployeeName) });
                    }
                    if (startTime == ticketStartTime || (endTime > ticketStartTime && startTime < ticketStartTime))
                    {
                        return Json(new { result = false, message = string.Format("{0} has scheduling conflict. Please check to make sure time is not overlapping.", item.EmployeeName) });
                    }
                    if (endTime == ticketEndTime || (endTime > ticketEndTime && startTime < ticketEndTime))
                    {
                        return Json(new { result = false, message = string.Format("{0} has scheduling conflict. Please check to make sure time is not overlapping.", item.EmployeeName) });
                    }
                }
            }

            #endregion

            #region Init Values
            Customer TicketCustomer = _Util.Facade.CustomerFacade.GetCustomerByCustomerId(Ticket.CustomerId);
            bool IsNewTicket = !(Ticket.Id > 0);
            #endregion

            if (Ticket.Id > 0)
            {
                #region Update Ticket 
                Ticket TempTicket = _Util.Facade.TicketFacade.GetTicketById(Ticket.Id);
                if (TempTicket == null || TempTicket.TicketId != Ticket.TicketId)
                {
                    return Json(new { result = false, message = "Access denied." });
                }

                TempTicket.Priority = Ticket.Priority;
                TempTicket.CompletionDate = Ticket.CompletionDate;
                TempTicket.Status = Ticket.Status;
                TempTicket.LastUpdatedBy = CurrentUser.UserId;
                TempTicket.LastUpdatedDate = DateTime.Now.UTCCurrentTime();
                TempTicket.AppointmentEndTime = Ticket.AppointmentEndTime;
                TempTicket.AppointmentStartTime = Ticket.AppointmentStartTime;

                if (Ticket.CompletionDate == null)
                {
                    Ticket.CompletionDate = new DateTime();
                }
                _Util.Facade.TicketFacade.UpdateTicket(TempTicket);
                Ticket = TempTicket;
                Message = "Ticket updated successfully.";

                CustomerAppointment ca = _Util.Facade.CustomerAppoinmentFacade.GetCustomerAppointmentDetailinfoByAppointmentId(TempTicket.TicketId);

                if (ca != null)
                {
                    bool IsAllDay = true;

                    ca.LastUpdatedBy = User.Identity.Name;
                    ca.LastUpdatedDate = DateTime.Now.UTCCurrentTime();
                    ca.AppointmentStartTime = Ticket.AppointmentStartTime;
                    ca.AppointmentEndTime = Ticket.AppointmentEndTime;
                    ca.AppointmentType = Ticket.TicketType;
                    ca.AppointmentDate = Ticket.CompletionDate;
                    ca.IsAllDay = IsAllDay;
                    _Util.Facade.CustomerAppoinmentFacade.UpdateCustomerAppoinment(ca);
                }
                else
                {
                    bool IsAllDay = true;
                    if (!string.IsNullOrWhiteSpace(Ticket.AppointmentStartTime) && Ticket.AppointmentStartTime != "-1"
                        && !string.IsNullOrWhiteSpace(Ticket.AppointmentEndTime) && Ticket.AppointmentEndTime != "-1")
                    {
                        IsAllDay = false;
                    }

                    ca = new CustomerAppointment()
                    {
                        AppointmentDate = Ticket.CompletionDate,
                        AppointmentId = Ticket.TicketId,
                        CompanyId = CurrentUser.CompanyId.Value,
                        CreatedBy = User.Identity.Name,
                        CustomerId = Ticket.CustomerId,
                        IsAllDay = IsAllDay,
                        EmployeeId = new Guid(),//From now on customer appoinment will be check from ticket user;
                        LastUpdatedBy = User.Identity.Name,
                        LastUpdatedDate = DateTime.Now.UTCCurrentTime(),
                        Notes = Ticket.Message,
                        AppointmentStartTime = Ticket.AppointmentStartTime,
                        AppointmentEndTime = Ticket.AppointmentEndTime,
                        AppointmentType = Ticket.TicketType,

                    };
                    ca.Id = (int)_Util.Facade.CustomerAppoinmentFacade.InsertCustomerAppoinment(ca);
                }
                //}
                #endregion
            }
            else
            {
                #region Insert Ticket 
                Ticket.CreatedBy = CurrentUser.UserId;
                Ticket.CreatedDate = DateTime.Now.UTCCurrentTime();
                Ticket.LastUpdatedBy = CurrentUser.UserId;
                Ticket.LastUpdatedDate = DateTime.Now.UTCCurrentTime();
                Ticket.CompanyId = CurrentUser.CompanyId.Value;
                Ticket.TicketId = Guid.NewGuid();
                if (Ticket.CompletionDate == null)
                {
                    Ticket.CompletionDate = new DateTime();
                }
                Ticket.Id = _Util.Facade.TicketFacade.InsertTicket(Ticket);
                var strMsg = HS.Web.UI.Helper.LanguageHelper.T("Create Ticket for");
                Message = strMsg + " added successfully.";

                bool IsAllDay = true;

                CustomerAppointment ca = new CustomerAppointment()
                {
                    AppointmentDate = Ticket.CompletionDate,
                    AppointmentId = Ticket.TicketId,
                    CompanyId = CurrentUser.CompanyId.Value,
                    CreatedBy = User.Identity.Name,
                    CustomerId = Ticket.CustomerId,
                    IsAllDay = IsAllDay,
                    EmployeeId = new Guid(),//From now on customer appoinment will be check from ticket user;
                    LastUpdatedBy = User.Identity.Name,
                    LastUpdatedDate = DateTime.Now.UTCCurrentTime(),
                    Notes = Ticket.Message,
                    AppointmentStartTime = Ticket.AppointmentStartTime,
                    AppointmentEndTime = Ticket.AppointmentEndTime,
                    AppointmentType = Ticket.TicketType,

                };
                ca.Id = (int)_Util.Facade.CustomerAppoinmentFacade.InsertCustomerAppoinment(ca);
                #endregion
            }

            #region Insert/Update TicketUser 
            _Util.Facade.TicketFacade.DeleteTicketUserByTicketId(Ticket.TicketId, true);
            if (Assigned != null && Assigned.Count() > 0)
            {
                foreach (var item in Assigned)
                {
                    var TicketUser = new TicketUser()
                    {
                        AddedBy = CurrentUser.UserId,
                        AddedDate = DateTime.Now.UTCCurrentTime(),
                        UserId = item,
                        IsPrimary = true,
                        TiketId = Ticket.TicketId,
                        NotificationOnly = false,
                    };
                    _Util.Facade.TicketFacade.InsertTicketUser(TicketUser);
                }
            }
            _Util.Facade.TicketFacade.DeleteTicketUserByTicketId(Ticket.TicketId, false);
            _Util.Facade.TicketFacade.DeleteTicketUserByTicketId(Ticket.TicketId, null, true);
            //if (NotifyingUserList != null && NotifyingUserList.Count() > 0)
            //{
            //    foreach (var item in NotifyingUserList)
            //    {
            //        if (item == new Guid())
            //            continue;

            //        var TicketUser = new TicketUser()
            //        {
            //            AddedBy = CurrentUser.UserId,
            //            AddedDate = DateTime.Now.UTCCurrentTime(),
            //            UserId = item,
            //            IsPrimary = false,
            //            TiketId = Ticket.TicketId,
            //            NotificationOnly = true,
            //        };
            //        _Util.Facade.TicketFacade.InsertTicketUser(TicketUser);
            //    }
            //}

            #endregion

            if (IsNewTicket)
            {
                #region Send Ticket Created Email


                string ToEmailList = "";
                //List<Guid> AllUser = new List<Guid>();
                //if (Assigned != null)
                //{
                //    AllUser.AddRange(Assigned);
                //}
                //if (UserList != null)
                //{
                //    AllUser.AddRange(UserList);
                //}
                //if (NotifyingUserList != null)
                //{
                //    AllUser.AddRange(NotifyingUserList);
                //}
                //AllUser = AllUser.GroupBy(x => x).Select(x => x.Key).ToList();

                #region Insert notification
                Notification notification = new Notification()
                {
                    CompanyId = CurrentUser.CompanyId.Value,
                    CreatedDate = DateTime.Now.UTCCurrentTime(),
                    NotificationId = Guid.NewGuid(),
                    Type = LabelHelper.NotificationType.Employee,
                    Who = CurrentUser.UserId,
                    What = string.Format(@"{0} created a new Ticket {1}", "{0}", Ticket.Id),
                    NotificationUrl = AppConfig.DomainSitePath + "/Ticket/AddTicket/?Id=" + Ticket.Id,
                };
                _Util.Facade.NotificationFacade.InsertNotification(notification);

                #endregion

                //foreach (Guid item in AllUser)
                //{
                //    if (item != CurrentUser.UserId)
                //    {
                //        Employee emp = _Util.Facade.EmployeeFacade.GetEmployeeByUserId(item);
                //        if (emp != null && emp.Email.IsValidEmailAddress())
                //        {
                //            ToEmailList += string.Format("{0}>{1} {2};", emp.Email, emp.FirstName, emp.LastName);
                //        }
                //        #region set user to notification
                //        NotificationUser nu = new NotificationUser()
                //        {
                //            NotificationId = notification.NotificationId,
                //            IsRead = false,
                //            NotificationPerson = item,
                //        };
                //        _Util.Facade.NotificationFacade.InsertNotificationUser(nu);
                //        #endregion
                //    }

                //}
                if (!string.IsNullOrWhiteSpace(ToEmailList))
                {
                    string CustomerName = TicketCustomer.FirstName + " " + TicketCustomer.LastName;
                    if (TicketCustomer.Type == LabelHelper.CustomerType.Commercial && !string.IsNullOrWhiteSpace(TicketCustomer.BusinessName))
                    {
                        CustomerName = TicketCustomer.BusinessName;
                    }
                    TicketNotificationEmails TicketCreatedNotificationEmail = new TicketNotificationEmails()
                    {
                        CompanyId = CurrentUser.CompanyId.Value,
                        CreatedByName = CurrentUser.GetFullName(),
                        TicketMessage = Ticket.Message,
                        CreatedForCustomerName = CustomerName,
                        TicketNumber = string.Format("Ticket #{0}", Ticket.Id),
                        ToEmail = ToEmailList,
                        Subject = string.Format("A new ticket has been created (Ticket #{0})", Ticket.Id),
                        HeaderMessage = "A new ticket has been created",
                        BodyMessage = string.Format("A new ticket (Ticket #{0}) has been created by {1} for customer {2}", Ticket.Id, CurrentUser.GetFullName(), TicketCustomer.FirstName + " " + TicketCustomer.LastName),
                        TicketUrl = string.Format("{2}{4}/Public/Open/?TicketId={0}&CompanyId={1}&Type={3}", Ticket.TicketId, CurrentUser.CompanyId.Value, AppConfig.SiteDomain, LabelHelper.PublicOpenTypes.Ticket, AppConfig.DomainSitePath)
                    };
                    _Util.Facade.MailFacade.SendTicketCreatedNotificationEmail(TicketCreatedNotificationEmail);
                }
                #endregion
            }

            return Json(new { result = true, message = Message });
        }

        [Authorize]
        public ActionResult CustomerContactList(Guid FromCustomer, string soldby)
        {
            ViewBag.CustomerId = FromCustomer;
            ViewBag.contactTab = true;
            ViewBag.SoldBy = soldby;
            return View();
        }
        #region Customer Cancellation Area
        [Authorize]
        public PartialViewResult AddCustomer(int? id, bool? IsGotoBill, bool? IsSystemInfo, bool? IsAccountActivity, bool? IsEmergency)

        {
            //IsSystemInfo = true;
            if (!base.IsPermitted(UserPermissions.CustomerPermissions.CustomerInformationEdit))
            {
                return PartialView("~/Views/Shared/_AccessDenied.cshtml");
            }
            var CurrentLoggedInUser = (HS.Web.UI.Helper.CustomPrincipal)User;
            var UserRole = CurrentLoggedInUser.UserRole;
            GlobalSetting paymentGetway = _Util.Facade.GlobalSettingsFacade.GetGlobalSettingsByKey(CurrentLoggedInUser.CompanyId.Value, "PaymentGetway");
            ViewBag.PaymentGetway = paymentGetway.Value;
            List<SelectListItem> BranchList = new List<SelectListItem>();
            BranchList.Add(new SelectListItem()
            {
                Text = "Please Select",
                Value = "-1"
            });
            //UserBranch ub = _Util.Facade.UserCompanyFacade.GetUserBranchByUserId(CurrentLoggedInUser.UserId);

            //if (CompanyBranchDropDown != null && CompanyBranchDropDown.Count > 0)
            //{
            //    BranchList.AddRange(CompanyBranchDropDown.OrderBy(x => x.Id.ToString() != "-1").ThenBy(x => x.Name).Select(x => new SelectListItem()
            //    {
            //        Text = x.Name,
            //        Value = x.Id.ToString(),
            //        Selected = x.IsMainBranch == true
            //    }).ToList());
            //}



            GlobalSetting ShowTicketPricing = _Util.Facade.GlobalSettingsFacade.GetGlobalSettingsByKey(CurrentLoggedInUser.CompanyId.Value, "PaymentGetway");
            ViewBag.ShowTicketPricing = ShowTicketPricing.Value;

            if (UserRole == "Customer")
            {
                ViewBag.UserRole = UserRole;
            }
            else
            {
                ViewBag.UserRole = UserRole;
            }
            CreateTicketModel Model = new CreateTicketModel();
            Customer model;
            List<Employee> EmployeeList = _Util.Facade.EmployeeFacade.GetAllEmployee(CurrentLoggedInUser.CompanyId.Value);

            List<Employee> EmpList = EmployeeList.OrderBy(x => x.FirstName).ToList();
            List<SelectListItem> ProfilePackage = new List<SelectListItem>();
            ProfilePackage.Add(new SelectListItem()
            {
                Text = "Please Select",
                Value = "-1"
            });


            ProfilePackage.AddRange(_Util.Facade.LookupFacade.GetDropdownsByKey("PaymentMethodRMR"));


            if (id.HasValue)
            {
                model = _Util.Facade.CustomerFacade.GetCustomersById(id.Value);
                if (IsGotoBill.HasValue && IsGotoBill == true)
                {
                    ViewBag.IsGotoBill = 1;
                }
                if (IsSystemInfo.HasValue && IsSystemInfo == true)
                {
                    ViewBag.IsSystemInfo = 1;
                }
                if (IsAccountActivity.HasValue && IsAccountActivity == true)
                {
                    ViewBag.IsAccountActivity = 1;
                }
                if (IsEmergency.HasValue && IsEmergency == true)
                {
                    ViewBag.IsEmergency = 1;
                }
                if (model.BillTax == null)
                {
                    model.BillTax = true;
                }
                if (model.CustomerExtended.ContractStartDate == new DateTime())
                {
                    model.CustomerExtended.ContractStartDate = DateTime.Now.Date;
                }
                List<PaymentInfo> AllCustomerPaymentInfo = _Util.Facade.PaymentInfoFacade.GetAllPaymentInfoByCustomerIdAndCompanyId(model.CustomerId, CurrentLoggedInUser.CompanyId.Value);
                var CreditCardInfo = AllCustomerPaymentInfo.Where(x => x.CardSecurityCode != "" && x.CardNumber != "" && x.CardExpireDate != "").FirstOrDefault();
                if (CreditCardInfo == null)
                {
                    CreditCardInfo = new PaymentInfo();
                }
                ViewBag.CreditCardInfo = CreditCardInfo;

                var ACHInfo = AllCustomerPaymentInfo.Where(x => x.BankAccountType != "" && x.EcheckType != "" && x.RoutingNo != "" && x.AcountNo != "").FirstOrDefault();
                if (ACHInfo == null)
                {
                    ACHInfo = new PaymentInfo();
                }
                if (!string.IsNullOrWhiteSpace(model.AuthorizeRefId) || !string.IsNullOrWhiteSpace(model.CustomerToken))
                {
                    ProfilePackage.Add(new SelectListItem()
                    {
                        Text = "Getway Existing Porfile",
                        Value = Helper.LabelHelper.PaymentMethod.GetwayExisting
                    });
                }

                ViewBag.ACHInfo = ACHInfo;
                ViewBag.QA1Percentageval = _Util.Facade.CustomerFacade.GetCustomerQA1StatusByCompanyIdAndCustomerId(CurrentLoggedInUser.CompanyId.Value, model.CustomerId);
                ViewBag.GlobalSettingPercentage = _Util.Facade.CustomerFacade.GetQA1PercentageValueByCompanyId(CurrentLoggedInUser.CompanyId.Value);
                ViewBag.AssignedEmployee = EmpList.Select(x => new SelectListItem()
                {
                    Text = x.FirstName + " " + x.LastName,
                    Value = x.UserId.ToString(),
                    Selected = Model.TicketAssignedUserList != null ? Model.TicketAssignedUserList.Count(y => y.UserId == x.UserId) > 0 : false
                }).ToList();

                //List<SelectListItem> AccessAssignedPersons = new List<SelectListItem>();
                //AccessAssignedPersons.Add(new SelectListItem()
                //{
                //    Text = "Access Assign To",
                //    Value = "-1"
                //});
                //List<Employee> EmployeeListDropDown = EmployeeList;
                //if (EmployeeListDropDown != null && EmployeeListDropDown.Count > 0)
                //{
                //    AccessAssignedPersons.AddRange(EmployeeListDropDown.OrderBy(x => x.FirstName).Select(x => new SelectListItem()
                //    {
                //        Text = x.FirstName.ToString() + " " + x.LastName.ToString(),
                //        Value = x.UserId.ToString()
                //    }).ToList());
                //}

                //ViewBag.AccessAssignedPersons = AccessAssignedPersons;

                bool IsQa1Done = false;
                int Qval = 0;
                int Gval = 0;
                if (ViewBag.QA1Percentageval != "")
                {
                    Qval = Convert.ToInt32(Math.Floor(Convert.ToDouble(ViewBag.QA1Percentageval)));
                }
                if (ViewBag.GlobalSettingPercentage != "")
                {
                    Gval = Convert.ToInt32(ViewBag.GlobalSettingPercentage);
                }

                if (Qval <= Gval && Qval != Gval)
                {
                    ViewBag.QA1FinalResult = IsQa1Done;
                }
                else
                {
                    IsQa1Done = true;
                    ViewBag.QA1FinalResult = IsQa1Done;
                }
                bool Tresult = _Util.Facade.CustomerFacade.GetQATechCallValueBycompanyId(CurrentLoggedInUser.CompanyId.Value, model.CustomerId);
                var QATechcallGlobSetting = _Util.Facade.GlobalSettingsFacade.GetQATechCallGlobSettingsBycompanyId(CurrentLoggedInUser.CompanyId.Value);
                model.IsQA2Done = _Util.Facade.CustomerFacade.GetCustomerQA2StatusByCompanyIdAndCustomerId(CurrentLoggedInUser.CompanyId.Value, model.CustomerId);

                if (Tresult != false)
                {
                    Tresult = true;
                    ViewBag.TechFinalResult = Tresult;
                }
                else
                {
                    ViewBag.TechFinalResult = Tresult;
                }
                if (QATechcallGlobSetting.Count > 0 && QATechcallGlobSetting.Count == 3)
                {
                    model.QA1GlobalSettings = (QATechcallGlobSetting[0].Value.ToLower() == "true") ? true : false;
                    model.TechCallGlobalSettings = (QATechcallGlobSetting[1].Value.ToLower() == "true") ? true : false;
                    model.QA2GlobalSettings = (QATechcallGlobSetting[2].Value.ToLower() == "true") ? true : false;
                }
                //////   



                ViewBag.HasAdminPermission = PermissionChecker.IsPermitted(PermissionList.LeadPermissions.SmartSetUpSaveReview);
                bool HasAdminPermission = ViewBag.HasAdminPermission;
                if (HasAdminPermission)
                {
                    ProfilePackage.AddRange(_Util.Facade.CustomerFacade.GetAllPaymentProfileByType(model.CustomerId, CurrentLoggedInUser.CompanyId.Value, "PaymentMethodPackage").Select(x =>
                 new SelectListItem()
                 {
                     Text = x.Type.ToString(),
                     Value = x.PaymentInfoId.ToString()
                 }).ToList().Where(x => x.Text != "OnFile").OrderBy(x => x.Text != "Please Select").ThenBy(x => x.Text).ToList());
                }
                else
                {
                    ProfilePackage.AddRange(_Util.Facade.CustomerFacade.GetAllPaymentProfileByType(model.CustomerId, CurrentLoggedInUser.CompanyId.Value, "PaymentMethodPackage", true).Select(x =>
                 new SelectListItem()
                 {
                     Text = x.Type.ToString(),
                     Value = x.PaymentInfoId.ToString()
                 }).ToList().Where(x => x.Text != "OnFile").OrderBy(x => x.Text != "Please Select").ThenBy(x => x.Text).ToList());
                }
                ViewBag.ProfilePackage = ProfilePackage.ToList();
                foreach (var Paymethod in ProfilePackage)
                {
                    if (model.PaymentMethod == Paymethod.Text)
                    {
                        model.PaymentMethod = Paymethod.Value;
                    }
                }
                if (!string.IsNullOrWhiteSpace(model.CustomerAccountType))
                {
                    var spaccounttype = model.CustomerAccountType.Replace(", ", ",").Split(',');
                    List<string> accounttypelist = new List<string>();
                    if (spaccounttype.Length > 0)
                    {
                        foreach (var item in spaccounttype)
                        {
                            accounttypelist.Add(item);
                        }
                    }
                    model.CustomerAccountTypeList = accounttypelist;
                }
                CustomerExtended extended = _Util.Facade.CustomerFacade.GetCustomerExtendedByCustomerId(model.CustomerId);
                model.CustomerExtended = extended;
                if (extended != null)
                {
                    model.CSAgreement = extended.CSAgreement;
                    model.CustomerExtended.FinanceCompany = extended.FinanceCompany;
                    model.CustomerExtended.SalesPerson4 = extended.SalesPerson4;
                    model.CustomerExtended.RWST1 = extended.RWST1;
                    model.CustomerExtended.RWST2 = extended.RWST2;
                    model.CustomerExtended.RWST3 = extended.RWST3;
                    model.CustomerExtended.RWST4 = extended.RWST4;
                    model.CustomerExtended.RWST5 = extended.RWST5;
                    model.CustomerExtended.RWST6 = extended.RWST6;
                    model.CustomerExtended.RWST7 = extended.RWST7;
                    model.CustomerExtended.RWST8 = extended.RWST8;
                    model.CustomerExtended.RWST9 = extended.RWST9;
                    model.CustomerExtended.RWST10 = extended.RWST10;
                    model.CustomerExtended.RWST11 = extended.RWST11;
                    model.CustomerExtended.RWST12 = extended.RWST12;
                    model.CustomerExtended.RWST13 = extended.RWST13;
                    model.CustomerExtended.RWST14 = extended.RWST14;
                    model.CustomerExtended.RWST15 = extended.RWST15;
                    model.CustomerExtended.RepsAssignedDate = extended.RepsAssignedDate;
                    model.CustomerExtended.MonthlyFinanceRate = extended.MonthlyFinanceRate;
                    model.CustomerExtended.GrossFundedAmount = extended.GrossFundedAmount;
                    model.CustomerExtended.NetFundedAmount = extended.NetFundedAmount;
                    model.CustomerExtended.DiscountFundedAmount = extended.DiscountFundedAmount;
                    model.CustomerExtended.DiscountFundedPercentage = extended.DiscountFundedPercentage;
                    model.CustomerExtended.CustomerPaymentAmount = extended.CustomerPaymentAmount;
                    model.CustomerExtended.FinanceRepCommissionRate = extended.FinanceRepCommissionRate;
                    model.CustomerExtended.LoanNumber = extended.LoanNumber;
                    model.CustomerExtended.CreditAppNumber = extended.CreditAppNumber;
                    model.CustomerExtended.Term = extended.Term;
                    model.CustomerExtended.APR = extended.APR;
                    model.CustomerExtended.MaxCreditLimit = extended.MaxCreditLimit;
                    model.CustomerExtended.ApprovalDate = extended.ApprovalDate;
                    model.CustomerExtended.Batch = extended.Batch;
                    model.CustomerExtended.MonthlyBatch = extended.MonthlyBatch;
                    model.CustomerExtended.FinanceRep = extended.FinanceRep;
                    model.CustomerExtended.AppoinmentSetBy = extended.AppoinmentSetBy;
                }

                //#region Recurring Billing
                //Customer cus = _Util.Facade.CustomerFacade.GetCustomerByCustomerId(model.CustomerId);
                //if (cus != null)
                //{
                //    RecurringBillingSchedule BillingSchedule = _Util.Facade.CustomerFacade.GetByRecurringBillingByCustomerId(cus.CustomerId);
                //    if (BillingSchedule != null)
                //    {
                //        RecurringBillingModel Billing = _Util.Facade.CustomerFacade.GetSumOfRecurringBillingByCustomerId(BillingSchedule.CustomerId);
                //        model.MonthlyMonitoringFee = Billing.MonitoringFee.ToString();
                //        model.BillAmount = Billing.BillingAmount;
                //    }

                //}
                //#endregion
                #region CustomerRoute
                CustomerRoute CRoute = _Util.Facade.CustomerFacade.GetCustomerRouteByCustomerId(model.CustomerId);
                if (CRoute != null)
                {
                    model.RouteId = CRoute.RouteId;
                }

                #endregion
            }
            else
            {

                ViewBag.ProfilePackage = ProfilePackage;
                //ViewBag.ProfilePackage = ProfilePackage.Where(x => x.Text != "OnFile").OrderBy(x => x.Text != "Please Select").ThenBy(x => x.Text).ToList();
                //////////

                model = new Customer();
                model.LeadSource = "-1";
                model.CustomerId = Guid.NewGuid();
                model.BillCycle = LabelHelper.BillCycle.Monthly;
                model.BillTax = true;
                model.systemNo = new List<CustomerSystemNo>();
                ViewBag.CreditCardInfo = new PaymentInfo();
                ViewBag.ACHInfo = new PaymentInfo();
                EmpList = EmployeeList.OrderBy(x => x.FirstName).ToList();
                ViewBag.AssignedEmployee = EmpList.Select(x => new SelectListItem()
                {
                    Text = x.FirstName + " " + x.LastName,
                    Value = x.UserId.ToString(),
                    Selected = Model.TicketAssignedUserList != null ? Model.TicketAssignedUserList.Count(y => y.UserId == x.UserId) > 0 : false
                }).ToList();
            }
            List<GridSetting> CustomerUiSetting = new List<GridSetting>();
            CustomerUiSetting = _Util.Facade.GridSettingsFacade.GetAllByKey("CustomerGrid", CurrentLoggedInUser.CompanyId.Value);
            if (CustomerUiSetting.Count > 0)
            {
                CustomerUiSetting = CustomerUiSetting.OrderBy(x => x.OrderBy).Where(x => x.FormActive == true).ToList();
            }
            ViewBag.CustomerUiSetting = CustomerUiSetting;
            List<GridSetting> CustomerTabUiSetting = new List<GridSetting>();
            CustomerTabUiSetting = _Util.Facade.GridSettingsFacade.GetAllByKey("CustomerTab", CurrentLoggedInUser.CompanyId.Value);
            if (CustomerTabUiSetting.Count > 0)
            {
                CustomerTabUiSetting = CustomerTabUiSetting.OrderBy(x => x.OrderBy).Where(x => x.FormActive == true).ToList();
            }
            ViewBag.CustomerTabUiSetting = CustomerTabUiSetting;
            //CustomerListInit();
            //List<SelectListItem> LeadSource = new List<SelectListItem>();
            //LeadSource.AddRange(_Util.Facade.LookupFacade.GetLookupByKeyWithParent("LeadSource").OrderBy(x => x.DataValue != "-1").ThenBy(x => x.DisplayText).Select(x => new SelectListItem()
            //{
            //    Text = x.DisplayText.ToString(),
            //    Value = x.DataValue.ToString()
            //}).ToList());
            //if (LeadSource.Where(x => x.Selected).Count() == 0)
            //{
            //    LeadSource.Where(x => x.Value == "-1").FirstOrDefault(x => x.Selected = true);
            //    model.LeadSource = "-1";
            //}
            //ViewBag.LeadSource = LeadSource;

            ViewBag.ECheckTypeList = _Util.Facade.LookupFacade.GetLookupByKey("ECheckType").Select(x =>
                           new SelectListItem()
                           {
                               Text = x.DisplayText.ToString(),
                               Value = x.DataValue.ToString()
                           }).ToList();
            ViewBag.BankAccountTypeList = _Util.Facade.LookupFacade.GetLookupByKey("BankAccountType").Select(x =>
                           new SelectListItem()
                           {
                               Text = x.DisplayText.ToString(),
                               Value = x.DataValue.ToString()
                           }).ToList();
            var BrinksCreditCheck = _Util.Facade.GlobalSettingsFacade.GetGlobalSettingsByKey(CurrentLoggedInUser.CompanyId.Value, "BrinksCreditCheck");
            if (BrinksCreditCheck != null)
            {
                ViewBag.BrinksCreditCheck = BrinksCreditCheck.Value;
            }
            //List<SelectListItem> SalesCommisssion = new List<SelectListItem>();
            //SalesCommisssion.Add(new SelectListItem()
            //{
            //    Text = "Please Select",
            //    Value = "-1"
            //});
            //SalesCommisssion.AddRange(_Util.Facade.LookupFacade.GetLookupByKey("CommissionType").Select(x =>
            //            new SelectListItem()
            //            {
            //                Text = x.DisplayText.ToString(),
            //                Value = x.DataValue.ToString()
            //            }).ToList());
            //ViewBag.SalesLocation = SalesCommisssion.OrderBy(x => x.Text != "Please Select").ThenBy(x => x.Text).ToList();
            //ViewBag.SalesLocation = _Util.Facade.LookupFacade.GetLookupByKey("CommissionType").Select(x =>
            //              new SelectListItem()
            //              {
            //                  Text = x.DisplayText.ToString(),
            //                  Value = x.DataValue.ToString()
            //              }).ToList();
            Employee emp = _Util.Facade.EmployeeFacade.GetEmployeeByEmployeeId(CurrentLoggedInUser.UserId);
            ViewBag.EmpSalesLocation = emp.SalesCommissionStructure;
            ViewBag.PaymentMethod = _Util.Facade.LookupFacade.GetLookupByKey("PaymentMethod").Select(x =>
                            new SelectListItem()
                            {
                                Text = x.DisplayText.ToString(),
                                Value = x.DataValue.ToString()
                            }).ToList();
            ViewBag.paymentmethodrmr = _Util.Facade.LookupFacade.GetLookupByKey("PaymentMethodRMR").Select(x =>
            new SelectListItem()
            {
                Text = x.DisplayText.ToString(),
                Value = x.DataValue.ToString()
            }).ToList();

            //ViewBag.CustomerTypeList = _Util.Facade.LookupFacade.GetLookupByKey("CustomerType").OrderBy(x => x.DisplayText != "Select One").ThenBy(x => x.DisplayText).Select(x =>
            //              new SelectListItem()
            //              {
            //                  Text = x.DisplayText.ToString(),
            //                  Value = x.DataValue.ToString()
            //              }).ToList();

            var objsettings = _Util.Facade.GlobalSettingsFacade.GetGlobalSettingsByKey(CurrentLoggedInUser.CompanyId.Value, "CustomerTypeRequired");
            if (objsettings != null)
            {
                ViewBag.CustomerTypeRequired = Convert.ToBoolean(objsettings.Value);
            }
            else
            {
                ViewBag.CustomerTypeRequired = false;
            }

            //ViewBag.RWSTList = _Util.Facade.LookupFacade.GetLookupByKey("RWST").OrderBy(x => x.DisplayText != "Select One").ThenBy(x => x.DisplayText).Select(x =>
            //              new SelectListItem()
            //              {
            //                  Text = x.DisplayText.ToString(),
            //                  Value = x.DataValue.ToString()
            //              }).ToList();




            //ViewBag.LeadSourceTypeList = _Util.Facade.LookupFacade.GetLookupByKey("LeadSourceType").OrderBy(x => x.DisplayText != "Select One").ThenBy(x => x.DisplayText).Select(x =>
            //              new SelectListItem()
            //              {
            //                  Text = x.DisplayText.ToString(),
            //                  Value = x.DataValue.ToString()
            //              }).ToList();


            //ViewBag.CentralStationAgreement = _Util.Facade.LookupFacade.GetLookupByKey("CentralStationAgreement").OrderBy(x => x.DisplayText != "Select One").ThenBy(x => x.DisplayText).Select(x =>
            //              new SelectListItem()
            //              {
            //                  Text = x.DisplayText.ToString(),
            //                  Value = x.DataValue.ToString()
            //              }).ToList();

            //ViewBag.FinanceCompanyList = _Util.Facade.LookupFacade.GetLookupByKey("FinanceCompany").OrderBy(x => x.DisplayText != "Select One").ThenBy(x => x.DisplayText).Select(x =>
            //              new SelectListItem()
            //              {
            //                  Text = x.DisplayText.ToString(),
            //                  Value = x.DataValue.ToString()
            //              }).ToList();

            //ViewBag.CustomerAccountTypeLookup = _Util.Facade.LookupFacade.GetLookupByKey("CustomerAccountType").Where(x => x.DataValue != "-1").Select(x =>
            //               new SelectListItem()
            //               {
            //                   Text = x.DisplayText.ToString(),
            //                   Value = x.DataValue.ToString()
            //               }).ToList();

            //ViewBag.YesNoList = _Util.Facade.LookupFacade.GetLookupByKey("FundedStatus").Select(x =>
            //                    new SelectListItem()
            //                    {
            //                        Text = x.DisplayText.ToString(),
            //                        Value = x.DataValue
            //                    }).ToList();

            ViewBag.TimeToCall = _Util.Facade.LookupFacade.GetLookupByKey("TimeToCall").Select(x =>
                              new SelectListItem()
                              {
                                  Text = x.DisplayText.ToString(),
                                  Value = x.DataValue.ToString()
                              }).ToList();
            //List<SelectListItem> creditGradeList = new List<SelectListItem>();
            //creditGradeList.Add(new SelectListItem()
            //{
            //    Text = "Select One",
            //    Value = "-1"
            //});

            //creditGradeList.AddRange(_Util.Facade.CustomerFacade.GetAllCreditScoreGrade().Select(x =>
            //          new SelectListItem()
            //          {
            //              Text = x.Grade.ToString() + " (" + x.MinScore + " - " + x.MaxScore + ")",
            //              Value = x.ID.ToString()
            //          }).ToList());
            //ViewBag.CreditScore = creditGradeList;

            ViewBag.StateList = _Util.Facade.LookupFacade.GetLookupByKey("StateList").Select(x =>
                           new SelectListItem()
                           {
                               Text = x.DisplayText.ToString(),
                               Value = x.DataValue.ToString()
                           }).ToList();
            ViewBag.PaymentMethod = _Util.Facade.LookupFacade.GetLookupByKey("PaymentMethod").Select(x =>
                            new SelectListItem()
                            {
                                Text = x.DisplayText.ToString(),
                                Value = x.DataValue.ToString()
                            }).ToList();

            ViewBag.BrinksFundingStatusList = _Util.Facade.LookupFacade.GetLookupByKey("BrinksFundingStatus").Select(x =>
                          new SelectListItem()
                          {
                              Text = x.DisplayText.ToString(),
                              Value = x.DataValue.ToString()
                          }).ToList();
            ViewBag.FinanceFundingStatusList = _Util.Facade.LookupFacade.GetLookupByKey("FainanceFundingStatus").Select(x =>
                        new SelectListItem()
                        {
                            Text = x.DisplayText.ToString(),
                            Value = x.DataValue.ToString()
                        }).ToList();

            //ViewBag.BillCycle = _Util.Facade.LookupFacade.GetLookupByKey("BillCycle").Select(x =>
            //                new SelectListItem()
            //                {
            //                    Text = x.DisplayText.ToString(),
            //                    Value = x.DataValue.ToString()
            //                }).ToList();
            ViewBag.EmployeeName = _Util.Facade.EmployeeFacade.GetAllEmployee(CurrentLoggedInUser.CompanyId.Value).Select(x =>
                                  new SelectListItem()
                                  {
                                      Text = x.FirstName.ToString() + " " + x.LastName.ToString(),
                                      Value = x.UserId.ToString()
                                  }).ToList();
            //List<SelectListItem> InstallerList = new List<SelectListItem>();
            //InstallerList.Add(new SelectListItem()
            //{
            //    Text = "Please Select One",
            //    Value = ""
            //});
            ////InstallerList.AddRange(_Util.Facade.EmployeeFacade.GetAllInstallerEmployeeByCompnayId(CurrentUser.CompanyId.Value).Select(x =>
            ////                new SelectListItem()
            ////                {
            ////                    Text = x.FirstName + " " + x.LastName,
            ////                    Value = x.EmployeeId.ToString()
            ////                }).ToList());
            //List<Employee> EmployeeDropDownList = _Util.Facade.EmployeeFacade.GetEmployeeByCompanyIdAndTag(CurrentUser.CompanyId.Value, LabelHelper.UserTags.Installer, new Guid());
            //if (EmployeeDropDownList != null && EmployeeDropDownList.Count > 0)
            //{
            //    InstallerList.AddRange(EmployeeDropDownList.OrderBy(x => x.FirstName).Select(x =>
            //               new SelectListItem()
            //               {
            //                   Text = x.FirstName + " " + x.LastName,
            //                   Value = x.UserId.ToString()
            //               }).ToList());
            //}

            //ViewBag.InstallerList = InstallerList;


            //List<SelectListItem> FundingCompany = new List<SelectListItem>();
            //FundingCompany.Add(new SelectListItem() { Text = "Please Select One", Value = "-1" });
            //FundingCompany.AddRange(_Util.Facade.FundFacade.GetAllFundingCompany().Select(x =>
            //                 new SelectListItem()
            //                 {
            //                     Text = x.Name.ToString(),
            //                     Value = x.Value.ToString()
            //                 }).ToList());
            //ViewBag.FundingCompany = FundingCompany;

            //ViewBag.BillYesNo = _Util.Facade.LookupFacade.GetLookupByKey("CustomerTaxYesNo").Select(x =>
            //                 new SelectListItem()
            //                 {
            //                     Text = x.DisplayText.ToString(),
            //                     Value = x.DataValue.ToString(),
            //                     Selected = x.IsDefaultItem == true
            //                 }).ToList();
            #region Sales Person Initials
            //List<SelectListItem> SalesPersonList = new List<SelectListItem>();
            //if (IsPermitted(UserPermissions.MyCompanyPermissions.ShowAllSalesPerson))
            //{
            //    var objcurrentlog = _Util.Facade.EmployeeFacade.GetEmployeeByEmployeeId(CurrentLoggedInUser.UserId);
            //    SalesPersonList.Add(new SelectListItem()
            //    {
            //        Text = "Please Select One",
            //        Value = ""
            //    });
            //    List<Employee> Employeelist = _Util.Facade.EmployeeFacade.GetEmployeeByCompanyIdAndTag(CurrentLoggedInUser.CompanyId.Value, LabelHelper.UserTags.SalesPerson, new Guid()).Where(x => x.UserId != CurrentLoggedInUser.UserId).ToList();
            //    if (!string.IsNullOrEmpty(model.Soldby))
            //    {
            //        Guid SoldBy = Guid.Empty;
            //        Guid.TryParse(model.Soldby, out SoldBy);
            //        var SoldByEmployeeDetails = _Util.Facade.EmployeeFacade.GetEmployeeByEmployeeId(SoldBy);
            //        if (SoldByEmployeeDetails != null && SoldByEmployeeDetails.IsActive == false)
            //        {
            //            Employeelist.Add(SoldByEmployeeDetails);
            //            SalesPersonList.Add(new SelectListItem()
            //            {
            //                Text = SoldByEmployeeDetails.FirstName + " " + objcurrentlog.LastName,
            //                Value = SoldByEmployeeDetails.UserId.ToString(),
            //                Selected = true
            //            });
            //        }
            //    }
            //    if (objcurrentlog != null)
            //    {
            //        Employeelist.Add(objcurrentlog);
            //        SalesPersonList.Add(new SelectListItem()
            //        {
            //            Text = objcurrentlog.FirstName + " " + objcurrentlog.LastName,
            //            Value = objcurrentlog.UserId.ToString(),
            //            Selected = true
            //        });
            //    }
            //    SalesPersonList.AddRange(Employeelist.Select(x =>
            //              new SelectListItem()
            //              {
            //                  Text = x.FirstName.ToString() + " " + x.LastName.ToString(),
            //                  Value = x.UserId.ToString()
            //              }).ToList());
            //    ViewBag.EmployeeList = Employeelist.OrderBy(x => x.FirstName + " " + x.LastName != "Please Select One").ThenBy(x => x.FirstName + " " + x.LastName).ToList();
            //    ViewBag.SalesPersonList = SalesPersonList.OrderBy(x => x.Text != "Please Select One").ThenBy(x => x.Text).ToList();
            //}
            //else
            //{
            //    var objEmpCus = _Util.Facade.EmployeeFacade.GetEmployeeByEmployeeId(CurrentLoggedInUser.UserId);
            //    if (objEmpCus != null)
            //    {
            //        SalesPersonList.Add(new SelectListItem()
            //        {
            //            Text = objEmpCus.FirstName.ToString() + " " + objEmpCus.LastName.ToString(),
            //            Value = CurrentLoggedInUser.UserId.ToString()
            //        });
            //        ViewBag.SalesPersonList = SalesPersonList;
            //    }
            //}
            #endregion
            #region viewbag contract terms
            //List<SelectListItem> ContactTerms = new List<SelectListItem>();
            //ContactTerms.AddRange(_Util.Facade.LookupFacade.GetDropdownsByKey("ContractTerm"));

            //if (model != null && model.CustomerId != null && !string.IsNullOrEmpty(model.ContractTeam) && model.ContractTeam != "3" && model.ContractTeam != "5")
            //{
            //    var packid = _Util.Facade.PackageFacade.GetPackageCustomerByCustomerIdandCompanyId(model.CustomerId, CurrentLoggedInUser.CompanyId.Value);
            //    if (packid != null)
            //    {
            //        var PackageDetails = _Util.Facade.SmartPackageFacade.GetSmartPackageByPackageId(packid.PackageId);
            //        if (PackageDetails != null && PackageDetails.NonConforming == true)
            //        {
            //            var ContractTeamSet = Convert.ToDouble(model.ContractTeam) * 12;
            //            ContactTerms.Add(new SelectListItem() { Value = model.ContractTeam.ToString(), Text = ContractTeamSet.ToString() + " Month" });
            //        }
            //    }
            //}
            //ViewBag.ContractTerm = ContactTerms;
            #endregion
            #region ViewBags
            TicketFilter ticketFilter = new TicketFilter();
            ticketFilter.CompanyId = CurrentLoggedInUser.CompanyId.Value;
            ticketFilter.CustomerId = model.CustomerId;
            ticketFilter.TicketType = _Util.Facade.GlobalSettingsFacade.GetAllGlobalSettingsByCompanyId(CurrentLoggedInUser.CompanyId.Value).Where(x => x.SearchKey == "DefaultTicketType").FirstOrDefault().Value;
            //ticketFilter.TicketStatus = "Created";
            ticketFilter.PageNo = 1;
            ticketFilter.PageSize = 50;
            ticketFilter.SearchText = "";
            //ticketFilter.
            TicketListModel ticketListModel = _Util.Facade.TicketFacade.GetTicketListByCustomerIdAndFilter(ticketFilter, null);
            Ticket tickets = ticketListModel.Tickets.FirstOrDefault();
            if (tickets != null)
            {
                if (tickets.Id > 0)
                {
                    #region Existing Ticket
                    Model.Ticket = tickets;

                    if (Model.Ticket != null)
                    {
                        if (Model.Ticket.CompanyId != CurrentLoggedInUser.CompanyId.Value)
                        {
                            return PartialView("~/Views/Shared/_AccessDenied.cshtml");
                        }
                        List<TicketUser> UserList = _Util.Facade.TicketFacade.GetTicketUserListByTicketId(Model.Ticket.TicketId);
                        if (UserList.Count() > 0)
                        {
                            Model.TicketAssignedUserList = UserList.Where(x => x.IsPrimary == true && (!x.NotificationOnly.HasValue || !x.NotificationOnly.Value)).ToList();
                            Model.TicketUserList = UserList.Where(x => x.IsPrimary == false && (!x.NotificationOnly.HasValue || !x.NotificationOnly.Value)).ToList();
                            Model.NotifyingUserList = UserList.Where(x => x.IsPrimary == false && x.NotificationOnly.HasValue && x.NotificationOnly.Value).ToList();
                        }

                        Model.TicketReplyList = _Util.Facade.TicketFacade.GetAllTicketReplyByTicketId(Model.Ticket.TicketId, null);
                        Model.CustomerAppointment = _Util.Facade.CustomerAppoinmentFacade.GetAllCustomerAppointmentByAppIdCusId(Model.Ticket.TicketId, Model.Ticket.CustomerId);
                        if (Model.CustomerAppointment != null && Model.CustomerAppointment.AppointmentId != new Guid())
                        {
                            Model.CustomerAppointmentEquipmentList = _Util.Facade.CustomerAppoinmentFacade.GetAllCustomerAppointmentEquipListByAppointmentId(Model.Ticket.TicketId);
                            Model.Ticket.AppointmentStartTime = Model.CustomerAppointment.AppointmentStartTime;
                            Model.Ticket.AppointmentEndTime = Model.CustomerAppointment.AppointmentEndTime;
                            // = _Util.Facade.CustomerAppoinmentFacade.IsAppointmentEquipmentExistCheck(AppointmentId);
                        }
                    }
                    #endregion
                }
            }
            else
            {
                tickets = new Ticket();
            }
            if (Model.TicketAssignedUserList == null)
            {
                Model.TicketAssignedUserList = new List<TicketUser>();
            }
            ViewBag.AssignedEmployee = EmpList.Select(x => new SelectListItem()
            {
                Text = x.FirstName + " " + x.LastName,
                Value = x.UserId.ToString(),
                Selected = Model.TicketAssignedUserList.Count(y => y.UserId == x.UserId) > 0
            }).ToList();


            #region Duplicate Customer
            //List<SelectListItem> DuplicateCustomerList = new List<SelectListItem>();
            //if (model.DuplicateCustomer == Guid.Empty)
            //{
            //    DuplicateCustomerList.Add(new SelectListItem
            //    {
            //        Text = LanguageHelper.T("Customer"),
            //        Value = "00000000-0000-0000-0000-000000000000"
            //    });
            //}
            //else
            //{
            //    Customer DuplicateCustomer = _Util.Facade.CustomerFacade.GetCustomerByCustomerId(model.DuplicateCustomer);
            //    if (DuplicateCustomer != null)
            //    {
            //        DuplicateCustomerList.Add(new SelectListItem
            //        {
            //            Text = string.IsNullOrWhiteSpace(DuplicateCustomer.BusinessName) ? (DuplicateCustomer.FirstName + " " + DuplicateCustomer.LastName) : DuplicateCustomer.BusinessName,
            //            Value = DuplicateCustomer.CustomerId.ToString()
            //        });
            //    }
            //}
            //ViewBag.DuplicateCustomerList = DuplicateCustomerList;
            #endregion

            //List<SelectListItem> CustomerList = new List<SelectListItem>();
            //List<SelectListItem> ContactList = new List<SelectListItem>();
            //if (model.ReferringCustomer == new Guid())
            //{
            //    CustomerList.Add(new SelectListItem
            //    {
            //        Text = HS.Web.UI.Helper.LanguageHelper.T("Customer"),
            //        Value = "00000000-0000-0000-0000-000000000000"
            //    });
            //    ContactList.Add(new SelectListItem
            //    {
            //        Text = LanguageHelper.T("Contact"),
            //        Value = "00000000-0000-0000-0000-000000000000"
            //    });
            //}
            //else
            //{
            //    Customer RefCustomer = _Util.Facade.CustomerFacade.GetCustomerByCustomerId(model.ReferringCustomer);
            //    Contact RefContact = _Util.Facade.ContactFacade.GetContactbyContactId(model.ReferringCustomer);
            //    if (RefCustomer != null)
            //    {
            //        CustomerList.Add(new SelectListItem
            //        {
            //            Text = string.IsNullOrWhiteSpace(RefCustomer.BusinessName) ? (RefCustomer.FirstName + " " + RefCustomer.LastName) : RefCustomer.BusinessName,
            //            Value = RefCustomer.CustomerId.ToString()
            //        });
            //    }
            //    if (RefContact != null)
            //    {
            //        ContactList.Add(new SelectListItem
            //        {
            //            Text = (RefContact.FirstName + " " + RefContact.LastName),
            //            Value = RefContact.ContactId.ToString()
            //        });
            //    }
            //}

            //ViewBag.CustomerList = CustomerList;
            //ViewBag.ContactList = ContactList;


            //List<SelectListItem> ChildCustomerList = new List<SelectListItem>();
            //if (model.ChildOf == new Guid())
            //{
            //    ChildCustomerList.Add(new SelectListItem
            //    {
            //        Text = LanguageHelper.T("Customer"),
            //        Value = "00000000-0000-0000-0000-000000000000"
            //    });
            //}
            //else
            //{
            //    Customer childCustomer = _Util.Facade.CustomerFacade.GetCustomerByCustomerId(model.ChildOf);
            //    if (childCustomer != null)
            //    {
            //        ChildCustomerList.Add(new SelectListItem
            //        {
            //            Text = string.IsNullOrWhiteSpace(childCustomer.BusinessName) ? (childCustomer.FirstName + " " + childCustomer.LastName) : childCustomer.BusinessName,
            //            Value = childCustomer.CustomerId.ToString()
            //        });
            //    }
            //}

            //ViewBag.ChildCustomerList = ChildCustomerList;

            List<SelectListItem> MonitoringList = new List<SelectListItem>();
            MonitoringList.Add(new SelectListItem()
            {
                Text = LanguageHelper.T("Please Select"),
                Value = String.Empty
            });
            List<MMR> MMRDropDownList = _Util.Facade.CustomerFacade.GetMMRValueListByCompanyId(CurrentLoggedInUser.CompanyId.Value);
            if (MMRDropDownList != null && MMRDropDownList.Count > 0)
            {
                MonitoringList.AddRange(MMRDropDownList.OrderBy(x => x.Name).Select(x =>
                            new SelectListItem()
                            {
                                Text = x.Name.ToString(),
                                Value = x.Value.ToString(),
                                Selected = (model.MonthlyMonitoringFee == x.Value.ToString())
                            }).ToList());
            }

            ViewBag.MonthlyMonitoringFee = MonitoringList;


            //Guid cusid = model.CustomerId;
            ViewBag.sysid = _Util.Facade.CustomerFacade.GetCustomerSystemInfoIdByCompanyId(CurrentLoggedInUser.CompanyId.Value, model.CustomerId);
            ViewBag.sysLastDate = _Util.Facade.CustomerFacade.GetCustomerSystemInfoLastUpdateDateByCompanyIdandCustomerId(CurrentLoggedInUser.CompanyId.Value, model.CustomerId);
            //bool bitvalue = bool.Parse(ViewBag.sysLastDate);
            if (ViewBag.sysid != "")
            {
                model.CustomerSystemId = Int32.Parse(ViewBag.sysid);
            }
            if (ViewBag.sysLastDate != "true")
            {
                model.CustomerSystemCompanyId = CurrentLoggedInUser.CompanyId.Value;
                model.CustomerSystemCustomerId = model.CustomerId;
            }

            ViewBag.salesTaxAmount = "0.0";
            Guid tempCustomerId = new Guid();
            if (model != null)
            {
                tempCustomerId = model.CustomerId;
            }
            var salesTaxAmountObj = _Util.Facade.GlobalSettingsFacade.GetSalesTax(CurrentLoggedInUser.CompanyId.Value, tempCustomerId);
            if (salesTaxAmountObj != null)
            {
                ViewBag.salesTaxAmount = salesTaxAmountObj.Value;
            }
            if (paymentGetway.Value == LabelHelper.PaymentGetway.Authorize)
            {
                ViewBag.BillCycle = _Util.Facade.LookupFacade.GetDropdownsByKey("BillCycle");
            }
            else
            {
                ViewBag.BillCycle = _Util.Facade.LookupFacade.GetDropdownsByKey("ForteBillCycle");
            }

            //ViewBag.BussinessAccountType = _Util.Facade.LookupFacade.GetDropdownsByKey("BussinessAccountType");
            //ViewBag.InstalledStatus = _Util.Facade.LookupFacade.GetDropdownsByKey("InstalledStatus");
            //ViewBag.PreferredContactMethod = _Util.Facade.LookupFacade.GetDropdownsByKey("PreferredContactMethod");

            List<SelectListItem> EmployeeNameList = new List<SelectListItem>();
            EmployeeNameList.Add(new SelectListItem()
            {
                Text = "Please Select One",
                Value = ""
            });
            List<Employee> EmployeeDropDown = EmployeeList;
            if (EmployeeDropDown != null && EmployeeDropDown.Count > 0)
            {
                EmployeeNameList.AddRange(EmployeeDropDown.OrderBy(x => x.FirstName).Select(x =>
                                  new SelectListItem()
                                  {
                                      Text = x.FirstName.ToString() + " " + x.LastName.ToString(),
                                      Value = x.UserId.ToString()
                                  }).ToList());
            }

            ViewBag.EmployeeNameList = EmployeeNameList;
            List<SelectListItem> QualityAssuranceList1 = new List<SelectListItem>();
            QualityAssuranceList1.Add(new SelectListItem()
            {
                Text = "Please Select One",
                Value = ""
            });
            List<Employee> EmployeeDropDownList = EmployeeList;
            if (EmployeeDropDownList != null && EmployeeDropDownList.Count > 0)
            {
                QualityAssuranceList1.AddRange(EmployeeDropDownList.OrderBy(x => x.FirstName).Select(x =>
                                  new SelectListItem()
                                  {
                                      Text = x.FirstName.ToString() + " " + x.LastName.ToString(),
                                      Value = x.UserId.ToString()
                                  }).ToList());
            }

            ViewBag.QualityAssuranceList1 = QualityAssuranceList1;
            List<SelectListItem> QualityAssuranceList2 = new List<SelectListItem>();
            QualityAssuranceList2.Add(new SelectListItem()
            {
                Text = "Please Select One",
                Value = ""
            });
            List<Employee> EmployeeDropDownList2 = EmployeeList;
            QualityAssuranceList2.AddRange(EmployeeDropDownList2.OrderBy(x => x.FirstName).Select(x =>
                                  new SelectListItem()
                                  {
                                      Text = x.FirstName.ToString() + " " + x.LastName.ToString(),
                                      Value = x.UserId.ToString()
                                  }).ToList());
            ViewBag.QualityAssuranceList2 = QualityAssuranceList2;
            //ViewBag.LeadStreetType = _Util.Facade.LookupFacade.GetDropdownsByKey("LeadStreetType");

            //ViewBag.BillingDay = _Util.Facade.LookupFacade.GetDropdownsByKey("BillingDay");
            #endregion

            #region alarm.com dropdowns

            SetupAlarm AlarmModel = _Util.Facade.AlarmFacade.GetSetupalarmByCustomerId(model.CustomerId);
            if (AlarmModel == null || model.CustomerId == new Guid())
            {
                AlarmModel = new SetupAlarm()
                {
                    CustomerId = model.CustomerId,
                    CompanyId = CurrentLoggedInUser.CompanyId.Value,
                    Phone = model.PrimaryPhone,
                    InsCity = model.City,
                    InsState = model.State,
                    InsZip = model.ZipCode,
                    EmailAddress = model.EmailAddress,
                };
                if (!string.IsNullOrWhiteSpace(model.CustomerNo))
                {
                    string[] str = model.CustomerNo.Split(new[] { "FLV12" }, StringSplitOptions.None);
                    if (str.Count() == 2)
                    {
                        AlarmModel.CentralStationAccountNo = str[1];
                    }
                }
            }
            ViewBag.SetupAlarm = AlarmModel;


            ViewBag.CentralStationForwardingOption = _Util.Facade.LookupFacade.GetDropdownsByKey("CentralStationForwardingOption");

            ViewBag.PanelTypeEnum = _Util.Facade.LookupFacade.GetDropdownsByKey("PanelTypeEnum");

            ViewBag.PanelVersionEnum = _Util.Facade.LookupFacade.GetDropdownsByKey("PanelVersionEnum");

            //ViewBag.PropertyTypeEnum = _Util.Facade.LookupFacade.GetDropdownsByKey("PropertyTypeEnum");

            ViewBag.CultureEnum = _Util.Facade.LookupFacade.GetDropdownsByKey("CultureEnum");

            ViewBag.StateList = _Util.Facade.LookupFacade.GetDropdownsByKey("StateList");

            #endregion
            model.Ticket = tickets;

            //ViewBag.OwnerShipList = _Util.Facade.LookupFacade.GetDropdownsByKey("OwnerShip");

            //ViewBag.BestTimeToCallList = _Util.Facade.LookupFacade.GetDropdownsByKey("BestTimeToCall");

            //ViewBag.CSProviderList = _Util.Facade.LookupFacade.GetDropdownsByKey("CSProvider");

            //ViewBag.LeadMarket = _Util.Facade.LookupFacade.GetDropdownsByKey("LeadMarket");

            //ViewBag.SourceLead = _Util.Facade.LookupFacade.GetDropdownsByKey("LeadSource");

            //ViewBag.AppoinmentSetList = _Util.Facade.LookupFacade.GetDropdownsByKey("AppoinmentSet");

            //ViewBag.TermList = _Util.Facade.LookupFacade.GetDropdownsByKey("TermList");

            //ViewBag.LeadStatus = _Util.Facade.LookupFacade.GetDropdownsByKey("LeadStatus");

            //ViewBag.CustomerStatus = _Util.Facade.LookupFacade.GetDropdownsByKey("CustomerStatus1");

            //ViewBag.ContractedPrevious = _Util.Facade.LookupFacade.GetDropdownsByKey("ContractYesNo");

            //ViewBag.IsFinancedList = _Util.Facade.LookupFacade.GetDropdownsByKey("IsFinanced");

            //ViewBag.IsPets = _Util.Facade.LookupFacade.GetDropdownsByKey("Pets");

            //ViewBag.TypeOfPets = _Util.Facade.LookupFacade.GetDropdownsByKey("TypeOfPets");

            //ViewBag.IsRepair = _Util.Facade.LookupFacade.GetDropdownsByKey("Repair");

            //ViewBag.IsVipClubMember = _Util.Facade.LookupFacade.GetDropdownsByKey("VipClubMember");



            //ViewBag.TypeOfRepair = _Util.Facade.LookupFacade.GetDropdownsByKey("TypeOfRepair");


            #region Credit Check Info
            CustomerCreditCheck creditCheck = new CustomerCreditCheck();
            creditCheck = _Util.Facade.CustomerFacade.GetAllCustomerCreditCheckByCustomerId(model.CustomerId).FirstOrDefault();


            if (creditCheck != null)
            {
                model.CreditCheck = creditCheck;
                ViewBag.HasCreditCheck = "true";

            }
            else
            {
                model.CreditCheck = null;
                ViewBag.HasCreditCheck = "false";
            }
            if (CurrentLoggedInUser.UserTags.Contains("admin"))
            {
                ViewBag.IsShowReport = "true";
            }
            else
            {
                ViewBag.IsShowReport = "false";
            }
            GlobalSetting GlobSet = _Util.Facade.GlobalSettingsFacade.GetGlobalsettingBySearchKeyAndCompanyId("PassingCreditScore", CurrentLoggedInUser.CompanyId.Value);
            if (GlobSet != null)
            {
                ViewBag.CreditScoreValue = GlobSet.Value;
            }
            else
            {
                ViewBag.CreditScoreValue = 0;
            }



            #endregion


            #region CreditScore
            ViewBag.CreditGrade = "";
            if (model.CreditScoreValue != null && model.CreditScoreValue > 0)
            {
                CreditScoreGrade creditscoreGrade = _Util.Facade.CustomerFacade.GetCreditScoreGradeByScoreRange(model.CreditScoreValue.Value);
                if (creditscoreGrade != null)
                {
                    ViewBag.CreditGrade = creditscoreGrade.ID;
                }

            }

            #endregion
            var objEmp = _Util.Facade.EmployeeFacade.GetEmployeeByEmployeeId(CurrentLoggedInUser.UserId);
            if (string.IsNullOrWhiteSpace(model.Soldby) && (model.SalesLocation == "" || model.SalesLocation == "-1" || model.SalesLocation == null))
            {
                model.SalesLocation = objEmp.SalesCommissionStructure;
            }
            if (!string.IsNullOrWhiteSpace(model.Soldby))
            {
                ViewBag.SelectSoldby = model.Soldby;
            }
            else
            {
                ViewBag.SelectSoldby = objEmp.UserId.ToString();


            }
            if (model.CustomerExtended != null && model.CustomerExtended.FinanceRep != null && model.CustomerExtended.FinanceRep != new Guid("00000000-0000-0000-0000-000000000000"))
            {
                ViewBag.SelectSoldbyFin = model.CustomerExtended.FinanceRep;
            }

            else
            {
                //ViewBag.SelectSoldbyFin = objEmp.UserId;

            }

            if (model.CustomerExtended != null && model.CustomerExtended.AppoinmentSetBy != null && model.CustomerExtended.AppoinmentSetBy != new Guid("00000000-0000-0000-0000-000000000000"))
            {
                ViewBag.SelectAppoinmentBy = model.CustomerExtended.AppoinmentSetBy;
            }
            //else
            //{
            //    ViewBag.SelectAppoinmentBy = objEmp.UserId;

            //}

            //List<CompanyBranch> CompanyBranchDropDown = _Util.Facade.CompanyBranchFacade.GetAllCompanyBranchByCompanyId(CurrentLoggedInUser.CompanyId.Value);
            //if (model.BranchId != null && model.BranchId > 0)
            //{
            //    if (CompanyBranchDropDown != null && CompanyBranchDropDown.Count > 0)
            //    {
            //        BranchList.AddRange(CompanyBranchDropDown.OrderBy(x => x.Id.ToString() != "-1").ThenBy(x => x.Name).Select(x => new SelectListItem()
            //        {
            //            Text = x.Name,
            //            Value = x.Id.ToString(),
            //            Selected = x.Id == model.BranchId,
            //        }).ToList());
            //    }
            //}
            //else
            //{
            //    if (CompanyBranchDropDown != null && CompanyBranchDropDown.Count > 0)
            //    {
            //        BranchList.AddRange(CompanyBranchDropDown.OrderBy(x => x.Id.ToString() != "-1").ThenBy(x => x.Name).Select(x => new SelectListItem()
            //        {
            //            Text = x.Name,
            //            Value = x.Id.ToString(),
            //            Selected = x.IsMainBranch == true,
            //        }).ToList());
            //    }
            //}
            //ViewBag.BranchList = BranchList.ToList();
            if (model.CustomerExtended == null)
            {
                model.CustomerExtended = new CustomerExtended();
            }
            if (model.CustomerExtended.ContractStartDate == null || model.CustomerExtended.ContractStartDate == new DateTime())
            {
                model.CustomerExtended.ContractStartDate = DateTime.Now.Date;
            }


            string conterm = "";
            int term = 0;
            double contract;
            if (model != null)
            {
                bool success = Double.TryParse(model.ContractTeam, out contract);
                if (success)
                {
                    term = Convert.ToInt32(Math.Round(contract * 12));
                    ViewBag.termid = term;
                    if (term > 1)
                    {
                        ViewBag.TermMonth = " month";
                    }
                    else
                    {
                        ViewBag.TermMonth = " month";
                    }
                }
                if (string.IsNullOrWhiteSpace(model.CustomerExtended.RemainingContractTerm))
                {
                    conterm = string.Concat(ViewBag.termid, ViewBag.TermMonth);
                    model.CustomerExtended.RemainingContractTerm = (Convert.ToDouble(ViewBag.termid) / 12).ToString();
                }
                else
                {
                    CustomerExtended _extended = _Util.Facade.CustomerFacade.GetCustomerExtendedByCustomerId(model.CustomerId);
                    if (_extended != null)
                    {
                        term = Convert.ToInt32(Math.Round(Convert.ToDouble(_extended.RemainingContractTerm) * 12));
                        conterm = string.Concat(term, ViewBag.TermMonth);
                        model.CustomerExtended.RemainingContractTerm = (Convert.ToDouble(term) / 12).ToString();
                    }
                }
            }
            //List<SelectListItem> taxexemplist = new List<SelectListItem>();
            //taxexemplist.Add(new SelectListItem()
            //{
            //    Text = "Please Select One",
            //    Value = "-1"
            //});
            //taxexemplist.AddRange(_Util.Facade.LookupFacade.GetLookupByKey("TaxExemption").Select(x =>
            //new SelectListItem()
            //{
            //    Text = x.DisplayText.ToString(),
            //    Value = x.DataValue.ToString(),

            //}).ToList());
            //ViewBag.TaxExemptionList = taxexemplist;
            #region Cancellation Exist
            bool CancellationExist = false;
            if (model != null && model.CustomerId != new Guid())
            {
                var CustomerCanelllation = _Util.Facade.CustomerFacade.GetActiveCustomerQueueCancellationByCustomerId(model.CustomerId);
                if (CustomerCanelllation.Count > 0)
                {
                    CancellationExist = true;
                }
            }
            ViewBag.CancellationExist = CancellationExist;

            bool CancellationDocumentPostSend = false;
            GlobalSetting GlobSet2 = _Util.Facade.GlobalSettingsFacade.GetGlobalsettingBySearchKeyAndCompanyId("CancellationDocumentPostSend", CurrentLoggedInUser.CompanyId.Value);
            if (GlobSet2 != null && !string.IsNullOrWhiteSpace(GlobSet2.Value))
            {
                if (GlobSet2.Value == "true")
                {
                    CancellationDocumentPostSend = true;
                }
            }
            ViewBag.CancellationDocumentPostSend = CancellationDocumentPostSend;
            #endregion

            //double MonthlyFeeTemp = Math.Round(Convert.ToDouble(model.MonthlyMonitoringFee), 2);
            List<GridSetting> getcustomerdropdown = _Util.Facade.GridSettingsFacade.GetAllCustomerFilterSettingByKeyAndCompanyIdAndIsActive(CurrentLoggedInUser.CompanyId.Value);
            foreach (var item in getcustomerdropdown)
            {
                string columnname = item.SelectedColumn.ToLower();

                switch (columnname)
                {

                    case "businessaccounttype":

                        ViewBag.BussinessAccountType = _Util.Facade.LookupFacade.GetDropdownsByKey("BussinessAccountType");


                        break;

                    case "installedstatus":

                        ViewBag.InstalledStatus = _Util.Facade.LookupFacade.GetDropdownsByKey("InstalledStatus");


                        break;

                    case "ownership":

                        ViewBag.OwnerShipList = _Util.Facade.LookupFacade.GetDropdownsByKey("OwnerShip");


                        break;

                    case "type":

                        ViewBag.CustomerTypeList = _Util.Facade.LookupFacade.GetLookupByKey("CustomerType").OrderBy(x => x.DisplayText != "Select One").ThenBy(x => x.DisplayText).Select(x =>
                                              new SelectListItem()
                                              {
                                                  Text = x.DisplayText.ToString(),
                                                  Value = x.DataValue.ToString()
                                              }).ToList();

                        break;

                    case "csprovider":

                        ViewBag.CSProviderList = _Util.Facade.LookupFacade.GetDropdownsByKey("CSProvider");


                        break;

                    case "besttimetocall":

                        ViewBag.BestTimeToCallList = _Util.Facade.LookupFacade.GetDropdownsByKey("BestTimeToCall");


                        break;

                    case "customeraccounttype":


                        ViewBag.CustomerAccountTypeLookup = _Util.Facade.LookupFacade.GetLookupByKey("CustomerAccountType").Where(x => x.DataValue != "-1").Select(x =>
                                       new SelectListItem()
                                       {
                                           Text = x.DisplayText.ToString(),
                                           Value = x.DataValue.ToString()
                                       }).ToList();

                        break;


                    case "preferredcontactmethod":


                        ViewBag.PreferredContactMethod = _Util.Facade.LookupFacade.GetDropdownsByKey("PreferredContactMethod");


                        break;


                    case "accessgivento":


                        List<SelectListItem> AccessAssignedPersons = new List<SelectListItem>();
                        AccessAssignedPersons.Add(new SelectListItem()
                        {
                            Text = "Access Assign To",
                            Value = "-1"
                        });
                        List<Employee> EmployeeListDropDown = EmployeeList;
                        if (EmployeeListDropDown != null && EmployeeListDropDown.Count > 0)
                        {
                            AccessAssignedPersons.AddRange(EmployeeListDropDown.OrderBy(x => x.FirstName).Select(x => new SelectListItem()
                            {
                                Text = x.FirstName.ToString() + " " + x.LastName.ToString(),
                                Value = x.UserId.ToString()
                            }).ToList());
                        }

                        ViewBag.AccessAssignedPersons = AccessAssignedPersons;

                        break;
                    case "resignedby":
                        List<SelectListItem> ResignedByItem = new List<SelectListItem>();
                        ResignedByItem.Add(new SelectListItem()
                        {
                            Text = "Please Select",
                            Value = "-1"
                        });
                        if (EmployeeList != null && EmployeeList.Count > 0)
                        {
                            ResignedByItem.AddRange(EmployeeList.OrderBy(x => x.FirstName).Select(x => new SelectListItem()
                            {
                                Text = x.FirstName.ToString() + " " + x.LastName.ToString(),
                                Value = x.UserId.ToString()
                            }).ToList());
                        }
                        ViewBag.ResignedByList = ResignedByItem;
                        break;

                    case "leadsource":

                        List<SelectListItem> leadSourceList = new List<SelectListItem>();
                        if (CurrentLoggedInUser.UserRole == "Sales Rep - Outside")
                        {
                            leadSourceList.Add(new SelectListItem()
                            {
                                Text = "Outside Sales - Rep",
                                Value = "Outside Sales - Rep"
                            });


                        }
                        else
                        {
                            leadSourceList.AddRange(_Util.Facade.LookupFacade.GetLookupByKeyWithParent("LeadSource").OrderBy(x => x.DataValue != "-1").ThenBy(x => x.DataOrder).Select(x => new SelectListItem()
                            {
                                Text = x.DisplayText.ToString(),
                                Value = x.DataValue.ToString(),
                                Selected = model.LeadSource == x.DataValue
                            }).ToList());
                            if (leadSourceList.Where(x => x.Selected).Count() == 0)
                            {
                                leadSourceList.Where(x => x.Value == "-1").FirstOrDefault(x => x.Selected = true);
                                model.LeadSource = "-1";
                            }
                        }


                        ViewBag.SourceLead = leadSourceList;


                        break;

                    case "leadsourcetype":


                        ViewBag.LeadSourceTypeList = _Util.Facade.LookupFacade.GetLookupByKey("LeadSourceType").OrderBy(x => x.DisplayText != "Select One").ThenBy(x => x.DisplayText).Select(x =>
                                      new SelectListItem()
                                      {
                                          Text = x.DisplayText.ToString(),
                                          Value = x.DataValue.ToString()
                                      }).ToList();

                        break;

                    case "centralstationagreement":



                        ViewBag.CentralStationAgreement = _Util.Facade.LookupFacade.GetLookupByKey("CentralStationAgreement").OrderBy(x => x.DisplayText != "Select One").ThenBy(x => x.DisplayText).Select(x =>
                                      new SelectListItem()
                                      {
                                          Text = x.DisplayText.ToString(),
                                          Value = x.DataValue.ToString()
                                      }).ToList();

                        break;

                    case "financecompany":




                        ViewBag.FinanceCompanyList = _Util.Facade.LookupFacade.GetLookupByKey("FinanceCompany").OrderBy(x => x.DisplayText != "Select One").ThenBy(x => x.DisplayText).Select(x =>
                                      new SelectListItem()
                                      {
                                          Text = x.DisplayText.ToString(),
                                          Value = x.DataValue.ToString()
                                      }).ToList();

                        break;


                    case "duplicatecustomer":



                        List<SelectListItem> DuplicateCustomerList = new List<SelectListItem>();
                        if (model.DuplicateCustomer == Guid.Empty)
                        {
                            DuplicateCustomerList.Add(new SelectListItem
                            {
                                Text = LanguageHelper.T("Customer"),
                                Value = "00000000-0000-0000-0000-000000000000"
                            });
                        }
                        else
                        {
                            Customer DuplicateCustomer = _Util.Facade.CustomerFacade.GetCustomerByCustomerId(model.DuplicateCustomer);
                            if (DuplicateCustomer != null)
                            {
                                DuplicateCustomerList.Add(new SelectListItem
                                {
                                    Text = string.IsNullOrWhiteSpace(DuplicateCustomer.BusinessName) ? (DuplicateCustomer.FirstName + " " + DuplicateCustomer.LastName) : DuplicateCustomer.BusinessName,
                                    Value = DuplicateCustomer.CustomerId.ToString()
                                });
                            }
                        }
                        ViewBag.DuplicateCustomerList = DuplicateCustomerList;

                        break;

                    case "referringcustomer":


                        List<SelectListItem> CustomerList = new List<SelectListItem>();
                        List<SelectListItem> ContactList = new List<SelectListItem>();
                        if (model.ReferringCustomer == new Guid())
                        {
                            CustomerList.Add(new SelectListItem
                            {
                                Text = HS.Web.UI.Helper.LanguageHelper.T("Customer"),
                                Value = "00000000-0000-0000-0000-000000000000"
                            });
                            ContactList.Add(new SelectListItem
                            {
                                Text = LanguageHelper.T("Contact"),
                                Value = "00000000-0000-0000-0000-000000000000"
                            });
                        }
                        else
                        {
                            Customer RefCustomer = _Util.Facade.CustomerFacade.GetCustomerByCustomerId(model.ReferringCustomer);
                            Contact RefContact = _Util.Facade.ContactFacade.GetContactbyContactId(model.ReferringCustomer);
                            if (RefCustomer != null)
                            {
                                CustomerList.Add(new SelectListItem
                                {
                                    Text = string.IsNullOrWhiteSpace(RefCustomer.BusinessName) ? (RefCustomer.FirstName + " " + RefCustomer.LastName) : RefCustomer.BusinessName,
                                    Value = RefCustomer.CustomerId.ToString()
                                });
                            }
                            if (RefContact != null)
                            {
                                ContactList.Add(new SelectListItem
                                {
                                    Text = (RefContact.FirstName + " " + RefContact.LastName),
                                    Value = RefContact.ContactId.ToString()
                                });
                            }
                        }

                        ViewBag.CustomerList = CustomerList;
                        ViewBag.ContactList = ContactList;

                        break;


                    case "childof":


                        List<SelectListItem> ChildCustomerList = new List<SelectListItem>();
                        if (model.ChildOf == new Guid())
                        {
                            ChildCustomerList.Add(new SelectListItem
                            {
                                Text = LanguageHelper.T("Customer"),
                                Value = "00000000-0000-0000-0000-000000000000"
                            });
                        }
                        else
                        {
                            Customer childCustomer = _Util.Facade.CustomerFacade.GetCustomerByCustomerId(model.ChildOf);
                            if (childCustomer != null)
                            {
                                ChildCustomerList.Add(new SelectListItem
                                {
                                    Text = string.IsNullOrWhiteSpace(childCustomer.BusinessName) ? (childCustomer.FirstName + " " + childCustomer.LastName) : childCustomer.BusinessName,
                                    Value = childCustomer.CustomerId.ToString()
                                });
                            }
                        }

                        ViewBag.ChildCustomerList = ChildCustomerList;

                        break;

                    case "branchid":


                        List<CompanyBranch> CompanyBranchDropDown = _Util.Facade.CompanyBranchFacade.GetAllCompanyBranchByCompanyId(CurrentLoggedInUser.CompanyId.Value);
                        if (model.BranchId != null && model.BranchId > 0)
                        {
                            if (CompanyBranchDropDown != null && CompanyBranchDropDown.Count > 0)
                            {
                                BranchList.AddRange(CompanyBranchDropDown.OrderBy(x => x.Id.ToString() != "-1").ThenBy(x => x.Name).Select(x => new SelectListItem()
                                {
                                    Text = x.Name,
                                    Value = x.Id.ToString(),
                                    Selected = x.Id == model.BranchId,
                                }).ToList());
                            }
                        }
                        else
                        {
                            if (CompanyBranchDropDown != null && CompanyBranchDropDown.Count > 0)
                            {
                                BranchList.AddRange(CompanyBranchDropDown.OrderBy(x => x.Id.ToString() != "-1").ThenBy(x => x.Name).Select(x => new SelectListItem()
                                {
                                    Text = x.Name,
                                    Value = x.Id.ToString(),
                                    Selected = x.IsMainBranch == true,
                                }).ToList());
                            }
                        }
                        ViewBag.BranchList = BranchList.ToList();

                        break;

                    case "lead status":

                        ViewBag.LeadStatus = _Util.Facade.LookupFacade.GetDropdownsByKey("LeadStatus");


                        break;

                    case "customerstatus":


                        ViewBag.CustomerStatus = _Util.Facade.LookupFacade.GetDropdownsByKey("CustomerStatus1");


                        break;

                    case "market":


                        ViewBag.LeadMarket = _Util.Facade.LookupFacade.GetDropdownsByKey("LeadMarket");


                        break;

                    case "saleslocation":


                        List<SelectListItem> SalesCommisssion = new List<SelectListItem>();
                        //SalesCommisssion.Add(new SelectListItem()
                        //{
                        //    Text = "Please Select",
                        //    Value = "-1"
                        //});
                        SalesCommisssion.AddRange(_Util.Facade.LookupFacade.GetLookupByKey("CommissionType").Select(x =>
                                    new SelectListItem()
                                    {
                                        Text = x.DisplayText.ToString(),
                                        Value = x.DataValue.ToString()
                                    }).ToList());
                        ViewBag.SalesLocation = SalesCommisssion.OrderBy(x => x.Text != "Please Select").ThenBy(x => x.Text).ToList();

                        break;
                    case "soldby":
                        #region soldby
                        List<SelectListItem> SalesPerson = new List<SelectListItem>();
                        if (IsPermitted(UserPermissions.MyCompanyPermissions.ShowAllSalesPerson))
                        {
                            Employee objcurrentlog = _Util.Facade.EmployeeFacade.GetEmployeeByEmployeeId(CurrentLoggedInUser.UserId);
                            SalesPerson.Add(new SelectListItem()
                            {
                                Text = "Please Select One",
                                Value = ""
                            });
                            List<Employee> Employeelist = _Util.Facade.EmployeeFacade.GetEmployeeByCompanyIdAndTag(CurrentLoggedInUser.CompanyId.Value, LabelHelper.UserTags.SalesPerson, new Guid()).OrderBy(x => x.FirstName.ToString() + " " + x.LastName.ToString()).Where(x => x.UserId != CurrentLoggedInUser.UserId).ToList();
                            if (!string.IsNullOrEmpty(model.Soldby))
                            {
                                Guid SoldBy = Guid.Empty;
                                Guid.TryParse(model.Soldby, out SoldBy);
                                var SoldByEmployeeDetails = _Util.Facade.EmployeeFacade.GetEmployeeByEmployeeId(SoldBy);
                                if (SoldByEmployeeDetails != null && SoldByEmployeeDetails.IsActive == false)
                                {
                                    Employeelist.Add(SoldByEmployeeDetails);
                                    SalesPerson.Add(new SelectListItem()
                                    {
                                        Text = SoldByEmployeeDetails.FirstName + " " + SoldByEmployeeDetails.LastName,
                                        Value = SoldByEmployeeDetails.UserId.ToString(),
                                        Selected = true
                                    });
                                }
                            }
                            if (objcurrentlog != null)
                            {
                                Employeelist.Add(objcurrentlog);
                                SalesPerson.Add(new SelectListItem()
                                {
                                    Text = objcurrentlog.FirstName + " " + objcurrentlog.LastName,
                                    Value = objcurrentlog.UserId.ToString(),
                                    Selected = true
                                });
                            }

                            SalesPerson.AddRange(Employeelist.Select(x =>
                                      new SelectListItem()
                                      {
                                          Text = x.FirstName.ToString() + " " + x.LastName.ToString(),
                                          Value = x.UserId.ToString()
                                      }).ToList());
                            if (model.CustomerExtended != null && model.CustomerExtended.AppoinmentSetBy != null && model.CustomerExtended.AppoinmentSetBy != new Guid("00000000-0000-0000-0000-000000000000"))
                            {
                                Employee _appoinmentSetbyEmployee = Employeelist.Where(x => x.UserId == model.CustomerExtended.AppoinmentSetBy).FirstOrDefault();
                                Employeelist.Remove(_appoinmentSetbyEmployee);
                            }
                            ViewBag.EmployeeList = Employeelist;

                            ViewBag.SalesPerson = SalesPerson.OrderBy(x => x.Text != "Please Select One").ThenBy(x => x.Text).ToList();
                        }
                        else
                        {
                            List<Employee> Employeelist = _Util.Facade.EmployeeFacade.GetEmployeeByCompanyIdAndTag(CurrentLoggedInUser.CompanyId.Value, LabelHelper.UserTags.SalesPerson, new Guid()).OrderBy(x => x.FirstName.ToString() + " " + x.LastName.ToString()).Where(x => x.UserId == CurrentLoggedInUser.UserId).ToList();
                            if (objEmp != null)
                            {
                                SalesPerson.Add(new SelectListItem()
                                {
                                    Text = objEmp.FirstName.ToString() + " " + objEmp.LastName.ToString(),
                                    Value = objEmp.UserId.ToString()
                                });
                                ViewBag.SalesPerson = SalesPerson.OrderBy(x => x.Text != "Please Select One").ThenBy(x => x.Text).ToList();
                            }
                            if (model.CustomerExtended != null && model.CustomerExtended.AppoinmentSetBy != null && model.CustomerExtended.AppoinmentSetBy != new Guid("00000000-0000-0000-0000-000000000000"))
                            {
                                Employee _appoinmentSetbyEmployee = Employeelist.Where(x => x.UserId == model.CustomerExtended.AppoinmentSetBy).FirstOrDefault();
                                Employeelist.Remove(_appoinmentSetbyEmployee);
                            }
                            if (!string.IsNullOrEmpty(model.Soldby))
                            {
                                Guid SoldBy = Guid.Empty;
                                Guid.TryParse(model.Soldby, out SoldBy);
                                var SoldByEmployeeDetails = _Util.Facade.EmployeeFacade.GetEmployeeByEmployeeId(SoldBy);
                                if (SoldByEmployeeDetails != null && SoldBy != CurrentLoggedInUser.UserId)
                                {
                                    SoldByEmployeeDetails.FirstName = "**********";
                                    SoldByEmployeeDetails.LastName = "";
                                    Employeelist.Add(SoldByEmployeeDetails);
                                    SalesPerson.Add(new SelectListItem()
                                    {
                                        Text = "**********",
                                        Value = SoldByEmployeeDetails.UserId.ToString(),
                                        Selected = true
                                    });
                                }
                            }
                            ViewBag.EmployeeList = Employeelist;
                        }
                        if (string.IsNullOrWhiteSpace(model.Soldby) && model.SalesLocation == "" || model.SalesLocation == "-1" || model.SalesLocation == null)
                        {
                            model.SalesLocation = objEmp.SalesCommissionStructure;
                        }
                        if (!string.IsNullOrWhiteSpace(model.Soldby))
                        {
                            ViewBag.SelectSoldby = model.Soldby;
                        }
                        else
                        {
                            ViewBag.SelectSoldby = objEmp.UserId.ToString();
                        }
                        break;
                    #endregion

                    case "soldby2":
                        #region soldby2
                        var objEmp2 = _Util.Facade.EmployeeFacade.GetEmployeeByEmployeeId(CurrentLoggedInUser.UserId);
                        List<SelectListItem> SalesPerson2 = new List<SelectListItem>();

                        if (IsPermitted(UserPermissions.MyCompanyPermissions.ShowAllSalesPerson))
                        {
                            Employee objcurrentlog2 = _Util.Facade.EmployeeFacade.GetEmployeeByEmployeeId(CurrentLoggedInUser.UserId);
                            SalesPerson2.Add(new SelectListItem()
                            {
                                Text = "Please Select One",
                                Value = ""
                            });
                            List<Employee> Employeelist2 = _Util.Facade.EmployeeFacade.GetEmployeeByCompanyIdAndTag(CurrentLoggedInUser.CompanyId.Value, LabelHelper.UserTags.SalesPerson, new Guid()).OrderBy(x => x.FirstName.ToString() + " " + x.LastName.ToString()).Where(x => x.UserId != CurrentLoggedInUser.UserId).ToList();
                            if (model.SoldBy2 != Guid.Empty)
                            {
                                var SoldByEmployeeDetails2 = _Util.Facade.EmployeeFacade.GetEmployeeByEmployeeId(model.SoldBy2);
                                if (SoldByEmployeeDetails2 != null && SoldByEmployeeDetails2.IsActive == false)
                                {
                                    SalesPerson2.Add(new SelectListItem()
                                    {
                                        Text = SoldByEmployeeDetails2.FirstName + " " + SoldByEmployeeDetails2.LastName,
                                        Value = SoldByEmployeeDetails2.UserId.ToString(),
                                        Selected = true
                                    });
                                }
                            }
                            if (objcurrentlog2 != null)
                            {
                                SalesPerson2.Add(new SelectListItem()
                                {
                                    Text = objcurrentlog2.FirstName + " " + objcurrentlog2.LastName,
                                    Value = objcurrentlog2.UserId.ToString(),
                                    Selected = true
                                });
                            }

                            SalesPerson2.AddRange(Employeelist2.Select(x =>
                                      new SelectListItem()
                                      {
                                          Text = x.FirstName.ToString() + " " + x.LastName.ToString(),
                                          Value = x.UserId.ToString()
                                      }).ToList());
                            ViewBag.SalesPerson2 = SalesPerson2.OrderBy(x => x.Text != "Please Select One").ThenBy(x => x.Text).ToList();
                        }
                        else
                        {
                            if (objEmp2 != null)
                            {
                                SalesPerson2.Add(new SelectListItem()
                                {
                                    Text = objEmp2.FirstName.ToString() + " " + objEmp2.LastName.ToString(),
                                    Value = objEmp2.UserId.ToString()
                                });
                            }
                            ViewBag.SalesPerson2 = SalesPerson2.OrderBy(x => x.Text != "Please Select One").ThenBy(x => x.Text).ToList();
                        }
                        break;
                    #endregion

                    case "soldby3":
                        #region soldby3
                        var objEmp3 = _Util.Facade.EmployeeFacade.GetEmployeeByEmployeeId(CurrentLoggedInUser.UserId);
                        List<SelectListItem> SalesPerson3 = new List<SelectListItem>();

                        if (IsPermitted(UserPermissions.MyCompanyPermissions.ShowAllSalesPerson))
                        {
                            Employee objcurrentlog3 = _Util.Facade.EmployeeFacade.GetEmployeeByEmployeeId(CurrentLoggedInUser.UserId);
                            SalesPerson3.Add(new SelectListItem()
                            {
                                Text = "Please Select One",
                                Value = ""
                            });
                            List<Employee> Employeelist3 = _Util.Facade.EmployeeFacade.GetEmployeeByCompanyIdAndTag(CurrentLoggedInUser.CompanyId.Value, LabelHelper.UserTags.SalesPerson, new Guid()).OrderBy(x => x.FirstName.ToString() + " " + x.LastName.ToString()).Where(x => x.UserId != CurrentLoggedInUser.UserId).ToList();
                            if (model.SoldBy3 != Guid.Empty)
                            {
                                var SoldByEmployeeDetails3 = _Util.Facade.EmployeeFacade.GetEmployeeByEmployeeId(model.SoldBy3);
                                if (SoldByEmployeeDetails3 != null && SoldByEmployeeDetails3.IsActive == false)
                                {
                                    SalesPerson3.Add(new SelectListItem()
                                    {
                                        Text = SoldByEmployeeDetails3.FirstName + " " + SoldByEmployeeDetails3.LastName,
                                        Value = SoldByEmployeeDetails3.UserId.ToString(),
                                        Selected = true
                                    });
                                }
                            }
                            if (objcurrentlog3 != null)
                            {
                                SalesPerson3.Add(new SelectListItem()
                                {
                                    Text = objcurrentlog3.FirstName + " " + objcurrentlog3.LastName,
                                    Value = objcurrentlog3.UserId.ToString(),
                                    Selected = true
                                });
                            }

                            SalesPerson3.AddRange(Employeelist3.Select(x =>
                                      new SelectListItem()
                                      {
                                          Text = x.FirstName.ToString() + " " + x.LastName.ToString(),
                                          Value = x.UserId.ToString()
                                      }).ToList());
                            ViewBag.SalesPerson3 = SalesPerson3.OrderBy(x => x.Text != "Please Select One").ThenBy(x => x.Text).ToList();
                        }
                        else
                        {
                            if (objEmp3 != null)
                            {
                                SalesPerson3.Add(new SelectListItem()
                                {
                                    Text = objEmp3.FirstName.ToString() + " " + objEmp3.LastName.ToString(),
                                    Value = objEmp3.UserId.ToString()
                                });
                            }
                            ViewBag.SalesPerson3 = SalesPerson3.OrderBy(x => x.Text != "Please Select One").ThenBy(x => x.Text).ToList();
                        }
                        break;
                    #endregion

                    case "salesperson4":
                        #region soldby4
                        var objEmp4 = _Util.Facade.EmployeeFacade.GetEmployeeByEmployeeId(CurrentLoggedInUser.UserId);
                        List<SelectListItem> SalesPerson4 = new List<SelectListItem>();

                        if (IsPermitted(UserPermissions.MyCompanyPermissions.ShowAllSalesPerson))
                        {
                            Employee objcurrentlog4 = _Util.Facade.EmployeeFacade.GetEmployeeByEmployeeId(CurrentLoggedInUser.UserId);
                            SalesPerson4.Add(new SelectListItem()
                            {
                                Text = "Please Select One",
                                Value = ""
                            });
                            List<Employee> Employeelist4 = _Util.Facade.EmployeeFacade.GetEmployeeByCompanyIdAndTag(CurrentLoggedInUser.CompanyId.Value, LabelHelper.UserTags.SalesPerson, new Guid()).OrderBy(x => x.FirstName.ToString() + " " + x.LastName.ToString()).Where(x => x.UserId != CurrentLoggedInUser.UserId).ToList();
                            if (model.CustomerExtended.SalesPerson4 != Guid.Empty)
                            {
                                var SoldByEmployeeDetails4 = _Util.Facade.EmployeeFacade.GetEmployeeByEmployeeId(model.CustomerExtended.SalesPerson4);
                                if (SoldByEmployeeDetails4 != null && SoldByEmployeeDetails4.IsActive == false)
                                {
                                    SalesPerson4.Add(new SelectListItem()
                                    {
                                        Text = SoldByEmployeeDetails4.FirstName + " " + SoldByEmployeeDetails4.LastName,
                                        Value = SoldByEmployeeDetails4.UserId.ToString(),
                                        Selected = true
                                    });
                                }
                            }
                            if (objcurrentlog4 != null)
                            {
                                SalesPerson4.Add(new SelectListItem()
                                {
                                    Text = objcurrentlog4.FirstName + " " + objcurrentlog4.LastName,
                                    Value = objcurrentlog4.UserId.ToString(),
                                    Selected = true
                                });
                            }

                            SalesPerson4.AddRange(Employeelist4.Select(x =>
                                      new SelectListItem()
                                      {
                                          Text = x.FirstName.ToString() + " " + x.LastName.ToString(),
                                          Value = x.UserId.ToString()
                                      }).ToList());
                            ViewBag.SalesPerson4 = SalesPerson4.OrderBy(x => x.Text != "Please Select One").ThenBy(x => x.Text).ToList();
                        }
                        else
                        {
                            if (objEmp4 != null)
                            {
                                SalesPerson4.Add(new SelectListItem()
                                {
                                    Text = objEmp4.FirstName.ToString() + " " + objEmp4.LastName.ToString(),
                                    Value = objEmp4.UserId.ToString()
                                });
                            }
                            ViewBag.SalesPerson4 = SalesPerson4.OrderBy(x => x.Text != "Please Select One").ThenBy(x => x.Text).ToList();
                        }
                        break;
                    #endregion
                    case "rwst01":


                        ViewBag.RWSTList = _Util.Facade.LookupFacade.GetLookupByKey("RWST").OrderBy(x => x.DisplayText != "Select One").ThenBy(x => x.DisplayText).Select(x =>
                                      new SelectListItem()
                                      {
                                          Text = x.DisplayText.ToString(),
                                          Value = x.DataValue.ToString()
                                      }).ToList();

                        break;


                    case "rwst02":


                        ViewBag.RWSTList = _Util.Facade.LookupFacade.GetLookupByKey("RWST").OrderBy(x => x.DisplayText != "Select One").ThenBy(x => x.DisplayText).Select(x =>
                                      new SelectListItem()
                                      {
                                          Text = x.DisplayText.ToString(),
                                          Value = x.DataValue.ToString()
                                      }).ToList();

                        break;

                    case "rwst03":


                        ViewBag.RWSTList = _Util.Facade.LookupFacade.GetLookupByKey("RWST").OrderBy(x => x.DisplayText != "Select One").ThenBy(x => x.DisplayText).Select(x =>
                                      new SelectListItem()
                                      {
                                          Text = x.DisplayText.ToString(),
                                          Value = x.DataValue.ToString()
                                      }).ToList();

                        break;

                    case "rwst04":


                        ViewBag.RWSTList = _Util.Facade.LookupFacade.GetLookupByKey("RWST").OrderBy(x => x.DisplayText != "Select One").ThenBy(x => x.DisplayText).Select(x =>
                                      new SelectListItem()
                                      {
                                          Text = x.DisplayText.ToString(),
                                          Value = x.DataValue.ToString()
                                      }).ToList();

                        break;

                    case "rwst05":


                        ViewBag.RWSTList = _Util.Facade.LookupFacade.GetLookupByKey("RWST").OrderBy(x => x.DisplayText != "Select One").ThenBy(x => x.DisplayText).Select(x =>
                                      new SelectListItem()
                                      {
                                          Text = x.DisplayText.ToString(),
                                          Value = x.DataValue.ToString()
                                      }).ToList();

                        break;

                    case "rwst06":


                        ViewBag.RWSTList = _Util.Facade.LookupFacade.GetLookupByKey("RWST").OrderBy(x => x.DisplayText != "Select One").ThenBy(x => x.DisplayText).Select(x =>
                                      new SelectListItem()
                                      {
                                          Text = x.DisplayText.ToString(),
                                          Value = x.DataValue.ToString()
                                      }).ToList();

                        break;


                    case "rwst07":


                        ViewBag.RWSTList = _Util.Facade.LookupFacade.GetLookupByKey("RWST").OrderBy(x => x.DisplayText != "Select One").ThenBy(x => x.DisplayText).Select(x =>
                                      new SelectListItem()
                                      {
                                          Text = x.DisplayText.ToString(),
                                          Value = x.DataValue.ToString()
                                      }).ToList();

                        break;

                    case "rwst08":


                        ViewBag.RWSTList = _Util.Facade.LookupFacade.GetLookupByKey("RWST").OrderBy(x => x.DisplayText != "Select One").ThenBy(x => x.DisplayText).Select(x =>
                                      new SelectListItem()
                                      {
                                          Text = x.DisplayText.ToString(),
                                          Value = x.DataValue.ToString()
                                      }).ToList();

                        break;

                    case "rwst09":


                        ViewBag.RWSTList = _Util.Facade.LookupFacade.GetLookupByKey("RWST").OrderBy(x => x.DisplayText != "Select One").ThenBy(x => x.DisplayText).Select(x =>
                                      new SelectListItem()
                                      {
                                          Text = x.DisplayText.ToString(),
                                          Value = x.DataValue.ToString()
                                      }).ToList();

                        break;

                    case "rwst10":


                        ViewBag.RWSTList = _Util.Facade.LookupFacade.GetLookupByKey("RWST").OrderBy(x => x.DisplayText != "Select One").ThenBy(x => x.DisplayText).Select(x =>
                                      new SelectListItem()
                                      {
                                          Text = x.DisplayText.ToString(),
                                          Value = x.DataValue.ToString()
                                      }).ToList();

                        break;

                    case "rwst11":


                        ViewBag.RWSTList = _Util.Facade.LookupFacade.GetLookupByKey("RWST").OrderBy(x => x.DisplayText != "Select One").ThenBy(x => x.DisplayText).Select(x =>
                                      new SelectListItem()
                                      {
                                          Text = x.DisplayText.ToString(),
                                          Value = x.DataValue.ToString()
                                      }).ToList();

                        break;

                    case "rwst12":


                        ViewBag.RWSTList = _Util.Facade.LookupFacade.GetLookupByKey("RWST").OrderBy(x => x.DisplayText != "Select One").ThenBy(x => x.DisplayText).Select(x =>
                                      new SelectListItem()
                                      {
                                          Text = x.DisplayText.ToString(),
                                          Value = x.DataValue.ToString()
                                      }).ToList();

                        break;

                    case "rwst13":


                        ViewBag.RWSTList = _Util.Facade.LookupFacade.GetLookupByKey("RWST").OrderBy(x => x.DisplayText != "Select One").ThenBy(x => x.DisplayText).Select(x =>
                                      new SelectListItem()
                                      {
                                          Text = x.DisplayText.ToString(),
                                          Value = x.DataValue.ToString()
                                      }).ToList();

                        break;

                    case "rwst14":


                        ViewBag.RWSTList = _Util.Facade.LookupFacade.GetLookupByKey("RWST").OrderBy(x => x.DisplayText != "Select One").ThenBy(x => x.DisplayText).Select(x =>
                                      new SelectListItem()
                                      {
                                          Text = x.DisplayText.ToString(),
                                          Value = x.DataValue.ToString()
                                      }).ToList();

                        break;

                    case "rwst15":


                        ViewBag.RWSTList = _Util.Facade.LookupFacade.GetLookupByKey("RWST").OrderBy(x => x.DisplayText != "Select One").ThenBy(x => x.DisplayText).Select(x =>
                                      new SelectListItem()
                                      {
                                          Text = x.DisplayText.ToString(),
                                          Value = x.DataValue.ToString()
                                      }).ToList();

                        break;

                    case "isfinanced":


                        ViewBag.IsFinancedList = _Util.Facade.LookupFacade.GetDropdownsByKey("IsFinanced");


                        break;

                    case "pets":


                        ViewBag.IsPets = _Util.Facade.LookupFacade.GetDropdownsByKey("Pets");


                        break;

                    case "petstype":


                        ViewBag.TypeOfPets = _Util.Facade.LookupFacade.GetDropdownsByKey("TypeOfPets");


                        break;

                    case "repair":


                        ViewBag.IsRepair = _Util.Facade.LookupFacade.GetDropdownsByKey("Repair");


                        break;

                    case "vipclubmember":


                        ViewBag.IsVipClubMember = _Util.Facade.LookupFacade.GetDropdownsByKey("VipClubMember");


                        break;

                    case "repairtype":


                        ViewBag.TypeOfRepair = _Util.Facade.LookupFacade.GetDropdownsByKey("TypeOfRepair");


                        break;
                    case "financerep":

                        List<Employee> EmployeelistFin = _Util.Facade.EmployeeFacade.GetAllEmployeeByCompanyId(CurrentLoggedInUser.CompanyId.Value).ToList();

                        EmployeelistFin.Insert(0, new Employee()
                        {
                            FirstName = "Please Select",
                            LastName = "One",
                            UserId = Guid.Empty
                        });

                        ViewBag.EmployeeListFin = EmployeelistFin.OrderBy(x => x.FirstName + " " + x.LastName != "Please Select One").ThenBy(x => x.FirstName + " " + x.LastName).ToList();

                        break;

                    case "contactedperviously":


                        ViewBag.ContractedPrevious = _Util.Facade.LookupFacade.GetDropdownsByKey("ContractYesNo");


                        break;

                    case "tax exemption":


                        List<SelectListItem> taxexemplist = new List<SelectListItem>();
                        taxexemplist.Add(new SelectListItem()
                        {
                            Text = "Please Select One",
                            Value = "-1"
                        });
                        taxexemplist.AddRange(_Util.Facade.LookupFacade.GetLookupByKey("TaxExemption").Select(x =>
                        new SelectListItem()
                        {
                            Text = x.DisplayText.ToString(),
                            Value = x.DataValue.ToString(),

                        }).ToList());
                        ViewBag.TaxExemptionList = taxexemplist;

                        break;

                    case "appoinment set":


                        ViewBag.AppoinmentSetList = _Util.Facade.LookupFacade.GetDropdownsByKey("AppoinmentSet");


                        break;

                    case "term":


                        ViewBag.TermList = _Util.Facade.LookupFacade.GetDropdownsByKey("TermList");


                        break;

                    case "streettype":


                        ViewBag.LeadStreetType = _Util.Facade.LookupFacade.GetDropdownsByKey("LeadStreetType");


                        break;

                    case "assignedto":


                        ViewBag.AssignedEmployee = EmpList.Select(x => new SelectListItem()
                        {
                            Text = x.FirstName + " " + x.LastName,
                            Value = x.UserId.ToString(),
                            Selected = Model.TicketAssignedUserList.Count(y => y.UserId == x.UserId) > 0
                        }).ToList();

                        break;

                    case "installer":

                        List<SelectListItem> InstallerList = new List<SelectListItem>();
                        InstallerList.Add(new SelectListItem()
                        {
                            Text = "Please Select One",
                            Value = ""
                        });

                        List<Employee> EmployeeDropDownListInstaller = _Util.Facade.EmployeeFacade.GetEmployeeByCompanyIdAndTag(CurrentLoggedInUser.CompanyId.Value, LabelHelper.UserTags.Installer, new Guid());
                        if (EmployeeDropDownListInstaller != null && EmployeeDropDownListInstaller.Count > 0)
                        {
                            InstallerList.AddRange(EmployeeDropDownListInstaller.OrderBy(x => x.FirstName).Select(x =>
                                       new SelectListItem()
                                       {
                                           Text = x.FirstName + " " + x.LastName,
                                           Value = x.UserId.ToString()
                                       }).ToList());
                        }

                        ViewBag.InstallerList = InstallerList;

                        break;


                    //case "QA1":

                    //    List<SelectListItem> QualityAssuranceList1 = new List<SelectListItem>();
                    //    QualityAssuranceList1.Add(new SelectListItem()
                    //    {
                    //        Text = "Please Select One",
                    //        Value = ""
                    //    });

                    //    //List<Employee> EmployeeDropDownListforQA = EmployeeList;
                    //    //if (EmployeeDropDownListforQA != null && EmployeeDropDownListforQA.Count > 0)
                    //    //{
                    //    //    QualityAssuranceList1.AddRange(EmployeeDropDownListforQA.OrderBy(x => x.FirstName).Select(x =>
                    //    //                      new SelectListItem()
                    //    //                      {
                    //    //                          Text = x.FirstName.ToString() + " " + x.LastName.ToString(),
                    //    //                          Value = x.UserId.ToString()
                    //    //                      }).ToList());
                    //    //}

                    //    ViewBag.QualityAssuranceList1 = QualityAssuranceList1;

                    //    break;

                    //case "QA2":

                    //    List<SelectListItem> QualityAssuranceList2 = new List<SelectListItem>();
                    //    QualityAssuranceList2.Add(new SelectListItem()
                    //    {
                    //        Text = "Please Select One",
                    //        Value = ""
                    //    });
                    //    //List<Employee> EmployeeDropDownList2 = EmployeeList;
                    //    //QualityAssuranceList2.AddRange(EmployeeDropDownList2.OrderBy(x => x.FirstName).Select(x =>
                    //    //                      new SelectListItem()
                    //    //                      {
                    //    //                          Text = x.FirstName.ToString() + " " + x.LastName.ToString(),
                    //    //                          Value = x.UserId.ToString()
                    //    //                      }).ToList());
                    //    ViewBag.QualityAssuranceList2 = QualityAssuranceList2;

                    //    break;

                    case "tab->alarm.com account.":

                        ViewBag.PropertyTypeEnum = _Util.Facade.LookupFacade.GetDropdownsByKey("PropertyTypeEnum");


                        break;

                    case "creditscore":

                        List<SelectListItem> creditGradeList = new List<SelectListItem>();
                        creditGradeList.Add(new SelectListItem()
                        {
                            Text = "Select One",
                            Value = "-1"
                        });

                        creditGradeList.AddRange(_Util.Facade.CustomerFacade.GetAllCreditScoreGrade().Select(x =>
                                  new SelectListItem()
                                  {
                                      Text = x.Grade.ToString() + " (" + x.MinScore + " - " + x.MaxScore + ")",
                                      Value = x.ID.ToString()
                                  }).ToList());
                        ViewBag.CreditScore = creditGradeList;

                        break;

                    case "contractteam":

                        List<SelectListItem> ContactTerms = new List<SelectListItem>();
                        ContactTerms.AddRange(_Util.Facade.LookupFacade.GetDropdownsByKey("ContractTerm"));

                        if (model != null && model.CustomerId != null && !string.IsNullOrEmpty(model.ContractTeam) && model.ContractTeam != "3" && model.ContractTeam != "5")
                        {
                            var packid = _Util.Facade.PackageFacade.GetPackageCustomerByCustomerIdandCompanyId(model.CustomerId, CurrentLoggedInUser.CompanyId.Value);
                            if (packid != null)
                            {
                                var PackageDetails = _Util.Facade.SmartPackageFacade.GetSmartPackageByPackageId(packid.PackageId);
                                if (PackageDetails != null && PackageDetails.NonConforming == true)
                                {
                                    var ContractTeamSet = Convert.ToDouble(model.ContractTeam) * 12;
                                    ContactTerms.Add(new SelectListItem() { Value = model.ContractTeam.ToString(), Text = ContractTeamSet.ToString() + " Month" });
                                }
                            }
                        }
                        ViewBag.ContractTerm = ContactTerms;

                        break;

                    case "customerfunded":

                        ViewBag.YesNoList = _Util.Facade.LookupFacade.GetLookupByKey("FundedStatus").Select(x =>
                           new SelectListItem()
                           {
                               Text = x.DisplayText.ToString(),
                               Value = x.DataValue
                           }).ToList();

                        break;

                    case "fundingcompany":

                        //List<SelectListItem> FundingCompany = new List<SelectListItem>();
                        //FundingCompany.Add(new SelectListItem() { Text = "Please Select One", Value = "-1" });
                        //FundingCompany.AddRange(_Util.Facade.FundFacade.GetAllFundingCompany().Select(x =>
                        //                 new SelectListItem()
                        //                 {
                        //                     Text = x.Name.ToString(),
                        //                     Value = x.Value.ToString()
                        //                 }).ToList());
                        ViewBag.FundingCompany = _Util.Facade.LookupFacade.GetDropdownsByKey("FundingCompany");

                        break;

                    case "maintenance":

                        ViewBag.YesNoList = _Util.Facade.LookupFacade.GetLookupByKey("FundedStatus").Select(x =>
                            new SelectListItem()
                            {
                                Text = x.DisplayText.ToString(),
                                Value = x.DataValue
                            }).ToList();

                        break;

                    case "billcycle":

                        ViewBag.BillCycle = _Util.Facade.LookupFacade.GetLookupByKey("BillCycle").Select(x =>
                            new SelectListItem()
                            {
                                Text = x.DisplayText.ToString(),
                                Value = x.DataValue.ToString()
                            }).ToList();

                        break;

                    case "billday":

                        ViewBag.BillingDay = _Util.Facade.LookupFacade.GetDropdownsByKey("BillingDay");


                        break;

                    case "billtax":

                        ViewBag.BillYesNo = _Util.Facade.LookupFacade.GetLookupByKey("CustomerTaxYesNo").Select(x =>
                                                    new SelectListItem()
                                                    {
                                                        Text = x.DisplayText.ToString(),
                                                        Value = x.DataValue.ToString(),
                                                        Selected = x.IsDefaultItem == true
                                                    }).ToList();

                        break;

                    case "route":

                        List<SelectListItem> RouteList = new List<SelectListItem>();
                        RouteList.Add(new SelectListItem()
                        {
                            Text = "Please Select One",
                            Value = ""
                        });

                        if (CurrentLoggedInUser.UserRole != "Employee")
                        {
                            List<GeeseRoute> GeeseRouteList = _Util.Facade.CustomerFacade.GetRouteList();
                            if (GeeseRouteList != null && GeeseRouteList.Count > 0)
                            {
                                RouteList.AddRange(GeeseRouteList.OrderBy(x => x.Name).Select(x =>
                                           new SelectListItem()
                                           {
                                               Text = x.Name,
                                               Value = x.RouteId.ToString()
                                           }).ToList());
                            }

                            ViewBag.RouteList = RouteList;
                        }
                        else
                        {
                            List<RouteList> GeeseRouteList = _Util.Facade.CustomerFacade.GetAllEmployeeRouteByUserId(CurrentLoggedInUser.UserId);
                            if (GeeseRouteList != null && GeeseRouteList.Count > 0)
                            {
                                RouteList.AddRange(GeeseRouteList.OrderBy(x => x.Name).Select(x =>
                                           new SelectListItem()
                                           {
                                               Text = x.Name,
                                               Value = x.RouteId.ToString()
                                           }).ToList());
                            }

                            ViewBag.RouteList = RouteList;
                        }


                        break;

                }
            }


            model.MonthlyMonitoringFee = Convert.ToDecimal(String.Format("{0:0.00}", Convert.ToDecimal(!string.IsNullOrWhiteSpace(model.MonthlyMonitoringFee) ? model.MonthlyMonitoringFee : "0"))).ToString();
            return PartialView("_AddCustomer", model);
        }


        public ActionResult CustomerCancellationConfirm(Guid? CustomerId)
        {
            CustomerCancellationQueue model = _Util.Facade.CustomerFacade.GetActiveCustomerCancellationQueueByCustomerId(CustomerId.Value);
            var CurrentLoggedInUser = ((HS.Web.UI.Helper.CustomPrincipal)(User));
            ViewBag.CancelReasonList = _Util.Facade.LookupFacade.GetLookupByKey("CancellationReason").Where(m => m.DataValue != "-1").Select(x =>
                           new SelectListItem()
                           {
                               Text = x.DisplayText.ToString(),
                               Value = x.DataValue.ToString()
                           }).ToList();
            ViewBag.DFWCancelReasonList = _Util.Facade.LookupFacade.GetLookupByKey("DFWCancellationReason").Select(x =>
                        new SelectListItem()
                        {
                            Text = x.DisplayText.ToString(),
                            Value = x.DataValue.ToString()
                        }).ToList();
            ViewBag.CustomerId = CustomerId;
            #region AgreementSetting
            bool CancellationReasonFillByEmployee = false;
            GlobalSetting GlobSet = _Util.Facade.GlobalSettingsFacade.GetGlobalsettingBySearchKeyAndCompanyId("CancellationReasonFillByEmployee", CurrentLoggedInUser.CompanyId.Value);
            if (GlobSet != null && !string.IsNullOrWhiteSpace(GlobSet.Value))
            {
                if (GlobSet.Value == "true")
                {
                    CancellationReasonFillByEmployee = true;
                }
            }
            ViewBag.CancellationReasonFillByEmployee = CancellationReasonFillByEmployee;
            #endregion

            #region CancellationRegion
            bool IsCancellReason = false;
            GlobalSetting GlobalSet = _Util.Facade.GlobalSettingsFacade.GetGlobalsettingBySearchKeyAndCompanyId("ShowDFWCancellationReason", CurrentLoggedInUser.CompanyId.Value);
            if (GlobalSet != null && !string.IsNullOrWhiteSpace(GlobalSet.Value))
            {
                if (GlobalSet.Value == "true")
                {
                    IsCancellReason = true;
                }
            }
            ViewBag.CancellationEmployeeReason = IsCancellReason;


            #endregion
            bool isDeclinedAdded = true;
            GlobalSetting isDeclined = _Util.Facade.GlobalSettingsFacade.GetGlobalSettingsByKey(CurrentLoggedInUser.CompanyId.Value, "IsDeclinedInvoiceAddedInUnpaidAmount");
            if (isDeclined != null)
            {
                isDeclinedAdded = !string.IsNullOrWhiteSpace(isDeclined.Value) && isDeclined.Value.ToLower() == "false" ? false : true;
            }
            EstimateStatusDetail EstimateStatusDetail = _Util.Facade.CustomerFacade.GetAllEstimateStatusDetailByCustomerId(CustomerId.Value, isDeclinedAdded);
            if (EstimateStatusDetail != null)
            {
                ViewBag.RemainingBalance = Math.Round(EstimateStatusDetail.UnpaidAmount, 2,
                                             MidpointRounding.ToEven);
            }
            return View(model);
        }

        public ActionResult GetCancellationPopUp(Guid? CustomerId)
        {
            Customer cus = new Customer();
            var CurrentLoggedInUser = ((HS.Web.UI.Helper.CustomPrincipal)(User));
            if (CustomerId.HasValue && CustomerId != new Guid())
            {
                cus = _Util.Facade.CustomerFacade.GetCustomerByCustomerId(CustomerId.Value);
                ViewBag.LeadId = CustomerId;
                ViewBag.LeadIdInt = cus.Id;
            }
            ViewBag.AgreementDocumentHeight = _Util.Facade.GlobalSettingsFacade.GetAgreementDocumentHeightByCompanyId(CurrentLoggedInUser.CompanyId.Value);
            ViewBag.StringHeight = ViewBag.AgreementDocumentHeight + "px";
            return View(cus);
        }

        public ActionResult CustomerCancellationAgreement_v2(Guid CustomerId)
        {
            Guid CompanyId = new Guid();
            Customer cus = _Util.Facade.CustomerFacade.GetCustomerByCustomerGuidId(CustomerId);
            if (User.Identity.IsAuthenticated)
            {
                var CurrentUser = (HS.Web.UI.Helper.CustomPrincipal)User;
                CompanyId = CurrentUser.CompanyId.Value;
            }
            else
            {
                CustomerCompany custommerCompany = _Util.Facade.CustomerFacade.GetCustomerCompanyByCustomerId(cus.Id);
                CompanyId = custommerCompany.CompanyId;
            }
            CustomerCancellationQueue cencellationQueue = _Util.Facade.CustomerFacade.GetCustomerCancellationQueueByCustomerId(CustomerId);


            Company cuscom = _Util.Facade.CompanyFacade.GetCompanyByComapnyId(CompanyId);
            List<Lookup> cancellationReasonLookup = _Util.Facade.LookupFacade.GetLookupByKey("CancellationReason");

            CustomerCancellationQueueAggrement model = new CustomerCancellationQueueAggrement()
            {
                CompanyLogo = _Util.Facade.CompanyBranchFacade.GetCompanyEmailLogoByCompanyId(cuscom.CompanyId),
                CompanyCity = cuscom.City,
                CompanyEmail = cuscom.EmailAdress,
                CompanyState = cuscom.State,
                CompanyStreet = cuscom.Street,
                CompanyPhone = cuscom.Phone,
                CompanyName = cuscom.CompanyName,
                CompanyZipcode = cuscom.ZipCode,
                CompanyWebsite = cuscom.Website,
                SignedImg = cus.CancellationSignature,
                CustomerName = cus.DisplayName,
                CustomerAddress = cus.Street,
                RemainingBalance = cencellationQueue.RemainingBalance.HasValue ? cencellationQueue.RemainingBalance.Value : 0,
                IsSigned = cencellationQueue.IsSigned.HasValue ? cencellationQueue.IsSigned.Value : false,
                Reason = cencellationQueue.Reason,
                CancellationDate = cencellationQueue.CancellationDate.HasValue ? cencellationQueue.CancellationDate.Value : new DateTime(),
                CompanyId = CompanyId,
                Note = cencellationQueue.Note
            };
            model.CustomerCancellationReasonList = _Util.Facade.CustomerFacade.GetCustomerCancellationReasonList(CustomerId);
            CustomerCancellationLookup cancelLookup = new CustomerCancellationLookup();
            model.CancellationReason = new List<CustomerCancellationLookup>();
            foreach (var item in cancellationReasonLookup)
            {
                if (item.DataValue != "-1")
                {
                    cancelLookup = new CustomerCancellationLookup()
                    {
                        Value = item.DataValue,
                        Text = item.DisplayText
                    };

                    model.CancellationReason.Add(cancelLookup);
                }
            }
            string body = _Util.Facade.AgreementFacade.MakeCancellationAgreementPdf(model);
            ViewBag.Body = body;
            if (cencellationQueue.IsSigned == true)
            {
                ViewAsPdf actionPDF = new Rotativa.ViewAsPdf("CustomerCancellationAgreement")
                {
                    //FileName = "TestView.pdf",l
                    PageSize = Rotativa.Options.Size.A4,
                    PageOrientation = Rotativa.Options.Orientation.Portrait,
                    PageMargins = { Left = 1, Right = 1 },

                };
                byte[] applicationPDFData = actionPDF.BuildPdf(ControllerContext);
                Random rand = new Random();
                string filename = ConfigurationManager.AppSettings["File.LeadToCustomerAgreement"];
                var comname = _Util.Facade.CompanyFacade.GetCompanyByComapnyId(CompanyId).CompanyName.ReplaceSpecialChar();
                var pdftempFolderName = string.Format(filename, comname) + rand.Next().ToString() + cus.Id + "CancellationAgreementMail.pdf";
                string Serverfilename = FileHelper.GetFileFullPath(pdftempFolderName);
                FileHelper.SaveFile(applicationPDFData, Serverfilename);
                var OnlyFileName = pdftempFolderName.Split('/');

                //var cusinfo = _Util.Facade.CustomerFacade.GetById(leadid.Value);
                var delimeter = new string[] { "-___" };
                var fullFileName = OnlyFileName[3].Split(delimeter, StringSplitOptions.RemoveEmptyEntries);
                CustomerFile cf = new CustomerFile()
                {
                    CompanyId = CompanyId,
                    FileId = Guid.NewGuid(),
                    CustomerId = CustomerId,
                    FileDescription = cus.Id + "_" + "Cancellation_Form_Signed" + ".pdf",
                    Filename = "//" + pdftempFolderName,
                    Uploadeddate = DateTime.Now, //2020-09-24 05:48:33.000
                    FileFullName = fullFileName[0],
                    IsActive = true,
                    CreatedBy = Guid.Empty,
                    CreatedDate = DateTime.Now,
                    UpdatedBy = Guid.Empty,
                    UpdatedDate = DateTime.Now,
                    WMStatus = LabelHelper.WatermarkStatus.Pending
                };
                _Util.Facade.CustomerFileFacade.InsertCustomerFile(cf);
            }
            return new ViewAsPdf()
            {
                // FileName = flightPlan.ListingItemDetailsModel.FlightDetails + ".pdf",
                PageSize = Rotativa.Options.Size.A4,
                PageOrientation = Orientation.Portrait,
                //PageMargins = new Margins(10, 0, 0, 0),
                PageMargins = new Margins(10, 2, 10, 3)
            };



        }

        public ActionResult CustomerCancellationAgreement(Guid CustomerId)
        {

            Guid CompanyId = new Guid();
            Customer cus = _Util.Facade.CustomerFacade.GetCustomerByCustomerGuidId(CustomerId);
            if (User.Identity.IsAuthenticated)
            {
                var CurrentUser = (HS.Web.UI.Helper.CustomPrincipal)User;
                CompanyId = CurrentUser.CompanyId.Value;
            }
            else
            {
                CustomerCompany custommerCompany = _Util.Facade.CustomerFacade.GetCustomerCompanyByCustomerId(cus.Id);
                CompanyId = custommerCompany.CompanyId;
            }
            CustomerCancellationQueue cencellationQueue = _Util.Facade.CustomerFacade.GetCustomerCancellationQueueByCustomerId(CustomerId);


            Company cuscom = _Util.Facade.CompanyFacade.GetCompanyByComapnyId(CompanyId);
            List<Lookup> cancellationReasonLookup = _Util.Facade.LookupFacade.GetLookupByKey("CancellationReason");

            CustomerCancellationQueueAggrement model = new CustomerCancellationQueueAggrement()
            {
                CompanyLogo = _Util.Facade.CompanyBranchFacade.GetCompanyEmailLogoByCompanyId(cuscom.CompanyId),
                CompanyCity = cuscom.City,
                CompanyEmail = cuscom.EmailAdress,
                CompanyState = cuscom.State,
                CompanyStreet = cuscom.Street,
                CompanyPhone = cuscom.Phone,
                CompanyName = cuscom.CompanyName,
                CompanyZipcode = cuscom.ZipCode,
                CompanyWebsite = cuscom.Website,
                SignedImg = cus.CancellationSignature,
                CustomerName = cus.DisplayName,
                CustomerAddress = cus.Street,
                RemainingBalance = cencellationQueue.RemainingBalance.HasValue ? cencellationQueue.RemainingBalance.Value : 0,
                IsSigned = cencellationQueue.IsSigned.HasValue ? cencellationQueue.IsSigned.Value : false,
                Reason = cencellationQueue.Reason,
                CancellationDate = cencellationQueue.CancellationDate.HasValue ? cencellationQueue.CancellationDate.Value : new DateTime(),
                CompanyId = CompanyId,
                Note = cencellationQueue.Note
            };
            model.CustomerCancellationReasonList = _Util.Facade.CustomerFacade.GetCustomerCancellationReasonList(CustomerId);
            CustomerCancellationLookup cancelLookup = new CustomerCancellationLookup();
            model.CancellationReason = new List<CustomerCancellationLookup>();
            foreach (var item in cancellationReasonLookup)
            {
                if (item.DataValue != "-1")
                {
                    cancelLookup = new CustomerCancellationLookup()
                    {
                        Value = item.DataValue,
                        Text = item.DisplayText
                    };

                    model.CancellationReason.Add(cancelLookup);
                }
            }
            string body = _Util.Facade.AgreementFacade.MakeCancellationAgreementPdf(model);
            ViewBag.Body = body;
            if (cencellationQueue.IsSigned == true)
            {
                ViewAsPdf actionPDF = new Rotativa.ViewAsPdf("CustomerCancellationAgreement")
                {
                    //FileName = "TestView.pdf",l
                    PageSize = Rotativa.Options.Size.A4,
                    PageOrientation = Rotativa.Options.Orientation.Portrait,
                    PageMargins = { Left = 1, Right = 1 },

                };

                byte[] applicationPDFData = actionPDF.BuildPdf(ControllerContext);

                #region File Save
                //Random rand = new Random();
                //string filename = ConfigurationManager.AppSettings["File.LeadToCustomerAgreement"];
                //var comname = _Util.Facade.CompanyFacade.GetCompanyByComapnyId(CompanyId).CompanyName.ReplaceSpecialChar();
                //var pdftempFolderName = string.Format(filename, comname) + rand.Next().ToString() + cus.Id + "CancellationAgreementMail.pdf";
                //string Serverfilename = FileHelper.GetFileFullPath(pdftempFolderName);
                //FileHelper.SaveFile(applicationPDFData, Serverfilename);
                //var OnlyFileName = pdftempFolderName.Split('/');
                #endregion

                //// "mayur" AWS S3 Changes //// Start

                #region File Save on AWS S3

                Random rand = new Random();
                string filename = ConfigurationManager.AppSettings["File.LeadToCustomerAgreement"];
                filename = filename.TrimEnd('/');

                var comname = _Util.Facade.CompanyFacade.GetCompanyByComapnyId(CompanyId).CompanyName.ReplaceSpecialChar();

                string FilePath = string.Format(filename, comname);
                string FileName = rand.Next().ToString() + cus.Id + "CancellationAgreementMail.pdf";

                string FileKey = string.Format($"{FilePath}/{FileName}");
                var OnlyFileName = "CancellationAgreementMail.pdf";
                var returnurl = "";

                var task = Task.Run(async () => {
                    AWSS3ObjectService AWSobject = new AWSS3ObjectService();

                    await AWSobject.UploadFile(FileKey, applicationPDFData);
                    await AWSobject.MakePublic(FileName, FilePath);
                });

                task.Wait();

                /// "mayur" used thread for async s3 methods : start

                //Thread thread = new Thread(async () => {

                //    AWSS3ObjectService AWSobject = new AWSS3ObjectService();

                //    await AWSobject.UploadFile(FileKey, applicationPDFData);
                //    await AWSobject.MakePublic(FileName, FilePath);

                //});
                //thread.Start();

                ///// "mayur" used thread for async s3 methods : End

                //Thread.Sleep(3000);

                returnurl = String.Format(AppConfig.AWSS3Url, AppConfig.AWSS3BucketName);
                returnurl = returnurl + FileKey;


                ViewBag.ReturnUrl = returnurl;
                ViewBag.FileName = FileName;
                ViewBag.FileKey = FileKey;


                #endregion

                //// "mayur" AWS S3 Changes //// End





                //var cusinfo = _Util.Facade.CustomerFacade.GetById(leadid.Value);

                // var delimeter = new string[] { "-___" };
                // var fullFileName = OnlyFileName[3].Split(delimeter, StringSplitOptions.RemoveEmptyEntries);

                //// ""Mayur" Calculate File Size : start
                #region Calculate file size

                var _fileSize = applicationPDFData.Length / 1024;

                #endregion
                //// ""Mayur" Calculate File Size : End


                CustomerFile cf = new CustomerFile()
                {
                    CompanyId = CompanyId,
                    FileId = Guid.NewGuid(),
                    FileSize = _fileSize,
                    CustomerId = CustomerId,
                    FileDescription = cus.Id + "_" + "Cancellation_Form_Signed" + ".pdf",
                    Filename = "/" + FileKey,
                    Uploadeddate = DateTime.Now, //2020-09-24 05:48:33.000
                    FileFullName = OnlyFileName,
                    IsActive = true,
                    CreatedBy = Guid.Empty,
                    CreatedDate = DateTime.Now,
                    UpdatedBy = Guid.Empty,
                    UpdatedDate = DateTime.Now,
                    WMStatus = LabelHelper.WatermarkStatus.Pending,
                    AWSProcessStatus = LabelHelper.AWSProcessStatus.Uploaded,
                    AWSUploadTS = DateTime.Now
                };
                _Util.Facade.CustomerFileFacade.InsertCustomerFile(cf);
            }
            return new ViewAsPdf()
            {
                // FileName = flightPlan.ListingItemDetailsModel.FlightDetails + ".pdf",
                PageSize = Rotativa.Options.Size.A4,
                PageOrientation = Orientation.Portrait,
                //PageMargins = new Margins(10, 0, 0, 0),
                PageMargins = new Margins(10, 2, 10, 3)
            };



        }


        public JsonResult CustomerCancellationPDFMailAndSMS(int leadid, string PrefferedEmail, string PrefferedNO)
        {
            bool result = false;
            string message = "";
            try
            {
                Customer cus = _Util.Facade.CustomerFacade.GetCustomerById(leadid);
                bool isMailAndSMS = true;
                CustomerCancellationPDFMail(cus.CustomerId, PrefferedEmail, isMailAndSMS);

                SMSCancellationAgreementLinkForPrintBlank(cus.Id, PrefferedNO);
                result = true;
                message = "Email and Sms sent successfully.";
            }
            catch (Exception ex)
            {
                message = "Email address or number missing.";
            }


            return Json(new { result = result, message = message });

        }

        public JsonResult SMSCancellationAgreementLinkForPrintBlank(int leadid, string PrefferedNO)
        {
            var CurrentUser = (HS.Web.UI.Helper.CustomPrincipal)User;

            List<string> ReceiverNumberList = new List<string>();

            //if (!_Util.Facade.CustomerFacade.CustomerIsInCompany(leadid, CurrentUser.CompanyId.Value))
            //{
            //    return Json(new { result = false, message = "Lead is from another company." });
            //}

            var Cus = _Util.Facade.CustomerFacade.GetCustomerById(leadid);

            string encryptedurl = DESEncryptionDecryption.EncryptPlainTextToCipherText(leadid + "#" + Cus.EmailAddress + "#" + CurrentUser.CompanyId.Value.ToString());
            string fullurl = string.Concat(AppConfig.SiteDomain, "/Leads-Cancellation-Agreement/", encryptedurl);
            string shortUrl = "";
            string SMSText = "";
            string ReceiverNumber = "";
            ShortUrl ShortUrl = _Util.Facade.ShortUrlFacade.GetSortUrlByUrl(fullurl, Cus.CustomerId);
            shortUrl = string.Concat(AppConfig.ShortSiteDomain, "/shrt/", ShortUrl.Code);
            //SMSText = string.Concat("Here is your agreements", Environment.NewLine, shortUrl);
            #region ReceiverNumber Setup
            if (!string.IsNullOrWhiteSpace(PrefferedNO))
            {
                ReceiverNumber = PrefferedNO.Replace("-", "");
            }
            else if (!string.IsNullOrWhiteSpace(Cus.SecondaryPhone))
            {
                ReceiverNumber = Cus.SecondaryPhone.Replace("-", "");
            }
            else if (!string.IsNullOrWhiteSpace(Cus.PrimaryPhone))
            {
                ReceiverNumber = Cus.PrimaryPhone.Replace("-", "");
            }
            else
            {
                return Json(new { result = false, message = "Lead has no phone number available." });
            }
            ReceiverNumberList.Add(ReceiverNumber);
            #endregion
            SMSAgreement smsAgreement = new SMSAgreement();

            smsAgreement.ShortUrl = shortUrl;
            string phonenumber = string.Join(";", ReceiverNumberList);
            if (_Util.Facade.SMSFacade.SendCancellationAgrementSMS(smsAgreement, CurrentUser.UserId, CurrentUser.CompanyId.Value, ReceiverNumberList, false, string.Concat(CurrentUser.FirstName, " ", CurrentUser.LastName)) == true)
            {
                LeadCorrespondence LeadCorrespondence = new LeadCorrespondence()
                {
                    CompanyId = CurrentUser.CompanyId.Value,
                    CustomerId = Cus.CustomerId,
                    Type = "SMS",
                    ToMobileNo = phonenumber,
                    BodyContent = "Customer Cancellation Agreement",
                    SentDate = DateTime.Now.UTCCurrentTime(),
                    LastUpdatedDate = DateTime.Now,
                    SentBy = CurrentUser.UserId
                };
                _Util.Facade.LeadCorrespondenceFacade.InsertCorrespondence(LeadCorrespondence);

                return Json(new { result = true, message = string.Format("SMS sent to {0} successfully.", ReceiverNumber) });
            }
            else
            {
                return Json(new { result = false, message = string.Format("Sending to {0} failed.", ReceiverNumber) });
            }

        }
        public JsonResult InsertCustomerCancellationData(CustomerCancellationQueue CusQueue)
        {
            bool result = false;
            string message = "";
            var CurrentUser = (HS.Web.UI.Helper.CustomPrincipal)User;
            List<CustomerCancellationQueue> cencellationList = _Util.Facade.CustomerFacade.GetActiveCustomerQueueCancellationByCustomerId(CusQueue.CustomerId);
            if (cencellationList.Count > 0)
            {
                Customer cus = _Util.Facade.CustomerFacade.GetCustomerByCustomerId(CusQueue.CustomerId);
                cus.CancellationSignature = "";
                _Util.Facade.CustomerFacade.UpdateCustomer(cus);
                foreach (var item in cencellationList)
                {
                    item.IsActive = false;
                    item.IsSigned = false;
                    _Util.Facade.CustomerFacade.UpdateCustomerCancellationQueue(item);
                }
            }
            try
            {
                CustomerCancellationQueue Model = new CustomerCancellationQueue()
                {
                    CancellationId = Guid.NewGuid(),
                    CustomerId = CusQueue.CustomerId,
                    CreatedBy = CurrentUser.UserId,
                    CreatedDate = DateTime.Now,
                    CancellationDate = CusQueue.CancellationDate,
                    RemainingBalance = CusQueue.RemainingBalance,
                    ExpirationDays = CusQueue.ExpirationDays,
                    Note = CusQueue.Note,
                    IsSigned = false,
                    IsActive = true,
                    IsCancelled = false,
                    EmployeeReason = CusQueue.EmployeeReason,
                    ExpirationDate = DateTime.Now,
                    FileId = Guid.Empty
                };
                result = _Util.Facade.CustomerFacade.InsertCustomerCancellationQueue(Model) > 0;

                base.AddUserActivityForCustomer("Customer Is added to Cancellation Queue By " + (CurrentUser.FirstName + " " + CurrentUser.LastName), LabelHelper.ActivityAction.Update, CusQueue.CustomerId, null, null);

                CustomerNote cn = new CustomerNote();
                if (!String.IsNullOrWhiteSpace(CusQueue.Note))
                {
                    cn.Notes = CusQueue.Note;
                    cn.CompanyId = CurrentUser.CompanyId.Value;
                    cn.CreatedDate = DateTime.Now.UTCCurrentTime();
                    cn.CustomerId = CusQueue.CustomerId;
                    cn.CreatedBy = CurrentUser.FirstName + " " + CurrentUser.LastName;
                    cn.CreatedByUid = CurrentUser.UserId;
                    _Util.Facade.NotesFacade.InsertCustomerNote(cn);
                }

                if (result && CusQueue.CacellationReasonList != null)
                {
                    foreach (var reason in CusQueue.CacellationReasonList)
                    {
                        CustomerCancellationReason ccreason = new CustomerCancellationReason()
                        {
                            CustomerCancellationReasonId = Guid.NewGuid(),
                            CompanyId = CurrentUser.CompanyId.Value,
                            CustomerId = CusQueue.CustomerId,
                            CancellationReason = reason
                        };
                        _Util.Facade.CustomerFacade.InsertCustomerCancellationReason(ccreason);
                    }
                }
                Customer cus = _Util.Facade.CustomerFacade.GetCustomerByCustomerId(CusQueue.CustomerId);
                if (cus != null)
                {
                    cus.CustomerStatus = "11";
                    _Util.Facade.CustomerFacade.UpdateCustomer(cus);
                }
            }
            catch (Exception ex)
            {
                result = false;
            }
            #region AgreementSetting
            bool IsCancellAgreement = false;
            GlobalSetting GlobSet = _Util.Facade.GlobalSettingsFacade.GetGlobalsettingBySearchKeyAndCompanyId("CancellationDocumentPreSend", CurrentUser.CompanyId.Value);
            if (GlobSet != null && !string.IsNullOrWhiteSpace(GlobSet.Value))
            {
                if (GlobSet.Value == "true")
                {
                    IsCancellAgreement = true;
                }
            }

            #endregion

            return Json(new { result = result, message = message, IsCancellAgreement = IsCancellAgreement });

        }
        public JsonResult UpdateCustomerCancellation(CustomerCancellationQueue CusQueue)
        {
            bool result = false;
            string message = "";
            try
            {
                CustomerCancellationQueue cancellationQueue = _Util.Facade.CustomerFacade.GetCustomerCancellationQueueById(CusQueue.Id);
                cancellationQueue.Note = CusQueue.OtherReason;
                result = _Util.Facade.CustomerFacade.UpdateCustomerCancellationQueue(cancellationQueue) > 0;

                _Util.Facade.CustomerFacade.DeleteCustomerCancellationReasonByCustomerId(CusQueue.CustomerId);

                var CustomerCompany = _Util.Facade.CustomerFacade.GetCustomerCompanyByCustomerGuidId(CusQueue.CustomerId);
                CustomerCancellationReason ccreason = new CustomerCancellationReason()
                {
                    CustomerCancellationReasonId = Guid.NewGuid(),
                    CompanyId = CustomerCompany.CompanyId,
                    CustomerId = CusQueue.CustomerId,
                    CancellationReason = CusQueue.Reason
                };
                _Util.Facade.CustomerFacade.InsertCustomerCancellationReason(ccreason);
            }
            catch (Exception ex)
            {
                logger.Error(ex, JsonConvert.SerializeObject(CusQueue));
                message = "Internal error!";
                result = false;
            }

            return Json(new { result = result });
        }

        #endregion
        [Authorize]
        [HttpPost]
        public JsonResult CustomerCancellationPDFMail_V2(Guid CustomerId, string PrefferedEmail, bool? isMailAndSMS)
        {
            var CurrentUser = (HS.Web.UI.Helper.CustomPrincipal)User;
            List<string> ValidPrefferedEmail = new List<string>();
            if (!string.IsNullOrWhiteSpace(PrefferedEmail))
            {
                string[] Emailadd = PrefferedEmail.Split(';');
                if (Emailadd != null)
                {
                    foreach (var item in Emailadd)
                    {
                        if (item.IsValidEmailAddress())
                        {
                            ValidPrefferedEmail.Add(item);
                        }
                    }
                }
                if (ValidPrefferedEmail.Count == 0)
                {
                    return Json(new { result = false, message = "Invalid email address." });
                }

            }
            string file = "Customer_Cancellation";
            CustomerCancellationQueue cencellationQueue = _Util.Facade.CustomerFacade.GetCustomerCancellationQueueByCustomerId(CustomerId);

            Customer cus = _Util.Facade.CustomerFacade.GetCustomerByCustomerGuidId(CustomerId);
            Company cuscom = _Util.Facade.CompanyFacade.GetCompanyByComapnyId(CurrentUser.CompanyId.Value);

            List<Lookup> cancellationReasonLookup = _Util.Facade.LookupFacade.GetLookupByKey("CancellationReason");

            CustomerCancellationQueueAggrement model = new CustomerCancellationQueueAggrement()
            {
                CompanyLogo = cuscom.CompanyLogo,
                CompanyCity = cuscom.City,
                CompanyEmail = cuscom.EmailAdress,
                CompanyState = cuscom.State,
                CompanyStreet = cuscom.Street,
                CompanyPhone = cuscom.Phone,
                CompanyName = cuscom.CompanyName,
                CompanyZipcode = cuscom.ZipCode,
                CompanyWebsite = cuscom.Website,

                CustomerName = cus.DisplayName,
                CustomerAddress = cus.Street,
                RemainingBalance = cencellationQueue.RemainingBalance.Value,
                IsSigned = cencellationQueue.IsSigned.Value,
                Reason = cencellationQueue.Reason,
                CancellationDate = cencellationQueue.CancellationDate.Value,
                CompanyId = CurrentUser.CompanyId.Value
            };
            model.CustomerCancellationReasonList = _Util.Facade.CustomerFacade.GetCustomerCancellationReasonList(CustomerId);
            CustomerCancellationLookup cancelLookup = new CustomerCancellationLookup();
            model.CancellationReason = new List<CustomerCancellationLookup>();
            foreach (var item in cancellationReasonLookup)
            {
                if (item.DataValue != "-1")
                {
                    cancelLookup = new CustomerCancellationLookup()
                    {
                        Value = item.DataValue,
                        Text = item.DisplayText
                    };

                    model.CancellationReason.Add(cancelLookup);
                }
            }
            string body = _Util.Facade.AgreementFacade.MakeCancellationAgreementPdf(model);
            ViewBag.Body = body;
            ViewAsPdf actionPDF = new Rotativa.ViewAsPdf("CustomerCancellationAgreement")
            {
                //FileName = "TestView.pdf",
                PageSize = Rotativa.Options.Size.A4,
                PageOrientation = Rotativa.Options.Orientation.Portrait,
                PageMargins = { Left = 1, Right = 1 },

            };
            byte[] applicationPDFData = actionPDF.BuildPdf(ControllerContext);
            Random rand = new Random();
            string filename = ConfigurationManager.AppSettings["File.LeadToCustomerAgreement"];
            var comname = _Util.Facade.CompanyFacade.GetCompanyByComapnyId(CurrentUser.CompanyId.Value).CompanyName.ReplaceSpecialChar();
            var pdftempFolderName = string.Format(filename, comname) + rand.Next().ToString() + cus.Id + "CancellationAgreementMail.pdf";
            string Serverfilename = FileHelper.GetFileFullPath(pdftempFolderName);
            FileHelper.SaveFile(applicationPDFData, Serverfilename);


            bool result = false;
            string encryptedurl = DESEncryptionDecryption.EncryptPlainTextToCipherText(cus.Id + "#" + cus.EmailAddress + "#" + CurrentUser.CompanyId.Value.ToString());
            string fullurl = string.Concat(AppConfig.SiteDomain, "/Leads-Cancellation-Agreement/", encryptedurl);

            ShortUrl ShortUrl = _Util.Facade.ShortUrlFacade.GetSortUrlByUrl(fullurl, cus.CustomerId);
            string shortUrl = string.Concat(AppConfig.ShortSiteDomain, "/shrt/", ShortUrl.Code);
            string message = "";

            if (cus != null)
            {
                string EmailAddress = PrefferedEmail;
                if (ValidPrefferedEmail.Count == 0)
                {
                    EmailAddress = cus.EmailAddress;
                }
                else
                {
                    EmailAddress = string.Join(";", ValidPrefferedEmail);
                }
                if (ValidPrefferedEmail.Count > 0 || (!string.IsNullOrWhiteSpace(cus.EmailAddress) && cus.EmailAddress.IsValidEmailAddress()))
                {
                    result = true;
                    LeadsAggrement la = new LeadsAggrement
                    {
                        CustomerNum = cus.FirstName + " " + cus.LastName,
                        ToEmail = EmailAddress,
                        //LeadsAggrementpdf = new Attachment(Serverfilename, MediaTypeNames.Application.Octet),
                        BodyLink = shortUrl,
                        CustomerId = cus.CustomerId.ToString(),
                        EmployeeId = CurrentUser.UserId.ToString()
                    };
                    bool AgreementResult = false;
                    AgreementResult = _Util.Facade.MailFacade.EmailOnlyCancellationAggrement(la, CurrentUser.CompanyId.Value);
                    #region file save to customer file
                    string pdfLastExt = "_Mail";
                    if (isMailAndSMS.HasValue && isMailAndSMS.Value == true)
                    {
                        pdfLastExt = "_Mail_SMS";
                    }
                    CustomerFile cfs = new CustomerFile()
                    {
                        FileDescription = cus.Id + "_" + Regex.Replace(file, @"\s+", String.Empty) + pdfLastExt + ".pdf",
                        FileId = Guid.NewGuid(),
                        Filename = "/" + pdftempFolderName,
                        FileFullName = Regex.Replace(file, @"\s+", String.Empty) + ".pdf",
                        Uploadeddate = DateTime.Now.UTCCurrentTime(),
                        CustomerId = cus.CustomerId,
                        CompanyId = CurrentUser.CompanyId.Value,
                        IsActive = true,
                        CreatedBy = CurrentUser.UserId,
                        CreatedDate = DateTime.Now.UTCCurrentTime(),
                        UpdatedBy = CurrentUser.UserId,
                        UpdatedDate = DateTime.Now.UTCCurrentTime(),
                        WMStatus = LabelHelper.WatermarkStatus.Pending,
                        AWSProcessStatus = LabelHelper.AWSProcessStatus.Local
                    };
                    _Util.Facade.CustomerFileFacade.InsertCustomerFile(cfs);
                    string logMessage = Regex.Replace(file, @"\s+", String.Empty) + ".pdf " + message.ToLower();
                    base.AddUserActivityForCustomer(logMessage, LabelHelper.ActivityAction.AddDocumentFileManagement, null, cus.Id, null);

                    #endregion
                    if (AgreementResult == true)
                    {
                        message = "Cancellation Form sent to " + EmailAddress;

                        LeadCorrespondence LeadCorrespondence = new LeadCorrespondence()
                        {
                            CompanyId = CurrentUser.CompanyId.Value,
                            CustomerId = cus.CustomerId,
                            Type = LabelHelper.CorrespondenceMessageTyp.Email,
                            TemplateKey = "CancellationAgreementMail",
                            ToEmail = EmailAddress,
                            Subject = "Customer Cancellation Agreement",
                            BodyContent = shortUrl,
                            SentDate = DateTime.Now.UTCCurrentTime(),
                            LastUpdatedDate = DateTime.Now.UTCCurrentTime(),
                            SentBy = CurrentUser.UserId
                        };
                        _Util.Facade.LeadCorrespondenceFacade.InsertCorrespondence(LeadCorrespondence);
                    }
                    file = "Customer_Cancellation";

                }
                else
                {
                    result = false;
                    message = "Invalid email address.";
                }
            }

            return Json(new { result = result, message = message });
        }

        public JsonResult CustomerCancellationPDFMail(Guid CustomerId, string PrefferedEmail, bool? isMailAndSMS)
        {

            WebClient webClient;
            byte[] fileBytes1;
            string Temp_FileName;

            var CurrentUser = (HS.Web.UI.Helper.CustomPrincipal)User;
            List<string> ValidPrefferedEmail = new List<string>();
            if (!string.IsNullOrWhiteSpace(PrefferedEmail))
            {
                string[] Emailadd = PrefferedEmail.Split(';');
                if (Emailadd != null)
                {
                    foreach (var item in Emailadd)
                    {
                        if (item.IsValidEmailAddress())
                        {
                            ValidPrefferedEmail.Add(item);
                        }
                    }
                }
                if (ValidPrefferedEmail.Count == 0)
                {
                    return Json(new { result = false, message = "Invalid email address." });
                }

            }
            string file = "Customer_Cancellation";
            CustomerCancellationQueue cencellationQueue = _Util.Facade.CustomerFacade.GetCustomerCancellationQueueByCustomerId(CustomerId);

            Customer cus = _Util.Facade.CustomerFacade.GetCustomerByCustomerGuidId(CustomerId);
            Company cuscom = _Util.Facade.CompanyFacade.GetCompanyByComapnyId(CurrentUser.CompanyId.Value);

            List<Lookup> cancellationReasonLookup = _Util.Facade.LookupFacade.GetLookupByKey("CancellationReason");

            CustomerCancellationQueueAggrement model = new CustomerCancellationQueueAggrement()
            {
                CompanyLogo = cuscom.CompanyLogo,
                CompanyCity = cuscom.City,
                CompanyEmail = cuscom.EmailAdress,
                CompanyState = cuscom.State,
                CompanyStreet = cuscom.Street,
                CompanyPhone = cuscom.Phone,
                CompanyName = cuscom.CompanyName,
                CompanyZipcode = cuscom.ZipCode,
                CompanyWebsite = cuscom.Website,

                CustomerName = cus.DisplayName,
                CustomerAddress = cus.Street,
                RemainingBalance = cencellationQueue.RemainingBalance.Value,
                IsSigned = cencellationQueue.IsSigned.Value,
                Reason = cencellationQueue.Reason,
                CancellationDate = cencellationQueue.CancellationDate.Value,
                CompanyId = CurrentUser.CompanyId.Value
            };
            model.CustomerCancellationReasonList = _Util.Facade.CustomerFacade.GetCustomerCancellationReasonList(CustomerId);
            CustomerCancellationLookup cancelLookup = new CustomerCancellationLookup();
            model.CancellationReason = new List<CustomerCancellationLookup>();
            foreach (var item in cancellationReasonLookup)
            {
                if (item.DataValue != "-1")
                {
                    cancelLookup = new CustomerCancellationLookup()
                    {
                        Value = item.DataValue,
                        Text = item.DisplayText
                    };

                    model.CancellationReason.Add(cancelLookup);
                }
            }
            string body = _Util.Facade.AgreementFacade.MakeCancellationAgreementPdf(model);
            ViewBag.Body = body;
            ViewAsPdf actionPDF = new Rotativa.ViewAsPdf("CustomerCancellationAgreement")
            {
                //FileName = "TestView.pdf",
                PageSize = Rotativa.Options.Size.A4,
                PageOrientation = Rotativa.Options.Orientation.Portrait,
                PageMargins = { Left = 1, Right = 1 },

            };
            byte[] applicationPDFData = actionPDF.BuildPdf(ControllerContext);

            #region File Save
            //Random rand = new Random();
            //string filename = ConfigurationManager.AppSettings["File.LeadToCustomerAgreement"];
            //var comname = _Util.Facade.CompanyFacade.GetCompanyByComapnyId(CurrentUser.CompanyId.Value).CompanyName.ReplaceSpecialChar();
            //var pdftempFolderName = string.Format(filename, comname) + rand.Next().ToString() + cus.Id + "CancellationAgreementMail.pdf";
            //string Serverfilename = FileHelper.GetFileFullPath(pdftempFolderName);
            //FileHelper.SaveFile(applicationPDFData, Serverfilename);
            #endregion

            //// "mayur" AWS S3 Changes //// Start

            #region File Save on AWS S3

            Random rand = new Random();
            string filename = ConfigurationManager.AppSettings["File.LeadToCustomerAgreement"];
            filename = filename.TrimEnd('/');

            var comname = _Util.Facade.CompanyFacade.GetCompanyByComapnyId(CurrentUser.CompanyId.Value).CompanyName.ReplaceSpecialChar();

            string FilePath = string.Format(filename, comname);
            string FileName = rand.Next().ToString() + cus.Id + "CancellationAgreementMail.pdf";

            string FileKey = string.Format($"{FilePath}/{FileName}");

            var returnurl = string.Empty;

            var task = Task.Run(async () => {
                AWSS3ObjectService AWSobject = new AWSS3ObjectService();
                await AWSobject.UploadFile(FileKey, applicationPDFData);
                await AWSobject.MakePublic(FileName, FilePath);
            });
            task.Wait();

            /// "mayur" used thread for async s3 methods : start

            //Thread thread = new Thread(async () => {

            //    AWSS3ObjectService AWSobject = new AWSS3ObjectService();

            //    await AWSobject.UploadFile(FileKey, applicationPDFData);
            //    await AWSobject.MakePublic(FileName, FilePath);

            //});
            //thread.Start();

            /// "mayur" used thread for async s3 methods : End



            returnurl = String.Format(AppConfig.AWSS3Url, AppConfig.AWSS3BucketName);
            returnurl = returnurl + FileKey;


            ViewBag.ReturnUrl = returnurl;
            ViewBag.FileName = FileName;
            ViewBag.FileKey = FileKey;


            #endregion

            //// "mayur" AWS S3 Changes //// End




            bool result = false;
            string encryptedurl = DESEncryptionDecryption.EncryptPlainTextToCipherText(cus.Id + "#" + cus.EmailAddress + "#" + CurrentUser.CompanyId.Value.ToString());
            string fullurl = string.Concat(AppConfig.SiteDomain, "/Leads-Cancellation-Agreement/", encryptedurl);

            ShortUrl ShortUrl = _Util.Facade.ShortUrlFacade.GetSortUrlByUrl(fullurl, cus.CustomerId);
            string shortUrl = string.Concat(AppConfig.ShortSiteDomain, "/shrt/", ShortUrl.Code);
            string message = "";


            /// Mayur :: File Download to temp folder :start

            //webClient = new WebClient();
            //fileBytes1 = webClient.DownloadData(returnurl);

            //File(fileBytes1, System.Net.Mime.MediaTypeNames.Application.Octet, FileName).ToString();
            File(applicationPDFData, System.Net.Mime.MediaTypeNames.Application.Octet, FileName).ToString();



            Temp_FileName = Server.MapPath("~/EmailFileCache/tmp_" + FileName);

            //if (!System.IO.File.Exists(Temp_FileName))
            //{
            //    System.IO.File.WriteAllBytes(Temp_FileName, fileBytes1);
            //}
            //else
            //{
            //    System.IO.File.WriteAllBytes(Temp_FileName, fileBytes1);
            //}

            /// Mayur :: File Download to temp folder :End
            /// 
            if (cus != null)
            {
                string EmailAddress = PrefferedEmail;
                if (ValidPrefferedEmail.Count == 0)
                {
                    EmailAddress = cus.EmailAddress;
                }
                else
                {
                    EmailAddress = string.Join(";", ValidPrefferedEmail);
                }
                if (ValidPrefferedEmail.Count > 0 || (!string.IsNullOrWhiteSpace(cus.EmailAddress) && cus.EmailAddress.IsValidEmailAddress()))
                {
                    result = true;
                    LeadsAggrement la = new LeadsAggrement
                    {
                        CustomerNum = cus.FirstName + " " + cus.LastName,
                        ToEmail = EmailAddress,
                        //LeadsAggrementpdf = new Attachment(Temp_FileName, MediaTypeNames.Application.Octet),
                        LeadsAggrementpdf = new Attachment(new MemoryStream(applicationPDFData), FileName, MediaTypeNames.Application.Octet),

                        BodyLink = shortUrl,
                        CustomerId = cus.CustomerId.ToString(),
                        EmployeeId = CurrentUser.UserId.ToString()
                    };
                    bool AgreementResult = false;
                    AgreementResult = _Util.Facade.MailFacade.EmailOnlyCancellationAggrement(la, CurrentUser.CompanyId.Value);
                    #region file save to customer file
                    string pdfLastExt = "_Mail";
                    if (isMailAndSMS.HasValue && isMailAndSMS.Value == true)
                    {
                        pdfLastExt = "_Mail_SMS";
                    }

                    //// ""Mayur" Calculate File Size : start
                    #region Calculate file size

                    var _fileSize = applicationPDFData.Length / 1024;

                    #endregion
                    //// ""Mayur" Calculate File Size : End


                    CustomerFile cfs = new CustomerFile()
                    {
                        FileDescription = cus.Id + "_" + Regex.Replace(file, @"\s+", String.Empty) + pdfLastExt + ".pdf",
                        FileId = Guid.NewGuid(),
                        FileSize = _fileSize,
                        Filename = "/" + FileKey,
                        FileFullName = Regex.Replace(file, @"\s+", String.Empty) + ".pdf",
                        Uploadeddate = DateTime.Now.UTCCurrentTime(),
                        CustomerId = cus.CustomerId,
                        CompanyId = CurrentUser.CompanyId.Value,
                        IsActive = true,
                        CreatedBy = CurrentUser.UserId,
                        CreatedDate = DateTime.Now.UTCCurrentTime(),
                        UpdatedBy = CurrentUser.UserId,
                        UpdatedDate = DateTime.Now.UTCCurrentTime(),
                        WMStatus = LabelHelper.WatermarkStatus.Pending,
                        AWSProcessStatus = LabelHelper.AWSProcessStatus.Local
                    };
                    _Util.Facade.CustomerFileFacade.InsertCustomerFile(cfs);
                    string logMessage = Regex.Replace(file, @"\s+", String.Empty) + ".pdf " + message.ToLower();
                    base.AddUserActivityForCustomer(logMessage, LabelHelper.ActivityAction.AddDocumentFileManagement, null, cus.Id, null);

                    CustomerCancellationQueue queuemodel = _Util.Facade.CustomerFacade.GetActiveCustomerCancellationQueueByCustomerId(CustomerId);
                    if(queuemodel != null)
                    {
                        if(queuemodel.ExpirationDays > 0 && queuemodel.ExpirationDate.HasValue)
                        {
                            double doublevalue = Convert.ToDouble(queuemodel.ExpirationDays);
                            CustomerCancellationQueue queue = new CustomerCancellationQueue()
                            { 
                                Id = queuemodel.Id,
                                ExpirationDate = queuemodel.ExpirationDate.Value.AddDays(doublevalue),
                                CancellationId = Guid.NewGuid(),
                                CustomerId = CustomerId,
                                CreatedBy = CurrentUser.UserId,
                                CreatedDate = DateTime.Now,
                                CancellationDate = queuemodel.CancellationDate,
                                RemainingBalance = queuemodel.RemainingBalance,
                                ExpirationDays = queuemodel.ExpirationDays,
                                Note = queuemodel.Note,
                                IsSigned = false,
                                IsActive = true,
                                IsCancelled = false,
                                EmployeeReason = queuemodel.EmployeeReason, 
                                FileId = cfs.FileId
                            };
                            _Util.Facade.CustomerFacade.UpdateCustomerCancellationQueue(queue);
                        }  
                    }
                    #endregion
                    if (AgreementResult == true)
                    {
                        message = "Cancellation Form sent to " + EmailAddress;

                        LeadCorrespondence LeadCorrespondence = new LeadCorrespondence()
                        {
                            CompanyId = CurrentUser.CompanyId.Value,
                            CustomerId = cus.CustomerId,
                            Type = LabelHelper.CorrespondenceMessageTyp.Email,
                            TemplateKey = "CancellationAgreementMail",
                            ToEmail = EmailAddress,
                            Subject = "Customer Cancellation Agreement",
                            BodyContent = shortUrl,
                            SentDate = DateTime.Now.UTCCurrentTime(),
                            LastUpdatedDate = DateTime.Now.UTCCurrentTime(),
                            SentBy = CurrentUser.UserId
                        };
                        _Util.Facade.LeadCorrespondenceFacade.InsertCorrespondence(LeadCorrespondence);
                    }
                    file = "Customer_Cancellation";

                }
                else
                {
                    result = false;
                    message = "Invalid email address.";
                }
            }

            return Json(new { result = result, message = message });
        }

        [HttpPost]
        public JsonResult CancellationAgreeSetup(int? Id)
        {
            if (!Id.HasValue)
                return Json(false);
            Customer _Customer = new Customer();

            Guid CompanyId = new Guid();
            bool result = false;
            if (User.Identity.IsAuthenticated)
            {
                var CurrentUser = (HS.Web.UI.Helper.CustomPrincipal)User;
                CompanyId = CurrentUser.CompanyId.Value;
            }
            else
            {
                CustomerCompany custommerCompany = _Util.Facade.CustomerFacade.GetCustomerCompanyByCustomerId(Id.Value);
                CompanyId = custommerCompany.CompanyId;
            }
            Company _Company = new Company { CompanyId = CompanyId };

            if (Id.Value > 0)
            {
                _Customer = _Util.Facade.CustomerFacade.GetCustomersById(Id.Value);

            }
            CustomerCancellationQueue cencellationQueue = _Util.Facade.CustomerFacade.GetCustomerCancellationQueueByCustomerId(_Customer.CustomerId);
            cencellationQueue.IsSigned = true;

            try
            {
                _Util.Facade.CustomerFacade.UpdateCustomerCancellationQueue(cencellationQueue);
                result = true;
            }
            catch (Exception ex)
            {
                result = false;
            }

            result = result && IAgreeCustomerCancellationEmail(_Customer, _Company);
            //base.AddUserActivityForCustomer("Customer Cancellation Form Is Signed " , LabelHelper.ActivityAction.Update, _Customer.CustomerId, null, null);
            UserActivity ua = new UserActivity()
            {
                ActivityId = Guid.NewGuid(),
                PageUrl = Request.Url.AbsoluteUri != null ? Request.Url.AbsoluteUri : "",
                ReferrerUrl = Request.UrlReferrer != null ? Request.UrlReferrer.AbsoluteUri : "",
                // new paramiter
                Action = "File Signed",
                StatsDate = DateTime.UtcNow,
                UserId = _Customer.CustomerId != null ? _Customer.CustomerId : Guid.NewGuid(),
                UserName = _Customer.FirstName + " " + _Customer.LastName,
                ActionDisplyText = "Customer Cancellation Form Is Signed",


                UserAgent = AppConfig.GetUserAgent != null ? AppConfig.GetUserAgent : "",
                UserIp = AppConfig.GetIP != null ? AppConfig.GetIP : ""
            };
            Guid ActivityID = ua.ActivityId;
            _Util.Facade.UserActivityFacade.InsertUserActivity(ua);
            UserActivityCustomer uac = new UserActivityCustomer()
            {
                ActivityId = ActivityID != null ? ActivityID : Guid.NewGuid(),

                CustomerId = _Customer.CustomerId != null ? _Customer.CustomerId : Guid.NewGuid(),
                RefId = _Customer.Id.ToString(),

            };
            _Util.Facade.UserActivityCustomerFacade.InsertUserActivityCustomer(uac);
            return Json(result);
        }
        public bool IAgreeCustomerCancellationEmail_v2(Customer leadDetails, Company _Company)
        {

            bool result = true;

            Guid CompanyId = new Guid();
            Customer cus = _Util.Facade.CustomerFacade.GetCustomerByCustomerGuidId(leadDetails.CustomerId);
            if (User.Identity.IsAuthenticated)
            {
                var CurrentUser = (HS.Web.UI.Helper.CustomPrincipal)User;
                CompanyId = CurrentUser.CompanyId.Value;
            }
            else
            {
                CustomerCompany custommerCompany = _Util.Facade.CustomerFacade.GetCustomerCompanyByCustomerId(cus.Id);
                CompanyId = custommerCompany.CompanyId;
            }
            CustomerCancellationQueue cencellationQueue = _Util.Facade.CustomerFacade.GetCustomerCancellationQueueByCustomerId(leadDetails.CustomerId);
            Company cuscom = _Util.Facade.CompanyFacade.GetCompanyByComapnyId(CompanyId);
            List<Lookup> cancellationReasonLookup = _Util.Facade.LookupFacade.GetLookupByKey("CancellationReason");
            CustomerCancellationQueueAggrement model = new CustomerCancellationQueueAggrement()
            {
                CompanyLogo = _Util.Facade.CompanyBranchFacade.GetCompanyEmailLogoByCompanyId(cuscom.CompanyId),
                CompanyCity = cuscom.City,
                CompanyEmail = cuscom.EmailAdress,
                CompanyState = cuscom.State,
                CompanyStreet = cuscom.Street,
                CompanyPhone = cuscom.Phone,
                CompanyName = cuscom.CompanyName,
                CompanyZipcode = cuscom.ZipCode,
                CompanyWebsite = cuscom.Website,
                SignedImg = cus.CancellationSignature,
                CustomerName = cus.DisplayName,
                CustomerAddress = cus.Street,
                RemainingBalance = cencellationQueue.RemainingBalance.Value,
                IsSigned = cencellationQueue.IsSigned.Value,
                Reason = cencellationQueue.Reason,
                CancellationDate = cencellationQueue.CancellationDate.Value,
                CompanyId = CompanyId,
                Note = cencellationQueue.Note
            };
            model.CustomerCancellationReasonList = _Util.Facade.CustomerFacade.GetCustomerCancellationReasonList(leadDetails.CustomerId);
            CustomerCancellationLookup cancelLookup = new CustomerCancellationLookup();
            model.CancellationReason = new List<CustomerCancellationLookup>();
            foreach (var item in cancellationReasonLookup)
            {
                if (item.DataValue != "-1")
                {
                    cancelLookup = new CustomerCancellationLookup()
                    {
                        Value = item.DataValue,
                        Text = item.DisplayText
                    };

                    model.CancellationReason.Add(cancelLookup);
                }
            }
            string body = _Util.Facade.AgreementFacade.MakeCancellationAgreementPdf(model);
            ViewBag.Body = body;
            ViewAsPdf actionPDF = new Rotativa.ViewAsPdf("CustomerCancellationAgreement")
            {
                PageSize = Rotativa.Options.Size.A4,
                PageOrientation = Rotativa.Options.Orientation.Portrait,
                PageMargins = { Left = 1, Right = 1 },

            };
            byte[] applicationPDFData = actionPDF.BuildPdf(ControllerContext);
            Random rand = new Random();
            string filename = ConfigurationManager.AppSettings["File.LeadToCustomerAgreement"];
            var comname = _Util.Facade.CompanyFacade.GetCompanyByComapnyId(CompanyId).CompanyName.ReplaceSpecialChar();
            var pdftempFolderName = string.Format(filename, comname) + rand.Next().ToString() + cus.Id + "CancellationAgreementMail.pdf";
            string Serverfilename = FileHelper.GetFileFullPath(pdftempFolderName);
            FileHelper.SaveFile(applicationPDFData, Serverfilename);
            var OnlyFileName = pdftempFolderName.Split('/');
            var delimeter = new string[] { "-___" };
            var fullFileName = OnlyFileName[3].Split(delimeter, StringSplitOptions.RemoveEmptyEntries);

            List<Employee> EmployeeDetails = _Util.Facade.EmployeeFacade.GetAllQAEmployee(_Company.CompanyId);
            LeadtoCustomerCancellation leadtocus = new LeadtoCustomerCancellation();
            leadtocus.CustomerName = leadDetails.FirstName + " " + leadDetails.LastName;
            if (leadDetails.MiddleName != null)
            {
                leadtocus.CustomerName = leadDetails.FirstName + " " + leadDetails.MiddleName + " " + leadDetails.LastName;
            }
            leadtocus.fileManagementpdf = new Attachment(Serverfilename, MediaTypeNames.Application.Octet);
            leadtocus.CustomerAddress = leadDetails.Address;
            leadtocus.ToEmail = leadDetails.EmailAddress;
            _Util.Facade.MailFacade.EmailToCustomerForCancellation(leadtocus, _Company.CompanyId);

            return result;
        }

        public bool IAgreeCustomerCancellationEmail(Customer leadDetails, Company _Company)
        {
            WebClient webClient;
            byte[] fileBytes1;
            string Temp_FileName;

            bool result = true;

            Guid CompanyId = new Guid();
            Customer cus = _Util.Facade.CustomerFacade.GetCustomerByCustomerGuidId(leadDetails.CustomerId);
            if (User.Identity.IsAuthenticated)
            {
                var CurrentUser = (HS.Web.UI.Helper.CustomPrincipal)User;
                CompanyId = CurrentUser.CompanyId.Value;
            }
            else
            {
                CustomerCompany custommerCompany = _Util.Facade.CustomerFacade.GetCustomerCompanyByCustomerId(cus.Id);
                CompanyId = custommerCompany.CompanyId;
            }
            CustomerCancellationQueue cencellationQueue = _Util.Facade.CustomerFacade.GetCustomerCancellationQueueByCustomerId(leadDetails.CustomerId);
            Company cuscom = _Util.Facade.CompanyFacade.GetCompanyByComapnyId(CompanyId);
            List<Lookup> cancellationReasonLookup = _Util.Facade.LookupFacade.GetLookupByKey("CancellationReason");
            CustomerCancellationQueueAggrement model = new CustomerCancellationQueueAggrement()
            {
                CompanyLogo = _Util.Facade.CompanyBranchFacade.GetCompanyEmailLogoByCompanyId(cuscom.CompanyId),
                CompanyCity = cuscom.City,
                CompanyEmail = cuscom.EmailAdress,
                CompanyState = cuscom.State,
                CompanyStreet = cuscom.Street,
                CompanyPhone = cuscom.Phone,
                CompanyName = cuscom.CompanyName,
                CompanyZipcode = cuscom.ZipCode,
                CompanyWebsite = cuscom.Website,
                SignedImg = cus.CancellationSignature,
                CustomerName = cus.DisplayName,
                CustomerAddress = cus.Street,
                RemainingBalance = cencellationQueue.RemainingBalance.Value,
                IsSigned = cencellationQueue.IsSigned.Value,
                Reason = cencellationQueue.Reason,
                CancellationDate = cencellationQueue.CancellationDate.Value,
                CompanyId = CompanyId,
                Note = cencellationQueue.Note
            };
            model.CustomerCancellationReasonList = _Util.Facade.CustomerFacade.GetCustomerCancellationReasonList(leadDetails.CustomerId);
            CustomerCancellationLookup cancelLookup = new CustomerCancellationLookup();
            model.CancellationReason = new List<CustomerCancellationLookup>();
            foreach (var item in cancellationReasonLookup)
            {
                if (item.DataValue != "-1")
                {
                    cancelLookup = new CustomerCancellationLookup()
                    {
                        Value = item.DataValue,
                        Text = item.DisplayText
                    };

                    model.CancellationReason.Add(cancelLookup);
                }
            }
            string body = _Util.Facade.AgreementFacade.MakeCancellationAgreementPdf(model);
            ViewBag.Body = body;
            ViewAsPdf actionPDF = new Rotativa.ViewAsPdf("CustomerCancellationAgreement")
            {
                PageSize = Rotativa.Options.Size.A4,
                PageOrientation = Rotativa.Options.Orientation.Portrait,
                PageMargins = { Left = 1, Right = 1 },

            };
            byte[] applicationPDFData = actionPDF.BuildPdf(ControllerContext);

            #region file save
            //Random rand = new Random();
            //string filename = ConfigurationManager.AppSettings["File.LeadToCustomerAgreement"];
            //var comname = _Util.Facade.CompanyFacade.GetCompanyByComapnyId(CompanyId).CompanyName.ReplaceSpecialChar();
            //var pdftempFolderName = string.Format(filename, comname) + rand.Next().ToString() + cus.Id + "CancellationAgreementMail.pdf";
            //string Serverfilename = FileHelper.GetFileFullPath(pdftempFolderName);
            //FileHelper.SaveFile(applicationPDFData, Serverfilename);
            #endregion 

            //// "mayur" AWS S3 Changes //// Start

            #region File Save on AWS S3

            Random rand = new Random();
            string filename = ConfigurationManager.AppSettings["File.LeadToCustomerAgreement"];
            filename = filename.TrimEnd('/');

            var comname = _Util.Facade.CompanyFacade.GetCompanyByComapnyId(CompanyId).CompanyName.ReplaceSpecialChar();

            string FilePath = string.Format(filename, comname);
            string FileName = rand.Next().ToString() + cus.Id + "CancellationAgreementMail.pdf";

            string FileKey = string.Format($"{FilePath}/{FileName}");

            var returnurl = "";

            var task = Task.Run(async () => {
                AWSS3ObjectService AWSobject = new AWSS3ObjectService();

                await AWSobject.UploadFile(FileKey, applicationPDFData);
                await AWSobject.MakePublic(FileName, FilePath);
            });

            task.Wait();

            /// "mayur" used thread for async s3 methods : start

            //Thread thread = new Thread(async () => {

            //    AWSS3ObjectService AWSobject = new AWSS3ObjectService();

            //    await AWSobject.UploadFile(FileKey, applicationPDFData);
            //    await AWSobject.MakePublic(FileName, FilePath);

            //});
            //thread.Start();

            ///// "mayur" used thread for async s3 methods : End
            //Thread.Sleep(5000);


            returnurl = String.Format(AppConfig.AWSS3Url, AppConfig.AWSS3BucketName);
            returnurl = returnurl + FileKey;


            ViewBag.ReturnUrl = returnurl;
            ViewBag.FileName = FileName;
            ViewBag.FileKey = FileKey;


            #endregion

            //// "mayur" AWS S3 Changes //// End


           // var OnlyFileName = FileKey.Split('/');
            string OnlyFileName = ViewBag.FileName;
            if (OnlyFileName.Contains("-___"))
            {
                string[] delimeter = new string[] { "-___" };
                //var fullFileName = OnlyFileName[3].Split(delimeter, StringSplitOptions.RemoveEmptyEntries);
            }
                
            //var delimeter = new string[] { "-___" };
            
           

            List<Employee> EmployeeDetails = _Util.Facade.EmployeeFacade.GetAllQAEmployee(_Company.CompanyId);
            LeadtoCustomerCancellation leadtocus = new LeadtoCustomerCancellation();
            leadtocus.CustomerName = leadDetails.FirstName + " " + leadDetails.LastName;
            if (leadDetails.MiddleName != null)
            {
                leadtocus.CustomerName = leadDetails.FirstName + " " + leadDetails.MiddleName + " " + leadDetails.LastName;
            }
            // leadtocus.fileManagementpdf = new Attachment(ViewBag.ReturnUrl, MediaTypeNames.Application.Octet);

            /// Mayur :: File Download to temp folder :start

            //webClient = new WebClient();
            //fileBytes1 = webClient.DownloadData(returnurl);

            //File(fileBytes1, System.Net.Mime.MediaTypeNames.Application.Octet, FileName).ToString();

            File(applicationPDFData, System.Net.Mime.MediaTypeNames.Application.Octet, FileName).ToString();



            Temp_FileName = Server.MapPath("~/EmailFileCache/tmp_" + FileName);

            //if (!System.IO.File.Exists(Temp_FileName))
            //{
            //    System.IO.File.WriteAllBytes(Temp_FileName, fileBytes1);
            //}
            //else
            //{
            //    System.IO.File.WriteAllBytes(Temp_FileName, fileBytes1);
            //}

            /// Mayur :: File Download to temp folder :End

            Stream stream = new MemoryStream(applicationPDFData);
            //leadtocus.fileManagementpdf = new Attachment(stream,Temp_FileName, MediaTypeNames.Application.Octet);
            leadtocus.fileManagementpdf = new Attachment(stream, FileName, MediaTypeNames.Application.Octet);

            leadtocus.CustomerAddress = leadDetails.Address;
            leadtocus.ToEmail = leadDetails.EmailAddress;   
            _Util.Facade.MailFacade.EmailToCustomerForCancellation(leadtocus, _Company.CompanyId);

            return result;
        }
        public ActionResult CreditGrades()
        {
            return View();
        }
        public ActionResult LoadCreditGrades()
        {
            List<CreditScoreGrade> creditScore = new List<CreditScoreGrade>();
            creditScore = _Util.Facade.CustomerFacade.GetAllCreditScoreGrade();
            return View(creditScore);
        }

        public ActionResult AddCreditGrade(int? Id)
        {
            CreditScoreGrade cusGrade = new CreditScoreGrade();
            if (Id > 0)
            {
                cusGrade = _Util.Facade.CustomerFacade.GetCreditScoreGradeById(Id.Value);
            }

            return View(cusGrade);
        }

        public JsonResult SaveCreditGrade(CreditScoreGrade creditScoreGrade)
        {
            var result = false;

            var CurrentUser = (HS.Web.UI.Helper.CustomPrincipal)User;

            CreditScoreGrade creditScore = new CreditScoreGrade();
            if (CurrentUser == null)
            {
                return Json(result);
            }
            if (creditScoreGrade.ID > 0)
            {
                creditScore = _Util.Facade.CustomerFacade.GetCreditScoreGradeById(creditScoreGrade.ID);
                creditScore.MaxScore = creditScoreGrade.MaxScore;
                creditScore.MinScore = creditScoreGrade.MinScore;
                creditScore.Grade = creditScoreGrade.Grade;


                try
                {
                    _Util.Facade.CustomerFacade.UpdateCreditScoreGrade(creditScore);
                    result = true;
                }
                catch (Exception ex)
                {
                    result = false;
                }
            }
            else
            {
                creditScore.MaxScore = creditScoreGrade.MaxScore;
                creditScore.MinScore = creditScoreGrade.MinScore;
                creditScore.Grade = creditScoreGrade.Grade;
                creditScore.CreditGradeId = Guid.NewGuid();
                creditScore.CreatedBy = CurrentUser.UserId;
                creditScore.CreatedDate = DateTime.Now.UTCCurrentTime();
                try
                {
                    _Util.Facade.CustomerFacade.InsertCreditScoreGrade(creditScore);
                    result = true;
                }
                catch (Exception ex)
                {
                    result = false;
                }
            }
            return Json(result);
        }

        [Authorize]
        [HttpPost]
        public JsonResult DeleteCreditScoreGrade(int Id)
        {
            var res = _Util.Facade.CustomerFacade.DeleteCreditScoreGrade(Id);
            if (res > 0)
            {
                return Json(new { result = res, message = "Credit Grade deleted successfully." });
            }
            else
            {
                return Json(new { result = res, message = "An error occured." });
            }

        }


        public ActionResult EditCredential(Guid? CustomerId)
        {
            UserLogin c = new UserLogin();
            c = _Util.Facade.UserLoginFacade.GetUserLoginByUserId(CustomerId.Value);
            ViewBag.CustomerId = CustomerId;

            ViewBag.EmailAddress = "";
            if (CustomerId != Guid.Empty)
            {
                Customer cus = _Util.Facade.CustomerFacade.GetCustomerByCustomerId(CustomerId.Value);
                if (cus != null)
                {
                    if (c != null)
                    {
                        ViewBag.EmailAddress = c.UserName;
                    }
                    else if (!string.IsNullOrEmpty(cus.EmailAddress))
                    {
                        ViewBag.EmailAddress = cus.EmailAddress;
                    }

                }
            }
            if (c == null)
            {
                c = new UserLogin();
            }
            return View(c);
        }
        public ActionResult GeneratePassword(int length)
        {
            string password = "";
            Random rand = new Random(Guid.NewGuid().GetHashCode());
            string Alphabet = "abcdefghijklmnopqrstuvwyxzABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789";
            char[] chars = new char[length];
            for (int i = 0; i < length; i++)
            {
                chars[i] = Alphabet[rand.Next(Alphabet.Length)];
            }
            password = new string(chars);
            return Json(password);
        }
        public string GenarateToken(int length)
        {
            string password = "";
            Random rand = new Random(Guid.NewGuid().GetHashCode());
            string Alphabet = "0123456789";
            char[] chars = new char[length];
            for (int i = 0; i < length; i++)
            {
                chars[i] = Alphabet[rand.Next(Alphabet.Length)];
            }
            password = new string(chars);
            return password;
        }
        public ActionResult CheckRoleAndSaveCredential(UserLogin userlogin, string Token)
        {
            bool result = false;
            string message = "";
            var CurrentUser = (HS.Web.UI.Helper.CustomPrincipal)User;
            Customer cus = _Util.Facade.CustomerFacade.GetCustomerByCustomerId(CurrentUser.UserId);
            if (cus.Passcode == Token)
            {
                //Session["TokenPassed"] = "Yes";
                //Session.Timeout = 1;
                result = true;
                return CredentialSave(userlogin);
            }
            else
            {
                result = false;
                message = "Verbal password does not match. ";
                //Session.Remove("token");
                //Session.Remove("TokenPassed");
                return Json(new { result = result, message = message });
            }

        }
        public ActionResult CheckTokenAndSaveCredential(UserLogin userlogin)
        {
            bool result = false;
            string message = "";
            if (Session["token"] != null)
            {
                if (Session["token"].ToString() == userlogin.Token)
                {
                    Session["TokenPassed"] = "Yes";
                    Session.Timeout = 1;
                    result = true;
                    return CredentialSave(userlogin);
                }
                else
                {
                    result = false;
                    message = "OTP does not match. ";
                    Session.Remove("token");
                    Session.Remove("TokenPassed");
                    return Json(new { result = result, message = message });
                }

            }

            else
            {
                return Json(new { result = result, message = message });
            }
        }
        [Authorize]
        [HttpPost]
        public JsonResult CredentialSave(UserLogin userlogin)
        {
            var CurrentUser = (HS.Web.UI.Helper.CustomPrincipal)User;
            string password = userlogin.Password;
            userlogin.Password = MD5Encryption.GetMD5HashData(userlogin.Password);

            var result = false;
            UserLogin user = new UserLogin();
            Customer Cus = _Util.Facade.CustomerFacade.GetCustomerByCustomerId(userlogin.UserId);
            string message = "Internal error. Please try again.";
            if (userlogin.Id > 0)
            {

                user = _Util.Facade.UserLoginFacade.GetUserLoginById(userlogin.Id);
                user.Password = userlogin.Password;
                user.IsActive = true;
                user.LastUpdatedBy = CurrentUser.EmailAddress;
                try
                {
                    _Util.Facade.UserLoginFacade.UpdateUserLogin(user);
                    base.AddUserActivityForCustomer("User Credential information is Updated", LabelHelper.ActivityAction.UpdateCredential, userlogin.UserId, null, null);

                    result = true;
                    message = "Credential Updated successfully.";
                    if (userlogin.SendMail == "true")
                    {
                        CredentialMail la = new CredentialMail
                        {
                            CustomerName = Cus.FirstName + " " + Cus.LastName,
                            ToEmail = userlogin.EmailAddress,
                            Message = "Your password updated successfully. Your new username and password are </br>",
                            UserName = userlogin.UserName,
                            Password = password

                        };
                        try
                        {
                            _Util.Facade.MailFacade.EmailUserCredential(la, CurrentUser.CompanyId.Value);
                            message += "Your username and password are sent to your mail.";
                        }
                        catch (Exception ex)
                        {
                            message += "Mail sending failed.";
                        }

                    }
                }
                catch (Exception ex)
                {
                    result = false;
                    message = "Credential Not Updated";

                }

            }
            else
            {
                try
                {
                    UserLogin userexist = _Util.Facade.UserLoginFacade.GetUserByUsername(userlogin.UserName);
                    if (userexist == null)
                    {
                        _Util.Facade.UserLoginFacade.InsertUserCredential(userlogin.UserName, userlogin.UserId, CurrentUser.CompanyId.Value, userlogin.EmailAddress, userlogin.Password);
                        base.AddUserActivityForCustomer("User Credential information is Added", LabelHelper.ActivityAction.AddCredential, userlogin.UserId, null, null);

                        result = true;
                        message = "Credential Saved successfully.";
                        if (userlogin.SendMail == "true")
                        {
                            CredentialMail la = new CredentialMail
                            {
                                CustomerName = Cus.FirstName + " " + Cus.LastName,
                                ToEmail = userlogin.EmailAddress,
                                Message = "Your username and password are ready to use. Your username and password are </br>",
                                UserName = userlogin.UserName,
                                Password = password

                            };
                            try
                            {
                                _Util.Facade.MailFacade.EmailUserCredential(la, CurrentUser.CompanyId.Value);
                                message += "Your username and password are sent to your mail.";
                            }
                            catch (Exception ex)
                            {
                                message += "Mail sending failed.";
                            }


                        }
                    }
                    else
                    {
                        message = "User name already exist. Try another one.";
                        result = false;
                    }

                }
                catch (Exception ex)
                {
                    result = true;
                    message = "User Not Saved.";
                }
            }
            return Json(new { result = result, message = message });

        }

        #region Update Test Account
        [Authorize]
        [HttpPost]
        public JsonResult UpdateTestAccountChecked(Guid CustomerId, bool IsTestAccount)
        {
            var CurrentUser = (HS.Web.UI.Helper.CustomPrincipal)User;
            bool result = false;
            string message = "";
            Customer cus = _Util.Facade.CustomerFacade.GetCustomerByCustomerId(CustomerId);
            CustomerExtended _cusExd = _Util.Facade.CustomerFacade.GetCustomerExtendedByCustomerId(CustomerId);
            if (cus != null)
            {
                if (cus.Type == "Commercial")
                {
                    message = cus.BusinessName;
                }
                else
                {
                    message = cus.FirstName + " " + cus.LastName;
                }
            }
            if (IsTestAccount == true)
            {
                message += " Checked as Test Account";
            }
            else
            {
                message += " Unchecked From Test Account";
            }
            if(_cusExd != null)
            {
                _cusExd.IsTestAccount = IsTestAccount;
                result = _Util.Facade.CustomerFacade.UpdateCustomerExtended(_cusExd);
            }
            #region Log
            base.AddUserActivityForCustomer(message, LabelHelper.ActivityAction.Update, CustomerId, null, null);
            #endregion
            return Json(new { result = result});
        }
        #endregion

        [Authorize]
        public ActionResult DeleteCustomerAdditionalInfo(int Id)
        {
            bool result = false;
            string message = "";
            if (Id > 0)
            {
                try
                {

                    _Util.Facade.AdditionalContactFacade.DeleteAdditionalContact(Id);
                    result = true;
                    message = "Deleted successfully.";


                }
                catch (Exception ex)
                {
                    result = false;
                    message = "Not deleted successfully.";
                }
                return Json(new { result = true, message = message });
            }
            else
            {
                return Json(new { result = true, message = "Internal Error." });
            }


        }

        [Authorize]
        public ActionResult CustomerAdditionalInfo(Guid customerId, int? Id)
        {
            ViewBag.Relationship = _Util.Facade.LookupFacade.GetLookupByKey("Relationship").Select(x =>
                           new SelectListItem()
                           {
                               Text = x.DisplayText.ToString(),
                               Value = x.DataValue.ToString()
                           }).ToList();
            ViewBag.CustomerId = customerId;
            ViewBag.PhoneType = _Util.Facade.LookupFacade.GetLookupByKey("PhoneType").Select(x =>
                         new SelectListItem()
                         {
                             Text = x.DisplayText.ToString(),
                             Value = x.DataValue.ToString()
                         }).ToList();
            ViewBag.CustomerId = customerId;
            ViewBag.Phone2Type = ViewBag.PhoneType;
            ViewBag.Phone3Type = ViewBag.PhoneType;
            CustomerAdditionalContact additionalContact = new CustomerAdditionalContact();
            if (Id.HasValue && Id > 0)
            {
                additionalContact = _Util.Facade.AdditionalContactFacade.GetById(Id.Value);

            }
            return View(additionalContact);
        }
        [Authorize]
        [HttpPost]
        public ActionResult SaveAdditionalContact(CustomerAdditionalContact Contact)
        {
            bool result = false;
            string message = "";
            var CurrentLoggedInUser = (HS.Web.UI.Helper.CustomPrincipal)User;
            try
            {
                if (Contact.IsEmergencyContact == true)
                {
                    EmergencyContact emergencyContact = new EmergencyContact();
                    if (Contact.Id > 0)
                    {
                        emergencyContact = _Util.Facade.EmergencyContactFacade.GetEmergencyContactByFirstNameAndEmail(Contact.FirstName, Contact.Email);
                        if (emergencyContact != null)
                        {
                            emergencyContact.CompanyId = CurrentLoggedInUser.CompanyId.Value;
                            emergencyContact.FirstName = Contact.FirstName;
                            emergencyContact.LastName = Contact.LastName;
                            emergencyContact.CustomerId = Contact.CustomerId;
                            emergencyContact.Email = Contact.Email;
                            emergencyContact.RelationShip = Contact.RelationShip;
                            emergencyContact.CrossSteet = Contact.CrossSteet;
                            emergencyContact.Phone = Contact.Phone;

                            _Util.Facade.EmergencyContactFacade.UpdateEmergencyContact(emergencyContact);
                            base.AddUserActivityForCustomer("Emergency Contact is Updated", LabelHelper.ActivityAction.AddAdditionalContact, Contact.CustomerId, null, null);

                            result = true;
                        }
                    }
                    else
                    {
                        emergencyContact.CompanyId = CurrentLoggedInUser.CompanyId.Value;
                        emergencyContact.FirstName = Contact.FirstName;
                        emergencyContact.LastName = Contact.LastName;
                        emergencyContact.CustomerId = Contact.CustomerId;
                        emergencyContact.Email = Contact.Email;
                        emergencyContact.RelationShip = Contact.RelationShip;
                        emergencyContact.CrossSteet = Contact.CrossSteet;
                        emergencyContact.Phone = Contact.Phone;

                        _Util.Facade.EmergencyContactFacade.InsertEmergencyContact(emergencyContact);
                        base.AddUserActivityForCustomer("Emergency Contact is added", LabelHelper.ActivityAction.AddAdditionalContact, Contact.CustomerId, null, null);
                    }
                    if (Contact.Id > 0)
                    {
                        Contact.Id = (int)_Util.Facade.AdditionalContactFacade.UpdateAdditionalContact(Contact);
                        base.AddUserActivityForCustomer("Additional Contact is Updated", LabelHelper.ActivityAction.UpdateAdditionalContact, Contact.CustomerId, null, null);
                    }
                    else
                    {
                        Contact.Id = (int)_Util.Facade.AdditionalContactFacade.InsertAdditionalContact(Contact);
                        base.AddUserActivityForCustomer("Additional Contact is Added", LabelHelper.ActivityAction.AddAdditionalContact, Contact.CustomerId, null, null);
                    }
                }
                else
                {
                    if (Contact.Id > 0)
                    {
                        Contact.Id = (int)_Util.Facade.AdditionalContactFacade.UpdateAdditionalContact(Contact);
                        base.AddUserActivityForCustomer("Additional Contact is Updated", LabelHelper.ActivityAction.UpdateAdditionalContact, Contact.CustomerId, null, null);
                    }
                    else
                    {
                        Contact.Id = (int)_Util.Facade.AdditionalContactFacade.InsertAdditionalContact(Contact);
                        base.AddUserActivityForCustomer("Additional Contact is Added", LabelHelper.ActivityAction.AddAdditionalContact, Contact.CustomerId, null, null);
                    }
                }
                result = true;
                message = "Additional contact saved successfully";

            }
            catch (Exception ex)
            {
                result = false;
            }
            // return RedirectToAction("Dashboard");
            return Json(new { result = result, message = message });
        }
        [Authorize]
        public ActionResult CustomerExistingItem(Guid customerId)
        {
            ViewBag.CustomerId = customerId;
            Customer customer = _Util.Facade.CustomerFacade.GetCustomerByCustomerId(customerId);
            ViewBag.Id = customer.Id;
            return View();
        }
        [Authorize]
        [HttpPost]
        public ActionResult SaveExistingItem(CustomerExistingItem item)
        {
            bool result = false;
            try
            {

                item.Id = (int)_Util.Facade.CustomerFacade.InsertCustomerExistingItem(item);

                result = true;
            }
            catch (Exception ex)
            {
                result = false;
            }
            // return RedirectToAction("Dashboard");
            return Json(new { result = result, message = "Saved Successfully." });
        }

        [Authorize]
        public PartialViewResult CustomerSystemInfoPartial(int? id, string CusID, string ComID)
        {
            string IsGrate = ConfigurationManager.AppSettings["IsGrateCrm"];
            if (IsGrate == "true")
            {
                return null;
            }
            CustomerSystemInfo model;
            var CurrentLoggedInUser = (HS.Web.UI.Helper.CustomPrincipal)User;
            if (!string.IsNullOrEmpty(CusID))
            {
                model = _Util.Facade.CustomerSystemInfoFacade.GetCustomerSystemInfoByCustomerIdAndCompanyId(new Guid(CusID), new Guid(ComID));
            }
            else
            {
                model = new CustomerSystemInfo();
            }
            List<SelectListItem> PanelList = new List<SelectListItem>();
            PanelList.Add(new SelectListItem()
            {
                Text = "Please Select",
                Value = "-1"
            });
            PanelList.AddRange(ViewBag.Panel = _Util.Facade.PanelTypeFacade.GetAllPanelTypeByCompanyId(CurrentLoggedInUser.CompanyId.Value).Select(x =>
                           new SelectListItem()
                           {
                               Text = x.Name.ToString(),
                               Value = x.Value.ToString()
                           }).ToList());
            ViewBag.Panel = PanelList.OrderBy(x => x.Text != "Please Select").ThenBy(x => x.Text).ToList();
            ViewBag.Install = _Util.Facade.LookupFacade.GetLookupByKey("LeadInstallType").Select(x =>
                           new SelectListItem()
                           {
                               Text = x.DisplayText.ToString(),
                               Value = x.DataValue.ToString()
                           }).ToList();
            ViewBag.Cellular = _Util.Facade.LookupFacade.GetLookupByKey("CellularBackup").Select(x =>
                           new SelectListItem()
                           {
                               Text = x.DisplayText.ToString(),
                               Value = x.DataValue.ToString()
                           }).ToList();
            return PartialView("CustomerSystemInfoPartial", model);
        }



        public ActionResult TakeCustomerToken()
        {
            return View();
        }





        public ActionResult ShowList(Guid CustomerId)
        {
            return View();
        }
        public ActionResult ShowCustomerDraftList(Guid CustomerId)
        {

            return View();
        }

        [HttpPost]
        [Authorize]
        public JsonResult VerifyEmail(Customer customer)
        {
            var CurrentUser = ((HS.Web.UI.Helper.CustomPrincipal)(User));
            bool result = false;
            string apiKey = "";
            if (!customer.EmailAddress.IsValidEmailAddress())
            {
                //[Shariful-24-9-19]
                return Json(new { result = false, message = "Email address not found." });
                //[~Shariful-24-9-19]
            }
            GlobalSetting GlobSet = _Util.Facade.GlobalSettingsFacade.GetGlobalsettingBySearchKeyAndCompanyId("KickBoxApiKey", CurrentUser.CompanyId.Value);
            if (GlobSet != null && !string.IsNullOrWhiteSpace(GlobSet.Value))
            {
                apiKey = GlobSet.Value;
            }
            else
            {
                return Json(new { result = false, message = "API key not found." });
            }

            Customer oldCustomer = _Util.Facade.CustomerFacade.GetCustomerByCustomerId(customer.CustomerId);
            if (oldCustomer != null)
            {
                if (oldCustomer.EmailAddress == customer.EmailAddress && oldCustomer.EmailVerified.HasValue && oldCustomer.EmailVerified.Value)
                {
                    return Json(new { result = true, message = "Email address already verified." });
                }
                else
                {
                    ExtendedKickBoxResponse response = HS.Kickbox.KickBoxApi.VerifyWithResponse(customer.EmailAddress, apiKey);
                    oldCustomer.EmailVerified = (response.Result == Result.Deliverable) || (response.Result == Result.Risky);
                    oldCustomer.EmailAddress = customer.EmailAddress;
                    _Util.Facade.CustomerFacade.UpdateCustomer(oldCustomer);
                    if (oldCustomer.EmailVerified.Value)
                    {
                        return Json(new { result = true, message = "Email verification successful." });
                    }
                    else
                    {
                        return Json(new { result = false, message = "Email verification failed." });
                    }
                }
            }
            else
            {
                string EmailAddress = customer.EmailAddress;

                ExtendedKickBoxResponse response = HS.Kickbox.KickBoxApi.VerifyWithResponse(EmailAddress, apiKey);
                customer.EmailVerified = response.Result == Result.Deliverable;
                if (customer.EmailVerified.Value)
                {
                    return Json(new { result = true, message = "Email verification successful." });
                }
                else
                {
                    return Json(new { result = false, message = "Email verification failed." });
                }

            }
        }

        [HttpPost]
        [Authorize]
        public JsonResult VerifyPhone(string PhoneNumber, Guid? CustomerId, string PhoneType, string FormatedPhoneNo)
        {
            var CurrentUser = ((HS.Web.UI.Helper.CustomPrincipal)(User));
            var SavePhoneNumber = PhoneNumber;
            if (PhoneNumber != null && PhoneNumber[0] != '+')
            {
                PhoneNumber = "+1" + PhoneNumber;
            }
            string SMSVerificationAccesskey = _Util.Facade.GlobalSettingsFacade.GetGlobalSettingsByKey(CurrentUser.CompanyId.Value, "SMSAccesskey").Value;
            string url = "http://apilayer.net/api/validate?access_key=" + SMSVerificationAccesskey + "&number=" + PhoneNumber;
            try
            {
                var response = GetResponse(url);
                NumberVerifyResponse verifyResponse = new NumberVerifyResponse();
                verifyResponse = Newtonsoft.Json.JsonConvert.DeserializeObject<NumberVerifyResponse>(response);
                if (CustomerId != new Guid() && CustomerId != null)
                {
                    Customer cus = _Util.Facade.CustomerFacade.GetCustomerByCustomerId(CustomerId.Value);

                    if (verifyResponse.valid == "true")
                    {

                        if (cus != null)
                        {
                            if (PhoneType == "PrimaryPhone")
                            {
                                cus.PrimaryPhone = SavePhoneNumber;
                                cus.IsPrimaryPhoneVerified = true;
                                _Util.Facade.CustomerFacade.UpdateCustomer(cus);
                            }
                            else if (PhoneType == "secondaryPhone")
                            {
                                cus.SecondaryPhone = SavePhoneNumber;
                                cus.IsSecondaryPhoneVerified = true;
                                _Util.Facade.CustomerFacade.UpdateCustomer(cus);
                            }
                            else if (PhoneType == "CellNo")
                            {
                                cus.CellNo = SavePhoneNumber;
                                cus.IsCellNoVerified = true;
                                _Util.Facade.CustomerFacade.UpdateCustomer(cus);
                            }


                        }

                    }
                    else
                    {
                        if (cus != null)
                        {
                            if (PhoneType == "PrimaryPhone")
                            {
                                cus.PrimaryPhone = SavePhoneNumber;
                                cus.IsPrimaryPhoneVerified = false;
                                _Util.Facade.CustomerFacade.UpdateCustomer(cus);
                            }
                            else if (PhoneType == "secondaryPhone")
                            {
                                cus.SecondaryPhone = SavePhoneNumber;
                                cus.IsSecondaryPhoneVerified = false;
                                _Util.Facade.CustomerFacade.UpdateCustomer(cus);
                            }
                            else if (PhoneType == "CellNo")
                            {
                                cus.CellNo = SavePhoneNumber;
                                cus.IsCellNoVerified = false;
                                _Util.Facade.CustomerFacade.UpdateCustomer(cus);
                            }

                        }
                    }

                }
                return Json(new { result = verifyResponse.valid, location = verifyResponse.location, line_type = verifyResponse.line_type, carrier = verifyResponse.carrier, country_code = verifyResponse.country_code });
            }
            catch (Exception ex)
            {
                return Json(new { result = "false" });
            }

        }

        public JsonResult VerifyHomeOwner(Guid? CustomerId, string FirstName, string LastName, string Street, string City, string State, string ZipCode)
        {
            var CurrentUser = ((HS.Web.UI.Helper.CustomPrincipal)(User));
            bool result = false;
            string OwnerName = "";
            string OwnerName1 = "";
            string OwnerName2 = "";
            string OwnerName3 = "";
            string SecondaryOwner = "";
            string CurrentDeedOwner = "";
            string LastDeedOwner1 = "";
            string LastDeedOwner2 = "";
            string LastDeedOwner3 = "";
            string LastDeedOwner4 = "";

            string response = "";
            Customer cus = new Customer();
            if (CustomerId.HasValue)
            {
                cus = _Util.Facade.CustomerFacade.GetCustomerByCustomerGuidId(CustomerId.Value);
            }

            if (Street != null && ZipCode != null && State != null && City != null)
            {
                string HomeOwnerVerificationkey = _Util.Facade.GlobalSettingsFacade.GetGlobalSettingsByKey(CurrentUser.CompanyId.Value, "HomeOwnerVerifyKey").Value;
                var lastline = City + "," + State + "," + ZipCode;
                var FullName = FirstName + " " + LastName;
                string url = "https://personator.melissadata.net/v3/WEB/ContactVerify/doContactVerify?&id=" + HomeOwnerVerificationkey + "&first=" + FirstName + "&last=" + LastName + "&full=" + FullName + "&city=" + City + "&state=" + State + "&a1=" + Street + "&postal=" + ZipCode + "&lastline=" + lastline + "&format=JSON";
                try
                {
                    response = GetResponse(url);
                    VerifiedHomeOwnerRoot verifiedHome = new VerifiedHomeOwnerRoot();
                    verifiedHome = Newtonsoft.Json.JsonConvert.DeserializeObject<VerifiedHomeOwnerRoot>(response);
                    if (verifiedHome != null)
                    {
                        if (verifiedHome.Records != null && verifiedHome.Records.Count > 0)
                        {
                            string AddressKey = verifiedHome.Records[0].AddressKey;
                            if (!string.IsNullOrEmpty(AddressKey))
                            {
                                string recordurl = "https://property.melissadata.net/v4/WEB/LookupProperty/?&id=" + HomeOwnerVerificationkey + "&addresskey=" + AddressKey + "&cols=GrpAll&format=JSON";
                                response = GetResponse(recordurl);
                                OwnerRoot owner = new OwnerRoot();
                                owner = Newtonsoft.Json.JsonConvert.DeserializeObject<OwnerRoot>(response);
                                if (owner != null)
                                {
                                    if (owner.Records != null && owner.Records.Count > 0)
                                    {
                                        if (!string.IsNullOrEmpty(owner.Records[0].PrimaryOwner.Name1Full))
                                        {
                                            OwnerName = owner.Records[0].PrimaryOwner.Name1Full;
                                            OwnerName1 = owner.Records[0].PrimaryOwner.Name1Full;
                                        }
                                        if (!string.IsNullOrEmpty(owner.Records[0].PrimaryOwner.Name2Full))
                                        {
                                            OwnerName += " & " + owner.Records[0].PrimaryOwner.Name2Full;
                                            OwnerName2 = owner.Records[0].PrimaryOwner.Name2Full;
                                        }
                                        if (!string.IsNullOrEmpty(owner.Records[0].SecondaryOwner.Name3Full))
                                        {
                                            OwnerName += " & " + owner.Records[0].SecondaryOwner.Name3Full;
                                            SecondaryOwner = owner.Records[0].SecondaryOwner.Name3Full;
                                        }
                                        if (!string.IsNullOrEmpty(owner.Records[0].CurrentDeed.LenderName))
                                        {

                                            CurrentDeedOwner = owner.Records[0].CurrentDeed.LenderName;
                                        }
                                        if (!string.IsNullOrEmpty(owner.Records[0].LastDeedOwnerInfo.Name1Full))
                                        {

                                            LastDeedOwner1 = owner.Records[0].LastDeedOwnerInfo.Name1Full;
                                        }
                                        if (!string.IsNullOrEmpty(owner.Records[0].LastDeedOwnerInfo.Name2Full))
                                        {

                                            LastDeedOwner2 = owner.Records[0].LastDeedOwnerInfo.Name2Full;
                                        }
                                        if (!string.IsNullOrEmpty(owner.Records[0].LastDeedOwnerInfo.Name3Full))
                                        {

                                            LastDeedOwner3 = owner.Records[0].LastDeedOwnerInfo.Name3Full;
                                        }
                                        if (!string.IsNullOrEmpty(owner.Records[0].LastDeedOwnerInfo.Name4Full))
                                        {

                                            LastDeedOwner4 = owner.Records[0].LastDeedOwnerInfo.Name4Full;
                                        }
                                        result = true;
                                    }
                                }

                                #region Full Home Owner List
                                if (CustomerId.HasValue)
                                {
                                    HomeOwnerHistory ownerhistory = new HomeOwnerHistory();
                                    List<HomeOwnerHistory> homeOwnerList = new List<HomeOwnerHistory>();
                                    homeOwnerList = _Util.Facade.CustomerFacade.GetHomeOwnerListBCustomerId(CustomerId.Value, CurrentUser.CompanyId.Value);
                                    foreach (var item in homeOwnerList)
                                    {
                                        _Util.Facade.CustomerFacade.DeleteHomeOwner(item.Id);
                                    }

                                    if (!string.IsNullOrEmpty(OwnerName1))
                                    {
                                        ownerhistory = new HomeOwnerHistory();
                                        ownerhistory.HomeOwnerName = OwnerName1;
                                        ownerhistory.OwnerAddress = Street + "," + City + "," + State + "," + ZipCode;
                                        ownerhistory.RequestedBy = CurrentUser.UserId;
                                        ownerhistory.RequestedDate = DateTime.Now.UTCCurrentTime();
                                        ownerhistory.CustomerId = CustomerId.Value;
                                        ownerhistory.CompanyId = CurrentUser.CompanyId.Value;
                                        _Util.Facade.CustomerFacade.InsertHomeOwnerHistory(ownerhistory);
                                    }

                                    if (!string.IsNullOrEmpty(OwnerName2))
                                    {
                                        ownerhistory = new HomeOwnerHistory();
                                        ownerhistory.HomeOwnerName = OwnerName2;
                                        ownerhistory.OwnerAddress = Street + "," + City + "," + State + "," + ZipCode;
                                        ownerhistory.RequestedBy = CurrentUser.UserId;
                                        ownerhistory.RequestedDate = DateTime.Now.UTCCurrentTime();
                                        ownerhistory.CustomerId = CustomerId.Value;
                                        ownerhistory.CompanyId = CurrentUser.CompanyId.Value;
                                        _Util.Facade.CustomerFacade.InsertHomeOwnerHistory(ownerhistory);
                                    }
                                    if (!string.IsNullOrEmpty(SecondaryOwner))
                                    {
                                        ownerhistory = new HomeOwnerHistory();
                                        ownerhistory.HomeOwnerName = SecondaryOwner;
                                        ownerhistory.OwnerAddress = Street + "," + City + "," + State + "," + ZipCode;
                                        ownerhistory.RequestedBy = CurrentUser.UserId;
                                        ownerhistory.RequestedDate = DateTime.Now.UTCCurrentTime();
                                        ownerhistory.CustomerId = CustomerId.Value;
                                        ownerhistory.CompanyId = CurrentUser.CompanyId.Value;
                                        _Util.Facade.CustomerFacade.InsertHomeOwnerHistory(ownerhistory);
                                    }
                                    if (!string.IsNullOrEmpty(CurrentDeedOwner))
                                    {
                                        ownerhistory = new HomeOwnerHistory();
                                        ownerhistory.HomeOwnerName = CurrentDeedOwner;
                                        ownerhistory.OwnerAddress = Street + "," + City + "," + State + "," + ZipCode;
                                        ownerhistory.RequestedBy = CurrentUser.UserId;
                                        ownerhistory.RequestedDate = DateTime.Now.UTCCurrentTime();
                                        ownerhistory.CustomerId = CustomerId.Value;
                                        ownerhistory.CompanyId = CurrentUser.CompanyId.Value;
                                        _Util.Facade.CustomerFacade.InsertHomeOwnerHistory(ownerhistory);
                                    }
                                    if (!string.IsNullOrEmpty(LastDeedOwner1))
                                    {
                                        ownerhistory = new HomeOwnerHistory();
                                        ownerhistory.HomeOwnerName = LastDeedOwner1;
                                        ownerhistory.OwnerAddress = Street + "," + City + "," + State + "," + ZipCode;
                                        ownerhistory.RequestedBy = CurrentUser.UserId;
                                        ownerhistory.RequestedDate = DateTime.Now.UTCCurrentTime();
                                        ownerhistory.CustomerId = CustomerId.Value;
                                        ownerhistory.CompanyId = CurrentUser.CompanyId.Value;
                                        _Util.Facade.CustomerFacade.InsertHomeOwnerHistory(ownerhistory);
                                    }
                                    if (!string.IsNullOrEmpty(LastDeedOwner2))
                                    {
                                        ownerhistory = new HomeOwnerHistory();
                                        ownerhistory.HomeOwnerName = LastDeedOwner2;
                                        ownerhistory.OwnerAddress = Street + "," + City + "," + State + "," + ZipCode;
                                        ownerhistory.RequestedBy = CurrentUser.UserId;
                                        ownerhistory.RequestedDate = DateTime.Now.UTCCurrentTime();
                                        ownerhistory.CustomerId = CustomerId.Value;
                                        ownerhistory.CompanyId = CurrentUser.CompanyId.Value;
                                        _Util.Facade.CustomerFacade.InsertHomeOwnerHistory(ownerhistory);
                                    }
                                    if (!string.IsNullOrEmpty(LastDeedOwner3))
                                    {
                                        ownerhistory = new HomeOwnerHistory();
                                        ownerhistory.HomeOwnerName = LastDeedOwner3;
                                        ownerhistory.OwnerAddress = Street + "," + City + "," + State + "," + ZipCode;
                                        ownerhistory.RequestedBy = CurrentUser.UserId;
                                        ownerhistory.RequestedDate = DateTime.Now.UTCCurrentTime();
                                        ownerhistory.CustomerId = CustomerId.Value;
                                        ownerhistory.CompanyId = CurrentUser.CompanyId.Value;
                                        _Util.Facade.CustomerFacade.InsertHomeOwnerHistory(ownerhistory);
                                    }
                                    if (!string.IsNullOrEmpty(LastDeedOwner4))
                                    {
                                        ownerhistory = new HomeOwnerHistory();
                                        ownerhistory.HomeOwnerName = LastDeedOwner4;
                                        ownerhistory.OwnerAddress = Street + "," + City + "," + State + "," + ZipCode;
                                        ownerhistory.RequestedBy = CurrentUser.UserId;
                                        ownerhistory.RequestedDate = DateTime.Now.UTCCurrentTime();
                                        ownerhistory.CustomerId = CustomerId.Value;
                                        ownerhistory.CompanyId = CurrentUser.CompanyId.Value;
                                        _Util.Facade.CustomerFacade.InsertHomeOwnerHistory(ownerhistory);
                                    }

                                    //try
                                    //{
                                    //    List<HomeOwnerHistory> historyList = new List<HomeOwnerHistory>();

                                    //    historyList = _Util.Facade.CustomerFacade.GetHomeOwnerListBCustomerId(cus.CustomerId, CurrentUser.CompanyId.Value);
                                    //    ViewAsPdf actionPDF = new Rotativa.ViewAsPdf("ShowHomeOwnerHistoryListAsPdf", historyList)
                                    //    {
                                    //        //FileName = "TestView.pdf",
                                    //        PageSize = Rotativa.Options.Size.A4,
                                    //        PageOrientation = Rotativa.Options.Orientation.Portrait,
                                    //        PageMargins = { Left = 1, Right = 1 },

                                    //    };
                                    //    var FileNo = 1;

                                    //    byte[] applicationPDFData = actionPDF.BuildPdf(ControllerContext);
                                    //    Random rand = new Random();
                                    //    string filename = ConfigurationManager.AppSettings["File.LeadToCustomerAgreement"];
                                    //    var comname = _Util.Facade.CompanyFacade.GetCompanyByComapnyId(CurrentUser.CompanyId.Value).CompanyName.ReplaceSpecialChar();
                                    //    var pdftempFolderName = string.Format(filename, comname)  + "HomeOwnerList.pdf";
                                    //    if (FileNo > 1)
                                    //    {
                                    //        pdftempFolderName = string.Format(filename, comname) + string.Format("HomeOwnerList_{0}.pdf", FileNo);
                                    //    }
                                    //    string Serverfilename = FileHelper.GetFileFullPath(pdftempFolderName);
                                    //    FileHelper.SaveFile(applicationPDFData, Serverfilename);

                                    //    string[] comNameSplit = comname.Split('/');


                                    //    var FileNameDes = "HomeOwner.pdf";


                                    //    CustomerFile cfs = new CustomerFile()
                                    //    {
                                    //        //FileId = 1,
                                    //        FileDescription = cus.Id + "_" + FileNameDes,
                                    //        Filename = "/" + pdftempFolderName,
                                    //        FileFullName = cus.Id + FileNameDes,
                                    //        Uploadeddate = DateTime.Now.UTCCurrentTime(),
                                    //        CustomerId = cus.CustomerId,
                                    //        CompanyId = CurrentUser.CompanyId.Value,
                                    //        IsActive = true,
                                    //        CreatedBy = cus.Soldby1,
                                    //        CreatedDate = DateTime.Now.UTCCurrentTime(),
                                    //        UpdatedBy = cus.Soldby1,
                                    //        UpdatedDate = DateTime.Now.UTCCurrentTime()
                                    //    };
                                    //    int CustomerFileId = (int)_Util.Facade.CustomerFileFacade.InsertCustomerFile(cfs);

                                    //}
                                    //catch(Exception ex)
                                    //{

                                    //}
                                }

                                #endregion


                            }
                        }
                    }

                }
                catch (Exception ex)
                {
                    result = false;
                }

            }


            return Json(new { result = result, OwnerName = OwnerName });
        }

        public ActionResult ShowHomeOwnerHistoryList(Guid CustomerId)
        {
            var CurrentUser = ((HS.Web.UI.Helper.CustomPrincipal)(User));
            List<HomeOwnerHistory> historyList = new List<HomeOwnerHistory>();

            historyList = _Util.Facade.CustomerFacade.GetHomeOwnerListBCustomerId(CustomerId, CurrentUser.CompanyId.Value);
            return View(historyList);
        }
        public ActionResult ShowHomeOwnerHistoryListAsPdf(Guid CustomerId)
        {
            var CurrentUser = ((HS.Web.UI.Helper.CustomPrincipal)(User));
            List<HomeOwnerHistory> historyList = new List<HomeOwnerHistory>();

            historyList = _Util.Facade.CustomerFacade.GetHomeOwnerListBCustomerId(CustomerId, CurrentUser.CompanyId.Value);
            return new ViewAsPdf(historyList)
            {
                // FileName = flightPlan.ListingItemDetailsModel.FlightDetails + ".pdf",
                PageSize = Rotativa.Options.Size.A4,
                PageOrientation = Orientation.Portrait,
                //PageMargins = new Margins(10, 0, 0, 0),
                PageMargins = new Margins(10, 2, 10, 3)
            };
        }
        internal static string GetResponse(String URL)
        {
            HttpResponseMessage response;
            ServicePointManager.SecurityProtocol = SecurityProtocolType.Tls12;
            using (var client = new HttpClient())
            {
                response = client.GetAsync(URL).Result;
            }
            string resultMessage = "";
            if (response != null && response.IsSuccessStatusCode)
            {
                resultMessage = response.Content.ReadAsStringAsync().Result;
            }
            return resultMessage;
        }
        public void CustomerContact(Customer customer)
        {

            Contact contact = new Contact();
            if (!string.IsNullOrWhiteSpace(customer.EmailAddress) || !string.IsNullOrWhiteSpace(customer.SecondaryPhone) || !string.IsNullOrWhiteSpace(customer.CellNo))
            {
                bool existEmail = _Util.Facade.ContactFacade.ExistEmailorCellNo(customer.EmailAddress, customer.PrimaryPhone, customer.SecondaryPhone);
                UserContact uc = _Util.Facade.ContactFacade.GetUserContactsByCustomerId(customer.CustomerId);
                Guid Soldby = Guid.Empty;
                Guid.TryParse(customer.Soldby, out Soldby);
                if (existEmail == false)
                {

                    contact.ContactOwner = Soldby;
                    contact.FirstName = customer.FirstName;
                    contact.LastName = customer.LastName;
                    contact.ContactId = Guid.NewGuid();
                    contact.CreatedBy = customer.CreatedByUid;
                    contact.CreatedDate = customer.CreatedDate;
                    contact.Mobile = customer.PrimaryPhone;
                    contact.Work = customer.SecondaryPhone;
                    contact.Email = customer.EmailAddress;
                    contact.Notes = customer.Note;

                    _Util.Facade.ContactFacade.InsertContacts(contact);
                    if (uc == null)
                    {
                        UserContact userContact = new UserContact();
                        userContact.UserType = LabelHelper.UserType.Customer;
                        userContact.UserId = customer.CustomerId;
                        userContact.ContactId = contact.ContactId;
                        _Util.Facade.ContactFacade.InsertUserContacts(userContact);
                    }
                }
            }

        }
        public JsonResult CreateLeadFromCustomer(Customer customer, bool equipment, bool service, bool billing, int OldCustomerId)
        {
            var CurrentUser = ((HS.Web.UI.Helper.CustomPrincipal)(User));
            var result = false;
            string message = "Internal Error.";
            if (CurrentUser == null)
            {
                return Json(result);
            }
            if (!CurrentUser.CompanyId.HasValue)
            {
                return Json(result);
            }
            #region Add New Lead
            #region New Lead Add
            customer.CustomerId = Guid.NewGuid();
            customer.Address = MakeAddress(customer.Street, customer.City, customer.State, customer.ZipCode, customer.Country);
            customer.JoinDate = DateTime.Now;
            customer.IsTechCallPassed = false;
            customer.LastUpdatedDate = DateTime.Now.UTCCurrentTime();
            customer.LastUpdatedBy = User.Identity.Name;
            customer.IsDirect = false;
            customer.IsActive = true;
            customer.CreatedDate = DateTime.Now;
            customer.CreatedByUid = CurrentUser.UserId;
            customer.LastUpdatedByUid = CurrentUser.UserId;
            customer.EmailVerified = false;
            customer.Id = (int)_Util.Facade.CustomerFacade.InsertCustomer(customer);

            result = customer.Id > 0;
            #endregion
            if (result != false)
            {
                CustomerCompany cc = new CustomerCompany()
                {
                    CompanyId = CurrentUser.CompanyId.Value,
                    CustomerId = customer.CustomerId,
                    IsLead = true,
                    IsActive = true
                };
                result = _Util.Facade.CustomerFacade.InsertCustomerCompany(cc) > 0;
                message = "Lead Created successfully.";
            }
            #endregion
            ViewBag.LeadId = customer.Id;
            #region New Customer Package, Equipment, Service and Billing
            if (result && equipment && service)
            {
                var objcustomer = _Util.Facade.CustomerFacade.GetCustomerByCustomerId(customer.MoveCustomerId);
                var objpackagecustomer = _Util.Facade.PackageFacade.GetPackageCustomerByCustomerId(customer.MoveCustomerId);
                var objpackageservice = _Util.Facade.PackageFacade.GetCustomerPackageServiceByCustomerId(customer.MoveCustomerId);
                var objpackageequipment = _Util.Facade.PackageFacade.GetCustomerPackageEqpByCustomerId(customer.MoveCustomerId);
                var objemergency = _Util.Facade.EmergencyContactFacade.GetAllEmergencyContactByCustomerId(customer.MoveCustomerId);
                var objnewcustomer = _Util.Facade.CustomerFacade.GetCustomerByCustomerId(customer.CustomerId);
                if (objpackagecustomer != null)
                {
                    PackageCustomer objpc = new PackageCustomer()
                    {
                        CompanyId = objpackagecustomer.CompanyId,
                        CustomerId = customer.CustomerId,
                        PackageId = objpackagecustomer.PackageId,
                        SmartSystemTypeId = objpackagecustomer.SmartSystemTypeId,
                        SmartInstallTypeId = objpackagecustomer.SmartInstallTypeId,
                        ManufacturerId = objpackagecustomer.ManufacturerId,
                        NonConformingFee = objpackagecustomer.NonConformingFee,
                        ActivationFee = objpackagecustomer.ActivationFee,
                        WarrentyAvailable = objpackagecustomer.WarrentyAvailable
                    };
                    _Util.Facade.PackageFacade.InsertPackageCustomer(objpc);
                }
                if (objpackageservice != null && objpackageservice.Count > 0)
                {
                    foreach (var item in objpackageservice)
                    {
                        CustomerPackageService objcps = new CustomerPackageService()
                        {
                            CompanyId = item.CompanyId,
                            CustomerId = customer.CustomerId,
                            PackageId = item.PackageId,
                            EquipmentId = item.EquipmentId,
                            MonthlyRate = item.MonthlyRate,
                            DiscountRate = item.DiscountRate,
                            Total = item.Total,
                            ManufacturerId = item.ManufacturerId,
                            LocationId = item.LocationId,
                            TypeId = item.TypeId,
                            ModelId = item.ModelId,
                            FinishId = item.FinishId,
                            CapacityId = item.CapacityId
                        };
                        _Util.Facade.PackageFacade.InsertCustomerPackageService(objcps);
                    }
                }
                if (objpackageequipment != null && objpackageequipment.Count > 0)
                {
                    foreach (var item in objpackageequipment)
                    {
                        CustomerPackageEqp objeqp = new CustomerPackageEqp()
                        {
                            CompanyId = item.CompanyId,
                            CustomerId = customer.CustomerId,
                            PackageId = item.PackageId,
                            EquipmentId = item.EquipmentId,
                            IsIncluded = item.IsIncluded,
                            IsDevice = item.IsDevice,
                            IsOptionalEqp = item.IsOptionalEqp,
                            Quantity = item.Quantity,
                            UnitPrice = item.UnitPrice,
                            DiscountUnitPricce = item.DiscountUnitPricce,
                            DiscountPckage = item.DiscountPckage,
                            Total = item.Total,
                            IsServiceEquipment = item.IsServiceEquipment,
                            ServiceId = item.ServiceId,
                            IsEqpExist = true
                        };
                        _Util.Facade.PackageFacade.InsertCustomerPackageEqp(objeqp);
                    }
                }
                if (objnewcustomer != null && objcustomer != null)
                {
                    objnewcustomer.Passcode = objcustomer.Passcode;
                    objnewcustomer.ContractTeam = objcustomer.ContractTeam;
                    objnewcustomer.SmartSetUpStep = 5;
                    _Util.Facade.CustomerFacade.UpdateCustomer(objnewcustomer);
                }
                if (objemergency != null && objemergency.Count > 0)
                {
                    foreach (var item in objemergency)
                    {
                        EmergencyContact EmergencyContact = new EmergencyContact()
                        {
                            CompanyId = item.CompanyId,
                            CustomerId = customer.CustomerId,
                            CrossSteet = item.CrossSteet,
                            FirstName = item.FirstName,
                            LastName = item.LastName,
                            RelationShip = item.RelationShip,
                            Email = item.Email,
                            Phone = item.Phone,
                            HasKey = item.HasKey,
                            PhoneType = item.PhoneType,
                            OrderBy = item.OrderBy
                        };
                        _Util.Facade.EmergencyContactFacade.InsertEmergencyContact(EmergencyContact);
                    }
                }
            }
            if (result && billing)
            {
                var objpayinfocustomer = _Util.Facade.PaymentInfoCustomerFacade.GetAllPaymentInfoCustomerByCustomerId(customer.MoveCustomerId);
                var objpayprofilecustomer = _Util.Facade.PaymentInfoCustomerFacade.GetAllPaymentProfileCustomerByCustomerId(customer.MoveCustomerId);
                if (objpayinfocustomer != null && objpayinfocustomer.Count > 0)
                {
                    foreach (var item in objpayinfocustomer)
                    {
                        PaymentInfoCustomer objinfocustomer = new PaymentInfoCustomer()
                        {
                            CompanyId = item.CompanyId,
                            CustomerId = customer.CustomerId,
                            PaymentInfoId = item.PaymentInfoId,
                            Type = item.Type,
                            Payfor = item.Payfor,
                            IsPaid = false,
                            PaymentDate = item.PaymentDate,
                            ForMonths = item.ForMonths,
                            InvoiceId = ""
                        };
                        _Util.Facade.PaymentInfoCustomerFacade.InsertPaymentInfoCustomer(objinfocustomer);
                    }
                }
                if (objpayprofilecustomer != null && objpayprofilecustomer.Count > 0)
                {
                    foreach (var item in objpayprofilecustomer)
                    {
                        PaymentProfileCustomer objprofile = new PaymentProfileCustomer()
                        {
                            CompanyId = item.CompanyId,
                            CustomerId = customer.CustomerId,
                            PaymentInfoId = item.PaymentInfoId,
                            Type = item.Type
                        };
                        _Util.Facade.PaymentInfoCustomerFacade.InsertPaymentProfileCustomer(objprofile);
                    }
                }
            }
            #endregion
            return Json(new { result = result, message = message, leadId = ViewBag.LeadId });
        }
        [Authorize]
        [HttpPost]
        public JsonResult AddCustomer(Customer customer, CustomerSystemInfo systemInfo, CustomerApiSetting apiAlarm, CustomerApiSetting apiMoni, CustomerApiSetting apiCentral, PaymentInfo PaymentInfo, string nexttab, bool? IsIeatery, bool? IsProrated)
        {
            int cusID = 0;
            var resultcus = false;
            var resultcusextended = false;
            if (!base.IsPermitted(UserPermissions.CustomerPermissions.CustomerInformationEdit))
            {
                return Json(new
                {
                    status = false,
                    message = "Access denied."
                });
            }


            if (PaymentInfo.AccountName == "ProfilePackage")
            {
                PaymentInfo = _Util.Facade.PaymentInfoFacade.GetPaymentInfoById(PaymentInfo.Id);
                if (PaymentInfo == null)
                {
                    PaymentInfo = new PaymentInfo();
                }
            }

            var flag1 = false;
            var flag2 = false;
            var currentLoggedIn = ((HS.Web.UI.Helper.CustomPrincipal)(User));
            customer.LastUpdatedDate = DateTime.Now.UTCCurrentTime();
            customer.LastUpdatedByUid = currentLoggedIn.UserId;
            customer.LastUpdatedBy = User.Identity.Name;
            bool result = true;
            string role = currentLoggedIn.UserRole;

            try
            {
                customer.Soldby1 = Guid.Parse(customer.Soldby);
            }
            catch (Exception e)
            {
                customer.Soldby1 = Guid.Empty;
            }

            //if (paymentGetway.Value == "Authorize.Net")
            if (!currentLoggedIn.CompanyId.HasValue)
            {
                return Json(false);
            }
            try
            {
                #region Edit Customer 
                if (customer.Id > 0)
                {
                    if (IsIeatery.HasValue && IsIeatery.Value == true)
                    {
                        Customer Emailcustomer = _Util.Facade.CustomerFacade.GetCustomerBySearch(customer.EmailAddress);
                        Customer Phonecustomer = _Util.Facade.CustomerFacade.GetCustomerBySearch(customer.CellNo);
                        if (Emailcustomer != null && Emailcustomer.Id != customer.Id)
                        {
                            return Json(new
                            {
                                status = false,
                                message = "Email address already exist"
                            });
                        }
                        if (Phonecustomer != null && Phonecustomer.Id != customer.Id)
                        {
                            return Json(new
                            {
                                status = false,
                                message = "Phone number already exist"
                            });
                        }
                    }
                    #region Customer Update
                    Customer Cusmodel = _Util.Facade.CustomerFacade.GetCustomersByIdAndSoldBy(customer.Id, currentLoggedIn.UserId, "", "");

                    Customer cust = _Util.Facade.CustomerFacade.GetById(customer.Id);
                    #region Sold By Change Commission Change
                    if (cust != null && cust.Soldby != customer.Soldby)
                    {
                        var CustomerAgreementTicket = _Util.Facade.TicketFacade.GetTicketByCustomerIdAndIsAgreementTicket(customer.CustomerId);
                        if (CustomerAgreementTicket != null)
                        {
                            bool update = _Util.Facade.CustomerAppoinmentFacade.UpdateSoldByCustomerAppointmentEqp(CustomerAgreementTicket.TicketId, customer.Soldby);
                        }
                    }
                    #endregion
                    if (cust.EmailAddress != customer.EmailAddress)
                    {
                        cust.EmailVerified = false;
                    }
                    if (cust.PrimaryPhone != customer.PrimaryPhone)
                    {
                        if (customer.IsPrimaryPhoneVerified == true)
                        {
                            cust.IsPrimaryPhoneVerified = true;
                        }
                        else
                        {
                            cust.IsPrimaryPhoneVerified = false;
                        }
                        if (customer.PrimaryPhone != null)
                        {
                            cust.PrimaryPhone = customer.PrimaryPhone.TrimPhoneNum();
                        }
                        else
                        {
                            cust.PrimaryPhone = customer.PrimaryPhone;
                        }
                    }
                    else
                    {
                        if (cust.IsPrimaryPhoneVerified != true)
                        {
                            cust.IsPrimaryPhoneVerified = customer.IsPrimaryPhoneVerified;
                        }
                        if (customer.PrimaryPhone != null)
                        {
                            cust.PrimaryPhone = customer.PrimaryPhone.TrimPhoneNum();
                        }
                    }

                    if (cust.SecondaryPhone != customer.SecondaryPhone)
                    {
                        if (customer.IsSecondaryPhoneVerified == true)
                        {
                            cust.IsSecondaryPhoneVerified = true;
                        }
                        else
                        {
                            cust.IsSecondaryPhoneVerified = false;
                        }
                        if (customer.SecondaryPhone != null)
                        {
                            cust.SecondaryPhone = customer.SecondaryPhone.TrimPhoneNum();
                        }
                        else
                        {
                            cust.SecondaryPhone = customer.SecondaryPhone;
                        }
                    }
                    else
                    {
                        if (cust.IsSecondaryPhoneVerified != true)
                        {
                            cust.IsSecondaryPhoneVerified = customer.IsSecondaryPhoneVerified;
                        }
                        if (customer.SecondaryPhone != null)
                        {
                            cust.SecondaryPhone = customer.SecondaryPhone.TrimPhoneNum();
                        }
                    }
                    if (cust.CellNo != customer.CellNo)
                    {
                        if (customer.IsCellNoVerified == true)
                        {
                            cust.IsCellNoVerified = true;
                        }
                        else
                        {
                            cust.IsCellNoVerified = false;
                        }
                        if (customer.CellNo != null)
                        {
                            cust.CellNo = customer.CellNo.TrimPhoneNum();
                        }
                        else
                        {
                            cust.CellNo = customer.CellNo;
                        }
                    }
                    else
                    {
                        if (cust.IsCellNoVerified != true)
                        {
                            cust.IsCellNoVerified = customer.IsCellNoVerified;
                        }
                        if (customer.CellNo != null)
                        {
                            cust.CellNo = customer.CellNo.TrimPhoneNum();
                        }
                    }
                    if (cust.AgreementPhoneNo != customer.AgreementPhoneNo)
                    {
                        if (customer.AgreementPhoneNo != null)
                        {
                            cust.AgreementPhoneNo = customer.AgreementPhoneNo.TrimPhoneNum();
                        }
                        else
                        {
                            cust.AgreementPhoneNo = customer.AgreementPhoneNo;
                        }
                    }
                    customer.CustomerId = cust.CustomerId;
                    if (!string.IsNullOrEmpty(customer.CSAgreement))
                    {

                        CustomerExtended extended = _Util.Facade.CustomerFacade.GetCustomerExtendedByCustomerId(cust.CustomerId);
                        if (extended != null)
                        {
                            extended.CSAgreement = customer.CSAgreement;
                            resultcusextended = _Util.Facade.CustomerFacade.UpdateCustomerExtended(extended);
                        }
                        else
                        {
                            extended = new CustomerExtended()
                            {
                                CustomerId = cust.CustomerId,
                                CSAgreement = customer.CSAgreement
                            };
                            _Util.Facade.CustomerFacade.InsertCustomerExtended(extended);
                        }

                    }

                    if (!string.IsNullOrWhiteSpace(customer.CustomerNo) && cust.CustomerNo != customer.CustomerNo)
                    {
                        Customer cusnoCheck = _Util.Facade.CustomerFacade.GetCustomerByCustomerNo(customer.CustomerNo);
                        if (cusnoCheck != null && cusnoCheck.CustomerId != cust.CustomerId)
                        {
                            return Json(new
                            {
                                status = false,
                                customerid = cust.Id,
                                message = "Customer No. already used by another customer."
                            });
                        }
                        else
                        {
                            CustomerSystemNo sysno = _Util.Facade.CustomerSystemNoFacade.GetCusSysNoByCustomerIdAndSysNo(cust.Id, cust.CustomerNo);
                            if (sysno != null)
                            {
                                sysno.IsReserved = false;
                                sysno.IsUsed = false;
                                _Util.Facade.CustomerSystemNoFacade.UpdateCustomerSystemNo(sysno);
                            }
                        }
                    }

                    if (customer.FirstBilling.HasValue)
                    {
                        customer.FirstBilling = customer.FirstBilling.Value.SetZeroHour();
                    }
                    if (!IsPermitted(UserPermissions.CustomerPermissions.CustomerPackageActivationFee))
                    {
                        customer.ActivationFee = cust.ActivationFee;
                    }
                    if (!string.IsNullOrWhiteSpace(customer.Latlng) && customer.Latlng != "undefined")
                    {
                        Customer Cus = _Util.Facade.CustomerFacade.GetCustomerByCustomerId(customer.CustomerId);
                        if (Cus != null)
                        {
                            Cus.Latlng = customer.Latlng;
                            _Util.Facade.CustomerFacade.UpdateCustomer(Cus);
                        }

                    }
                    customer.CustomerId = cust.CustomerId;
                    customer.JoinDate = cust.JoinDate;
                    customer.IsActive = cust.IsActive;
                    customer.SmartSetUpStep = cust.SmartSetUpStep;
                    customer.Address = MakeAddress(customer.Street, customer.City, customer.State, customer.ZipCode, customer.Country);
                    customer.Address2 = MakeAddress(customer.StreetPrevious, customer.CityPrevious, customer.StatePrevious, customer.ZipCodePrevious, customer.CountryPrevious);
                    customer.Address = !string.IsNullOrEmpty(customer.Address) ? customer.Address.Replace("'", "`") : "";
                    customer.Address2 = !string.IsNullOrEmpty(customer.Address2) ? customer.Address2.Replace("'", "`") : "";
                    customer.AuthorizeRefId = cust.AuthorizeRefId;
                    customer.AuthorizeCusPaymentProfileId = cust.AuthorizeCusPaymentProfileId;
                    customer.AuthorizeCusProfileId = cust.AuthorizeCusProfileId;
                    customer.AlarmRefId = cust.AlarmRefId;
                    customer.TransunionRefId = cust.TransunionRefId;
                    customer.MonitronicsRefId = cust.MonitronicsRefId;
                    customer.CmsRefId = cust.CmsRefId;
                    customer.ReminderDate = cust.ReminderDate;
                    customer.QA1 = cust.QA1;
                    customer.QA1Date = cust.QA1Date;
                    customer.QA2 = cust.QA2;
                    customer.QA2Date = cust.QA2Date;
                    customer.LastGeneratedInvoice = cust.LastGeneratedInvoice;
                    customer.Singature = cust.Singature;
                    customer.EmailVerified = cust.EmailVerified;
                    customer.ScheduleToken = cust.ScheduleToken;
                    customer.PaymentToken = cust.PaymentToken;
                    customer.CustomerToken = cust.CustomerToken;
                    customer.IsPrimaryPhoneVerified = cust.IsPrimaryPhoneVerified;
                    customer.IsSecondaryPhoneVerified = cust.IsSecondaryPhoneVerified;
                    customer.IsCellNoVerified = cust.IsCellNoVerified;
                    customer.CreatedByUid = cust.CreatedByUid;
                    customer.CreatedDate = cust.CreatedDate;
                    customer.UCCRefId = cust.UCCRefId;
                    customer.BrinksRefId = cust.BrinksRefId;
                    customer.IsContractSigned = cust.IsContractSigned;
                    customer.TransferCustomerId = cust.TransferCustomerId;
                    customer.IsAgreementSend = cust.IsAgreementSend;
                    customer.AgreementEmail = cust.AgreementEmail;
                    customer.AgreementPhoneNo = cust.AgreementPhoneNo;
                    customer.PrimaryPhone = cust.PrimaryPhone;
                    customer.CellNo = cust.CellNo;
                    customer.SecondaryPhone = cust.SecondaryPhone;
                    customer.CustomerFunded = cust.CustomerFunded;
                    customer.LastUpdatedByUid = currentLoggedIn.UserId;

                    if (string.IsNullOrEmpty(customer.LeadSourceType))
                    {
                        customer.LeadSourceType = cust.LeadSourceType;
                    }
                    if (customer.CustomerAccountTypeList != null && customer.CustomerAccountTypeList.Count > 0)
                    {
                        customer.CustomerAccountType = string.Join(", ", customer.CustomerAccountTypeList);
                    }

                    if(!string.IsNullOrEmpty(customer.Street))
                    {
                        customer.Street = customer.Street.Replace("'", "`");
                    }
                    #region edit customer number 

                    var OldCustomerNoObj = _Util.Facade.CustomerSystemNoFacade.GetCustomerSystemNoObjectByCustomerIdAndCompanyId(customer.Id, currentLoggedIn.CompanyId.Value);
                    if (OldCustomerNoObj != null)
                    {
                        if (OldCustomerNoObj.CustomerNo != customer.CustomerNo)
                        {
                            if (customer.CustomerNo == "")
                            {
                                OldCustomerNoObj.CustomerId = 0;
                                OldCustomerNoObj.IsReserved = false;
                                OldCustomerNoObj.IsUsed = false;
                                var oldObjRemovedResult = _Util.Facade.CustomerSystemNoFacade.UpdateCustomerSystemNo(OldCustomerNoObj);
                            }

                            else
                            {
                                var NewCustomerNumberObj = _Util.Facade.CustomerSystemNoFacade.GetCustomerSystemNoObjectByNumberAndCompanyId(customer.CustomerNo, currentLoggedIn.CompanyId.Value);
                                if (NewCustomerNumberObj != null)
                                {
                                    NewCustomerNumberObj.IsReserved = true;
                                    NewCustomerNumberObj.IsUsed = true;
                                    NewCustomerNumberObj.ReserveDate = DateTime.Now.UTCCurrentTime();
                                    NewCustomerNumberObj.UsedDate = DateTime.Now.UTCCurrentTime();
                                    NewCustomerNumberObj.CustomerId = customer.Id;
                                    var NewObjRemovedResult = _Util.Facade.CustomerSystemNoFacade.UpdateCustomerSystemNo(NewCustomerNumberObj);

                                    if (NewObjRemovedResult == true)
                                    {
                                        OldCustomerNoObj.CustomerId = 0;
                                        OldCustomerNoObj.IsReserved = false;
                                        OldCustomerNoObj.IsUsed = false;
                                        var oldObjRemovedResult = _Util.Facade.CustomerSystemNoFacade.UpdateCustomerSystemNo(OldCustomerNoObj);

                                        if (oldObjRemovedResult == true)
                                        {
                                            customer.CustomerNo = NewCustomerNumberObj.CustomerNo;
                                        }
                                        else
                                        {
                                            customer.CustomerNo = OldCustomerNoObj.CustomerNo;
                                        }
                                    }
                                }
                                else
                                {
                                    customer.CustomerNo = OldCustomerNoObj.CustomerNo;
                                }
                            }
                        }
                        else
                        {
                            customer.CustomerNo = OldCustomerNoObj.CustomerNo;
                        }
                    }
                    else
                    {
                        var assignNumber = _Util.Facade.CustomerSystemNoFacade.GetCustomerSystemNoObjectByNumberAndCompanyId(customer.CustomerNo, currentLoggedIn.CompanyId.Value);
                        if (assignNumber != null)
                        {
                            assignNumber.IsReserved = true;
                            assignNumber.IsUsed = true;
                            assignNumber.ReserveDate = DateTime.Now.UTCCurrentTime();
                            assignNumber.UsedDate = DateTime.Now.UTCCurrentTime();
                            assignNumber.CustomerId = customer.Id;
                            var NewObjRemovedResult = _Util.Facade.CustomerSystemNoFacade.UpdateCustomerSystemNo(assignNumber);
                        }
                        else
                        {
                            customer.CustomerNo = "";
                        }
                    }

                    #endregion

                    if (apiAlarm.Url != null && apiAlarm.UserName != null && apiAlarm.Password != null)
                    {
                        customer.IsAlarmCom = true;
                    }
                    else
                    {
                        customer.IsAlarmCom = false;
                    }
                    if (cust.IsDirect.HasValue && !cust.IsDirect.Value)
                    {
                        customer.IsDirect = false;
                    }
                    //if (cust.IsDirect.HasValue && cust.IsDirect.Value)
                    else
                    {
                        customer.IsDirect = true;
                    }
                    if (customer.SalesDate.HasValue)
                    {
                        customer.SalesDate = customer.SalesDate.Value;
                    }
                    //if (customer.InstallDate.HasValue)
                    //{
                    //    customer.InstallDate = customer.InstallDate.Value.ClientToUTCTime();
                    //}
                    if (customer.CutInDate.HasValue)
                    {
                        customer.CutInDate = customer.CutInDate.Value.ClientToUTCTime();
                    }
                    if (!string.IsNullOrWhiteSpace(customer.MonthlyMonitoringFee))
                    {
                        var doublVal = Convert.ToDouble(customer.MonthlyMonitoringFee);
                        string stringval = doublVal.ToString("0.##");
                        customer.MonthlyMonitoringFee = stringval;
                    }
                    CustomerMigration CM = _Util.Facade.CustomerFacade.GetCustomerMigrationByCustomerId(customer.CustomerId);
                    if (CM != null)
                    {
                        customer.AgemniId = CM.RefenrenceId;
                    }
                    resultcus = _Util.Facade.CustomerFacade.UpdateCustomer(customer);

                    #region Referring customer task create
                    if (customer.ReferringCustomer != null && customer.ReferringCustomer != Guid.Empty && customer.ReferringCustomer != cust.ReferringCustomer)
                    {
                        Customer refcus = _Util.Facade.CustomerFacade.GetCustomerByCustomerId(customer.ReferringCustomer);
                        GlobalSetting refGlb = _Util.Facade.GlobalSettingsFacade.GetGlobalSettingsByKey("AssignTaskTeamForReferringClient");
                        if (refcus != null)
                        {
                            CustomerNote CustomerNoteObj = new CustomerNote()
                            {
                                Notes = "Referring customer added (" + refcus.Id + ").",
                                ReminderDate = DateTime.UtcNow.AddDays(1),
                                ReminderEndDate = DateTime.UtcNow.AddDays(1).SetMaxHour(),
                                CompanyId = currentLoggedIn.CompanyId.Value,
                                CustomerId = customer.CustomerId,
                                CreatedDate = DateTime.Now.UTCCurrentTime(),
                                IsEmail = true,
                                IsText = false,
                                TeamSettingId = refGlb != null && !string.IsNullOrWhiteSpace(refGlb.Value) ? Convert.ToInt32(refGlb.Value) : 0,
                                IsShedule = true,
                                IsFollowUp = true,
                                CreatedBy = User.Identity.Name,
                                CreatedByUid = currentLoggedIn.UserId
                            };
                            _Util.Facade.NotesFacade.InsertCustomerNote(CustomerNoteObj);
                            if (CustomerNoteObj.TeamSettingId.HasValue && CustomerNoteObj.TeamSettingId > 0)
                            {
                                TeamSetting teamUsers = _Util.Facade.UserLoginFacade.GetTeamSettingById(CustomerNoteObj.TeamSettingId.Value);
                                var userarray = teamUsers.UserId.Split(',');
                                if (userarray != null && userarray.Count() > 0)
                                {
                                    foreach (var item in userarray)
                                    {
                                        NoteAssign objnoteassign = new NoteAssign()
                                        {
                                            NoteId = CustomerNoteObj.Id,
                                            EmployeeId = new Guid(item)
                                        };
                                        _Util.Facade.NoteAssignFacade.InsertNoteAssign(objnoteassign);
                                    }
                                }
                            }
                        }

                    }
                    #endregion
                    Logmessage(customer, Cusmodel);



                    #endregion

                    #region Add CustomerNote if Note not matches
                    if (/*!string.IsNullOrWhiteSpace(customer.Note) &&*/ !string.IsNullOrWhiteSpace(customer.Note) && customer.Note != cust.Note)
                    {
                        CustomerNote objnote = _Util.Facade.CustomerFacade.GetCustomerNoteByCustomerIdAndIsPrimary(customer.CustomerId);
                        if (objnote != null)
                        {
                            objnote.Notes = customer.Note;
                            objnote.CustomerId = customer.CustomerId;
                            objnote.CompanyId = currentLoggedIn.CompanyId.Value;
                            objnote.IsPrimaryNote = true;
                            //objnote.CreatedDate = DateTime.Now.UTCCurrentTime();
                            //objnote.CreatedBy = User.Identity.Name;
                            //objnote.CreatedByUid = currentLoggedIn.UserId;
                            _Util.Facade.NotesFacade.UpdateNotes(objnote);
                        }
                        else
                        {
                            objnote = new CustomerNote()
                            {
                                Notes = customer.Note,
                                CustomerId = customer.CustomerId,
                                CompanyId = currentLoggedIn.CompanyId.Value,
                                CreatedDate = DateTime.Now.UTCCurrentTime(),
                                CreatedBy = User.Identity.Name,
                                IsPrimaryNote = true,
                                CreatedByUid = currentLoggedIn.UserId
                            };
                            _Util.Facade.NotesFacade.InsertCustomerNote(objnote);
                        }

                    }
                    #endregion

                    if (systemInfo.Id > 0)
                    {
                        CustomerSystemInfo info = _Util.Facade.CustomerSystemInfoFacade.GetSystemInfoById(systemInfo.Id);
                        systemInfo.CompanyId = currentLoggedIn.CompanyId.Value;
                        systemInfo.CustomerId = info.CustomerId;
                        _Util.Facade.CustomerSystemInfoFacade.UpdateSystemInfo(systemInfo);
                    }
                    else
                    {
                        CustomerSystemInfo objsystemInfo = new CustomerSystemInfo()
                        {
                            CustomerId = customer.CustomerId,
                            CompanyId = currentLoggedIn.CompanyId.Value,
                            PanelType = systemInfo.PanelType,
                            InstallType = systemInfo.InstallType,
                            CellularBackup = systemInfo.CellularBackup,
                            Zone1 = systemInfo.Zone1,
                            Zone2 = systemInfo.Zone2,
                            Zone3 = systemInfo.Zone3,
                            Zone4 = systemInfo.Zone4,
                            Zone5 = systemInfo.Zone5,
                            Zone6 = systemInfo.Zone6,
                            Zone7 = systemInfo.Zone7,
                            Zone8 = systemInfo.Zone8,
                            Zone9 = systemInfo.Zone9
                        };
                        _Util.Facade.CustomerSystemInfoFacade.InsertSystemInfo(objsystemInfo);

                    }


                    #region CustomerApiSetting Not required anymore
                    /*
                    CustomerApiSetting alarmset = _Util.Facade.CustomerApiSettingFacade.GetCustomerApiSettingByCustomerIdAndAccountName(AccountName.AlarmDotCom, customer.CustomerId);

                    if (alarmset != null && alarmset.Id > 0)
                    {
                        apiAlarm.Id = alarmset.Id;
                        apiAlarm.CustomerId = alarmset.CustomerId;
                        apiAlarm.CompanyId = alarmset.CompanyId;
                        apiAlarm.AccountName = AccountName.AlarmDotCom;

                        _Util.Facade.CustomerApiSettingFacade.UpdateApi(apiAlarm);

                    }
                    else
                    {
                        apiAlarm.CustomerId = customer.CustomerId;
                        apiAlarm.CompanyId = currentLoggedIn.CompanyId.Value;
                        apiAlarm.AccountName = AccountName.AlarmDotCom;

                        _Util.Facade.CustomerApiSettingFacade.InsertApiSetting(apiAlarm);
                    }


                    CustomerApiSetting moniset = _Util.Facade.CustomerApiSettingFacade.GetCustomerApiSettingByCustomerIdAndAccountName(AccountName.Monitronics, customer.CustomerId);

                    if (moniset != null && moniset.Id > 0)
                    {
                        apiMoni.Id = moniset.Id;
                        apiMoni.CustomerId = moniset.CustomerId;
                        apiMoni.CompanyId = moniset.CompanyId;
                        apiMoni.AccountName = AccountName.Monitronics;
                        _Util.Facade.CustomerApiSettingFacade.UpdateApi(apiMoni);
                    }
                    else
                    {
                        apiMoni.CustomerId = customer.CustomerId;
                        apiMoni.CompanyId = currentLoggedIn.CompanyId.Value;
                        apiMoni.AccountName = AccountName.Monitronics;
                        _Util.Facade.CustomerApiSettingFacade.InsertApiSetting(apiMoni);
                    }


                    CustomerApiSetting centralset = _Util.Facade.CustomerApiSettingFacade.GetCustomerApiSettingByCustomerIdAndAccountName(AccountName.CentralStation, customer.CustomerId);

                    if (centralset != null && centralset.Id > 0)
                    {
                        apiCentral.Id = centralset.Id;
                        apiCentral.CustomerId = centralset.CustomerId;
                        apiCentral.CompanyId = centralset.CompanyId;
                        apiCentral.AccountName = AccountName.CentralStation;
                        _Util.Facade.CustomerApiSettingFacade.UpdateApi(apiCentral);
                    }
                    else
                    {
                        apiCentral.CustomerId = customer.CustomerId;
                        apiCentral.CompanyId = currentLoggedIn.CompanyId.Value;
                        apiCentral.AccountName = AccountName.CentralStation;
                        _Util.Facade.CustomerApiSettingFacade.InsertApiSetting(apiCentral);
                    }
                    */
                    #endregion

                    //previously arb subscription part was here
                    //checking if there is enough payment ifo for credit card or ach
                    bool PaymentInfoIsNull = true;
                    if (!string.IsNullOrWhiteSpace(PaymentInfo.BankAccountType) && !string.IsNullOrWhiteSpace(PaymentInfo.RoutingNo) && !string.IsNullOrWhiteSpace(PaymentInfo.AcountNo))
                    {
                        //ACH checking
                        PaymentInfoIsNull = false;
                    }
                    else if (!string.IsNullOrWhiteSpace(PaymentInfo.CardNumber) && !string.IsNullOrWhiteSpace(PaymentInfo.CardSecurityCode) && !string.IsNullOrWhiteSpace(PaymentInfo.CardExpireDate))
                    {
                        //CreditCard checking
                        PaymentInfoIsNull = false;
                    }
                    #region Customer Payment Info part
                    if (!PaymentInfoIsNull)
                    {
                        if (PaymentInfo.Id > 0)
                        {

                            //if payment info changes what will happen to arb?
                            List<PaymentInfo> AllCustomerPaymentInfo = _Util.Facade.PaymentInfoFacade.GetAllPaymentInfoByCustomerIdAndCompanyId(customer.CustomerId, currentLoggedIn.CompanyId.Value);
                            if (customer.PaymentMethod == LabelHelper.PaymentMethod.CreditCard && PaymentInfo.CardNumber.IndexOf("******") > -1 && PaymentInfo.Id > 0)
                            {

                                var CreditCardInfo = AllCustomerPaymentInfo.Where(x => x.CardSecurityCode != "" && x.CardNumber != "" && x.CardExpireDate != "").FirstOrDefault();
                                //PaymentInfo tmpPaymentInfo = _Util.Facade.PaymentInfoFacade.GetPaymentInfo_Card_ByCompanyIdAndCustomerId(CurrentUser.CompanyId.Value, customer.CustomerId);

                                PaymentInfo.CardNumber = CreditCardInfo.CardNumber;
                            }
                            if (customer.PaymentMethod == LabelHelper.PaymentMethod.ACH && PaymentInfo.AcountNo.IndexOf("******") > -1 && PaymentInfo.Id > 0)
                            {
                                var ACHInfo = AllCustomerPaymentInfo.Where(x => x.BankAccountType != "" && x.EcheckType != "" && x.RoutingNo != "" && x.AcountNo != "").FirstOrDefault();
                                //PaymentInfo tmpPaymentInfo = _Util.Facade.PaymentInfoFacade.GetPaymentInfo_Card_ByCompanyIdAndCustomerId(CurrentUser.CompanyId.Value, customer.CustomerId);
                                PaymentInfo.AcountNo = DESEncryptionDecryption.DecryptCipherTextToPlainText(ACHInfo.AcountNo);
                                flag1 = true;
                            }
                            if (customer.PaymentMethod == LabelHelper.PaymentMethod.ACH && PaymentInfo.RoutingNo.IndexOf("******") > -1 && PaymentInfo.Id > 0)
                            {
                                var ACHInfo = AllCustomerPaymentInfo.Where(x => x.BankAccountType != "" && x.EcheckType != "" && x.RoutingNo != "" && x.AcountNo != "").FirstOrDefault();
                                //PaymentInfo tmpPaymentInfo = _Util.Facade.PaymentInfoFacade.GetPaymentInfo_Card_ByCompanyIdAndCustomerId(CurrentUser.CompanyId.Value, customer.CustomerId);
                                PaymentInfo.RoutingNo = DESEncryptionDecryption.DecryptCipherTextToPlainText(ACHInfo.RoutingNo);
                                flag1 = true;
                            }

                            #region Update PaymentProfileCustomer
                            string MethodType = "";
                            if (customer.PaymentMethod == LabelHelper.PaymentMethod.ACH)
                            {
                                MethodType = "ACH_" + PaymentInfo.AccountName + "_" + PaymentInfo.AcountNo.Substring(Math.Max(0, PaymentInfo.AcountNo.Length - 2));
                            }
                            else if (customer.PaymentMethod == LabelHelper.PaymentMethod.CreditCard)
                            {
                                string cardno = DESEncryptionDecryption.DecryptCipherTextToPlainText(PaymentInfo.CardNumber);
                                MethodType = "CC" + "_" + PaymentInfo.AccountName + "_" + cardno.Substring(Math.Max(0, cardno.Length - 4));
                            }
                            else if (customer.PaymentMethod == LabelHelper.PaymentMethod.Invoice)
                            {
                                MethodType = "Invoice";
                            }
                            else if (customer.PaymentMethod == LabelHelper.PaymentMethod.Financed)
                            {
                                MethodType = "Financed";
                            }
                            if (!string.IsNullOrWhiteSpace(MethodType))
                            {
                                List<PaymentProfileCustomer> paymentProfileCustomers = _Util.Facade.PaymentInfoCustomerFacade.GetPaymentProfileListByPaymentInfoId(PaymentInfo.Id);
                                if (paymentProfileCustomers != null && paymentProfileCustomers.Count > 0)
                                {
                                    foreach (var item in paymentProfileCustomers)
                                    {
                                        item.Type = MethodType;

                                        _Util.Facade.PaymentInfoCustomerFacade.UpdatePaymentProfileCustomer(item);
                                    }
                                }
                                else
                                {
                                    PaymentProfileCustomer PPC = new PaymentProfileCustomer()
                                    {
                                        CompanyId = currentLoggedIn.CompanyId.Value,
                                        CustomerId = customer.CustomerId,
                                        PaymentInfoId = PaymentInfo.Id,
                                        Type = MethodType
                                    };
                                    _Util.Facade.PaymentInfoCustomerFacade.InsertPaymentProfileCustomer(PPC);
                                }

                            }


                            #endregion

                            PaymentInfo.CompanyId = currentLoggedIn.CompanyId.Value;
                            PaymentInfo.IsCash = false;
                            _Util.Facade.PaymentInfoFacade.UpdatePaymentInfo(PaymentInfo);

                            #region UpdatePaymentInfoCustomer
                            PaymentInfoCustomer PIC = _Util.Facade.PaymentInfoCustomerFacade.GetPaymentInfoCustomerByCustomerIdAndPayFor(customer.CustomerId, "MMR");
                            //_Util.Facade.PaymentInfoCustomerFacade.DeletePaymentInfoCustomerByPayForAndCustomerId("MMR",customer.CustomerId);
                            if (PIC == null)
                            {
                                PaymentInfoCustomer pic = new PaymentInfoCustomer()
                                {
                                    CompanyId = currentLoggedIn.CompanyId.Value,
                                    CustomerId = customer.CustomerId,
                                    PaymentInfoId = PaymentInfo.Id,
                                    Payfor = "MMR"
                                };
                                pic.Id = (int)_Util.Facade.PaymentInfoCustomerFacade.InsertPaymentInfoCustomer(pic);
                            }
                            else
                            {
                                PIC.PaymentInfoId = PaymentInfo.Id;
                                _Util.Facade.PaymentInfoCustomerFacade.UpdatePaymentInfoCustomer(PIC);
                            }

                            #endregion

                            if (!string.IsNullOrWhiteSpace(customer.AuthorizeRefId) || !string.IsNullOrWhiteSpace(customer.ScheduleToken))
                            {
                                if (flag1 == false || flag2 == false)
                                {
                                    customer.IsRequiredCsvSync = true;
                                }
                                _Util.Facade.CustomerFacade.UpdateCustomer(customer);
                            }

                        }
                        else
                        {
                            PaymentInfo.CompanyId = currentLoggedIn.CompanyId.Value;
                            PaymentInfo objInfoPay = new PaymentInfo()
                            {
                                CompanyId = PaymentInfo.CompanyId,
                                AccountName = PaymentInfo.AccountName,
                                BankAccountType = PaymentInfo.BankAccountType,
                                RoutingNo = PaymentInfo.RoutingNo,
                                AcountNo = PaymentInfo.AcountNo,
                                CardNumber = PaymentInfo.CardNumber,
                                CardExpireDate = PaymentInfo.CardExpireDate,
                                CardSecurityCode = PaymentInfo.CardSecurityCode,
                                EcheckType = PaymentInfo.EcheckType,
                                BankName = PaymentInfo.BankName
                            };
                            objInfoPay.Id = (int)_Util.Facade.PaymentInfoFacade.InsertPaymentInfo(objInfoPay);

                            #region Insert PaymentProfileCustomer
                            string MethodType = "";
                            if (customer.PaymentMethod == LabelHelper.PaymentMethod.ACH)
                            {
                                MethodType = "ACH_" + PaymentInfo.AccountName + "_" + PaymentInfo.AcountNo.Substring(Math.Max(0, PaymentInfo.AcountNo.Length - 2));
                            }
                            else if (customer.PaymentMethod == LabelHelper.PaymentMethod.CreditCard)
                            {
                                string cardno = DESEncryptionDecryption.DecryptCipherTextToPlainText(PaymentInfo.CardNumber);
                                MethodType = "CC" + "_" + PaymentInfo.AccountName + "_" + cardno.Substring(Math.Max(0, cardno.Length - 4));
                            }
                            else if (customer.PaymentMethod == LabelHelper.PaymentMethod.Invoice)
                            {
                                MethodType = "Invoice";
                            }
                            else if (customer.PaymentMethod == LabelHelper.PaymentMethod.Financed)
                            {
                                MethodType = "Financed";
                            }
                            if (!string.IsNullOrWhiteSpace(MethodType))
                            {
                                PaymentProfileCustomer PPC = new PaymentProfileCustomer()
                                {
                                    CompanyId = currentLoggedIn.CompanyId.Value,
                                    CustomerId = customer.CustomerId,
                                    PaymentInfoId = objInfoPay.Id,
                                    Type = MethodType
                                };
                                _Util.Facade.PaymentInfoCustomerFacade.InsertPaymentProfileCustomer(PPC);
                            }

                            #endregion

                            #region Insert PaymentInfoCustomer
                            PaymentInfoCustomer PIC = _Util.Facade.PaymentInfoCustomerFacade.GetPaymentInfoCustomerByCustomerIdAndPayFor(customer.CustomerId, "MMR");
                            //_Util.Facade.PaymentInfoCustomerFacade.DeletePaymentInfoCustomerByPayForAndCustomerId("MMR",customer.CustomerId);
                            if (PIC == null)
                            {
                                PaymentInfoCustomer pic = new PaymentInfoCustomer()
                                {
                                    CompanyId = currentLoggedIn.CompanyId.Value,
                                    CustomerId = customer.CustomerId,
                                    PaymentInfoId = objInfoPay.Id,
                                    Payfor = "MMR"
                                };
                                pic.Id = (int)_Util.Facade.PaymentInfoCustomerFacade.InsertPaymentInfoCustomer(pic);
                            }
                            else
                            {
                                PIC.PaymentInfoId = objInfoPay.Id;
                                _Util.Facade.PaymentInfoCustomerFacade.UpdatePaymentInfoCustomer(PIC);
                            }
                            #endregion
                        }
                    }
                    #endregion Customer Payment Info part
                    cusID = customer.Id;


                }
                #endregion

                #region Insert New Customer
                else
                {
                    if (IsIeatery.HasValue && IsIeatery.Value == true)
                    {
                        Customer Emailcustomer = _Util.Facade.CustomerFacade.GetCustomerBySearch(customer.EmailAddress);
                        Customer Phonecustomer = _Util.Facade.CustomerFacade.GetCustomerBySearch(customer.CellNo);
                        if (Emailcustomer != null)
                        {
                            return Json(new
                            {
                                status = false,
                                message = "Email address already exist"
                            });
                        }
                        if (Phonecustomer != null)
                        {
                            return Json(new
                            {
                                status = false,
                                message = "Phone number already exist"
                            });
                        }
                    }
                    if (!string.IsNullOrWhiteSpace(customer.CustomerNo))
                    {
                        Customer cusnoCheck = _Util.Facade.CustomerFacade.GetCustomerByCustomerNo(customer.CustomerNo);
                        if (cusnoCheck != null)
                        {
                            return Json(new
                            {
                                status = false,
                                message = "Customer No. already used by another customer."
                            });
                        }
                    }


                    if (customer.CustomerId == Guid.Empty)
                    {
                        customer.CustomerId = Guid.NewGuid();
                    }
                    customer.Address = MakeAddress(customer.Street, customer.City, customer.State, customer.ZipCode, "");
                    customer.Address2 = MakeAddress(customer.StreetPrevious, customer.CityPrevious, customer.StatePrevious, customer.ZipCodePrevious, "");
                    customer.Address = MakeAddress(customer.Street, customer.City, customer.State, customer.ZipCode, customer.Country);
                    customer.Address2 = MakeAddress(customer.StreetPrevious, customer.CityPrevious, customer.StatePrevious, customer.ZipCodePrevious, customer.CountryPrevious);

                    var customerIsAlarm = customer.IsAlarmCom;
                    customer.LastUpdatedDate = DateTime.Now.UTCCurrentTime();
                    customer.LastUpdatedBy = User.Identity.Name;
                    customer.CreatedByUid = currentLoggedIn.UserId;
                    customer.LastUpdatedByUid = currentLoggedIn.UserId;
                    customer.JoinDate = DateTime.Now.UTCCurrentTime();
                    customer.IsTechCallPassed = false;
                    customer.IsDirect = true;
                    customer.IsActive = true;
                    customer.CreatedDate = DateTime.Now.UTCCurrentTime();
                    if (!string.IsNullOrEmpty(customer.CSAgreement))
                    {
                        CustomerExtended extended = new CustomerExtended()
                        {
                            CustomerId = customer.CustomerId,
                            CSAgreement = customer.CSAgreement,
                        };
                        _Util.Facade.CustomerFacade.InsertCustomerExtended(extended);

                    }
                    List<Lookup> OwnerShipList = _Util.Facade.LookupFacade.GetLookupByKeyForArrivalOrDepartureTimeByMinAndMaxTimeRange("OwnerShip", null, null).ToList();
                    if (OwnerShipList != null && OwnerShipList.Count() > 0)
                    {
                        foreach (var item in OwnerShipList)
                        {

                            if (currentLoggedIn.CompanyName.ToLower().IndexOf(item.DisplayText.ToLower()) > -1)
                            {
                                customer.Ownership = item.DisplayText;
                                break;
                            }
                        }
                    }


                    //customer.EmailVerified = false;

                    if (customer.SalesDate.HasValue)
                    {
                        customer.SalesDate = customer.SalesDate.Value;
                    }
                    else
                    {
                        customer.SalesDate = DateTime.Now.UTCCurrentTime();
                    }
                    if (customer.InstallDate.HasValue)
                    {
                        customer.InstallDate = customer.InstallDate.Value.SetZeroHour();
                    }
                    if (customer.CutInDate.HasValue)
                    {
                        customer.CutInDate = customer.CutInDate.Value.SetZeroHour();
                    }
                    if (customer.CustomerFundedDate.HasValue)
                    {
                        customer.CustomerFundedDate = customer.CustomerFundedDate.Value.SetZeroHour();
                    }
                    if (customer.FirstBilling.HasValue)
                    {
                        customer.FirstBilling = customer.FirstBilling.Value.SetZeroHour();
                    }
                    if (apiAlarm.Url != null && apiAlarm.UserName != null && apiAlarm.Password != null)
                    {
                        customer.IsAlarmCom = true;
                    }
                    else
                    {
                        customer.IsAlarmCom = false;
                    }
                    if (!string.IsNullOrWhiteSpace(customer.MonthlyMonitoringFee))
                    {
                        var doublVal = Convert.ToDouble(customer.MonthlyMonitoringFee);
                        string stringval = doublVal.ToString("0.##");
                        customer.MonthlyMonitoringFee = stringval;
                    }
                    CustomerSystemInfo objsystemInfo = new CustomerSystemInfo()
                    {
                        CustomerId = customer.CustomerId,
                        CompanyId = currentLoggedIn.CompanyId.Value,
                        PanelType = systemInfo.PanelType,
                        InstallType = systemInfo.InstallType,
                        CellularBackup = systemInfo.CellularBackup,
                        Zone1 = systemInfo.Zone1,
                        Zone2 = systemInfo.Zone2,
                        Zone3 = systemInfo.Zone3,
                        Zone4 = systemInfo.Zone4,
                        Zone5 = systemInfo.Zone5,
                        Zone6 = systemInfo.Zone6,
                        Zone7 = systemInfo.Zone7,
                        Zone8 = systemInfo.Zone8,
                        Zone9 = systemInfo.Zone9
                    };
                    _Util.Facade.CustomerSystemInfoFacade.InsertSystemInfo(objsystemInfo);
                    //if (customer.SoldBy2 == null)
                    //{
                    //    customer.SoldBy2 = new Guid();
                    //}
                    //if (customer.SoldBy3 == null)
                    //{
                    //    customer.SoldBy3 = new Guid();
                    //}
                    if (customer.CustomerAccountTypeList != null && customer.CustomerAccountTypeList.Count > 0)
                    {
                        customer.CustomerAccountType = string.Join(", ", customer.CustomerAccountTypeList);
                    }

                    int CustomerIntID = _Util.Facade.CustomerFacade.InsertCustomerAndReturnId(customer);
                    string insertcusid = CustomerIntID.ToString();
                    #region Referring customer task create
                    if (customer.ReferringCustomer != null && customer.ReferringCustomer != Guid.Empty)
                    {
                        Customer refcus = _Util.Facade.CustomerFacade.GetCustomerByCustomerId(customer.ReferringCustomer);
                        GlobalSetting refGlb = _Util.Facade.GlobalSettingsFacade.GetGlobalSettingsByKey("AssignTaskTeamForReferringClient");
                        if (refcus != null)
                        {
                            CustomerNote CustomerNoteObj = new CustomerNote()
                            {
                                Notes = "Referring customer added (" + refcus.Id + ").",
                                ReminderDate = DateTime.UtcNow.AddDays(1),
                                ReminderEndDate = DateTime.UtcNow.AddDays(1).SetMaxHour(),
                                CompanyId = currentLoggedIn.CompanyId.Value,
                                CustomerId = customer.CustomerId,
                                CreatedDate = DateTime.Now.UTCCurrentTime(),
                                IsEmail = true,
                                IsText = false,
                                TeamSettingId = refGlb != null && !string.IsNullOrWhiteSpace(refGlb.Value) ? Convert.ToInt32(refGlb.Value) : 0,
                                IsShedule = true,
                                IsFollowUp = true,
                                CreatedBy = User.Identity.Name,
                                CreatedByUid = currentLoggedIn.UserId
                            };
                            _Util.Facade.NotesFacade.InsertCustomerNote(CustomerNoteObj);
                            if (CustomerNoteObj.TeamSettingId.HasValue && CustomerNoteObj.TeamSettingId > 0)
                            {
                                TeamSetting teamUsers = _Util.Facade.UserLoginFacade.GetTeamSettingById(CustomerNoteObj.TeamSettingId.Value);
                                if(teamUsers != null)
                                {
                                    var userarray = teamUsers.UserId.Split(',');
                                    if (userarray != null && userarray.Count() > 0)
                                    {
                                        foreach (var item in userarray)
                                        {
                                            NoteAssign objnoteassign = new NoteAssign()
                                            {
                                                NoteId = CustomerNoteObj.Id,
                                                EmployeeId = new Guid(item)
                                            };
                                            _Util.Facade.NoteAssignFacade.InsertNoteAssign(objnoteassign);
                                        }
                                    }
                                }
                            }
                        }

                    }
                    #endregion

                    base.AddUserActivityForCustomer("New Customer Created #Ref: Customer#" + insertcusid, LabelHelper.ActivityAction.AddCustomer, customer.CustomerId, customer.Id, insertcusid);
                    if (CustomerIntID > 0)
                    {
                        string empname = "";
                        var empobj = _Util.Facade.EmployeeFacade.GetEmployeeByEmployeeId(currentLoggedIn.UserId);
                        if (empobj != null)
                        {
                            empname = empobj.FirstName + " " + empobj.LastName;
                        }
                        CustomerSnapshot DbCustomerSnapshot = new CustomerSnapshot()
                        {
                            CompanyId = currentLoggedIn.CompanyId.Value,
                            CustomerId = customer.CustomerId,
                            Description = "<b>" + customer.FirstName + " " + customer.LastName + "</b>" + " " + "created by " + "<b>" + empname + "</b>" + " " + "on" + " " + "<b>" + DateTimeExtension.UTCToClientTime(customer.JoinDate.Value).ToString("MM/dd/yyyy") + "</b>",
                            Type = "CustomerCreatedHistory",
                            Updatedby = empname,
                            Logdate = DateTime.Now.UTCCurrentTime()
                        };

                        _Util.Facade.CustomerSnapshotFacade.InsertSnapshot(DbCustomerSnapshot);
                    }
                    if (customer.CustomerNo != null && customer.CustomerNo != "")
                    {
                        var LockAccountNo = _Util.Facade.CustomerSystemNoFacade.GetCustomerSystemNoObjectByNumberAndCompanyId(customer.CustomerNo, currentLoggedIn.CompanyId.Value);
                        if (LockAccountNo != null)
                        {
                            LockAccountNo.IsUsed = true;
                            LockAccountNo.IsReserved = true;
                            LockAccountNo.ReserveDate = DateTime.Now.UTCCurrentTime();
                            LockAccountNo.UsedDate = DateTime.Now.UTCCurrentTime();
                            LockAccountNo.CustomerId = CustomerIntID;
                            _Util.Facade.CustomerSystemNoFacade.UpdateCustomerSystemNo(LockAccountNo);
                        }
                    }
                    #region Add CustomerNote
                    if (!string.IsNullOrWhiteSpace(customer.Note))
                    {
                        CustomerNote objnote = new CustomerNote()
                        {
                            Notes = customer.Note,
                            CustomerId = customer.CustomerId,
                            CompanyId = currentLoggedIn.CompanyId.Value,
                            CreatedDate = DateTime.Now.UTCCurrentTime(),
                            CreatedBy = User.Identity.Name,
                            IsPrimaryNote = true,
                            CreatedByUid = currentLoggedIn.UserId
                        };
                        _Util.Facade.NotesFacade.InsertCustomerNote(objnote);
                    }
                    #endregion
                    //string CustomerStringID = CustomerIntID.ToString();

                    #region CustomerApiSetting Not Required Anymore
                    /*
                    CustomerApiSetting objApiAlarm = new CustomerApiSetting();
                    objApiAlarm.CompanyId = currentLoggedIn.CompanyId.Value;
                    objApiAlarm.CustomerId = customer.CustomerId;
                    objApiAlarm.AccountName = AccountName.AlarmDotCom;
                    objApiAlarm.Url = apiAlarm.Url;
                    objApiAlarm.UserName = apiAlarm.UserName;
                    objApiAlarm.Password = apiAlarm.Password;
                    _Util.Facade.CustomerApiSettingFacade.InsertApiSetting(objApiAlarm);
                    CustomerApiSetting objApiMonitronics = new CustomerApiSetting();
                    objApiMonitronics.CompanyId = currentLoggedIn.CompanyId.Value;
                    objApiMonitronics.CustomerId = customer.CustomerId;
                    objApiMonitronics.AccountName = AccountName.Monitronics;
                    objApiMonitronics.Url = apiMoni.Url;
                    objApiMonitronics.UserName = apiMoni.UserName;
                    objApiMonitronics.Password = apiMoni.Password;
                    _Util.Facade.CustomerApiSettingFacade.InsertApiSetting(objApiMonitronics);
                    CustomerApiSetting objApiCentral = new CustomerApiSetting();
                    objApiCentral.CompanyId = currentLoggedIn.CompanyId.Value;
                    objApiCentral.CustomerId = customer.CustomerId;
                    objApiCentral.AccountName = AccountName.CentralStation;
                    objApiCentral.Url = apiCentral.Url;
                    objApiCentral.UserName = apiCentral.UserName;
                    objApiCentral.Password = apiCentral.Password;
                    _Util.Facade.CustomerApiSettingFacade.InsertApiSetting(objApiCentral);
                    customer.Id = CustomerIntID;
                    */
                    #endregion

                    #region Contacts
                    var PopulateContact = _Util.Facade.GlobalSettingsFacade.GetGlobalSettingsByKey(currentLoggedIn.CompanyId.Value, "AutomaticPopulateContactData");
                    if (PopulateContact != null && PopulateContact.Value.ToLower() == "true")
                    {
                        CustomerContact(customer);
                    }

                    #endregion
                }
                #endregion -------------------------------------------------------------

                #region Add/Edit Ticket
                Ticket ticket = new Ticket();
                Guid[] UserList = null;
                ticket.CompletionDate = customer.CompletionDate;
                ticket.CustomerId = customer.CustomerId;
                ticket.TicketType = _Util.Facade.GlobalSettingsFacade.GetAllGlobalSettingsByCompanyId(currentLoggedIn.CompanyId.Value).Where(x => x.SearchKey == "DefaultTicketType").FirstOrDefault().Value;
                if (customer.AssignedTo != null)
                {
                    var sucResult = AddTicket(ticket, customer.AssignedTo);
                }

                #endregion

                #region Customer Extended
                if (customer.CustomerExtended == null)
                {
                    customer.CustomerExtended = new CustomerExtended();
                }
                #region Contract Start Date And Remaining Timing
                double RemainingMOnth = 0;
                if (customer.CustomerExtended != null
                    && customer.CustomerExtended.ContractStartDate != null
                    && customer.CustomerExtended.ContractStartDate != new DateTime()
                    && !string.IsNullOrWhiteSpace(customer.ContractTeam))
                {
                    double ContractTerm = 0;
                    if (double.TryParse(customer.ContractTeam, out ContractTerm) && ContractTerm > 0)
                    {
                        ContractTerm *= 12;

                        if (DateTime.Today <= customer.CustomerExtended.ContractStartDate)
                        {
                            RemainingMOnth = (ContractTerm / 12);
                        }
                        else
                        {
                            double Smonth = customer.CustomerExtended.ContractStartDate.Value.Month;
                            double Syear = customer.CustomerExtended.ContractStartDate.Value.Year;
                            double STotalMonth = Smonth + (Syear * 12);


                            double Tmonth = DateTime.Today.Month;
                            double Tyear = DateTime.Today.Year;
                            double TTotalMonth = Tmonth + (Tyear * 12);

                            double TotalMOnth = TTotalMonth - STotalMonth;
                            RemainingMOnth = (ContractTerm - TotalMOnth) / 12;

                        }
                    }


                }
                #endregion
                CustomerExtended _extended = _Util.Facade.CustomerFacade.GetCustomerExtendedByCustomerId(customer.CustomerId);
                string previousBatchNumber = "";
                if (_extended != null)
                {
                    previousBatchNumber = _extended.Batch;
                    _extended.RemainingContractTerm = RemainingMOnth.ToString();
                    _extended.ContractStartDate = customer.CustomerExtended.ContractStartDate;
                    _extended.SalesPerson4 = customer.CustomerExtended.SalesPerson4;
                    _extended.FinanceCompany = customer.CustomerExtended.FinanceCompany;
                    _extended.IsFinanced = customer.CustomerExtended.IsFinanced;
                    _extended.Pets = customer.CustomerExtended.Pets;
                    _extended.PetsType = customer.CustomerExtended.PetsType;
                    _extended.Repair = customer.CustomerExtended.Repair;
                    _extended.RepairType = customer.CustomerExtended.RepairType;
                    _extended.DrivingLicense = customer.CustomerExtended.DrivingLicense;
                    _extended.BirthDateCoupon = customer.CustomerExtended.BirthDateCoupon;
                    _extended.VipClubMember = customer.CustomerExtended.VipClubMember;
                    _extended.RWST1 = customer.CustomerExtended.RWST1;
                    _extended.RWST2 = customer.CustomerExtended.RWST2;
                    _extended.RWST3 = customer.CustomerExtended.RWST3;
                    _extended.RWST4 = customer.CustomerExtended.RWST4;
                    _extended.RWST5 = customer.CustomerExtended.RWST5;
                    _extended.RWST6 = customer.CustomerExtended.RWST6;
                    _extended.RWST7 = customer.CustomerExtended.RWST7;
                    _extended.RWST8 = customer.CustomerExtended.RWST8;
                    _extended.RWST9 = customer.CustomerExtended.RWST9;
                    _extended.RWST10 = customer.CustomerExtended.RWST10;
                    _extended.RWST11 = customer.CustomerExtended.RWST11;
                    _extended.RWST12 = customer.CustomerExtended.RWST12;
                    _extended.RWST13 = customer.CustomerExtended.RWST13;
                    _extended.RWST14 = customer.CustomerExtended.RWST14;
                    _extended.RWST15 = customer.CustomerExtended.RWST15;
                    _extended.CSAgreement = customer.CustomerExtended.CSAgreement;
                    _extended.RepsAssignedDate = customer.CustomerExtended.RepsAssignedDate;
                    _extended.MonthlyFinanceRate = customer.CustomerExtended.MonthlyFinanceRate;
                    _extended.GrossFundedAmount = customer.CustomerExtended.GrossFundedAmount;
                    _extended.NetFundedAmount = customer.CustomerExtended.NetFundedAmount;
                    _extended.DiscountFundedAmount = customer.CustomerExtended.DiscountFundedAmount;
                    _extended.DiscountFundedPercentage = customer.CustomerExtended.DiscountFundedPercentage;
                    _extended.CustomerPaymentAmount = customer.CustomerExtended.CustomerPaymentAmount;
                    _extended.FinanceRepCommissionRate = customer.CustomerExtended.FinanceRepCommissionRate;
                    _extended.LoanNumber = customer.CustomerExtended.LoanNumber;
                    _extended.CreditAppNumber = customer.CustomerExtended.CreditAppNumber;
                    _extended.Term = customer.CustomerExtended.Term;
                    _extended.APR = customer.CustomerExtended.APR;
                    _extended.MaxCreditLimit = customer.CustomerExtended.MaxCreditLimit;
                    _extended.ApprovalDate = customer.CustomerExtended.ApprovalDate;
                    _extended.Batch = customer.CustomerExtended.Batch;
                    _extended.MonthlyBatch = customer.CustomerExtended.MonthlyBatch;
                    _extended.FinanceRep = customer.CustomerExtended.FinanceRep;
                    _extended.AppoinmentSetBy = customer.CustomerExtended.AppoinmentSetBy;
                    _extended.BrinksFundingStatus = customer.CustomerExtended.BrinksFundingStatus;
                    _extended.FinanceFundingStatus = customer.CustomerExtended.FinanceFundingStatus;
                    _extended.GeeseCount = customer.CustomerExtended.GeeseCount;
                    _extended.ResignedBy = customer.CustomerExtended.ResignedBy;
                    _extended.DealerFee = customer.CustomerExtended.DealerFee;
                    _extended.CycleStartDate = customer.CustomerExtended.CycleStartDate;
                    _Util.Facade.CustomerFacade.UpdateCustomerExtended(_extended);

                }
                else
                {
                    previousBatchNumber = "newbatch";
                    _extended = new CustomerExtended()
                    {
                        CustomerId = customer.CustomerId,
                        ContractStartDate = customer.CustomerExtended.ContractStartDate,
                        SalesPerson4 = customer.CustomerExtended.SalesPerson4,
                        FinanceCompany = customer.CustomerExtended.FinanceCompany,
                        RemainingContractTerm = RemainingMOnth.ToString(),
                        IsFinanced = customer.CustomerExtended.IsFinanced,
                        Pets = customer.CustomerExtended.Pets,
                        PetsType = customer.CustomerExtended.PetsType,
                        Repair = customer.CustomerExtended.Repair,
                        RepairType = customer.CustomerExtended.RepairType,
                        BirthDateCoupon = customer.CustomerExtended.BirthDateCoupon,
                        VipClubMember = customer.CustomerExtended.VipClubMember,
                        RWST1 = customer.CustomerExtended.RWST1,
                        RWST2 = customer.CustomerExtended.RWST2,
                        RWST3 = customer.CustomerExtended.RWST3,
                        RWST4 = customer.CustomerExtended.RWST4,
                        RWST5 = customer.CustomerExtended.RWST5,
                        RWST6 = customer.CustomerExtended.RWST6,
                        RWST7 = customer.CustomerExtended.RWST7,
                        RWST8 = customer.CustomerExtended.RWST8,
                        RWST9 = customer.CustomerExtended.RWST9,
                        RWST10 = customer.CustomerExtended.RWST10,
                        RWST11 = customer.CustomerExtended.RWST11,
                        RWST12 = customer.CustomerExtended.RWST12,
                        RWST13 = customer.CustomerExtended.RWST13,
                        RWST14 = customer.CustomerExtended.RWST14,
                        RWST15 = customer.CustomerExtended.RWST15,
                        CSAgreement = customer.CustomerExtended.CSAgreement,
                        RepsAssignedDate = customer.CustomerExtended.RepsAssignedDate,
                        MonthlyFinanceRate = customer.CustomerExtended.MonthlyFinanceRate,
                        GrossFundedAmount = customer.CustomerExtended.GrossFundedAmount,
                        NetFundedAmount = customer.CustomerExtended.NetFundedAmount,
                        DiscountFundedAmount = customer.CustomerExtended.DiscountFundedAmount,
                        DiscountFundedPercentage = customer.CustomerExtended.DiscountFundedPercentage,
                        CustomerPaymentAmount = customer.CustomerExtended.CustomerPaymentAmount,
                        FinanceRepCommissionRate = customer.CustomerExtended.FinanceRepCommissionRate,
                        LoanNumber = customer.CustomerExtended.LoanNumber,
                        CreditAppNumber = customer.CustomerExtended.CreditAppNumber,
                        Term = customer.CustomerExtended.Term,
                        APR = customer.CustomerExtended.APR,
                        MaxCreditLimit = customer.CustomerExtended.MaxCreditLimit,
                        ApprovalDate = customer.CustomerExtended.ApprovalDate,
                        Batch = customer.CustomerExtended.Batch,
                        DrivingLicense = customer.CustomerExtended.DrivingLicense,
                        MonthlyBatch = customer.CustomerExtended.MonthlyBatch,
                        FinanceRep = customer.CustomerExtended.FinanceRep,
                        AppoinmentSetBy = customer.CustomerExtended.AppoinmentSetBy,
                        GeeseCount = customer.CustomerExtended.GeeseCount,
                        CreatedDay = DateTime.Today,
                        ResignedBy = customer.CustomerExtended.ResignedBy,
                        IsTestAccount = false,
                        CycleStartDate= customer.CustomerExtended.CycleStartDate,
                        DealerFee = customer.CustomerExtended.DealerFee

                    };
                    _Util.Facade.CustomerFacade.InsertCustomerExtended(_extended);
                }

                #region Update Batch related object
                if (previousBatchNumber != _extended.Batch)
                {
                    _Util.Facade.CustomerFacade.UpdateBatchNumber(customer.CustomerId, _extended.Batch);
                }
                #endregion

                #endregion

                #region PackageCustomer
                if (IsPermitted(UserPermissions.CustomerPermissions.CustomerPackageActivationFee) && customer.ActivationFee != null)
                {
                    PackageCustomer _pc = _Util.Facade.PackageFacade.GetPackageCustomerByCustomerId(customer.CustomerId);
                    if (_pc != null)
                    {
                        _pc.ActivationFee = customer.ActivationFee;
                        _Util.Facade.PackageFacade.UpdatePackageCustomer(_pc);

                    }
                    else
                    {
                        _pc = new PackageCustomer()
                        {
                            CustomerId = customer.CustomerId,
                            CompanyId = currentLoggedIn.CompanyId.Value,
                            PackageId = Guid.Empty,
                            SmartSystemTypeId = 0,
                            SmartInstallTypeId = 0,
                            ManufacturerId = Guid.Empty,
                            NonConformingFee = 0,
                            ActivationFee = customer.ActivationFee
                        };
                        _Util.Facade.PackageFacade.InsertPackageCustomer(_pc);
                    }
                }
                #endregion

                #region Customer Route
                if (customer.RouteId != new Guid())
                {
                    CustomerRoute CRoute = _Util.Facade.CustomerFacade.GetCustomerRouteByCustomerId(customer.CustomerId);
                    if (CRoute != null)
                    {
                        if (CRoute.RouteId != customer.RouteId)
                        {
                            _Util.Facade.CustomerFacade.DeleteCutomerRouteById(CRoute.Id);

                            GeeseRoute GR = _Util.Facade.CustomerFacade.GetGeeseRouteByRouteId(customer.RouteId);
                            if (GR != null)
                            {
                                CustomerRoute CR = new CustomerRoute()
                                {
                                    CustomerId = customer.CustomerId,
                                    RouteId = customer.RouteId,
                                    Name = GR.Name,
                                    CreatedBy = currentLoggedIn.UserId,
                                    CreatedDate = DateTime.Now.UTCCurrentTime(),
                                    UserId = currentLoggedIn.UserId
                                };
                                _Util.Facade.CustomerFacade.InsertCustomerRoute(CR);
                            }
                        }

                    }
                    else
                    {
                        GeeseRoute GR = _Util.Facade.CustomerFacade.GetGeeseRouteByRouteId(customer.RouteId);
                        if (GR != null)
                        {
                            CustomerRoute CR = new CustomerRoute()
                            {
                                CustomerId = customer.CustomerId,
                                RouteId = customer.RouteId,
                                Name = GR.Name,
                                CreatedBy = currentLoggedIn.UserId,
                                CreatedDate = DateTime.Now.UTCCurrentTime(),
                                UserId = currentLoggedIn.UserId
                            };
                            _Util.Facade.CustomerFacade.InsertCustomerRoute(CR);
                        }
                    }
                }
                #endregion

                if (IsIeatery.HasValue && IsIeatery.Value == true && cusID == 0)
                {
                    UserLogin _userlogin = new UserLogin()
                    {
                        UserId = Guid.NewGuid(),
                        UserName = customer.EmailAddress,
                        Password = HS.Framework.MD5Encryption.GetMD5HashData(customer.Password),
                        EmailAddress = customer.EmailAddress,
                        IsActive = true,
                        IsDeleted = false,
                        LastUpdatedBy = "System Admin",
                        LastUpdatedDate = DateTime.UtcNow,
                        CompanyId = currentLoggedIn.CompanyId.Value
                    };
                    _Util.Facade.UserLoginFacade.InsertUserLogin(_userlogin);
                    CustomerCompany cc = new CustomerCompany()
                    {
                        CompanyId = currentLoggedIn.CompanyId.Value,
                        CustomerId = customer.CustomerId,
                        IsLead = false,
                        ConvertionDate = DateTime.Now.UTCCurrentTime(),
                        IsActive = true
                    };
                    _Util.Facade.CustomerFacade.InsertCustomerCompany(cc);
                }
                else if (cusID == 0)
                {
                    CustomerCompany cc = new CustomerCompany()
                    {
                        CompanyId = currentLoggedIn.CompanyId.Value,
                        CustomerId = customer.CustomerId,
                        IsLead = false,
                        ConvertionDate = DateTime.Now.UTCCurrentTime(),
                        IsActive = true
                    };
                    _Util.Facade.CustomerFacade.InsertCustomerCompany(cc);
                }

                //if(customer.FinanceCompany != null)
                //{
                //    CustomerExtended _extendedCus = _Util.Facade.CustomerFacade.GetCustomerExtendedByCustomerId(customer.CustomerId);

                //    if(_extendedCus != null)
                //    {
                //        _extendedCus.FinanceCompany = customer.FinanceCompany;
                //        _Util.Facade.CustomerFacade.UpdateCustomerExtended(_extendedCus);
                //    }
                //    else
                //    {
                //        _extendedCus = new CustomerExtended()
                //        {
                //            CustomerId = customer.CustomerId,
                //            FinanceCompany = customer.FinanceCompany
                //        };
                //        _Util.Facade.CustomerFacade.InsertCustomerExtended(_extendedCus);
                //    }

                //}
                //if (customer.SalesPerson4 != null)
                //{
                //    CustomerExtended _extendedCus = _Util.Facade.CustomerFacade.GetCustomerExtendedByCustomerId(customer.CustomerId);

                //    if (_extendedCus != null)
                //    {
                //        _extendedCus.SalesPerson4 = customer.SalesPerson4;
                //        _Util.Facade.CustomerFacade.UpdateCustomerExtended(_extendedCus);
                //    }
                //    else
                //    {
                //        _extendedCus = new CustomerExtended()
                //        {
                //            CustomerId = customer.CustomerId,
                //            SalesPerson4 = customer.SalesPerson4
                //        };
                //        _Util.Facade.CustomerFacade.InsertCustomerExtended(_extendedCus);
                //    }
                //}


                // Here is my recurring billing code                   
                //Guid tempTicketId = Guid.Empty;
                //if (ticket.TicketId != Guid.Empty) { tempTicketId = ticket.TicketId; }
                //var IsRMRActice = _Util.Facade.GlobalSettingsFacade.GetGlobalSettingsByKey(currentLoggedIn.CompanyId.Value, "IsRMRActive");
                //if (IsRMRActice != null && IsRMRActice.Value.ToLower() == "true")
                //{
                //    var controller = DependencyResolver.Current.GetService<RecurringBillingController>();
                //    controller.UpdateRecurringBillingInformationByCustomerModification(customer.CustomerId, tempTicketId, currentLoggedIn.UserId, currentLoggedIn.CompanyId.Value, "", "Customer");
                //}
            }
            catch (Exception ex)
            {
                result = false;
            }
            return Json(new
            {
                status = result,
                customerid = customer.Id,
                tab = nexttab,
                PaymentInfoId = PaymentInfo.Id,
                PaymentMethod = customer.PaymentMethod,
                AuthId = customer.AuthorizeRefId,
                SyncRequired = customer.IsRequiredCsvSync,
                IsProrated = IsProrated,
                ForteId = customer.ScheduleToken
            });
        }
        public JsonResult getupdatedetails(int Id, string Audittime)
        {
            var CurrentUser = ((HS.Web.UI.Helper.CustomPrincipal)(User));

            string resemail = "";
            string resssn = "";
            string restitle = "";
            string rescustomerno = "";
            string resfirstname = "";
            string reslastname = "";
            string restype = "";
            string resbussinessname = "";
            string resdateofbirth = "";
            string resprimaryphone = "";
            string ressecondaryphone = "";
            string rescellno = "";
            string resfax = "";
            string rescallingtime = "";
            string resaddress = "";
            string resstreet = "";
            string rescity = "";
            string resstate = "";
            string reszipcode = "";
            string rescreditscore = "";
            string rescontactterm = "";
            string resfundingcompany = "";
            string resmonthlymonitoringfee = "";
            string rescellularbackup = "";
            string resleadsource = "";
            string rescustomerfunded = "";
            string resmaintanence = "";
            string resnote = "";
            string ressalesdate = "";
            string resinstalldate = "";
            string resinstaller = "";
            string ressoldby = "";
            string resfundingdate = "";
            string resjoindate = "";
            string resqa1 = "";
            string resqa2 = "";
            string resqa1date = "";
            string resqa2date = "";
            string resstatus = "";
            string resbillamount = "";
            string respaymentmethod = "";
            string resbillcycle = "";
            string resbilltax = "";
            string resbilloutstanding = "";
            string resservicedate = "";
            string resisactive = "";
            string resdba = "";
            string resbussinessacounttype = "";
            string resrefferingcustomer = "";
            string resownership = "";
            string respurchaseprice = "";
            string reschildof = "";
            string resestclosedate = "";
            string resdonotcall = "";
            string rescsprovider = "";
            string ressoldby2 = "";
            string ressoldby3 = "";
            string resmovingdate = "";
            string resfollowupdate = "";
            string resbuyoutamountbyads = "";
            string resbuyoutamountbysalesrep = "";
            string resfinancedterm = "";
            string resfinancedamount = "";
            string ressoldamount = "";
            string resleadsourcetype = "";
            ViewBag.Audittime = Audittime;
            DateTime? Auditdatetime = null;
            if (!String.IsNullOrEmpty(Audittime))
            {
                Auditdatetime = DateTime.Parse(Audittime);

            }
            string message = "";
            List<Customerupdateoldandnew> cus = new List<Customerupdateoldandnew>();
            Customer Cusmodel = _Util.Facade.CustomerFacade.GetCustomersByIdAndSoldBy(Id, CurrentUser.UserId, "", "");

            cus = _Util.Facade.CustomerFacade.GetCustomerAuditLog(Id, Auditdatetime);

            if (cus.Count != 0)
            {



                if (cus.FirstOrDefault().newemail != cus.FirstOrDefault().oldemail)
                {
                    message += " Email Updated from " + cus.FirstOrDefault().oldemail + " to " + cus.FirstOrDefault().newemail + "<br>";
                }
                if (cus.FirstOrDefault().newssn != cus.FirstOrDefault().oldssn)
                {
                    message += " SSN Updated from " + cus.FirstOrDefault().oldssn + " to " + cus.FirstOrDefault().newssn + "<br>";
                }
                if (cus.FirstOrDefault().newtitle != cus.FirstOrDefault().oldtitle)
                {
                    message += " Title Updated from " + cus.FirstOrDefault().oldtitle + " to " + cus.FirstOrDefault().newtitle + "<br>";
                }
                if (cus.FirstOrDefault().newcustomerno != cus.FirstOrDefault().oldcustomerno)
                {
                    message += "Customer No Updated from " + cus.FirstOrDefault().oldcustomerno + " to " + cus.FirstOrDefault().newcustomerno + "<br>";
                }
                if (cus.FirstOrDefault().newfirstname != cus.FirstOrDefault().oldfirstname)
                {
                    message += " First name Updated from " + cus.FirstOrDefault().oldfirstname + " to " + cus.FirstOrDefault().newfirstname + "<br>";
                }
                if (cus.FirstOrDefault().newlastname != cus.FirstOrDefault().oldlastname)
                {
                    message += "Last name Updated from " + cus.FirstOrDefault().oldlastname + " to " + cus.FirstOrDefault().newlastname + "<br>";
                }
                if (cus.FirstOrDefault().newtype != cus.FirstOrDefault().oldtype)
                {
                    message += "Type Updated from " + cus.FirstOrDefault().oldtype + " to " + cus.FirstOrDefault().newtype + "<br>";
                }
                if (cus.FirstOrDefault().newbusinessname != cus.FirstOrDefault().oldbusinessname)
                {
                    message += " Business name Updated from " + cus.FirstOrDefault().oldbusinessname + " to " + cus.FirstOrDefault().newbusinessname + "<br>";
                }
                if (cus.FirstOrDefault().newdateofbirth != cus.FirstOrDefault().olddateofbirth)
                {
                    if (cus.FirstOrDefault().newdateofbirth == new DateTime())
                    {
                        cus.FirstOrDefault().newdateofbirth = null;
                    }
                    if (cus.FirstOrDefault().olddateofbirth == new DateTime())
                    {
                        cus.FirstOrDefault().olddateofbirth = null;
                    }
                    message += " Date of Birth Updated from " + cus.FirstOrDefault().olddateofbirth + " to " + cus.FirstOrDefault().newdateofbirth + "<br>";
                }
                if (cus.FirstOrDefault().newprimaryphone != cus.FirstOrDefault().oldprimaryphone)
                {
                    message += " Primary Phone Updated from " + cus.FirstOrDefault().oldprimaryphone + " to " + cus.FirstOrDefault().newprimaryphone + "<br>";
                }
                if (cus.FirstOrDefault().newsecondaryphone != cus.FirstOrDefault().oldsecondaryphone)
                {
                    message += " Secondary Phone Updated from " + cus.FirstOrDefault().oldsecondaryphone + " to " + cus.FirstOrDefault().newsecondaryphone + "<br>";
                }
                if (cus.FirstOrDefault().newcellno != cus.FirstOrDefault().oldcellno)
                {
                    message += " Cell No Updated from " + cus.FirstOrDefault().oldcellno + " to " + cus.FirstOrDefault().newcellno + "<br>";
                }
                if (cus.FirstOrDefault().newfax != cus.FirstOrDefault().oldfax)
                {
                    message += " Fax Updated from " + cus.FirstOrDefault().oldfax + " to " + cus.FirstOrDefault().newfax + "<br>";
                }
                if (cus.FirstOrDefault().newcallingtime != cus.FirstOrDefault().oldcallingtime)
                {
                    message += " Calling Time Updated from " + cus.FirstOrDefault().oldcallingtime + " to " + cus.FirstOrDefault().newcallingtime + "<br>";
                }
                if (cus.FirstOrDefault().newaddress != cus.FirstOrDefault().oldaddress)
                {
                    message += " Address Updated from " + cus.FirstOrDefault().oldaddress + " to " + cus.FirstOrDefault().newaddress + "<br>";
                }
                if (cus.FirstOrDefault().newstreet != cus.FirstOrDefault().oldstreet)
                {
                    message += " Street Updated from " + cus.FirstOrDefault().oldstreet + " to " + cus.FirstOrDefault().newstreet + "<br>";
                }
                if (cus.FirstOrDefault().newcity != cus.FirstOrDefault().oldcity)
                {
                    message += " City Updated from " + cus.FirstOrDefault().oldcity + " to " + cus.FirstOrDefault().newcity + "<br>";
                }
                if (cus.FirstOrDefault().newstate != cus.FirstOrDefault().oldstate)
                {
                    message += " State Updated from " + cus.FirstOrDefault().oldstate + " to " + cus.FirstOrDefault().newstate + "<br>";
                }
                if (cus.FirstOrDefault().newzipcode != cus.FirstOrDefault().oldzipcode)
                {
                    message += " Zip Code Updated from " + cus.FirstOrDefault().oldzipcode + " to " + cus.FirstOrDefault().newzipcode + "<br>";
                }
                if (cus.FirstOrDefault().newcreditscore != cus.FirstOrDefault().oldcreditscore)
                {
                    if (cus.FirstOrDefault().newcreditscore == "-1")
                    {
                        cus.FirstOrDefault().newcreditscore = null;
                    }
                    if (cus.FirstOrDefault().oldcreditscore == "-1")
                    {
                        cus.FirstOrDefault().oldcreditscore = null;
                    }
                    message += " Credit Score Updated from " + cus.FirstOrDefault().oldcreditscore + " to " + cus.FirstOrDefault().newcreditscore + "<br>";
                }
                if (cus.FirstOrDefault().newcontactterm != cus.FirstOrDefault().oldcontactterm)
                {
                    message += " Contact Term Updated from " + cus.FirstOrDefault().oldcontactterm + " to " + cus.FirstOrDefault().newcontactterm + "<br>";
                }
                //if (cus.FirstOrDefault().newcontactterm != cus.FirstOrDefault().oldcontactterm)
                //{
                //    rescontactterm += "Customer ContactTerm Updated from " + cus.FirstOrDefault().oldcontactterm + " to " + cus.FirstOrDefault().newcontactterm;
                //}
                if (cus.FirstOrDefault().newfundingcompany != cus.FirstOrDefault().oldfundingcompany)
                {
                    if (cus.FirstOrDefault().newfundingcompany == "-1")
                    {
                        cus.FirstOrDefault().newfundingcompany = null;
                    }
                    if (cus.FirstOrDefault().oldfundingcompany == "-1")
                    {
                        cus.FirstOrDefault().oldfundingcompany = null;
                    }
                    message += " Funding Company Updated from " + cus.FirstOrDefault().oldfundingcompany + " to " + cus.FirstOrDefault().newfundingcompany + "<br>";
                }
                if (cus.FirstOrDefault().newmonthlymonitoringfee != cus.FirstOrDefault().oldmonthlymonitoringfee)
                {
                    message += " Monthly monitoring fee Updated from " + cus.FirstOrDefault().oldmonthlymonitoringfee + " to " + cus.FirstOrDefault().newmonthlymonitoringfee + "<br>";
                }
                if (cus.FirstOrDefault().newcellularbackup != cus.FirstOrDefault().oldcellularbackup)
                {
                    message += " Cellular Backup Updated from " + cus.FirstOrDefault().oldcellularbackup + " to " + cus.FirstOrDefault().newcellularbackup + "<br>";
                }

                if (cus.FirstOrDefault().newleadsource != cus.FirstOrDefault().oldleadsource)
                {
                    message += " Lead Source Updated from " + cus.FirstOrDefault().Oldleadsourceval + " to " + cus.FirstOrDefault().Newleadsourceval + "<br>";
                }
                if (cus.FirstOrDefault().newcustomerfunded != cus.FirstOrDefault().oldcustomerfunded)
                {
                    message += " Customer Funded Updated from " + cus.FirstOrDefault().oldcustomerfunded + " to " + cus.FirstOrDefault().newcustomerfunded + "<br>";
                }
                if (cus.FirstOrDefault().newmaintanence != cus.FirstOrDefault().oldmaintanence)
                {
                    message += " Maintainence Updated from " + cus.FirstOrDefault().oldmaintanence + " to " + cus.FirstOrDefault().newmaintanence + "<br>";
                }
                if (cus.FirstOrDefault().newnote != cus.FirstOrDefault().oldnote)
                {
                    message += " Note Updated from " + cus.FirstOrDefault().oldnote + " to " + cus.FirstOrDefault().newnote;
                }
                //if (cus.FirstOrDefault().newsalesdate != cus.FirstOrDefault().oldsalesdate)
                //{
                //    message += "Customer SalesDate Updated from " + cus.FirstOrDefault().oldsalesdate + " to " + cus.FirstOrDefault().newsalesdate + "<br>";
                //}
                if (cus.FirstOrDefault().newinstalldate != cus.FirstOrDefault().oldinstalldate)
                {
                    if (cus.FirstOrDefault().newinstalldate == new DateTime())
                    {
                        cus.FirstOrDefault().newinstalldate = null;
                    }
                    if (cus.FirstOrDefault().oldinstalldate == new DateTime())
                    {
                        cus.FirstOrDefault().oldinstalldate = null;
                    }
                    message += " Install Date Updated from " + cus.FirstOrDefault().oldinstalldate + " to " + cus.FirstOrDefault().newinstalldate + "<br>";
                }
                if (cus.FirstOrDefault().newinstaller != cus.FirstOrDefault().oldinstaller)
                {
                    message += " Installer Updated from " + cus.FirstOrDefault().Oldinstallerval + " to " + cus.FirstOrDefault().Newinstallerval + "<br>";
                }
                if (cus.FirstOrDefault().newsoldby != cus.FirstOrDefault().oldsoldby)
                {
                    message += " Sales Person Updated from " + cus.FirstOrDefault().oldsoldbyval + " to " + cus.FirstOrDefault().newsoldbyval + "<br>";
                }
                //if (cus.FirstOrDefault().newfundingdate != cus.FirstOrDefault().oldfundingdate)
                //{
                //    message += "Customer FundingDate Updated from " + cus.FirstOrDefault().oldfundingdate + " to " + cus.FirstOrDefault().newfundingdate + "<br>";
                //}
                if (cus.FirstOrDefault().newjoindate != cus.FirstOrDefault().oldjoindate)
                {
                    if (cus.FirstOrDefault().newjoindate == new DateTime())
                    {
                        cus.FirstOrDefault().newjoindate = null;
                    }
                    if (cus.FirstOrDefault().oldjoindate == new DateTime())
                    {
                        cus.FirstOrDefault().oldjoindate = null;
                    }
                    message += " Join Date Updated from " + cus.FirstOrDefault().oldjoindate + " to " + cus.FirstOrDefault().newjoindate + "<br>";
                }
                if (cus.FirstOrDefault().newqa1 != cus.FirstOrDefault().oldqa1)
                {
                    message += " QA1 Updated from " + cus.FirstOrDefault().oldqa1 + " to " + cus.FirstOrDefault().newqa1 + "<br>";
                }
                if (cus.FirstOrDefault().newqa2 != cus.FirstOrDefault().oldqa2)
                {
                    message += " QA2 Updated from " + cus.FirstOrDefault().oldqa2 + " to " + cus.FirstOrDefault().newqa2 + "<br>";
                }
                if (cus.FirstOrDefault().newqa1date != cus.FirstOrDefault().oldqa1date)
                {
                    if (cus.FirstOrDefault().newqa1date == new DateTime())
                    {
                        cus.FirstOrDefault().newqa1date = null;
                    }
                    if (cus.FirstOrDefault().oldqa1date == new DateTime())
                    {
                        cus.FirstOrDefault().oldqa1date = null;
                    }
                    message += " QA1 Date Updated from " + cus.FirstOrDefault().oldqa1date + " to " + cus.FirstOrDefault().newqa1date + "<br>";
                }
                if (cus.FirstOrDefault().newqa2date != cus.FirstOrDefault().oldqa2date)
                {
                    if (cus.FirstOrDefault().newqa2date == new DateTime())
                    {
                        cus.FirstOrDefault().newqa2date = null;
                    }
                    if (cus.FirstOrDefault().oldqa2date == new DateTime())
                    {
                        cus.FirstOrDefault().oldqa2date = null;
                    }
                    message += " QA2 Date Updated from " + cus.FirstOrDefault().oldqa2date + " to " + cus.FirstOrDefault().newqa2date + "<br>";
                }
                if (cus.FirstOrDefault().newsoldby2 != cus.FirstOrDefault().oldsoldby2)
                {
                    message += " Sales Person2 Updated from " + cus.FirstOrDefault().oldsoldby2 + " to " + cus.FirstOrDefault().newsoldby2 + "<br>";
                }
                if (cus.FirstOrDefault().newsoldby3 != cus.FirstOrDefault().oldsoldby3)
                {
                    message += " Sales Person3 Updated from " + cus.FirstOrDefault().oldsoldby3 + " to " + cus.FirstOrDefault().newsoldby3 + "<br>";
                }
                if (cus.FirstOrDefault().newcustomerstatus != cus.FirstOrDefault().oldcustomerstatus)
                {
                    message += " Status Updated from " + cus.FirstOrDefault().oldcustomerstatus + " to " + cus.FirstOrDefault().newcustomerstatus + "<br>";
                }
                if (cus.FirstOrDefault().newbillamount != cus.FirstOrDefault().oldbillamount)
                {
                    message += " Bill Amount Updated from " + cus.FirstOrDefault().oldbillamount + "$" + " to " + cus.FirstOrDefault().newbillamount + "$" + "<br>";
                }
                if (cus.FirstOrDefault().newpaymentmethod == "-1")
                {
                    cus.FirstOrDefault().newpaymentmethod = "";
                }
                if (cus.FirstOrDefault().oldpaymentmethod == "-1")
                {
                    cus.FirstOrDefault().oldpaymentmethod = "";
                }
                if (cus.FirstOrDefault().newpaymentmethod != cus.FirstOrDefault().oldpaymentmethod)
                {
                    message += " Payment Method Updated from " + cus.FirstOrDefault().oldpaymentmethod + " to " + cus.FirstOrDefault().newpaymentmethod + "<br>";
                }

                if (cus.FirstOrDefault().newbillcycle != cus.FirstOrDefault().oldbillcycle)
                {
                    if (cus.FirstOrDefault().newbillcycle == "-1")
                    {
                        cus.FirstOrDefault().newbillcycle = null;
                    }
                    if (cus.FirstOrDefault().oldbillcycle == "-1")
                    {
                        cus.FirstOrDefault().oldbillcycle = null;
                    }



                    message += " Bill Cycle Updated from " + cus.FirstOrDefault().oldbillcycle + " to " + cus.FirstOrDefault().newbillcycle + "<br>";

                }
                if (cus.FirstOrDefault().newbilltax != cus.FirstOrDefault().oldbilltax)
                {
                    message += " Bill Tax Updated from " + cus.FirstOrDefault().oldbilltax + " to " + cus.FirstOrDefault().newbilltax + "<br>";
                }
                if (cus.FirstOrDefault().newbilloutstanding != cus.FirstOrDefault().oldbilloutstanding)
                {
                    message += " Bill Outstanding Updated from " + cus.FirstOrDefault().oldbilloutstanding + " to " + cus.FirstOrDefault().newbilloutstanding + "<br>";
                }
                if (cus.FirstOrDefault().newisactive != cus.FirstOrDefault().oldisactive)
                {
                    message += " Active status Updated from " + cus.FirstOrDefault().oldisactive + " to " + cus.FirstOrDefault().newisactive + "<br>";
                }
                if (cus.FirstOrDefault().newdba != cus.FirstOrDefault().olddba)
                {
                    message += " DBA Updated from " + cus.FirstOrDefault().olddba + " to " + cus.FirstOrDefault().newdba + "<br>";

                }

                if (cus.FirstOrDefault().newreferingcustomer != cus.FirstOrDefault().oldreferingcustomer)
                {
                    message += " Refferring Customer Updated from " + cus.FirstOrDefault().oldreferingcustomer + " to " + cus.FirstOrDefault().newreferingcustomer + "<br>";
                }

                //if (cus.FirstOrDefault().newownership != cus.FirstOrDefault().oldownership)
                //{
                //    if (cus.FirstOrDefault().newownership == "-1")
                //    {
                //        message += "Customer DBA Updated from " + cus.FirstOrDefault().olddba + " to " + cus.FirstOrDefault().newdba + "<br>";
                //    }
                //}
                if (cus.FirstOrDefault().newbusinessaccounttype != cus.FirstOrDefault().oldbusinessaccounttype)
                {
                    if (cus.FirstOrDefault().newbusinessaccounttype == "-1")
                    {
                        cus.FirstOrDefault().newbusinessaccounttype = null;
                    }
                    if (cus.FirstOrDefault().oldbusinessaccounttype == "-1")
                    {
                        cus.FirstOrDefault().oldbusinessaccounttype = null;
                    }
                    message += " Business Account Type Updated from " + cus.FirstOrDefault().oldbusinessaccounttype + " to " + cus.FirstOrDefault().newbusinessaccounttype + "<br>";
                }
                //if (cus.FirstOrDefault().newreferingcustomer != cus.FirstOrDefault().oldreferingcustomer)
                //{
                //    message += "Customer RefferringCustomer Updated from " + cus.FirstOrDefault().oldreferingcustomer + " to " + cus.FirstOrDefault().newreferingcustomer + "<br>";
                //}

                if (cus.FirstOrDefault().newownership != cus.FirstOrDefault().oldownership)
                {
                    if (cus.FirstOrDefault().newownership == "-1")
                    {
                        cus.FirstOrDefault().newownership = null;
                    }
                    if (cus.FirstOrDefault().oldownership == "-1")
                    {
                        cus.FirstOrDefault().oldownership = null;
                    }
                    message += " Ownership Updated from " + cus.FirstOrDefault().oldownership + " to " + cus.FirstOrDefault().newownership + "<br>";
                }
                if (cus.FirstOrDefault().newpurchaseprice != cus.FirstOrDefault().oldpurchaseprice)
                {
                    message += " Purchase Price Updated from " + cus.FirstOrDefault().oldpurchaseprice + " to " + cus.FirstOrDefault().newpurchaseprice + "<br>";
                }
                if (cus.FirstOrDefault().newchildof != cus.FirstOrDefault().oldchildof)
                {
                    message += " Child of Updated from " + cus.FirstOrDefault().oldchildof + " to " + cus.FirstOrDefault().newchildof + "<br>";
                }
                if (cus.FirstOrDefault().newestimateclosedate != cus.FirstOrDefault().oldestimateclosedate)
                {
                    if (cus.FirstOrDefault().newestimateclosedate == new DateTime())
                    {
                        cus.FirstOrDefault().newestimateclosedate = null;
                    }
                    if (cus.FirstOrDefault().oldestimateclosedate == new DateTime())
                    {
                        cus.FirstOrDefault().oldestimateclosedate = null;
                    }
                    message += " Estimate Close Date Updated from " + cus.FirstOrDefault().oldestimateclosedate + " to " + cus.FirstOrDefault().newestimateclosedate + "<br>";
                }

                if (cus.FirstOrDefault().newdonotcall != cus.FirstOrDefault().olddonotcall)
                {
                    message += " Do Not Call Updated from " + cus.FirstOrDefault().olddonotcall + " to " + cus.FirstOrDefault().newdonotcall + "<br>";
                }
                if (cus.FirstOrDefault().newcsprovider != cus.FirstOrDefault().oldcsprovider)
                {
                    message += " CS Provider Updated from " + cus.FirstOrDefault().oldcsprovider + " to " + cus.FirstOrDefault().newcsprovider + "<br>";
                }
                if (cus.FirstOrDefault().newmovingdate != cus.FirstOrDefault().oldmovingdate)
                {
                    if (cus.FirstOrDefault().newmovingdate == new DateTime())
                    {
                        cus.FirstOrDefault().newmovingdate = null;
                    }
                    if (cus.FirstOrDefault().oldmovingdate == new DateTime())
                    {
                        cus.FirstOrDefault().oldmovingdate = null;
                    }
                    message += " Moving Date Updated from " + cus.FirstOrDefault().oldmovingdate + " to " + cus.FirstOrDefault().newmovingdate + "<br>";
                }
                if (cus.FirstOrDefault().newfollowupdate != cus.FirstOrDefault().oldfollowupdate)
                {
                    if (cus.FirstOrDefault().newfollowupdate == new DateTime())
                    {
                        cus.FirstOrDefault().newfollowupdate = null;
                    }
                    if (cus.FirstOrDefault().oldfollowupdate == new DateTime())
                    {
                        cus.FirstOrDefault().oldfollowupdate = null;
                    }
                    message += " Followup Date Updated from " + cus.FirstOrDefault().oldfollowupdate + " to " + cus.FirstOrDefault().newfollowupdate + "<br>";
                }
                if (cus.FirstOrDefault().newbuyoutamountbyads != cus.FirstOrDefault().oldbuyoutamountbyads)
                {
                    message += " BuyoutamountbyADS Updated from " + cus.FirstOrDefault().oldbuyoutamountbyads + " to " + cus.FirstOrDefault().newbuyoutamountbyads + "<br>";
                }
                if (cus.FirstOrDefault().newbuyoutamountbysalesrep != cus.FirstOrDefault().oldbuyoutamountbysalesrep)
                {
                    message += " BuyoutamountbySalesRep Updated from " + cus.FirstOrDefault().oldbuyoutamountbysalesrep + " to " + cus.FirstOrDefault().newbuyoutamountbysalesrep + "<br>";
                }
                if (cus.FirstOrDefault().newfinancedterm != cus.FirstOrDefault().oldfinancedterm)
                {
                    message += " Finance Term Updated from " + cus.FirstOrDefault().oldfinancedterm + " to " + cus.FirstOrDefault().newfinancedterm + "<br>";
                }
                if (cus.FirstOrDefault().newfinancedamount != cus.FirstOrDefault().oldfinancedamount)
                {
                    message += " Finance Amount Updated from " + cus.FirstOrDefault().oldfinancedamount + " to " + cus.FirstOrDefault().newfinancedamount + "<br>";
                }
                if (cus.FirstOrDefault().newsoldamount != cus.FirstOrDefault().oldsoldamount)
                {
                    message += " Sold Amount Updated from " + cus.FirstOrDefault().oldsoldamount + " to " + cus.FirstOrDefault().newsoldamount + "<br>";
                }
                if (cus.FirstOrDefault().newleadtype != cus.FirstOrDefault().oldleadtype)
                {
                    message += " Lead Source Type Updated from " + cus.FirstOrDefault().oldleadtype + " to " + cus.FirstOrDefault().newleadtype + "<br>";
                }

            }


            //ViewBag.ResultTitle = restitle;
            //ViewBag.ResultCusNo = rescustomerno;
            //ViewBag.resfirstname = resfirstname;
            //ViewBag.reslastname = reslastname;

            //ViewBag.restype = restype;
            //ViewBag.resbussinessname = resbussinessname;
            //ViewBag.resdateofbirth = resdateofbirth;
            //ViewBag.resprimaryphone = resprimaryphone;

            //ViewBag.ressecondaryphone = ressecondaryphone;
            //ViewBag.rescellno = rescellno;
            //ViewBag.resfax = resfax;
            //ViewBag.rescallingtime = rescallingtime;


            //ViewBag.resaddress = resaddress;
            //ViewBag.resstreet = resstreet;
            //ViewBag.rescity = rescity;
            //ViewBag.resstate = resstate;


            //ViewBag.reszipcode = reszipcode;
            //ViewBag.rescreditscore = rescreditscore;
            //ViewBag.rescontactterm = rescontactterm;
            //ViewBag.resfundingcompany = resfundingcompany;


            //ViewBag.resmonthlymonitoringfee = resmonthlymonitoringfee;
            //ViewBag.rescellularbackup = rescellularbackup;
            //ViewBag.resleadsource = resleadsource;
            //ViewBag.rescustomerfunded = rescustomerfunded;

            //ViewBag.resmaintanence = resmaintanence;
            //ViewBag.resnote = resnote;
            //ViewBag.ressalesdate = ressalesdate;
            //ViewBag.resinstalldate = resinstalldate;


            //ViewBag.resinstaller = resinstaller;
            //ViewBag.ressoldby = ressoldby;
            //ViewBag.resfundingdate = resfundingdate;
            //ViewBag.resjoindate = resjoindate;

            //ViewBag.resqa1 = resqa1;
            //ViewBag.resqa2 = resqa2;
            //ViewBag.resqa1date = resqa1date;
            //ViewBag.resqa2date = resqa2date;


            //ViewBag.resstatus = resstatus;
            //ViewBag.resbillamount = resbillamount;
            //ViewBag.respaymentmethod = respaymentmethod;
            //ViewBag.resbillcycle = resbillcycle;


            //ViewBag.resbilltax = resbilltax;
            //ViewBag.resbilloutstanding = resbilloutstanding;
            //ViewBag.resservicedate = resservicedate;
            //ViewBag.resisactive = resisactive;


            //ViewBag.resdba = resdba;
            //ViewBag.resbussinessacounttype = resbussinessacounttype;
            //ViewBag.resrefferingcustomer = resrefferingcustomer;
            //ViewBag.resownership = resownership;

            //ViewBag.respurchaseprice = respurchaseprice;
            //ViewBag.reschildof = reschildof;
            //ViewBag.resestclosedate = resestclosedate;
            //ViewBag.resdonotcall = resdonotcall;


            //ViewBag.rescsprovider = rescsprovider;
            //ViewBag.ressoldby2 = ressoldby2;
            //ViewBag.ressoldby3 = ressoldby3;
            //ViewBag.resmovingdate = resmovingdate;

            //ViewBag.resfollowupdate = resfollowupdate;
            //ViewBag.resbuyoutamountbyads = resbuyoutamountbyads;
            //ViewBag.resbuyoutamountbysalesrep = resbuyoutamountbysalesrep;
            //ViewBag.resfinancedterm = resfinancedterm;

            //ViewBag.resfinancedamount = resfinancedamount;
            //ViewBag.ressoldamount = ressoldamount;
            //ViewBag.resleadsourcetype = resleadsourcetype;

            //if (!String.IsNullOrEmpty(restitle)) 
            //       {
            //    restitle = restitle + "<br>";
            //        }

            //if (!String.IsNullOrEmpty(rescustomerno))
            //{
            //    rescustomerno = rescustomerno + "<br>";
            //}
            //if (!String.IsNullOrEmpty(resfirstname))
            //{
            //    rescustomerno = rescustomerno + "<br>";
            //}





















            //string message = restitle  + rescustomerno  + resfirstname + reslastname +  restype + resbussinessname + resdateofbirth + resprimaryphone +  ressecondaryphone + rescellno +resfax +  rescallingtime +  resaddress +  resstreet +
            //    rescity+resstate+ reszipcode +rescreditscore +rescontactterm +  resfundingcompany +  resmonthlymonitoringfee +  rescellularbackup + resleadsource +  rescustomerfunded +  resmaintanence +  resnote + ressalesdate + resinstalldate
            //    + resinstaller +  ressoldby +  resfundingdate + resjoindate + resqa1 +  resqa2 +  resqa1date + resqa2date + resstatus +  resbillamount +  respaymentmethod + resbillcycle + resbilltax + resbilloutstanding +  resservicedate + resisactive
            //    +resdba+resbussinessacounttype+resrefferingcustomer+resownership+respurchaseprice+reschildof+resestclosedate+resdonotcall+rescsprovider+ressoldby2+ressoldby3+resmovingdate+resfollowupdate+resbuyoutamountbyads
            //    +  resbuyoutamountbysalesrep +  resfinancedterm + resfinancedamount +  ressoldamount +  resleadsourcetype;

            //ViewBag.ResultEmail = resemail;
            //ViewBag.ResultSSN = resssn;
            //return Json(new {  message = message });
            return Json(new { message = message }, JsonRequestBehavior.AllowGet);

            //return PartialView("_Getupdatedetails");
        }
        [Authorize]
        [HttpPost]
        public JsonResult SyncFromAuthorize(Guid CustomerId)
        {
            if (CustomerId == null || CustomerId == Guid.Empty)
            {
                return Json(new { result = false, message = "Customer not found." });
            }
            Customer customer = _Util.Facade.CustomerFacade.GetCustomerByCustomerId(CustomerId);
            if (customer == null)
            {
                return Json(new { result = false, message = "Customer not found." });
            }
            if (string.IsNullOrWhiteSpace(customer.AuthorizeRefId))
            {
                return Json(new { result = false, message = "Customer not subscribed for authorize.net." });
            }
            var CurrentUser = (HS.Web.UI.Helper.CustomPrincipal)User;
            string TransactionKey = _Util.Facade.GlobalSettingsFacade.GetAuthTransactionKeyByCompanyId(CurrentUser.CompanyId.Value, (customer.PaymentMethod == LabelHelper.PaymentMethod.ACH));
            string APILoginId = _Util.Facade.GlobalSettingsFacade.GetAuthAPILoginIdByCompanyId(CurrentUser.CompanyId.Value, (customer.PaymentMethod == LabelHelper.PaymentMethod.ACH));

            ARBGetSubscriptionResponse response = GetSubscription.Run(APILoginId, TransactionKey, customer.AuthorizeRefId, true);
            if (response.subscription != null)
            {
                customer.SubscriptionStatus = response.subscription.status.ToString();

                #region Bill Amount And MonitoringFee 
                if (customer.BillTax.HasValue && customer.BillTax == true)
                {
                    #region Tax Calculation
                    double MonitoringFee = (double)response.subscription.amount;
                    double TaxAmount = 0;
                    string TaxPercentage = "8.25";//_Util.Facade.GlobalSettingsFacade.GetSalesTax(CurrentUser.CompanyId.Value, customer.CustomerId);

                    MonitoringFee = ((100 * MonitoringFee) / (100 + (Convert.ToDouble(TaxPercentage))));
                    TaxAmount = (double)response.subscription.amount - MonitoringFee;

                    #endregion
                    customer.BillAmount = (double)response.subscription.amount;
                    customer.MonthlyMonitoringFee = MonitoringFee.ToString();

                }
                else
                {
                    customer.BillTax = false;
                    customer.BillAmount = (double)response.subscription.amount;
                    customer.MonthlyMonitoringFee = response.subscription.amount.ToString();
                }
                #endregion

                if (response.subscription.profile != null)
                {
                    customer.AuthorizeCusProfileId = response.subscription.profile.customerProfileId;
                    if (response.subscription.profile.paymentProfile != null)
                    {
                        customer.AuthorizeCusPaymentProfileId = response.subscription.profile.paymentProfile.customerPaymentProfileId;

                        if (response.subscription.profile.paymentProfile.payment != null
                            && response.subscription.profile.paymentProfile.payment.Item != null)
                        {
                            Type type = response.subscription.profile.paymentProfile.payment.Item.GetType();
                            if (type == typeof(creditCardMaskedType))
                            {
                                customer.PaymentMethod = LabelHelper.PaymentMethod.CreditCard;
                            }
                            if (type == typeof(bankAccountMaskedType))
                            {
                                customer.PaymentMethod = LabelHelper.PaymentMethod.ACH;
                            }
                        }

                    }
                }
                if (response.subscription.paymentSchedule != null)
                {
                    customer.FirstBilling = response.subscription.paymentSchedule.startDate;
                    if (response.subscription.paymentSchedule.interval.unit == ARBSubscriptionUnitEnum.months)
                    {
                        if (response.subscription.paymentSchedule.interval.length == 1)
                        {
                            customer.BillCycle = LabelHelper.BillCycle.Monthly;
                        }
                        else if (response.subscription.paymentSchedule.interval.length == 12)
                        {
                            customer.BillCycle = LabelHelper.BillCycle.Annually;
                        }
                        else if (response.subscription.paymentSchedule.interval.length == 6)
                        {
                            customer.BillCycle = LabelHelper.BillCycle.SemiAnnual;
                        }
                        else if (response.subscription.paymentSchedule.interval.length == 3)
                        {
                            customer.BillCycle = LabelHelper.BillCycle.Quarterly;
                        }
                    }
                }
                _Util.Facade.CustomerFacade.UpdateCustomer(customer);
            }




            return Json(true);
        }

        [Authorize]
        [HttpPost]
        public JsonResult SubscribeToAuthorize(Customer customer, PaymentInfo PaymentInfo)
        {
            bool result = false;
            bool HasAuthorizeMessage = false;
            string AuthorizeMessage = "";
            bool PaymentInfoIsNull = true;
            var CurrentUser = (HS.Web.UI.Helper.CustomPrincipal)User;
            if (PaymentInfo.AccountName == "ProfilePackage")
            {
                PaymentInfo = _Util.Facade.PaymentInfoFacade.GetPaymentInfoById(PaymentInfo.Id);
            }

            if (customer.Id > 0)
            {
                #region ARB Subscription

                Customer cust = _Util.Facade.CustomerFacade.GetById(customer.Id);
                if (cust == null || cust.CustomerId != customer.CustomerId)
                {
                    return Json(new { status = false, message = "invalid customer." });
                }
                else if (!string.IsNullOrWhiteSpace(cust.AuthorizeRefId))
                {
                    return Json(new
                    {
                        status = true,
                        AuthId = cust.AuthorizeRefId,
                        HasMessage = true,
                        AuthMessage = "already subscribed to authorize.net with subscriptionid: " + cust.AuthorizeRefId
                    });
                }

                int PaymentInfoId = 0;

                if (int.TryParse(customer.PaymentMethod, out PaymentInfoId) && PaymentInfoId > 0)
                {
                    PaymentInfo tempPaymentInfo = _Util.Facade.PaymentInfoFacade.GetPaymentInfoById(PaymentInfoId);
                    if (tempPaymentInfo != null)
                    {
                        tempPaymentInfo.CardNumber.Replace("-", "");
                        PaymentInfo = tempPaymentInfo;

                        if (!string.IsNullOrWhiteSpace(PaymentInfo.CardNumber) && !string.IsNullOrWhiteSpace(PaymentInfo.CardExpireDate)
                                && !string.IsNullOrWhiteSpace(PaymentInfo.CardSecurityCode))
                        {
                            PaymentInfo.CardNumber = PaymentInfo.CardNumber.Replace("-", "");
                            cust.PaymentMethod = LabelHelper.PaymentMethod.CreditCard;
                            customer.PaymentMethod = LabelHelper.PaymentMethod.CreditCard;
                            _Util.Facade.CustomerFacade.UpdateCustomer(cust);
                        }
                        else if (!string.IsNullOrWhiteSpace(PaymentInfo.RoutingNo)
                           && !string.IsNullOrWhiteSpace(PaymentInfo.AcountNo))
                        {
                            cust.PaymentMethod = LabelHelper.PaymentMethod.ACH;
                            customer.PaymentMethod = LabelHelper.PaymentMethod.ACH;
                            _Util.Facade.CustomerFacade.UpdateCustomer(cust);
                        }

                        PaymentInfoCustomer PIC = _Util.Facade.PaymentInfoCustomerFacade.GetByCustomerIdAndPayfor(cust.CustomerId, "MMR");

                        if (PIC != null)
                        {
                            PIC.PaymentInfoId = PaymentInfo.Id;
                            _Util.Facade.PaymentInfoCustomerFacade.UpdatePaymentInfoCustomer(PIC);
                        }
                        else
                        {
                            PIC = new PaymentInfoCustomer()
                            {
                                CustomerId = cust.CustomerId,
                                CompanyId = CurrentUser.CompanyId.Value,
                                Payfor = "MMR",
                                IsPaid = false,
                                PaymentInfoId = PaymentInfo.Id,

                            };
                            _Util.Facade.PaymentInfoCustomerFacade.InsertPaymentInfoCustomer(PIC);
                        }

                    }
                }

                //checking if there is enough payment ifo
                if (!string.IsNullOrWhiteSpace(PaymentInfo.BankAccountType) && !string.IsNullOrWhiteSpace(PaymentInfo.RoutingNo) && !string.IsNullOrWhiteSpace(PaymentInfo.AcountNo))
                {
                    PaymentInfoIsNull = false;
                }
                else if (!string.IsNullOrWhiteSpace(PaymentInfo.CardNumber) && !string.IsNullOrWhiteSpace(PaymentInfo.CardSecurityCode) && !string.IsNullOrWhiteSpace(PaymentInfo.CardExpireDate))
                {
                    PaymentInfoIsNull = false;
                }
                //if payment method is ach or credit card
                if ((customer.PaymentMethod == LabelHelper.PaymentMethod.ACH || customer.PaymentMethod == LabelHelper.PaymentMethod.CreditCard) && !PaymentInfoIsNull)
                {

                    if (customer.PaymentMethod == LabelHelper.PaymentMethod.CreditCard && PaymentInfo.CardNumber.IndexOf("******") > -1 && PaymentInfo.Id > 0)
                    {
                        PaymentInfo tmpPaymentInfo = _Util.Facade.PaymentInfoFacade.GetPaymentInfo_Card_ByCompanyIdAndCustomerId(CurrentUser.CompanyId.Value, customer.CustomerId);
                        PaymentInfo.CardNumber = DESEncryptionDecryption.DecryptCipherTextToPlainText(tmpPaymentInfo.CardNumber);
                    }
                    if (customer.PaymentMethod == LabelHelper.PaymentMethod.ACH && PaymentInfo.AcountNo.IndexOf("******") > -1 && PaymentInfo.Id > 0)
                    {
                        PaymentInfo tmpPaymentInfo = _Util.Facade.PaymentInfoFacade.GetPaymentInfo_Card_ByCompanyIdAndCustomerId(CurrentUser.CompanyId.Value, customer.CustomerId);
                        PaymentInfo.AcountNo = DESEncryptionDecryption.DecryptCipherTextToPlainText(tmpPaymentInfo.AcountNo);
                    }
                    if (customer.PaymentMethod == LabelHelper.PaymentMethod.ACH && PaymentInfo.RoutingNo.IndexOf("******") > -1 && PaymentInfo.Id > 0)
                    {
                        PaymentInfo tmpPaymentInfo = _Util.Facade.PaymentInfoFacade.GetPaymentInfo_Card_ByCompanyIdAndCustomerId(CurrentUser.CompanyId.Value, customer.CustomerId);
                        PaymentInfo.RoutingNo = DESEncryptionDecryption.DecryptCipherTextToPlainText(tmpPaymentInfo.RoutingNo);
                    }

                    if (string.IsNullOrWhiteSpace(cust.AuthorizeRefId) && string.IsNullOrWhiteSpace(customer.AuthorizeRefId))
                    {
                        #region if there is no authorizer ref id ; do subscription
                        if (customer.BillAmount == null)
                        {
                            customer.BillAmount = 0;
                        }

                        string TransactionKey = _Util.Facade.GlobalSettingsFacade.GetAuthTransactionKeyByCompanyId(CurrentUser.CompanyId.Value, (customer.PaymentMethod == LabelHelper.PaymentMethod.ACH));
                        string APILoginId = _Util.Facade.GlobalSettingsFacade.GetAuthAPILoginIdByCompanyId(CurrentUser.CompanyId.Value, (customer.PaymentMethod == LabelHelper.PaymentMethod.ACH));

                        PaymentInfo.CardNumber = string.IsNullOrWhiteSpace(PaymentInfo.CardNumber) ? "" : DESEncryptionDecryption.DecryptCipherTextToPlainText(PaymentInfo.CardNumber);
                        PaymentInfo.CardSecurityCode = string.IsNullOrWhiteSpace(PaymentInfo.CardSecurityCode) ? "" : DESEncryptionDecryption.DecryptCipherTextToPlainText(PaymentInfo.CardSecurityCode);
                        PaymentInfo.CardExpireDate = string.IsNullOrWhiteSpace(PaymentInfo.CardExpireDate) ? "" : DESEncryptionDecryption.DecryptCipherTextToPlainText(PaymentInfo.CardExpireDate);

                        #region Getting BillingFirstName And BillingLastName From Given Name
                        string FirstName = customer.FirstName;
                        string LastName = customer.LastName;
                        if (!string.IsNullOrWhiteSpace(PaymentInfo.AccountName))
                        {
                            var str = PaymentInfo.AccountName.Replace("  ", " ").Split(' ');
                            if (str.Count() > 0)
                            {
                                var i = 1;
                                FirstName = str[0];
                                for (; i < str.Count() - 1; i++)
                                {
                                    FirstName += " " + str[i];
                                }
                                if (str.Count() > 1)
                                {
                                    LastName = str[i];
                                }
                                else
                                {
                                    LastName = "";
                                }

                            }
                            else
                            {
                                FirstName = PaymentInfo.AccountName;
                                LastName = "";
                            }
                        }
                        #endregion

                        ARBSubscription Subscription = new ARBSubscription()
                        {
                            CustomerId = customer.Id.ToString(),
                            FirstName = customer.FirstName,
                            LastName = customer.LastName,

                            BillingFirstName = FirstName,
                            BillingLastName = LastName,
                            PaymentMethod = customer.PaymentMethod,
                            CompanyName = customer.BusinessName,
                            //CustomerId = customer.CustomerNo,
                            //NameOnCard = PaymentInfo.AccountName,
                            CardNumber = PaymentInfo.CardNumber.Replace(" ", "").Replace("-", ""),
                            CardPassword = PaymentInfo.CardSecurityCode,
                            ExpirationDate = PaymentInfo.CardExpireDate.Replace("/", ""),

                            SubscritptionAmount = (decimal)customer.BillAmount,
                            SubscriptionInterval = 1,
                            BankAccountType = PaymentInfo.BankAccountType,
                            BankAccountNumber = PaymentInfo.AcountNo,
                            BankARBRoutingNumber = PaymentInfo.RoutingNo,
                            ECheckType = PaymentInfo.EcheckType,
                            NameOnBankAccount = PaymentInfo.AccountName,
                            BankName = PaymentInfo.BankName,
                            TotalOccurrences = 999,
                            Invoice = customer.CustomerNo,
                            Description = customer.AuthorizeDescription,
                            //Invoice = LabelHelper.InvoiceNumberForARB.MonitoringFee,
                        };
                        if (customer.EmailAddress.IsValidEmailAddress())
                        {
                            Subscription.EmailAddress = customer.EmailAddress;
                        }
                        if (!string.IsNullOrWhiteSpace(PaymentInfo.AccountName))
                        {
                            RegexOptions options = RegexOptions.None;
                            Regex regex = new Regex("[ ]{2,}", options);
                            PaymentInfo.AccountName = regex.Replace(PaymentInfo.AccountName, " ");

                            if (PaymentInfo.AccountName.Length > 4 && PaymentInfo.AccountName.IndexOf(" ") > 1)
                            {
                                Subscription.FirstName = PaymentInfo.AccountName.Split(' ')[0];
                                Subscription.LastName = PaymentInfo.AccountName.Split(' ')[1];
                            }
                        }

                        #region Subscription starts

                        if (!string.IsNullOrWhiteSpace(customer.BillCycle) && customer.BillCycle != "-1")
                        {
                            if (customer.BillCycle == LabelHelper.BillCycle.Monthly)
                            {
                                Subscription.SubscriptionInterval = 1;
                            }
                            else if (customer.BillCycle == LabelHelper.BillCycle.Quarterly)
                            {
                                Subscription.SubscriptionInterval = 3;
                            }
                            else if (customer.BillCycle == LabelHelper.BillCycle.SemiAnnual)
                            {
                                Subscription.SubscriptionInterval = 6;
                            }
                            else if (customer.BillCycle == LabelHelper.BillCycle.Annual)
                            {
                                Subscription.SubscriptionInterval = 12;
                            }
                        }

                        if (customer.FirstBilling.HasValue)
                        {
                            customer.FirstBilling = customer.FirstBilling.Value.SetZeroHour();
                            //if (customer.FirstBilling.Value <= DateTime.Now.UTCCurrentTime().SetZeroHour())
                            //{
                            //    Subscription.SubscriptionStartDate = DateTime.Now.UTCCurrentTime().SetZeroHour().AddDays(1);
                            //}
                            //else
                            //{
                            //    Subscription.SubscriptionStartDate = customer.FirstBilling.Value;
                            //}
                            Subscription.SubscriptionStartDate = customer.FirstBilling.Value;
                        }
                        else
                        {
                            //Subscription.SubscriptionStartDate = DateTime.Now.UTCCurrentTime().SetZeroHour().AddDays(1);
                            //customer.FirstBilling = Subscription.SubscriptionStartDate;
                            return Json(new
                            {
                                status = true,
                                AuthId = cust.AuthorizeRefId,
                                HasMessage = true,
                                AuthMessage = "Subscription start date required."
                            });
                        }
                        #endregion
                        bool AuthInProduction = false;
                        GlobalSetting globset = _Util.Facade.GlobalSettingsFacade.GetGlobalSettingsByKey(CurrentUser.CompanyId.Value, "Authorize.NetInProduction");
                        if (globset != null && globset.Value.ToLower() == "true")
                        {
                            AuthInProduction = true;
                        }
                        //bool ForteInProduction = false;
                        //GlobalSetting ForteGlobset = _Util.Facade.GlobalSettingsFacade.GetGlobalSettingsByKey(CurrentUser.CompanyId.Value, "ForteInProduction");
                        //if (globset != null && globset.Value.ToLower() == "true")
                        //{
                        //    ForteInProduction = true;
                        //}
                        ARBCreateSubscriptionResponse SubscriptionResult = new ARBCreateSubscriptionResponse();
                        try
                        {
                            //Elmah.ErrorSignal.FromCurrentContext().Raise(new Exception("SubscriptionResult Started"));

                            SubscriptionResult = CreateSubscription.Run(APILoginId, TransactionKey, Subscription, AuthInProduction);
                        }
                        catch (Exception)
                        {
                            //Elmah.ErrorSignal.FromCurrentContext().Raise(new Exception("SubscriptionResult E7878"));
                            result = false;
                        }
                        if (SubscriptionResult == null)
                        {
                            //Elmah.ErrorSignal.FromCurrentContext().Raise(new Exception("SubscriptionResult NULL"));
                            HasAuthorizeMessage = true;
                            AuthorizeMessage = "We are Sorry! authorize.net is not respoding. Please contact system admin.";
                        }
                        if (SubscriptionResult != null && SubscriptionResult.messages.resultCode == messageTypeEnum.Ok)
                        {
                            if (SubscriptionResult != null && SubscriptionResult.messages.message != null)
                            {
                                customer.AuthorizeRefId = SubscriptionResult.subscriptionId.ToString();

                                if (SubscriptionResult.profile != null)
                                {
                                    customer.AuthorizeCusProfileId = SubscriptionResult.profile.customerProfileId;
                                    customer.AuthorizeCusPaymentProfileId = SubscriptionResult.profile.customerPaymentProfileId;
                                }

                                customer.IsActive = true;
                                cust.BillAmount = customer.BillAmount;
                                cust.PaymentMethod = customer.PaymentMethod;
                                cust.BillCycle = customer.BillCycle;
                                cust.FirstName = customer.FirstName;
                                cust.LastName = customer.LastName;
                                cust.BusinessName = customer.BusinessName;

                                cust.AuthorizeRefId = customer.AuthorizeRefId;
                                cust.AuthorizeCusProfileId = customer.AuthorizeCusProfileId;
                                cust.AuthorizeCusPaymentProfileId = customer.AuthorizeCusPaymentProfileId;
                                cust.AuthorizeDescription = customer.AuthorizeDescription;
                                cust.FirstBilling = customer.FirstBilling;
                                result = true;

                                try
                                {
                                    _Util.Facade.CustomerFacade.UpdateCustomer(cust);
                                }
                                catch (Exception ex)
                                {
                                    Elmah.ErrorSignal.FromCurrentContext().Raise(new Exception("UpdateCustomer E666"));
                                    Elmah.ErrorSignal.FromCurrentContext().Raise(ex);
                                }
                                HasAuthorizeMessage = true;
                                AuthorizeMessage = "Customer subscribed to authorize.net with subscription id " + SubscriptionResult.subscriptionId.ToString();

                                string ToEmail = cust.EmailAddress;
                                if (!string.IsNullOrWhiteSpace(customer.EmailAddress) && customer.EmailAddress.IsValidEmailAddress())
                                {
                                    ToEmail = customer.EmailAddress;
                                }
                                if (ToEmail.IsValidEmailAddress())
                                {
                                    #region Send subscription Notification to cusotmer 
                                    Guid EmpId = new Guid();
                                    string ReplyEmail = "info@rmrcloud.com";
                                    string ReplyName = "RMRCloud";
                                    if (Guid.TryParse(cust.Soldby, out EmpId) && EmpId != new Guid())
                                    {
                                        Employee salesPerson = _Util.Facade.EmployeeFacade.GetEmployeeByEmployeeId(EmpId);
                                        ReplyEmail = salesPerson.Email;
                                        ReplyName = string.Concat(salesPerson.FirstName, " ", salesPerson.LastName);
                                    }

                                    SubscribedToAthorizeNotification email = new SubscribedToAthorizeNotification()
                                    {
                                        ToEmail = customer.EmailAddress,
                                        BillingCycle = customer.BillCycle,
                                        PaymentMethod = customer.PaymentMethod,
                                        CompanyName = CurrentUser.CompanyName,
                                        CustomerName = string.Concat(customer.FirstName, " ", customer.LastName),
                                        SubscriptionAmount = string.Format("{0}{1}", LabelHelper.CurrentTransMakeCurrency.MakeCurrency(null), customer.BillAmount.Value.ToString("#,##0.00")),
                                        SubscriptionPeriod = (customer.ContractTeam == "-1" ? "Manual" : string.Format("{0} Year", customer.ContractTeam)),
                                        ReplyTo = ReplyEmail,
                                        ReplyToName = ReplyName,
                                        CompanyId = CurrentUser.CompanyId.Value
                                    };
                                    try
                                    {
                                        //_Util.Facade.MailFacade.SubscriptionNotificationEmail(email);
                                    }
                                    catch (Exception)
                                    {
                                        Elmah.ErrorSignal.FromCurrentContext().Raise(new Exception("SubscriptionNotificationEmail E555"));
                                    }

                                    #endregion
                                }
                                if (PaymentInfo.Id > 0)
                                {
                                    //var GetInfoPayment = _Util.Facade.PaymentInfoFacade.GetPaymentInfoById(PaymentInfo.Id);
                                    //if(GetInfoPayment != null)
                                    //{
                                    //    var DelPaymentInfo = _Util.Facade.PaymentInfoFacade.DeletePaymentInfoById(GetInfoPayment.Id);
                                    //}
                                    // PaymentInfo.CompanyId = currentLoggedIn.CompanyId.Value;
                                    //_Util.Facade.PaymentInfoFacade.UpdatePaymentInfo(PaymentInfo);

                                    if (customer.PaymentMethod == LabelHelper.PaymentMethod.CreditCard && PaymentInfo.CardNumber.IndexOf("******") > -1 && PaymentInfo.Id > 0)
                                    {
                                        PaymentInfo tmpPaymentInfo = _Util.Facade.PaymentInfoFacade.GetPaymentInfo_Card_ByCompanyIdAndCustomerId(CurrentUser.CompanyId.Value, customer.CustomerId);
                                        PaymentInfo.CardNumber = tmpPaymentInfo.CardNumber;
                                    }

                                    if (customer.PaymentMethod == LabelHelper.PaymentMethod.ACH && PaymentInfo.AcountNo.IndexOf("******") > -1 && PaymentInfo.Id > 0)
                                    {
                                        PaymentInfo tmpPaymentInfo = _Util.Facade.PaymentInfoFacade.GetPaymentInfo_Card_ByCompanyIdAndCustomerId(CurrentUser.CompanyId.Value, customer.CustomerId);
                                        PaymentInfo.AcountNo = tmpPaymentInfo.AcountNo;
                                    }

                                    if (customer.PaymentMethod == LabelHelper.PaymentMethod.ACH && PaymentInfo.RoutingNo.IndexOf("******") > -1 && PaymentInfo.Id > 0)
                                    {
                                        PaymentInfo tmpPaymentInfo = _Util.Facade.PaymentInfoFacade.GetPaymentInfo_Card_ByCompanyIdAndCustomerId(CurrentUser.CompanyId.Value, customer.CustomerId);
                                        PaymentInfo.RoutingNo = tmpPaymentInfo.RoutingNo;
                                    }

                                    PaymentInfo.CompanyId = CurrentUser.CompanyId.Value;
                                    PaymentInfo.IsCash = false;
                                    try
                                    {
                                        _Util.Facade.PaymentInfoFacade.UpdatePaymentInfo(PaymentInfo);
                                    }
                                    catch (Exception)
                                    {
                                        Elmah.ErrorSignal.FromCurrentContext().Raise(new Exception("UpdatePaymentInfo E111"));

                                    }
                                    //if (!string.IsNullOrWhiteSpace(cust.AuthorizeRefId))
                                    //{
                                    //    cust.IsRequiredCsvSync = true;
                                    //    _Util.Facade.CustomerFacade.UpdateCustomer(cust);
                                    //}

                                }
                                else
                                {
                                    PaymentInfo.CompanyId = CurrentUser.CompanyId.Value;
                                    PaymentInfo objInfoPay = new PaymentInfo()
                                    {
                                        CompanyId = PaymentInfo.CompanyId,
                                        AccountName = PaymentInfo.AccountName,
                                        BankAccountType = PaymentInfo.BankAccountType,
                                        RoutingNo = PaymentInfo.RoutingNo,
                                        AcountNo = PaymentInfo.AcountNo,
                                        CardNumber = PaymentInfo.CardNumber,
                                        CardExpireDate = PaymentInfo.CardExpireDate,
                                        CardSecurityCode = PaymentInfo.CardSecurityCode,
                                        EcheckType = PaymentInfo.EcheckType
                                    };
                                    try
                                    {
                                        _Util.Facade.PaymentInfoFacade.InsertPaymentInfo(objInfoPay);
                                    }
                                    catch (Exception)
                                    {
                                        Elmah.ErrorSignal.FromCurrentContext().Raise(new Exception("InsertPaymentInfo E222"));

                                    }

                                    PaymentInfoCustomer pic = new PaymentInfoCustomer()
                                    {
                                        CompanyId = CurrentUser.CompanyId.Value,
                                        CustomerId = cust.CustomerId,
                                        PaymentInfoId = objInfoPay.Id,
                                        Payfor = "MMR"
                                    };

                                    try
                                    {
                                        pic.Id = (int)_Util.Facade.PaymentInfoCustomerFacade.InsertPaymentInfoCustomer(pic);
                                    }
                                    catch (Exception)
                                    {
                                        Elmah.ErrorSignal.FromCurrentContext().Raise(new Exception("InsertPaymentInfoCustomer E333"));
                                    }
                                    cust.IsRequiredCsvSync = false;

                                    try
                                    {
                                        _Util.Facade.CustomerFacade.UpdateCustomer(cust);
                                    }
                                    catch (Exception)
                                    {
                                        Elmah.ErrorSignal.FromCurrentContext().Raise(new Exception("UpdateCustomer E444"));
                                    }

                                }
                            }
                        }
                        else if (SubscriptionResult != null)
                        {
                            HasAuthorizeMessage = true;
                            AuthorizeMessage = "Error: " + SubscriptionResult.messages.message[0].code + "  " + SubscriptionResult.messages.message[0].text;

                        }
                        #endregion
                    }
                }
                #endregion
            }
            else
            {
                result = false;
            }

            return Json(new
            {
                status = result,
                customerid = customer.Id,
                HasMessage = HasAuthorizeMessage,
                PaymentInfoId = PaymentInfo.Id,
                PaymentMethod = customer.PaymentMethod,
                AuthId = customer.AuthorizeRefId,
                AuthMessage = AuthorizeMessage
            });
        }

        [Authorize]
        [HttpPost]
        public JsonResult SubscribeToForte(Customer customer, PaymentInfo PaymentInfo)
        {
            bool result = false;
            bool HasForteMessage = false;
            string ForteMessage = "";
            string ForteId = "";
            string ForteCustomerId = "";
            string FortePaymentMethodId = "";
            bool PaymentInfoIsNull = true;
            var CurrentUser = (HS.Web.UI.Helper.CustomPrincipal)User;

            if (PaymentInfo.AccountName == "ProfilePackage")
            {
                PaymentInfo = _Util.Facade.PaymentInfoFacade.GetPaymentInfoById(PaymentInfo.Id);
            }


            if (customer.Id > 0)
            {

                Customer cust = _Util.Facade.CustomerFacade.GetById(customer.Id);
                //checking if there is enough payment ifo
                if (!string.IsNullOrWhiteSpace(PaymentInfo.BankAccountType) && !string.IsNullOrWhiteSpace(PaymentInfo.RoutingNo) && !string.IsNullOrWhiteSpace(PaymentInfo.AcountNo))
                {
                    PaymentInfoIsNull = false;
                }
                else if (!string.IsNullOrWhiteSpace(PaymentInfo.CardNumber) && !string.IsNullOrWhiteSpace(PaymentInfo.CardSecurityCode) && !string.IsNullOrWhiteSpace(PaymentInfo.CardExpireDate))
                {
                    PaymentInfoIsNull = false;
                }
                //if payment method is ach or credit card
                List<PaymentInfo> AllCustomerPaymentInfo = _Util.Facade.PaymentInfoFacade.GetAllPaymentInfoByCustomerIdAndCompanyId(customer.CustomerId, CurrentUser.CompanyId.Value);
                if ((customer.PaymentMethod == LabelHelper.PaymentMethod.ACH || customer.PaymentMethod == LabelHelper.PaymentMethod.CreditCard) && !PaymentInfoIsNull)
                {

                    if (customer.PaymentMethod == LabelHelper.PaymentMethod.CreditCard && PaymentInfo.CardNumber.IndexOf("******") > -1 && PaymentInfo.Id > 0)
                    {
                        PaymentInfo CreditCardInfo = AllCustomerPaymentInfo.FirstOrDefault(x => x.CardSecurityCode != "" && x.CardNumber != "" && x.CardExpireDate != "");
                        //PaymentInfo tmpPaymentInfo = _Util.Facade.PaymentInfoFacade.GetPaymentInfo_Card_ByCompanyIdAndCustomerId(CurrentUser.CompanyId.Value, customer.CustomerId);
                        PaymentInfo.CardNumber = DESEncryptionDecryption.DecryptCipherTextToPlainText(CreditCardInfo.CardNumber);
                    }
                    if (customer.PaymentMethod == LabelHelper.PaymentMethod.ACH && PaymentInfo.AcountNo.IndexOf("******") > -1 && PaymentInfo.Id > 0)
                    {
                        PaymentInfo ACHInfo = AllCustomerPaymentInfo.FirstOrDefault(x => x.BankAccountType != "" && x.EcheckType != "" && x.RoutingNo != "" && x.AcountNo != "");
                        //PaymentInfo tmpPaymentInfo = _Util.Facade.PaymentInfoFacade.GetPaymentInfo_Card_ByCompanyIdAndCustomerId(CurrentUser.CompanyId.Value, customer.CustomerId);
                        PaymentInfo.AcountNo = DESEncryptionDecryption.DecryptCipherTextToPlainText(ACHInfo.AcountNo);
                    }
                    if (customer.PaymentMethod == LabelHelper.PaymentMethod.ACH && PaymentInfo.RoutingNo.IndexOf("******") > -1 && PaymentInfo.Id > 0)
                    {
                        PaymentInfo ACHInfo = AllCustomerPaymentInfo.FirstOrDefault(x => x.BankAccountType != "" && x.EcheckType != "" && x.RoutingNo != "" && x.AcountNo != "");
                        //PaymentInfo tmpPaymentInfo = _Util.Facade.PaymentInfoFacade.GetPaymentInfo_Card_ByCompanyIdAndCustomerId(CurrentUser.CompanyId.Value, customer.CustomerId);
                        PaymentInfo.RoutingNo = DESEncryptionDecryption.DecryptCipherTextToPlainText(ACHInfo.RoutingNo);
                    }


                }
                else
                {
                    int PaymentProfileId = 0;
                    if (int.TryParse(customer.PaymentMethod, out PaymentProfileId) && PaymentProfileId > 0)
                    {
                        PaymentInfo paymentInfo = _Util.Facade.PaymentInfoFacade.GetPaymentInfoById(PaymentProfileId);
                        if (paymentInfo != null)
                        {
                            PaymentInfo = paymentInfo;
                            if (!string.IsNullOrWhiteSpace(paymentInfo.CardNumber) && !string.IsNullOrWhiteSpace(paymentInfo.CardExpireDate)
                                && !string.IsNullOrWhiteSpace(paymentInfo.CardSecurityCode))
                            {
                                PaymentInfo.CardNumber = PaymentInfo.CardNumber.Replace("-", "");
                                cust.PaymentMethod = LabelHelper.PaymentMethod.CreditCard;
                                customer.PaymentMethod = LabelHelper.PaymentMethod.CreditCard;
                                _Util.Facade.CustomerFacade.UpdateCustomer(cust);
                            }
                            else if (!string.IsNullOrWhiteSpace(paymentInfo.RoutingNo)
                               && !string.IsNullOrWhiteSpace(paymentInfo.AcountNo))
                            {
                                cust.PaymentMethod = LabelHelper.PaymentMethod.ACH;
                                customer.PaymentMethod = LabelHelper.PaymentMethod.ACH;
                                _Util.Facade.CustomerFacade.UpdateCustomer(cust);
                            }
                        }

                        PaymentInfoCustomer PIC = _Util.Facade.PaymentInfoCustomerFacade.GetByCustomerIdAndPayfor(cust.CustomerId, "MMR");

                        if (PIC != null)
                        {
                            PIC.PaymentInfoId = PaymentInfo.Id;
                            _Util.Facade.PaymentInfoCustomerFacade.UpdatePaymentInfoCustomer(PIC);
                        }
                        else
                        {
                            PIC = new PaymentInfoCustomer()
                            {
                                CustomerId = cust.CustomerId,
                                CompanyId = CurrentUser.CompanyId.Value,
                                Payfor = "MMR",
                                IsPaid = false,
                                PaymentInfoId = PaymentInfo.Id,

                            };
                            _Util.Facade.PaymentInfoCustomerFacade.InsertPaymentInfoCustomer(PIC);
                        }


                    }
                }
                if (PaymentInfo != null)
                {
                    if (string.IsNullOrWhiteSpace(cust.ScheduleToken) && string.IsNullOrWhiteSpace(customer.ScheduleToken))
                    {

                        if (customer.BillAmount == null)
                        {
                            customer.BillAmount = 0;
                        }

                        string ForteTransactionKey = _Util.Facade.GlobalSettingsFacade.GetForteTransactionKeyByCompanyId(CurrentUser.CompanyId.Value, (customer.PaymentMethod == LabelHelper.PaymentMethod.ACH));
                        string ForteAPILoginId = _Util.Facade.GlobalSettingsFacade.GetForteAPILoginIdByCompanyId(CurrentUser.CompanyId.Value, (customer.PaymentMethod == LabelHelper.PaymentMethod.ACH));
                        string ForteOrganizationId = _Util.Facade.GlobalSettingsFacade.GetForteOrganizationIdByCompanyId(CurrentUser.CompanyId.Value, (cust.PaymentMethod.ToLower() == "ach"));
                        string ForteLocationId = _Util.Facade.GlobalSettingsFacade.GetForteLocationIdByCompanyId(CurrentUser.CompanyId.Value, (cust.PaymentMethod.ToLower() == "ach"));
                        string ForteAuthAccountId = _Util.Facade.GlobalSettingsFacade.GetForteAuthAccountIdByCompanyId(CurrentUser.CompanyId.Value, (cust.PaymentMethod.ToLower() == "ach"));


                        PaymentInfo.CardNumber = string.IsNullOrWhiteSpace(PaymentInfo.CardNumber) ? "" : DESEncryptionDecryption.DecryptCipherTextToPlainText(PaymentInfo.CardNumber);
                        PaymentInfo.CardSecurityCode = string.IsNullOrWhiteSpace(PaymentInfo.CardSecurityCode) ? "" : DESEncryptionDecryption.DecryptCipherTextToPlainText(PaymentInfo.CardSecurityCode);
                        PaymentInfo.CardExpireDate = string.IsNullOrWhiteSpace(PaymentInfo.CardExpireDate) ? "" : DESEncryptionDecryption.DecryptCipherTextToPlainText(PaymentInfo.CardExpireDate);


                        //string FirstName = customer.FirstName;
                        //string LastName = customer.LastName;
                        //if (!string.IsNullOrWhiteSpace(PaymentInfo.AccountName))
                        //{
                        //    var str = PaymentInfo.AccountName.Replace("  ", " ").Split(' ');
                        //    if (str.Count() > 0)
                        //    {
                        //        var i = 1;
                        //        FirstName = str[0];
                        //        for (; i < str.Count() - 1; i++)
                        //        {
                        //            FirstName += " " + str[i];
                        //        }
                        //        if (str.Count() > 1)
                        //        {
                        //            LastName = str[i];
                        //        }
                        //        else
                        //        {
                        //            LastName = "";
                        //        }

                        //    }
                        //    else
                        //    {
                        //        FirstName = PaymentInfo.AccountName;
                        //        LastName = "";
                        //    }
                        //}

                        GlobalSetting globset = _Util.Facade.GlobalSettingsFacade.GetGlobalSettingsByKey(CurrentUser.CompanyId.Value, "ForteInProduction");


                        try
                        {

                            ForteOptions forte = new ForteOptions();
                            forte.Organization_ID = ForteOrganizationId;
                            forte.Location_Id = ForteLocationId;
                            forte.AuthAccountId = ForteAuthAccountId;

                            forte.UserId = ForteAPILoginId;
                            forte.Password = ForteTransactionKey;

                            System.Net.ServicePointManager.SecurityProtocol = System.Net.SecurityProtocolType.Ssl3
                                               | System.Net.SecurityProtocolType.Tls
                                               | System.Net.SecurityProtocolType.Tls11
                                               | System.Net.SecurityProtocolType.Tls12;
                            forte.Server = "https://sandbox.forte.net/api/v3";
                            if (globset != null && globset.Value.ToLower() == "true")
                            {
                                forte.Server = "https://api.forte.net/v3";
                            }

                            #region Customer Token Generate On Forte
                            ForteCustomerCreate customercreate = new ForteCustomerCreate();
                            if (string.IsNullOrEmpty(cust.CustomerToken) || cust.CustomerToken == "")
                            {

                                ForteCustomerService forteCustomer = new ForteCustomerService(forte);
                                ForteCustomer forteCust = new ForteCustomer();
                                //Possible Action: sale,disburse,authorize,verify,inquiry
                                forteCust.first_name = cust.FirstName;
                                forteCust.last_name = cust.LastName;
                                forteCust.company_name = cust.BusinessName;
                                forteCust.customer_id = cust.Id.ToString();
                                forteCust.location_id = ForteLocationId;


                                #region Create  CUstomer
                                customercreate = _Util.Facade.CustomerFacade.GetCustomerTokenForForte(forteCust, forteCustomer);

                                if (customercreate == null)
                                {
                                    result = false;
                                    ForteMessage = "Couldn't create customer account on forte. Please contact system admin.";
                                    return Json(new
                                    {
                                        status = result,
                                        customerid = customer.Id,
                                        HasMessage = HasForteMessage,
                                        PaymentInfoId = PaymentInfo.Id,
                                        PaymentMethod = customer.PaymentMethod,

                                        AuthMessage = ForteMessage
                                    });
                                }
                                #endregion

                                if (!string.IsNullOrEmpty(customercreate.CustomerToken))
                                {
                                    cust.CustomerToken = customercreate.CustomerToken;
                                    _Util.Facade.CustomerFacade.UpdateCustomer(cust);

                                }
                                else
                                {
                                    result = false;
                                    ForteMessage = customercreate.ErrorMessage;
                                    return Json(new
                                    {
                                        status = result,
                                        customerid = customer.Id,
                                        HasMessage = HasForteMessage,
                                        PaymentInfoId = PaymentInfo.Id,
                                        PaymentMethod = customer.PaymentMethod,

                                        AuthMessage = ForteMessage
                                    });
                                }
                            }
                            else
                            {
                                customercreate.CustomerToken = cust.CustomerToken;
                            }
                            forte.Customer_Token = customercreate.CustomerToken;
                            ForteCustomerId = customercreate.CustomerToken;
                            #endregion

                            #region Add Schedule On Forte
                            FortePaymethodsService fortePayService = new FortePaymethodsService(forte);
                            FortePaymethod fortePay = new FortePaymethod();

                            if ((customer.PaymentMethod == LabelHelper.PaymentMethod.CreditCard))
                            {
                                #region Get Card Type
                                string CardType = PaymentInfo.CardNumber.GetCardType();
                                if (CardType == LabelHelper.CardType.Visa)
                                {
                                    PaymentInfo.CardType = "visa";
                                }
                                else if (CardType == LabelHelper.CardType.MasterCard)
                                {
                                    PaymentInfo.CardType = "mast";
                                }
                                else if (CardType == LabelHelper.CardType.Discover)
                                {
                                    PaymentInfo.CardType = "disc";
                                }
                                else if (CardType == LabelHelper.CardType.AmericanExpress)
                                {
                                    PaymentInfo.CardType = "amex";
                                }
                                else
                                {
                                    result = false;
                                    ForteMessage = "Invalid Card Type.";
                                }
                                #endregion

                                string[] ExpDate = new string[10];
                                if (PaymentInfo.CardExpireDate.Contains('/'))
                                {
                                    ExpDate = PaymentInfo.CardExpireDate.Split('/');

                                }
                                else
                                {
                                    string expMonth = PaymentInfo.CardExpireDate.Substring(0, 2);
                                    string expYear = PaymentInfo.CardExpireDate.Substring(2, 2);


                                    ExpDate[0] = expMonth;
                                    ExpDate[1] = expYear;
                                }
                                if (ExpDate[1].Length == 2)
                                {
                                    ExpDate[1] = "20" + ExpDate[1];
                                }
                                fortePay.CardList = new List<ForteCard>
                                {
                                    new ForteCard
                                    {
                                        name_on_card = PaymentInfo.AccountName,
                                        card_type = PaymentInfo.CardType,
                                        account_number = PaymentInfo.CardNumber,
                                        expire_month = ExpDate[0].ToString(),
                                        expire_year = ExpDate[1].ToString(),
                                        card_verification_value = PaymentInfo.CardSecurityCode
                                    },
                                };
                                fortePay.notes = "Customer ID: " + customer.Id;
                                fortePay.card = JsonConvert.SerializeObject(fortePay.CardList);
                            }
                            else if ((customer.PaymentMethod == LabelHelper.PaymentMethod.ACH))
                            {
                                fortePay.AchCardList = new List<ForteAchCard>
                                {
                                    new ForteAchCard
                                    {
                                        account_holder = PaymentInfo.AccountName,
                                        routing_number = PaymentInfo.RoutingNo,
                                        account_number = PaymentInfo.AcountNo,
                                        account_type = PaymentInfo.BankAccountType,

                                    },
                                };
                                fortePay.notes = "Customer ID: " + customer.Id;
                                fortePay.echeck = JsonConvert.SerializeObject(fortePay.AchCardList);
                            }


                            FortePaymentCreate paymentInfo = new FortePaymentCreate();
                            if (string.IsNullOrEmpty(cust.PaymentToken) || cust.PaymentToken == "")
                            {
                                paymentInfo = _Util.Facade.CustomerFacade.GetPaymentTokenForForte(fortePay, fortePayService);

                                if (!string.IsNullOrEmpty(paymentInfo.PaymentToken) && paymentInfo.Result)
                                {
                                    cust.PaymentToken = paymentInfo.PaymentToken;
                                    _Util.Facade.CustomerFacade.UpdateCustomer(cust);
                                    paymentInfo.PaymentToken = cust.PaymentToken;
                                }
                                else
                                {
                                    result = false;
                                    ForteMessage = paymentInfo.ErrorMessage;
                                    return Json(new
                                    {
                                        status = result,
                                        customerid = customer.Id,
                                        HasMessage = HasForteMessage,
                                        PaymentInfoId = PaymentInfo.Id,
                                        PaymentMethod = customer.PaymentMethod,

                                        AuthMessage = ForteMessage
                                    });
                                }
                            }
                            else
                            {
                                paymentInfo.PaymentToken = cust.PaymentToken;
                            }
                            FortePaymentMethodId = cust.PaymentToken;
                            #region Create Schedule
                            ForteScheduleService forteScheduleService = new ForteScheduleService(forte);
                            ForteSchedule forteSchedule = new ForteSchedule();

                            forteSchedule.schedule_amount = customer.BillAmount.ToString();
                            forteSchedule.schedule_start_date = customer.FirstBilling.ToString();
                            forteSchedule.schedule_quantity = "0";
                            forteSchedule.paymethod_token = paymentInfo.PaymentToken;
                            forteSchedule.schedule_frequency = customer.BillCycle.ToLower();
                            forteSchedule.action = "sale";
                            if (string.IsNullOrEmpty(cust.ScheduleToken) || cust.ScheduleToken == "")
                            {
                                ForteResponseDetails forteResponse = _Util.Facade.CustomerFacade.MakeScheduleForCustomer(forteSchedule, forteScheduleService);
                                if (forteResponse.Result)
                                {
                                    cust.ScheduleToken = forteResponse.ScheduleToken;
                                    cust.FirstBilling = customer.FirstBilling;
                                    cust.BillAmount = customer.BillAmount;
                                    cust.BillCycle = customer.BillCycle;
                                    cust.MonthlyMonitoringFee = customer.MonthlyMonitoringFee;
                                    cust.BillTax = customer.BillTax;
                                    _Util.Facade.CustomerFacade.UpdateCustomer(cust);
                                    ForteMessage = forteResponse.Massege;
                                    result = true;
                                    HasForteMessage = true;
                                    ForteId = forteResponse.ScheduleToken;

                                }
                                else
                                {
                                    result = false;
                                    ForteMessage = forteResponse.ErrorMessage;
                                    return Json(new
                                    {
                                        status = result,

                                        AuthMessage = ForteMessage

                                    });
                                }
                            }
                            #endregion
                            #endregion


                        }
                        catch (Exception ex)
                        {
                            //Elmah.ErrorSignal.FromCurrentContext().Raise(new Exception("SubscriptionResult E7878"));
                            result = false;
                            ForteMessage = "Internal Error.";
                        }
                    }
                }

            }
            else
            {
                Elmah.ErrorSignal.FromCurrentContext().Raise(new Exception("No Customer found!"));

                result = false;
            }

            return Json(new
            {
                status = result,
                customerid = customer.Id,
                HasMessage = HasForteMessage,
                PaymentInfoId = PaymentInfo.Id,
                PaymentMethod = customer.PaymentMethod,
                ForteId = ForteId,
                ForteCustomerId = ForteCustomerId,
                FortePaymentMethodId = FortePaymentMethodId,
                AuthMessage = ForteMessage
            });

        }
        [Authorize]
        [HttpPost]
        public JsonResult UpdateAuthorizeSubscription(Customer customer, PaymentInfo PaymentInfo)
        {
            bool result = false;
            string AuthorizeMessage = "";
            bool PaymentInfoIsNull = true;
            var CurrentUser = (HS.Web.UI.Helper.CustomPrincipal)User;
            if (PaymentInfo.AccountName == "ProfilePackage")
            {
                PaymentInfo = _Util.Facade.PaymentInfoFacade.GetPaymentInfoById(PaymentInfo.Id);
            }

            if (customer.Id > 0)
            {
                #region ARB Subscription

                Customer cust = _Util.Facade.CustomerFacade.GetById(customer.Id);
                if (cust == null || cust.CustomerId != customer.CustomerId)
                {
                    return Json(new { result = result, message = "invalid customer." });
                }
                else if (string.IsNullOrWhiteSpace(cust.AuthorizeRefId))
                {
                    return Json(new
                    {
                        result = result,
                        AuthId = cust.AuthorizeRefId,
                        message = "Not subscribed to authorize.net yet."
                    });
                }
                //checking if there is enough payment ifo
                if (!string.IsNullOrWhiteSpace(PaymentInfo.BankAccountType) && !string.IsNullOrWhiteSpace(PaymentInfo.RoutingNo) && !string.IsNullOrWhiteSpace(PaymentInfo.AcountNo))
                {
                    PaymentInfoIsNull = false;
                }
                else if (!string.IsNullOrWhiteSpace(PaymentInfo.CardNumber) && !string.IsNullOrWhiteSpace(PaymentInfo.CardSecurityCode) && !string.IsNullOrWhiteSpace(PaymentInfo.CardExpireDate))
                {
                    PaymentInfoIsNull = false;
                }
                if (PaymentInfoIsNull)
                {
                    return Json(new
                    {
                        result = result,
                        AuthId = cust.AuthorizeRefId,
                        HasMessage = true,
                        message = "Not enough payment info provided."
                    });
                }
                //if payment method is ach or credit card
                if (customer.PaymentMethod == LabelHelper.PaymentMethod.ACH
                    || customer.PaymentMethod == LabelHelper.PaymentMethod.CreditCard
                    || customer.PaymentMethod == LabelHelper.PaymentMethod.GetwayExisting
                    )
                {

                    if (customer.PaymentMethod == LabelHelper.PaymentMethod.CreditCard && PaymentInfo.CardNumber.IndexOf("******") > -1 && PaymentInfo.Id > 0)
                    {
                        PaymentInfo tmpPaymentInfo = _Util.Facade.PaymentInfoFacade.GetPaymentInfo_Card_ByCompanyIdAndCustomerId(CurrentUser.CompanyId.Value, customer.CustomerId);
                        PaymentInfo.CardNumber = DESEncryptionDecryption.DecryptCipherTextToPlainText(tmpPaymentInfo.CardNumber);
                    }

                    if (customer.PaymentMethod == LabelHelper.PaymentMethod.ACH && PaymentInfo.AcountNo.IndexOf("******") > -1 && PaymentInfo.Id > 0)
                    {
                        PaymentInfo tmpPaymentInfo = _Util.Facade.PaymentInfoFacade.GetPaymentInfo_Card_ByCompanyIdAndCustomerId(CurrentUser.CompanyId.Value, customer.CustomerId);
                        PaymentInfo.AcountNo = DESEncryptionDecryption.DecryptCipherTextToPlainText(tmpPaymentInfo.AcountNo);
                    }

                    if (customer.PaymentMethod == LabelHelper.PaymentMethod.ACH && PaymentInfo.RoutingNo.IndexOf("******") > -1 && PaymentInfo.Id > 0)
                    {
                        PaymentInfo tmpPaymentInfo = _Util.Facade.PaymentInfoFacade.GetPaymentInfo_Card_ByCompanyIdAndCustomerId(CurrentUser.CompanyId.Value, customer.CustomerId);
                        PaymentInfo.RoutingNo = DESEncryptionDecryption.DecryptCipherTextToPlainText(tmpPaymentInfo.RoutingNo);
                    }

                    if (!string.IsNullOrWhiteSpace(cust.AuthorizeRefId) && !string.IsNullOrWhiteSpace(customer.AuthorizeRefId))
                    {
                        #region if there is authorize ref id ; update subscription
                        if (customer.BillAmount == null)
                        {
                            customer.BillAmount = 0;
                        }

                        string TransactionKey = _Util.Facade.GlobalSettingsFacade.GetAuthTransactionKeyByCompanyId(CurrentUser.CompanyId.Value, (customer.PaymentMethod == LabelHelper.PaymentMethod.ACH));
                        string APILoginId = _Util.Facade.GlobalSettingsFacade.GetAuthAPILoginIdByCompanyId(CurrentUser.CompanyId.Value, (customer.PaymentMethod == LabelHelper.PaymentMethod.ACH));

                        PaymentInfo.CardNumber = string.IsNullOrWhiteSpace(PaymentInfo.CardNumber) ? "" : PaymentInfo.CardNumber;
                        PaymentInfo.CardSecurityCode = string.IsNullOrWhiteSpace(PaymentInfo.CardSecurityCode) ? "" : PaymentInfo.CardSecurityCode;
                        PaymentInfo.CardExpireDate = string.IsNullOrWhiteSpace(PaymentInfo.CardExpireDate) ? "" : PaymentInfo.CardExpireDate;
                        #region Getting BillingFirstName And BillingLastName From Given Name
                        string FirstName = customer.FirstName;
                        string LastName = customer.LastName;
                        if (!string.IsNullOrWhiteSpace(PaymentInfo.AccountName))
                        {
                            var str = PaymentInfo.AccountName.Replace("  ", " ").Split(' ');
                            if (str.Count() > 0)
                            {
                                var i = 1;
                                FirstName = str[0];
                                for (; i < str.Count() - 1; i++)
                                {
                                    FirstName += " " + str[i];
                                }
                                if (str.Count() > 1)
                                {
                                    LastName = str[i];
                                }
                                else
                                {
                                    LastName = "";
                                }

                            }
                            else
                            {
                                FirstName = PaymentInfo.AccountName;
                                LastName = "";
                            }
                        }
                        #endregion
                        ARBSubscription Subscription = new ARBSubscription()
                        {
                            CustomerId = customer.Id.ToString(),
                            FirstName = customer.FirstName,
                            LastName = customer.LastName,

                            BillingFirstName = FirstName,
                            BillingLastName = LastName,

                            PaymentMethod = customer.PaymentMethod,
                            CompanyName = customer.BusinessName,
                            //CustomerId = customer.CustomerNo,
                            //NameOnCard = PaymentInfo.AccountName,
                            CardNumber = PaymentInfo.CardNumber.Replace(" ", ""),
                            CardPassword = PaymentInfo.CardSecurityCode,
                            ExpirationDate = PaymentInfo.CardExpireDate.Replace("/", ""),

                            SubscritptionAmount = (decimal)customer.BillAmount,
                            SubscriptionInterval = 1,
                            BankAccountType = PaymentInfo.BankAccountType,
                            BankAccountNumber = PaymentInfo.AcountNo,
                            BankARBRoutingNumber = PaymentInfo.RoutingNo,
                            ECheckType = PaymentInfo.EcheckType,
                            NameOnBankAccount = PaymentInfo.AccountName,
                            BankName = PaymentInfo.BankName,
                            TotalOccurrences = 999,
                            Invoice = customer.CustomerNo,
                            Description = customer.AuthorizeDescription
                            //Invoice = LabelHelper.InvoiceNumberForARB.MonitoringFee,
                        };
                        if (customer.EmailAddress.IsValidEmailAddress())
                        {
                            Subscription.EmailAddress = customer.EmailAddress;
                        }
                        if (!string.IsNullOrWhiteSpace(PaymentInfo.AccountName))
                        {
                            RegexOptions options = RegexOptions.None;
                            Regex regex = new Regex("[ ]{2,}", options);
                            PaymentInfo.AccountName = regex.Replace(PaymentInfo.AccountName, " ");

                            if (PaymentInfo.AccountName.Length > 4 && PaymentInfo.AccountName.IndexOf(" ") > 1)
                            {
                                Subscription.FirstName = PaymentInfo.AccountName.Split(' ')[0];
                                Subscription.LastName = PaymentInfo.AccountName.Split(' ')[1];
                            }
                        }

                        #region Subscription starts

                        if (!string.IsNullOrWhiteSpace(customer.BillCycle) && customer.BillCycle != "-1")
                        {
                            if (customer.BillCycle == LabelHelper.BillCycle.Monthly)
                            {
                                Subscription.SubscriptionInterval = 1;
                            }
                            else if (customer.BillCycle == LabelHelper.BillCycle.Quarterly)
                            {
                                Subscription.SubscriptionInterval = 3;
                            }
                            else if (customer.BillCycle == LabelHelper.BillCycle.SemiAnnual)
                            {
                                Subscription.SubscriptionInterval = 6;
                            }
                            else if (customer.BillCycle == LabelHelper.BillCycle.Annual)
                            {
                                Subscription.SubscriptionInterval = 12;
                            }
                        }

                        if (customer.FirstBilling.HasValue)
                        {
                            customer.FirstBilling = customer.FirstBilling.Value.SetZeroHour();
                            //if (customer.FirstBilling.Value <= DateTime.Now.UTCCurrentTime().SetZeroHour())
                            //{
                            //    Subscription.SubscriptionStartDate = DateTime.Now.UTCCurrentTime().SetZeroHour().AddDays(1);
                            //}
                            //else
                            //{
                            //    Subscription.SubscriptionStartDate = customer.FirstBilling.Value;
                            //}
                            Subscription.SubscriptionStartDate = customer.FirstBilling.Value;
                        }
                        //else
                        //{
                        //    //Subscription.SubscriptionStartDate = DateTime.Today.AddDays(1);
                        //    //customer.FirstBilling = Subscription.SubscriptionStartDate;
                        //}
                        #endregion
                        bool AuthInProduction = false;
                        GlobalSetting globset = _Util.Facade.GlobalSettingsFacade.GetGlobalSettingsByKey(CurrentUser.CompanyId.Value, "Authorize.NetInProduction");
                        if (globset != null && globset.Value.ToLower() == "true")
                        {
                            AuthInProduction = true;
                        }

                        bool UseExistingPaymentProfile = false;
                        if (customer.PaymentMethod == LabelHelper.PaymentMethod.GetwayExisting)
                        {
                            UseExistingPaymentProfile = true;
                        }
                        ARBUpdateSubscriptionResponse SubscriptionResult = UpdateSubscription.Run(APILoginId, TransactionKey, customer.AuthorizeRefId, Subscription, AuthInProduction, UseExistingPaymentProfile);

                        if (SubscriptionResult != null && SubscriptionResult.messages.resultCode == messageTypeEnum.Ok)
                        {
                            if (SubscriptionResult != null && SubscriptionResult.messages.message != null)
                            {
                                if (SubscriptionResult.profile != null)
                                {
                                    customer.AuthorizeCusProfileId = SubscriptionResult.profile.customerProfileId;
                                    customer.AuthorizeCusPaymentProfileId = SubscriptionResult.profile.customerPaymentProfileId;
                                }
                                customer.IsRequiredCsvSync = false;
                                customer.IsActive = true;
                                cust.BillAmount = customer.BillAmount;
                                cust.PaymentMethod = customer.PaymentMethod;
                                cust.BillCycle = customer.BillCycle;
                                cust.FirstName = customer.FirstName;
                                cust.LastName = customer.LastName;
                                cust.BusinessName = customer.BusinessName;

                                cust.AuthorizeRefId = customer.AuthorizeRefId;
                                cust.AuthorizeCusProfileId = customer.AuthorizeCusProfileId;
                                cust.AuthorizeCusPaymentProfileId = customer.AuthorizeCusPaymentProfileId;
                                cust.AuthorizeDescription = customer.AuthorizeDescription;
                                cust.FirstBilling = customer.FirstBilling;

                                _Util.Facade.CustomerFacade.UpdateCustomer(cust);
                                result = true;
                                AuthorizeMessage = "Customer authorize.net subscription updated successfully.";

                                if (PaymentInfo.Id > 0)
                                {
                                    //var GetInfoPayment = _Util.Facade.PaymentInfoFacade.GetPaymentInfoById(PaymentInfo.Id);
                                    //if(GetInfoPayment != null)
                                    //{
                                    //    var DelPaymentInfo = _Util.Facade.PaymentInfoFacade.DeletePaymentInfoById(GetInfoPayment.Id);
                                    //}
                                    // PaymentInfo.CompanyId = currentLoggedIn.CompanyId.Value;
                                    PaymentInfo.CompanyId = CurrentUser.CompanyId.Value;
                                    _Util.Facade.PaymentInfoFacade.UpdatePaymentInfo(PaymentInfo);
                                }
                                else
                                {
                                    PaymentInfo.CompanyId = CurrentUser.CompanyId.Value;
                                    PaymentInfo objInfoPay = new PaymentInfo()
                                    {
                                        CompanyId = PaymentInfo.CompanyId,
                                        AccountName = PaymentInfo.AccountName,
                                        BankAccountType = PaymentInfo.BankAccountType,
                                        RoutingNo = PaymentInfo.RoutingNo,
                                        AcountNo = PaymentInfo.AcountNo,
                                        CardNumber = PaymentInfo.CardNumber,
                                        CardExpireDate = PaymentInfo.CardExpireDate,
                                        CardSecurityCode = PaymentInfo.CardSecurityCode,
                                        EcheckType = PaymentInfo.EcheckType
                                    };
                                    _Util.Facade.PaymentInfoFacade.InsertPaymentInfo(objInfoPay);
                                    PaymentInfoCustomer pic = new PaymentInfoCustomer()
                                    {
                                        CompanyId = CurrentUser.CompanyId.Value,
                                        CustomerId = cust.CustomerId,
                                        PaymentInfoId = objInfoPay.Id,
                                        Payfor = "MMR"
                                    };
                                    pic.Id = (int)_Util.Facade.PaymentInfoCustomerFacade.InsertPaymentInfoCustomer(pic);
                                }


                            }
                        }
                        else if (SubscriptionResult != null)
                        {
                            result = false;
                            AuthorizeMessage = "Error: " + SubscriptionResult.messages.message[0].code + "  " + SubscriptionResult.messages.message[0].text;

                        }
                        else
                        {
                            result = false;
                            AuthorizeMessage = "Error: E0003 An unknown error has been occurred. Please contact system admin for further assistance.";
                        }
                        #endregion
                    }
                }
                #endregion
            }
            else
            {
                result = false;
            }

            return Json(new
            {
                result = result,
                customerid = customer.Id,
                PaymentInfoId = PaymentInfo.Id,
                PaymentMethod = customer.PaymentMethod,
                AuthId = customer.AuthorizeRefId,
                message = AuthorizeMessage
            });
        }


        [Authorize]
        [HttpPost]
        public JsonResult UpdateForteSubscription(Customer customer, PaymentInfo PaymentInfo)
        {
            bool result = false;
            bool HasForteMessage = false;
            string ForteMessage = "";
            bool PaymentInfoIsNull = true;
            var CurrentUser = (HS.Web.UI.Helper.CustomPrincipal)User;

            if (PaymentInfo.AccountName == "ProfilePackage")
            {
                PaymentInfo = _Util.Facade.PaymentInfoFacade.GetPaymentInfoById(PaymentInfo.Id);
            }
            if (customer.Id > 0)
            {
                Customer cust = _Util.Facade.CustomerFacade.GetById(customer.Id);
                if (cust == null || cust.CustomerId != customer.CustomerId)
                {
                    return Json(new { status = false, message = "invalid customer." });
                }
                else if (string.IsNullOrWhiteSpace(cust.ScheduleToken))
                {
                    return Json(new
                    {
                        status = true,
                        AuthId = cust.ScheduleToken,
                        HasMessage = true,
                        ForteMessage = "Not subscribed to Forte yet."
                    });
                }
                //checking if there is enough payment ifo
                if (!string.IsNullOrWhiteSpace(PaymentInfo.BankAccountType) && !string.IsNullOrWhiteSpace(PaymentInfo.RoutingNo) && !string.IsNullOrWhiteSpace(PaymentInfo.AcountNo))
                {
                    PaymentInfoIsNull = false;
                }
                else if (!string.IsNullOrWhiteSpace(PaymentInfo.CardNumber) && !string.IsNullOrWhiteSpace(PaymentInfo.CardSecurityCode) && !string.IsNullOrWhiteSpace(PaymentInfo.CardExpireDate))
                {
                    PaymentInfoIsNull = false;
                }
                if (PaymentInfoIsNull)
                {
                    return Json(new
                    {
                        status = true,
                        AuthId = cust.AuthorizeRefId,
                        HasMessage = true,
                        AuthMessage = "Not enough payment info provided."
                    });
                }
                //if payment method is ach or credit card
                if ((customer.PaymentMethod == LabelHelper.PaymentMethod.ACH || customer.PaymentMethod == LabelHelper.PaymentMethod.CreditCard))
                {
                    List<PaymentInfo> AllCustomerPaymentInfo = _Util.Facade.PaymentInfoFacade.GetAllPaymentInfoByCustomerIdAndCompanyId(customer.CustomerId, CurrentUser.CompanyId.Value);
                    if (customer.PaymentMethod == LabelHelper.PaymentMethod.CreditCard && PaymentInfo.CardNumber.IndexOf("******") > -1 && PaymentInfo.Id > 0)
                    {


                        var CreditCardInfo = AllCustomerPaymentInfo.Where(x => x.CardSecurityCode != "" && x.CardNumber != "" && x.CardExpireDate != "").FirstOrDefault();
                        //PaymentInfo tmpPaymentInfo = _Util.Facade.PaymentInfoFacade.GetPaymentInfo_Card_ByCompanyIdAndCustomerId(CurrentUser.CompanyId.Value, customer.CustomerId);
                        PaymentInfo.CardNumber = DESEncryptionDecryption.DecryptCipherTextToPlainText(CreditCardInfo.CardNumber);
                    }

                    if (customer.PaymentMethod == LabelHelper.PaymentMethod.ACH && PaymentInfo.AcountNo.IndexOf("******") > -1 && PaymentInfo.Id > 0)
                    {
                        var ACHInfo = AllCustomerPaymentInfo.Where(x => x.BankAccountType != "" && x.EcheckType != "" && x.RoutingNo != "" && x.AcountNo != "").FirstOrDefault();
                        //PaymentInfo tmpPaymentInfo = _Util.Facade.PaymentInfoFacade.GetPaymentInfo_Card_ByCompanyIdAndCustomerId(CurrentUser.CompanyId.Value, customer.CustomerId);
                        PaymentInfo.AcountNo = DESEncryptionDecryption.DecryptCipherTextToPlainText(ACHInfo.AcountNo);
                    }
                    if (customer.PaymentMethod == LabelHelper.PaymentMethod.ACH && PaymentInfo.RoutingNo.IndexOf("******") > -1 && PaymentInfo.Id > 0)
                    {
                        var ACHInfo = AllCustomerPaymentInfo.Where(x => x.BankAccountType != "" && x.EcheckType != "" && x.RoutingNo != "" && x.AcountNo != "").FirstOrDefault();
                        //PaymentInfo tmpPaymentInfo = _Util.Facade.PaymentInfoFacade.GetPaymentInfo_Card_ByCompanyIdAndCustomerId(CurrentUser.CompanyId.Value, customer.CustomerId);
                        PaymentInfo.RoutingNo = DESEncryptionDecryption.DecryptCipherTextToPlainText(ACHInfo.RoutingNo);
                    }

                    if (!string.IsNullOrWhiteSpace(cust.ScheduleToken))
                    {

                        if (customer.BillAmount == null)
                        {
                            customer.BillAmount = 0;
                        }

                        string ForteTransactionKey = _Util.Facade.GlobalSettingsFacade.GetForteTransactionKeyByCompanyId(CurrentUser.CompanyId.Value, (customer.PaymentMethod == LabelHelper.PaymentMethod.ACH));
                        string ForteAPILoginId = _Util.Facade.GlobalSettingsFacade.GetForteAPILoginIdByCompanyId(CurrentUser.CompanyId.Value, (customer.PaymentMethod == LabelHelper.PaymentMethod.ACH));
                        string ForteOrganizationId = _Util.Facade.GlobalSettingsFacade.GetForteOrganizationIdByCompanyId(CurrentUser.CompanyId.Value, (cust.PaymentMethod.ToLower() == "ach"));
                        string ForteLocationId = _Util.Facade.GlobalSettingsFacade.GetForteLocationIdByCompanyId(CurrentUser.CompanyId.Value, (cust.PaymentMethod.ToLower() == "ach"));
                        string ForteAuthAccountId = _Util.Facade.GlobalSettingsFacade.GetForteAuthAccountIdByCompanyId(CurrentUser.CompanyId.Value, (cust.PaymentMethod.ToLower() == "ach"));


                        PaymentInfo.CardNumber = string.IsNullOrWhiteSpace(PaymentInfo.CardNumber) ? "" : PaymentInfo.CardNumber;
                        PaymentInfo.CardSecurityCode = string.IsNullOrWhiteSpace(PaymentInfo.CardSecurityCode) ? "" : PaymentInfo.CardSecurityCode;
                        PaymentInfo.CardExpireDate = string.IsNullOrWhiteSpace(PaymentInfo.CardExpireDate) ? "" : PaymentInfo.CardExpireDate;

                        string FirstName = customer.FirstName;
                        string LastName = customer.LastName;
                        if (!string.IsNullOrWhiteSpace(PaymentInfo.AccountName))
                        {
                            var str = PaymentInfo.AccountName.Replace("  ", " ").Split(' ');
                            if (str.Count() > 0)
                            {
                                var i = 1;
                                FirstName = str[0];
                                for (; i < str.Count() - 1; i++)
                                {
                                    FirstName += " " + str[i];
                                }
                                if (str.Count() > 1)
                                {
                                    LastName = str[i];
                                }
                                else
                                {
                                    LastName = "";
                                }

                            }
                            else
                            {
                                FirstName = PaymentInfo.AccountName;
                                LastName = "";
                            }
                        }


                        try
                        {


                            ForteOptions forte = new ForteOptions();
                            forte.Organization_ID = ForteOrganizationId;
                            forte.Location_Id = ForteLocationId;
                            forte.AuthAccountId = ForteAuthAccountId;
                            forte.Paymethod_Token = cust.PaymentToken;
                            forte.UserId = ForteAPILoginId;
                            forte.Password = ForteTransactionKey;

                            System.Net.ServicePointManager.SecurityProtocol = System.Net.SecurityProtocolType.Ssl3
                                               | System.Net.SecurityProtocolType.Tls
                                               | System.Net.SecurityProtocolType.Tls11
                                               | System.Net.SecurityProtocolType.Tls12;
                            forte.Server = "https://sandbox.forte.net/api/v3";

                            GlobalSetting globset = _Util.Facade.GlobalSettingsFacade.GetGlobalSettingsByKey(CurrentUser.CompanyId.Value, "ForteInProduction");
                            if (globset != null && globset.Value.ToLower() == "true")
                            {
                                forte.Server = "https://api.forte.net/v3";
                            }
                            forte.Paymethod_Token = null;
                            FortePaymethodsService fortePayService = new FortePaymethodsService(forte);
                            FortePaymethod fortePay = new FortePaymethod();
                            if ((customer.PaymentMethod == LabelHelper.PaymentMethod.CreditCard))
                            {
                                #region Get Card Type
                                string CardType = PaymentInfo.CardNumber.GetCardType();
                                if (CardType == LabelHelper.CardType.Visa)
                                {
                                    PaymentInfo.CardType = "visa";
                                }
                                else if (CardType == LabelHelper.CardType.MasterCard)
                                {
                                    PaymentInfo.CardType = "mast";
                                }
                                else if (CardType == LabelHelper.CardType.Discover)
                                {
                                    PaymentInfo.CardType = "disc";
                                }
                                else if (CardType == LabelHelper.CardType.AmericanExpress)
                                {
                                    PaymentInfo.CardType = "amex";
                                }
                                else
                                {
                                    result = false;
                                    ForteMessage = "Invalid Card Type.";
                                }
                                #endregion


                                string[] ExpDate = new string[10];
                                if (PaymentInfo.CardExpireDate.Contains('/'))
                                {
                                    ExpDate = PaymentInfo.CardExpireDate.Split('/');
                                }
                                else
                                {
                                    string expMonth = PaymentInfo.CardExpireDate.Substring(0, 2);
                                    string expYear = PaymentInfo.CardExpireDate.Substring(2, 2);

                                    ExpDate[0] = expMonth;
                                    ExpDate[1] = expYear;
                                }

                                //fortePay.UpdateCardList = new List<UpdatePayInfoForCreditCard>
                                //{
                                //    new UpdatePayInfoForCreditCard
                                //    {
                                //        name_on_card = PaymentInfo.AccountName,
                                //        card_type = PaymentInfo.CardType,
                                //        expire_month = ExpDate[0].ToString(),
                                //        expire_year = "20"+ExpDate[1].ToString(),

                                //    },
                                //};

                                if (ExpDate[1].Length == 2)
                                {
                                    ExpDate[1] = "20" + ExpDate[1];
                                }
                                fortePay.CardList = new List<ForteCard>
                                {
                                    new ForteCard
                                    {
                                        name_on_card = PaymentInfo.AccountName,
                                        card_type = PaymentInfo.CardType,
                                        account_number = PaymentInfo.CardNumber,
                                        expire_month = ExpDate[0].ToString(),
                                        expire_year = ExpDate[1].ToString(),
                                        card_verification_value = PaymentInfo.CardSecurityCode
                                    },
                                };
                                fortePay.notes = "Customer ID: " + customer.Id;
                                fortePay.card = JsonConvert.SerializeObject(fortePay.CardList);
                            }
                            else if ((customer.PaymentMethod == LabelHelper.PaymentMethod.ACH))
                            {
                                fortePay.AchCardList = new List<ForteAchCard>
                                {
                                    new ForteAchCard
                                    {
                                        account_holder = PaymentInfo.AccountName,
                                        routing_number = PaymentInfo.RoutingNo,
                                        account_number = PaymentInfo.AcountNo,
                                        account_type = PaymentInfo.BankAccountType,

                                    },
                                };
                                fortePay.notes = "Customer ID: " + customer.Id;
                                fortePay.echeck = JsonConvert.SerializeObject(fortePay.AchCardList);
                            }


                            FortePaymentCreate paymentInfo = new FortePaymentCreate();

                            paymentInfo = _Util.Facade.CustomerFacade.GetPaymentTokenForForte(fortePay, fortePayService);

                            if (!string.IsNullOrEmpty(paymentInfo.PaymentToken) && paymentInfo.Result == true)
                            {
                                cust.PaymentToken = paymentInfo.PaymentToken;
                                _Util.Facade.CustomerFacade.UpdateCustomer(cust);
                                paymentInfo.PaymentToken = cust.PaymentToken;
                            }
                            else
                            {
                                result = false;
                                ForteMessage = "Invalid input field";

                                return Json(new
                                {
                                    status = result,
                                    HasMessage = HasForteMessage,
                                    PaymentInfoId = PaymentInfo.Id,
                                    PaymentMethod = customer.PaymentMethod,
                                    AuthId = customer.ScheduleToken,
                                    ForteMessage = ForteMessage
                                });
                            }
                            forte.Paymethod_Token = "";
                            forte.Customer_Token = cust.CustomerToken;
                            ForteCustomerService forteCustomer = new ForteCustomerService(forte);
                            UpdateCustomerWithPaymentToken forteCust = new UpdateCustomerWithPaymentToken();

                            forteCust.paymethod_token = paymentInfo.PaymentToken;
                            ForteCustomerCreate cusInfo = new ForteCustomerCreate();

                            cusInfo = _Util.Facade.CustomerFacade.UpdateCustomerForForte(forteCust, forteCustomer);
                            if (!string.IsNullOrEmpty(cusInfo.PaymentToken) && cusInfo.Result == true)
                            {
                                cust.PaymentToken = cusInfo.PaymentToken;
                                _Util.Facade.CustomerFacade.UpdateCustomer(cust);
                                cusInfo.PaymentToken = cust.PaymentToken;
                            }
                            else
                            {
                                result = false;
                                ForteMessage = cusInfo.ErrorMessage;

                                return Json(new
                                {
                                    status = result,
                                    HasMessage = HasForteMessage,
                                    PaymentInfoId = PaymentInfo.Id,
                                    PaymentMethod = customer.PaymentMethod,
                                    AuthId = customer.ScheduleToken,
                                    ForteMessage = ForteMessage
                                });
                            }
                            forte.Paymethod_Token = null;
                            forte.Customer_Token = null;
                            forte.Schedule_Id = cust.ScheduleToken;
                            ForteScheduleService forteScheduleService = new ForteScheduleService(forte);
                            ForteSchedule forteSchedule = new ForteSchedule();
                            forteSchedule.paymethod_token = cusInfo.PaymentToken;

                            ForteResponseDetails forteResponse = _Util.Facade.CustomerFacade.UpdateScheduleForCustomer(forteSchedule, forteScheduleService);
                            if (forteResponse.Result == true)
                            {
                                cust.ScheduleToken = forteResponse.ScheduleToken;
                                cust.IsRequiredCsvSync = false;
                                _Util.Facade.CustomerFacade.UpdateCustomer(cust);
                                ForteMessage = forteResponse.Massege;
                                result = true;
                                HasForteMessage = true;


                            }
                            else
                            {
                                result = false;
                                ForteMessage = forteResponse.ErrorMessage;
                                HasForteMessage = false;
                            }


                        }
                        catch (Exception ex)
                        {
                            result = false;
                            ForteMessage = "Internal Error";
                        }


                    }



                }
            }


            return Json(new
            {
                status = result,
                customerid = customer.Id,
                HasMessage = HasForteMessage,
                PaymentInfoId = PaymentInfo.Id,
                PaymentMethod = customer.PaymentMethod,
                AuthId = customer.ScheduleToken,
                ForteMessage = ForteMessage
            });
        }


        [Authorize]
        [HttpPost]
        public JsonResult UpdateCustomerFromForte(Guid CustomerId)
        {

            Customer customer = _Util.Facade.CustomerFacade.GetCustomerByCustomerId(CustomerId);
            if (customer == null)
            {

            }
            return Json(true);

        }


        [Authorize]
        [HttpPost]
        public JsonResult UnsubscribeFromAuthorize(string AuthorizeRefId)
        {
            bool Fresult = false; //check for deleting payment info. 

            var CurrentUser = (HS.Web.UI.Helper.CustomPrincipal)User;
            if (!string.IsNullOrWhiteSpace(AuthorizeRefId))
            {
                Customer customer = _Util.Facade.CustomerFacade.GetCustoemrBySubscriptionId(AuthorizeRefId);
                if (customer != null)
                {
                    Fresult = true;

                    #region Customer Payment info remove
                    //var InfoPaymentCustomerObject = _Util.Facade.PaymentInfoCustomerFacade.GetPaymentInfoCustomerByCustomerId(customer.CustomerId);
                    //if(InfoPaymentCustomerObject != null)
                    //{
                    //    var delObjPaymentInfoCustomer = _Util.Facade.PaymentInfoCustomerFacade.DeletePaymentInfoCustomerById(InfoPaymentCustomerObject.Id);
                    //    if(delObjPaymentInfoCustomer == true)
                    //    {
                    //        var objPaymentInfo = _Util.Facade.PaymentInfoFacade.GetPaymentInfoById(InfoPaymentCustomerObject.PaymentInfoId);
                    //        if(objPaymentInfo != null)
                    //        {
                    //            Fresult = _Util.Facade.PaymentInfoFacade.DeletePaymentInfoById(objPaymentInfo.Id);
                    //        }
                    //    }
                    //}
                    #endregion

                    if (Fresult == true)
                    {
                        string TransactionKey = _Util.Facade.GlobalSettingsFacade.GetAuthTransactionKeyByCompanyId(CurrentUser.CompanyId.Value, (customer.PaymentMethod == LabelHelper.PaymentMethod.ACH));
                        string APILoginId = _Util.Facade.GlobalSettingsFacade.GetAuthAPILoginIdByCompanyId(CurrentUser.CompanyId.Value, (customer.PaymentMethod == LabelHelper.PaymentMethod.ACH));
                        bool AuthInProduction = false;
                        GlobalSetting globset = _Util.Facade.GlobalSettingsFacade.GetGlobalSettingsByKey(CurrentUser.CompanyId.Value, "Authorize.NetInProduction");
                        if (globset != null && globset.Value.ToLower() == "true")
                        {
                            AuthInProduction = true;
                        }
                        //bool ForteInProduction = false;
                        //GlobalSetting ForteGlobset = _Util.Facade.GlobalSettingsFacade.GetGlobalSettingsByKey(CurrentUser.CompanyId.Value, "ForteInProduction");
                        //if (globset != null && globset.Value.ToLower() == "true")
                        //{
                        //    ForteInProduction = true;
                        //}
                        var response = CancelSubscription.Run(APILoginId, TransactionKey, AuthorizeRefId, AuthInProduction);

                        if (response != null && response.messages.resultCode == messageTypeEnum.Ok)
                        {
                            if (response != null && response.messages.message != null)
                            {
                                //Console.WriteLine("Success, Subscription Cancelled With RefID : " + response.refId);
                                string Message = "Success, Subscription Cancelled With RefID : " + response.refId;
                                if (string.IsNullOrWhiteSpace(response.refId))
                                {
                                    Message += customer.AuthorizeRefId;
                                }
                                if (!string.IsNullOrWhiteSpace(customer.AuthorizeCusPaymentProfileId))
                                {
                                    var cusPaymentProfileResponse = DeleteCustomerPaymentProfile.Run(APILoginId, TransactionKey, customer.AuthorizeCusProfileId, customer.AuthorizeCusPaymentProfileId);
                                }
                                if (!string.IsNullOrWhiteSpace(customer.AuthorizeCusProfileId))
                                {
                                    var cusProfileResponse = DeleteCustomerProfile.Run(APILoginId, TransactionKey, customer.AuthorizeCusProfileId);
                                }
                                customer.AuthorizeRefId = "";
                                customer.AuthorizeCusPaymentProfileId = "";
                                customer.AuthorizeCusProfileId = "";
                                customer.IsRequiredCsvSync = false;
                                //customer.IsActive = true;
                                //customer.PaymentMethod = "-1";
                                _Util.Facade.CustomerFacade.UpdateCustomer(customer);
                                return Json(new
                                {
                                    result = true,
                                    message = Message
                                });

                            }
                        }
                        else if (response != null)
                        {

                            if (response.messages.message[0].code == "E00035")
                            {
                                customer.AuthorizeRefId = "";
                                customer.AuthorizeCusPaymentProfileId = "";
                                customer.AuthorizeCusProfileId = "";
                                customer.IsRequiredCsvSync = false;
                                _Util.Facade.CustomerFacade.UpdateCustomer(customer);
                            }
                            //Console.WriteLine("Error: " + response.messages.message[0].code + "  " + response.messages.message[0].text);
                            return Json(new
                            {
                                result = false,
                                message = response.messages.message[0].code + "  " + response.messages.message[0].text
                            });
                        }
                    }
                }
            }
            return Json(new
            {
                result = false,
                message = "Customer not found, contact system admin or do it manually..."
            });

        }

        [Authorize]
        [HttpPost]
        public JsonResult UnsubscribeFromForte(string ForteRefId)
        {
            bool Fresult = false; //check for deleting payment info. 

            var CurrentUser = (HS.Web.UI.Helper.CustomPrincipal)User;
            if (!string.IsNullOrWhiteSpace(ForteRefId))
            {
                Customer customer = _Util.Facade.CustomerFacade.GetCustoemrByScheduleToken(ForteRefId);
                if (customer != null)
                {
                    Fresult = true;



                    if (Fresult == true)
                    {
                        string ForteTransactionKey = _Util.Facade.GlobalSettingsFacade.GetForteTransactionKeyByCompanyId(CurrentUser.CompanyId.Value, (customer.PaymentMethod == LabelHelper.PaymentMethod.ACH));
                        string ForteAPILoginId = _Util.Facade.GlobalSettingsFacade.GetForteAPILoginIdByCompanyId(CurrentUser.CompanyId.Value, (customer.PaymentMethod == LabelHelper.PaymentMethod.ACH));
                        string ForteOrganizationId = _Util.Facade.GlobalSettingsFacade.GetForteOrganizationIdByCompanyId(CurrentUser.CompanyId.Value, (customer.PaymentMethod.ToLower() == "ach"));
                        string ForteLocationId = _Util.Facade.GlobalSettingsFacade.GetForteLocationIdByCompanyId(CurrentUser.CompanyId.Value, (customer.PaymentMethod.ToLower() == "ach"));
                        string ForteAuthAccountId = _Util.Facade.GlobalSettingsFacade.GetForteAuthAccountIdByCompanyId(CurrentUser.CompanyId.Value, (customer.PaymentMethod.ToLower() == "ach"));

                        GlobalSetting globset = _Util.Facade.GlobalSettingsFacade.GetGlobalSettingsByKey(CurrentUser.CompanyId.Value, "ForteInProduction");


                        try
                        {
                            ForteOptions forte = new ForteOptions();
                            forte.Organization_ID = ForteOrganizationId;
                            forte.Location_Id = ForteLocationId;
                            forte.AuthAccountId = ForteAuthAccountId;

                            forte.UserId = ForteAPILoginId;
                            forte.Password = ForteTransactionKey;
                            forte.Schedule_Id = ForteRefId;
                            System.Net.ServicePointManager.SecurityProtocol = System.Net.SecurityProtocolType.Ssl3
                                               | System.Net.SecurityProtocolType.Tls
                                               | System.Net.SecurityProtocolType.Tls11
                                               | System.Net.SecurityProtocolType.Tls12;
                            forte.Server = "https://sandbox.forte.net/api/v3";
                            if (globset != null && globset.Value.ToLower() == "true")
                            {
                                forte.Server = "https://api.forte.net/v3";
                            }
                            ForteScheduleService forteSchedule = new ForteScheduleService(forte);
                            bool delete = _Util.Facade.CustomerFacade.DeleteCustomerSchedule(forteSchedule);
                            if (delete == true)
                            {
                                //customer.CustomerToken = null;//We are removing only the schedule not customer and payment method
                                customer.PaymentToken = null;
                                customer.ScheduleToken = null;
                                _Util.Facade.CustomerFacade.UpdateCustomer(customer);
                                return Json(new
                                {
                                    result = true,
                                    message = "Unsubscription successfull"
                                });
                            }
                            else
                            {
                                return Json(new
                                {
                                    result = false,
                                    message = "Can not unsbscribed"
                                });
                            }
                        }
                        catch (Exception ex)
                        {

                        }

                    }
                }
            }
            return Json(new
            {
                result = false,
                message = "Customer not found, contact system admin or do it manually..."
            });

        }
        [Authorize]
        [HttpPost]
        public JsonResult DeleteCustomer(string Id, Guid? CusId, string CusIntId)
        {
            Guid CustomerId;
            if (!Guid.TryParse(Id, out CustomerId))
            {
                return Json(new { result = false, message = "Permission denied." });
            }
            if (!base.IsPermitted(UserPermissions.CustomerPermissions.CustomerDelete))
            {
                return Json(new { result = false, message = "Permission denied." });
            }
            Customer cus = _Util.Facade.CustomerFacade.GetCustomerByCustomerId(CustomerId);
            if (cus == null)
            {
                return Json(new { result = false, message = "Customer not found." });
            }
            if (!string.IsNullOrWhiteSpace(cus.AuthorizeRefId))
            {
                return Json(new { result = false, message = "This customer already subscribed to authorize.net. You can't delete this customer." });
            }
            List<Invoice> CustomerInvoiceList = _Util.Facade.InvoiceFacade.GetAllInvoiceByCustomerId(CustomerId);
            if (CustomerInvoiceList.Count() > 0)
            {
                return Json(new { result = false, message = "This customer already has invoice/estimate created. You can't delete this customer." });
            }
            if (!string.IsNullOrWhiteSpace(cus.CustomerNo))
            {
                CustomerSystemNo cusSysNo = _Util.Facade.CustomerSystemNoFacade.GetCusSysNoByCustomerIdAndSysNo(cus.Id, cus.CustomerNo);
                if (cusSysNo != null)
                {
                    cusSysNo.IsReserved = false;
                    cusSysNo.IsUsed = false;
                    _Util.Facade.CustomerSystemNoFacade.UpdateCustomerSystemNo(cusSysNo);
                }
            }
            var result = false;
            if (Request.Url.Host.ToLower().IndexOf("app.ieatery.com") > -1)
            {
                var objlogin = _Util.Facade.UserLoginFacade.GetUserListByUsername(cus.EmailAddress);
                foreach (var item in objlogin)
                {
                    var objusercom = _Util.Facade.UserCompanyFacade.GetUserCompanyByUserIdAndCompanyId(item.UserId, item.CompanyId);
                    if (objusercom != null)
                    {
                        _Util.Facade.UserCompanyFacade.DeleteUserCompanyById(objusercom.Id);
                        _Util.Facade.UserLoginFacade.DeleteUserLogin(item.Id);
                    }
                }

                result = _Util.Facade.CustomerFacade.DeleteCustomer(cus.Id);
            }
            else
            {
                result = _Util.Facade.CustomerFacade.DeleteCustomer(cus.Id);
                base.AddUserActivityForCustomer("Customer is deleted #Ref:Customer#" + CusIntId, LabelHelper.ActivityAction.Delete, CusId, null, CusIntId);

            }
            #region Delete from customer tab cookie
            try
            {
                var Model = new List<CustomerTabModel>();
                if (Request.Cookies[CookieKeys.Customer] != null && !string.IsNullOrWhiteSpace(Request.Cookies[CookieKeys.Customer].Value))
                {

                    //HttpUtility.UrlDecode(Request.Cookies["__favProp"].Value);

                    string cookie = HttpUtility.UrlDecode(Request.Cookies[CookieKeys.Customer].Value); //Request.Cookies[CookieKeys.Customer].Value;
                    string[] CusList = cookie.Split('|');
                    foreach (var item in CusList)
                    {
                        if (string.IsNullOrWhiteSpace(item))
                        {
                            continue;
                        }
                        string[] itm = item.Split(',');
                        if (itm.Count() > 1)
                        {
                            var hell = new CustomerTabModel()
                            {
                                CustomerId = Convert.ToInt32(itm[0]),
                                CustomerName = itm[1]
                            };
                            if (hell.CustomerId != cus.Id)
                            {
                                Model.Add(hell);
                            }
                        }

                    }
                    if (Model.Count() > 0)
                    {
                        string newCookie = "";
                        for (int i = 0; i < Model.Count() && i < 4; i++)
                        {
                            newCookie += string.Format("{0},{1}|", Model[i].CustomerId, Model[i].CustomerName);
                        }
                        HttpCookie myCookie = new HttpCookie(CookieKeys.Customer);
                        myCookie.Value = newCookie;// HttpUtility.UrlEncode(cookie);
                        myCookie.Expires = DateTime.Now.UTCCurrentTime().AddDays(2d);
                        Response.Cookies.Add(myCookie);
                    }
                    else
                    {
                        var myCookie = new HttpCookie(CookieKeys.Customer);
                        myCookie.Expires = DateTime.Now.AddDays(-1);
                        Response.Cookies.Add(myCookie);
                    }
                }
            }
            catch (Exception)
            {
                var myCookie = new HttpCookie(CookieKeys.Customer);
                myCookie.Expires = DateTime.Now.AddDays(-1);
                Response.Cookies.Add(myCookie);
            }
            #endregion

            if (result)
            {
                return Json(new { result = true, message = "Customer deleted successfully." });
            }
            else
            {
                return Json(new { result = false, message = "An error occured. Please contact system admin" });
            }
        }

        [Authorize]
        public PartialViewResult AddProductCategory(int? id)
        {
            EquipmentType model;
            var currentLoggedIn = ((HS.Web.UI.Helper.CustomPrincipal)(User));
            if (id.HasValue)
            {
                if (!base.IsPermitted(UserPermissions.ProductsPermissions.ProductCategoriesEdit))
                {
                    return PartialView("~/Views/Shared/_AccessDenied.cshtml");
                }

                model = _Util.Facade.EquipmentTypeFacade.GetEquipmentTypeById(id.Value);
            }
            else
            {
                if (!base.IsPermitted(UserPermissions.ProductsPermissions.ProductCategoriesAdd))
                {
                    return PartialView("~/Views/Shared/_AccessDenied.cshtml");
                }

                model = new EquipmentType();
            }

            ViewBag.EquipmentTypeList = _Util.Facade.EquipmentTypeFacade
                .GetAllEquipmentCategoryWithSubCategoryByCompanyId(currentLoggedIn.CompanyId.Value).OrderBy(x => x.Text != "SERVICE").ThenBy(x => x.Text).ToList();
            return PartialView("_AddProductCategory", model);
        }

        [Authorize]
        [HttpPost]
        public JsonResult AddProductCategory(EquipmentType eq)
        {

            bool result = false;
            eq.IsActive = true;
            eq.CompanyId = ((HS.Web.UI.Helper.CustomPrincipal)(User)).CompanyId.Value;
            if (eq.Id > 0)
            {
                if (!base.IsPermitted(UserPermissions.ProductsPermissions.ProductCategoriesEdit))
                {
                    return Json(false);
                }

                result = _Util.Facade.EquipmentTypeFacade.UpdateEquipmentType(eq);
            }
            else
            {
                if (!base.IsPermitted(UserPermissions.ProductsPermissions.ProductCategoriesAdd))
                {
                    return Json(false);
                }

                result = _Util.Facade.EquipmentTypeFacade.InsertEquipmentType(eq) > 0;

            }

            return Json(result);
        }
        [Authorize]
        [HttpPost]
        public JsonResult DeleteProductCategory(int? id)
        {

            if (!base.IsPermitted(UserPermissions.ProductsPermissions.ProductCategoriesDelete))
            {
                return Json(false);
            }

            if (id.HasValue)
            {
                var productCategory = _Util.Facade.EquipmentTypeFacade.DeleteEquipmentType(id.Value);
            }
            return Json(true);
        }
        [Authorize]
        public PartialViewResult DetailTab(int id, string CustomerName, string Tablink, string noteid, string timeval, string IsComplete)
        {
            string CustomerGuid = "";
            var currentuser = ((HS.Web.UI.Helper.CustomPrincipal)(User));
            if (!base.IsPermitted(UserPermissions.CustomerPermissions.CustomerDetails))
            {
                return PartialView("~/Views/Shared/_AccessDenied.cshtml");
            }

            List<CustomerTabModel> Model = new List<CustomerTabModel>();
            Customer tmCus = new Customer();
            if (id > 0)
            {
                if (string.IsNullOrWhiteSpace(CustomerName))
                {
                    tmCus = _Util.Facade.CustomerFacade.GetCustomerByCustomerId(id);
                    if (tmCus != null)
                    {
                        CustomerName = tmCus.DisplayName;
                        CustomerGuid = tmCus.CustomerId.ToString();

                    }
                    else
                    {
                        return PartialView("~/Views/Shared/_AccessDenied.cshtml");
                    }

                }
                if (Request.Cookies[CookieKeys.Customer] != null && !string.IsNullOrWhiteSpace(Request.Cookies[CookieKeys.Customer].Value))
                {

                    //HttpUtility.UrlDecode(Request.Cookies["__favProp"].Value);

                    string cookie = HttpUtility.UrlDecode(Request.Cookies[CookieKeys.Customer].Value); //Request.Cookies[CookieKeys.Customer].Value;
                    string[] CusList = cookie.Split('|');
                    foreach (var item in CusList)
                    {
                        if (string.IsNullOrWhiteSpace(item))
                        {
                            continue;
                        }
                        string[] itm = item.Split('~');
                        if (itm.Count() > 2)
                        {
                            Model.Add(new CustomerTabModel()
                            {
                                CustomerId = Convert.ToInt32(itm[0]),
                                CustomerName = itm[1],
                                CustomerGuid = itm[2]
                            });
                        }
                    }
                    if (Model.Count() > 0)
                    {

                        if (Model.Where(x => x.CustomerId == id).Count() > 0)
                        {
                            var index = Model.FindIndex(x => x.CustomerId == id);
                            var item = Model[index];
                            Model[index] = Model[0];
                            Model[0] = item;
                        }
                        else
                        {
                            Model.Insert(0, new CustomerTabModel()
                            {
                                CustomerId = id,
                                CustomerName = CustomerName,
                                CustomerGuid = CustomerGuid
                            });
                        }
                    }
                }
                else
                {
                    Model.Add(new CustomerTabModel()
                    {
                        CustomerId = id,
                        CustomerName = CustomerName,
                        CustomerGuid = CustomerGuid
                    });
                }
                string newCookie = "";
                for (int i = 0; i < Model.Count() && i < 4; i++)
                {
                    newCookie += string.Format("{0}~{1}~{2}|", Model[i].CustomerId, Model[i].CustomerName, Model[i].CustomerGuid);
                }
                HttpCookie myCookie = new HttpCookie(CookieKeys.Customer);
                myCookie.Value = newCookie;// HttpUtility.UrlEncode(cookie);
                myCookie.Expires = DateTime.Now.UTCCurrentTime().AddDays(2d);
                Response.Cookies.Add(myCookie);
            }
            ViewBag.tablink = Tablink;
            ViewBag.noteid = Convert.ToInt32(noteid);
            ViewBag.time = timeval;
            ViewBag.complete = IsComplete;
            CustomerCompany cc = _Util.Facade.CustomerFacade.GetCustomerCompanyByCompanyIdAndCustomerId(currentuser.CompanyId.Value, tmCus.CustomerId);
            if (cc != null && cc.IsLead == false)
            {
                return PartialView("_DetailTab", Model.GetRange(0, (Model.Count() <= 4 ? Model.Count() : 4)));
            }
            else if (cc != null && cc.IsLead == true)
            {
                ViewBag.Location = "/Lead/Leadsdetail/?id=" + id;
                return PartialView("~/Views/Shared/_RedirectPage.cshtml");
            }
            else
            {
                return PartialView("~/Views/Shared/_NotFound.cshtml");
            }
        }


        [Authorize]
        public JsonResult RemoveATab(int id)
        {

            if (Request.Cookies[CookieKeys.Customer] != null && !string.IsNullOrWhiteSpace(Request.Cookies[CookieKeys.Customer].Value))
            {
                List<CustomerTabModel> Model = new List<CustomerTabModel>();
                string cookie = Request.Cookies[CookieKeys.Customer].Value.ToString();
                string[] CusList = cookie.Split('|');
                string NewCookie = "";
                foreach (var item in CusList)
                {
                    if (item.IndexOf(id.ToString() + ",") > -1)
                    {
                        continue;
                    }
                    NewCookie += item + "|";
                }
                HttpCookie myCookie = new HttpCookie(CookieKeys.Customer);
                myCookie.Value = cookie;
                myCookie.Expires = DateTime.Now.UTCCurrentTime().AddDays(2d);
                Response.Cookies.Add(myCookie);

            }
            return Json(true);
        }

        [Authorize]
        public ActionResult CustomerDetails(int id, string tab, string noteid, string timeval, string IsComplete)
        {

            if (id == 0)
            {
                return null;
            }
            ViewBag.IsCustomerContactTrack = "false";

            var CurrentUser = (HS.Web.UI.Helper.CustomPrincipal)User;
            string techid = "";
            if (CurrentUser.UserTags.ToLower().IndexOf("technician") > -1)
            {
                techid = CurrentUser.UserId.ToString();
            }
            //bool result = _Util.Facade.CustomerFacade.CustomerIsInCompany(id, CurrentUser.CompanyId.Value);
            //if (!result)
            //{
            //    return PartialView("~/Views/Shared/_AccessDenied.cshtml");
            //}
            AssignTicketFilter filter = new AssignTicketFilter();


            Customer model = _Util.Facade.CustomerFacade.GetCustomersByIdAndSoldBy(id, CurrentUser.UserId, CurrentUser.UserTags, CurrentUser.UserRole);

            if (model == null)
            {
                Customer Cusmodel = _Util.Facade.CustomerFacade.GetCustomersByIdAndSoldBy(id, CurrentUser.UserId, "", "");
                filter.DateFrom = new DateTime();
                filter.DateTo = new DateTime();
                filter.TicketStatus = "-1";
                filter.UserId = CurrentUser.UserId;
                List<AssignTicket> ticket = _Util.Facade.TicketFacade.GetAllAssignedTicketByUserId(filter);
                bool flag = false;
                if (Cusmodel != null)
                {
                    foreach (var item in ticket)
                    {
                        if (item.CustomerId == Cusmodel.Id)
                        {
                            flag = true;
                        }
                    }
                }
                if (flag == true)
                {
                    model = Cusmodel;
                }

            }


            if (model != null)
            {
                #region ReferringCustomer
                Customer objrefer = _Util.Facade.CustomerFacade.GetCustomerByCustomerId(model.ReferringCustomer);
                if (objrefer != null)
                {
                    string refname = "";
                    if (!string.IsNullOrWhiteSpace(objrefer.BusinessName))
                    {
                        refname = objrefer.BusinessName;
                    }
                    else
                    {
                        refname = objrefer.FirstName + " " + objrefer.LastName;
                    }
                    model.RefCustomer = refname;
                    ViewBag.RefId = objrefer.Id;
                }
                else
                {
                    ViewBag.RefId = "";
                }
                #endregion
                #region DuplicateCustomer
                if (model.DuplicateCustomer != Guid.Empty)
                {
                    Customer DuplicateCustomer = _Util.Facade.CustomerFacade.GetCustomerByCustomerId(model.DuplicateCustomer);
                    if (DuplicateCustomer != null)
                    {
                        string refname = "";
                        if (!string.IsNullOrWhiteSpace(DuplicateCustomer.BusinessName))
                        {
                            refname = DuplicateCustomer.BusinessName;
                        }
                        else
                        {
                            refname = DuplicateCustomer.FirstName + " " + DuplicateCustomer.LastName;
                        }
                        model.DuplicateCustomerName = refname;
                        model.DuplicateCustomerId = DuplicateCustomer.Id;
                    }
                }

                #endregion
                #region Child Of
                var objchild = _Util.Facade.CustomerFacade.GetCustomerByCustomerId(model.ChildOf);
                if (objchild != null)
                {
                    string refname = "";
                    if (!string.IsNullOrWhiteSpace(objchild.BusinessName))
                    {
                        refname = objchild.BusinessName;
                    }
                    else
                    {
                        refname = objchild.FirstName + " " + objchild.LastName;
                    }
                    model.chCustomer = refname;
                }
                #endregion

                if (model != null)
                {
                    var objemp = _Util.Facade.EmployeeFacade.GetEmployeeByEmployeeId(model.CreatedByUid);
                    if (objemp != null)
                    {
                        ViewBag.empfirst = objemp.FirstName;
                        ViewBag.emplast = objemp.LastName;
                    }
                }

                if (model.BusinessAccountType != "-1" && !string.IsNullOrWhiteSpace(model.BusinessAccountType))
                {
                    model.BusinessAccountType = _Util.Facade.LookupFacade.GetLookupByKeyAndValue("BussinessAccountType", model.BusinessAccountType).DisplayText;
                }
                #region Customer Header Reports
                bool isDeclinedAdded = true;
                GlobalSetting isDeclined = _Util.Facade.GlobalSettingsFacade.GetGlobalSettingsByKey(CurrentUser.CompanyId.Value, "IsDeclinedInvoiceAddedInUnpaidAmount");
                if (isDeclined != null)
                {
                    isDeclinedAdded = !string.IsNullOrWhiteSpace(isDeclined.Value) && isDeclined.Value.ToLower() == "false" ? false : true;
                }
                EstimateStatusDetail EstimateStatusDetail = _Util.Facade.CustomerFacade.GetAllEstimateStatusDetailByCustomerId(model.CustomerId, isDeclinedAdded);
                var GetSalesTax = _Util.Facade.GlobalSettingsFacade.GetSalesTax(CurrentUser.CompanyId.Value, model.CustomerId);
                Customer cus = _Util.Facade.CustomerFacade.GetCustomerByCustomerId(model.CustomerId);
                double Tax = 0.0;
                if (GetSalesTax != null)
                {
                    Tax = Convert.ToDouble(GetSalesTax.Value);
                }
                ViewBag.DueAmountDetail = EstimateStatusDetail.DueAmountDetail;
                ViewBag.EstimateAmountDetail = EstimateStatusDetail.EstimateAmountDetail;
                ViewBag.PaidAmountDetail = EstimateStatusDetail.PaidAmountDetail;
                ViewBag.UnpaidInvoice = EstimateStatusDetail.UnpaidAmount;
                if (EstimateStatusDetail.PaidAmountDetail > 0)
                {
                    if (cus.TaxExemption == "No" || cus.TaxExemption == "" || cus.TaxExemption == "-1")
                    {
                        ViewBag.PaidAmountDetailWithOutTax = EstimateStatusDetail.PaidAmountDetail - ((EstimateStatusDetail.PaidAmountDetail * Tax) / (100 + Tax));
                    }
                    else
                    {
                        ViewBag.PaidAmountDetailWithOutTax = EstimateStatusDetail.PaidAmountDetail;
                    }

                }
                else
                {
                    ViewBag.PaidAmountDetailWithOutTax = EstimateStatusDetail.PaidAmountDetail;
                }

                #endregion


                ViewBag.InvoiceRevenue = _Util.Facade.CustomerFacade.GetTotalRevenueByCustomerIdandCompanyId(model.CustomerId, CurrentUser.CompanyId.Value);
                if (ViewBag.InvoiceRevenue != null && ViewBag.InvoiceRevenue != "")
                {
                    model.CustomerTotalRevenue = double.Parse(ViewBag.InvoiceRevenue);
                }
                else
                {
                    model.CustomerTotalRevenue = 0.0;
                }

                List<CustomerApiSetting> setting = _Util.Facade.CustomerApiSettingFacade.GetAllApiSettingDetailByCustomerId(model.CustomerId);
                foreach (var item in setting)
                {
                    if (item.AccountName == "Monitronics" && item.Url != "" && item.UserName != "" && item.Password != "")
                    {
                        model.IsMonitronics = true;
                    }
                    if (item.AccountName == "Central Station" && item.Url != "" && item.UserName != "" && item.Password != "")
                    {
                        model.IsCentral = true;
                    }
                }
                model.QAList = _Util.Facade.QaAnswerFacade.GetQa1QuestionaireByCompanyIdandCustomerId(CurrentUser.CompanyId.Value, model.CustomerId);
                model.QAList1 = _Util.Facade.QaAnswerFacade.GetQa2QuestionaireByCompanyIdandCustomerId(CurrentUser.CompanyId.Value, model.CustomerId);

                ViewBag.QA1Percentageval = _Util.Facade.CustomerFacade.GetCustomerQA1StatusByCompanyIdAndCustomerId(CurrentUser.CompanyId.Value, model.CustomerId);
                ViewBag.GlobalSettingPercentage = _Util.Facade.CustomerFacade.GetQA1PercentageValueByCompanyId(CurrentUser.CompanyId.Value);
                bool IsQa1Done = false;
                int Qval = 0;
                int Gval = 0;
                if (ViewBag.QA1Percentageval != "")
                {
                    Qval = Convert.ToInt32(Math.Floor(Convert.ToDouble(ViewBag.QA1Percentageval)));
                }
                if (ViewBag.GlobalSettingPercentage != "")
                {
                    Gval = Convert.ToInt32(ViewBag.GlobalSettingPercentage);
                }

                if (Qval <= Gval && Qval != Gval)
                {
                    ViewBag.QA1FinalResult = IsQa1Done;
                }
                else
                {
                    IsQa1Done = true;
                    ViewBag.QA1FinalResult = IsQa1Done;
                }
                bool Tresult = _Util.Facade.CustomerFacade.GetQATechCallValueBycompanyId(CurrentUser.CompanyId.Value, model.CustomerId);
                var QATechcallGlobSetting = _Util.Facade.GlobalSettingsFacade.GetQATechCallGlobSettingsBycompanyId(CurrentUser.CompanyId.Value);
                model.IsQA2Done = _Util.Facade.CustomerFacade.GetCustomerQA2StatusByCompanyIdAndCustomerId(CurrentUser.CompanyId.Value, model.CustomerId);

                if (Tresult != false)
                {
                    Tresult = true;
                    ViewBag.TechFinalResult = Tresult;
                }
                else
                {
                    ViewBag.TechFinalResult = Tresult;
                }

                if (QATechcallGlobSetting.Count > 0 && QATechcallGlobSetting.Count == 3)
                {
                    model.QA1GlobalSettings = (QATechcallGlobSetting[0].Value.ToLower() == "true") ? true : false;
                    model.TechCallGlobalSettings = (QATechcallGlobSetting[1].Value.ToLower() == "true") ? true : false;
                    model.QA2GlobalSettings = (QATechcallGlobSetting[2].Value.ToLower() == "true") ? true : false;
                }
                Guid assignuser = new Guid();
                if (!IsPermitted(UserPermissions.CustomerTicketPermission.ShowAllTicket))
                {
                    assignuser = CurrentUser.UserId;
                }
                bool isorderpermit = false;
                if (IsPermitted(UserPermissions.MenuPermissions.LeftMenuOrders))
                {
                    isorderpermit = true;
                }

                model.Invoice = _Util.Facade.InvoiceFacade.GetRecentInvoiceUnpaidByCompanyIdAndCustomerId(CurrentUser.CompanyId.Value, model.CustomerId);
                model.CustomerCancel = _Util.Facade.CustomerFacade.GetCustomerCancelDateByCustomerIdAndCompanyId(CurrentUser.CompanyId.Value, model.CustomerId);
                model.CustomerTabCounts = _Util.Facade.CustomerFacade.GetCustomerTabCountsByCustomerId(model.CustomerId, techid, CurrentUser.CompanyId.Value, assignuser, isorderpermit);
                model.RMR = _Util.Facade.CustomerFacade.GetByRecurringBillingByCustomerId(model.CustomerId);

                model.ReferingCustomerList = _Util.Facade.CustomerFacade.GetReferringCustomerListByCustomerId(model.CustomerId);
                model.ChildCustomerList = _Util.Facade.CustomerFacade.GetChildCustomerListByCustomerId(model.CustomerId);
                model.EquipmentDetailList = _Util.Facade.CustomerAppoinmentFacade.GetAllTicketEquipmentsDetailByCustomerIdAndCompanyId(CurrentUser.CompanyId.Value, model.CustomerId);
                model.TicketServiceDetailList = _Util.Facade.CustomerAppoinmentFacade.GetAllTicketServicesDetailByCustomerIdAndCompanyId(CurrentUser.CompanyId.Value, model.CustomerId);
                model.ServiceDetailList = _Util.Facade.InvoiceFacade.GetInvoiceDetailsServiceByCustomerId(model.CustomerId);

                CustomerRoute CusRoute = _Util.Facade.CustomerFacade.GetCustomerRouteByCustomerId(model.CustomerId);
                if (CusRoute != null)
                {
                    model.RouteName = CusRoute.Name;
                }

                // List<Booking> BookingList = _Util.Facade.BookingFacade.GetAllBookingByCompanyIdAndCustomerId(CurrentUser.CompanyId.Value, model.CustomerId);

                bool isviptest = _Util.Facade.BookingFacade.IsVipFromBookingByCompanyIdAndCustomerId(CurrentUser.CompanyId.Value, model.CustomerId);
                if (isviptest)
                {
                    model.CustomerTabCounts.IsVip = true;
                }
                else
                {
                    model.CustomerTabCounts.IsVip = false;
                }

                //if (BookingList != null && BookingList.Count > 0)
                //{

                //    int year = DateTime.UtcNow.UTCToClientTime().Year;
                //    DateTime firstDay = new DateTime(year, 1, 1);
                //    DateTime lastDay = new DateTime(year, 12, 31).AddSeconds(86399);


                //    BookingList = BookingList.Where(x => x.Status.ToLower() == "approved").ToList();
                //    List<Booking> BookingListFor1stYear = BookingList.Where(x => x.CreatedDate >= firstDay.AddYears(-1) && x.CreatedDate <= lastDay.AddYears(-1)).ToList();
                //    List<Booking> BookingListFor2stYear = BookingList.Where(x => x.CreatedDate >= firstDay.AddYears(-2) && x.CreatedDate <= lastDay.AddYears(-2)).ToList();
                //    List<Booking> BookingListFor3stYear = BookingList.Where(x => x.CreatedDate >= firstDay.AddYears(-3) && x.CreatedDate <= lastDay.AddYears(-3)).ToList();
                //    if(BookingListFor1stYear.Count > 1 && BookingListFor1stYear.Count > 1 && BookingListFor1stYear.Count > 1)
                //    {
                //        model.CustomerTabCounts.IsVip = true;
                //    }

                //}


                UserLogin user = _Util.Facade.UserLoginFacade.GetUserLoginByUserId(model.CustomerId);
                if (user != null)
                {
                    ViewBag.UserName = user.UserName;
                    ViewBag.HasPassword = "True";
                }
                else
                {
                    ViewBag.UserName = model.EmailAddress;
                    ViewBag.HasPassword = "Password";
                }
                if (model.BranchId > 0)
                {
                    model.CompanyBranch = _Util.Facade.CompanyBranchFacade.GetCompanyBranchById(model.BranchId.Value);
                }
                Guid SoldBy = Guid.Empty;
                if (!string.IsNullOrWhiteSpace(model.Soldby) && Guid.TryParse(model.Soldby, out SoldBy))
                {
                    var empobj = _Util.Facade.EmployeeFacade.GetEmployeeByEmployeeId(SoldBy);
                    if (empobj != null)
                    {
                        if (!IsPermitted(UserPermissions.MyCompanyPermissions.ShowAllSalesPerson) && SoldBy != CurrentUser.UserId)
                        {
                            model.PersonSales = "**********";
                        }
                        else
                        {
                            model.PersonSales = empobj.FirstName + " " + empobj.LastName;
                        }
                    }
                }
                ViewBag.tab = tab;
                ViewBag.noteid = Convert.ToInt32(noteid);
                ViewBag.time = timeval;
                ViewBag.complete = IsComplete;
                List<GridSetting> CustomerUiSetting = new List<GridSetting>();
                CustomerUiSetting = _Util.Facade.GridSettingsFacade.GetAllByKey("CustomerDetailTab", CurrentUser.CompanyId.Value);
                if (CustomerUiSetting.Count > 0)
                {
                    CustomerUiSetting = CustomerUiSetting.OrderBy(x => x.OrderBy).Where(x => x.FormActive == true).ToList();
                }
                ViewBag.CustomerUiSetting = CustomerUiSetting;
                List<GridSetting> CustomerBlockUiSetting = new List<GridSetting>();
                CustomerBlockUiSetting = _Util.Facade.GridSettingsFacade.GetAllByKey("CustomerGrid", CurrentUser.CompanyId.Value);
                if (CustomerBlockUiSetting.Count > 0)
                {
                    CustomerBlockUiSetting = CustomerBlockUiSetting.OrderBy(x => x.OrderBy).Where(x => x.FormActive == true).ToList();
                }
                ViewBag.CustomerBlockUiSetting = CustomerBlockUiSetting;
                List<GridSetting> CustomerTabUiSetting = new List<GridSetting>();
                CustomerTabUiSetting = _Util.Facade.GridSettingsFacade.GetAllByKey("CustomerTab", CurrentUser.CompanyId.Value);
                if (CustomerTabUiSetting.Count > 0)
                {
                    CustomerTabUiSetting = CustomerTabUiSetting.OrderBy(x => x.OrderBy).Where(x => x.FormActive == true).ToList();
                }
                ViewBag.CustomerTabUiSetting = CustomerTabUiSetting;
                ViewBag.CustomerDetailBlock = _Util.Facade.GridSettingsFacade.GetAllByKey("CustomerDetailBlock", CurrentUser.CompanyId.Value);

                List<Booking> bookingList = _Util.Facade.BookingFacade.GetAllBookingByCustomerId(model.CustomerId);
                ViewBag.Pickupdate = "Not Set Yet";
                ViewBag.DeliveryDate = "Not Set Yet";
                if (bookingList.Count > 0)
                {
                    DateTime? pickupdate = bookingList.OrderBy(x => x.PickUpDate).FirstOrDefault().PickUpDate;
                    DateTime? Deliverydate = bookingList.OrderBy(x => x.DropOffDate).FirstOrDefault().DropOffDate;
                    if (pickupdate.HasValue && pickupdate != new DateTime())
                    {
                        ViewBag.Pickupdate = pickupdate.Value.ToString("MM/dd/yy");
                    }
                    else
                    {
                        ViewBag.Pickupdate = "Not Set Yet";
                    }
                    if (Deliverydate.HasValue && Deliverydate != new DateTime())
                    {
                        ViewBag.DeliveryDate = Deliverydate.Value.ToString("MM/dd/yy");
                    }
                    else
                    {
                        ViewBag.DeliveryDate = "Not Set Yet";
                    }
                }
                ViewBag.isContactFormList = _Util.Facade.CustomerFacade.IsCustomerInCustomerContactByCustomerId(model.CustomerId);
                model.PackageCustomer = _Util.Facade.PackageFacade.GetPackageCustomerByCustomerId(model.CustomerId);
                var objtransfercus = _Util.Facade.CustomerFacade.GetTransferCustomerById(model.Id);
                if (objtransfercus != null)
                {
                    model.TransferCustomerName = !string.IsNullOrWhiteSpace(objtransfercus.DBA) ? objtransfercus.DBA : !string.IsNullOrWhiteSpace(objtransfercus.BusinessName) ? objtransfercus.BusinessName : objtransfercus.FirstName + " " + objtransfercus.LastName;
                    model.TransferCustomerId = objtransfercus.Id;
                }
                else
                {
                    var transfercusobj = _Util.Facade.CustomerFacade.GetCustomerById(model.TransferCustomerId.HasValue ? model.TransferCustomerId.Value : 0);
                    if (transfercusobj != null)
                    {
                        model.TransferredCustomerName = !string.IsNullOrWhiteSpace(transfercusobj.DBA) ? transfercusobj.DBA : !string.IsNullOrWhiteSpace(transfercusobj.BusinessName) ? transfercusobj.BusinessName : transfercusobj.FirstName + " " + transfercusobj.LastName;
                        model.TransferredCustomerId = transfercusobj.Id;
                    }
                }
                var refcusobj = _Util.Facade.CustomerFacade.GetCustomerByMovedCustomerIdAndType(model.CustomerId);
                if (refcusobj != null)
                {
                    model.MovedCustomerName = !string.IsNullOrWhiteSpace(refcusobj.DBA) ? refcusobj.DBA : !string.IsNullOrWhiteSpace(refcusobj.BusinessName) ? refcusobj.BusinessName : refcusobj.FirstName + " " + refcusobj.LastName;
                    model.MovedCustomerId = refcusobj.Id;
                }
                else
                {
                    model.MovedCustomerId = 0;
                }
                var movecusobj = _Util.Facade.CustomerFacade.GetCustomerByCustomerId(model.MoveCustomerId);
                if (movecusobj != null)
                {
                    model.MovedCustomerName = !string.IsNullOrWhiteSpace(movecusobj.DBA) ? movecusobj.DBA : !string.IsNullOrWhiteSpace(movecusobj.BusinessName) ? movecusobj.BusinessName : movecusobj.FirstName + " " + movecusobj.LastName;
                    model.MovedCustomerIdFrom = movecusobj.Id;
                }
                else
                {
                    model.MovedCustomerIdFrom = 0;
                }
                if (!string.IsNullOrWhiteSpace(model.CustomerAccountType))
                {
                    var spacctype = model.CustomerAccountType.Replace(", ", ",").Split(',');
                    List<string> acctype = new List<string>();
                    if (spacctype.Length > 0)
                    {
                        foreach (var item in spacctype)
                        {
                            var lookupobj = _Util.Facade.LookupFacade.GetLookupByKeyAndValue("CustomerAccountType", item);
                            if (lookupobj != null)
                            {
                                acctype.Add(lookupobj.DisplayText);
                            }
                        }
                    }
                    model.CustomerAccountType = string.Join(", ", acctype);
                }
                if (Request.Url.Host.ToLower().IndexOf("app.ieatery.com") > -1)
                {
                    model.OrderSummeryDataModel = _Util.Facade.MenuFacade.GetRestaurantOrderSummeryByCompanyIdAndCustomerId(CurrentUser.CompanyId.Value, model.CustomerId);
                }

                #region CustomerMigration
                CustomerMigration cusMigration = new CustomerMigration();
                cusMigration = _Util.Facade.CustomerFacade.GetAgemniCustomerByCustomerId(model.CustomerId);
                model.CustomerMigration = cusMigration;

                #endregion
                #region Customer Extended Data
                if (model != null)
                {
                    CustomerExtended objextended = _Util.Facade.CustomerFacade.GetCustomerExtendedByCustomerId(model.CustomerId);
                    if (objextended != null)
                    {
                        //model.CustomerExtended = new CustomerExtended();
                        //model.CustomerExtended.ContractStartDate = objextended.ContractStartDate.HasValue ? objextended.ContractStartDate.Value : new DateTime();
                        //model.CustomerExtended.RemainingContractTerm = objextended.RemainingContractTerm;
                        //model.CustomerExtended.Pets = objextended.Pets;
                        //model.CustomerExtended.PetsType = objextended.PetsType;
                        //model.CustomerExtended.RepairType = objextended.RepairType;
                        //model.CustomerExtended.Repair = objextended.Repair;
                        //model.CustomerExtended.BirthDateCoupon = objextended.BirthDateCoupon;
                        //model.CustomerExtended.VipClubMember = objextended.VipClubMember;
                        //model.CustomerExtended.IsFinanced = objextended.VipClubMember;

                        model.CustomerExtended = objextended;

                        //Emergency fix needed, need to change
                        if (model.CustomerExtended.FinanceRep != Guid.Empty)
                        {
                            var RepEmployeeDetails = _Util.Facade.EmployeeFacade.GetEmployeeNameByEmployeeId(model.CustomerExtended.FinanceRep);
                            if (RepEmployeeDetails != null)
                            {
                                model.FinanceRepValue = RepEmployeeDetails.FirstName + " " + RepEmployeeDetails.LastName;
                            }
                        }
                        if (model.CustomerExtended.AppoinmentSetBy != Guid.Empty)
                        {
                            var AppSetEmployeeDetails = _Util.Facade.EmployeeFacade.GetEmployeeNameByEmployeeId(model.CustomerExtended.AppoinmentSetBy);
                            if (AppSetEmployeeDetails != null)
                            {
                                model.AppoinmentSetByValue = AppSetEmployeeDetails.FirstName + " " + AppSetEmployeeDetails.LastName;
                            }
                        }
                        //Emergency task. Need to fix later
                        if (model.CustomerExtended.ResignedBy != Guid.Empty)
                        {
                            var ResignedByDetails = _Util.Facade.EmployeeFacade.GetEmployeeNameByEmployeeId(model.CustomerExtended.ResignedBy);
                            if (ResignedByDetails != null)
                            {
                                model.ResignedByValue = ResignedByDetails.FirstName + " " + ResignedByDetails.LastName;
                            }
                        }
                    }
                }
                #endregion

                #region Insert Customer View
                bool result = false;

                CustomerView cv = new CustomerView();
                cv.CompanyId = CurrentUser.CompanyId.Value;
                cv.CustomerId = model.CustomerId;
                cv.LastVistited = DateTime.Now.UTCCurrentTime();
                cv.LastVisitedBy = User.Identity.Name;
                cv.LastVisitedByUId = CurrentUser.UserId;
                cv.IsLead = false;
                result = _Util.Facade.CustomerViewFacade.InsertViewList(cv) > 0;


                #endregion

                string GoogleMapAPIKey = _Util.Facade.GlobalSettingsFacade.GetGoogleMapAPIKeyByCompanyId(CurrentUser.CompanyId.Value);
                ViewBag.GoogleMapAPIKey = GoogleMapAPIKey;

                return PartialView("_CustomerDetails", model);
            }
            else
            {
                return View("_AccessDenied");
            }

        }
        public ActionResult HistoryLogPartial(Guid CustomerId, int PageNo, int PageSize)
        {
            var currentLoggedIn = ((HS.Web.UI.Helper.CustomPrincipal)(User));

            CustomerDetailTimestamp model = _Util.Facade.CustomerViewFacade.GetCustomerTimestampByCustomerId(CustomerId, PageNo, PageSize);

            ViewBag.PageNumber = PageNo;
            ViewBag.OutOfNumber = 0;
            ViewBag.order = null;
            if (ViewBag.order == null)
            {
                ViewBag.order = 0;
            }
            if (model.Count.TotalCustomer > 0)
            {
                ViewBag.OutOfNumber = model.Count.TotalCustomer;
            }

            if ((int)ViewBag.PageNumber * PageSize > (int)ViewBag.OutOfNumber)
            {
                ViewBag.CurrentNumber = (int)ViewBag.OutOfNumber;
            }
            else
            {
                ViewBag.CurrentNumber = (int)ViewBag.PageNumber * PageSize;
            }
            ViewBag.PageCount = Math.Ceiling((double)ViewBag.OutOfNumber / PageSize);

            return View(model.CustomerDetailTimestampList);
        }
        public ActionResult CustomerEquipmentDetailsPopUp(Guid customerid, Guid EqpId)
        {
            var CurrentUser = (HS.Web.UI.Helper.CustomPrincipal)User;
            List<CustomerAppointmentEquipment> EqModel = _Util.Facade.CustomerAppoinmentFacade.GetTicketEquipmentsDetailByEqpID(CurrentUser.CompanyId.Value, customerid, EqpId);

            return View(EqModel);
        }
        [Authorize]
        public ActionResult CustomerActiveInactiveHistory(Guid CustomerId)
        {
            List<CustomerCancel> Model = new List<CustomerCancel>();
            if (CustomerId != Guid.Empty)
            {
                Model = _Util.Facade.CustomerFacade.GetAllCustomerCancellLogByCustomerId(CustomerId);
            }
            return View(Model);
        }
        [Authorize]
        public ActionResult CustomerOpportunityList(Guid CustomerId)
        {
            List<Opportunity> opportunityList = _Util.Facade.OpportunityFacade.GetOpportunyByCustomerId(CustomerId);
            ViewBag.Opportunity = null;
            if (opportunityList.Count > 0)
            {
                ViewBag.Opportunity = "Show";
            }
            return View(opportunityList);
        }
        public JsonResult CustomerTabCounts(Guid CustomerId)
        {
            string techid = "";
            Guid AssignedUser = new Guid();
            bool isorderpermit = false;
            var CurrentUser = (HS.Web.UI.Helper.CustomPrincipal)User;
            if (CurrentUser.UserTags.ToLower().IndexOf("technician") > -1)
            {
                techid = CurrentUser.UserId.ToString();
            }
            if (!IsPermitted(UserPermissions.CustomerTicketPermission.ShowAllTicket))
            {
                AssignedUser = CurrentUser.UserId;
            }
            if (IsPermitted(UserPermissions.MenuPermissions.LeftMenuOrders))
            {
                isorderpermit = true;
            }
            CustomerTabCounts CustomerTabCounts = _Util.Facade.CustomerFacade.GetCustomerTabCountsByCustomerId(CustomerId, techid, CurrentUser.CompanyId.Value, AssignedUser, isorderpermit);

            return Json(new { result = true, message = "successful.", data = CustomerTabCounts });
        }
        public PartialViewResult CustomerFileDetails(Guid? CustomerId)
        {
            var CurrentUser = (HS.Web.UI.Helper.CustomPrincipal)User;
            List<CustomerFile> filename = _Util.Facade.CustomerFacade.GetAllFileNameByCustomerIdAndComapanyId(CustomerId.Value, CurrentUser.CompanyId.Value);
            return PartialView("_CustomerFileDetails", filename);
        }
        [Authorize]
        public PartialViewResult AddCustomerFileDetails(int? id, Guid customerId)
        {
            CustomerFile model;
            var currentLoggedIn = ((HS.Web.UI.Helper.CustomPrincipal)(User));
            if (id.HasValue)
            {

                model = _Util.Facade.CustomerFileFacade.GetFileNameById(id.Value);
            }
            else
            {
                model = new CustomerFile();
            }
            //ViewBag.CustomerId = _Util.Facade.CustomerFacade.GetCustomerByCustomerId(customerId).CustomerId.ToString();
            ViewBag.CustomerFileName = _Util.Facade.CustomerFacade.GetAllCustomerFileNameByCustomerId(customerId, currentLoggedIn.CompanyId.Value).Select(x =>


            new SelectListItem()
            {
                Text = x.FileDescription.ToString(),
                Value = x.Filename.ToString()
            }).ToList();
            return PartialView("AddCustomerDetails", model);
        }

        public PartialViewResult CustomerAppoinments(int Id, string parent)
        {

            if (!string.IsNullOrWhiteSpace(parent))
            {
                parent = "." + parent;
                ViewBag.Parent = parent;
            }

            return PartialView("_CustomerAppoinments");
        }

        [Authorize]
        public ActionResult CustomerListFiltered(CustomerFilter filter)
        {
            string outputstring = "";

            if (!base.IsPermitted(UserPermissions.CustomerPermissions.CustomerList))
            {
                return PartialView("~/Views/Shared/_AccessDenied.cshtml");
            }
            var currentLoggedIn = ((HS.Web.UI.Helper.CustomPrincipal)(User));

            filter.EmployeeRole = currentLoggedIn.UserTags;
            filter.UserRole = currentLoggedIn.UserRole;
            filter.EmployeeId = currentLoggedIn.UserId.ToString();
            filter.CompanyId = currentLoggedIn.CompanyId.Value;
            filter.Partners = _Util.Facade.EmployeeFacade.GetEmployeeByPartnerId(currentLoggedIn.UserId);
            filter.isPermit = IsPermitted(UserPermissions.CustomerPermissions.ShowAllCustomerList);

            #region Not using it anymore
            //if (currentLoggedIn.UserId != new Guid())
            //{
            //    var objRoleEmployee = _Util.Facade.EmployeeFacade.GetEmployeeRoleByEmployeeIdAndCompanyId(currentLoggedIn.UserId, currentLoggedIn.CompanyId.Value);
            //    filter.EmployeeRole = objRoleEmployee.Tag;
            //    filter.UserRole = currentLoggedIn.UserRole;
            //    filter.EmployeeId = currentLoggedIn.UserId.ToString();
            //}

            //outputstring += stopwatch.ElapsedMilliseconds.ToString() + " :: ";
            #endregion

            CustomerListWithCountModel customerfilterlist = new CustomerListWithCountModel();

            #region Grid Settings Prepare
            List<GridSetting> GridSettings = new List<GridSetting>();
            GridSettings = _Util.Facade.GridSettingsFacade.GetByKey("CustomerGrid", currentLoggedIn.CompanyId.Value);
            if (GridSettings.Count > 0)
            {
                GridSettings = GridSettings.OrderBy(x => x.OrderBy).Where(x => x.GridActive == true).ToList();
            }

            ViewBag.GridSettings = GridSettings;


            List<GridSetting> GridGroupSettings = new List<GridSetting>();
            GridGroupSettings = _Util.Facade.GridSettingsFacade.GetByKey("CustomerGridGroup", currentLoggedIn.CompanyId.Value);
            if (GridGroupSettings.Count > 0)
            {
                GridGroupSettings = GridGroupSettings.OrderBy(x => x.OrderBy).Where(x => x.GridActive == true).ToList();
            }

            //outputstring += stopwatch.ElapsedMilliseconds.ToString() + " :: ";
            ViewBag.GridGroupSettings = GridGroupSettings;

            List<GridSetting> LocationGroup = GridSettings.Where(x => x.ColumnGroup == "Location" && (x.SelectedColumn.ToLower() == "street" || x.SelectedColumn.ToLower() == "city" || x.SelectedColumn.ToLower() == "state" || x.SelectedColumn.ToLower() == "zipcode" || x.SelectedColumn.ToLower() == "streetprevious" || x.SelectedColumn.ToLower() == "cityprevious" || x.SelectedColumn.ToLower() == "stateprevious" || x.SelectedColumn.ToLower() == "zipcodeprevious" || x.SelectedColumn.ToLower() == "streettype" || x.SelectedColumn.ToLower() == "appartment")).ToList();
            ViewBag.LocationGroup = LocationGroup;

            #endregion


            ViewBag.CustomerUiSetting = _Util.Facade.GlobalSettingsFacade.GetAllGlobalSettings().Where(x => x.Tag == "CustomerUiSettings").ToList();
            if (filter.PageNo == 0)
            {
                filter.PageNo = 1;
            }

            GlobalSetting glob = _Util.Facade.GlobalSettingsFacade.GetGlobalSettingsByKey(currentLoggedIn.CompanyId.Value, "CustomerListPageSize");
            if (glob != null)
            {
                filter.PageSize = Convert.ToInt32(glob.Value);
            }
            else
            {
                filter.PageSize = 10;
            }

            #region No in use
            //outputstring += stopwatch.ElapsedMilliseconds.ToString() + " :: ";
            //filter.PageSize = 10; 
            //if (!string.IsNullOrEmpty(filter.SearchText))
            //{
            //    string str = filter.SearchText;
            //    str = str.Replace(" ", "");
            //    filter.SearchText = str;
            //}
            //Need to change
            //if (!currentLoggedIn.UserTags.Contains("admin") && currentLoggedIn.UserRole != "Sales Manager")
            //{
            //    filter.SoldById = currentLoggedIn.UserId;
            //    customerfilterlist = _Util.Facade.CustomerFacade.GetCustomerByFilter(filter);
            //    //List<CustomerIdList> idList = _Util.Facade.CustomerFacade.GetCustomerByFilterwithoutPagination(filter);

            //    Session["GetCustomerFilter"] = filter;

            //    //outputstring += stopwatch.ElapsedMilliseconds.ToString() + " :: ";

            //}
            //else
            //{
            //List<CustomerIdList> idList = _Util.Facade.CustomerFacade.GetCustomerByFilterwithoutPagination(filter);

            //outputstring += stopwatch.ElapsedMilliseconds.ToString() + " :: ";

            //}
            #endregion

            GlobalSetting settingOrd = _Util.Facade.GlobalSettingsFacade.GetGlobalSettingsByKey(currentLoggedIn.CompanyId.Value, "CustomerListOrder");
            if (settingOrd != null)
            {
                filter.SettingOrderBy = settingOrd.Value.ToString();
            }
            else
            {
                filter.SettingOrderBy = "Id desc";
            }
            customerfilterlist = _Util.Facade.CustomerFacade.GetCustomerByFilter(filter);

            Session["GetCustomerFilter"] = filter;

            #region Paging Ready
            if (customerfilterlist.CustomerList.Count() == 0)
            {
                filter.PageNo = 1;
            }
            ViewBag.PageNumber = filter.PageNo;
            ViewBag.OutOfNumber = 0;

            if (customerfilterlist.CustomerList.Count() > 0)
            {
                ViewBag.OutOfNumber = customerfilterlist.TotalCustomerCount.Counter;
            }

            if ((int)ViewBag.PageNumber * filter.PageSize > (int)ViewBag.OutOfNumber)
            {
                ViewBag.CurrentNumber = (int)ViewBag.OutOfNumber;
            }
            else
            {
                ViewBag.CurrentNumber = (int)ViewBag.PageNumber * filter.PageSize;
            }
            #endregion

            #region Not in use
            //outputstring += stopwatch.ElapsedMilliseconds.ToString() + " :: ";
            //foreach (var item in customerfilterlist.CustomerList)
            //{
            //    item.EqpmentCount = _Util.Facade.InvoiceFacade.GetInvoiceDetailsByCustomerId(item.CustomerId).Count;
            //    item.EmgContactCount = _Util.Facade.EmergencyContactFacade.GetAllEmergencyContactByCustomerIdAndCompanyId(item.CustomerId, currentLoggedIn.CompanyId.Value).Count;
            //}

            //outputstring += stopwatch.ElapsedMilliseconds.ToString() + " :: ";
            //stopwatch.Stop();
            #endregion


            ViewBag.PageCount = Math.Ceiling((double)ViewBag.OutOfNumber / filter.PageSize);
            return PartialView("_CustomerListFilterdNew", customerfilterlist);
        }
        [Authorize]
        public JsonResult FavoriteCustomerListFilteredLite(CustomerLiteFilter filter)
        {
            

            filter.searchid = DESEncryptionDecryption.DecryptCipherTextToPlainText(filter.searchid);
            string outputstring = "";

            if (!base.IsPermitted(UserPermissions.CustomerPermissions.CustomerList))
            {
                return Json(0, JsonRequestBehavior.AllowGet);
            }
            var currentLoggedIn = ((HS.Web.UI.Helper.CustomPrincipal)(User));
            #region multipleselect
            List<string> SalesLocation = new List<string>();

            if (!string.IsNullOrWhiteSpace(filter.SalesLocationText))
            {
                string[] SPList = filter.SalesLocationText.Split(',');
                if (SPList != null)
                {
                    foreach (var item in SPList)
                    {
                        SalesLocation.Add(item);
                    }
                }

            }
            ViewBag.SalesLocationList = SalesLocation;

            List<string> LeadSourceList = new List<string>();

            if (!string.IsNullOrWhiteSpace(filter.LeadSourceText))
            {
                string[] sourceList = filter.LeadSourceText.Split(',');
                if (sourceList != null)
                {
                    foreach (var item in sourceList)
                    {
                        LeadSourceList.Add(item);
                    }
                }

            }
            ViewBag.LeadSourceList = LeadSourceList;

            List<string> SalesPerson = new List<string>();

            if (!string.IsNullOrWhiteSpace(filter.SalesPersonText))
            {
                string[] SPList = filter.SalesPersonText.Split(',');
                if (SPList != null)
                {
                    foreach (var item in SPList)
                    {
                        SalesPerson.Add(item);
                    }
                }

            }
            ViewBag.SalesPersonList = SalesPerson;


            List<string> branch = new List<string>();

            if (!string.IsNullOrWhiteSpace(filter.BranchidText))
            {
                string[] SPList = filter.BranchidText.Split(',');
                if (SPList != null)
                {
                    foreach (var item in SPList)
                    {
                        branch.Add(item);
                    }
                }

            }
            ViewBag.BranchIdList = branch;


            List<string> Status = new List<string>();

            if (!string.IsNullOrWhiteSpace(filter.LeadStatusText))
            {
                string[] SPList = filter.LeadStatusText.Split(',');
                if (SPList != null)
                {
                    foreach (var item in SPList)
                    {
                        Status.Add(item);
                    }
                }

            }
            ViewBag.StatusList = Status;

            List<string> CutomerStatus = new List<string>();

            if (!string.IsNullOrWhiteSpace(filter.StatusText))
            {
                string[] SPList = filter.StatusText.Split(',');
                if (SPList != null)
                {
                    foreach (var item in SPList)
                    {
                        CutomerStatus.Add(item);
                    }
                }

            }
            ViewBag.CustomerStatusList = CutomerStatus;

            List<string> CreatedBy = new List<string>();

            if (!string.IsNullOrWhiteSpace(filter.CreatedBy))
            {
                string[] SPList = filter.CreatedBy.Split(',');
                if (SPList != null)
                {
                    foreach (var item in SPList)
                    {
                        CreatedBy.Add(item);
                    }
                }

            }
            ViewBag.CreatedByList = CreatedBy;

            List<string> AssignedUser = new List<string>();
            List<string> EmployeeList = new List<string>();
            if (!string.IsNullOrWhiteSpace(filter.Installer))
            {
                string[] SPList = filter.Installer.Split(',');
                if (SPList != null)
                {
                    foreach (var item in SPList)
                    {
                        AssignedUser.Add(item);
                    }
                }
                if (filter.Installer.Contains("00000000-0000-0000-0000-000000000000"))
                {
                    EmployeeList.Add("Unassigned");
                }
                EmployeeList.AddRange(_Util.Facade.EmployeeFacade.GetEmployeeList(AssignedUser));

            }

            #endregion
            filter.EmployeeRole = currentLoggedIn.UserTags;
            filter.UserRole = currentLoggedIn.UserRole;
            filter.EmployeeId = currentLoggedIn.UserId.ToString();
            filter.CompanyId = currentLoggedIn.CompanyId.Value;
            filter.Partners = _Util.Facade.EmployeeFacade.GetEmployeeByPartnerId(currentLoggedIn.UserId);
            if (filter.isLead)
            {
                filter.isPermit = IsPermitted(UserPermissions.CustomerPermissions.ShowAllLeadList);
            }
            else
            {
                filter.isPermit = IsPermitted(UserPermissions.CustomerPermissions.ShowAllCustomerList);
            }

            filter.LeadStatusText = Server.UrlDecode(filter.LeadStatusText);

            if (!string.IsNullOrWhiteSpace(filter.SearchText))
            {
                filter.SearchText = Server.UrlDecode(filter.SearchText);
            }
            #region Not using it anymore
            //if (currentLoggedIn.UserId != new Guid())
            //{
            //    var objRoleEmployee = _Util.Facade.EmployeeFacade.GetEmployeeRoleByEmployeeIdAndCompanyId(currentLoggedIn.UserId, currentLoggedIn.CompanyId.Value);
            //    filter.EmployeeRole = objRoleEmployee.Tag;
            //    filter.UserRole = currentLoggedIn.UserRole;
            //    filter.EmployeeId = currentLoggedIn.UserId.ToString();
            //}

            //outputstring += stopwatch.ElapsedMilliseconds.ToString() + " :: ";
            #endregion

            CustomerTableWithCount customerfilterlist = new CustomerTableWithCount();
            ViewBag.CustomerUiSetting = _Util.Facade.GlobalSettingsFacade.GetAllGlobalSettings().Where(x => x.Tag == "CustomerUiSettings").ToList();
            if (filter.PageNo == 0)
            {
                filter.PageNo = 1;
            }

            GlobalSetting glob = _Util.Facade.GlobalSettingsFacade.GetGlobalSettingsByKey(currentLoggedIn.CompanyId.Value, "CustomerListPageSize");
            if (glob != null)
            {
                filter.PageSize = Convert.ToInt32(glob.Value);
            }
            else
            {
                filter.PageSize = 10;
            }

            #region No in use
            //outputstring += stopwatch.ElapsedMilliseconds.ToString() + " :: ";
            //filter.PageSize = 10; 
            //if (!string.IsNullOrEmpty(filter.SearchText))
            //{
            //    string str = filter.SearchText;
            //    str = str.Replace(" ", "");
            //    filter.SearchText = str;
            //}
            //Need to change
            //if (!currentLoggedIn.UserTags.Contains("admin") && currentLoggedIn.UserRole != "Sales Manager")
            //{
            //    filter.SoldById = currentLoggedIn.UserId;
            //    customerfilterlist = _Util.Facade.CustomerFacade.GetCustomerByFilter(filter);
            //    //List<CustomerIdList> idList = _Util.Facade.CustomerFacade.GetCustomerByFilterwithoutPagination(filter);

            //    Session["GetCustomerFilter"] = filter;

            //    //outputstring += stopwatch.ElapsedMilliseconds.ToString() + " :: ";

            //}
            //else
            //{
            //List<CustomerIdList> idList = _Util.Facade.CustomerFacade.GetCustomerByFilterwithoutPagination(filter);

            //outputstring += stopwatch.ElapsedMilliseconds.ToString() + " :: ";

            //}
            #endregion
            if (string.IsNullOrEmpty(filter.SettingOrderBy))
            {
                GlobalSetting settingOrd = _Util.Facade.GlobalSettingsFacade.GetGlobalSettingsByKey(currentLoggedIn.CompanyId.Value, "CustomerListOrder");
                if (settingOrd != null)
                {
                    filter.SettingOrderBy = settingOrd.Value.ToString();
                }
                else
                {
                    filter.SettingOrderBy = "Id desc";
                }
            }
            filter.OrderPermission = PermissionChecker.IsPermitted(PermissionList.MenuPermissions.LeftMenuOrders);
            #region note in grid
            var CurrentTimeZone = "";

            TimeZoneInfo currentTimeZone = TimeZoneInfo.Local;
            string CookieCurrentUser = Request.Cookies[CookieKeys.CurrentUser].Value;
            filter.HourstoCount = 360;

            if (!string.IsNullOrWhiteSpace(CookieCurrentUser))
            {
                string[] splitCurrentUser = CookieCurrentUser.Split('&');
                CurrentTimeZone = splitCurrentUser[0];
                var ctz = CurrentTimeZone.Split('=');
                var TimeZoneId = ctz[1];
                var ctzid = splitCurrentUser[3].Split('=');
                var Hourstocount = Convert.ToInt32(TimeZoneId);
                filter.HourstoCount = Hourstocount;
            }
            string newCookie = "";
            string SelectedFilter = "";
            if (Request.Cookies[CookieKeys.DateViewFilter] != null && !string.IsNullOrWhiteSpace(Request.Cookies[CookieKeys.DateViewFilter].Value))
            {
                newCookie = Request.Cookies[CookieKeys.DateViewFilter].Value;
                newCookie = Server.UrlDecode(newCookie);
                var CookieVals = newCookie.Split(',');

                if (CookieVals.Length == 3)
                {
                    filter.FirstDate = CookieVals[0].ToDateTime();
                    filter.LastDate = CookieVals[1].ToDateTime();
                    SelectedFilter = CookieVals[2];
                    if (filter.IsFavorite || filter.MyLeads)
                    {
                        SelectedFilter = "alltime";
                    }
                }
            }
            #region grate note settings
            var settingsNote = _Util.Facade.GlobalSettingsFacade.GetGlobalSettingsByKey(currentLoggedIn.CompanyId.Value, "ShowNotesInGrid");
            if (settingsNote != null)
            {
                bool showNotes = false;
                bool.TryParse(settingsNote.Value, out showNotes);

                filter.ShowNotesInGrid = showNotes;
            }
            else
            {
                filter.ShowNotesInGrid = false;
            }
            #endregion

            #region CSM note settings
            var settingsNoteCSM = _Util.Facade.GlobalSettingsFacade.GetGlobalSettingsByKey(currentLoggedIn.CompanyId.Value, "ShowNotesInGridCSM");
            if (settingsNoteCSM != null)
            {
                bool showNotescsm = false;
                bool.TryParse(settingsNoteCSM.Value, out showNotescsm);

                filter.ShowNotesInGridCSM = showNotescsm;
            }
            else
            {
                filter.ShowNotesInGridCSM = false;
            }
            #endregion

            #region Not Interested Lead List Status
            var NotInterestedLead = _Util.Facade.GlobalSettingsFacade.GetGlobalSettingsByKey(currentLoggedIn.CompanyId.Value, "RemoveNotInterestedStatusLeadFromList");
            if (NotInterestedLead != null)
            {
                bool HideNotInterestedLead = false;
                bool.TryParse(NotInterestedLead.Value, out HideNotInterestedLead);

                filter.HideNotInterestedLead = HideNotInterestedLead;
            }
            else
            {
                filter.HideNotInterestedLead = false;
            }
            #endregion

            if (Session["GetCustomerFilter"] != null)
            {
                CustomerLiteFilter CustomerListGettingFinter = (CustomerLiteFilter)Session["GetCustomerFilter"];
                if (CustomerListGettingFinter != null)
                {
                    if (string.IsNullOrWhiteSpace(CustomerListGettingFinter.from))
                    {
                        filter.from = "";
                    }
                }
            }
            #endregion
            bool abc = false;
            bool fav = false;
            bool mylead = false;
            if (!string.IsNullOrWhiteSpace(filter.FirstNameText))
            {
                abc = true;
            }
            else if (!string.IsNullOrWhiteSpace(filter.LastNameText))
            {
                abc = true;
            }
            else if (!string.IsNullOrWhiteSpace(filter.BusinessNameText))
            {
                abc = true;
            }
            else if (!string.IsNullOrWhiteSpace(filter.Installer))
            {
                abc = true;
            }
            else if (!string.IsNullOrWhiteSpace(filter.LeadSourceText))
            {
                abc = true;
            }
            else if (!string.IsNullOrWhiteSpace(filter.CustomerAccountTypeText) && filter.CustomerAccountTypeText != "CustomerAccountType#-1")
            {
                abc = true;
            }
            else if (!string.IsNullOrWhiteSpace(filter.Industry))
            {
                abc = true;
            }
            else if (!string.IsNullOrWhiteSpace(filter.LeadStatusText) && filter.LeadStatusText != "-1")
            {
                abc = true;
            }
            else if (filter.UpdatedFrom != new DateTime())
            {
                abc = true;
            }
            else if (filter.UpdatedTo != new DateTime())
            {
                abc = true;
            }
            if (filter.IsFavorite)
            {
                fav = true;
            }
            if (filter.MyLeads)
            {
                mylead = true;
            }
            if (fav)
            {
                Session[SessionKeys.IsFavFilter] = filter.IsFavorite;
            }
            else
            {
                Session[SessionKeys.IsFavFilter] = null;
            }
            if (mylead)
            {
                Session[SessionKeys.IsMyLeads] = filter.MyLeads;
            }
            else
            {
                Session[SessionKeys.IsMyLeads] = null;
            }
            if (abc)
            {
                Session[SessionKeys.CustoemrFilter] = filter;
            }
            else
            {
                Session[SessionKeys.CustoemrFilter] = null;
            }

            if (Request.Cookies["_LeadPageSizeCookie"] != null)
            {
                filter.PageSize = Convert.ToInt32(Request.Cookies[CookieKeys.LeadPageSize].Value);
            }
            if (Request.Cookies["_SortCookie"] != null)
            {
                filter.SettingOrderBy = Server.UrlDecode(Request.Cookies[CookieKeys.SortCookie].Value);
            }
            customerfilterlist = _Util.Facade.CustomerFacade.GetCustomerByLiteFilter(filter);
            //string Leads = "LeadStatus";
            //List<Lookup> Statustext = _Util.Facade.LookupFacade.GetLookupByKey(Leads, true, true);
            //customerfilterlist = _Util.Facade.CustomerFacade.GetCustomerByLiteFiltertext(filter, Statustext);
            #region Header Text
            if (filter.from == "Initial")
            {
                SelectedFilter = "Recent History";
            }
            else if (!string.IsNullOrWhiteSpace(filter.SearchText))
            {
                SelectedFilter = "Search by: " + filter.SearchText;
            }
            else if (!string.IsNullOrWhiteSpace(filter.BusinessNameText) || !string.IsNullOrWhiteSpace(filter.CellNoText) || !string.IsNullOrWhiteSpace(filter.CustomerTypeText) || !string.IsNullOrWhiteSpace(filter.DisplayNameText) || !string.IsNullOrWhiteSpace(filter.FirstNameText) || !string.IsNullOrWhiteSpace(filter.LastNameText) || !string.IsNullOrWhiteSpace(filter.PrimaryPhoneText))
            {
                SelectedFilter = "Search by Filter";
            }
            else if (SelectedFilter.ToLower() == "thisweek")
            {
                SelectedFilter = "This Week";
            }
            else if (SelectedFilter.ToLower() == "lastweek")
            {
                SelectedFilter = "Last Week";
            }
            else if (SelectedFilter.ToLower() == "thismonth")
            {
                SelectedFilter = "This Month";
            }
            else if (SelectedFilter.ToLower() == "lastmonth")
            {
                SelectedFilter = "Last Month";
            }
            else if (SelectedFilter.ToLower() == "thisyear")
            {
                SelectedFilter = "This Year";
            }
            else if (SelectedFilter.ToLower() == "lastyear")
            {
                SelectedFilter = "Last Year";
            }
            else if (SelectedFilter.ToLower() == "alltime" || SelectedFilter.ToLower() == "-1")
            {
                SelectedFilter = "All Time";
            }
            else if (SelectedFilter.ToLower() == "custom" && filter.FirstDate == new DateTime() && filter.LastDate == new DateTime())
            {
                SelectedFilter = "All Time";
            }
            #endregion
            #region MoneyHeader Count 
            String LeadTopper = "";
            if (filter.isLead)
            {
                //var viewModel = new LeadLiteTopCardViewModel
                //{
                //    Statuslist = customerfilterlist.Statuslist
                //};

                LeadTopper = RenderViewToString("Template", "~/Views/Leads/_LeadLiteTopCard.cshtml", customerfilterlist.LeadHeaderStatusBar);
            }


            #endregion
            Session["GetCustomerFilter"] = filter;

            #region Paging Ready
            if (customerfilterlist.CustomerList.Rows.Count == 0)
            {
                filter.PageNo = 1;
            }
            Entities.CustomerPaging paging = new Entities.CustomerPaging();
            paging.PageNumber = filter.PageNo;
            paging.OutOfNumber = 0;
            paging.IsLead = filter.isLead;

            if (customerfilterlist.CustomerList.Rows.Count > 0)
            {
                paging.OutOfNumber = customerfilterlist.TotalCustomerCount.Counter;
            }

            if (paging.PageNumber * filter.PageSize > paging.OutOfNumber)
            {
                paging.CurrentNumber = paging.OutOfNumber;
            }
            else
            {
                paging.CurrentNumber = paging.PageNumber * filter.PageSize;
            }
            double pagecount = (double)paging.OutOfNumber / (double)filter.PageSize;
            paging.PageCount = (int)(Math.Ceiling(pagecount));
            paging.PageSize = filter.PageSize;
            paging.PageList = _Util.Facade.LookupFacade.GetLookupByKey("PageSize").Select(x =>
                    new SelectListItem()
                    {
                        Text = x.DisplayText.ToString(),
                        Value = x.DataValue.ToString(),
                    }).ToList();
            String renderedHTML = RenderViewToString("Template", "~/Views/Customer/_CustomerLitePaging.cshtml", paging);

            #endregion
            customerfilterlist.CustomerListString = DataTableToJSONWithJSONNet(customerfilterlist.CustomerList);
            customerfilterlist.CustomerList = null;
            if (customerfilterlist.CustomerHeaderMoneyBar != null)
            {
                ViewBag.OrderCount = customerfilterlist.CustomerHeaderMoneyBar.OrderCount;
                ViewBag.OrderValue = customerfilterlist.CustomerHeaderMoneyBar.OrderValue;
            }
            filter.LeadSourceText = HttpUtility.UrlDecode(filter.LeadSourceText);
            filter.CustomerAccountTypeText = HttpUtility.UrlDecode(filter.CustomerAccountTypeText);
            filter.Industry = HttpUtility.UrlDecode(filter.Industry);
            return Json(new { result = customerfilterlist, paged = renderedHTML, searchdatetext = SelectedFilter, LeadTopper = LeadTopper, favorite = filter.IsFavorite, LeadSearchText = filter.LeadStatusText, mylead = filter.MyLeads, EmployeeList = EmployeeList, filter = filter, JsonRequestBehavior.AllowGet });
        }
        [Authorize]
        public JsonResult CustomerListFilteredLite(CustomerLiteFilter filter)
        { 
            if (!string.IsNullOrWhiteSpace(filter.SearchText))
            { 
                string decodedSearchText = HttpUtility.UrlDecode(filter.SearchText);
                if (decodedSearchText.Contains("&#39;"))
                {
                    decodedSearchText = decodedSearchText.Replace("&#39;", "%60");
                    filter.SearchText = decodedSearchText; 
                }
                else
                {
                    decodedSearchText = decodedSearchText.Replace("'", "`");
                    filter.SearchText = decodedSearchText; 
                } 
            }
            string outputstring = "";

            if (!base.IsPermitted(UserPermissions.CustomerPermissions.CustomerList))
            {
                return Json(0, JsonRequestBehavior.AllowGet);
            }
            var currentLoggedIn = ((HS.Web.UI.Helper.CustomPrincipal)(User));
            #region multipleselect
            List<string> SalesLocation = new List<string>();

            if (!string.IsNullOrWhiteSpace(filter.SalesLocationText))
            {
                string[] SPList = filter.SalesLocationText.Split(',');
                if (SPList != null)
                {
                    foreach (var item in SPList)
                    {
                        SalesLocation.Add(item);
                    }
                }

            }
            ViewBag.SalesLocationList = SalesLocation;

            List<string> LeadSourceList = new List<string>();

            if (!string.IsNullOrWhiteSpace(filter.LeadSourceText))
            {
                string[] sourceList = filter.LeadSourceText.Split(',');
                if (sourceList != null)
                {
                    foreach (var item in sourceList)
                    {
                        LeadSourceList.Add(item);
                    }
                }

            }
            ViewBag.LeadSourceList = LeadSourceList;

            List<string> SalesPerson = new List<string>();

            if (!string.IsNullOrWhiteSpace(filter.SalesPersonText))
            {
                string[] SPList = filter.SalesPersonText.Split(',');
                if (SPList != null)
                {
                    foreach (var item in SPList)
                    {
                        SalesPerson.Add(item);
                    }
                }

            }
            ViewBag.SalesPersonList = SalesPerson;


            List<string> branch = new List<string>();

            if (!string.IsNullOrWhiteSpace(filter.BranchidText))
            {
                string[] SPList = filter.BranchidText.Split(',');
                if (SPList != null)
                {
                    foreach (var item in SPList)
                    {
                        branch.Add(item);
                    }
                }

            }
            ViewBag.BranchIdList = branch;


            List<string> Status = new List<string>();

            if (!string.IsNullOrWhiteSpace(filter.LeadStatusText))
            {
                string[] SPList = filter.LeadStatusText.Split(',');
                if (SPList != null)
                {
                    foreach (var item in SPList)
                    {
                        Status.Add(item);
                    }
                }

            }
            ViewBag.StatusList = Status;

            List<string> CutomerStatus = new List<string>();

            if (!string.IsNullOrWhiteSpace(filter.StatusText))
            {
                string[] SPList = filter.StatusText.Split(',');
                if (SPList != null)
                {
                    foreach (var item in SPList)
                    {
                        CutomerStatus.Add(item);
                    }
                }

            }
            ViewBag.CustomerStatusList = CutomerStatus;

            #endregion
            filter.EmployeeRole = currentLoggedIn.UserTags;
            filter.UserRole = currentLoggedIn.UserRole;
            filter.EmployeeId = currentLoggedIn.UserId.ToString();
            filter.CompanyId = currentLoggedIn.CompanyId.Value;
            //no need in DFW
            //filter.Partners = _Util.Facade.EmployeeFacade.GetEmployeeByPartnerId(currentLoggedIn.UserId);
            filter.isPermit = IsPermitted(UserPermissions.CustomerPermissions.ShowAllCustomerList);

            if (!string.IsNullOrWhiteSpace(filter.LeadStatusText))
            {
                filter.LeadStatusText = Server.UrlDecode(filter.LeadStatusText);
            }
            
            if (!string.IsNullOrWhiteSpace(filter.SearchText))
            {
                filter.SearchText = Server.UrlDecode(filter.SearchText);
            }
            


            #region Not using it anymore
            //if (currentLoggedIn.UserId != new Guid())
            //{
            //    var objRoleEmployee = _Util.Facade.EmployeeFacade.GetEmployeeRoleByEmployeeIdAndCompanyId(currentLoggedIn.UserId, currentLoggedIn.CompanyId.Value);
            //    filter.EmployeeRole = objRoleEmployee.Tag;
            //    filter.UserRole = currentLoggedIn.UserRole;
            //    filter.EmployeeId = currentLoggedIn.UserId.ToString();
            //}

            //outputstring += stopwatch.ElapsedMilliseconds.ToString() + " :: ";
            #endregion

            CustomerTableWithCount customerfilterlist = new CustomerTableWithCount();




            ViewBag.CustomerUiSetting = _Util.Facade.GlobalSettingsFacade.GetAllGlobalSettings().Where(x => x.Tag == "CustomerUiSettings").ToList();
            if (filter.PageNo == 0)
            {
                filter.PageNo = 1;
            }

            GlobalSetting glob = _Util.Facade.GlobalSettingsFacade.GetGlobalSettingsByKey(currentLoggedIn.CompanyId.Value, "CustomerListPageSize");
            if (glob != null)
            {
                filter.PageSize = Convert.ToInt32(glob.Value);
            }
            else
            {
                filter.PageSize = 10;
            }
            Session["GetCustomerFilterLite"] = filter;
            #region No in use
            //outputstring += stopwatch.ElapsedMilliseconds.ToString() + " :: ";
            //filter.PageSize = 10; 
            //if (!string.IsNullOrEmpty(filter.SearchText))
            //{
            //    string str = filter.SearchText;
            //    str = str.Replace(" ", "");
            //    filter.SearchText = str;
            //}
            //Need to change
            //if (!currentLoggedIn.UserTags.Contains("admin") && currentLoggedIn.UserRole != "Sales Manager")
            //{
            //    filter.SoldById = currentLoggedIn.UserId;
            //    customerfilterlist = _Util.Facade.CustomerFacade.GetCustomerByFilter(filter);
            //    //List<CustomerIdList> idList = _Util.Facade.CustomerFacade.GetCustomerByFilterwithoutPagination(filter);

            //    Session["GetCustomerFilter"] = filter;

            //    //outputstring += stopwatch.ElapsedMilliseconds.ToString() + " :: ";

            //}
            //else
            //{
            //List<CustomerIdList> idList = _Util.Facade.CustomerFacade.GetCustomerByFilterwithoutPagination(filter);

            //outputstring += stopwatch.ElapsedMilliseconds.ToString() + " :: ";

            //}
            #endregion
            if (string.IsNullOrEmpty(filter.SettingOrderBy))
            {
                GlobalSetting settingOrd = _Util.Facade.GlobalSettingsFacade.GetGlobalSettingsByKey(currentLoggedIn.CompanyId.Value, "CustomerListOrder");
                if (settingOrd != null)
                {
                    filter.SettingOrderBy = settingOrd.Value.ToString();
                }
                else
                {
                    filter.SettingOrderBy = "Id desc";
                }
            }
            filter.OrderPermission = PermissionChecker.IsPermitted(PermissionList.MenuPermissions.LeftMenuOrders);
            customerfilterlist = _Util.Facade.CustomerFacade.GetCustomerByLiteFilter(filter);


            Session["GetCustomerFilter"] = filter;

            #region Paging Ready
            if (customerfilterlist.CustomerList.Rows.Count == 0)
            {
                filter.PageNo = 1;
            }
            Entities.CustomerPaging paging = new Entities.CustomerPaging();
            paging.PageNumber = filter.PageNo;
            paging.OutOfNumber = 0;
            paging.IsLead = filter.isLead;

            if (customerfilterlist.CustomerList.Rows.Count > 0)
            {
                paging.OutOfNumber = customerfilterlist.TotalCustomerCount.Counter;
            }

            if (paging.PageNumber * filter.PageSize > paging.OutOfNumber)
            {
                paging.CurrentNumber = paging.OutOfNumber;
            }
            else
            {
                paging.CurrentNumber = paging.PageNumber * filter.PageSize;
            }
            double pagecount = (double)paging.OutOfNumber / (double)filter.PageSize;
            paging.PageCount = (int)(Math.Ceiling(pagecount));
            String renderedHTML = RenderViewToString("Template", "~/Views/Customer/_CustomerLitePaging.cshtml", paging);

            #endregion

            #region MoneyHeader Count 

            String CustomerTopper = "";
            if (!filter.isLead)
                CustomerTopper = RenderViewToString("Template", "~/Views/Customer/_CustomerLiteTopCard.cshtml", customerfilterlist.CustomerHeaderMoneyBar);

            #endregion

            customerfilterlist.CustomerListString = DataTableToJSONWithJSONNet(customerfilterlist.CustomerList);
            customerfilterlist.CustomerList = null;
            if (customerfilterlist.CustomerHeaderMoneyBar != null)
            {
                ViewBag.OrderCount = customerfilterlist.CustomerHeaderMoneyBar.OrderCount;
                ViewBag.OrderValue = customerfilterlist.CustomerHeaderMoneyBar.OrderValue;
            }
            return Json(new { result = customerfilterlist, paged = renderedHTML, CustomerTopper = CustomerTopper, JsonRequestBehavior.AllowGet });
        }
        public string DataTableToJSONWithJSONNet(DataTable table)
        {
            string JSONString = string.Empty;


            JSONString = JsonConvert.SerializeObject(table);
            return JSONString;
        }
        //IEnumerable<CustomerFilter> GetAllEmployee()
        //{
        //    using (ApplicationDbContext dB = new ApplicationDbContext())
        //    {
        //        var customerList = dB.CustomerFilter.ToList<CustomerFilter>();
        //        return customerList;
        //    }
        //}
        //public ActionResult CustomerListFiltered2(CustomerFilter filter)
        //{         
        //    return View();
        //}
        //public JsonResult CustomerListFiltered3(CustomerFilter filter)
        //{
        //    var customer = CustomerListFiltered(filter);
        //    return Json(new { Customer = customer });
        //}
        [Authorize]
        public ActionResult GetCustomerListPdfView(string UserList, string SourceList, string firstdate, string lastdate)
        {
            var CurrentLoggedInUser = (HS.Web.UI.Helper.CustomPrincipal)User;

            List<Customer> cusmod = _Util.Facade.CustomerFacade.GetAllCustomerListByFiltering(CurrentLoggedInUser.CompanyId.Value, UserList, SourceList, firstdate, lastdate);
            ViewBag.User = UserList;
            ViewBag.Source = SourceList;
            ViewBag.First = firstdate;
            ViewBag.Last = lastdate;
            //CustomerListPDF(UserList, SourceList, firstdate, lastdate);
            return PartialView("GetCustomerListPdfView", cusmod);
        }

        [Authorize]
        public ActionResult CustomerListPDF(string data1, string data2, string data3, string data4)
        {
            var CurrentLoggedInUser = (HS.Web.UI.Helper.CustomPrincipal)User;
            List<Customer> cus = _Util.Facade.CustomerFacade.GetAllCustomerListByFiltering(CurrentLoggedInUser.CompanyId.Value, data1, data2, data3, data4);
            return PartialView("CustomerListPDF", cus);
        }

        [Authorize]
        public ActionResult CustomerCreatedHistory(Guid CustomerId)
        {
            var CurrentLoggedInUser = (HS.Web.UI.Helper.CustomPrincipal)User;
            if (CurrentLoggedInUser == null)
            {
                return PartialView("~/Views/Shared/_AccessDenied.cshtml");
            }
            else if (CustomerId == null)
            {
                return PartialView("~/Views/Shared/_AccessDenied.cshtml");
            }
            else
            {
                CustomerSnapshot objCustomerSnapshot = _Util.Facade.CustomerSnapshotFacade.GetCustomerCreatedHistoryByCustomerIdAndCustomerCreatedHistoryKey(CustomerId, CurrentLoggedInUser.CompanyId.Value);
                return PartialView("_CustomerCreatedHistoryPartial", objCustomerSnapshot);
            }
        }

        [Authorize]
        public ActionResult CustomerFromLeadConvartedHistory(Guid CustomerId)
        {
            var CurrentLoggedInUser = (HS.Web.UI.Helper.CustomPrincipal)User;
            if (CurrentLoggedInUser == null)
            {
                return PartialView("~/Views/Shared/_AccessDenied.cshtml");
            }
            else if (CustomerId == null)
            {
                return PartialView("~/Views/Shared/_AccessDenied.cshtml");
            }
            else
            {
                CustomerSnapshot objCustomerSnapshot = _Util.Facade.CustomerSnapshotFacade.GetCustomerFromLeadConvartedHistoryByCustomerIdAndConvertLeadToCustomer(CustomerId, CurrentLoggedInUser.CompanyId.Value);
                return PartialView("_CustomerFromLeadConvartedHistory", objCustomerSnapshot);
            }
        }

        [Authorize]
        public ActionResult CustomerInvoiceHistories(Guid CustomerId)
        {
            var CurrentLoggedInUser = (HS.Web.UI.Helper.CustomPrincipal)User;
            if (CurrentLoggedInUser == null)
            {
                return PartialView("~/Views/Shared/_AccessDenied.cshtml");
            }
            else if (CustomerId == null)
            {
                return PartialView("~/Views/Shared/_AccessDenied.cshtml");
            }
            else
            {
                List<CustomerSnapshot> objCustomerSnapshot = _Util.Facade.CustomerSnapshotFacade.GetCustomerInvoiceHistoryByCustomerIdAndInvoiceCreatedKey(CustomerId, CurrentLoggedInUser.CompanyId.Value);
                return PartialView("_CustomerInvoiceHistoriesPartial", objCustomerSnapshot);
            }
        }

        [Authorize]
        public ActionResult CustomerSendEmailHistory(Guid CustomerId)
        {
            var CurrentLoggedInUser = (HS.Web.UI.Helper.CustomPrincipal)User;
            if (CurrentLoggedInUser == null)
            {
                return PartialView("~/Views/Shared/_AccessDenied.cshtml");
            }
            else if (CustomerId == null)
            {
                return PartialView("~/Views/Shared/_AccessDenied.cshtml");
            }
            else
            {
                List<CustomerSnapshot> listCustomerSendEmailHistory = _Util.Facade.CustomerSnapshotFacade.GetAllCustomerSendEmailHistoryByCompanyIdAndCustomerIdAndType(CustomerId, CurrentLoggedInUser.CompanyId.Value);
                Employee emp = _Util.Facade.EmployeeFacade.GetEmployeeByEmployeeId(CurrentLoggedInUser.UserId);
                if (emp != null)
                {
                    ViewBag.EmpName = emp.FirstName + " " + emp.LastName;
                }
                return View("CustomerSendEmailHistory", listCustomerSendEmailHistory);
            }
        }

        [Authorize]
        public ActionResult CustomerServiceOrderHistories(Guid CustomerId)
        {
            var CurrentLoggedInUser = (HS.Web.UI.Helper.CustomPrincipal)User;
            if (CurrentLoggedInUser == null)
            {
                return PartialView("~/Views/Shared/_AccessDenied.cshtml");
            }
            else if (CustomerId == null)
            {
                return PartialView("~/Views/Shared/_AccessDenied.cshtml");
            }
            else
            {
                List<CustomerSnapshot> objCustomerSnapshot = _Util.Facade.CustomerSnapshotFacade.GetCustomerServiceOrderHistoryByCustomerIdAndServiceOrderCreatedKey(CustomerId, CurrentLoggedInUser.CompanyId.Value);
                return PartialView("_CustomerServiceOrderHistoriesPartial", objCustomerSnapshot);
            }
        }

        [Authorize]
        public ActionResult CustomerWorkOrderHistories(Guid CustomerId)
        {
            var CurrentLoggedInUser = (HS.Web.UI.Helper.CustomPrincipal)User;
            if (CurrentLoggedInUser == null)
            {
                return PartialView("~/Views/Shared/_AccessDenied.cshtml");
            }
            else if (CustomerId == null)
            {
                return PartialView("~/Views/Shared/_AccessDenied.cshtml");
            }
            else
            {
                List<CustomerSnapshot> objCustomerSnapshot = _Util.Facade.CustomerSnapshotFacade.GetCustomerWorkOrderHistoryByCustomerIdAndWorkOrderCreatedKey(CustomerId, CurrentLoggedInUser.CompanyId.Value);
                return PartialView("_CustomerWorkOrderHistoriesPartial", objCustomerSnapshot);

            }
        }

        [Authorize]
        public ActionResult CustomerResponsiblePersonDetail(Guid CustomerId)
        {
            var CurrentLoggedInUser = (HS.Web.UI.Helper.CustomPrincipal)User;
            int id = 0;
            var cusobj = _Util.Facade.CustomerFacade.GetCustomerByCustomerId(CustomerId);
            if (cusobj != null)
            {
                id = cusobj.Id;
                ViewBag.CustomerId = id;
            }
            List<LeadEmergencyDetail> model = _Util.Facade.EmergencyContactFacade.GetAllCustomerEmergencyDetailByLeadIdandCompanyId(CurrentLoggedInUser.CompanyId.Value, id); ;
            return PartialView("CustomerResponsiblePersonDetail", model);
        }
        [Authorize]
        public ActionResult CustomerContacts(Guid CustomerId, string soldby)
        {

            var CurrentLoggedInUser = (HS.Web.UI.Helper.CustomPrincipal)User;
            string ContactIds = "";
            List<Contact> contactList = new List<Contact>();
            List<UserContact> UserContactList = _Util.Facade.ContactFacade.GetAllUserContactsByCustomerId(CustomerId);
            if (UserContactList.Count > 0)
            {
                foreach (var item in UserContactList)
                {
                    ContactIds += string.Format("'{0}',", item.ContactId);
                }
                ContactIds = ContactIds.Remove(ContactIds.Length - 1, 1);
                contactList = _Util.Facade.ContactFacade.GetAllContactListByContactIds(ContactIds);
            }

            ViewBag.CustomerId = CustomerId;
            ViewBag.SoldBy = soldby;
            return View(contactList);
        }

        [Authorize]
        public ActionResult CustomerActivities(Guid CustomerId)
        {

            var CurrentLoggedInUser = (HS.Web.UI.Helper.CustomPrincipal)User;

            List<HS.Entities.Activity> ActivityList = _Util.Facade.ActivityFacade.GetAllActivityListByAssociatWith(CustomerId);


            ViewBag.CustomerId = CustomerId;
            return View(ActivityList);
        }
        [Authorize]
        public ActionResult CustomerApiSettingDetail(Guid CustomerId)
        {
            List<CustomerApiSetting> setting = _Util.Facade.CustomerApiSettingFacade.GetAllApiSettingDetailByCustomerId(CustomerId);
            foreach (var item in setting)
            {
                if (item.AccountName == "Alarm.com")
                {
                    ViewBag.AlarmUrl = item.Url;
                    ViewBag.AlarmUser = item.UserName;
                    ViewBag.AlarmPass = item.Password;
                }
                if (item.AccountName == "Monitronics")
                {
                    ViewBag.MoniUrl = item.Url;
                    ViewBag.MoniUser = item.UserName;
                    ViewBag.MoniPass = item.Password;
                }
                if (item.AccountName == "Central Station")
                {
                    ViewBag.CenUrl = item.Url;
                    ViewBag.CenUser = item.UserName;
                    ViewBag.CenPass = item.Password;
                }
            }
            return PartialView("CustomerApiSettingDetail", setting);
        }

        [Authorize]
        public ActionResult CustomerSystemInfoDetails(Guid CustomerId)
        {
            string IsGrate = ConfigurationManager.AppSettings["IsGrateCrm"];
            if (IsGrate == "true")
            {
                return null;
            }
            var ObjSystemInfo = _Util.Facade.CustomerSystemInfoFacade.GetAllCustomerSystemInfoDetailsByCustomerId(CustomerId);
            var objcus = _Util.Facade.CustomerFacade.GetCustomerByCustomerId(CustomerId);
            if (objcus != null)
            {
                ViewBag.cusid = objcus.Id;
            }
            return PartialView("CustomerSystemInfoDetails", ObjSystemInfo);
        }

        [Authorize]
        public ActionResult CustomerAccountActivityDetails(Guid CustomerId)
        {
            var CurrentLoggedInUser = (HS.Web.UI.Helper.CustomPrincipal)User;
            var ObjActivity = _Util.Facade.CustomerFacade.GetAllAccountActivityByCustomerId(CustomerId);
            var CustomerUiSetting = _Util.Facade.GlobalSettingsFacade.GetAllGlobalSettingsByCompanyId(CurrentLoggedInUser.CompanyId.Value).Where(x => x.Tag == "CustomerUiSettings").ToList();
            if (CustomerUiSetting.Where(x => x.SearchKey == "Cut-in-date").FirstOrDefault().Value.ToLower() == "false")
            {
                ObjActivity.CutInDate = null;
            }
            if (CustomerUiSetting.Where(x => x.SearchKey == "FundingDate").FirstOrDefault().Value.ToLower() == "false")
            {
                ObjActivity.CustomerFundedDate = null;
            }
            if (CustomerUiSetting.Where(x => x.SearchKey == "QAFields").FirstOrDefault().Value.ToLower() == "false")
            {
                ObjActivity.QA1 = null;
                ObjActivity.QA1Date = null;
                ObjActivity.QA2 = null;
                ObjActivity.QA2Date = null;
                ObjActivity.QualityAssurance1 = null;
                ObjActivity.QualityAssurance2 = null;
            }
            if (CustomerUiSetting.Where(x => x.SearchKey == "FireAccount").FirstOrDefault().Value.ToLower() == "false")
            {
                ObjActivity.IsFireAccount = null;
            }
            //if (CustomerUiSetting.Where(x => x.SearchKey == "SignedAgreement").FirstOrDefault().Value.ToLower() == "false")
            //{
            //    ObjActivity.Singature = null;
            //}

            return PartialView("CustomerAccountActivityDetails", ObjActivity);
        }

        [Authorize]
        public ActionResult CustomerBillingHistories(Guid CustomerId)
        {
            var CurrentLoggedInUser = (HS.Web.UI.Helper.CustomPrincipal)User;
            if (CurrentLoggedInUser == null)
            {
                return PartialView("~/Views/Shared/_AccessDenied.cshtml");
            }
            else if (CustomerId == null)
            {
                return PartialView("~/Views/Shared/_AccessDenied.cshtml");
            }
            else
            {
                Customer objBill = _Util.Facade.CustomerFacade.GetAllCustomerBillInfoByCompanyId(CurrentLoggedInUser.CompanyId.Value, CustomerId);
                if (objBill != null)
                {
                    if (!string.IsNullOrWhiteSpace(objBill.MonthlyMonitoringFee))
                    {
                        float n;
                        if (float.TryParse(objBill.MonthlyMonitoringFee, out n))
                        {
                            objBill.MonthlyMonitoringFee = string.Format("{0:0,0.00}", Convert.ToDouble(objBill.MonthlyMonitoringFee));
                        }
                    }

                    if (!string.IsNullOrWhiteSpace(objBill.PayCardNumber))
                    {
                        objBill.PayCardNumber = DESEncryptionDecryption.DecryptCipherTextToPlainText(objBill.PayCardNumber);
                    }
                    if (!string.IsNullOrWhiteSpace(objBill.PayCardExpireDate))
                    {
                        objBill.PayCardExpireDate = DESEncryptionDecryption.DecryptCipherTextToPlainText(objBill.PayCardExpireDate);
                    }
                    if (!string.IsNullOrWhiteSpace(objBill.PayAccountNo))
                    {
                        objBill.PayAccountNo = DESEncryptionDecryption.DecryptCipherTextToPlainText(objBill.PayAccountNo);
                    }
                    var CustomerUiSetting = _Util.Facade.GlobalSettingsFacade.GetAllGlobalSettingsByCompanyId(CurrentLoggedInUser.CompanyId.Value).Where(x => x.Tag == "CustomerUiSettings").ToList();
                    if (CustomerUiSetting.Where(x => x.SearchKey == "CreditScore").FirstOrDefault().Value.ToLower() == "false")
                    {
                        objBill.CreditScore = null;
                    }
                    if (CustomerUiSetting.Where(x => x.SearchKey == "ContractTerm").FirstOrDefault().Value.ToLower() == "false")
                    {
                        objBill.ContractTeam = null;
                    }
                    if (CustomerUiSetting.Where(x => x.SearchKey == "MonitoringFee").FirstOrDefault().Value.ToLower() == "false")
                    {
                        objBill.MonthlyMonitoringFee = null;
                    }
                    if (CustomerUiSetting.Where(x => x.SearchKey == "CustomerFunded").FirstOrDefault().Value.ToLower() == "false")
                    {
                        objBill.CustomerFunded = null;
                    }
                    if (CustomerUiSetting.Where(x => x.SearchKey == "OutstandingBalance").FirstOrDefault().Value.ToLower() == "false")
                    {
                        objBill.BillOutStanding = 0.0;
                    }
                    if (CustomerUiSetting.Where(x => x.SearchKey == "StreetType").FirstOrDefault().Value.ToLower() == "false")
                    {
                        objBill.StreetType = null;
                    }
                    if (CustomerUiSetting.Where(x => x.SearchKey == "FundingCompany").FirstOrDefault().Value.ToLower() == "false")
                    {
                        objBill.FundingCompany = null;
                    }

                }

                return PartialView("CustomerBillingHistories", objBill);
            }
        }


        [Authorize]
        public ActionResult CustomerPreviousData(Guid CustomerId)
        {
            var CurrentLoggedInUser = (HS.Web.UI.Helper.CustomPrincipal)User;
            #region CustomerMigration
            CustomerMigration cusMigration = new CustomerMigration();
            cusMigration = _Util.Facade.CustomerFacade.GetAgemniCustomerByCustomerId(CustomerId);
            #endregion
            return View(cusMigration);

        }

        [Authorize]
        public ActionResult CustomerNoteBoxes(Guid CustomerId)
        {
            var CurrentLoggedInUser = (HS.Web.UI.Helper.CustomPrincipal)User;
            if (CurrentLoggedInUser == null)
            {
                return PartialView("~/Views/Shared/_AccessDenied.cshtml");
            }
            else if (CustomerId == null)
            {
                return PartialView("~/Views/Shared/_AccessDenied.cshtml");
            }
            else
            {
                List<CustomerNote> customerNote = _Util.Facade.NotesFacade.GetAllCustomerNoteByCustomerId(CustomerId, CurrentLoggedInUser.CompanyId.Value);

                //GlobalSetting ShowNoteFirst = _Util.Facade.GlobalSettingsFacade.GetGlobalSettingsByKey(CurrentLoggedInUser.CompanyId.Value, "CustomerDetailNoteReminderPlusButton");
                //ViewBag.CustomerDetailNoteReminderPlusButton = true;
                //if (ShowNoteFirst != null && ShowNoteFirst.Value.ToLower() == "false")
                //{
                //    ViewBag.CustomerDetailNoteReminderPlusButton = false;
                //}

                return PartialView("_CustomerNoteBoxes", customerNote);
            }
        }
        [Authorize]
        public ActionResult CustomerOrderBoxes(Guid CustomerId)
        {
            var CurrentLoggedInUser = (HS.Web.UI.Helper.CustomPrincipal)User;
            if (CurrentLoggedInUser == null)
            {
                return PartialView("~/Views/Shared/_AccessDenied.cshtml");
            }
            else if (CustomerId == null)
            {
                return PartialView("~/Views/Shared/_AccessDenied.cshtml");
            }
            else
            {
                //List<CustomerNote> customerNote = _Util.Facade.NotesFacade.GetAllCustomerNoteByCustomerId(CustomerId, CurrentLoggedInUser.CompanyId.Value);

                //GlobalSetting ShowNoteFirst = _Util.Facade.GlobalSettingsFacade.GetGlobalSettingsByKey(CurrentLoggedInUser.CompanyId.Value, "CustomerDetailNoteReminderPlusButton");
                //ViewBag.CustomerDetailNoteReminderPlusButton = true;
                //if (ShowNoteFirst != null && ShowNoteFirst.Value.ToLower() == "false")
                //{
                //    ViewBag.CustomerDetailNoteReminderPlusButton = false;
                //}

                return PartialView("_CustomerOrderBoxes");
            }
        }

        [Authorize]
        public ActionResult CustomerSalesPersonBox(Guid soldby)
        {
            var CurrentUser = (HS.Web.UI.Helper.CustomPrincipal)User;
            Employee emp = new Employee();
            if (soldby != null && soldby != new Guid())
            {
                emp = _Util.Facade.EmployeeFacade.GetEmployeeByEmployeeId(soldby);
                if (emp == null)
                {
                    emp = new Employee();
                }
            }
            return View(emp);
        }

        [Authorize]
        public ActionResult LoadCustomerFollowUpTabPartial(Guid CustomerId)
        {

            if (!base.IsPermitted(UserPermissions.CustomerPermissions.CustomerFollowUpTab))
            {
                return PartialView("~/Views/Shared/_AccessDenied.cshtml");
            }

            var CurrentLoggedInUser = ((HS.Web.UI.Helper.CustomPrincipal)(User));
            List<CustomerNote> model = new List<CustomerNote>();

            //Customer CustomerInfo = _Util.Facade.CustomerFacade.GetCustomerByCustomerId(CustomerId);
            model = _Util.Facade.CustomerFacade.GetAllCustomerFollowUpByCompanyId(CurrentLoggedInUser.CompanyId.Value, CustomerId);
            ViewBag.CustomerFollowUpPartialCustomerId = CustomerId;
            List<NoteAssign> NoteAssign = _Util.Facade.NoteAssignFacade.GetAllAssignByCustomerIdAndCompanyId(CustomerId, CurrentLoggedInUser.CompanyId.Value);
            foreach (var item in model)
            {
                string AssignName = "";
                List<string> tmp = NoteAssign.Where(x => x.NoteId == item.Id).Select(x => x.AssignName).ToList();
                foreach (var itm in tmp)
                {
                    AssignName += itm + ", ";
                }
                AssignName = AssignName.Remove(AssignName.Length - 2);

                item.AssignName = AssignName;
            }

            return PartialView("_CustomerFollwUpTabPartial", model);
        }

        [Authorize]
        public ActionResult AddNewReminderNote(int? id, Guid CustomerId, string Timeval, string IsComplete)
        {
            var CurrentLoggedInUser = ((HS.Web.UI.Helper.CustomPrincipal)(User));
            CustomerNote model = new CustomerNote();
            if (CurrentLoggedInUser == null)
            {
                return PartialView("~/Views/Shared/_AccessDenied.cshtml");
            }
            else if (!HS.Web.UI.Helper.PermissionHelper.IsPermitted(HS.Framework.UserPermissions.CustomerPermissions.CustomerFollowUpEdit))
            {
                return PartialView("~/Views/Shared/_AccessDenied.cshtml");
            }
            else
            {
                if (id.HasValue)
                {
                    model = _Util.Facade.NotesFacade.GetNotesById(id.Value);
                    var empobj = _Util.Facade.NoteAssignFacade.GetAssignedNotesByNoteId(model.Id);
                    if (empobj != null)
                    {
                        model.EmpId = empobj.EmployeeId.ToString();
                    }
                    if (model.ReminderDate.HasValue)
                    {
                        model.RemainderTime = model.ReminderDate.Value.UTCToClientTime().ToString("HH:mm");
                        model.ReminderDate = model.ReminderDate.Value.UTCToClientTime();
                    }
                    if (model.ReminderEndDate.HasValue)
                    {
                        model.ReminderEndDate = model.ReminderEndDate.Value.UTCToClientTime();
                    }
                    model.CreatedDate = model.CreatedDate.UTCToClientTime();
                    model.AssignEmpList = _Util.Facade.NoteAssignFacade.GetAllAssignCustomerNoteListByNoteId(id.Value);
                    model.TaskNoteList = _Util.Facade.NotesFacade.GetAllTaskNoteByTaskIdAndCompanyId(model.Id, CurrentLoggedInUser.CompanyId.Value);
                }
                else
                {
                    model.CustomerId = CustomerId;
                    model.IsEmail = false;
                    model.IsText = false;
                    model.ReminderDate = DateTime.UtcNow.UTCToClientTime().AddDays(1);
                    model.ReminderEndDate = DateTime.UtcNow.UTCToClientTime().AddDays(1);
                    model.CreatedDate = DateTime.UtcNow.UTCToClientTime();
                    model.RemainderTime = "";
                }
            }
            List<SelectListItem> EmployeeList = new List<SelectListItem>();
            EmployeeList.AddRange(_Util.Facade.EmployeeFacade.GetEmployeeByCompanyIdAndTag(CurrentLoggedInUser.CompanyId.Value, LabelHelper.UserTags.SalesPerson, new Guid(), LabelHelper.UserTags.Partner).Select(x =>
                                  new SelectListItem()
                                  {
                                      Text = x.FirstName.ToString() + " " + x.LastName.ToString(),
                                      Value = x.UserId.ToString()
                                  }).ToList());
            ViewBag.EmployeeName = EmployeeList;
            List<SelectListItem> SalesPersonList = new List<SelectListItem>();
            //List<SelectListItem> TeamList = new List<SelectListItem>();
            SalesPersonList.Add(new SelectListItem()
            {
                Text = "Please Select One",
                Value = "-1"
            });
            //if (CustomerId != new Guid())
            //{
            //    var cusobj = _Util.Facade.CustomerFacade.GetCustomerByCustomerId(CustomerId);
            //    if (cusobj != null)
            //    {
            //        SalesPersonList.Add(new SelectListItem()
            //        {
            //            Text = cusobj.FirstName.ToString() + " " + cusobj.LastName.ToString(),
            //            Value = cusobj.CustomerId.ToString()
            //        });
            //    }
            //}
            //GlobalSetting ReportForAll = _Util.Facade.GlobalSettingsFacade.GetGlobalSettingsByKey(CurrentLoggedInUser.CompanyId.Value, "RemainderForAll");
            //if (ReportForAll != null && ReportForAll.Value == "true")
            //{
            //    SalesPersonList.AddRange(_Util.Facade.EmployeeFacade.GetAllEmployee(CurrentLoggedInUser.CompanyId.Value).OrderBy(x => x.FirstName + " " + x.LastName != "Please Select One").ThenBy(x => x.FirstName + " " + x.LastName).ToList().Select(x =>
            //        new SelectListItem()
            //        {
            //            Text = x.FirstName + " " + x.LastName,
            //            Value = x.UserId.ToString()
            //        }).ToList());
            //}
            //else
            //{

            //    SalesPersonList.AddRange(_Util.Facade.EmployeeFacade.GetEmployeeByCompanyIdAndTag(CurrentLoggedInUser.CompanyId.Value, LabelHelper.UserTags.SalesPerson, new Guid(), LabelHelper.UserTags.Partner).OrderBy(x => x.UserId.ToString() != "-1").ThenBy(x => x.FirstName + " " + x.LastName).ToList().Select(x =>
            //                  new SelectListItem()
            //                  {
            //                      Text = x.FirstName + " " + x.LastName,
            //                      Value = x.UserId.ToString()
            //                  }).ToList());
            //}
            List<Employee> empLsit = _Util.Facade.EmployeeFacade.GetCurrentEmployeeListByCompanyId(CurrentLoggedInUser.CompanyId.Value);
            if (empLsit != null && empLsit.Count() > 0)
            {
                SalesPersonList.AddRange(empLsit.OrderBy(x => x.FirstName.ToString() + " " + x.LastName.ToString()).Select(x =>
                      new SelectListItem()
                      {
                          Text = x.FirstName.ToString() + " " + x.LastName.ToString(),
                          Value = x.UserId.ToString()
                      }).ToList());
            }
            List<TeamSetting> teamList = _Util.Facade.UserLoginFacade.GetAllTeam();
            //if(teamList != null && teamList.Count() > 0)
            //{
            //    TeamList.AddRange(teamList.OrderBy(x => x.Name.ToString()).Select(x =>
            //     new SelectListItem()
            //     {
            //         Text = x.Name.ToString(),
            //         Value = x.UserId.ToString()
            //     }).ToList());
            //}
            if (teamList == null && teamList.Count() == 0)
            {
                teamList = new List<TeamSetting>();
            }
            ViewBag.SalesPersonList = SalesPersonList.OrderBy(x => x.Text != "Please Select One").ThenBy(x => x.Text).ToList();
            ViewBag.TeamList = teamList; //TeamList.OrderBy(x => x.Text != "Please Select One").ThenBy(x => x.Text).ToList();
            var mintime = _Util.Facade.GlobalSettingsFacade.GetReminderMinTime(CurrentLoggedInUser.CompanyId.Value);
            var maxtime = _Util.Facade.GlobalSettingsFacade.GetReminderMaxTime(CurrentLoggedInUser.CompanyId.Value);
            List<SelectListItem> RemainderTime = new List<SelectListItem>();
            RemainderTime.AddRange(_Util.Facade.LookupFacade.GetLookupByKeyForArrivalOrDepartureTimeByMinAndMaxTimeRange("Arrival", mintime, maxtime).Select(x =>
            new SelectListItem()
            {
                Text = x.DisplayText.ToString(),
                Value = x.DataValue.ToString()
            }).ToList());
            ViewBag.RemainderTime = RemainderTime;
            ViewBag.timeval = Timeval;
            if (IsComplete == "true")
            {
                ViewBag.complete = IsComplete;
            }
            return PartialView("_AddCustomerFollowUpReminder", model);
        }

        #region Task Note added
        [Authorize]
        [HttpPost]
        public JsonResult AddTaskNote(TaskNote TskNote)
        {
            var CurrentLoggedInUser = ((HS.Web.UI.Helper.CustomPrincipal)(User));
            int Id = 0;
            TskNote.AddedBy = CurrentLoggedInUser.UserId;
            Employee tmpEmp = _Util.Facade.EmployeeFacade.GetEmployeeByEmployeeId(TskNote.AddedBy);
            List<Guid> assigned = new List<Guid>();
            assigned = _Util.Facade.NoteAssignFacade.GetAssignedNotesListByNoteId(TskNote.TaskId).Select(x => x.EmployeeId).ToList();
            CustomerNote cn = _Util.Facade.NotesFacade.GetNotesById(TskNote.TaskId);
            Customer c = _Util.Facade.CustomerFacade.GetCustomerByCustomerGuidId(cn.CustomerId);
            if (cn != null)
            {
                assigned.Add(cn.CreatedByUid);
            }
            if (TskNote.Id > 0)
            {
                TaskNote temptasknote = _Util.Facade.NotesFacade.GetTaskNoteById(TskNote.Id);
                temptasknote.Note = TskNote.Note;
                Id = TskNote.Id;
                _Util.Facade.NotesFacade.UpdateTaskNote(temptasknote);
                base.AddUserActivityForCustomer("Task reply is updated #Id:" + Id + " by " + CurrentLoggedInUser.GetFullName(), LabelHelper.ActivityAction.UpdateReminderReply, cn.CustomerId, null, null);
            }
            else
            {
                TskNote.AddedDate = DateTime.Now.UTCCurrentTime();
                TskNote.CompanyId = CurrentLoggedInUser.CompanyId.Value;
                Id = _Util.Facade.NotesFacade.InsertTaskNote(TskNote);
                base.AddUserActivityForCustomer("Task reply is added #Id:" + Id + " by " + CurrentLoggedInUser.GetFullName(), LabelHelper.ActivityAction.AddReminderReply, cn.CustomerId, null, null);
            }
            string AddedBy = CurrentLoggedInUser.GetFullName();
            string AddedDate = DateTime.Now.UTCCurrentTime().UTCToClientTime().ToString("MM/dd/yy hh:mm");
            #region Insert notification
            Notification notification = new Notification()
            {
                CompanyId = CurrentLoggedInUser.CompanyId.Value,
                CreatedDate = DateTime.Now.UTCCurrentTime(),
                NotificationId = Guid.NewGuid(),
                Type = LabelHelper.NotificationType.Employee,
                Who = CurrentLoggedInUser.UserId,
                //What = string.Format(@"{0} attached <a class=""cus-anchor"" href=""javascript:void(0)"" onclick=""{2}('{1}')"">{1}</a> to <a class=""cus-anchor"" href=""javascript:void(0)"" onclick=""OpenTicketById('{3}')"">Ticket #{3}</a>", "{0}" , InvoiceId, InvoiceOpenFunction,Ticket.Id),
                What = string.Format(@"{0} replied for a task {1}", AddedBy, TskNote.TaskId),
                NotificationUrl = AppConfig.DomainSitePath + "/Customer/Customerdetail/?id=" + c.Id + "#NotesTab",

            };
            _Util.Facade.NotificationFacade.InsertNotification(notification);

            foreach (Guid item in assigned)
            {
                if (item != CurrentLoggedInUser.UserId)
                {
                    #region set user to notification
                    NotificationUser nu = new NotificationUser()
                    {
                        NotificationId = notification.NotificationId,
                        IsRead = false,
                        NotificationPerson = item,
                    };
                    _Util.Facade.NotificationFacade.InsertNotificationUser(nu);
                    #endregion
                }
            }
            #endregion
            if (tmpEmp == null)
            {
                Customer tmpCus = _Util.Facade.CustomerFacade.GetCustomerByCustomerId(TskNote.AddedBy);
                return Json(new { result = true, Id = Id, AddedDate = AddedDate, Note = TskNote.Note, AddedBy = tmpCus.FirstName + " " + tmpCus.LastName, message = "Task note inserted successfully." });
            }
            else
            {
                return Json(new { result = true, Id = Id, AddedDate = AddedDate, Note = TskNote.Note, AddedBy = tmpEmp.FirstName + " " + tmpEmp.LastName, message = "Task note inserted successfully." });
            }

        }
        #endregion

        [Authorize]
        [HttpPost]
        public JsonResult AddNewReminderNote(CustomerNote CustomerNote, NoteAssign assign)
        {
            var CurrentLoggedInUser = ((HS.Web.UI.Helper.CustomPrincipal)(User));
            bool result = false;
            bool IsReOpened = false;
            CustomerNote CustomerNoteObj = new CustomerNote();
            string message1 = "";
            var count = _Util.Facade.NotesFacade.GetCountCustomerNoteByCompanyId(CurrentLoggedInUser.CompanyId.Value, CustomerNote.ReminderDate.Value.ClientToUTCTime().ToString("yyyy-MM-dd HH:mm:ss"), CustomerNote.ReminderDate.Value.AddHours(2).ClientToUTCTime().ToString("yyyy-MM-dd HH:mm:ss"));
            if (CurrentLoggedInUser != null)
            {
                if (CustomerNote.Id > 0)
                {
                    //if (count.ReminderCount > 1)
                    //{
                    //    message1 = "This ticket schedule event would not be able to overlap";
                    //}
                    //else
                    //{

                    //}

                    string remindermsg = "";
                    //List<AssignEmployeeCustomerNote> Assignemp= _Util.Facade.NoteAssignFacade.GetAllAssignCustomerNoteListByNoteId(CustomerNote.Id);
                    // List <string> AssignempList = ((string[])assign.AssignEmployeeIdArray).ToList();
                    // var stringList = Assignemp.OfType<string>();
                    // List<string> strings = stringList.ToList();

                    // if (!AssignempList.SequenceEqual(strings) )
                    // {
                    //     remindermsg += "Reminder for is Updated </br>";
                    // }


                    CustomerNote Obj = _Util.Facade.NotesFacade.GetNotesById(CustomerNote.Id);

                    var newreminderdate = "";
                    if (CustomerNote != null && CustomerNote.reminderdatetimeforlog != null)
                    {
                        newreminderdate = CustomerNote.reminderdatetimeforlog.Value.ClientToUTCTime().ToString("yyyy-MM-dd HH:mm:ss");
                    }


                    string prevdate = Obj.ReminderDate.Value.ToString("yyyy-MM-dd HH:mm:ss");
                    DateTime? prevdateforlog = Obj.ReminderDate.Value.AddHours(6);
                    if (CustomerNote.Notes != Obj.Notes)
                    {
                        remindermsg += $"Note is changed from <s>{Obj.Notes}</s> to <strong>{CustomerNote.Notes}</strong> </br>";
                    }
                    if (newreminderdate != "" && newreminderdate != prevdate)
                    {
                        remindermsg += $"Task Date and Time is updated from {prevdateforlog } to {CustomerNote.reminderdatetimeforlog} </br>";
                    }

                    if (CustomerNote.IsEmail != Obj.IsEmail)
                    {
                        remindermsg += $"Email for Task is updated from {Obj.IsEmail} to {CustomerNote.IsEmail} </br>";
                    }
                    if (CustomerNote.IsText != Obj.IsText)
                    {
                        remindermsg += $"Text for Task is updated from {Obj.IsText} to {CustomerNote.IsText} </br>";
                    }
                    if (CustomerNote.IsPin != Obj.IsPin)
                    {
                        remindermsg += "Pin to Top is updated from " + Obj.IsPin + " to " + CustomerNote.IsPin + "</br>";
                    }
                    Obj.Notes = CustomerNote.Notes;
                    if (!string.IsNullOrWhiteSpace(CustomerNote.RemainderTime) && CustomerNote.RemainderTime != "-1")
                    {
                        var redate = CustomerNote.ReminderDate.Value.Date.ToString("MM/dd/yyyy");
                        var Fredate = redate + " " + CustomerNote.RemainderTime;
                        CustomerNote.ReminderDate = Convert.ToDateTime(Fredate);
                        Obj.ReminderDate = CustomerNote.ReminderDate.Value.ClientToUTCTime();
                    }
                    else
                    {
                        Obj.ReminderDate = CustomerNote.ReminderDate.Value.ClientToUTCTime();
                    }
                    if (IsPermitted(UserPermissions.CustomerPermissions.ShowReminderCompletedDateOnAddReminder))
                    {
                        var redate = CustomerNote.ReminderEndDate.Value.Date.ToString("MM/dd/yyyy");
                        var Fredate = redate + " " + CustomerNote.RemainderTime;
                        CustomerNote.ReminderEndDate = Convert.ToDateTime(Fredate);
                        Obj.ReminderEndDate = CustomerNote.ReminderEndDate.Value.AddHours(2).ClientToUTCTime();
                    }
                    else
                    {
                        Obj.ReminderEndDate = CustomerNote.ReminderDate.Value.AddHours(2).ClientToUTCTime();
                    }
                    Obj.IsEmail = CustomerNote.IsEmail;
                    Obj.IsText = CustomerNote.IsText;
                    Obj.IsClose = CustomerNote.IsClose;
                    Obj.TeamSettingId = CustomerNote.TeamSettingId;
                    if (CustomerNote.IsClose != null && CustomerNote.IsClose == true)
                    {
                        Obj.IsShedule = false;
                    }
                    Obj.IsPin = CustomerNote.IsPin;
                    result = _Util.Facade.NotesFacade.UpdateNotes(Obj);

                    if (CustomerNote.IsClose == false || CustomerNote.IsInstantNotification == true)
                    {
                        var CheckAndDeleteOldEmp = _Util.Facade.NoteAssignFacade.CheckAndDeleteOldAssignedEmployee(CustomerNote.Id);
                        if (CheckAndDeleteOldEmp != false)
                        {
                            if (assign.AssignEmployeeIdArray != null && assign.AssignEmployeeIdArray.Length > 0)
                            {
                                foreach (var item in assign.AssignEmployeeIdArray)
                                {
                                    if (item != "-1")
                                    {
                                        string myString = "00000000-0000-0000-0000-000000000000";
                                        Guid checkEmpId = new Guid(myString);
                                        Guid EmpArrayId = new Guid(item);
                                        if (EmpArrayId != checkEmpId)
                                        {
                                            NoteAssign objnoteassign = new NoteAssign()
                                            {
                                                NoteId = CustomerNote.Id,
                                                EmployeeId = EmpArrayId
                                            };
                                            result = _Util.Facade.NoteAssignFacade.InsertNoteAssign(objnoteassign);

                                            var objcus = _Util.Facade.CustomerFacade.GetCustomerByCustomerId(CustomerNote.CustomerId);
                                            Employee _createdByName = _Util.Facade.EmployeeFacade.GetEmployeeByEmployeeId(Obj.CreatedByUid);
                                            if (objcus != null)
                                            {
                                                CustomerNote.cusName = objcus.FirstName + ' ' + objcus.LastName;
                                            }
                                            string recname = "";
                                            var objemp = _Util.Facade.EmployeeFacade.GetEmployeeByEmployeeId(EmpArrayId);
                                            if (objemp != null)
                                            {
                                                CustomerNote.empName = objemp.Email;
                                                recname = objemp.FirstName + ' ' + objemp.LastName;
                                                assign.AssignName = recname;
                                            }
                                            if (EmpArrayId != null)
                                            {
                                                EmailToEmployeeFromFollowUpNote EmailToEmployeeFromFollowUpNote = new EmailToEmployeeFromFollowUpNote();
                                                EmailToEmployeeFromFollowUpNote.CustomerName = CustomerNote.cusName;
                                                EmailToEmployeeFromFollowUpNote.EmailBody = CustomerNote.Notes;
                                                EmailToEmployeeFromFollowUpNote.ToEmail = CustomerNote.empName;
                                                EmailToEmployeeFromFollowUpNote.AssignPersonName = assign.AssignName;
                                                if (IsPermitted(UserPermissions.CustomerPermissions.ShowReminderCompletedDateOnAddReminder) && Obj.ReminderEndDate != null && Obj.ReminderEndDate != new DateTime())
                                                {
                                                    EmailToEmployeeFromFollowUpNote.AttnBy = Obj.ReminderEndDate.Value.UTCToClientTime().ToString("M/dd/yy");
                                                }
                                                EmailToEmployeeFromFollowUpNote.CreatedOn = Obj.CreatedDate.UTCToClientTime().ToString("M/dd/yy");
                                                if (objcus != null)
                                                {
                                                    EmailToEmployeeFromFollowUpNote.CustomerIntId = objcus.Id;
                                                }
                                                if (_createdByName != null)
                                                {
                                                    EmailToEmployeeFromFollowUpNote.CreatedByName = _createdByName.FirstName + " " + _createdByName.LastName;
                                                }

                                                _Util.Facade.MailFacade.EmailToEmployeeFromFollowUpNotes(EmailToEmployeeFromFollowUpNote, CurrentLoggedInUser.CompanyId.Value);
                                                if (CustomerNote.IsInstantNotification == true && CustomerNote.IsText == true && !string.IsNullOrWhiteSpace(objemp.Phone))
                                                {
                                                    ReminderSms _remindersms = new ReminderSms();
                                                    string cusName = objcus.FirstName + " " + objcus.LastName;
                                                    _remindersms.CusId = objcus.Id;
                                                    _remindersms.CustomerName = cusName;
                                                    _remindersms.Message = CustomerNote.Notes;
                                                    if (IsPermitted(UserPermissions.CustomerPermissions.ShowReminderCompletedDateOnAddReminder) && Obj.ReminderEndDate != null && Obj.ReminderEndDate != new DateTime())
                                                    {
                                                        _remindersms.AttnBy = Obj.ReminderEndDate.Value.UTCToClientTime().ToString("M/dd/yy");
                                                    }
                                                    _remindersms.CreatedBy = _createdByName != null ? _createdByName.FirstName + " " + _createdByName.LastName : "";
                                                    _remindersms.CreatedDate = Obj.CreatedDate.UTCToServerTime().ToString("M/dd/yy");
                                                    _remindersms.CompanyName = CurrentLoggedInUser.CompanyName;
                                                    List<string> receiverlist = new List<string>();
                                                    receiverlist.Add(objemp.Phone);
                                                    _Util.Facade.SMSFacade.ReminderFollowupSMS(CurrentLoggedInUser.CompanyId.Value, Guid.Empty, _remindersms, receiverlist);
                                                }
                                            }

                                        }
                                    }
                                }
                            }
                        }
                        else
                        {
                            if (assign.AssignEmployeeIdArray != null && assign.AssignEmployeeIdArray.Length > 0)
                            {
                                foreach (var item in assign.AssignEmployeeIdArray)
                                {
                                    if (item != "-1")
                                    {
                                        string myString = "00000000-0000-0000-0000-000000000000";
                                        Guid checkEmpId = new Guid(myString);
                                        Guid EmpArrayId = new Guid(item);
                                        if (EmpArrayId != checkEmpId)
                                        {
                                            NoteAssign objnoteassign = new NoteAssign()
                                            {
                                                NoteId = CustomerNote.Id,
                                                EmployeeId = EmpArrayId
                                            };
                                            result = _Util.Facade.NoteAssignFacade.InsertNoteAssign(objnoteassign);

                                            var objcus = _Util.Facade.CustomerFacade.GetCustomerByCustomerId(CustomerNote.CustomerId);
                                            Employee _createdByName = _Util.Facade.EmployeeFacade.GetEmployeeByEmployeeId(Obj.CreatedByUid);
                                            if (objcus != null)
                                            {
                                                CustomerNote.cusName = objcus.FirstName + ' ' + objcus.LastName;
                                            }
                                            string recname = "";
                                            var objemp = _Util.Facade.EmployeeFacade.GetEmployeeByEmployeeId(EmpArrayId);
                                            if (objemp != null)
                                            {
                                                CustomerNote.empName = objemp.Email;
                                                recname = objemp.FirstName + ' ' + objemp.LastName;
                                                assign.AssignName = recname;
                                            }
                                            if (EmpArrayId != null)
                                            {
                                                EmailToEmployeeFromFollowUpNote EmailToEmployeeFromFollowUpNote = new EmailToEmployeeFromFollowUpNote();
                                                EmailToEmployeeFromFollowUpNote.CustomerName = CustomerNote.cusName;
                                                EmailToEmployeeFromFollowUpNote.EmailBody = CustomerNote.Notes;
                                                EmailToEmployeeFromFollowUpNote.ToEmail = CustomerNote.empName;
                                                EmailToEmployeeFromFollowUpNote.AssignPersonName = assign.AssignName;
                                                if (IsPermitted(UserPermissions.CustomerPermissions.ShowReminderCompletedDateOnAddReminder) && Obj.ReminderEndDate != null && Obj.ReminderEndDate != new DateTime())
                                                {
                                                    EmailToEmployeeFromFollowUpNote.AttnBy = Obj.ReminderEndDate.Value.UTCToClientTime().ToString("M/dd/yy");
                                                }
                                                EmailToEmployeeFromFollowUpNote.CreatedOn = Obj.CreatedDate.UTCToClientTime().ToString("M/dd/yy");
                                                if (objcus != null)
                                                {
                                                    EmailToEmployeeFromFollowUpNote.CustomerIntId = objcus.Id;
                                                }
                                                if (_createdByName != null)
                                                {
                                                    EmailToEmployeeFromFollowUpNote.CreatedByName = _createdByName.FirstName + " " + _createdByName.LastName;
                                                }
                                                _Util.Facade.MailFacade.EmailToEmployeeFromFollowUpNotes(EmailToEmployeeFromFollowUpNote, CurrentLoggedInUser.CompanyId.Value);
                                                if (CustomerNote.IsInstantNotification == true && CustomerNote.IsText == true && !string.IsNullOrWhiteSpace(objemp.Phone))
                                                {
                                                    ReminderSms _remindersms = new ReminderSms();
                                                    string cusName = objcus.FirstName + " " + objcus.LastName;
                                                    _remindersms.CusId = objcus.Id;
                                                    _remindersms.CustomerName = cusName;
                                                    _remindersms.Message = CustomerNote.Notes;
                                                    if (IsPermitted(UserPermissions.CustomerPermissions.ShowReminderCompletedDateOnAddReminder) && Obj.ReminderEndDate != null && Obj.ReminderEndDate != new DateTime())
                                                    {
                                                        _remindersms.AttnBy = Obj.ReminderEndDate.Value.UTCToClientTime().ToString("M/dd/yy");
                                                    }
                                                    _remindersms.CreatedBy = _createdByName != null ? _createdByName.FirstName + " " + _createdByName.LastName : "";
                                                    _remindersms.CreatedDate = Obj.CreatedDate.UTCToServerTime().ToString("M/dd/yy");
                                                    _remindersms.CompanyName = CurrentLoggedInUser.CompanyName;
                                                    List<string> receiverlist = new List<string>();
                                                    receiverlist.Add(objemp.Phone);
                                                    _Util.Facade.SMSFacade.ReminderFollowupSMS(CurrentLoggedInUser.CompanyId.Value, Guid.Empty, _remindersms, receiverlist);
                                                }
                                            }
                                        }
                                    }
                                }
                            }
                        }
                    }

                    #region Insert notification
                    var objTempcus = _Util.Facade.CustomerFacade.GetCustomerByCustomerId(CustomerNote.CustomerId);
                    if (objTempcus != null)
                    {
                        CustomerNote.cusName = objTempcus.FirstName + ' ' + objTempcus.LastName;
                    }
                    string ReminderLink = AppConfig.DomainSitePath + string.Format("/Customer/Customerdetail/?id={0}#NotesTab", objTempcus.Id);
                    string CustomerLink = AppConfig.DomainSitePath + string.Format("/Customer/Customerdetail/?id={0}", objTempcus.Id);
                    Notification notification = new Notification()
                    {
                        CompanyId = CurrentLoggedInUser.CompanyId.Value,
                        CreatedDate = DateTime.Now.UTCCurrentTime(),
                        NotificationId = Guid.NewGuid(),
                        Type = LabelHelper.NotificationType.Employee,
                        Who = CustomerNote.CreatedByUid,
                        What = string.Format(@"You have a <a class='cus-anchor' href='{2}'>task</a> on {3} at {1} for <a class='cus-anchor' href='{4}'>{5}</a> assigned by {0}", "{0}", Obj.ReminderDate.Value.UTCToClientTime().ToString("hh:mm tt"), ReminderLink, Obj.ReminderDate.Value.UTCToClientTime().ToString("MM/dd/yy"), CustomerLink, CustomerNote.cusName),
                        NotificationUrl = ReminderLink
                    };
                    _Util.Facade.NotificationFacade.InsertNotification(notification);
                    #endregion
                    List<NoteAssign> AssignedUsers = _Util.Facade.NoteAssignFacade.GetAssignedNotesListByNoteId(Obj.Id);
                    foreach (var user in AssignedUsers)
                    {
                        #region set user to notification
                        NotificationUser nu = new NotificationUser()
                        {
                            NotificationId = notification.NotificationId,
                            IsRead = false,
                            NotificationPerson = user.EmployeeId,
                        };
                        _Util.Facade.NotificationFacade.InsertNotificationUser(nu);
                        #endregion
                    }
                    if (CustomerNote.IsClose.Value)
                    {
                        base.AddUserActivityForCustomer($"Task #{CustomerNote.Id} is closed. </br> {remindermsg}", LabelHelper.ActivityAction.UpdateRemineder, CustomerNote.CustomerId, null, null);
                    }
                    else if (CustomerNote.IsClose.Value == false && Obj.IsClose.Value == false)
                    {
                        base.AddUserActivityForCustomer($"Task #{CustomerNote.Id} is re-opened. </br> {remindermsg}", LabelHelper.ActivityAction.UpdateRemineder, CustomerNote.CustomerId, null, null);
                    }
                    else
                    {
                        base.AddUserActivityForCustomer($"Task #{CustomerNote.Id} is updated. </br> {remindermsg}", LabelHelper.ActivityAction.UpdateRemineder, CustomerNote.CustomerId, null, null);
                    }

                    //else
                    //{
                    //    base.AddUserActivityForCustomer("Reminder is Updated #RemnderId:" + CustomerNote.Id + "</br>" + "Reminderfor is Updated", LabelHelper.ActivityAction.UpdateRemineder, CustomerNote.CustomerId, null, null);

                    //}


                }

                else
                {
                    //if (count.ReminderCount > 0)
                    //{
                    //    message1 = "This ticket schedule event would not be able to overlap";
                    //}
                    //else
                    //{

                    //}

                    CustomerNoteObj.Notes = CustomerNote.Notes;
                    if (!string.IsNullOrWhiteSpace(CustomerNote.RemainderTime) && CustomerNote.RemainderTime != "-1")
                    {
                        var redate = CustomerNote.ReminderDate.Value.Date.ToString("MM/dd/yyyy");
                        var Fredate = redate + " " + CustomerNote.RemainderTime;
                        CustomerNote.ReminderDate = Convert.ToDateTime(Fredate);
                        CustomerNoteObj.ReminderDate = CustomerNote.ReminderDate.Value.ClientToUTCTime();
                    }
                    else
                    {
                        CustomerNoteObj.ReminderDate = CustomerNote.ReminderDate.Value.ClientToUTCTime();
                    }
                    if (IsPermitted(UserPermissions.CustomerPermissions.ShowReminderCompletedDateOnAddReminder))
                    {
                        var redate = CustomerNote.ReminderEndDate.Value.Date.ToString("MM/dd/yyyy");
                        var Fredate = redate + " " + CustomerNote.RemainderTime;
                        CustomerNote.ReminderEndDate = Convert.ToDateTime(Fredate);
                        CustomerNoteObj.ReminderEndDate = CustomerNote.ReminderEndDate.Value.AddHours(2).ClientToUTCTime();
                    }
                    else
                    {
                        CustomerNoteObj.ReminderEndDate = CustomerNote.ReminderDate.Value.AddHours(2).ClientToUTCTime();
                    }

                    CustomerNoteObj.CompanyId = CurrentLoggedInUser.CompanyId.Value;
                    CustomerNoteObj.CustomerId = CustomerNote.CustomerId;
                    CustomerNoteObj.CreatedDate = DateTime.Now.UTCCurrentTime();
                    CustomerNoteObj.IsEmail = CustomerNote.IsEmail;
                    CustomerNoteObj.IsText = CustomerNote.IsText;
                    CustomerNoteObj.TeamSettingId = CustomerNote.TeamSettingId;
                    CustomerNoteObj.IsShedule = true;
                    CustomerNoteObj.IsFollowUp = true;
                    CustomerNoteObj.CreatedBy = User.Identity.Name;
                    CustomerNoteObj.CreatedByUid = CurrentLoggedInUser.UserId;
                    result = _Util.Facade.NotesFacade.InsertCustomerNote(CustomerNoteObj) > 0;
                    var idvalue = CustomerNoteObj.Id;
                    CustomerSnapshot ObjCustomerSnapShot = new CustomerSnapshot
                    {
                        CustomerId = CustomerNoteObj.CustomerId,
                        CompanyId = CustomerNoteObj.CompanyId,
                        Description = "CustomerFollowUp: " + CustomerNoteObj.Notes,
                        Logdate = DateTime.Now.UTCCurrentTime(),
                        Updatedby = CurrentLoggedInUser.FirstName + " " + CurrentLoggedInUser.LastName
                    };
                    result = _Util.Facade.CustomerSnapshotFacade.InsertSnapshot(ObjCustomerSnapShot);
                    string PersonMailFollowup = "";
                    string PersonNumFollowup = "";
                    if (CustomerNote.cusIdValFollowup != null)
                    {
                        foreach (var Personvalue in CustomerNote.cusIdValFollowup)
                        {
                            var objcusFollow = _Util.Facade.CustomerFacade.GetCustomerByCustomerId(CustomerNote.CustomerId);
                            if (objcusFollow != null)
                            {
                                CustomerNote.cusName = objcusFollow.FirstName + ' ' + objcusFollow.LastName;
                            }
                            PersonMailFollowup = Personvalue.ToString();
                            var personalObjectFollowup = _Util.Facade.CustomerFacade.GetAllResposiblePersonByCompanyIdandCustomerId(CustomerNote.CustomerId);

                            EmailToResponsiblePersonFromCustomerNote EmailToResponsiblePersonFromCustomerNote = new EmailToResponsiblePersonFromCustomerNote();
                            EmailToResponsiblePersonFromCustomerNote.CustomerNum = CustomerNote.cusName;
                            EmailToResponsiblePersonFromCustomerNote.ToEmail = PersonMailFollowup;
                            EmailToResponsiblePersonFromCustomerNote.Notes = CustomerNote.Notes;
                            EmailToResponsiblePersonFromCustomerNote.ReceiverName = PersonNumFollowup;
                            //result = _Util.Facade.MailFacade.EmailToResponsiblePersonFromCustomerNote(EmailToResponsiblePersonFromCustomerNote, CurrentLoggedInUser.CompanyId.Value);

                        }
                    }
                    if (assign.AssignEmployeeIdArray != null && assign.AssignEmployeeIdArray.Length > 0)
                    {
                        foreach (var item in assign.AssignEmployeeIdArray)
                        {
                            if (item != "-1")
                            {
                                string myString = "00000000-0000-0000-0000-000000000000";
                                Guid checkEmpId = new Guid(myString);
                                Guid EmpArrayId = new Guid(item);
                                if (EmpArrayId != checkEmpId)
                                {
                                    NoteAssign objnoteassign = new NoteAssign()
                                    {
                                        NoteId = idvalue,
                                        EmployeeId = EmpArrayId
                                    };
                                    result = _Util.Facade.NoteAssignFacade.InsertNoteAssign(objnoteassign);

                                    var objcus = _Util.Facade.CustomerFacade.GetCustomerByCustomerId(CustomerNote.CustomerId);
                                    Employee _createdByName = _Util.Facade.EmployeeFacade.GetEmployeeByEmployeeId(CustomerNoteObj.CreatedByUid);
                                    if (objcus != null)
                                    {
                                        CustomerNote.cusName = objcus.FirstName + ' ' + objcus.LastName;
                                    }
                                    string recname = "";
                                    var objemp = _Util.Facade.EmployeeFacade.GetEmployeeByEmployeeId(EmpArrayId);
                                    if (objemp != null)
                                    {
                                        CustomerNote.empName = objemp.Email;
                                        recname = objemp.FirstName + ' ' + objemp.LastName;
                                        assign.AssignName = recname;
                                    }
                                    if (EmpArrayId != null && CustomerNote.IsInstantNotification == true)
                                    {
                                        if (CustomerNote.IsEmail == true && objemp.Email.IsValidEmailAddress())
                                        {
                                            EmailToEmployeeFromFollowUpNote EmailToEmployeeFromFollowUpNote = new EmailToEmployeeFromFollowUpNote();
                                            EmailToEmployeeFromFollowUpNote.CustomerName = CustomerNote.cusName;
                                            EmailToEmployeeFromFollowUpNote.EmailBody = CustomerNote.Notes;
                                            EmailToEmployeeFromFollowUpNote.ToEmail = CustomerNote.empName;
                                            EmailToEmployeeFromFollowUpNote.AssignPersonName = assign.AssignName;
                                            if (IsPermitted(UserPermissions.CustomerPermissions.ShowReminderCompletedDateOnAddReminder) && CustomerNoteObj.ReminderEndDate != null && CustomerNoteObj.ReminderEndDate != new DateTime())
                                            {
                                                EmailToEmployeeFromFollowUpNote.AttnBy = CustomerNoteObj.ReminderEndDate.Value.UTCToClientTime().ToString("M/dd/yy");
                                            }
                                            EmailToEmployeeFromFollowUpNote.CreatedOn = CustomerNoteObj.CreatedDate.UTCToClientTime().ToString("M/dd/yy");
                                            if (objcus != null)
                                            {
                                                EmailToEmployeeFromFollowUpNote.CustomerIntId = objcus.Id;
                                            }
                                            if (_createdByName != null)
                                            {
                                                EmailToEmployeeFromFollowUpNote.CreatedByName = _createdByName.FirstName + " " + _createdByName.LastName;
                                            }
                                            _Util.Facade.MailFacade.EmailToEmployeeFromFollowUpNotes(EmailToEmployeeFromFollowUpNote, CurrentLoggedInUser.CompanyId.Value);
                                        }
                                        if (CustomerNote.IsText == true && !string.IsNullOrWhiteSpace(objemp.Phone))
                                        {
                                            ReminderSms _remindersms = new ReminderSms();
                                            string cusName = objcus.FirstName + " " + objcus.LastName;
                                            _remindersms.CusId = objcus.Id;
                                            _remindersms.CustomerName = cusName;
                                            _remindersms.Message = CustomerNote.Notes;
                                            if (IsPermitted(UserPermissions.CustomerPermissions.ShowReminderCompletedDateOnAddReminder) && CustomerNoteObj.ReminderEndDate != null && CustomerNoteObj.ReminderEndDate != new DateTime())
                                            {
                                                _remindersms.AttnBy = CustomerNoteObj.ReminderEndDate.Value.UTCToClientTime().ToString("M/dd/yy");
                                            }
                                            _remindersms.CreatedBy = _createdByName != null ? _createdByName.FirstName + " " + _createdByName.LastName : "";
                                            _remindersms.CreatedDate = CustomerNoteObj.CreatedDate.UTCToServerTime().ToString("M/dd/yy");
                                            _remindersms.CompanyName = CurrentLoggedInUser.CompanyName;
                                            List<string> receiverlist = new List<string>();
                                            receiverlist.Add(objemp.Phone);
                                            _Util.Facade.SMSFacade.ReminderFollowupSMS(CurrentLoggedInUser.CompanyId.Value, Guid.Empty, _remindersms, receiverlist);
                                        }
                                    }

                                }
                            }
                        }
                    }
                    base.AddUserActivityForCustomer($"New Task #{idvalue} is added. </br> Note: {CustomerNote.Notes} </br> On: {CustomerNote.ReminderDate}", LabelHelper.ActivityAction.AddRemineder, CustomerNote.CustomerId, null, null);

                }

                return Json(new { result = result, cusid = CustomerNote.CustomerId, message1 = message1 });
            }
            else
            {
                return Json(false);
            }
        }

        private static int GetIso8601WeekOfYear(DateTime time)
        {
            DayOfWeek day = CultureInfo.InvariantCulture.Calendar.GetDayOfWeek(time);
            if (day >= DayOfWeek.Monday && day <= DayOfWeek.Wednesday)
            {
                time = time.AddDays(3);
            }

            return CultureInfo.InvariantCulture.Calendar.GetWeekOfYear(time, CalendarWeekRule.FirstFourDayWeek, DayOfWeek.Monday);
        }

        private static DateTime FirstDateOfWeek(int year, int weekOfYear, System.Globalization.CultureInfo ci, int DateOffSet = 0)
        {
            DateTime jan1 = new DateTime(year, 1, 1);
            int daysOffset = (int)ci.DateTimeFormat.FirstDayOfWeek - (int)jan1.DayOfWeek;
            DateTime firstWeekDay = jan1.AddDays(daysOffset);
            int firstWeek = ci.Calendar.GetWeekOfYear(jan1, ci.DateTimeFormat.CalendarWeekRule, ci.DateTimeFormat.FirstDayOfWeek);
            if ((firstWeek <= 1 || firstWeek >= 52) && daysOffset >= -3)
            {
                weekOfYear -= 1;
            }
            return firstWeekDay.AddDays(weekOfYear * 7).AddDays(DateOffSet);
        }

        public ActionResult DateViewPartial(string FilterStartDate, string FilterEndDate)
        {
            var CurrentUser = (HS.Web.UI.Helper.CustomPrincipal)User;
            #region Date Offset
            string FirstDayOfWeek = _Util.Facade.GlobalSettingsFacade.GetStartDayOfWeek(CurrentUser.CompanyId.Value);
            int DateOffset = 0;
            if (FirstDayOfWeek == "Saturday")
            {
                DateOffset = -1;
            }
            else if (FirstDayOfWeek == "Monday")
            {
                DateOffset = 1;
            }
            CultureInfo ci = new CultureInfo("en-US");
            #endregion

            #region Week Filter Dropdown
            //Copany start date will be retrive from global settings
            DateTime CompanyStartDate = new DateTime(2018, 7, 1);
            int Week = GetIso8601WeekOfYear(CompanyStartDate);

            int CurrentWeek = GetIso8601WeekOfYear(DateTime.Now);
            CompanyStartDate = FirstDateOfWeek(CompanyStartDate.Year, Week, ci, DateOffset);
            List<SelectListItem> WeekList = new List<SelectListItem>();
            DateTime StartDate = new DateTime();
            DateTime EndDate = new DateTime();
            string PtoFilter = "-1";

            #region CookieJobs
            string IsDefultDate = "";

            var GlobalSetting = _Util.Facade.GlobalSettingsFacade.GetGlobalSettingsByKey(CurrentUser.CompanyId.Value, "IsDefultDate");
            if (GlobalSetting != null)
            {
                IsDefultDate = GlobalSetting.Value;
                if (Request.Url.Host.ToLower().IndexOf("app.ieatery.com") > -1)
                {
                    GlobalSetting.Value = "false";
                    _Util.Facade.GlobalSettingsFacade.UpdateGlobalSetting(GlobalSetting);
                }
            }
            if (IsDefultDate == "true")
            {
                ViewBag.DateRangeList = _Util.Facade.LookupFacade.GetLookupByKey("PTOFilterOptions").Select(x =>
               new SelectListItem()
               {
                   Text = x.DisplayText.ToString(),
                   Value = x.DataValue.ToString(),

               }).ToList();
            }
            else
            {
                bool fromCookie = false;
                string newCookie = "";
                if (Request.Cookies[CookieKeys.DateViewFilter] != null && !string.IsNullOrWhiteSpace(Request.Cookies[CookieKeys.DateViewFilter].Value))
                {
                    newCookie = Request.Cookies[CookieKeys.DateViewFilter].Value;
                    newCookie = Server.UrlDecode(newCookie);
                    var CookieVals = newCookie.Split(',');
                    string SelectedFilter = "";
                    if (CookieVals.Length == 3)
                    {
                        StartDate = CookieVals[0].ToDateTime();
                        EndDate = CookieVals[1].ToDateTime();
                        SelectedFilter = CookieVals[2];
                        fromCookie = true;

                    }
                    ViewBag.DateRangeList = _Util.Facade.LookupFacade.GetLookupByKey("PTOFilterOptions").Select(x =>
                    new SelectListItem()
                    {
                        Text = x.DisplayText.ToString(),
                        Value = x.DataValue.ToString(),
                        Selected = x.DataValue.ToString() == SelectedFilter ? true : false
                    }).ToList();
                    FilterStartDate = StartDate.ToString("MM/dd/yyyy");
                    FilterEndDate = EndDate.ToString("MM/dd/yyyy");
                    ViewBag.SetDate = SelectedFilter;
                }
                else
                {
                    ViewBag.DateRangeList = _Util.Facade.LookupFacade.GetLookupByKey("PTOFilterOptions").Select(x =>
                    new SelectListItem()
                    {
                        Text = x.DisplayText.ToString(),
                        Value = x.DataValue.ToString(),
                    }).ToList();
                }
            }

            #endregion

            while (CompanyStartDate < DateTime.Now)
            {
                string suffix = "th";
                if (CompanyStartDate.Day == 1 || CompanyStartDate.Day % 20 == 1 || CompanyStartDate.Day % 30 == 1)
                {
                    suffix = "st";
                }
                else if (CompanyStartDate.Day == 2 || CompanyStartDate.Day % 20 == 2)
                {
                    suffix = "nd";
                }
                else if (CompanyStartDate.Day == 3 || CompanyStartDate.Day % 20 == 3)
                {
                    suffix = "rd";
                }


                CompanyStartDate = CompanyStartDate.AddDays(7);
                Week = GetIso8601WeekOfYear(CompanyStartDate);
            }
            if (!string.IsNullOrEmpty(FilterStartDate) && !string.IsNullOrEmpty(FilterEndDate))
            {
                ViewBag.StartDate = FilterStartDate;
                ViewBag.EndDate = FilterEndDate;
            }
            else
            {
                if (Request.Url.Host.ToLower().IndexOf("app.ieatery.com") > -1)
                {
                    ViewBag.EndDate = DateTime.Today.ToString("MM/dd/yyyy");
                    ViewBag.StartDate = DateTime.Today.ToString("MM/dd/yyyy");
                    ViewBag.SetDate = "Today";
                }
                else
                {
                    ViewBag.EndDate = DateTime.Today.ToString("MM/dd/yyyy");
                    ViewBag.StartDate = DateTime.Today.AddDays(-30).ToString("MM/dd/yyyy");
                    ViewBag.SetDate = "Last30Days";
                }
            }

            ViewBag.WeekList = WeekList;
            ViewBag.FirstDayOfWeek = FirstDayOfWeek;
            #endregion

            return PartialView("_DateViewPartial");
        }
        public ActionResult DateViewPartialOth(string FilterStartDate, string FilterEndDate)
        {
            var CurrentUser = (HS.Web.UI.Helper.CustomPrincipal)User;
            #region Date Offset
            string FirstDayOfWeek = _Util.Facade.GlobalSettingsFacade.GetStartDayOfWeek(CurrentUser.CompanyId.Value);
            int DateOffset = 0;
            if (FirstDayOfWeek == "Saturday")
            {
                DateOffset = -1;
            }
            else if (FirstDayOfWeek == "Monday")
            {
                DateOffset = 1;
            }
            CultureInfo ci = new CultureInfo("en-US");
            #endregion

            #region Week Filter Dropdown
            //Copany start date will be retrive from global settings
            DateTime CompanyStartDate = new DateTime(2018, 7, 1);
            int Week = GetIso8601WeekOfYear(CompanyStartDate);

            int CurrentWeek = GetIso8601WeekOfYear(DateTime.Now);
            CompanyStartDate = FirstDateOfWeek(CompanyStartDate.Year, Week, ci, DateOffset);
            List<SelectListItem> WeekList = new List<SelectListItem>();
            DateTime StartDate = new DateTime();
            DateTime EndDate = new DateTime();
            string PtoFilter = "-1";

            #region CookieJobs
            string IsDefultDate = "";

            var GlobalSetting = _Util.Facade.GlobalSettingsFacade.GetGlobalSettingsByKey(CurrentUser.CompanyId.Value, "IsDefultDate");
            if (GlobalSetting != null)
            {
                IsDefultDate = GlobalSetting.Value;
                if (Request.Url.Host.ToLower().IndexOf("app.ieatery.com") > -1)
                {
                    GlobalSetting.Value = "false";
                    _Util.Facade.GlobalSettingsFacade.UpdateGlobalSetting(GlobalSetting);
                }
            }
            if (IsDefultDate == "true")
            {
                ViewBag.DateRangeList = _Util.Facade.LookupFacade.GetLookupByKey("PTOFilterOptions").Select(x =>
               new SelectListItem()
               {
                   Text = x.DisplayText.ToString(),
                   Value = x.DataValue.ToString(),

               }).ToList();
            }
            else
            {
                bool fromCookie = false;
                string newCookie = "";
                if (Request.Cookies[CookieKeys.DateViewFilter] != null && !string.IsNullOrWhiteSpace(Request.Cookies[CookieKeys.DateViewFilter].Value))
                {
                    newCookie = Request.Cookies[CookieKeys.DateViewFilter].Value;
                    newCookie = Server.UrlDecode(newCookie);
                    var CookieVals = newCookie.Split(',');
                    string SelectedFilter = "";
                    if (CookieVals.Length == 3)
                    {
                        StartDate = CookieVals[0].ToDateTime();
                        EndDate = CookieVals[1].ToDateTime();
                        SelectedFilter = CookieVals[2];
                        fromCookie = true;

                    }
                    ViewBag.DateRangeList = _Util.Facade.LookupFacade.GetLookupByKey("PTOFilterOptions").Select(x =>
                    new SelectListItem()
                    {
                        Text = x.DisplayText.ToString(),
                        Value = x.DataValue.ToString(),
                        Selected = x.DataValue.ToString() == SelectedFilter ? true : false
                    }).ToList();
                    FilterStartDate = StartDate.ToString("MM/dd/yyyy");
                    FilterEndDate = EndDate.ToString("MM/dd/yyyy");
                    ViewBag.SetDate = SelectedFilter;
                }
                else
                {
                    ViewBag.DateRangeList = _Util.Facade.LookupFacade.GetLookupByKey("PTOFilterOptions").Select(x =>
                    new SelectListItem()
                    {
                        Text = x.DisplayText.ToString(),
                        Value = x.DataValue.ToString(),
                    }).ToList();
                }
            }

            #endregion

            while (CompanyStartDate < DateTime.Now)
            {
                string suffix = "th";
                if (CompanyStartDate.Day == 1 || CompanyStartDate.Day % 20 == 1 || CompanyStartDate.Day % 30 == 1)
                {
                    suffix = "st";
                }
                else if (CompanyStartDate.Day == 2 || CompanyStartDate.Day % 20 == 2)
                {
                    suffix = "nd";
                }
                else if (CompanyStartDate.Day == 3 || CompanyStartDate.Day % 20 == 3)
                {
                    suffix = "rd";
                }


                CompanyStartDate = CompanyStartDate.AddDays(7);
                Week = GetIso8601WeekOfYear(CompanyStartDate);
            }
            if (!string.IsNullOrEmpty(FilterStartDate) && !string.IsNullOrEmpty(FilterEndDate))
            {
                ViewBag.StartDate = FilterStartDate;
                ViewBag.EndDate = FilterEndDate;
            }
            else
            {
                if (Request.Url.Host.ToLower().IndexOf("app.ieatery.com") > -1)
                {
                    ViewBag.EndDate = DateTime.Today.ToString("MM/dd/yyyy");
                    ViewBag.StartDate = DateTime.Today.ToString("MM/dd/yyyy");
                    ViewBag.SetDate = "Today";
                }
                else
                {
                    ViewBag.EndDate = DateTime.Today.ToString("MM/dd/yyyy");
                    ViewBag.StartDate = DateTime.Today.AddDays(-30).ToString("MM/dd/yyyy");
                    ViewBag.SetDate = "Last30Days";
                }
            }

            ViewBag.WeekList = WeekList;
            ViewBag.FirstDayOfWeek = FirstDayOfWeek;
            #endregion

            return PartialView("_DateViewPartialOth");
        }
        public JsonResult DeleteCustomerNote(int? id, Guid? CustomerId)
        {
            if (id.HasValue)
            {
                var dellead = _Util.Facade.NotesFacade.DeleteCustomerNote(id.Value);
                base.AddUserActivityForCustomer("Reminder is deleted #Id:" + id, LabelHelper.ActivityAction.Delete, CustomerId, null, null);

            }
            return Json(true);
        }
        [Authorize]
        public ActionResult CustomerViewList(bool? recent)
        {
            var CurrentLoggedInUser = ((HS.Web.UI.Helper.CustomPrincipal)(User));

            List<CustomerView> viewlist = _Util.Facade.CustomerViewFacade.GetCustomerViewListByCompanyIdandCustomerId(CurrentLoggedInUser.CompanyId.Value, recent.Value, User.Identity.Name);
            foreach (var item in viewlist)
            {

                item.LastVisitDate = string.Format(HS.Framework.Utils.ConvertDatetimeToAgo.TimeAgo(item.LastVistited).ToString("MM/dd/yyyy {0} hh:mm tt"), "at");
            }
            return PartialView("CustomerViewList", viewlist);
        }

        [Authorize]
        [HttpPost]
        public JsonResult CustomerView(Guid? cusid)
        {
            var CurrentLoggedInUser = ((HS.Web.UI.Helper.CustomPrincipal)(User));
            bool result = false;

            if (CurrentLoggedInUser == null)
            {
                return Json(result);
            }

            if (cusid.HasValue)
            {
                CustomerView cv = new CustomerView();
                cv.CompanyId = CurrentLoggedInUser.CompanyId.Value;
                cv.CustomerId = cusid.Value;
                cv.LastVistited = DateTime.Now.UTCCurrentTime();
                cv.LastVisitedBy = User.Identity.Name;
                result = _Util.Facade.CustomerViewFacade.InsertViewList(cv) > 0;
            }
            return Json(result);
        }

        [Authorize]
        public ActionResult CustomerSystemNoPartial()
        {
            var CurrentUser = ((HS.Web.UI.Helper.CustomPrincipal)(User));

            if (!base.IsPermitted(UserPermissions.MenuPermissions.QuickMenuToolsCustomerSystemNo))
            {
                return PartialView("~/Views/Shared/_AccessDenied.cshtml");
            }

            List<SelectListItem> Status = new List<SelectListItem>();
            ViewBag.Status = _Util.Facade.LookupFacade.GetLookupByKey("CustomerNoStatus").OrderBy(x => x.DataValue != "-1").ThenBy(x => x.DisplayText).Select(x =>
                        new SelectListItem()
                        {
                            Text = x.DisplayText.ToString(),
                            Value = x.DataValue.ToString()
                        }).ToList();

            List<SelectListItem> prifixList = new List<SelectListItem>();
            prifixList.Add(new SelectListItem()
            {
                Text = "Select Customer No Prefix",
                Value = "-1"
            });

            prifixList.AddRange(_Util.Facade.CustomerFacade.GetAllCustomerSystemNoPrefixByCompanyId(CurrentUser.CompanyId.Value).OrderBy(x => x.Name).Select(x =>
                      new SelectListItem()
                      {
                          Text = x.Name.ToString(),
                          Value = x.Name.ToString()
                      }).ToList());
            ViewBag.Prefix = prifixList;
            return PartialView("CustomerSystemNoPartial");
        }

        [Authorize]
        public ActionResult CustomerSystemNoPrefixPartial()
        {

            if (!base.IsPermitted(UserPermissions.MenuPermissions.QuickMenuToolsCustomerSystemNo))
            {
                return PartialView("~/Views/Shared/_AccessDenied.cshtml");
            }

            return PartialView("CustomerSystemNoPrefixPartial");

        }

        [Authorize]
        public ActionResult CustomerSystemNoPrefixListPartial()
        {
            if (!base.IsPermitted(UserPermissions.MenuPermissions.QuickMenuToolsCustomerSystemNo))
            {
                return PartialView("~/Views/Shared/_AccessDenied.cshtml");
            }

            var CurrentUser = ((HS.Web.UI.Helper.CustomPrincipal)(User));
            List<CustomerNoPrefix> model = _Util.Facade.CustomerFacade.GetAllCustomerSystemNoPrefixByCompanyId(CurrentUser.CompanyId.Value);
            return PartialView("_CustomerSystemNoPrefixListPartial", model);

        }

        [Authorize]
        public ActionResult CustomerSystemNoListPartial(int PageNo, string SearchText, string filter, string prefix)
        {
            var CurrentLoggedInUser = ((HS.Web.UI.Helper.CustomPrincipal)(User));
            int PageSize = 10;
            if (!base.IsPermitted(UserPermissions.MenuPermissions.QuickMenuToolsCustomerSystemNo))
            {
                return PartialView("~/Views/Shared/_AccessDenied.cshtml");
            }
            PageSize = _Util.Facade.GlobalSettingsFacade.GetCustomerSystemNoPagingLimit(CurrentLoggedInUser.CompanyId.Value);
            if (PageSize < 10)
            {
                PageSize = 10;
            }

            if (PageNo == 0)
            {
                PageNo = 1;
            }

            CustomerSystemNumberWithModel model = _Util.Facade.CustomerSystemNoFacade.GetCustomerSystemNoListByCompanyIdAndPaging(CurrentLoggedInUser.CompanyId.Value, PageNo, PageSize, SearchText, filter, prefix);
            if (model.ListCustomerSystemNo.Count() == 0)
            {
                PageNo = 1;
            }
            ViewBag.PageNumber = PageNo;
            ViewBag.OutOfNumber = 0;
            if (model.ListCustomerSystemNo.Count() > 0)
            {
                ViewBag.OutOfNumber = model.TotalCustomerSystemNoCount.Counter;
            }
            if ((int)ViewBag.PageNumber * PageSize > (int)ViewBag.OutOfNumber)
            {
                ViewBag.CurrentNumber = (int)ViewBag.OutOfNumber;
            }
            else
            {
                ViewBag.CurrentNumber = (int)ViewBag.PageNumber * PageSize;
            }
            ViewBag.PageCount = Math.Ceiling((double)ViewBag.OutOfNumber / PageSize);
            return PartialView("_CustomerSystemNoListPartial", model);
        }

        [Authorize]
        public ActionResult AddCustomerSystemNoPrefix(int? id)
        {
            var CurrentLoggedInUser = ((HS.Web.UI.Helper.CustomPrincipal)(User));
            if (CurrentLoggedInUser == null)
            {
                return PartialView("~/Views/Shared/_AccessDenied.cshtml");
            }
            CustomerNoPrefix model = new CustomerNoPrefix();
            if (id.HasValue && id > 0)
            {
                if (!base.IsPermitted(UserPermissions.ToolsPermissions.CustomerSystemNoEdit))
                {
                    return PartialView("~/Views/Shared/_AccessDenied.cshtml");
                }

                model = _Util.Facade.CustomerFacade.GetCustomerNoPrefixById(id.Value);

            }
            else
            {
                if (!base.IsPermitted(UserPermissions.ToolsPermissions.CustomerSystemNoAdd))
                {
                    return PartialView("~/Views/Shared/_AccessDenied.cshtml");
                }
            }
            ViewBag.CentralStationName = _Util.Facade.LookupFacade.GetLookupByKey("CentralStationName").OrderBy(x => x.DisplayText != "Select One").ThenBy(x => x.DisplayText).Select(x =>
                        new SelectListItem()
                        {
                            Text = x.DisplayText.ToString(),
                            Value = x.DataValue.ToString()
                        }).ToList();

            return PartialView("_AddCustomerSystemNoPrefix", model);
        }

        [Authorize]
        [HttpPost]
        public JsonResult AddCustomerSystemNoPrefix(CustomerNoPrefix cusNoP)
        {
            cusNoP.CompanyId = ((HS.Web.UI.Helper.CustomPrincipal)(User)).CompanyId.Value;
            if (cusNoP.Id > 0)
            {
                if (!base.IsPermitted(UserPermissions.ToolsPermissions.CustomerSystemNoEdit))
                {
                    return Json(false);
                }

                _Util.Facade.CustomerFacade.UpdateCustomerNoPrefix(cusNoP);
            }
            else
            {
                if (!base.IsPermitted(UserPermissions.ToolsPermissions.CustomerSystemNoAdd))
                {
                    return Json(false);
                }

                _Util.Facade.CustomerFacade.InsertCustomerNoPrefix(cusNoP);
            }
            return Json(true);

            //var CurrentLoggedInUser = ((HS.Web.UI.Helper.CustomPrincipal)(User));

            //bool result;

            //var CheckIfExistNoPrefix = _Util.Facade.CustomerFacade.CheckNoPrefixExistUsingCompanyIdAndName(CurrentLoggedInUser.CompanyId.Value, CustomerNoPrefixModel.Name);
            //if (CheckIfExistNoPrefix == true)
            //{
            //    CustomerNoPrefix DbCustomerNoPrefix = new CustomerNoPrefix();
            //    DbCustomerNoPrefix.Name = CustomerNoPrefixModel.Name;
            //    DbCustomerNoPrefix.CompanyId = CurrentLoggedInUser.CompanyId.Value;
            //    var InsertCustomerNoPrefix = _Util.Facade.CustomerFacade.InsertCustomerNoPrefix(DbCustomerNoPrefix);
            //    result = InsertCustomerNoPrefix;
            //}

            //else
            //{
            //    result = CheckIfExistNoPrefix;
            //}

            //return Json(result);
        }

        [Authorize]
        [HttpPost]
        public JsonResult DeleteCustomerSystemNoPrefix(int? id)
        {
            if (!base.IsPermitted(UserPermissions.ToolsPermissions.CustomerSystemNoDelete))
            {
                return Json(false);
            }

            if (id.HasValue)
            {
                var CustomerSystemNoPrefix = _Util.Facade.CustomerFacade.DeleteCustomerNoPrefix(id.Value);
            }

            return Json(true);
        }

        [Authorize]
        public ActionResult AddCustomerSystemNo(int? id)
        {
            var CurrentLoggedInUser = ((HS.Web.UI.Helper.CustomPrincipal)(User));
            CustomerSystemNo model = new CustomerSystemNo();

            if (CurrentLoggedInUser == null)
            {
                return PartialView("~/Views/Shared/_AccessDenied.cshtml");
            }
            if (id.HasValue)
            {

            }
            else
            {

                ViewBag.CustomerNoPrefixList = _Util.Facade.CustomerFacade.GetAllCustomerSystemNoPrefixByCompanyId(CurrentLoggedInUser.CompanyId.Value).OrderBy(x => x.Name).Select(x =>
                          new SelectListItem()
                          {
                              Text = x.Name.ToString(),
                              Value = x.Name.ToString()
                          }).ToList();
                model.StartingNumber = 0;
                model.TotalNumber = 0;
            }
            return PartialView("_AddCustomerSystemNo", model);
        }

        [Authorize]
        [HttpPost]
        public JsonResult AddCustomerSystemNo(CustomerSystemNo CustomerSystemNoObj)
        {
            var CurrentLoggedInUser = ((HS.Web.UI.Helper.CustomPrincipal)(User));
            string erroResult = "";
            string sucessResult = "";
            //string resultDiv = "";

            for (int i = 0; i < CustomerSystemNoObj.TotalNumber; i++)
            {
                string prefix = CustomerSystemNoObj.Prefix;

                int CusNumber = CustomerSystemNoObj.StartingNumber;

                CustomerSystemNo DbCustomerSystemNo = new CustomerSystemNo();
                DbCustomerSystemNo.CompanyId = CurrentLoggedInUser.CompanyId.Value;
                int sysNumber = CusNumber + i;
                string csNumber = "";
                if (sysNumber.ToString().Length == 1)
                {
                    csNumber = "000" + sysNumber;
                }
                else if (sysNumber.ToString().Length == 2)
                {
                    csNumber = "00" + sysNumber;
                }
                else if (sysNumber.ToString().Length == 3)
                {
                    csNumber = "0" + sysNumber;
                }
                else
                {
                    csNumber = sysNumber.ToString();
                }


                DbCustomerSystemNo.CustomerNo = prefix + csNumber;
                DbCustomerSystemNo.IsUsed = false;
                DbCustomerSystemNo.IsReserved = false;
                DbCustomerSystemNo.GenerateDate = DateTime.Now.UTCCurrentTime();

                long result = _Util.Facade.CustomerSystemNoFacade.InsertCustomerSystemNoCheck(DbCustomerSystemNo);
                if (result == -22)
                {
                    erroResult = erroResult + string.Format("<span class='error'> {0} is already exist.</span><br> ", DbCustomerSystemNo.CustomerNo);
                }
                else
                {
                    sucessResult = sucessResult + string.Format("{0} is added successfully. <br> ", DbCustomerSystemNo.CustomerNo);
                }


            }
            return Json(erroResult + sucessResult);
        }

        [Authorize]
        public ActionResult AddCustomerEmailTextTemplate(int? id)
        {
            var CurrentLoggedInUser = ((HS.Web.UI.Helper.CustomPrincipal)(User));
            EmailTextTemplate model;
            if (id.HasValue)
            {
                model = _Util.Facade.EmailTextTemplateFacade.GetById(id.Value);
            }
            else
            {
                model = new EmailTextTemplate();
            }
            return PartialView("_AddCustomerEmailTextTemplate", model);
        }

        [Authorize]
        [HttpPost]
        public JsonResult AddCustomerEmailTextTemplate(EmailTextTemplate et)
        {
            var CurrentLoggedInUser = ((HS.Web.UI.Helper.CustomPrincipal)(User));
            if (et.Id > 0)
            {
                et.CompanyId = CurrentLoggedInUser.CompanyId.Value;
                et.Type = TextTemplateType.Customer;
                _Util.Facade.EmailTextTemplateFacade.UpdateTextTemplate(et);
            }
            else
            {
                et.CompanyId = CurrentLoggedInUser.CompanyId.Value;
                et.Type = TextTemplateType.Customer;
                _Util.Facade.EmailTextTemplateFacade.InsertTextTemplate(et);
            }
            return Json(true);
        }

        public ActionResult CustomerAddressMap(Guid? CustomerId)
        {
            var currentLoggedIn = ((HS.Web.UI.Helper.CustomPrincipal)(User));
            string GoogleMapAPIKey = _Util.Facade.GlobalSettingsFacade.GetGoogleMapAPIKeyByCompanyId(currentLoggedIn.CompanyId.Value);
            ViewBag.GoogleMapAPIKey = GoogleMapAPIKey;
            if (!CustomerId.HasValue)
            {
                return PartialView("~/Views/Shared/_AccessDenied.cshtml");
            }
            else if (currentLoggedIn == null)
            {
                return PartialView("~/Views/Shared/_AccessDenied.cshtml");
            }
            else
            {
                Customer model = _Util.Facade.CustomerFacade.GetCustomerByCustomerId(CustomerId.Value);
                if (model == null)
                {
                    return PartialView("~/Views/Shared/_AccessDenied.cshtml");
                }
                else
                {
                    ViewBag.GoogleMapAPIKey = _Util.Facade.GlobalSettingsFacade.GetGoogleMapAPIKeyByCompanyId(currentLoggedIn.CompanyId.Value);
                    return PartialView("_CustomerAddressMapPopUp", model);
                }

            }
        }

        public ActionResult CustomerAddressMapForTicket(Guid? CustomerId, int? CustomerAddressId)
        {
            var CurrentLoggedInUser = ((HS.Web.UI.Helper.CustomPrincipal)(User));
            if (!CustomerId.HasValue)
            {
                return PartialView("~/Views/Shared/_AccessDenied.cshtml");
            }
            else if (CurrentLoggedInUser == null)
            {
                return PartialView("~/Views/Shared/_AccessDenied.cshtml");
            }
            else
            {
                Customer model = _Util.Facade.CustomerFacade.GetCustomerByCustomerId(CustomerId.Value);
                if (model == null)
                {
                    return PartialView("~/Views/Shared/_AccessDenied.cshtml");
                }
                else
                {
                    if (CustomerAddressId.HasValue && CustomerAddressId.Value > 0)
                    {
                        CustomerAddress CustomerAddressModel = new CustomerAddress();
                        CustomerAddressModel = _Util.Facade.CustomerFacade.GetCustomerAddesssById(CustomerAddressId.Value);
                        if (CustomerAddressModel != null)
                        {
                            model.Street = CustomerAddressModel.Street;
                            model.City = CustomerAddressModel.City;
                            model.State = CustomerAddressModel.State;
                            model.ZipCode = CustomerAddressModel.ZipCode;
                        }
                    }
                    return PartialView("_CustomerAddressMapPopUp", model);
                }

            }
        }


        public ActionResult CustomerAddressMapPrevious(Guid? CustomerId)
        {
            var CurrentLoggedInUser = ((HS.Web.UI.Helper.CustomPrincipal)(User));
            string GoogleMapAPIKey = _Util.Facade.GlobalSettingsFacade.GetGoogleMapAPIKeyByCompanyId(CurrentLoggedInUser.CompanyId.Value);
            ViewBag.GoogleMapAPIKey = GoogleMapAPIKey;
            if (!CustomerId.HasValue)
            {
                return PartialView("~/Views/Shared/_AccessDenied.cshtml");
            }
            else if (CurrentLoggedInUser == null)
            {
                return PartialView("~/Views/Shared/_AccessDenied.cshtml");
            }
            else
            {
                Customer model = _Util.Facade.CustomerFacade.GetCustomerByCustomerId(CustomerId.Value);
                if (model == null)
                {
                    return PartialView("~/Views/Shared/_AccessDenied.cshtml");
                }
                else
                {
                    return PartialView("CustomerAddressMapPrevious", model);
                }

            }
        }

        [Authorize]
        //[HttpPost]
        public JsonResult CustomerSystemNumber(string KeyValue)
        {
            Customer cusmod = new Customer();

            var CurrentLoggedInUser = ((HS.Web.UI.Helper.CustomPrincipal)(User));
            if (CurrentLoggedInUser != null)
            {
                var modelSys = cusmod.systemNo;
                modelSys = _Util.Facade.CustomerFacade.GetAllCustomerNUmberByCompanyId(CurrentLoggedInUser.CompanyId.Value, KeyValue);
                if (modelSys.Count != 0)
                {
                    return Json(modelSys, JsonRequestBehavior.AllowGet);
                }
                else
                {
                    string errorText = "No Records Found";
                    return Json(errorText, JsonRequestBehavior.AllowGet);
                }
            }
            else
            {
                return Json("Error Occoured");
            }
        }

        #region private

        private void CustomerListInit()
        {
            var CurrentUser = (HS.Web.UI.Helper.CustomPrincipal)User;

            List<SelectListItem> LeadSource = new List<SelectListItem>();
            LeadSource.AddRange(_Util.Facade.LookupFacade.GetLookupByKeyWithParent("LeadSource").OrderBy(x => x.DisplayText != "Lead Source").ThenBy(x => x.DataOrder).Select(x => new SelectListItem()
            {
                Text = x.DisplayText.ToString(),
                Value = x.DataValue.ToString()
            }).ToList());
            ViewBag.LeadSource = LeadSource;
            ViewBag.ECheckTypeList = _Util.Facade.LookupFacade.GetLookupByKey("ECheckType").Select(x =>
                           new SelectListItem()
                           {
                               Text = x.DisplayText.ToString(),
                               Value = x.DataValue.ToString()
                           }).ToList();
            ViewBag.BankAccountTypeList = _Util.Facade.LookupFacade.GetLookupByKey("BankAccountType").Select(x =>
                           new SelectListItem()
                           {
                               Text = x.DisplayText.ToString(),
                               Value = x.DataValue.ToString()
                           }).ToList();
            List<SelectListItem> SalesCommisssion = new List<SelectListItem>();
            SalesCommisssion.Add(new SelectListItem()
            {
                Text = "Please Select",
                Value = "-1"
            });
            SalesCommisssion.AddRange(_Util.Facade.LookupFacade.GetLookupByKey("CommissionType").Select(x =>
                        new SelectListItem()
                        {
                            Text = x.DisplayText.ToString(),
                            Value = x.DataValue.ToString()
                        }).ToList());
            ViewBag.SalesLocation = SalesCommisssion.OrderBy(x => x.Text != "Please Select").ThenBy(x => x.Text).ToList();
            //ViewBag.SalesLocation = _Util.Facade.LookupFacade.GetLookupByKey("CommissionType").Select(x =>
            //              new SelectListItem()
            //              {
            //                  Text = x.DisplayText.ToString(),
            //                  Value = x.DataValue.ToString()
            //              }).ToList();
            Employee emp = _Util.Facade.EmployeeFacade.GetEmployeeByEmployeeId(CurrentUser.UserId);
            ViewBag.EmpSalesLocation = emp.SalesCommissionStructure;
            ViewBag.PaymentMethod = _Util.Facade.LookupFacade.GetLookupByKey("PaymentMethod").Select(x =>
                            new SelectListItem()
                            {
                                Text = x.DisplayText.ToString(),
                                Value = x.DataValue.ToString()
                            }).ToList();
            ViewBag.paymentmethodrmr = _Util.Facade.LookupFacade.GetLookupByKey("PaymentMethodRMR").Select(x =>
            new SelectListItem()
            {
                Text = x.DisplayText.ToString(),
                Value = x.DataValue.ToString()
            }).ToList();

            ViewBag.CustomerTypeList = _Util.Facade.LookupFacade.GetLookupByKey("CustomerType").OrderBy(x => x.DisplayText != "Select One").ThenBy(x => x.DisplayText).Select(x =>
                          new SelectListItem()
                          {
                              Text = x.DisplayText.ToString(),
                              Value = x.DataValue.ToString()
                          }).ToList();

            var objsettings = _Util.Facade.GlobalSettingsFacade.GetGlobalSettingsByKey(CurrentUser.CompanyId.Value, "CustomerTypeRequired");
            if (objsettings != null)
            {
                ViewBag.CustomerTypeRequired = Convert.ToBoolean(objsettings.Value);
            }
            else
            {
                ViewBag.CustomerTypeRequired = false;
            }

            ViewBag.RWSTList = _Util.Facade.LookupFacade.GetLookupByKey("RWST").OrderBy(x => x.DisplayText != "Select One").ThenBy(x => x.DisplayText).Select(x =>
                          new SelectListItem()
                          {
                              Text = x.DisplayText.ToString(),
                              Value = x.DataValue.ToString()
                          }).ToList();




            ViewBag.LeadSourceTypeList = _Util.Facade.LookupFacade.GetLookupByKey("LeadSourceType").OrderBy(x => x.DisplayText != "Select One").ThenBy(x => x.DisplayText).Select(x =>
                          new SelectListItem()
                          {
                              Text = x.DisplayText.ToString(),
                              Value = x.DataValue.ToString()
                          }).ToList();


            ViewBag.CentralStationAgreement = _Util.Facade.LookupFacade.GetLookupByKey("CentralStationAgreement").OrderBy(x => x.DisplayText != "Select One").ThenBy(x => x.DisplayText).Select(x =>
                          new SelectListItem()
                          {
                              Text = x.DisplayText.ToString(),
                              Value = x.DataValue.ToString()
                          }).ToList();

            ViewBag.FinanceCompanyList = _Util.Facade.LookupFacade.GetLookupByKey("FinanceCompany").OrderBy(x => x.DisplayText != "Select One").ThenBy(x => x.DisplayText).Select(x =>
                          new SelectListItem()
                          {
                              Text = x.DisplayText.ToString(),
                              Value = x.DataValue.ToString()
                          }).ToList();

            ViewBag.CustomerAccountTypeLookup = _Util.Facade.LookupFacade.GetLookupByKey("CustomerAccountType").Where(x => x.DataValue != "-1").Select(x =>
                           new SelectListItem()
                           {
                               Text = x.DisplayText.ToString(),
                               Value = x.DataValue.ToString()
                           }).ToList();

            ViewBag.YesNoList = _Util.Facade.LookupFacade.GetLookupByKey("FundedStatus").Select(x =>
                                new SelectListItem()
                                {
                                    Text = x.DisplayText.ToString(),
                                    Value = x.DataValue
                                }).ToList();

            ViewBag.TimeToCall = _Util.Facade.LookupFacade.GetLookupByKey("TimeToCall").Select(x =>
                              new SelectListItem()
                              {
                                  Text = x.DisplayText.ToString(),
                                  Value = x.DataValue.ToString()
                              }).ToList();
            List<SelectListItem> creditGradeList = new List<SelectListItem>();
            creditGradeList.Add(new SelectListItem()
            {
                Text = "Select One",
                Value = "-1"
            });

            creditGradeList.AddRange(_Util.Facade.CustomerFacade.GetAllCreditScoreGrade().Select(x =>
                      new SelectListItem()
                      {
                          Text = x.Grade.ToString() + " (" + x.MinScore + " - " + x.MaxScore + ")",
                          Value = x.ID.ToString()
                      }).ToList());
            ViewBag.CreditScore = creditGradeList;

            ViewBag.StateList = _Util.Facade.LookupFacade.GetLookupByKey("StateList").Select(x =>
                           new SelectListItem()
                           {
                               Text = x.DisplayText.ToString(),
                               Value = x.DataValue.ToString()
                           }).ToList();
            ViewBag.PaymentMethod = _Util.Facade.LookupFacade.GetLookupByKey("PaymentMethod").Select(x =>
                            new SelectListItem()
                            {
                                Text = x.DisplayText.ToString(),
                                Value = x.DataValue.ToString()
                            }).ToList();
            ViewBag.BillCycle = _Util.Facade.LookupFacade.GetLookupByKey("BillCycle").Select(x =>
                            new SelectListItem()
                            {
                                Text = x.DisplayText.ToString(),
                                Value = x.DataValue.ToString()
                            }).ToList();
            ViewBag.EmployeeName = _Util.Facade.EmployeeFacade.GetAllEmployee(CurrentUser.CompanyId.Value).Select(x =>
                                  new SelectListItem()
                                  {
                                      Text = x.FirstName.ToString() + " " + x.LastName.ToString(),
                                      Value = x.UserId.ToString()
                                  }).ToList();
            List<SelectListItem> InstallerList = new List<SelectListItem>();
            InstallerList.Add(new SelectListItem()
            {
                Text = "Please Select One",
                Value = ""
            });
            //InstallerList.AddRange(_Util.Facade.EmployeeFacade.GetAllInstallerEmployeeByCompnayId(CurrentUser.CompanyId.Value).Select(x =>
            //                new SelectListItem()
            //                {
            //                    Text = x.FirstName + " " + x.LastName,
            //                    Value = x.EmployeeId.ToString()
            //                }).ToList());
            List<Employee> EmployeeDropDownList = _Util.Facade.EmployeeFacade.GetEmployeeByCompanyIdAndTag(CurrentUser.CompanyId.Value, LabelHelper.UserTags.Installer, new Guid());
            if (EmployeeDropDownList != null && EmployeeDropDownList.Count > 0)
            {
                InstallerList.AddRange(EmployeeDropDownList.OrderBy(x => x.FirstName).Select(x =>
                           new SelectListItem()
                           {
                               Text = x.FirstName + " " + x.LastName,
                               Value = x.UserId.ToString()
                           }).ToList());
            }

            ViewBag.InstallerList = InstallerList;


            List<SelectListItem> FundingCompany = new List<SelectListItem>();
            FundingCompany.Add(new SelectListItem() { Text = "Please Select One", Value = "-1" });
            FundingCompany.AddRange(_Util.Facade.FundFacade.GetAllFundingCompany().Select(x =>
                             new SelectListItem()
                             {
                                 Text = x.Name.ToString(),
                                 Value = x.Value.ToString()
                             }).ToList());
            ViewBag.FundingCompany = FundingCompany;

            ViewBag.BillYesNo = _Util.Facade.LookupFacade.GetLookupByKey("CustomerTaxYesNo").Select(x =>
                             new SelectListItem()
                             {
                                 Text = x.DisplayText.ToString(),
                                 Value = x.DataValue.ToString(),
                                 Selected = x.IsDefaultItem == true
                             }).ToList();
        }

        #endregion

        #region Make address
        private string MakeAddress(string street, string city, string state, string zipcode, string country)
        {
            string address = "";
            if (!string.IsNullOrWhiteSpace(street))
            {
                address += street + ",";
            }
            if (!string.IsNullOrWhiteSpace(city))
            {
                if (city != "-1")
                {
                    address += city + ",";
                }
            }
            if (!string.IsNullOrWhiteSpace(state))
            {
                if (state != "-1")
                {
                    address += state + ",";
                }
            }
            if (!string.IsNullOrWhiteSpace(zipcode))
            {
                address += zipcode + ",";
            }
            if (!string.IsNullOrWhiteSpace(country))
            {
                address += country + ",";
            }
            return address.TrimEnd(',');
        }
        #endregion

        [Authorize]
        public ActionResult QA1QuestionariePartial(int? id)
        {
            var currentLoggedIn = ((HS.Web.UI.Helper.CustomPrincipal)(User));
            if (currentLoggedIn == null)
            {
                return PartialView("~/Views/Shared/_AccessDenied.cshtml");
            }
            var objcus = _Util.Facade.CustomerFacade.GetById(id.Value);
            if (objcus != null)
            {
                ViewBag.LogName = objcus.FirstName + " " + objcus.LastName;
            }
            var objemp = _Util.Facade.EmployeeFacade.GetEmployeeByUserId(currentLoggedIn.UserId);
            if (objemp != null)
            {
                ViewBag.LogUser = objemp.FirstName + " " + objemp.LastName;
            }
            ViewBag.ComName = _Util.Facade.CompanyFacade.GetCompanyByComapnyId(currentLoggedIn.CompanyId.Value).CompanyName;
            ListQuestionAnswer model = new ListQuestionAnswer();
            if (id.HasValue)
            {
                model.ListQa1Question = _Util.Facade.QAQuestionFacade.GetQa1QuestionByCompanyId(currentLoggedIn.CompanyId.Value);
                model.QACustomer = objcus;
                if (model.QACustomer.Soldby != "-1" && model.QACustomer.Soldby != "")
                {
                    Guid valsale = new Guid(model.QACustomer.Soldby);
                    var empobj = _Util.Facade.EmployeeFacade.GetEmployeeByEmployeeId(valsale);
                    if (empobj != null)
                    {
                        model.QACustomer.PersonSales = empobj.FirstName + " " + empobj.LastName;
                    }
                }
            }
            List<SelectListItem> InstallerList = new List<SelectListItem>();
            InstallerList.Add(new SelectListItem()
            {
                Text = "Please Select One",
                Value = ""
            });
            InstallerList.AddRange(_Util.Facade.EmployeeFacade.GetAllInstallerEmployeeByCompnayId(currentLoggedIn.CompanyId.Value).Select(x =>
                           new SelectListItem()
                           {
                               Text = x.FirstName + " " + x.LastName,
                               Value = x.UserId.ToString()
                           }).ToList());
            ViewBag.InstallerList = InstallerList;
            ViewBag.LeadCustomerIdForQuestionaire = _Util.Facade.CustomerFacade.GetCustomersById(id.Value).CustomerId;
            ViewBag.LeadIDForQuestionarie = id.Value;
            var InstallerIdval = _Util.Facade.CustomerFacade.GetEmployeeIdByCompanyIdandCustomerId(currentLoggedIn.CompanyId.Value, id.Value);
            if (InstallerIdval != null)
            {
                if (InstallerIdval.InstallerId != null)
                {
                    ViewBag.ValIdInstaller = InstallerIdval.InstallerId;
                }
            }
            var objworkappointment = _Util.Facade.CustomerAppoinmentFacade.GetAllAppointmentByCustomerId(ViewBag.LeadCustomerIdForQuestionaire);
            if (objworkappointment != null)
            {
                ViewBag.TechDateVal = objworkappointment.AppointmentDate;
            }
            model.ListQa1Answer = _Util.Facade.QaAnswerFacade.GetQa1QuestionaireByCompanyIdandCustomerId(currentLoggedIn.CompanyId.Value, ViewBag.LeadCustomerIdForQuestionaire);
            model.ListQaQuesNotQaAnswer = _Util.Facade.QAQuestionFacade.GetQa1QuestionListNotInQaAnswer(currentLoggedIn.CompanyId.Value, ViewBag.LeadCustomerIdForQuestionaire);
            ViewBag.HeaderData = _Util.Facade.GlobalSettingsFacade.GetGlobalSettingsByKey(currentLoggedIn.CompanyId.Value, "QATechQuestionaireCall").Value;
            return View("QA1QuestionariePartial", model);
        }

        [Authorize]
        [HttpPost]
        public JsonResult AddNewQuestionaire(string LeadCustomerId, List<ListOfQaAnswers> QaAnswersList, int LeadId, string TechDate, string TechId)
        {
            bool result = false;
            var currentLoggedIn = ((HS.Web.UI.Helper.CustomPrincipal)(User));
            if (QaAnswersList != null)
            {
                var CheckQAExist = _Util.Facade.QaAnswerFacade.GetQa1QuestionaireByCompanyIdandCustomerId(currentLoggedIn.CompanyId.Value, new Guid(LeadCustomerId));
                if (CheckQAExist.Count > 0)
                {
                    foreach (var item1 in QaAnswersList)
                    {
                        if (item1.SelectedAnswer == "true")
                        {
                            var ObjAnswerFalseList = _Util.Facade.QaAnswerFacade.GetQa1QuestionaireAnswerFalseByCompanyIdandCustomerId(currentLoggedIn.CompanyId.Value, new Guid(LeadCustomerId), item1.SelectedQuesid);
                            if (ObjAnswerFalseList != null)
                            {
                                QaAnswer objQaAnswer = new QaAnswer()
                                {
                                    Id = ObjAnswerFalseList.Id,
                                    CompanyId = currentLoggedIn.CompanyId.Value,
                                    CustomerId = new Guid(LeadCustomerId),
                                    QuestionId = item1.SelectedQuesid,
                                    Answer = item1.SelectedAnswer
                                };
                                _Util.Facade.QaAnswerFacade.UpdateQaAnswer(objQaAnswer);
                            }
                        }

                    }
                }
                else
                {
                    foreach (var Item in QaAnswersList)
                    {
                        var Boolval = Convert.ToBoolean(Item.SelectedAnswer);

                        QaAnswer _QaAnswer = new QaAnswer()
                        {
                            CompanyId = currentLoggedIn.CompanyId.Value,
                            CustomerId = new Guid(LeadCustomerId),
                            QuestionId = Item.SelectedQuesid,
                            Answer = Item.SelectedAnswer
                        };
                        _Util.Facade.QaAnswerFacade.InsertQaAnswer(_QaAnswer);
                    }
                }
                var LeadobjName = _Util.Facade.CustomerFacade.GetLeadNameByLeadId(LeadId).LeadName;
                var ScheduleId = _Util.Facade.ScheduleFacade.GetByQA1Id(LeadId);
                Schedule modelSchedule = new Schedule();
                if (ScheduleId != null)
                {
                    modelSchedule.Id = ScheduleId.Id;
                    if (modelSchedule.Id > 0)
                    {
                        modelSchedule.CompanyId = currentLoggedIn.CompanyId.Value;
                        modelSchedule.Type = ScheduleType.QA1;
                        modelSchedule.StartDate = (DateTime.Now.UTCCurrentTime()).AddDays(1);
                        modelSchedule.EndDate = (DateTime.Now.UTCCurrentTime()).AddDays(2);
                        modelSchedule.Title = ScheduleTitle.QA1Required + " " + LeadobjName;
                        modelSchedule.LeadId = LeadId;
                        modelSchedule.IsCompleted = true;
                        modelSchedule.Identifier = "00000000-0000-0000-0000-000000000000";
                        _Util.Facade.ScheduleFacade.UpdateSchedule(modelSchedule);
                    }
                }
                var objworkappointment = _Util.Facade.CustomerAppoinmentFacade.GetAllAppointmentByCustomerId(new Guid(LeadCustomerId));
                if (objworkappointment != null)
                {
                    if (TechDate != "" && TechId != "" && objworkappointment.AppointmentType == "WorkOrder")
                    {
                        objworkappointment.AppointmentDate = Convert.ToDateTime(TechDate);
                        objworkappointment.EmployeeId = new Guid(TechId);
                        _Util.Facade.CustomerAppoinmentFacade.UpdateCustomerAppoinment(objworkappointment);
                    }
                }
                var objCusInfo = _Util.Facade.CustomerFacade.GetById(LeadId);
                if (objCusInfo != null)
                {
                    if (objCusInfo.Id > 0)
                    {
                        objCusInfo.Installer = TechId;
                        objCusInfo.IsActive = true;
                        _Util.Facade.CustomerFacade.UpdateCustomer(objCusInfo);
                    }
                }
                result = true;
                //}
            }
            return Json(new { result = result, LeadQuestionaireId = LeadId, Techdateid = TechDate });
        }

        public ActionResult QA2QuestionariePartial(int? id)
        {
            var currentLoggedIn = ((HS.Web.UI.Helper.CustomPrincipal)(User));
            var objcus = _Util.Facade.CustomerFacade.GetById(id.Value);
            if (objcus != null)
            {
                ViewBag.LogName = objcus.FirstName + " " + objcus.LastName;
            }
            var objemp = _Util.Facade.EmployeeFacade.GetEmployeeByUserId(currentLoggedIn.UserId);
            if (objemp != null)
            {
                ViewBag.LogUser = objemp.FirstName + " " + objemp.LastName;
            }
            ViewBag.ComName = _Util.Facade.CompanyFacade.GetCompanyByComapnyId(currentLoggedIn.CompanyId.Value).CompanyName;
            ListQuestionAnswer model = new ListQuestionAnswer();
            if (id.HasValue)
            {
                model.ListQa2Question = _Util.Facade.QAQuestionFacade.GetQa2QuestionByCompanyId(currentLoggedIn.CompanyId.Value);
                model.QACustomer = objcus;
                if (model.QACustomer.Soldby != "-1" && model.QACustomer.Soldby != "")
                {
                    Guid valsale = new Guid(model.QACustomer.Soldby);
                    var empobj = _Util.Facade.EmployeeFacade.GetEmployeeByEmployeeId(valsale);
                    if (empobj != null)
                    {
                        model.QACustomer.PersonSales = empobj.FirstName + " " + empobj.LastName;
                    }
                }
            }
            ViewBag.InstallerList = _Util.Facade.EmployeeFacade.GetAllInstallerEmployeeByCompnayId(currentLoggedIn.CompanyId.Value).Select(x =>
                           new SelectListItem()
                           {
                               Text = x.FirstName + " " + x.LastName,
                               Value = x.UserId.ToString()
                           }).ToList();
            ViewBag.LeadCustomerIdForQuestionaire = _Util.Facade.CustomerFacade.GetCustomersById(id.Value).CustomerId;
            ViewBag.LeadIDForQuestionarie = id.Value;
            model.ListQa2Answer = _Util.Facade.QaAnswerFacade.GetQa2QuestionaireByCompanyIdandCustomerId(currentLoggedIn.CompanyId.Value, ViewBag.LeadCustomerIdForQuestionaire);
            ViewBag.HeaderData = _Util.Facade.GlobalSettingsFacade.GetGlobalSettingsByKey(currentLoggedIn.CompanyId.Value, "QATechQuestionaireCall").Value;
            return View("QA2QuestionariePartial", model);
        }

        [Authorize]
        [HttpPost]
        public JsonResult AddNewQuestionaire2(string LeadCustomerId, List<ListOfQaAnswers> QaAnswersList, int LeadId1)
        {
            var currentLoggedIn = ((HS.Web.UI.Helper.CustomPrincipal)(User));

            if (QaAnswersList != null)
            {
                var CheckQAExist = _Util.Facade.QaAnswerFacade.GetQa2QuestionaireByCompanyIdandCustomerId(currentLoggedIn.CompanyId.Value, new Guid(LeadCustomerId));
                if (CheckQAExist != null)
                {
                    var Answerobj = _Util.Facade.QaAnswerFacade.DeleteQa2AnswerByCustomerIdAndComapnyId(new Guid(LeadCustomerId), currentLoggedIn.CompanyId.Value);
                }
                foreach (var Item in QaAnswersList)
                {
                    var Boolval = Convert.ToBoolean(Item.SelectedAnswer);

                    QaAnswer _QaAnswer = new QaAnswer()
                    {
                        CompanyId = currentLoggedIn.CompanyId.Value,
                        CustomerId = new Guid(LeadCustomerId),
                        QuestionId = Item.SelectedQuesid,
                        Answer = Item.SelectedAnswer
                    };
                    _Util.Facade.QaAnswerFacade.InsertQaAnswer(_QaAnswer);
                }
                var LeadobjName = _Util.Facade.CustomerFacade.GetLeadNameByLeadId(LeadId1).LeadName;
                var ScheduleId = _Util.Facade.ScheduleFacade.GetByQA2Id(LeadId1);
                if (ScheduleId != null)
                {
                    Schedule modelSchedule = new Schedule();
                    modelSchedule.Id = ScheduleId.Id;
                    if (modelSchedule.Id > 0)
                    {
                        modelSchedule.CompanyId = currentLoggedIn.CompanyId.Value;
                        modelSchedule.Type = ScheduleType.QA2;
                        modelSchedule.StartDate = (DateTime.Now.UTCCurrentTime()).AddDays(1);
                        modelSchedule.EndDate = (DateTime.Now.UTCCurrentTime()).AddDays(2);
                        modelSchedule.Title = ScheduleTitle.QA2Required + " " + LeadobjName;
                        modelSchedule.LeadId = LeadId1;
                        modelSchedule.IsCompleted = true;
                        modelSchedule.Identifier = "00000000-0000-0000-0000-000000000000";
                        _Util.Facade.ScheduleFacade.UpdateSchedule(modelSchedule);
                    }
                }

            }

            return Json(new { result = true, LeadQuestionaireId = LeadId1 });
        }

        [Authorize]
        public ActionResult LeadTechCallPartial(int? id)
        {
            var CurrentLoggedInUser = ((HS.Web.UI.Helper.CustomPrincipal)(User));

            if (CurrentLoggedInUser == null)
            {
                return PartialView("~/Views/Shared/_AccessDenied.cshtml");
            }

            ViewBag.TechCallCustomerId = new Guid();
            ViewBag.IsTechCallComplete = false;
            if (id.HasValue)
            {
                var CustomerInfo = _Util.Facade.CustomerFacade.GetCustomersById(id.Value);
                if (CustomerInfo != null)
                {
                    var CustomerGuidId = CustomerInfo.CustomerId;
                    ViewBag.TechCallCustomerId = CustomerGuidId;
                    ViewBag.TechCallCustomerIntId = id.Value;
                    ViewBag.IsTechCallComplete = CustomerInfo.IsTechCallPassed;
                }
            }

            return View("LeadTechCallPartial");
        }
        #region share customer info
        public PartialViewResult ShareCustomerInfo(int Id, string from)
        {
            var CurrentUser = (HS.Web.UI.Helper.CustomPrincipal)User;
            CreateCustomerShareInfo model = new CreateCustomerShareInfo();
            string greetingstext = "";
            if (Id > 0)
            {
                model.Customer = _Util.Facade.CustomerFacade.GetCustomersById(Id);
            }
            List<GridSetting> CustomerBlockUiSetting = new List<GridSetting>();
            CustomerBlockUiSetting = _Util.Facade.GridSettingsFacade.GetAllByKey("CustomerGrid", CurrentUser.CompanyId.Value);
            if (CustomerBlockUiSetting.Count > 0)
            {
                CustomerBlockUiSetting = CustomerBlockUiSetting.OrderBy(x => x.OrderBy).Where(x => x.FormActive == true).ToList();
            }
            List<GridSetting> LeadUiSetting = new List<GridSetting>();
            LeadUiSetting = _Util.Facade.GridSettingsFacade.GetAllByKey("LeadGrid", CurrentUser.CompanyId.Value);
            if (LeadUiSetting.Count > 0)
            {
                LeadUiSetting = LeadUiSetting.Where(x => x.FormActive == true).ToList();
            }
            var objcom = _Util.Facade.CompanyFacade.GetAllCompanyByCompanyId(CurrentUser.CompanyId.Value).FirstOrDefault();
            if (model.Customer != null)
            {
                model.CustomerName = model.Customer.FirstName + " " + model.Customer.LastName;

                if (!string.IsNullOrWhiteSpace(model.Customer.CellNo) && model.Customer.CellNo.Length > 6)
                {
                    model.CustomerContactNumber = model.Customer.CellNo;
                }
                else if (!string.IsNullOrWhiteSpace(model.Customer.PrimaryPhone) && model.Customer.PrimaryPhone.Length > 6)
                {
                    model.CustomerContactNumber = model.Customer.PrimaryPhone;
                }
                else if (!string.IsNullOrWhiteSpace(model.Customer.SecondaryPhone) && model.Customer.SecondaryPhone.Length > 6)
                {
                    model.CustomerContactNumber = model.Customer.SecondaryPhone;
                }

                model.CustomerAddress = MakeAddress(model.Customer.Street, " " + model.Customer.City, " " + model.Customer.State, " " + model.Customer.ZipCode, " " + model.Customer.Country);
            }
            if (objcom != null)
            {
                model.CompanyName = objcom.CompanyName;
                model.CompanyEmail = objcom.EmailAdress;
            }
            var objemp = _Util.Facade.EmployeeFacade.GetEmployeeByEmployeeId(CurrentUser.UserId);
            if (objemp != null)
            {
                ViewBag.SalesGuy = objemp.FirstName + " " + objemp.LastName;
                if (!string.IsNullOrWhiteSpace(objemp.Phone))
                {
                    ViewBag.SalesPhone = objemp.Phone;
                }
                else
                {
                    ViewBag.SalesPhone = objcom.Phone;
                }
            }
            model.ShortUrl = string.Concat(AppConfig.ShortSiteDomain, "/shrt/");
            //if (Session[SessionKeys.InvoicePdfSession] != null)
            //{
            //    List<InvoiceSessionModel> ModelList = (List<InvoiceSessionModel>)Session[SessionKeys.InvoicePdfSession];
            //    ViewBag.pdfLocation = AppConfig.DomainSitePath + "/" + ModelList.Where(x => x.InvoiceId == model.Invoice.InvoiceId).Select(x => x.FileName).FirstOrDefault();
            //}
            model.SMSBody = string.Concat("Customer Info from", " ", model.CompanyName, ": ", Environment.NewLine,
                "Customer Id: " + model.Customer.Id, Environment.NewLine,
                "Customer Name: " + model.CustomerName, Environment.NewLine,
                "Address: " + model.CustomerAddress, Environment.NewLine,
                "Email: " + model.Customer.EmailAddress, Environment.NewLine,
                "Phone: " + model.CustomerContactNumber, Environment.NewLine
                , Environment.NewLine, model.ShortUrl, "##url##");
            #region Emailtemplate
            Customer Cusmodel = _Util.Facade.CustomerFacade.GetCustomersByIdAndSoldBy(Id, CurrentUser.UserId, "", "");

            string EmailTemplate = "  ";
            if (from == "customer")
            {
                foreach (var item in CustomerBlockUiSetting)
                {
                    if (item.SelectedColumn == "Id" && Cusmodel.Id > 0)
                    {
                        EmailTemplate += "Customer Id: " + Cusmodel.Id + "<br>";

                    }
                    if (item.SelectedColumn == "Title" && !string.IsNullOrEmpty(Cusmodel.Title))
                    {
                        EmailTemplate += "Title: " + Cusmodel.Title + "<br>";
                    }

                    if (item.SelectedColumn == "FirstName" && !string.IsNullOrEmpty(Cusmodel.FirstName))
                    {
                        EmailTemplate += "Name: " + Cusmodel.FirstName + " " + Cusmodel.LastName + "<br>";
                    }
                    if (item.SelectedColumn == "MiddleName" && !string.IsNullOrEmpty(Cusmodel.MiddleName))
                    {
                        EmailTemplate += "Middle Name: " + Cusmodel.MiddleName + "<br>";
                    }
                    if (item.SelectedColumn == "Type" && !string.IsNullOrEmpty(model.Customer.Type) && model.Customer.Type != "-1")
                    {
                        EmailTemplate += "Type: " + model.Customer.Type + "<br>";
                    }
                    if (item.SelectedColumn == "Address" && !string.IsNullOrEmpty(Cusmodel.Street))
                    {
                        EmailTemplate += "Address: " + model.CustomerAddress + "<br>";
                    }

                    if (item.SelectedColumn == "CustomerAccountType" && !string.IsNullOrEmpty(Cusmodel.CustomerAccountType))
                    {
                        EmailTemplate += "Account Type: " + Cusmodel.CustomerAccountType + "<br>";
                    }
                    if (item.SelectedColumn == "BusinessName" && !string.IsNullOrEmpty(Cusmodel.BusinessName))
                    {
                        EmailTemplate += "Business Name: " + Cusmodel.BusinessName + "<br>";
                    }
                    if (item.SelectedColumn == "DBA" && !string.IsNullOrEmpty(Cusmodel.DBA))
                    {
                        EmailTemplate += "DBA: " + Cusmodel.DBA + "<br>";
                    }
                    if (item.SelectedColumn == "CustomerNo" && !string.IsNullOrEmpty(Cusmodel.CustomerNo))
                    {
                        EmailTemplate += "Customer No: " + Cusmodel.CustomerNo + "<br>";
                    }
                    if (item.SelectedColumn == "SecondCustomerNo" && !string.IsNullOrEmpty(Cusmodel.SecondCustomerNo))
                    {
                        EmailTemplate += "Second Customer No: " + Cusmodel.SecondCustomerNo + "<br>";
                    }
                    if (item.SelectedColumn == "AdditionalCustomerNo" && !string.IsNullOrEmpty(Cusmodel.AdditionalCustomerNo))
                    {
                        EmailTemplate += "Additional Customer No: " + Cusmodel.AdditionalCustomerNo + "<br>";
                    }
                    if (item.SelectedColumn == "InstalledStatus" && !string.IsNullOrEmpty(Cusmodel.InstalledStatus))
                    {
                        EmailTemplate += "Installed Status: " + Cusmodel.InstalledStatus + "<br>";
                    }
                    if (item.SelectedColumn == "DateofBirth" && Cusmodel.DateofBirth != null && Cusmodel.DateofBirth != new DateTime())
                    {
                        EmailTemplate += "Date of Birth: " + Cusmodel.DateofBirth.Value.ToString("MM/dd/yy") + "<br>";
                    }
                    if (item.SelectedColumn == "EmailAddress" && !string.IsNullOrEmpty(Cusmodel.EmailAddress))
                    {
                        EmailTemplate += "Email: " + Cusmodel.EmailAddress + "<br>";
                    }
                    if (item.SelectedColumn == "AccessGivenTo" && !string.IsNullOrEmpty(Cusmodel.AccessGivenToVal))
                    {
                        EmailTemplate += "Access Assign To: " + Cusmodel.AccessGivenToVal + "<br>";
                    }
                    if (item.SelectedColumn == "PrimaryPhone" && !string.IsNullOrEmpty(Cusmodel.PrimaryPhone))
                    {
                        EmailTemplate += "Site Phone: " + Cusmodel.PrimaryPhone + "<br>";
                    }
                    if (item.SelectedColumn == "SecondaryPhone" && !string.IsNullOrEmpty(Cusmodel.SecondaryPhone))
                    {
                        EmailTemplate += "Secondary Phone: " + Cusmodel.SecondaryPhone + "<br>";
                    }
                    if (item.SelectedColumn == "CellNo" && !string.IsNullOrEmpty(Cusmodel.CellNo))
                    {
                        EmailTemplate += "Cell Phone: " + Cusmodel.CellNo + "<br>";
                    }
                    if (item.SelectedColumn == "LeadSource" && !string.IsNullOrEmpty(Cusmodel.LeadSource) && (Cusmodel.LeadSource != "-1" && Cusmodel.LeadSource != "" && Cusmodel.LeadSource != "Select One"))
                    {
                        EmailTemplate += "Lead Source: " + Cusmodel.LeadSourceVal + "<br>";
                    }
                    if (item.SelectedColumn == "LeadSourceType" && !string.IsNullOrEmpty(Cusmodel.LeadSourceType) && Cusmodel.LeadSourceType != "-1" && PermissionChecker.IsPermitted(PermissionList.LeadPermissions.LeadSourceType))
                    {
                        EmailTemplate += "Lead Source Type: " + Cusmodel.LeadSourceType + "<br>";
                    }

                    if (item.SelectedColumn == "CustomerFunded" && Cusmodel.CustomerFunded == true)
                    {
                        EmailTemplate += "Customer Funded: " + "Yes" + "<br>";

                    }
                    if (item.SelectedColumn == "CustomerFunded" && Cusmodel.CustomerFunded == false)
                    {
                        EmailTemplate += "Customer Funded: " + "No" + "<br>";

                    }
                    if (item.SelectedColumn == "BusinessAccountType" && !string.IsNullOrEmpty(Cusmodel.BusinessAccountType) && Cusmodel.BusinessAccountType != "-1")
                    {
                        EmailTemplate += "Business Account Type: " + Cusmodel.BusinessAccountType + "<br>";
                    }

                    if (item.SelectedColumn == "InstallDate" && Cusmodel.InstallDate != null && Cusmodel.InstallDate != new DateTime())
                    {
                        EmailTemplate += "Install Date: " + Cusmodel.InstallDate.Value.ToString("MM/dd/yy") + "<br>";
                    }
                    if (item.SelectedColumn == "IsActive" && Cusmodel.IsActive == true)
                    {
                        EmailTemplate += "Active Status: " + "Active" + "<br>";

                    }
                    if (item.SelectedColumn == "IsActive" && Cusmodel.IsActive == false)
                    {
                        EmailTemplate += "Active Status: " + "InActive" + "<br>";

                    }
                    if (item.SelectedColumn == "BranchId" && Cusmodel.CompanyBranch != null)
                    {
                        EmailTemplate += "Branch: " + Cusmodel.CompanyBranch.Name + "<br>";
                    }
                    if (item.SelectedColumn == "Route" && Cusmodel.RouteName != null)
                    {
                        EmailTemplate += "Route: " + Cusmodel.RouteName + "<br>";
                    }
                    if (item.SelectedColumn == "AnnualRevenue" && Cusmodel.AnnualRevenue != null)
                    {
                        EmailTemplate += "Annual Revenue: " + Cusmodel.AnnualRevenue + "<br>";
                    }
                    if (item.SelectedColumn == "AcquiredFrom" && !string.IsNullOrEmpty(Cusmodel.AcquiredFrom))
                    {
                        EmailTemplate += "Acquired From: " + Cusmodel.AcquiredFrom + "<br>";
                    }

                    if (item.SelectedColumn == "FollowUpDate" && Cusmodel.FollowUpDate != null && Cusmodel.FollowUpDate != new DateTime())
                    {
                        EmailTemplate += "Follow Up Date: " + Cusmodel.FollowUpDate.Value.ToString("MM/dd/yy") + "<br>";
                    }
                    if (item.SelectedColumn == "BuyoutAmountByADS" && Cusmodel.BuyoutAmountByADS != null)
                    {
                        EmailTemplate += "Buyout Amount By ADS: " + Cusmodel.BuyoutAmountByADS + "<br>";
                    }
                    if (item.SelectedColumn == "BuyoutAmountBySalesRep" && Cusmodel.BuyoutAmountBySalesRep != null)
                    {
                        EmailTemplate += "Buyout Amount By Sales Rep: " + Cusmodel.BuyoutAmountBySalesRep + "<br>";
                    }
                    if (item.SelectedColumn == "FinancedTerm" && Cusmodel.FinancedTerm != null)
                    {
                        EmailTemplate += "Financed Term: " + Cusmodel.FinancedTerm + "<br>";
                    }
                    if (item.SelectedColumn == "FinancedAmount" && Cusmodel.FinancedAmount != null)
                    {
                        EmailTemplate += "Financed Amount: " + Cusmodel.FinancedAmount + "<br>";
                    }
                    if (item.SelectedColumn == "Levels" && Cusmodel.Levels != null)
                    {
                        EmailTemplate += "Levels: " + Cusmodel.Levels + "<br>";
                    }
                    if (item.SelectedColumn == "SoldAmount" && Cusmodel.SoldAmount != null)
                    {
                        EmailTemplate += "Sold Amount: " + Cusmodel.SoldAmount + "<br>";
                    }
                    if (item.SelectedColumn == "Website" && !string.IsNullOrEmpty(Cusmodel.Website))
                    {
                        EmailTemplate += "Website: " + Cusmodel.Website + "<br>";
                    }
                    if (item.SelectedColumn == "BestTimeToCall" && !string.IsNullOrEmpty(Cusmodel.BestTimeToCall) && Cusmodel.BestTimeToCall != "-1")
                    {
                        EmailTemplate += "Best Time To Call: " + Cusmodel.BestTimeToCall + "<br>";
                    }
                    if (item.SelectedColumn == "CSProvider" && !string.IsNullOrEmpty(Cusmodel.CSProvider) && Cusmodel.CSProvider != "-1")
                    {
                        EmailTemplate += "CS Provider: " + Cusmodel.CSProvider + "<br>";
                    }
                    if (item.SelectedColumn == "Market" && !string.IsNullOrEmpty(Cusmodel.Market) && Cusmodel.Market != "-1")
                    {
                        EmailTemplate += "Market: " + Cusmodel.Market + "<br>";
                    }
                    if (item.SelectedColumn == "Passengers" && Cusmodel.Passengers != null)
                    {
                        EmailTemplate += "Passengers: " + Cusmodel.Passengers + "<br>";
                    }
                    if (item.SelectedColumn == "Budget" && Cusmodel.Budget != null)
                    {
                        EmailTemplate += "Budget: " + HS.Web.UI.Helper.LabelHelper.CurrentTransMakeCurrency.MakeCurrency(null) + HS.Web.UI.Helper.LabelHelper.FormatAmount(Cusmodel.Budget.Value) + "<br>";
                    }
                    if (item.SelectedColumn == "Ownership" && !string.IsNullOrEmpty(Cusmodel.Ownership) && Cusmodel.Ownership != "-1")
                    {
                        EmailTemplate += "Ownership: " + Cusmodel.Ownership + "<br>";
                    }

                    if (item.SelectedColumn == "SSN" && !string.IsNullOrEmpty(Cusmodel.SSN))
                    {
                        var SSN = "";
                        if (!string.IsNullOrEmpty(Cusmodel.SSN) && Cusmodel.SSN.Length > 4)
                        {
                            int n;
                            bool isNumeric = int.TryParse(Cusmodel.SSN, out n);
                            if (isNumeric)
                            {
                                var FormateSSN = Cusmodel.SSN.Substring(Cusmodel.SSN.Length - 4);
                                SSN = String.Format("{0:XXX-XX-0000}", Convert.ToInt32(FormateSSN));
                            }
                        }
                        if (PermissionChecker.IsPermitted(PermissionList.CustomerPermissions.ShowSSNFullNumber))
                        {
                            EmailTemplate += "SSN: " + Cusmodel.SSN + "<br>";

                        }
                        else
                        {
                            EmailTemplate += "SSN: " + SSN + "<br>";

                        }
                    }
                    if (item.SelectedColumn == "PurchasePrice" && Cusmodel.PurchasePrice != null)
                    {
                        EmailTemplate += "Purchase Price: " + HS.Web.UI.Helper.LabelHelper.CurrentTransMakeCurrency.MakeCurrency(null) + HS.Web.UI.Helper.LabelHelper.FormatAmount(Cusmodel.PurchasePrice.Value) + "<br>";
                    }
                    if (item.SelectedColumn == "ContractValue" && !string.IsNullOrEmpty(Cusmodel.ContractValue))
                    {
                        EmailTemplate += "Contract Value: " + Cusmodel.ContractValue + "<br>";
                    }
                    if (item.SelectedColumn == "BrinksFundingStatus" && Cusmodel.CustomerExtended != null && !string.IsNullOrEmpty(Cusmodel.CustomerExtended.BrinksFundingStatus))
                    {
                        EmailTemplate += "Brinks Funding Status: " + Cusmodel.CustomerExtended.BrinksFundingStatus + "<br>";
                    }
                    if (item.SelectedColumn == "FinanceFundingStatus" && Cusmodel.CustomerExtended != null && !string.IsNullOrEmpty(Cusmodel.CustomerExtended.FinanceFundingStatus))
                    {
                        EmailTemplate += "Finance Funding Status: " + Cusmodel.CustomerExtended.FinanceFundingStatus + "<br>";
                    }
                    if (item.SelectedColumn == "CreatedBy" && !string.IsNullOrEmpty(objemp.FirstName) && !string.IsNullOrEmpty(objemp.LastName))
                    {
                        EmailTemplate += "Created By: " + ViewBag.SalesGuy + "<br>";
                    }

                    if (item.SelectedColumn == "HomeOwner" && !string.IsNullOrEmpty(Cusmodel.HomeOwner))
                    {
                        EmailTemplate += "Home Owner: " + Cusmodel.HomeOwner + "<br>";
                    }
                    if (item.SelectedColumn == "CreatedDate" && Cusmodel.CreatedDate != null && Cusmodel.CreatedDate != new DateTime())
                    {
                        EmailTemplate += "Created Date: " + Cusmodel.CreatedDate.UTCToClientTime().ToString("MM/dd/yy hh:mm tt") + "<br>";
                    }
                    if (item.SelectedColumn == "Fax" && !string.IsNullOrEmpty(Cusmodel.Fax))
                    {
                        EmailTemplate += "Fax: " + Cusmodel.Fax + "<br>";
                    }
                    if (item.SelectedColumn == "RenewalTerm" && Cusmodel.RenewalTerm > 0)
                    {
                        EmailTemplate += "Renewal Term: " + Cusmodel.RenewalTerm + "<br>";
                    }
                    if (item.SelectedColumn == "CallingTime" && !string.IsNullOrEmpty(Cusmodel.CallingTime) && Cusmodel.CallingTime != "-1")
                    {
                        EmailTemplate += "Calling Time: " + Cusmodel.CallingTime + "<br>";
                    }
                    if (item.SelectedColumn == "AccountNo" && !string.IsNullOrEmpty(Cusmodel.AccountNo))
                    {
                        EmailTemplate += "Account No: " + Cusmodel.AccountNo + "<br>";
                    }
                    if (item.SelectedColumn == "IsAlarmCom" && Cusmodel.IsAlarmCom == true)
                    {
                        EmailTemplate += "Alarming: " + "Yes" + "<br>";

                    }
                    if (item.SelectedColumn == "IsAlarmCom" && Cusmodel.IsAlarmCom == false)
                    {
                        EmailTemplate += "Alarming: " + "No" + "<br>";

                    }
                    if (item.SelectedColumn == "CreditScore" && !string.IsNullOrEmpty(Cusmodel.CreditScore) && Cusmodel.CreditScore != "-1")
                    {
                        EmailTemplate += "Credit Grade: " + Cusmodel.CreditGrade + "<br>";
                    }
                    if (item.SelectedColumn == "CreditScoreValue" && Cusmodel.CreditScoreValue > 0)
                    {
                        if (PermissionChecker.IsPermitted(PermissionList.CustomerPermissions.CustomerCreditScore))
                        {
                            EmailTemplate += "Credit Score: " + Cusmodel.CreditScoreValue + "<br>";

                        }
                        else
                        {
                            EmailTemplate += "Credit Score: ****" + "<br>";

                        }
                    }
                    if (item.SelectedColumn == "SalesLocation" && !string.IsNullOrEmpty(Cusmodel.SalesLocation) && Cusmodel.SalesLocation != "-1")
                    {
                        EmailTemplate += "Sales Location: " + Cusmodel.SalesLocation + "<br>";
                    }
                    if (item.SelectedColumn == "FundingCompany" && !string.IsNullOrEmpty(Cusmodel.FundingCompany) && Cusmodel.FundingCompany != "-1")
                    {
                        EmailTemplate += "Funding Company: " + Cusmodel.FundingCompany + "<br>";
                    }
                    if (item.SelectedColumn == "CellularBackup" && Cusmodel.CellularBackup == true)
                    {
                        EmailTemplate += "Cellular Backup: " + "Yes" + "<br>";

                    }
                    if (item.SelectedColumn == "CellularBackup" && Cusmodel.CellularBackup == false)
                    {
                        EmailTemplate += "Cellular Backup: " + "No" + "<br>";

                    }
                    if (item.SelectedColumn == "Lead Status" && !string.IsNullOrEmpty(Cusmodel.Status) && Cusmodel.Status != "-1")
                    {
                        EmailTemplate += "Lead Status: " + Cusmodel.StatusVal + "<br>";
                    }
                    if (item.SelectedColumn == "CustomerStatus" && !string.IsNullOrEmpty(Cusmodel.CustomerStatusVal) && Cusmodel.CustomerStatusVal != "-1")
                    {
                        EmailTemplate += "Customer Status: " + Cusmodel.CustomerStatusVal + "<br>";
                    }
                    if (item.SelectedColumn == "Maintenance" && Cusmodel.Maintenance == true)
                    {
                        EmailTemplate += "Maintenance: " + "Yes" + "<br>";

                    }
                    if (item.SelectedColumn == "Maintenance" && Cusmodel.Maintenance == false)
                    {
                        EmailTemplate += "Maintenance: " + "No" + "<br>";

                    }
                    if (item.SelectedColumn == "SalesDate" && Cusmodel.SalesDate != null && Cusmodel.SalesDate != new DateTime())
                    {
                        if (Cusmodel.SalesDate.Value.ToString("MM/dd/yy") != "01/01/00")
                        {
                            EmailTemplate += "Sales Date: " + Cusmodel.SalesDate.Value.ToString("MM/dd/yy") + "<br>";

                        }
                    }
                    if (item.SelectedColumn == "CutInDate" && Cusmodel.CutInDate != null && Cusmodel.CutInDate != new DateTime())
                    {

                        EmailTemplate += "Cut In Date: " + Cusmodel.CutInDate.Value.ToString("MM/dd/yy") + "<br>";


                    }
                    if (item.SelectedColumn == "Installer" && !string.IsNullOrEmpty(Cusmodel.InstallerName))
                    {
                        EmailTemplate += "Installer: " + Cusmodel.InstallerName + "<br>";
                    }
                    if (item.SelectedColumn == "SoldBy" && !string.IsNullOrEmpty(Cusmodel.PersonSales))
                    {
                        EmailTemplate += "Sales Person: " + Cusmodel.PersonSales + "<br>";
                    }
                    if (item.SelectedColumn == "SoldBy2" && !string.IsNullOrEmpty(Cusmodel.SoldBy2Text))
                    {
                        EmailTemplate += "Sales Person 2: " + Cusmodel.SoldBy2Text + "<br>";
                    }
                    if (item.SelectedColumn == "SoldBy3" && !string.IsNullOrEmpty(Cusmodel.SoldBy3Text))
                    {
                        EmailTemplate += "Sales Person 3: " + Cusmodel.SoldBy3Text + "<br>";
                    }
                    if (item.SelectedColumn == "InspectionCompany" && !string.IsNullOrEmpty(Cusmodel.InspectionCompany))
                    {
                        EmailTemplate += "Inspection Company: " + Cusmodel.InspectionCompany + "<br>";
                    }
                    if (item.SelectedColumn == "FundingDate" && Cusmodel.CustomerFundedDate != null && Cusmodel.CustomerFundedDate != new DateTime())
                    {

                        EmailTemplate += "Funding Date: " + Cusmodel.CustomerFundedDate.Value.ToString("MM/dd/yy") + "<br>";


                    }
                    if (item.SelectedColumn == "ReminderDate" && Cusmodel.ReminderDate != null && Cusmodel.ReminderDate != new DateTime())
                    {

                        EmailTemplate += "Reminder Date: " + Cusmodel.ReminderDate.Value.ToString("MM/dd/yy") + "<br>";


                    }
                    if (item.SelectedColumn == "DoNotCall" && Cusmodel.DoNotCall != null && Cusmodel.DoNotCall != new DateTime())
                    {

                        EmailTemplate += "Do Not Call: " + Cusmodel.DoNotCall.Value.ToString("MM/dd/yy") + "<br>";


                    }
                    if (item.SelectedColumn == "ServiceDate" && Cusmodel.ServiceDate != null && Cusmodel.ServiceDate != new DateTime())
                    {

                        EmailTemplate += "Service Date: " + Cusmodel.ServiceDate.Value.ToString("MM/dd/yy") + "<br>";


                    }
                    if (item.SelectedColumn == "Area" && !string.IsNullOrEmpty(Cusmodel.Area))
                    {
                        EmailTemplate += "Area: " + Cusmodel.Area + "<br>";
                    }
                    if (item.SelectedColumn == "Latlng" && !string.IsNullOrEmpty(Cusmodel.Latlng))
                    {
                        EmailTemplate += "Latlng: " + Cusmodel.Latlng + "<br>";
                    }
                    if (item.SelectedColumn == "IsTechCallPassed" && Cusmodel.IsTechCallPassed == true)
                    {
                        EmailTemplate += "Tech Call: " + "Yes" + "<br>";

                    }
                    if (item.SelectedColumn == "IsTechCallPassed" && Cusmodel.IsTechCallPassed == false)
                    {
                        EmailTemplate += "Tech Call: " + "No" + "<br>";

                    }
                    if (item.SelectedColumn == "IsDirect" && Cusmodel.IsDirect == true)
                    {
                        EmailTemplate += "Direct: " + "Yes" + "<br>";

                    }
                    if (item.SelectedColumn == "IsDirect" && Cusmodel.IsDirect == false)
                    {
                        EmailTemplate += "Direct: " + "No" + "<br>";

                    }
                    if (item.SelectedColumn == "Passcode" && !string.IsNullOrEmpty(Cusmodel.Passcode))
                    {
                        EmailTemplate += "Passcode: " + Cusmodel.Passcode + "<br>";
                    }
                    if (item.SelectedColumn == "ActivationFee" && Cusmodel.ActivationFee != null)
                    {
                        EmailTemplate += "Activation Fee: " + Cusmodel.ActivationFee + "<br>";
                    }
                    if (item.SelectedColumn == "PackageActivationFee" && Cusmodel.ActivationFee != null && PermissionChecker.IsPermitted(PermissionList.CustomerPermissions.CustomerPackageActivationFee))
                    {
                        EmailTemplate += "Package Customer Activation Fee: " + HS.Web.UI.Helper.LabelHelper.CurrentTransMakeCurrency.MakeCurrency(null) + HS.Web.UI.Helper.LabelHelper.FormatAmount(Cusmodel.ActivationFee.Value) + "<br>";
                    }
                    if (item.SelectedColumn == "FirstBilling" && Cusmodel.FirstBilling != null && Cusmodel.FirstBilling != new DateTime())
                    {

                        EmailTemplate += "First Billing: " + Cusmodel.FirstBilling.Value.ToString("MM/dd/yy") + "<br>";


                    }
                    if (item.SelectedColumn == "LastGeneratedInvoice" && Cusmodel.LastGeneratedInvoice != null && Cusmodel.LastGeneratedInvoice != new DateTime())
                    {

                        EmailTemplate += "Last Generated Invoice: " + Cusmodel.LastGeneratedInvoice.Value.ToString("MM/dd/yy") + "<br>";


                    }
                    if (item.SelectedColumn == "Singature" && !string.IsNullOrEmpty(Cusmodel.Singature))
                    {
                        EmailTemplate += "Singature: " + Cusmodel.Singature + "<br>";
                    }
                    if (item.SelectedColumn == "CrossStreet" && !string.IsNullOrEmpty(Cusmodel.CrossStreet))
                    {
                        EmailTemplate += "CrossStreet: " + Cusmodel.CrossStreet + "<br>";
                    }
                    if (item.SelectedColumn == "IsAgreement" && Cusmodel.IsAgreement == true)
                    {
                        EmailTemplate += "Agreement: " + "Yes" + "<br>";

                    }
                    if (item.SelectedColumn == "IsAgreement" && Cusmodel.IsAgreement == false)
                    {
                        EmailTemplate += "Agreement: " + "No" + "<br>";

                    }
                    if (item.SelectedColumn == "IsFireAccount" && Cusmodel.IsFireAccount == true)
                    {
                        EmailTemplate += "Fire Account: " + "Yes" + "<br>";

                    }
                    if (item.SelectedColumn == "IsFireAccount" && Cusmodel.IsFireAccount == false)
                    {
                        EmailTemplate += "Fire Account: " + "No" + "<br>";

                    }
                    if (item.SelectedColumn == "PhoneType" && !string.IsNullOrEmpty(Cusmodel.PhoneType) && Cusmodel.PhoneType != "-1")
                    {
                        EmailTemplate += "Phone Type: " + Cusmodel.PhoneType + "<br>";
                    }
                    if (item.SelectedColumn == "Carrier" && !string.IsNullOrEmpty(Cusmodel.Carrier) && Cusmodel.Carrier != "-1")
                    {
                        EmailTemplate += "Carrier: " + Cusmodel.Carrier + "<br>";
                    }
                    if (item.SelectedColumn == "ReferringCustomer" && Cusmodel.ReferringCustomer != new Guid())
                    {
                        EmailTemplate += "Referring Customer: " + Cusmodel.RefCustomer + "<br>";
                    }
                    if (item.SelectedColumn == "EsistingPanel" && !string.IsNullOrEmpty(Cusmodel.EsistingPanel))
                    {
                        EmailTemplate += "Esisting Panel: " + Cusmodel.EsistingPanel + "<br>";
                    }
                    if (item.SelectedColumn == "ChildOf" && !string.IsNullOrEmpty(Cusmodel.chCustomer))
                    {
                        EmailTemplate += "Child Of: " + Cusmodel.chCustomer + "<br>";
                    }
                    if (item.SelectedColumn == "EmailVerified" && Cusmodel.EmailVerified == true)
                    {
                        EmailTemplate += "Email Verified: " + "Yes" + "<br>";

                    }
                    if (item.SelectedColumn == "EmailVerified" && Cusmodel.EmailVerified == false)
                    {
                        EmailTemplate += "Email Verified: " + "No" + "<br>";

                    }
                    if (item.SelectedColumn == "HomeVerified" && Cusmodel.HomeVerified == true)
                    {
                        EmailTemplate += "Home Verified: " + "Yes" + "<br>";

                    }
                    if (item.SelectedColumn == "HomeVerified" && Cusmodel.HomeVerified == false)
                    {
                        EmailTemplate += "Home Verified: " + "No" + "<br>";

                    }
                    if (item.SelectedColumn == "County" && !string.IsNullOrEmpty(Cusmodel.County))
                    {
                        EmailTemplate += "County: " + Cusmodel.County + "<br>";
                    }
                    if (item.SelectedColumn == "EstCloseDate" && Cusmodel.EstCloseDate != null && Cusmodel.EstCloseDate != new DateTime())
                    {

                        EmailTemplate += "Est Close Date: " + Cusmodel.EstCloseDate.Value.ToString("MM/dd/yy") + "<br>";


                    }
                    if (item.SelectedColumn == "DuplicateCustomer" && Cusmodel.DuplicateCustomer != null && Cusmodel.DuplicateCustomer != Guid.Empty && Cusmodel.DuplicateCustomerId != null)
                    {
                        EmailTemplate += "Duplicate Customer: " + Cusmodel.DuplicateCustomerName + "<br>";
                    }
                    if (item.SelectedColumn == "ProjectWalkDate" && Cusmodel.ProjectWalkDate != null && Cusmodel.ProjectWalkDate != new DateTime())
                    {

                        EmailTemplate += "Project Walk Date: " + Cusmodel.ProjectWalkDate.Value.ToString("MM/dd/yy") + "<br>";


                    }
                    if (item.SelectedColumn == "MovingDate" && Cusmodel.MovingDate != null && Cusmodel.MovingDate != new DateTime())
                    {

                        EmailTemplate += "Moving Date: " + Cusmodel.MovingDate.Value.ToString("MM/dd/yy") + "<br>";


                    }

                    if (item.SelectedColumn == "AgreementEmail" && !string.IsNullOrEmpty(Cusmodel.AgreementEmail))
                    {
                        EmailTemplate += "Agreement Email: " + Cusmodel.AgreementEmail + "<br>";
                    }
                    if (item.SelectedColumn == "AgreementPhoneNo" && !string.IsNullOrEmpty(Cusmodel.AgreementPhoneNo))
                    {
                        EmailTemplate += "Agreement Phone No: " + Cusmodel.AgreementPhoneNo + "<br>";
                    }
                    if (item.SelectedColumn == "Tax Exemption" && Cusmodel.TaxExemptionVal != null && Cusmodel.TaxExemptionVal != "" && Cusmodel.TaxExemptionVal != "Select One")
                    {
                        EmailTemplate += "Tax Exemption: " + Cusmodel.TaxExemptionVal + "<br>";
                    }
                    if (item.SelectedColumn == "Appointment Set" && Cusmodel.AppointmentSetVal != null && Cusmodel.AppointmentSetVal != "" && Cusmodel.AppointmentSetVal != "Select One")
                    {
                        EmailTemplate += "Appointment Set: " + Cusmodel.AppointmentSetVal + "<br>";
                    }
                    if (item.SelectedColumn == "MapscoNo" && !string.IsNullOrEmpty(Cusmodel.MapscoNo) && PermissionChecker.IsPermitted(PermissionList.CustomerPermissions.MapscoNoPermission))
                    {
                        EmailTemplate += "Mapsco Number: " + Cusmodel.MapscoNo + "<br>";
                    }
                    if (item.SelectedColumn == "PlatformId" && Cusmodel.PlatformId != null && Cusmodel.PlatformId != "")
                    {
                        EmailTemplate += "Platform Id: " + Cusmodel.PlatformId + "<br>";
                    }
                    if (item.SelectedColumn == "ContactedPerviously" && !string.IsNullOrEmpty(Cusmodel.ContactedPerviously) && Cusmodel.ContactedPerviously != "-1")
                    {
                        if (Cusmodel.ContactedPerviously == "1")
                        {
                            EmailTemplate += "Contacted Perviously: Yes" + "<br>";

                        }
                        else
                        {
                            EmailTemplate += "Contacted Perviously: No" + "<br>";

                        }
                    }
                    if (item.SelectedColumn == "IsPrimaryPhoneVerified" && Cusmodel.IsPrimaryPhoneVerified == true)
                    {
                        EmailTemplate += "Primary Phone Verified: " + "Yes" + "<br>";

                    }
                    if (item.SelectedColumn == "IsPrimaryPhoneVerified" && Cusmodel.IsPrimaryPhoneVerified == false)
                    {
                        EmailTemplate += "Primary Phone Verified: " + "No" + "<br>";

                    }
                    if (item.SelectedColumn == "IsSecondaryPhoneVerified" && Cusmodel.IsSecondaryPhoneVerified == true)
                    {
                        EmailTemplate += "Secondary Phone Verified: " + "Yes" + "<br>";

                    }
                    if (item.SelectedColumn == "IsSecondaryPhoneVerified" && Cusmodel.IsSecondaryPhoneVerified == false)
                    {
                        EmailTemplate += "Secondary Phone Verified: " + "No" + "<br>";

                    }
                    if (item.SelectedColumn == "IsCellNoVerified" && Cusmodel.IsCellNoVerified == true)
                    {
                        EmailTemplate += "Cell No Verified: " + "Yes" + "<br>";

                    }
                    if (item.SelectedColumn == "IsCellNoVerified" && Cusmodel.IsCellNoVerified == false)
                    {
                        EmailTemplate += "Cell No Verified: " + "No" + "<br>";
                    }

                    //}
                    if (item.SelectedColumn == "PreferredContactMethod" && !string.IsNullOrEmpty(Cusmodel.PreferredContactMethod) && Cusmodel.PreferredContactMethod != "-1")
                    {
                        EmailTemplate += "Preferred Contact Method: " + Cusmodel.PreferredContactMethod + "<br>";
                    }
                    //notification method skip
                    if (item.SelectedColumn == "ContractStartDate" && Cusmodel.CustomerExtended != null && Cusmodel.CustomerExtended.ContractStartDate != null && Cusmodel.CustomerExtended.ContractStartDate != new DateTime())
                    {

                        EmailTemplate += "Contract Start Date: " + Cusmodel.CustomerExtended.ContractStartDate.Value.ToString("MM/dd/yy") + "<br>";


                    }
                    if (item.SelectedColumn == "Repair" && Cusmodel.CustomerExtended != null && !string.IsNullOrEmpty(Cusmodel.CustomerExtended.Repair) && Cusmodel.CustomerExtended.Repair != "-1")
                    {
                        EmailTemplate += "Repair: " + Cusmodel.CustomerExtended.Repair + "<br>";
                    }
                    if (item.SelectedColumn == "MonthlyBatch" && Cusmodel.CustomerExtended != null && Cusmodel.CustomerExtended.MonthlyBatch != null)
                    {

                        EmailTemplate += "Monthly Batch Number: " + Cusmodel.CustomerExtended.MonthlyBatch + "<br>";


                    }
                    if (item.SelectedColumn == "FinanceRep" && !string.IsNullOrEmpty(Cusmodel.FinanceRepValue))
                    {
                        EmailTemplate += "Finance Rep: " + Cusmodel.FinanceRepValue + "<br>";
                    }
                    if (item.SelectedColumn == "AppoinmentSetBy" && !string.IsNullOrEmpty(Cusmodel.AppoinmentSetByValue))
                    {
                        EmailTemplate += "Appoinment Set By: " + Cusmodel.AppoinmentSetByValue + "<br>";
                    }
                    if (item.SelectedColumn == "RepairType" && Cusmodel.CustomerExtended != null && !string.IsNullOrEmpty(Cusmodel.CustomerExtended.RepairType) && Cusmodel.CustomerExtended.RepairType != "-1")
                    {
                        EmailTemplate += "Type Of Repair: " + Cusmodel.CustomerExtended.RepairType + "<br>";
                    }
                    if (item.SelectedColumn == "PetsType" && Cusmodel.CustomerExtended != null && !string.IsNullOrEmpty(Cusmodel.CustomerExtended.PetsType) && Cusmodel.CustomerExtended.PetsType != "-1")
                    {
                        EmailTemplate += "Type Of Pets: " + Cusmodel.CustomerExtended.PetsType + "<br>";
                    }
                    if (item.SelectedColumn == "Pets" && Cusmodel.CustomerExtended != null && !string.IsNullOrEmpty(Cusmodel.CustomerExtended.Pets) && Cusmodel.CustomerExtended.Pets != "-1")
                    {
                        EmailTemplate += "Pets: " + Cusmodel.CustomerExtended.Pets + "<br>";
                    }
                    if (item.SelectedColumn == "BirthDateCoupon" && Cusmodel.CustomerExtended != null && !string.IsNullOrEmpty(Cusmodel.CustomerExtended.BirthDateCoupon))
                    {
                        EmailTemplate += "Birth Date Coupon: " + Cusmodel.CustomerExtended.BirthDateCoupon + "<br>";
                    }
                    if (item.SelectedColumn == "VipClubMember" && Cusmodel.CustomerExtended != null && !string.IsNullOrEmpty(Cusmodel.CustomerExtended.VipClubMember) && Cusmodel.CustomerExtended.VipClubMember != "-1")
                    {
                        EmailTemplate += "Vip Club Member: " + Cusmodel.CustomerExtended.VipClubMember + "<br>";
                    }
                    if (item.SelectedColumn == "IsFinanced" && Cusmodel.CustomerExtended != null && Cusmodel.CustomerExtended.IsFinanced != null)
                    {
                        if (Cusmodel.CustomerExtended.IsFinanced == true)
                        {
                            EmailTemplate += "Is Financed:  Yes" + "<br>";

                        }
                        else
                        {
                            EmailTemplate += "Is Financed:  No" + "<br>";

                        }


                    }
                    if (item.SelectedColumn == "FinanceCompany" && Cusmodel.CustomerExtended != null && !string.IsNullOrEmpty(Cusmodel.CustomerExtended.FinanceCompany) && Cusmodel.CustomerExtended.FinanceCompany != "-1")
                    {
                        EmailTemplate += "Financed Company: " + Cusmodel.CustomerExtended.FinanceCompany + "<br>";
                    }
                    if (item.SelectedColumn == "MonthlyFinanceRate" && Cusmodel.CustomerExtended != null && Cusmodel.CustomerExtended.MonthlyFinanceRate != null)
                    {
                        EmailTemplate += "Monthly Finance Rate: " + HS.Web.UI.Helper.LabelHelper.CurrentTransMakeCurrency.MakeCurrency(null) + HS.Web.UI.Helper.LabelHelper.FormatAmount(Cusmodel.CustomerExtended.MonthlyFinanceRate) + "<br>";
                    }
                    if (item.SelectedColumn == "GrossFundedAmount" && Cusmodel.CustomerExtended != null && Cusmodel.CustomerExtended.GrossFundedAmount != null)
                    {
                        EmailTemplate += "Gross Funded Amount: " + HS.Web.UI.Helper.LabelHelper.CurrentTransMakeCurrency.MakeCurrency(null) + HS.Web.UI.Helper.LabelHelper.FormatAmount(Cusmodel.CustomerExtended.GrossFundedAmount) + "<br>";
                    }
                    if (item.SelectedColumn == "NetFundedAmount" && Cusmodel.CustomerExtended != null && Cusmodel.CustomerExtended.NetFundedAmount != null)
                    {
                        EmailTemplate += "Net Funded Amount: " + HS.Web.UI.Helper.LabelHelper.CurrentTransMakeCurrency.MakeCurrency(null) + HS.Web.UI.Helper.LabelHelper.FormatAmount(Cusmodel.CustomerExtended.NetFundedAmount) + "<br>";
                    }
                    if (item.SelectedColumn == "DiscountFundedAmount" && Cusmodel.CustomerExtended != null && Cusmodel.CustomerExtended.DiscountFundedAmount != null)
                    {
                        EmailTemplate += "Discount Funded Amount: " + HS.Web.UI.Helper.LabelHelper.CurrentTransMakeCurrency.MakeCurrency(null) + HS.Web.UI.Helper.LabelHelper.FormatAmount(Cusmodel.CustomerExtended.DiscountFundedAmount) + "<br>";
                    }
                    if (item.SelectedColumn == "DiscountFundedPercentage" && Cusmodel.CustomerExtended != null && Cusmodel.CustomerExtended.DiscountFundedPercentage != null)
                    {
                        EmailTemplate += "Discount Funded Percentage: " + Cusmodel.CustomerExtended.DiscountFundedPercentage + "<br>";
                    }
                    if (item.SelectedColumn == "CustomerPaymentAmount" && Cusmodel.CustomerExtended != null && Cusmodel.CustomerExtended.CustomerPaymentAmount != null)
                    {
                        EmailTemplate += "Customer Payment Amount: " + HS.Web.UI.Helper.LabelHelper.CurrentTransMakeCurrency.MakeCurrency(null) + HS.Web.UI.Helper.LabelHelper.FormatAmount(Cusmodel.CustomerExtended.CustomerPaymentAmount) + "<br>";
                    }
                    if (item.SelectedColumn == "FinanceRepCommissionRate" && Cusmodel.CustomerExtended != null && Cusmodel.CustomerExtended.FinanceRepCommissionRate != null)
                    {
                        EmailTemplate += "Finance Rep Commission Rate: " + HS.Web.UI.Helper.LabelHelper.CurrentTransMakeCurrency.MakeCurrency(null) + HS.Web.UI.Helper.LabelHelper.FormatAmount(Cusmodel.CustomerExtended.FinanceRepCommissionRate) + "<br>";
                    }
                    if (item.SelectedColumn == "LoanNumber" && Cusmodel.CustomerExtended != null && !string.IsNullOrEmpty(Cusmodel.CustomerExtended.LoanNumber))
                    {
                        EmailTemplate += "Loan Number: " + Cusmodel.CustomerExtended.LoanNumber + "<br>";
                    }
                    if (item.SelectedColumn == "CreditAppNumber" && Cusmodel.CustomerExtended != null && !string.IsNullOrEmpty(Cusmodel.CustomerExtended.CreditAppNumber))
                    {
                        EmailTemplate += "Credit App Number: " + Cusmodel.CustomerExtended.CreditAppNumber + "<br>";
                    }
                    if (item.SelectedColumn == "Term" && Cusmodel.CustomerExtended != null && !string.IsNullOrEmpty(Cusmodel.CustomerExtended.Term) && Cusmodel.CustomerExtended.Term != "-1")
                    {
                        EmailTemplate += "Term: " + Cusmodel.CustomerExtended.Term + "<br>";
                    }
                    if (item.SelectedColumn == "APR" && Cusmodel.CustomerExtended != null && !string.IsNullOrEmpty(Cusmodel.CustomerExtended.APR))
                    {
                        EmailTemplate += "APR: " + Cusmodel.CustomerExtended.APR + "<br>";
                    }
                    if (item.SelectedColumn == "MaxCreditLimit" && Cusmodel.CustomerExtended != null && Cusmodel.CustomerExtended.MaxCreditLimit != null)
                    {
                        EmailTemplate += "Max Credit Limit: " + HS.Web.UI.Helper.LabelHelper.CurrentTransMakeCurrency.MakeCurrency(null) + HS.Web.UI.Helper.LabelHelper.FormatAmount(Cusmodel.CustomerExtended.MaxCreditLimit) + "<br>";
                    }
                    if (item.SelectedColumn == "ApprovalDate" && Cusmodel.CustomerExtended != null && Cusmodel.CustomerExtended.ApprovalDate != null && Cusmodel.CustomerExtended.ApprovalDate.HasValue && Cusmodel.CustomerExtended.ApprovalDate.Value.ToString("MM/dd/yy") != "01/01/00")
                    {

                        EmailTemplate += "Approval Date: " + Cusmodel.CustomerExtended.ApprovalDate.Value.ToString("MM/dd/yy") + "<br>";


                    }
                    if (item.SelectedColumn.ToLower() == "isactive" && Cusmodel.IsActive == false && Cusmodel.CustomerCancel != null && Cusmodel.CustomerCancel.CancelDatet.HasValue && Cusmodel.CustomerCancel.CancelDatet != new DateTime())
                    {

                        EmailTemplate += "Cancellation Date: " + HS.Framework.DateTimeExtension.UTCToClientTime(Cusmodel.CustomerCancel.CancelDatet.Value).ToString("MM/dd/yy") + " at " + HS.Framework.DateTimeExtension.UTCToClientTime(Cusmodel.CustomerCancel.CancelDatet.Value).ToString("hh:mm tt") + "<br>";

                        EmailTemplate += "Cancelled By: " + Cusmodel.CustomerCancel.EmpName + "<br>";

                        EmailTemplate += "Cancellation Reason: " + Cusmodel.CustomerCancel.CancelReason + "<br>";


                    }
                }
            }
            else
            {
                foreach (var item in LeadUiSetting)
                {
                    if (item.SelectedColumn == "Id" && Cusmodel.Id > 0)
                    {
                        EmailTemplate += "Lead Id: " + Cusmodel.Id + "<br>";

                    }
                    if (item.SelectedColumn == "Title" && !string.IsNullOrEmpty(Cusmodel.Title))
                    {
                        EmailTemplate += "Title: " + Cusmodel.Title + "<br>";
                    }

                    if (item.SelectedColumn == "FirstName" && !string.IsNullOrEmpty(Cusmodel.FirstName))
                    {
                        EmailTemplate += "Name: " + Cusmodel.FirstName + " " + Cusmodel.LastName + "<br>";
                    }
                    if (item.SelectedColumn == "MiddleName" && !string.IsNullOrEmpty(Cusmodel.MiddleName))
                    {
                        EmailTemplate += "Middle Name: " + Cusmodel.MiddleName + "<br>";
                    }
                    if (item.SelectedColumn == "Type" && !string.IsNullOrEmpty(model.Customer.Type) && model.Customer.Type != "-1")
                    {
                        EmailTemplate += "Type: " + model.Customer.Type + "<br>";
                    }
                    if (item.SelectedColumn == "Address" && !string.IsNullOrEmpty(Cusmodel.Street))
                    {
                        EmailTemplate += "Address: " + model.CustomerAddress + "<br>";
                    }

                    if (item.SelectedColumn == "CustomerAccountType" && !string.IsNullOrEmpty(Cusmodel.CustomerAccountType))
                    {
                        EmailTemplate += "Account Type: " + Cusmodel.CustomerAccountType + "<br>";
                    }
                    if (item.SelectedColumn == "BusinessName" && !string.IsNullOrEmpty(Cusmodel.BusinessName))
                    {
                        EmailTemplate += "Business Name: " + Cusmodel.BusinessName + "<br>";
                    }
                    if (item.SelectedColumn == "DBA" && !string.IsNullOrEmpty(Cusmodel.DBA))
                    {
                        EmailTemplate += "DBA: " + Cusmodel.DBA + "<br>";
                    }
                    if (item.SelectedColumn == "CustomerNo" && !string.IsNullOrEmpty(Cusmodel.CustomerNo))
                    {
                        EmailTemplate += "Customer No: " + Cusmodel.CustomerNo + "<br>";
                    }
                    if (item.SelectedColumn == "SecondCustomerNo" && !string.IsNullOrEmpty(Cusmodel.SecondCustomerNo))
                    {
                        EmailTemplate += "Second Customer No: " + Cusmodel.SecondCustomerNo + "<br>";
                    }
                    if (item.SelectedColumn == "AdditionalCustomerNo" && !string.IsNullOrEmpty(Cusmodel.AdditionalCustomerNo))
                    {
                        EmailTemplate += "Additional Customer No: " + Cusmodel.AdditionalCustomerNo + "<br>";
                    }
                    if (item.SelectedColumn == "InstalledStatus" && !string.IsNullOrEmpty(Cusmodel.InstalledStatus))
                    {
                        EmailTemplate += "Installed Status: " + Cusmodel.InstalledStatus + "<br>";
                    }
                    if (item.SelectedColumn == "DateofBirth" && Cusmodel.DateofBirth != null && Cusmodel.DateofBirth != new DateTime())
                    {
                        EmailTemplate += "Date of Birth: " + Cusmodel.DateofBirth.Value.ToString("MM/dd/yy") + "<br>";
                    }
                    if (item.SelectedColumn == "EmailAddress" && !string.IsNullOrEmpty(Cusmodel.EmailAddress))
                    {
                        EmailTemplate += "Email: " + Cusmodel.EmailAddress + "<br>";
                    }
                    if (item.SelectedColumn == "AccessGivenTo" && !string.IsNullOrEmpty(Cusmodel.AccessGivenToVal))
                    {
                        EmailTemplate += "Access Assign To: " + Cusmodel.AccessGivenToVal + "<br>";
                    }
                    if (item.SelectedColumn == "PrimaryPhone" && !string.IsNullOrEmpty(Cusmodel.PrimaryPhone))
                    {
                        EmailTemplate += "Site Phone: " + Cusmodel.PrimaryPhone + "<br>";
                    }
                    if (item.SelectedColumn == "SecondaryPhone" && !string.IsNullOrEmpty(Cusmodel.SecondaryPhone))
                    {
                        EmailTemplate += "Secondary Phone: " + Cusmodel.SecondaryPhone + "<br>";
                    }
                    if (item.SelectedColumn == "CellNo" && !string.IsNullOrEmpty(Cusmodel.CellNo))
                    {
                        EmailTemplate += "Cell Phone: " + Cusmodel.CellNo + "<br>";
                    }
                    if (item.SelectedColumn == "LeadSource" && !string.IsNullOrEmpty(Cusmodel.LeadSource) && (Cusmodel.LeadSource != "-1" && Cusmodel.LeadSource != "" && Cusmodel.LeadSource != "Select One"))
                    {
                        EmailTemplate += "Lead Source: " + Cusmodel.LeadSourceVal + "<br>";
                    }
                    if (item.SelectedColumn == "LeadSourceType" && !string.IsNullOrEmpty(Cusmodel.LeadSourceType) && Cusmodel.LeadSourceType != "-1" && PermissionChecker.IsPermitted(PermissionList.LeadPermissions.LeadSourceType))
                    {
                        EmailTemplate += "Lead Source Type: " + Cusmodel.LeadSourceType + "<br>";
                    }

                    if (item.SelectedColumn == "CustomerFunded" && Cusmodel.CustomerFunded == true)
                    {
                        EmailTemplate += "Customer Funded: " + "Yes" + "<br>";

                    }
                    if (item.SelectedColumn == "CustomerFunded" && Cusmodel.CustomerFunded == false)
                    {
                        EmailTemplate += "Customer Funded: " + "No" + "<br>";

                    }
                    if (item.SelectedColumn == "BusinessAccountType" && !string.IsNullOrEmpty(Cusmodel.BusinessAccountType) && Cusmodel.BusinessAccountType != "-1")
                    {
                        EmailTemplate += "Business Account Type: " + Cusmodel.BusinessAccountType + "<br>";
                    }

                    if (item.SelectedColumn == "InstallDate" && Cusmodel.InstallDate != null && Cusmodel.InstallDate != new DateTime())
                    {
                        EmailTemplate += "Install Date: " + Cusmodel.InstallDate.Value.ToString("MM/dd/yy") + "<br>";
                    }
                    if (item.SelectedColumn == "IsActive" && Cusmodel.IsActive == true)
                    {
                        EmailTemplate += "Active Status: " + "Active" + "<br>";

                    }
                    if (item.SelectedColumn == "IsActive" && Cusmodel.IsActive == false)
                    {
                        EmailTemplate += "Active Status: " + "InActive" + "<br>";

                    }
                    if (item.SelectedColumn == "BranchId" && Cusmodel.CompanyBranch != null)
                    {
                        EmailTemplate += "Branch: " + Cusmodel.CompanyBranch.Name + "<br>";
                    }
                    if (item.SelectedColumn == "Route" && Cusmodel.RouteName != null)
                    {
                        EmailTemplate += "Route: " + Cusmodel.RouteName + "<br>";
                    }
                    if (item.SelectedColumn == "AnnualRevenue" && Cusmodel.AnnualRevenue != null)
                    {
                        EmailTemplate += "Annual Revenue: " + Cusmodel.AnnualRevenue + "<br>";
                    }
                    if (item.SelectedColumn == "AcquiredFrom" && !string.IsNullOrEmpty(Cusmodel.AcquiredFrom))
                    {
                        EmailTemplate += "Acquired From: " + Cusmodel.AcquiredFrom + "<br>";
                    }

                    if (item.SelectedColumn == "FollowUpDate" && Cusmodel.FollowUpDate != null && Cusmodel.FollowUpDate != new DateTime())
                    {
                        EmailTemplate += "Follow Up Date: " + Cusmodel.FollowUpDate.Value.ToString("MM/dd/yy") + "<br>";
                    }
                    if (item.SelectedColumn == "BuyoutAmountByADS" && Cusmodel.BuyoutAmountByADS != null)
                    {
                        EmailTemplate += "Buyout Amount By ADS: " + Cusmodel.BuyoutAmountByADS + "<br>";
                    }
                    if (item.SelectedColumn == "BuyoutAmountBySalesRep" && Cusmodel.BuyoutAmountBySalesRep != null)
                    {
                        EmailTemplate += "Buyout Amount By Sales Rep: " + Cusmodel.BuyoutAmountBySalesRep + "<br>";
                    }
                    if (item.SelectedColumn == "FinancedTerm" && Cusmodel.FinancedTerm != null)
                    {
                        EmailTemplate += "Financed Term: " + Cusmodel.FinancedTerm + "<br>";
                    }
                    if (item.SelectedColumn == "FinancedAmount" && Cusmodel.FinancedAmount != null)
                    {
                        EmailTemplate += "Financed Amount: " + Cusmodel.FinancedAmount + "<br>";
                    }
                    if (item.SelectedColumn == "Levels" && Cusmodel.Levels != null)
                    {
                        EmailTemplate += "Levels: " + Cusmodel.Levels + "<br>";
                    }
                    if (item.SelectedColumn == "SoldAmount" && Cusmodel.SoldAmount != null)
                    {
                        EmailTemplate += "Sold Amount: " + Cusmodel.SoldAmount + "<br>";
                    }
                    if (item.SelectedColumn == "Website" && !string.IsNullOrEmpty(Cusmodel.Website))
                    {
                        EmailTemplate += "Website: " + Cusmodel.Website + "<br>";
                    }
                    if (item.SelectedColumn == "BestTimeToCall" && !string.IsNullOrEmpty(Cusmodel.BestTimeToCall) && Cusmodel.BestTimeToCall != "-1")
                    {
                        EmailTemplate += "Best Time To Call: " + Cusmodel.BestTimeToCall + "<br>";
                    }
                    if (item.SelectedColumn == "CSProvider" && !string.IsNullOrEmpty(Cusmodel.CSProvider) && Cusmodel.CSProvider != "-1")
                    {
                        EmailTemplate += "CS Provider: " + Cusmodel.CSProvider + "<br>";
                    }
                    if (item.SelectedColumn == "Market" && !string.IsNullOrEmpty(Cusmodel.Market) && Cusmodel.Market != "-1")
                    {
                        EmailTemplate += "Market: " + Cusmodel.Market + "<br>";
                    }
                    if (item.SelectedColumn == "Passengers" && Cusmodel.Passengers != null)
                    {
                        EmailTemplate += "Passengers: " + Cusmodel.Passengers + "<br>";
                    }
                    if (item.SelectedColumn == "Budget" && Cusmodel.Budget != null)
                    {
                        EmailTemplate += "Budget: " + HS.Web.UI.Helper.LabelHelper.CurrentTransMakeCurrency.MakeCurrency(null) + HS.Web.UI.Helper.LabelHelper.FormatAmount(Cusmodel.Budget.Value) + "<br>";
                    }
                    if (item.SelectedColumn == "Ownership" && !string.IsNullOrEmpty(Cusmodel.Ownership) && Cusmodel.Ownership != "-1")
                    {
                        EmailTemplate += "Ownership: " + Cusmodel.Ownership + "<br>";
                    }

                    if (item.SelectedColumn == "SSN" && !string.IsNullOrEmpty(Cusmodel.SSN))
                    {
                        var SSN = "";
                        if (!string.IsNullOrEmpty(Cusmodel.SSN) && Cusmodel.SSN.Length > 4)
                        {
                            int n;
                            bool isNumeric = int.TryParse(Cusmodel.SSN, out n);
                            if (isNumeric)
                            {
                                var FormateSSN = Cusmodel.SSN.Substring(Cusmodel.SSN.Length - 4);
                                SSN = String.Format("{0:XXX-XX-0000}", Convert.ToInt32(FormateSSN));
                            }
                        }
                        if (PermissionChecker.IsPermitted(PermissionList.CustomerPermissions.ShowSSNFullNumber))
                        {
                            EmailTemplate += "SSN: " + Cusmodel.SSN + "<br>";

                        }
                        else
                        {
                            EmailTemplate += "SSN: " + SSN + "<br>";

                        }
                    }
                    if (item.SelectedColumn == "PurchasePrice" && Cusmodel.PurchasePrice != null)
                    {
                        EmailTemplate += "Purchase Price: " + HS.Web.UI.Helper.LabelHelper.CurrentTransMakeCurrency.MakeCurrency(null) + HS.Web.UI.Helper.LabelHelper.FormatAmount(Cusmodel.PurchasePrice.Value) + "<br>";
                    }
                    if (item.SelectedColumn == "ContractValue" && !string.IsNullOrEmpty(Cusmodel.ContractValue))
                    {
                        EmailTemplate += "Contract Value: " + Cusmodel.ContractValue + "<br>";
                    }
                    if (item.SelectedColumn == "BrinksFundingStatus" && Cusmodel.CustomerExtended != null && !string.IsNullOrEmpty(Cusmodel.CustomerExtended.BrinksFundingStatus))
                    {
                        EmailTemplate += "Brinks Funding Status: " + Cusmodel.CustomerExtended.BrinksFundingStatus + "<br>";
                    }
                    if (item.SelectedColumn == "FinanceFundingStatus" && Cusmodel.CustomerExtended != null && !string.IsNullOrEmpty(Cusmodel.CustomerExtended.FinanceFundingStatus))
                    {
                        EmailTemplate += "Finance Funding Status: " + Cusmodel.CustomerExtended.FinanceFundingStatus + "<br>";
                    }
                    if (item.SelectedColumn == "CreatedBy" && !string.IsNullOrEmpty(objemp.FirstName) && !string.IsNullOrEmpty(objemp.LastName))
                    {
                        EmailTemplate += "Created By: " + ViewBag.SalesGuy + "<br>";
                    }

                    if (item.SelectedColumn == "HomeOwner" && !string.IsNullOrEmpty(Cusmodel.HomeOwner))
                    {
                        EmailTemplate += "Home Owner: " + Cusmodel.HomeOwner + "<br>";
                    }
                    if (item.SelectedColumn == "CreatedDate" && Cusmodel.CreatedDate != null && Cusmodel.CreatedDate != new DateTime())
                    {
                        EmailTemplate += "Created Date: " + Cusmodel.CreatedDate.UTCToClientTime().ToString("MM/dd/yy hh:mm tt") + "<br>";
                    }
                    if (item.SelectedColumn == "Fax" && !string.IsNullOrEmpty(Cusmodel.Fax))
                    {
                        EmailTemplate += "Fax: " + Cusmodel.Fax + "<br>";
                    }
                    if (item.SelectedColumn == "RenewalTerm" && Cusmodel.RenewalTerm > 0)
                    {
                        EmailTemplate += "Renewal Term: " + Cusmodel.RenewalTerm + "<br>";
                    }
                    if (item.SelectedColumn == "CallingTime" && !string.IsNullOrEmpty(Cusmodel.CallingTime) && Cusmodel.CallingTime != "-1")
                    {
                        EmailTemplate += "Calling Time: " + Cusmodel.CallingTime + "<br>";
                    }
                    if (item.SelectedColumn == "AccountNo" && !string.IsNullOrEmpty(Cusmodel.AccountNo))
                    {
                        EmailTemplate += "Account No: " + Cusmodel.AccountNo + "<br>";
                    }
                    if (item.SelectedColumn == "IsAlarmCom" && Cusmodel.IsAlarmCom == true)
                    {
                        EmailTemplate += "Alarming: " + "Yes" + "<br>";

                    }
                    if (item.SelectedColumn == "IsAlarmCom" && Cusmodel.IsAlarmCom == false)
                    {
                        EmailTemplate += "Alarming: " + "No" + "<br>";

                    }
                    if (item.SelectedColumn == "CreditScore" && !string.IsNullOrEmpty(Cusmodel.CreditScore) && Cusmodel.CreditScore != "-1")
                    {
                        EmailTemplate += "Credit Grade: " + Cusmodel.CreditGrade + "<br>";
                    }
                    if (item.SelectedColumn == "CreditScoreValue" && Cusmodel.CreditScoreValue > 0)
                    {
                        if (PermissionChecker.IsPermitted(PermissionList.CustomerPermissions.CustomerCreditScore))
                        {
                            EmailTemplate += "Credit Score: " + Cusmodel.CreditScoreValue + "<br>";

                        }
                        else
                        {
                            EmailTemplate += "Credit Score: ****" + "<br>";

                        }
                    }
                    if (item.SelectedColumn == "SalesLocation" && !string.IsNullOrEmpty(Cusmodel.SalesLocation) && Cusmodel.SalesLocation != "-1")
                    {
                        EmailTemplate += "Sales Location: " + Cusmodel.SalesLocation + "<br>";
                    }
                    if (item.SelectedColumn == "FundingCompany" && !string.IsNullOrEmpty(Cusmodel.FundingCompany) && Cusmodel.FundingCompany != "-1")
                    {
                        EmailTemplate += "Funding Company: " + Cusmodel.FundingCompany + "<br>";
                    }
                    if (item.SelectedColumn == "CellularBackup" && Cusmodel.CellularBackup == true)
                    {
                        EmailTemplate += "Cellular Backup: " + "Yes" + "<br>";

                    }
                    if (item.SelectedColumn == "CellularBackup" && Cusmodel.CellularBackup == false)
                    {
                        EmailTemplate += "Cellular Backup: " + "No" + "<br>";

                    }
                    if (item.SelectedColumn == "Lead Status" && !string.IsNullOrEmpty(Cusmodel.Status) && Cusmodel.Status != "-1")
                    {
                        EmailTemplate += "Lead Status: " + Cusmodel.StatusVal + "<br>";
                    }
                    if (item.SelectedColumn == "CustomerStatus" && !string.IsNullOrEmpty(Cusmodel.CustomerStatusVal) && Cusmodel.CustomerStatusVal != "-1")
                    {
                        EmailTemplate += "Customer Status: " + Cusmodel.CustomerStatusVal + "<br>";
                    }
                    if (item.SelectedColumn == "Maintenance" && Cusmodel.Maintenance == true)
                    {
                        EmailTemplate += "Maintenance: " + "Yes" + "<br>";

                    }
                    if (item.SelectedColumn == "Maintenance" && Cusmodel.Maintenance == false)
                    {
                        EmailTemplate += "Maintenance: " + "No" + "<br>";

                    }
                    if (item.SelectedColumn == "SalesDate" && Cusmodel.SalesDate != null && Cusmodel.SalesDate != new DateTime())
                    {
                        if (Cusmodel.SalesDate.Value.ToString("MM/dd/yy") != "01/01/00")
                        {
                            EmailTemplate += "Sales Date: " + Cusmodel.SalesDate.Value.ToString("MM/dd/yy") + "<br>";

                        }
                    }
                    if (item.SelectedColumn == "CutInDate" && Cusmodel.CutInDate != null && Cusmodel.CutInDate != new DateTime())
                    {

                        EmailTemplate += "Cut In Date: " + Cusmodel.CutInDate.Value.ToString("MM/dd/yy") + "<br>";


                    }
                    if (item.SelectedColumn == "Installer" && !string.IsNullOrEmpty(Cusmodel.InstallerName))
                    {
                        EmailTemplate += "Installer: " + Cusmodel.InstallerName + "<br>";
                    }
                    if (item.SelectedColumn == "SoldBy" && !string.IsNullOrEmpty(Cusmodel.PersonSales))
                    {
                        EmailTemplate += "Sales Person: " + Cusmodel.PersonSales + "<br>";
                    }
                    if (item.SelectedColumn == "SoldBy2" && !string.IsNullOrEmpty(Cusmodel.SoldBy2Text))
                    {
                        EmailTemplate += "Sales Person 2: " + Cusmodel.SoldBy2Text + "<br>";
                    }
                    if (item.SelectedColumn == "SoldBy3" && !string.IsNullOrEmpty(Cusmodel.SoldBy3Text))
                    {
                        EmailTemplate += "Sales Person 3: " + Cusmodel.SoldBy3Text + "<br>";
                    }
                    if (item.SelectedColumn == "InspectionCompany" && !string.IsNullOrEmpty(Cusmodel.InspectionCompany))
                    {
                        EmailTemplate += "Inspection Company: " + Cusmodel.InspectionCompany + "<br>";
                    }
                    if (item.SelectedColumn == "FundingDate" && Cusmodel.CustomerFundedDate != null && Cusmodel.CustomerFundedDate != new DateTime())
                    {

                        EmailTemplate += "Funding Date: " + Cusmodel.CustomerFundedDate.Value.ToString("MM/dd/yy") + "<br>";


                    }
                    if (item.SelectedColumn == "ReminderDate" && Cusmodel.ReminderDate != null && Cusmodel.ReminderDate != new DateTime())
                    {

                        EmailTemplate += "Reminder Date: " + Cusmodel.ReminderDate.Value.ToString("MM/dd/yy") + "<br>";


                    }
                    if (item.SelectedColumn == "DoNotCall" && Cusmodel.DoNotCall != null && Cusmodel.DoNotCall != new DateTime())
                    {

                        EmailTemplate += "Do Not Call: " + Cusmodel.DoNotCall.Value.ToString("MM/dd/yy") + "<br>";


                    }
                    if (item.SelectedColumn == "ServiceDate" && Cusmodel.ServiceDate != null && Cusmodel.ServiceDate != new DateTime())
                    {

                        EmailTemplate += "Service Date: " + Cusmodel.ServiceDate.Value.ToString("MM/dd/yy") + "<br>";


                    }
                    if (item.SelectedColumn == "Area" && !string.IsNullOrEmpty(Cusmodel.Area))
                    {
                        EmailTemplate += "Area: " + Cusmodel.Area + "<br>";
                    }
                    if (item.SelectedColumn == "Latlng" && !string.IsNullOrEmpty(Cusmodel.Latlng))
                    {
                        EmailTemplate += "Latlng: " + Cusmodel.Latlng + "<br>";
                    }
                    if (item.SelectedColumn == "IsTechCallPassed" && Cusmodel.IsTechCallPassed == true)
                    {
                        EmailTemplate += "Tech Call: " + "Yes" + "<br>";

                    }
                    if (item.SelectedColumn == "IsTechCallPassed" && Cusmodel.IsTechCallPassed == false)
                    {
                        EmailTemplate += "Tech Call: " + "No" + "<br>";

                    }
                    if (item.SelectedColumn == "IsDirect" && Cusmodel.IsDirect == true)
                    {
                        EmailTemplate += "Direct: " + "Yes" + "<br>";

                    }
                    if (item.SelectedColumn == "IsDirect" && Cusmodel.IsDirect == false)
                    {
                        EmailTemplate += "Direct: " + "No" + "<br>";

                    }
                    if (item.SelectedColumn == "Passcode" && !string.IsNullOrEmpty(Cusmodel.Passcode))
                    {
                        EmailTemplate += "Passcode: " + Cusmodel.Passcode + "<br>";
                    }
                    if (item.SelectedColumn == "ActivationFee" && Cusmodel.ActivationFee != null)
                    {
                        EmailTemplate += "Activation Fee: " + Cusmodel.ActivationFee + "<br>";
                    }
                    if (item.SelectedColumn == "PackageActivationFee" && Cusmodel.ActivationFee != null && PermissionChecker.IsPermitted(PermissionList.CustomerPermissions.CustomerPackageActivationFee))
                    {
                        EmailTemplate += "Package Customer Activation Fee: " + HS.Web.UI.Helper.LabelHelper.CurrentTransMakeCurrency.MakeCurrency(null) + HS.Web.UI.Helper.LabelHelper.FormatAmount(Cusmodel.ActivationFee.Value) + "<br>";
                    }
                    if (item.SelectedColumn == "FirstBilling" && Cusmodel.FirstBilling != null && Cusmodel.FirstBilling != new DateTime())
                    {

                        EmailTemplate += "First Billing: " + Cusmodel.FirstBilling.Value.ToString("MM/dd/yy") + "<br>";


                    }
                    if (item.SelectedColumn == "LastGeneratedInvoice" && Cusmodel.LastGeneratedInvoice != null && Cusmodel.LastGeneratedInvoice != new DateTime())
                    {

                        EmailTemplate += "Last Generated Invoice: " + Cusmodel.LastGeneratedInvoice.Value.ToString("MM/dd/yy") + "<br>";


                    }
                    if (item.SelectedColumn == "Singature" && !string.IsNullOrEmpty(Cusmodel.Singature))
                    {
                        EmailTemplate += "Singature: " + Cusmodel.Singature + "<br>";
                    }
                    if (item.SelectedColumn == "CrossStreet" && !string.IsNullOrEmpty(Cusmodel.CrossStreet))
                    {
                        EmailTemplate += "CrossStreet: " + Cusmodel.CrossStreet + "<br>";
                    }
                    if (item.SelectedColumn == "IsAgreement" && Cusmodel.IsAgreement == true)
                    {
                        EmailTemplate += "Agreement: " + "Yes" + "<br>";

                    }
                    if (item.SelectedColumn == "IsAgreement" && Cusmodel.IsAgreement == false)
                    {
                        EmailTemplate += "Agreement: " + "No" + "<br>";

                    }
                    if (item.SelectedColumn == "IsFireAccount" && Cusmodel.IsFireAccount == true)
                    {
                        EmailTemplate += "Fire Account: " + "Yes" + "<br>";

                    }
                    if (item.SelectedColumn == "IsFireAccount" && Cusmodel.IsFireAccount == false)
                    {
                        EmailTemplate += "Fire Account: " + "No" + "<br>";

                    }
                    if (item.SelectedColumn == "PhoneType" && !string.IsNullOrEmpty(Cusmodel.PhoneType) && Cusmodel.PhoneType != "-1")
                    {
                        EmailTemplate += "Phone Type: " + Cusmodel.PhoneType + "<br>";
                    }
                    if (item.SelectedColumn == "Carrier" && !string.IsNullOrEmpty(Cusmodel.Carrier) && Cusmodel.Carrier != "-1")
                    {
                        EmailTemplate += "Carrier: " + Cusmodel.Carrier + "<br>";
                    }
                    if (item.SelectedColumn == "ReferringCustomer" && Cusmodel.ReferringCustomer != new Guid())
                    {
                        EmailTemplate += "Referring Customer: " + Cusmodel.RefCustomer + "<br>";
                    }
                    if (item.SelectedColumn == "EsistingPanel" && !string.IsNullOrEmpty(Cusmodel.EsistingPanel))
                    {
                        EmailTemplate += "Esisting Panel: " + Cusmodel.EsistingPanel + "<br>";
                    }
                    if (item.SelectedColumn == "ChildOf" && !string.IsNullOrEmpty(Cusmodel.chCustomer))
                    {
                        EmailTemplate += "Child Of: " + Cusmodel.chCustomer + "<br>";
                    }
                    if (item.SelectedColumn == "EmailVerified" && Cusmodel.EmailVerified == true)
                    {
                        EmailTemplate += "Email Verified: " + "Yes" + "<br>";

                    }
                    if (item.SelectedColumn == "EmailVerified" && Cusmodel.EmailVerified == false)
                    {
                        EmailTemplate += "Email Verified: " + "No" + "<br>";

                    }
                    if (item.SelectedColumn == "HomeVerified" && Cusmodel.HomeVerified == true)
                    {
                        EmailTemplate += "Home Verified: " + "Yes" + "<br>";

                    }
                    if (item.SelectedColumn == "HomeVerified" && Cusmodel.HomeVerified == false)
                    {
                        EmailTemplate += "Home Verified: " + "No" + "<br>";

                    }
                    if (item.SelectedColumn == "County" && !string.IsNullOrEmpty(Cusmodel.County))
                    {
                        EmailTemplate += "County: " + Cusmodel.County + "<br>";
                    }
                    if (item.SelectedColumn == "EstCloseDate" && Cusmodel.EstCloseDate != null && Cusmodel.EstCloseDate != new DateTime())
                    {

                        EmailTemplate += "Est Close Date: " + Cusmodel.EstCloseDate.Value.ToString("MM/dd/yy") + "<br>";


                    }
                    if (item.SelectedColumn == "DuplicateCustomer" && Cusmodel.DuplicateCustomer != null && Cusmodel.DuplicateCustomer != Guid.Empty && Cusmodel.DuplicateCustomerId != null)
                    {
                        EmailTemplate += "Duplicate Customer: " + Cusmodel.DuplicateCustomerName + "<br>";
                    }
                    if (item.SelectedColumn == "ProjectWalkDate" && Cusmodel.ProjectWalkDate != null && Cusmodel.ProjectWalkDate != new DateTime())
                    {

                        EmailTemplate += "Project Walk Date: " + Cusmodel.ProjectWalkDate.Value.ToString("MM/dd/yy") + "<br>";


                    }
                    if (item.SelectedColumn == "MovingDate" && Cusmodel.MovingDate != null && Cusmodel.MovingDate != new DateTime())
                    {

                        EmailTemplate += "Moving Date: " + Cusmodel.MovingDate.Value.ToString("MM/dd/yy") + "<br>";


                    }

                    if (item.SelectedColumn == "AgreementEmail" && !string.IsNullOrEmpty(Cusmodel.AgreementEmail))
                    {
                        EmailTemplate += "Agreement Email: " + Cusmodel.AgreementEmail + "<br>";
                    }
                    if (item.SelectedColumn == "AgreementPhoneNo" && !string.IsNullOrEmpty(Cusmodel.AgreementPhoneNo))
                    {
                        EmailTemplate += "Agreement Phone No: " + Cusmodel.AgreementPhoneNo + "<br>";
                    }
                    if (item.SelectedColumn == "Tax Exemption" && Cusmodel.TaxExemptionVal != null && Cusmodel.TaxExemptionVal != "" && Cusmodel.TaxExemptionVal != "Select One")
                    {
                        EmailTemplate += "Tax Exemption: " + Cusmodel.TaxExemptionVal + "<br>";
                    }
                    if (item.SelectedColumn == "Appointment Set" && Cusmodel.AppointmentSetVal != null && Cusmodel.AppointmentSetVal != "" && Cusmodel.AppointmentSetVal != "Select One")
                    {
                        EmailTemplate += "Appointment Set: " + Cusmodel.AppointmentSetVal + "<br>";
                    }
                    if (item.SelectedColumn == "MapscoNo" && !string.IsNullOrEmpty(Cusmodel.MapscoNo) && PermissionChecker.IsPermitted(PermissionList.CustomerPermissions.MapscoNoPermission))
                    {
                        EmailTemplate += "Mapsco Number: " + Cusmodel.MapscoNo + "<br>";
                    }
                    if (item.SelectedColumn == "PlatformId" && Cusmodel.PlatformId != null && Cusmodel.PlatformId != "")
                    {
                        EmailTemplate += "Platform Id: " + Cusmodel.PlatformId + "<br>";
                    }
                    if (item.SelectedColumn == "ContactedPerviously" && !string.IsNullOrEmpty(Cusmodel.ContactedPerviously) && Cusmodel.ContactedPerviously != "-1")
                    {
                        if (Cusmodel.ContactedPerviously == "1")
                        {
                            EmailTemplate += "Contacted Perviously: Yes" + "<br>";

                        }
                        else
                        {
                            EmailTemplate += "Contacted Perviously: No" + "<br>";

                        }
                    }
                    if (item.SelectedColumn == "IsPrimaryPhoneVerified" && Cusmodel.IsPrimaryPhoneVerified == true)
                    {
                        EmailTemplate += "Primary Phone Verified: " + "Yes" + "<br>";

                    }
                    if (item.SelectedColumn == "IsPrimaryPhoneVerified" && Cusmodel.IsPrimaryPhoneVerified == false)
                    {
                        EmailTemplate += "Primary Phone Verified: " + "No" + "<br>";

                    }
                    if (item.SelectedColumn == "IsSecondaryPhoneVerified" && Cusmodel.IsSecondaryPhoneVerified == true)
                    {
                        EmailTemplate += "Secondary Phone Verified: " + "Yes" + "<br>";

                    }
                    if (item.SelectedColumn == "IsSecondaryPhoneVerified" && Cusmodel.IsSecondaryPhoneVerified == false)
                    {
                        EmailTemplate += "Secondary Phone Verified: " + "No" + "<br>";

                    }
                    if (item.SelectedColumn == "IsCellNoVerified" && Cusmodel.IsCellNoVerified == true)
                    {
                        EmailTemplate += "Cell No Verified: " + "Yes" + "<br>";

                    }
                    if (item.SelectedColumn == "IsCellNoVerified" && Cusmodel.IsCellNoVerified == false)
                    {
                        EmailTemplate += "Cell No Verified: " + "No" + "<br>";
                    }

                    //}
                    if (item.SelectedColumn == "PreferredContactMethod" && !string.IsNullOrEmpty(Cusmodel.PreferredContactMethod) && Cusmodel.PreferredContactMethod != "-1")
                    {
                        EmailTemplate += "Preferred Contact Method: " + Cusmodel.PreferredContactMethod + "<br>";
                    }
                    //notification method skip
                    if (item.SelectedColumn == "ContractStartDate" && Cusmodel.CustomerExtended != null && Cusmodel.CustomerExtended.ContractStartDate != null && Cusmodel.CustomerExtended.ContractStartDate != new DateTime())
                    {

                        EmailTemplate += "Contract Start Date: " + Cusmodel.CustomerExtended.ContractStartDate.Value.ToString("MM/dd/yy") + "<br>";


                    }
                    if (item.SelectedColumn == "Repair" && Cusmodel.CustomerExtended != null && !string.IsNullOrEmpty(Cusmodel.CustomerExtended.Repair) && Cusmodel.CustomerExtended.Repair != "-1")
                    {
                        EmailTemplate += "Repair: " + Cusmodel.CustomerExtended.Repair + "<br>";
                    }
                    if (item.SelectedColumn == "MonthlyBatch" && Cusmodel.CustomerExtended != null && Cusmodel.CustomerExtended.MonthlyBatch != null)
                    {

                        EmailTemplate += "Monthly Batch Number: " + Cusmodel.CustomerExtended.MonthlyBatch + "<br>";


                    }
                    if (item.SelectedColumn == "FinanceRep" && !string.IsNullOrEmpty(Cusmodel.FinanceRepValue))
                    {
                        EmailTemplate += "Finance Rep: " + Cusmodel.FinanceRepValue + "<br>";
                    }
                    if (item.SelectedColumn == "AppoinmentSetBy" && !string.IsNullOrEmpty(Cusmodel.AppoinmentSetByValue))
                    {
                        EmailTemplate += "Appoinment Set By: " + Cusmodel.AppoinmentSetByValue + "<br>";
                    }
                    if (item.SelectedColumn == "RepairType" && Cusmodel.CustomerExtended != null && !string.IsNullOrEmpty(Cusmodel.CustomerExtended.RepairType) && Cusmodel.CustomerExtended.RepairType != "-1")
                    {
                        EmailTemplate += "Type Of Repair: " + Cusmodel.CustomerExtended.RepairType + "<br>";
                    }
                    if (item.SelectedColumn == "PetsType" && Cusmodel.CustomerExtended != null && !string.IsNullOrEmpty(Cusmodel.CustomerExtended.PetsType) && Cusmodel.CustomerExtended.PetsType != "-1")
                    {
                        EmailTemplate += "Type Of Pets: " + Cusmodel.CustomerExtended.PetsType + "<br>";
                    }
                    if (item.SelectedColumn == "Pets" && Cusmodel.CustomerExtended != null && !string.IsNullOrEmpty(Cusmodel.CustomerExtended.Pets) && Cusmodel.CustomerExtended.Pets != "-1")
                    {
                        EmailTemplate += "Pets: " + Cusmodel.CustomerExtended.Pets + "<br>";
                    }
                    if (item.SelectedColumn == "BirthDateCoupon" && Cusmodel.CustomerExtended != null && !string.IsNullOrEmpty(Cusmodel.CustomerExtended.BirthDateCoupon))
                    {
                        EmailTemplate += "Birth Date Coupon: " + Cusmodel.CustomerExtended.BirthDateCoupon + "<br>";
                    }
                    if (item.SelectedColumn == "VipClubMember" && Cusmodel.CustomerExtended != null && !string.IsNullOrEmpty(Cusmodel.CustomerExtended.VipClubMember) && Cusmodel.CustomerExtended.VipClubMember != "-1")
                    {
                        EmailTemplate += "Vip Club Member: " + Cusmodel.CustomerExtended.VipClubMember + "<br>";
                    }
                    if (item.SelectedColumn == "IsFinanced" && Cusmodel.CustomerExtended != null && Cusmodel.CustomerExtended.IsFinanced != null)
                    {
                        if (Cusmodel.CustomerExtended.IsFinanced == true)
                        {
                            EmailTemplate += "Is Financed:  Yes" + "<br>";

                        }
                        else
                        {
                            EmailTemplate += "Is Financed:  No" + "<br>";

                        }


                    }
                    if (item.SelectedColumn == "FinanceCompany" && Cusmodel.CustomerExtended != null && !string.IsNullOrEmpty(Cusmodel.CustomerExtended.FinanceCompany) && Cusmodel.CustomerExtended.FinanceCompany != "-1")
                    {
                        EmailTemplate += "Financed Company: " + Cusmodel.CustomerExtended.FinanceCompany + "<br>";
                    }
                    if (item.SelectedColumn == "MonthlyFinanceRate" && Cusmodel.CustomerExtended != null && Cusmodel.CustomerExtended.MonthlyFinanceRate != null)
                    {
                        EmailTemplate += "Monthly Finance Rate: " + HS.Web.UI.Helper.LabelHelper.CurrentTransMakeCurrency.MakeCurrency(null) + HS.Web.UI.Helper.LabelHelper.FormatAmount(Cusmodel.CustomerExtended.MonthlyFinanceRate) + "<br>";
                    }
                    if (item.SelectedColumn == "GrossFundedAmount" && Cusmodel.CustomerExtended != null && Cusmodel.CustomerExtended.GrossFundedAmount != null)
                    {
                        EmailTemplate += "Gross Funded Amount: " + HS.Web.UI.Helper.LabelHelper.CurrentTransMakeCurrency.MakeCurrency(null) + HS.Web.UI.Helper.LabelHelper.FormatAmount(Cusmodel.CustomerExtended.GrossFundedAmount) + "<br>";
                    }
                    if (item.SelectedColumn == "NetFundedAmount" && Cusmodel.CustomerExtended != null && Cusmodel.CustomerExtended.NetFundedAmount != null)
                    {
                        EmailTemplate += "Net Funded Amount: " + HS.Web.UI.Helper.LabelHelper.CurrentTransMakeCurrency.MakeCurrency(null) + HS.Web.UI.Helper.LabelHelper.FormatAmount(Cusmodel.CustomerExtended.NetFundedAmount) + "<br>";
                    }
                    if (item.SelectedColumn == "DiscountFundedAmount" && Cusmodel.CustomerExtended != null && Cusmodel.CustomerExtended.DiscountFundedAmount != null)
                    {
                        EmailTemplate += "Discount Funded Amount: " + HS.Web.UI.Helper.LabelHelper.CurrentTransMakeCurrency.MakeCurrency(null) + HS.Web.UI.Helper.LabelHelper.FormatAmount(Cusmodel.CustomerExtended.DiscountFundedAmount) + "<br>";
                    }
                    if (item.SelectedColumn == "DiscountFundedPercentage" && Cusmodel.CustomerExtended != null && Cusmodel.CustomerExtended.DiscountFundedPercentage != null)
                    {
                        EmailTemplate += "Discount Funded Percentage: " + Cusmodel.CustomerExtended.DiscountFundedPercentage + "<br>";
                    }
                    if (item.SelectedColumn == "CustomerPaymentAmount" && Cusmodel.CustomerExtended != null && Cusmodel.CustomerExtended.CustomerPaymentAmount != null)
                    {
                        EmailTemplate += "Customer Payment Amount: " + HS.Web.UI.Helper.LabelHelper.CurrentTransMakeCurrency.MakeCurrency(null) + HS.Web.UI.Helper.LabelHelper.FormatAmount(Cusmodel.CustomerExtended.CustomerPaymentAmount) + "<br>";
                    }
                    if (item.SelectedColumn == "FinanceRepCommissionRate" && Cusmodel.CustomerExtended != null && Cusmodel.CustomerExtended.FinanceRepCommissionRate != null)
                    {
                        EmailTemplate += "Finance Rep Commission Rate: " + HS.Web.UI.Helper.LabelHelper.CurrentTransMakeCurrency.MakeCurrency(null) + HS.Web.UI.Helper.LabelHelper.FormatAmount(Cusmodel.CustomerExtended.FinanceRepCommissionRate) + "<br>";
                    }
                    if (item.SelectedColumn == "LoanNumber" && Cusmodel.CustomerExtended != null && !string.IsNullOrEmpty(Cusmodel.CustomerExtended.LoanNumber))
                    {
                        EmailTemplate += "Loan Number: " + Cusmodel.CustomerExtended.LoanNumber + "<br>";
                    }
                    if (item.SelectedColumn == "CreditAppNumber" && Cusmodel.CustomerExtended != null && !string.IsNullOrEmpty(Cusmodel.CustomerExtended.CreditAppNumber))
                    {
                        EmailTemplate += "Credit App Number: " + Cusmodel.CustomerExtended.CreditAppNumber + "<br>";
                    }
                    if (item.SelectedColumn == "Term" && Cusmodel.CustomerExtended != null && !string.IsNullOrEmpty(Cusmodel.CustomerExtended.Term) && Cusmodel.CustomerExtended.Term != "-1")
                    {
                        EmailTemplate += "Term: " + Cusmodel.CustomerExtended.Term + "<br>";
                    }
                    if (item.SelectedColumn == "APR" && Cusmodel.CustomerExtended != null && !string.IsNullOrEmpty(Cusmodel.CustomerExtended.APR))
                    {
                        EmailTemplate += "APR: " + Cusmodel.CustomerExtended.APR + "<br>";
                    }
                    if (item.SelectedColumn == "MaxCreditLimit" && Cusmodel.CustomerExtended != null && Cusmodel.CustomerExtended.MaxCreditLimit != null)
                    {
                        EmailTemplate += "Max Credit Limit: " + HS.Web.UI.Helper.LabelHelper.CurrentTransMakeCurrency.MakeCurrency(null) + HS.Web.UI.Helper.LabelHelper.FormatAmount(Cusmodel.CustomerExtended.MaxCreditLimit) + "<br>";
                    }
                    if (item.SelectedColumn == "ApprovalDate" && Cusmodel.CustomerExtended != null && Cusmodel.CustomerExtended.ApprovalDate != null && Cusmodel.CustomerExtended.ApprovalDate.HasValue && Cusmodel.CustomerExtended.ApprovalDate.Value.ToString("MM/dd/yy") != "01/01/00")
                    {

                        EmailTemplate += "Approval Date: " + Cusmodel.CustomerExtended.ApprovalDate.Value.ToString("MM/dd/yy") + "<br>";


                    }
                    if (item.SelectedColumn.ToLower() == "isactive" && Cusmodel.IsActive == false && Cusmodel.CustomerCancel != null && Cusmodel.CustomerCancel.CancelDatet.HasValue && Cusmodel.CustomerCancel.CancelDatet != new DateTime())
                    {

                        EmailTemplate += "Cancellation Date: " + HS.Framework.DateTimeExtension.UTCToClientTime(Cusmodel.CustomerCancel.CancelDatet.Value).ToString("MM/dd/yy") + " at " + HS.Framework.DateTimeExtension.UTCToClientTime(Cusmodel.CustomerCancel.CancelDatet.Value).ToString("hh:mm tt") + "<br>";

                        EmailTemplate += "Cancelled By: " + Cusmodel.CustomerCancel.EmpName + "<br>";

                        EmailTemplate += "Cancellation Reason: " + Cusmodel.CustomerCancel.CancelReason + "<br>";


                    }
                }
            }











            ViewBag.emailtemplate = EmailTemplate;
            //ViewBag.emailtemplate += salesguytext;
            #endregion
            model.EmailTemplate = _Util.Facade.MailFacade.GetTemplateByTemplateKey("CustomerInfoPredefineEmailTemplate");
            //model.EmailTemplate.CompanyId = CurrentUser.CompanyId.Value;


            string encryptedurl = DESEncryptionDecryption.EncryptPlainTextToCipherText(
                                        CurrentUser.CompanyId.Value
                                        + "#"
                                        + model.CustomerId);
            string fullurl = string.Concat(AppConfig.SiteDomain, "/Customer/", encryptedurl);
            ShortUrl ShortUrl = _Util.Facade.ShortUrlFacade.GetSortUrlByUrl(fullurl, model.CustomerId);
            ViewBag.url = AppConfig.ShortSiteDomain + "/shrt/" + ShortUrl.Code;
            return PartialView("ShareCustomerInfo", model);
        }
        #endregion

        [Authorize]
        public ActionResult TechcallEquipmentList(int? id)
        {
            var CurrentLoggedInUser = ((HS.Web.UI.Helper.CustomPrincipal)(User));

            if (CurrentLoggedInUser == null)
            {
                return PartialView("~/Views/Shared/_AccessDenied.cshtml");
            }
            List<CusEquipmentList> model = new List<CusEquipmentList>();
            if (id.HasValue)
            {
                var CustomerInfo = _Util.Facade.CustomerFacade.GetCustomersById(id.Value);
                if (CustomerInfo != null)
                {
                    var CustomerGuidId = CustomerInfo.CustomerId;
                    var appid = _Util.Facade.CustomerAppoinmentFacade.GetCustomerLastAppointmentIdByCustomerIdAndCompanyId(CustomerGuidId, CurrentLoggedInUser.CompanyId.Value);
                    if (appid != new Guid())
                    {
                        model = _Util.Facade.CustomerAppoinmentFacade.GetCustomerAppointmentEquipmentForTechCall(appid, CustomerGuidId);
                        if (model.Count > 0 && model != null)
                        {
                            foreach (var item in model)
                            {
                                item.EquipmentTotalPrice = item.EquipmentQuantity * item.EquipmentUnitPrice;
                            }
                        }

                    }
                }
            }
            return View("TechcallEquipmentList", model);
        }

        [Authorize]
        public ActionResult AddEquipmentTechCallPartial(Guid? Id)
        {
            var CurrentLoggedInUser = ((HS.Web.UI.Helper.CustomPrincipal)(User));
            if (CurrentLoggedInUser == null)
            {
                return PartialView("~/Views/Shared/_AccessDenied.cshtml");
            }
            ViewBag.AddEqpTechCallPartialCustomerId = new Guid();

            if (Id.HasValue && Id != new Guid())
            {
                ViewBag.AddEqpTechCallPartialCustomerId = Id;
            }
            return PartialView("AddEquipmentTechCallPartial");
        }

        [Authorize]
        [HttpPost]
        public JsonResult AddEquipmentTechCall(TechCallAddEquipment AddedEquipmentsList)
        {
            bool result = false;
            var CurrentLoggedInUser = ((HS.Web.UI.Helper.CustomPrincipal)(User));
            if (CurrentLoggedInUser == null)
            {
                return Json(result);
            }
            if (AddedEquipmentsList.CustomerID != new Guid())
            {
                //Check CustomerWorkOrderAppointment
                var CustomerAppointmentId = _Util.Facade.CustomerAppoinmentFacade.GetCustomerLastAppointmentIdByCustomerIdAndCompanyId(AddedEquipmentsList.CustomerID, CurrentLoggedInUser.CompanyId.Value);
                #region Insert New Work Order and Install product 

                if (CustomerAppointmentId == new Guid())
                {
                    Guid CustomerAppointmentEmpId = new Guid();
                    var CusDbObj = _Util.Facade.CustomerFacade.GetCustomerByCustomerId(AddedEquipmentsList.CustomerID);
                    if (CusDbObj != null)
                    {
                        if (CusDbObj.Installer != new Guid().ToString() && CusDbObj.Installer != "")
                        {
                            CustomerAppointmentEmpId = new Guid(CusDbObj.Installer);
                        }
                    }

                    #region Insert new workorder
                    CustomerAppointment _CustomerAppointment = new CustomerAppointment()
                    {
                        AppointmentId = Guid.NewGuid(),
                        CompanyId = CurrentLoggedInUser.CompanyId.Value,
                        CustomerId = AddedEquipmentsList.CustomerID,
                        EmployeeId = CustomerAppointmentEmpId,
                        AppointmentType = "WorkOrder",
                        IsAllDay = true,
                        Notes = "Work order created from tech call",
                        CreatedBy = User.Identity.Name,
                        LastUpdatedBy = User.Identity.Name,
                        LastUpdatedDate = DateTime.Now.UTCCurrentTime()
                    };
                    #endregion
                    bool IsInsertWorkOrder = _Util.Facade.CustomerAppoinmentFacade.InsertCustomerAppoinment(_CustomerAppointment) > 0;
                    if (IsInsertWorkOrder)
                    {
                        #region insert CustomerAppointmentDetail
                        CustomerAppointmentDetail _CustomerAppointmentDetail = new CustomerAppointmentDetail()
                        {
                            AppointmentId = _CustomerAppointment.AppointmentId,
                            InstallType = "",
                            CollectedAmount = 0.0
                        };
                        #endregion
                        bool IsInsertCustomerAppointmentDetail = _Util.Facade.CustomerAppoinmentDetailFacade.InsertCustomerAppoinmentDetail(_CustomerAppointmentDetail) > 0;

                        if (IsInsertCustomerAppointmentDetail)
                        {
                            #region Customer Appointment Equipment
                            if (AddedEquipmentsList.AddedEquipmetList.Count > 0)
                            {
                                foreach (var item in AddedEquipmentsList.AddedEquipmetList)
                                {
                                    CustomerAppointmentEquipment objCustomerAppointmentEquipment = new CustomerAppointmentEquipment
                                    {
                                        AppointmentId = _CustomerAppointment.AppointmentId,
                                        EquipmentId = item.EquipmentId,
                                        Quantity = item.Quantity,
                                        UnitPrice = item.UnitPrice,
                                        //TotalPrice = item.TotalPrice,
                                        CreatedDate = DateTime.Now.UTCCurrentTime(),
                                        CreatedBy = User.Identity.Name
                                    };
                                    result = _Util.Facade.CustomerAppoinmentDetailFacade.InsertCustomerAppointmentEquipment(objCustomerAppointmentEquipment) > 0;
                                }
                            }
                            #endregion
                        }
                    }
                }
                #endregion

                #region Edit Work Order And Install Products
                else
                {
                    if (CustomerAppointmentId != new Guid() && AddedEquipmentsList.AddedEquipmetList.Count > 0)
                    {
                        foreach (var item in AddedEquipmentsList.AddedEquipmetList)
                        {
                            CustomerAppointmentEquipment objCustomerAppointmentEquipment = new CustomerAppointmentEquipment
                            {
                                AppointmentId = CustomerAppointmentId,
                                EquipmentId = item.EquipmentId,
                                Quantity = item.Quantity,
                                UnitPrice = item.UnitPrice,
                                //Price = item.Price,
                                CreatedDate = DateTime.Now.UTCCurrentTime(),
                                CreatedBy = User.Identity.Name
                            };
                            result = _Util.Facade.CustomerAppoinmentDetailFacade.InsertCustomerAppointmentEquipment(objCustomerAppointmentEquipment) > 0;
                        }
                    }
                }
                #endregion

            }
            return Json(result);
        }


        public JsonResult MakeTechCallSuccessful(Guid CustomerId)
        {
            var result = false;
            var CurrentLoggedInUser = ((HS.Web.UI.Helper.CustomPrincipal)(User));
            if (CurrentLoggedInUser == null)
            {
                return Json(result);
            }
            int CusIntId = 0;
            if (CustomerId != new Guid())
            {
                var CustomerObj = _Util.Facade.CustomerFacade.GetCustomerByCustomerId(CustomerId);
                if (CustomerObj != null)
                {
                    CusIntId = CustomerObj.Id;
                    CustomerObj.IsTechCallPassed = true;
                    CustomerObj.LastUpdatedBy = User.Identity.Name;
                    CustomerObj.LastUpdatedDate = DateTime.Now.UTCCurrentTime();
                    CustomerObj.IsActive = true;
                }
                result = _Util.Facade.CustomerFacade.UpdateCustomer(CustomerObj);
            }
            return Json(new { status = result, customerid = CusIntId });
        }

        //public ActionResult SubscribeToAuthorize(int? CustomerId, Guid? CustomerGuid)
        //{
        //    var currentLoggedIn = ((HS.Web.UI.Helper.CustomPrincipal)(User));
        //    Customer Model = new Customer();
        //    if (CustomerId.HasValue && CustomerId > 0)
        //    {
        //        bool result = _Util.Facade.CustomerFacade.CustomerIsInCompany(CustomerId.Value, currentLoggedIn.CompanyId.Value);
        //        if (!result)
        //        {
        //            return PartialView("~/Views/Shared/_AccessDenied.cshtml");
        //        }
        //        Model = _Util.Facade.CustomerFacade.GetCustomerById(CustomerId.Value);

        //    }
        //    else if (CustomerGuid.HasValue && CustomerGuid != new Guid())
        //    {
        //        bool result = _Util.Facade.CustomerFacade.CustomerIsInCompany(CustomerGuid.Value, currentLoggedIn.CompanyId.Value);
        //        if (!result)
        //        {
        //            return PartialView("~/Views/Shared/_AccessDenied.cshtml");
        //        }

        //        Model = _Util.Facade.CustomerFacade.GetCustomerByCustomerId(CustomerGuid.Value);
        //    }
        //    else
        //    {
        //        return PartialView("~/Views/Shared/_AccessDenied.cshtml");
        //    }



        //    return View("_SubscribeToAuthorize", Model);
        //}
        //[HttpPost]
        //public JsonResult SubscribeToAuthorize(ARBSubscription Model)
        //{
        //    if (Model.CustomerId.HasValue && Model.CustomerId > 0)
        //    {
        //        Customer tempCustomer = _Util.Facade.CustomerFacade.GetCustomerById(Model.CustomerId.Value);
        //        if (tempCustomer != null)
        //        {
        //            var CurrentUser = (HS.Web.UI.Helper.CustomPrincipal)User;
        //            string TransactionKey = _Util.Facade.GlobalSettingsFacade.GetAuthTransactionKeyByCompanyId(CurrentUser.CompanyId.Value);
        //            string APILoginId = _Util.Facade.GlobalSettingsFacade.GetAuthAPILoginIdByCompanyId(CurrentUser.CompanyId.Value);
        //            Model.SubscriptionInterval = 30;
        //            var result = CreateSubscription.Run(APILoginId, TransactionKey, Model);
        //            if (!string.IsNullOrWhiteSpace(result.refId))
        //            {
        //                tempCustomer.AuthorizeRefId = result.refId;
        //                tempCustomer.IsActive = true;
        //                _Util.Facade.CustomerFacade.UpdateCustomer(tempCustomer);
        //                return Json(new { result = true, message = result.refId });
        //            }
        //        }
        //        return Json(new { result = false });
        //    }
        //    else
        //    {
        //        return Json(new { result = false });
        //    }

        //}

        [Authorize]
        public PartialViewResult CustomerEmergencyContactListPartial(Guid? Id)
        {
            var currentLoggedIn = ((HS.Web.UI.Helper.CustomPrincipal)(User));
            if (currentLoggedIn == null)
            {
                return PartialView("~/Views/Shared/_AccessDenied.cshtml");
            }
            List<EmergencyContact> model = new List<EmergencyContact>();
            if (currentLoggedIn != null)
            {
                if (!Id.HasValue)
                {
                    return PartialView("~/Views/Shared/_AccessDenied.cshtml");
                }
                else
                {
                    if (Id.Value != new Guid())
                    {
                        model = _Util.Facade.EmergencyContactFacade.GetAllEmergencyContactByCustomerIdAndCompanyId(Id.Value, currentLoggedIn.CompanyId.Value).OrderBy(x => x.OrderBy).ToList();
                    }
                }
            }
            #region Viewbag
            GlobalSetting HasKeyValue = _Util.Facade.GlobalSettingsFacade.GetGlobalSettingsByKey(currentLoggedIn.CompanyId.Value, "On emergency contact do you want has key?");
            if (HasKeyValue != null)
            {
                ViewBag.HasKeyValue = HasKeyValue.Value;
            }

            #endregion
            return PartialView("CustomerEmergencyContactListPartial", model);
        }

        [Authorize]
        public PartialViewResult AddCustomerEmergencyContact(Guid? EmgConId, int? EmgId)
        {

            if (!base.IsPermitted(UserPermissions.CustomerPermissions.CustomerSetupEmergencyTab) || !EmgConId.HasValue)
            {
                return PartialView("~/Views/Shared/_AccessDenied.cshtml");
            }
            var currentLoggedIn = ((HS.Web.UI.Helper.CustomPrincipal)(User));
            string UserRole = currentLoggedIn.UserRole;
            if (UserRole == "Customer")
            {
                ViewBag.Role = "Customer";
            }
            else
            {
                ViewBag.Role = "";
            }
            EmergencyContact model = new EmergencyContact();
            model.PhoneType = "-1";
            model.RelationShip = "-1";
            ViewBag.AddEmgContactCustomerId = new Guid();
            if (EmgConId.Value != new Guid() && EmgId.Value > 0)
            {

                ViewBag.AddEmgContactCustomerId = EmgConId.Value;
                model = _Util.Facade.EmergencyContactFacade.GetEmergencyContactByCustomerIdAndCompanyIdAndId(EmgConId.Value, currentLoggedIn.CompanyId.Value, EmgId.Value);
            }
            if (EmgConId.Value != new Guid())
            {
                ViewBag.AddEmgContactCustomerId = EmgConId.Value;
            }

            List<SelectListItem> typephonelist = new List<SelectListItem>();
            typephonelist.AddRange(_Util.Facade.LookupFacade.GetLookupByKey("PhoneType").Select(x =>
                             new SelectListItem()
                             {
                                 Text = x.DisplayText.ToString(),
                                 Value = x.DataValue.ToString()
                             }).ToList());
            ViewBag.PhoneTypeList = typephonelist;
            ViewBag.Relationship = _Util.Facade.LookupFacade.GetLookupByKey("Relationship").Select(x =>
                            new SelectListItem()
                            {
                                Text = x.DisplayText.ToString(),
                                Value = x.DataValue.ToString()
                            }).ToList();

            GlobalSetting HasKeyValue = _Util.Facade.GlobalSettingsFacade.GetGlobalSettingsByKey(currentLoggedIn.CompanyId.Value, "On emergency contact do you want has key?");
            if (HasKeyValue != null)
            {
                ViewBag.HasKeyValue = HasKeyValue.Value;
            }

            return PartialView("AddCustomerEmergencyContact", model);
        }



        [Authorize]
        [HttpPost]
        public JsonResult AddEmergencyContact(EmergencyContact _EmergencyContact)
        {
            var result = false;
            var message = "";
            var currentLoggedIn = ((HS.Web.UI.Helper.CustomPrincipal)(User));
            if (currentLoggedIn == null)
            {
                return Json(result);
            }
            if (currentLoggedIn != null)
            {
                if (_EmergencyContact.CompanyId == new Guid())
                {
                    _EmergencyContact.CompanyId = currentLoggedIn.CompanyId.Value;
                }
                if (_EmergencyContact.Id > 0)
                {
                    EmergencyContact OldEmergencyContactCopy = _Util.Facade.EmergencyContactFacade.GetEmergencyContactByCustomerIdAndCompanyIdAndId(_EmergencyContact.CustomerId, currentLoggedIn.CompanyId.Value, _EmergencyContact.Id);
                    if (OldEmergencyContactCopy != null)
                    {
                        OldEmergencyContactCopy.FirstName = _EmergencyContact.FirstName;
                        OldEmergencyContactCopy.LastName = _EmergencyContact.LastName;
                        OldEmergencyContactCopy.CrossSteet = _EmergencyContact.CrossSteet;
                        OldEmergencyContactCopy.RelationShip = _EmergencyContact.RelationShip;
                        OldEmergencyContactCopy.Phone = _EmergencyContact.Phone;
                        OldEmergencyContactCopy.HasKey = _EmergencyContact.HasKey;
                        OldEmergencyContactCopy.PhoneType = _EmergencyContact.PhoneType;
                        OldEmergencyContactCopy.ContactNo = OldEmergencyContactCopy.ContactNo;
                        OldEmergencyContactCopy.Email = _EmergencyContact.Email;
                        OldEmergencyContactCopy.Platform = _EmergencyContact.Platform;
                        result = _Util.Facade.EmergencyContactFacade.UpdateEmergencyContact(OldEmergencyContactCopy) > 0;
                        message = "Emergancy Contact Saved successfully";
                    }
                }
                else
                {
                    //var EmergencyContactCount = _Util.Facade.EmergencyContactFacade.GetAllEmergencyContactByCustomerIdAndCompanyId(_EmergencyContact.CustomerId, currentLoggedIn.CompanyId.Value);
                    //if (EmergencyContactCount.Count < 1)
                    //{
                    //    var LeadInfo = _Util.Facade.CustomerFacade.GetCustomerByCustomerId(_EmergencyContact.CustomerId);
                    //    if (LeadInfo != null)
                    //    {
                    //        var LeadIntId = LeadInfo.Id;
                    //        var LeadobjName = _Util.Facade.CustomerFacade.GetLeadNameByLeadId(LeadIntId).LeadName;

                    //    }
                    //}
                    _EmergencyContact.CompanyId = currentLoggedIn.CompanyId.Value;
                    result = _Util.Facade.EmergencyContactFacade.InsertEmergencyContact(_EmergencyContact) > 0;
                    message = "Emergancy Contact Saved successfully";
                }

            }

            return Json(new { result = result, message = message });
        }



        [Authorize]
        [HttpPost]
        public JsonResult DeleteEmergencyContact(int Id)
        {
            var res = _Util.Facade.EmergencyContactFacade.DeleteEmergencyContactById(Id);
            if (res)
            {
                return Json(new { result = res, message = "Emergency contact deleted successfully." });
            }
            else
            {
                return Json(new { result = res, message = "An error occured." });
            }

        }

        [Authorize]
        [HttpPost]
        public JsonResult ConvertInactiveOrActiveCustomer(int Nonval, string cval)
        {
            bool res = false;
            var currentLoggedIn = ((HS.Web.UI.Helper.CustomPrincipal)(User));
            var tempcustomer = _Util.Facade.CustomerFacade.GetCustomerById(Nonval);
            if (tempcustomer != null)
            {
                if (tempcustomer.IsActive == true)
                {
                    tempcustomer.IsActive = false;
                    res = _Util.Facade.CustomerFacade.UpdateCustomer(tempcustomer);
                    if (res == true)
                    {
                        CustomerCancel objCancel = new CustomerCancel()
                        {
                            CompanyId = currentLoggedIn.CompanyId.Value,
                            CustomerId = tempcustomer.CustomerId,
                            EmployeeId = currentLoggedIn.UserId,
                            CancelDatet = DateTime.Now.UTCCurrentTime(),
                            CancelReason = cval,
                            IsActivated = false
                        };
                        _Util.Facade.CustomerFacade.InsertCustomerCancel(objCancel);
                    }
                }
                else
                {
                    CustomerCancel objCancel = new CustomerCancel()
                    {
                        CompanyId = currentLoggedIn.CompanyId.Value,
                        CustomerId = tempcustomer.CustomerId,
                        EmployeeId = currentLoggedIn.UserId,
                        CancelDatet = DateTime.Now.UTCCurrentTime(),
                        CancelReason = cval,
                        IsActivated = true
                    };
                    _Util.Facade.CustomerFacade.InsertCustomerCancel(objCancel);

                    tempcustomer.IsActive = true;
                    res = _Util.Facade.CustomerFacade.UpdateCustomer(tempcustomer);
                }
            }
            return Json(new { res = res, Customerid = Nonval });
        }
        [Authorize]
        public JsonResult DuplicateCustomer(string Type, string Value, int CustomerId)
        {
            int CustomerIdExist = 0;
            bool result = false;
            if (!string.IsNullOrEmpty(Type) && !string.IsNullOrEmpty(Value))
            {
                var DuplicateCustomer = _Util.Facade.CustomerFacade.GetDuplicateCustomer(Type, Value, CustomerId);
                if (DuplicateCustomer != null)
                {
                    CustomerIdExist = DuplicateCustomer.Id;
                    result = true;
                }
            }
            return Json(new { result = result, CustomerId = CustomerIdExist }, JsonRequestBehavior.AllowGet);

        }

        [Authorize]
        public JsonResult GetCityStateZipListByKey(string key)
        {
            string result = "[]";
            if (!string.IsNullOrWhiteSpace(key))
            {
                var CurrentUser = (HS.Web.UI.Helper.CustomPrincipal)User;

                int ItemsLoadCount = _Util.Facade.GlobalSettingsFacade.GetLeadCityStateSearchMaxLoad(CurrentUser.CompanyId.Value);

                List<CityZipCode> LCityState = _Util.Facade.CityZipcodeFacade.GetLeadCityStateListBySearchKey(key, ItemsLoadCount);
                if (LCityState.Count > 0)
                    result = JsonConvert.SerializeObject(LCityState);
            }

            return Json(new { result = result }, JsonRequestBehavior.AllowGet);

        }

        [Authorize]
        public ActionResult CreateEstimateHistoryPartial(Guid CustomerId)
        {
            var CurrentLoggedInUser = (HS.Web.UI.Helper.CustomPrincipal)User;
            if (CurrentLoggedInUser == null)
            {
                return PartialView("~/Views/Shared/_AccessDenied.cshtml");
            }
            else if (CustomerId == null)
            {
                return PartialView("~/Views/Shared/_AccessDenied.cshtml");
            }
            else
            {
                List<CustomerSnapshot> EstimateHistoryList = _Util.Facade.CustomerSnapshotFacade.GetCustomerEstimateHistoryByCustomerIdAndEstimateCreatedKey(CustomerId, CurrentLoggedInUser.CompanyId.Value);
                return PartialView("_CreateEstimateHistoryPartial", EstimateHistoryList);
            }
        }

        [Authorize]
        public ActionResult InvoicePaymentHistoryPartial(Guid CustomerId)
        {
            var CurrentLoggedInUser = (HS.Web.UI.Helper.CustomPrincipal)User;
            if (CurrentLoggedInUser == null)
            {
                return PartialView("~/Views/Shared/_AccessDenied.cshtml");
            }
            else if (CustomerId == null)
            {
                return PartialView("~/Views/Shared/_AccessDenied.cshtml");
            }
            else
            {
                List<CustomerSnapshot> PaymentHistoryList = _Util.Facade.CustomerSnapshotFacade.GetCustomerPaymentHistoryByCustomerIdAndEstimateCreatedKey(CustomerId, CurrentLoggedInUser.CompanyId.Value);
                return PartialView("_InvoicePaymentHistoryPartial", PaymentHistoryList);
            }
        }

        #region Test
        public JsonResult Test()
        {
            return Json(new
            {
                MM = DateTime.Now.UTCCurrentTime().ToString("MM")
                ,
                MMM = DateTime.Now.UTCCurrentTime().ToString("MMM")
                ,
                MMMM = DateTime.Now.UTCCurrentTime().ToString("MMMM")
                ,
                yy = DateTime.Now.UTCCurrentTime().ToString("yy")
                ,
                yyyy = DateTime.Now.UTCCurrentTime().ToString("yyyy")
            }, JsonRequestBehavior.AllowGet);

        }
        #endregion

        [Authorize]
        [HttpPost]
        public JsonResult DeleteCustomerSystemNo(int? id)
        {
            bool result = false;
            string message = "";
            if (id.HasValue)
            {
                var noobj = _Util.Facade.CustomerSystemNoFacade.GetSystemNoById(id.Value);
                if (noobj != null)
                {
                    if (noobj.IsUsed == true && noobj.ReserveDate != new DateTime() && noobj.UsedDate != new DateTime())
                    {
                        message = noobj.CustomerNo + " already used";
                    }
                    else
                    {
                        _Util.Facade.CustomerSystemNoFacade.DeleteCustomerSystemNo(id.Value);
                        result = true;
                    }
                }
            }
            return Json(new { result = result, message = message });
        }

        [HttpPost]
        public JsonResult UnassociateCustomerSystemNo(int? id)
        {
            bool result = false;
            string message = "";
            Customer cus = new Customer();
            if (id.HasValue)
            {
                var noobj = _Util.Facade.CustomerSystemNoFacade.GetSystemNoById(id.Value);
                if (noobj != null)
                {
                    noobj.IsUsed = false;
                    noobj.IsReserved = true;
                    noobj.ReserveDate = DateTime.Now.ClientToUTCTime();
                    if (noobj.CustomerId > 0)
                    {
                        cus = _Util.Facade.CustomerFacade.GetCustomerById(noobj.CustomerId.Value);
                        if (cus != null)
                        {
                            cus.UCCRefId = "";
                            _Util.Facade.CustomerFacade.UpdateCustomer(cus);
                        }

                    }
                    _Util.Facade.CustomerSystemNoFacade.UpdateCustomerSystemNo(noobj);
                    message = "Number Unassociated Successfully.";
                    result = true;
                }
            }
            return Json(new { result = result, message = message });
        }
        [HttpPost]
        public JsonResult StatusChangeCustomerSystemNo(int? id)
        {
            var CurrentLoggedInUser = (HS.Web.UI.Helper.CustomPrincipal)User;
            bool result = false;
            string message = "";
            Customer cus = new Customer();
            if (id.HasValue)
            {
                var noobj = _Util.Facade.CustomerSystemNoFacade.GetSystemNoById(id.Value);
                if (noobj != null)
                {
                    if (noobj.IsUsed == false && noobj.IsReserved == false)
                    {
                        noobj.IsUsed = true;
                        noobj.IsReserved = true;
                        noobj.ReserveDate = DateTime.Now.ClientToUTCTime();

                    }
                    else
                    {
                        noobj.IsUsed = false;
                        noobj.IsReserved = false;
                        noobj.ReserveDate = DateTime.Now.ClientToUTCTime();
                    }

                    GlobalSetting RemoveCustomerNoGlobal = new GlobalSetting();

                    if (noobj.CustomerId > 0)
                    {
                        RemoveCustomerNoGlobal = _Util.Facade.GlobalSettingsFacade.GetGlobalSettingsByKey(CurrentLoggedInUser.CompanyId.Value, "RemoveCustomerNoForTermination");
                        cus = _Util.Facade.CustomerFacade.GetCustomerById(noobj.CustomerId.Value);
                        if (cus != null)
                        {
                            cus.UCCRefId = "";
                            cus.AccountNo = "";
                            cus.CustomerNo = "";
                            _Util.Facade.CustomerFacade.UpdateCustomer(cus);
                        }
                        if (RemoveCustomerNoGlobal != null && RemoveCustomerNoGlobal.Value.ToLower() == "true")
                        {
                            cus.CustomerNo = "";

                            _Util.Facade.CustomerFacade.UpdateCustomer(cus);
                        }
                        else if (!string.IsNullOrEmpty(cus.CustomerNo))
                        {
                            cus.CustomerNo = "X" + cus.CustomerNo;

                            _Util.Facade.CustomerFacade.UpdateCustomer(cus);
                        }
                    }


                    noobj.CustomerId = 0;
                    _Util.Facade.CustomerSystemNoFacade.UpdateCustomerSystemNo(noobj);
                    message = "Open Successfully.";
                    result = true;
                }
            }
            return Json(new { result = result, message = message });
        }
        [Authorize]
        public ActionResult CustomerAnnouncement()
        {
            return View();
        }
        public ActionResult AddAnnouncement(int? Id)
        {
            Announcement announcement = new Announcement();
            if (Id.HasValue && Id > 0)
            {
                announcement = _Util.Facade.CustomerFacade.GetAnnouncementById(Id.Value);
            }
            return View(announcement);
        }
        [Authorize]
        public PartialViewResult ShowAnnouncementList()
        {
            List<Announcement> AnnouncementList = _Util.Facade.CustomerFacade.GetAllAnnouncement();

            return PartialView("_ShowAnnouncementList", AnnouncementList);
        }
        public ActionResult AnnouncementIndex()
        {
            if (!base.SetLayoutCommons())
            {
                return RedirectToAction("Logout", "Login");
            }
            return View();
        }
        [Authorize]
        [HttpPost]
        public ActionResult AddAnnouncement(Announcement AnnouncementInfo)
        {
            bool result = false;
            string message = "";
            var currentLoggedIn = ((HS.Web.UI.Helper.CustomPrincipal)(User));

            if (AnnouncementInfo.StartTime <= AnnouncementInfo.EndTime)
            {
                try
                {
                    if (AnnouncementInfo.Id > 0)
                    {
                        Announcement announcement = _Util.Facade.CustomerFacade.GetAnnouncementById(AnnouncementInfo.Id);
                        announcement.Title = AnnouncementInfo.Title;
                        announcement.StartTime = AnnouncementInfo.StartTime;
                        announcement.EndTime = AnnouncementInfo.EndTime;
                        announcement.Message = AnnouncementInfo.Message;
                        _Util.Facade.CustomerFacade.UpdateAnnouncement(announcement);
                        result = true;
                        message = "Announcement updated successfully.";
                    }
                    else
                    {
                        AnnouncementInfo.CreatedBy = currentLoggedIn.UserId;
                        AnnouncementInfo.CreatedDate = DateTime.Now.UTCCurrentTime();
                        AnnouncementInfo.CompanyId = currentLoggedIn.CompanyId.Value;
                        long id = _Util.Facade.CustomerFacade.InsertCustomerAnnouncement(AnnouncementInfo);
                        result = true;
                        message = "Announcement added successfully.";
                    }



                }
                catch (Exception ex)
                {
                    result = false;
                    message = "Announcement does not save";
                }
            }
            else
            {
                result = false;
                message = "Announcement end date should greater then start date.";
            }


            return Json(new { result = result, message = message });
        }

        public ActionResult DeleteAnnouncement(int Id)
        {
            bool result = false;
            string message = "";
            var currentLoggedIn = ((HS.Web.UI.Helper.CustomPrincipal)(User));


            try
            {
                if (Id > 0)
                {
                    _Util.Facade.CustomerFacade.DeleteAnnouncement(Id);
                    result = true;
                    message = "Announcement Deleted successfully.";
                }
                else
                {

                    result = false;
                    message = "Internal Error.";
                }



            }
            catch (Exception ex)
            {
                result = false;
                message = "Internal Error.";
            }

            return Json(new { result = result, message = message });
        }

        [Authorize]
        [HttpPost, ValidateInput(false)]
        public JsonResult SendCustomerInfoEmail(Guid CustomerId, string ccEmail, string EmailAddress, string EmailDescription, string EmailSubject)
        {

            if (!base.IsPermitted(UserPermissions.CustomerPermissions.CustomerInvoiceAdd))
            {
                return Json(new { result = false, message = "Permission denied." });
            }
            Customer tempCustomer = _Util.Facade.CustomerFacade.GetCustomerByCustomerId(CustomerId);

            bool EmailSent = false;
            var CurrentUser = (HS.Web.UI.Helper.CustomPrincipal)User;

            #region SendEmail

            string filename = "";
            if (tempCustomer.Id > 0)
            {

                //var cusobj = _Util.Facade.CustomerFacade.GetCustomerByCustomerId(Model.Invoice.CustomerId);
                var comobj = _Util.Facade.CompanyFacade.GetCompanyByComapnyId(tempCustomer.CompanyId);
                SendCusInfoInEmail email = new SendCusInfoInEmail()
                {
                    CompanyName = _Util.Facade.CompanyFacade.GetCompanyByComapnyId(CurrentUser.CompanyId.Value).CompanyName,
                    CustomerName = tempCustomer.FirstName + " " + tempCustomer.LastName,
                    ToEmail = EmailAddress,
                    EmailBody = EmailDescription,
                    ccEmail = ccEmail,
                    Subject = EmailSubject,
                    FromEmail = CurrentUser.EmailAddress.IsValidEmailAddress() ? CurrentUser.EmailAddress : "info@rmrcloud.com",
                    FromName = string.Concat(CurrentUser.FirstName, " ", CurrentUser.LastName),

                };
                EmailSent = _Util.Facade.MailFacade.SendCustomerInfoEmail(email, CurrentUser.CompanyId.Value);
                tempCustomer.PreferedEmail = true;
                _Util.Facade.CustomerFacade.UpdateCustomer(tempCustomer);

                if (EmailSent)
                {
                    string empName = "";
                    var empobj = _Util.Facade.EmployeeFacade.GetEmployeeByEmployeeId(tempCustomer.CreatedByUid);
                    if (empobj != null)
                    {
                        empName = empobj.FirstName + " " + empobj.LastName;
                    }
                    CustomerSnapshot objEstimateEmailLog = new CustomerSnapshot()
                    {
                        CustomerId = CustomerId,
                        CompanyId = CurrentUser.CompanyId.Value,
                        Description = "Customer Info" + "  " + " " + "email sent by " + "<b>" + empName + "</b>",
                        Logdate = DateTime.Now.UTCCurrentTime(),
                        Updatedby = CurrentUser.Identity.Name,
                        Type = "CustomerMailHistory"
                    };
                    _Util.Facade.CustomerSnapshotFacade.InsertSnapshot(objEstimateEmailLog);
                    //CustomerAgreement objagree = new CustomerAgreement()
                    //{
                    //    CustomerId = Model.Invoice.CustomerId,
                    //    CompanyId = CurrentUser.CompanyId.Value,
                    //    InvoiceId = Model.Invoice.InvoiceId,
                    //    Type = LabelHelper.EstimateStatus.SentToCustomer,
                    //    AddedDate = DateTime.Now.UTCCurrentTime()
                    //};
                    //_Util.Facade.CustomerAgreementFacade.InsertCustomerAgreement(objagree);

                    LeadCorrespondence objCor = new LeadCorrespondence()
                    {
                        CompanyId = CurrentUser.CompanyId.Value,
                        CustomerId = CustomerId,
                        TemplateKey = "CustomerInfoMail",
                        Type = LabelHelper.CorrespondenceMessageTyp.Email,
                        ToEmail = EmailAddress,
                        Subject = EmailSubject,
                        BodyContent = EmailDescription,
                        SentDate = DateTime.Now.UTCCurrentTime(),
                        IsSystemAutoSent = true,
                        SentBy = CurrentUser.UserId
                    };
                    _Util.Facade.LeadCorrespondenceFacade.InsertCorrespondence(objCor);
                }
            }

            string errorMessage = "Failed send email";
            if (EmailSent == false)
            {
                if (string.IsNullOrWhiteSpace(EmailAddress))
                {
                    errorMessage = "Eamil cannot be send without email address";
                }
                return Json(new { result = true, message = errorMessage, EmailSent = EmailSent });
            }
            //if (EmailSent)
            //{
            //    string serverFile = Server.MapPath(filename);
            //    if (System.IO.File.Exists(serverFile))
            //    {
            //        System.IO.File.Delete(serverFile);
            //    }
            //}
            #endregion



            return Json(new { result = true, message = string.Concat("Customer Info Successfully Emailed to ", EmailAddress), EmailSent = EmailSent });
        }
        [Authorize]
        [HttpPost]
        public JsonResult SendCustomerInfoEmailandSMS(Guid CustomerId, string ccEmail, string EmailAddress, string EmailDescription, string EmailSubject, string ContactNumber, string Message)
        {

            if (!base.IsPermitted(UserPermissions.CustomerPermissions.CustomerInvoiceAdd))
            {
                return Json(new { result = false, message = "Permission denied." });
            }
            Customer tempCustomer = _Util.Facade.CustomerFacade.GetCustomerByCustomerId(CustomerId);

            bool EmailSent = false;
            bool SmsSent = false;
            var CurrentUser = (HS.Web.UI.Helper.CustomPrincipal)User;

            #region SendEmail

            string filename = "";
            if (tempCustomer.Id > 0)
            {

                //var cusobj = _Util.Facade.CustomerFacade.GetCustomerByCustomerId(Model.Invoice.CustomerId);
                var comobj = _Util.Facade.CompanyFacade.GetCompanyByComapnyId(tempCustomer.CompanyId);
                SendCusInfoInEmail email = new SendCusInfoInEmail()
                {
                    CompanyName = _Util.Facade.CompanyFacade.GetCompanyByComapnyId(CurrentUser.CompanyId.Value).CompanyName,
                    CustomerName = tempCustomer.FirstName + " " + tempCustomer.LastName,

                    ToEmail = EmailAddress,
                    EmailBody = EmailDescription,
                    ccEmail = ccEmail,
                    Subject = EmailSubject,
                    FromEmail = CurrentUser.EmailAddress.IsValidEmailAddress() ? CurrentUser.EmailAddress : "info@rmrcloud.com",
                    FromName = string.Concat(CurrentUser.FirstName, " ", CurrentUser.LastName),

                };
                EmailSent = _Util.Facade.MailFacade.SendCustomerInfoEmail(email, CurrentUser.CompanyId.Value);
                tempCustomer.PreferedEmail = true;
                _Util.Facade.CustomerFacade.UpdateCustomer(tempCustomer);

                if (EmailSent)
                {
                    string empName = "";
                    var empobj = _Util.Facade.EmployeeFacade.GetEmployeeByEmployeeId(tempCustomer.CreatedByUid);
                    if (empobj != null)
                    {
                        empName = empobj.FirstName + " " + empobj.LastName;
                    }
                    CustomerSnapshot objEstimateEmailLog = new CustomerSnapshot()
                    {
                        CustomerId = CustomerId,
                        CompanyId = CurrentUser.CompanyId.Value,
                        Description = "Customer Info" + "  " + " " + "email sent by " + "<b>" + empName + "</b>",
                        Logdate = DateTime.Now.UTCCurrentTime(),
                        Updatedby = CurrentUser.Identity.Name,
                        Type = "CustomerMailHistory"
                    };
                    _Util.Facade.CustomerSnapshotFacade.InsertSnapshot(objEstimateEmailLog);
                    //CustomerAgreement objagree = new CustomerAgreement()
                    //{
                    //    CustomerId = Model.Invoice.CustomerId,
                    //    CompanyId = CurrentUser.CompanyId.Value,
                    //    InvoiceId = Model.Invoice.InvoiceId,
                    //    Type = LabelHelper.EstimateStatus.SentToCustomer,
                    //    AddedDate = DateTime.Now.UTCCurrentTime()
                    //};
                    //_Util.Facade.CustomerAgreementFacade.InsertCustomerAgreement(objagree);

                    LeadCorrespondence objCor = new LeadCorrespondence()
                    {
                        CompanyId = CurrentUser.CompanyId.Value,
                        CustomerId = CustomerId,
                        TemplateKey = "CustomerInfoMail",
                        Type = LabelHelper.CorrespondenceMessageTyp.Email,
                        ToEmail = EmailAddress,
                        Subject = EmailSubject,
                        BodyContent = EmailDescription,
                        SentDate = DateTime.Now.UTCCurrentTime(),
                        IsSystemAutoSent = true,
                        SentBy = CurrentUser.UserId
                    };
                    _Util.Facade.LeadCorrespondenceFacade.InsertCorrespondence(objCor);
                }
            }

            string errorMessage = "Failed send email";
            if (EmailSent == false)
            {
                if (string.IsNullOrWhiteSpace(EmailAddress))
                {
                    errorMessage = "Eamil cannot be send without email address";
                }
                return Json(new { result = true, message = errorMessage, EmailSent = EmailSent });
            }
            //if (EmailSent)
            //{
            //    string serverFile = Server.MapPath(filename);
            //    if (System.IO.File.Exists(serverFile))
            //    {
            //        System.IO.File.Delete(serverFile);
            //    }
            //}
            #endregion
            #region sendsms
            if (string.IsNullOrWhiteSpace(ContactNumber))
            {
                return Json(new { result = false });
            }

            if (!tempCustomer.PreferedSms.HasValue || !tempCustomer.PreferedSms.Value)
            {
                tempCustomer.PreferedSms = true;
                _Util.Facade.CustomerFacade.UpdateCustomer(tempCustomer);
            }

            List<string> ReceiverNumberList = new List<string>();
            if (Message.IndexOf("##url##") > -1)
            {
                string encryptedurl = DESEncryptionDecryption.EncryptPlainTextToCipherText(
                     CurrentUser.CompanyId.Value
                    + "#"
                    + CustomerId);
                string fullurl = string.Concat(AppConfig.SiteDomain, "/Customer/", encryptedurl);
                ShortUrl ShortUrl = _Util.Facade.ShortUrlFacade.GetSortUrlByUrl(fullurl, CustomerId);
                Message = Message.Replace("##url##", ShortUrl.Code);
            }
            //Message = string.Concat("Here is your estimate", Environment.NewLine, shortUrl);
            #region ReceiverNumber Setup 
            ReceiverNumberList.Add(ContactNumber);
            #endregion
            CustomerInfoSms cusSms = new CustomerInfoSms();

            cusSms.Message = Message;

            if (_Util.Facade.SMSFacade.SendCustomerInfoSMS(cusSms, CurrentUser.UserId, CurrentUser.CompanyId.Value, ReceiverNumberList, false, string.Concat(CurrentUser.FirstName, " ", CurrentUser.LastName)) == true)
            {
                LeadCorrespondence objcorres = new LeadCorrespondence()
                {
                    CompanyId = CurrentUser.CompanyId.Value,
                    CustomerId = tempCustomer.CustomerId,
                    Type = LabelHelper.CorrespondenceMessageTyp.SMS,
                    ToMobileNo = ContactNumber,
                    BodyContent = Message,
                    SentDate = DateTime.Now.UTCCurrentTime(),
                    LastUpdatedDate = DateTime.Now.UTCCurrentTime(),
                    SentBy = CurrentUser.UserId
                };
                _Util.Facade.LeadCorrespondenceFacade.InsertCorrespondence(objcorres);
                //return Json(new { result = true, message = string.Format("SMS sent to {0} successfully.", ContactNumber) });
                SmsSent = true;
            }
            else
            {
                return Json(new { result = false, message = string.Format("Sending to {0} failed.", ContactNumber) });
            }
            #endregion

            return Json(new { result = true, message = string.Concat("Customer Info Successfully Emailed to ", EmailAddress + " and Messaged to ", ContactNumber), EmailSent = EmailSent, SMSsent = SmsSent });


        }
        public JsonResult UpdateContactList(List<QuestionSort> ContactList)
        {
            if (ContactList.Count() == 0)
            {
                return Json(new { result = false, message = "No data selected." });
            }
            foreach (var item in ContactList)
            {
                //also can take all lookup list by data key
                //then update individually.

                EmergencyContact emContact = new EmergencyContact();
                if (item.Id > 0)
                {
                    emContact = _Util.Facade.EmergencyContactFacade.GetEmergencyContactById(item.Id);
                    if (emContact != null)
                    {
                        emContact.OrderBy = item.OrderBy;

                        _Util.Facade.EmergencyContactFacade.UpdateEmergencyContact(emContact);
                    }
                }


            }
            return Json(new { result = true, message = "Question Updated successfully." });

        }
        [HttpPost]
        public JsonResult UpdateEmergencyContactList(List<EmergencyContact> emerarr)
        {
            if (emerarr != null && emerarr.Count > 0)
            {
                foreach (var item in emerarr)
                {
                    var objemer = _Util.Facade.EmergencyContactFacade.GetEmergencyContactById(item.Id);
                    if (objemer != null)
                    {
                        objemer.OrderBy = item.OrderBy;
                        _Util.Facade.EmergencyContactFacade.UpdateEmergencyContact(objemer);
                    }
                }
            }
            return Json(true);
        }

        public ActionResult LoadCustomerACHPaymentInfo(Guid? customerid)
        {
            List<PaymentInfo> model = new List<PaymentInfo>();
            if (customerid.HasValue && customerid.Value != new Guid())
            {
                var objcus = _Util.Facade.CustomerFacade.GetCustomerByCustomerId(customerid.Value);
                if (objcus != null)
                {
                    var objpayprofile = _Util.Facade.PaymentInfoCustomerFacade.GetAllPaymentProfileCustomerByCustomerIdAndProfileType(customerid.Value, "ACH_");
                    if (objpayprofile != null && objpayprofile.Count > 0)
                    {
                        foreach (var item in objpayprofile)
                        {
                            var objpayment = _Util.Facade.PaymentInfoFacade.GetPaymentInfoById(item.PaymentInfoId);
                            if (objpayment != null)
                            {
                                var objlookupBankAccountType = _Util.Facade.LookupFacade.GetDisplayTextByDataKeyAndDataValue("BankAccountType", objpayment.BankAccountType);
                                if (objlookupBankAccountType != null)
                                {
                                    objpayment.BankAccountType = objlookupBankAccountType.DisplayText;
                                }
                                var objlookupeCheckType = _Util.Facade.LookupFacade.GetDisplayTextByDataKeyAndDataValue("ECheckType", objpayment.EcheckType);
                                if (objlookupeCheckType != null)
                                {
                                    objpayment.EcheckType = objlookupeCheckType.DisplayText;
                                }
                            }
                            model.Add(objpayment);
                        }
                    }
                }
                ViewBag.customerid = customerid.Value;
            }
            //model=model.GroupBy(x => x.AcountNo,(key,x)=>x.FirstOrDefault()).ToList();
            return View(model);
        }

        public ActionResult LoadCustomerCCPaymentInfo(Guid? customerid)
        {
            List<PaymentInfo> model = new List<PaymentInfo>();
            if (customerid.HasValue && customerid.Value != new Guid())
            {
                var objcus = _Util.Facade.CustomerFacade.GetCustomerByCustomerId(customerid.Value);
                if (objcus != null)
                {
                    var objpayprofile = _Util.Facade.PaymentInfoCustomerFacade.GetAllPaymentProfileCustomerByCustomerIdAndProfileType(customerid.Value, "CC_");
                    if (objpayprofile != null && objpayprofile.Count > 0)
                    {
                        foreach (var item in objpayprofile)
                        {
                            model.Add(_Util.Facade.PaymentInfoFacade.GetPaymentInfoById(item.PaymentInfoId));

                        }
                    }

                }

                ViewBag.customerid = customerid.Value;

            }
            return View(model);


        }

        [HttpPost]
        public JsonResult TransferCustomerToLead(Guid? CustomerId, List<string> ServiceList, List<string> EquipmentList, string BusinessName, string DBA, string FirstName, string LastName)
        {
            var currentLoggedIn = ((HS.Web.UI.Helper.CustomPrincipal)(User));
            bool result = false;
            bool agreement = false;
            PackageCustomer objpc = new PackageCustomer();
            Customer model = new Customer();
            if (CustomerId.HasValue && CustomerId.Value != new Guid())
            {
                var objcus = _Util.Facade.CustomerFacade.GetCustomerByCustomerId(CustomerId.Value);
                if (objcus != null)
                {
                    agreement = objcus.IsAgreement.HasValue ? objcus.IsAgreement.Value : false;
                    model.CustomerId = Guid.NewGuid();
                    model.FirstName = FirstName;
                    model.LastName = LastName;
                    model.BusinessName = BusinessName;
                    model.DBA = DBA;
                    model.Type = objcus.Type;
                    model.Address = objcus.Address;
                    model.Address2 = "";
                    model.Street = objcus.Street;
                    model.StreetPrevious = "";
                    model.City = objcus.City;
                    model.CityPrevious = "";
                    model.State = objcus.State;
                    model.StatePrevious = "";
                    model.ZipCode = objcus.ZipCode;
                    model.ZipCodePrevious = "";
                    model.JoinDate = DateTime.Now.UTCCurrentTime();
                    model.Soldby = currentLoggedIn.UserId.ToString();
                    model.Soldby1 = currentLoggedIn.UserId;
                    model.Installer = objcus.Installer;
                    model.Status = objcus.Status;
                    model.SecondCustomerNo = "";
                    model.AdditionalCustomerNo = objcus.AdditionalCustomerNo;
                    model.IsActive = true;
                    model.CreatedByUid = currentLoggedIn.UserId;
                    model.CreatedDate = DateTime.Now.UTCCurrentTime();
                    model.LastUpdatedBy = currentLoggedIn.Identity.Name;
                    model.LastUpdatedByUid = currentLoggedIn.UserId;
                    model.LastUpdatedDate = DateTime.Now.UTCCurrentTime();
                    model.TransferCustomerId = objcus.Id;
                    model.County = objcus.County;
                    model.AlarmRefId = "";
                    model.IsAlarmCom = false;
                    model.InstallDate = null;
                    model.LeadSource = "TRANS";
                    model.Singature = "";
                    model.AccountNo = "";
                    model.UCCRefId = "";
                    model.AlarmRefId = "";
                    model.BrinksRefId = "";
                    model.CustomerNo = "";
                    result = _Util.Facade.CustomerFacade.InsertCustomer(model) > 0;

                    SendCancellationAgreement(objcus.CustomerId);
                }
                if (result)
                {
                    CustomerExtended extended = new CustomerExtended()
                    {
                        CustomerId = model.CustomerId
                    };
                    _Util.Facade.CustomerFacade.InsertCustomerExtended(extended);

                    CustomerCompany objcuscom = new CustomerCompany()
                    {
                        CustomerId = model.CustomerId,
                        CompanyId = currentLoggedIn.CompanyId.Value,
                        IsLead = true,
                        IsActive = true
                    };
                    _Util.Facade.CustomerFacade.InsertCustomerCompany(objcuscom);
                    #region New Customer Package, Equipment
                    var objcustomer = _Util.Facade.CustomerFacade.GetCustomerById(model.TransferCustomerId.Value);
                    var objpackagecustomer = _Util.Facade.PackageFacade.GetPackageCustomerByCustomerId(objcustomer.CustomerId);
                    if (objpackagecustomer == null)
                    {
                        objpackagecustomer = new PackageCustomer()
                        {
                            CompanyId = objcuscom.CompanyId,
                            SmartSystemTypeId = 3,
                            SmartInstallTypeId = 1,
                            ManufacturerId = Guid.Parse("264f63d7-e6fb-4337-a6eb-0c972c911cfa")
                        };
                    }
                    #region Package Update
                    objpc = new PackageCustomer()
                    {
                        CompanyId = objpackagecustomer.CompanyId,
                        CustomerId = model.CustomerId,
                        PackageId = objpackagecustomer.PackageId,
                        SmartSystemTypeId = objpackagecustomer.SmartSystemTypeId,
                        SmartInstallTypeId = objpackagecustomer.SmartInstallTypeId,
                        ManufacturerId = objpackagecustomer.ManufacturerId,
                        NonConformingFee = 0.0,
                        ActivationFee = 0.0,
                        WarrentyAvailable = objpackagecustomer.WarrentyAvailable
                    };
                    _Util.Facade.PackageFacade.InsertPackageCustomer(objpc);
                    var objsmartpack = _Util.Facade.SmartPackageFacade.GetSmartPackageBySystemTypeIdAndInstallIdAndManufacturerId(objpc.SmartSystemTypeId.Value, objpc.SmartInstallTypeId.Value, objpc.ManufacturerId, objcustomer.Type);
                    if (objsmartpack != null)
                    {
                        objpc.PackageId = objsmartpack.PackageId;
                        _Util.Facade.PackageFacade.UpdatePackageCustomer(objpc);
                    }
                    if (ServiceList == null)
                    {
                        model.SmartSetUpStep = 2;
                        _Util.Facade.CustomerFacade.UpdateCustomer(model);
                    }
                    else if (EquipmentList == null)
                    {
                        model.SmartSetUpStep = 3;
                        _Util.Facade.CustomerFacade.UpdateCustomer(model);
                    }
                    else
                    {
                        model.SmartSetUpStep = 4;
                        _Util.Facade.CustomerFacade.UpdateCustomer(model);
                    }
                    #endregion
                    if (ServiceList != null && ServiceList.Count > 0)
                    {
                        foreach (var item in ServiceList)
                        {
                            var objservice = _Util.Facade.CustomerAppoinmentFacade.GetCustomerAppointmentEquipmentById(Convert.ToInt32(item));
                            var objpackageservice = _Util.Facade.PackageFacade.GetPackageCustomerServiceByCustomerIdAndPackageIdAndEquipmentId(objpackagecustomer.PackageId, objcustomer.CustomerId, objservice.EquipmentId);
                            if (objpackageservice != null)
                            {
                                CustomerPackageService objcps = new CustomerPackageService()
                                {
                                    CompanyId = currentLoggedIn.CompanyId.Value,
                                    CustomerId = model.CustomerId,
                                    PackageId = objpackageservice.PackageId,
                                    EquipmentId = objpackageservice.EquipmentId,
                                    MonthlyRate = objpackageservice.MonthlyRate,
                                    DiscountRate = 0.0,
                                    Total = objpackageservice.Total,
                                    ManufacturerId = objpackageservice.ManufacturerId,
                                    LocationId = objpackageservice.LocationId,
                                    TypeId = objpackageservice.TypeId,
                                    ModelId = objpackageservice.ModelId,
                                    FinishId = objpackageservice.FinishId,
                                    CapacityId = objpackageservice.CapacityId
                                };
                                _Util.Facade.PackageFacade.InsertCustomerPackageService(objcps);
                            }
                            else
                            {
                                CustomerPackageService objcps = new CustomerPackageService()
                                {
                                    CompanyId = currentLoggedIn.CompanyId.Value,
                                    CustomerId = model.CustomerId,
                                    PackageId = objpc.PackageId,
                                    EquipmentId = objservice.EquipmentId,
                                    MonthlyRate = objservice.UnitPrice,
                                    DiscountRate = 0.0,
                                    Total = objservice.TotalPrice,
                                    ManufacturerId = new Guid(),
                                    LocationId = new Guid(),
                                    TypeId = new Guid(),
                                    ModelId = new Guid(),
                                    FinishId = new Guid(),
                                    CapacityId = new Guid()
                                };
                                _Util.Facade.PackageFacade.InsertCustomerPackageService(objcps);
                            }
                        }
                    }
                    if (EquipmentList != null && EquipmentList.Count > 0)
                    {
                        foreach (var item in EquipmentList)
                        {
                            var objequipment = _Util.Facade.CustomerAppoinmentFacade.GetCustomerAppointmentEquipmentById(Convert.ToInt32(item));
                            var objpackageequipment = _Util.Facade.PackageFacade.GetPackageCustomerEqpByCustomerIdAndPackageIdAndEquipmentId(objpackagecustomer.PackageId, objcustomer.CustomerId, objequipment.EquipmentId);
                            if (objpackageequipment != null)
                            {
                                CustomerPackageEqp objeqp = new CustomerPackageEqp()
                                {
                                    CompanyId = currentLoggedIn.CompanyId.Value,
                                    CustomerId = model.CustomerId,
                                    PackageId = objpackagecustomer.PackageId,
                                    EquipmentId = objpackageequipment.EquipmentId,
                                    IsIncluded = objpackageequipment.IsIncluded,
                                    IsDevice = objpackageequipment.IsDevice,
                                    IsOptionalEqp = objpackageequipment.IsOptionalEqp,
                                    Quantity = objpackageequipment.Quantity,
                                    UnitPrice = objpackageequipment.UnitPrice,
                                    DiscountUnitPricce = objpackageequipment.DiscountUnitPricce,
                                    DiscountPckage = objpackageequipment.DiscountPckage,
                                    Total = objpackageequipment.Total,
                                    IsServiceEquipment = objpackageequipment.IsServiceEquipment,
                                    ServiceId = objpackageequipment.ServiceId,
                                    IsTransfered = true,

                                    IsEqpExist = true,
                                    IsNonCommissionable = objequipment.IsNonCommissionable
                                };
                                _Util.Facade.PackageFacade.InsertCustomerPackageEqp(objeqp);
                            }
                            else
                            {
                                CustomerPackageEqp objeqp = new CustomerPackageEqp()
                                {
                                    CompanyId = currentLoggedIn.CompanyId.Value,
                                    CustomerId = model.CustomerId,
                                    PackageId = objpackagecustomer.PackageId,
                                    EquipmentId = objequipment.EquipmentId,
                                    IsIncluded = false,
                                    IsDevice = false,
                                    IsOptionalEqp = false,
                                    Quantity = objequipment.Quantity,
                                    UnitPrice = 0.0,
                                    DiscountUnitPricce = 0.0,
                                    DiscountPckage = 0.0,
                                    Total = 0.0,
                                    IsServiceEquipment = false,
                                    ServiceId = new Guid(),
                                    IsTransfered = true,
                                    IsEqpExist = true,
                                    IsNonCommissionable = objequipment.IsNonCommissionable
                                };
                                _Util.Facade.PackageFacade.InsertCustomerPackageEqp(objeqp);
                            }
                        }
                    }
                    #endregion
                    base.AddUserActivityForCustomer("Customer is Transferred to Lead #" + model.Id + " by " + currentLoggedIn.FirstName + " " + currentLoggedIn.LastName, LabelHelper.ActivityAction.Transfer, CustomerId, null, null);

                }
            }
            return Json(new
            {
                result = result,
                id = model.Id
            });
        }

        [HttpPost]
        public JsonResult CloseViewedCustomerRecent(int? viewid, DateTime visitdate)
        {
            bool result = false;
            if (viewid.HasValue && viewid.Value > 0)
            {
                var objcus = _Util.Facade.CustomerFacade.GetCustomerById(viewid.Value);
                if (objcus != null)
                {
                    var objviewcus = _Util.Facade.CustomerFacade.GetAllCustomerViewByCustomerId(objcus.CustomerId, visitdate);
                    if (objviewcus != null && objviewcus.Count > 0)
                    {
                        foreach (var item in objviewcus)
                        {
                            result = _Util.Facade.CustomerFacade.DeleteCustomerViewById(item.Id);
                        }
                    }
                }
            }
            return Json(result);
        }
        [Authorize]
        public ActionResult LoadCustomerInspection(Guid CustomerId)
        {
            CustomerInfoWithCompany cusCom = new CustomerInfoWithCompany();
            var currentLoggedIn = ((HS.Web.UI.Helper.CustomPrincipal)(User));
            if (currentLoggedIn == null)
            {
                return PartialView("~/Views/Shared/_AccessDenied.cshtml");
            }
            CustomerInspection model = _Util.Facade.CustomerInspectionFacade.GetCustomerInspectionByCustomerId(CustomerId);
            if (model == null)
            {
                model = new CustomerInspection();
                model.CustomerId = CustomerId;
                model.CompanyId = currentLoggedIn.CompanyId.Value;
                model.CreatedDate = DateTime.UtcNow;
                model.PMSignatureDate = DateTime.UtcNow;
                model.HomeOwnerSignatureDate = DateTime.UtcNow;
            }
            model.OutsideRelativeHumidity = Math.Round(model.OutsideRelativeHumidity, 2);
            model.OutsideTemperature = Math.Round(model.OutsideTemperature, 2);
            if (CustomerId != null)
            {
                cusCom = _Util.Facade.CustomerFacade.GetCustomerInfoWithCompanyByCustomerId(CustomerId);
                model.CusId = cusCom.CusId;
                model.customerFirstName = cusCom.customerFirstName;
                model.customerLastName = cusCom.customerLastName;
                model.customerStreet = cusCom.customerStreet;
                model.customerCity = cusCom.customerCity;
                model.customerState = cusCom.customerState;
                model.customerZipCode = cusCom.customerZipCode;
                model.customerEmail = cusCom.customerEmail;
                model.customerPrimaryPhone = cusCom.customerPrimaryPhone;
                model.customerSecondaryPhone = cusCom.customerSecondaryPhone;
                model.customerAddress = cusCom.customerAddress;
                model.companyName = cusCom.companyName;
                model.companyLogo = cusCom.companyLogo;
                model.companyStreet = cusCom.companyStreet;
                model.companyCity = cusCom.companyCity;
                model.companyState = cusCom.companyState;
                model.companyZipCode = cusCom.companyZipCode;
                model.companyEmail = cusCom.companyEmail;
                model.companyFax = cusCom.companyFax;
                model.companyPhone = cusCom.companyPhone;
                model.companyAddress = cusCom.companyAddress;
            }

            ViewBag.CurrentOutsideConditions = _Util.Facade.LookupFacade.GetLookupByKey("CurrentOutsideConditions").Select(x =>
                         new SelectListItem()
                         {
                             Text = x.DisplayText.ToString(),
                             Value = x.DataValue.ToString()
                         }).ToList();
            ViewBag.Heat = _Util.Facade.LookupFacade.GetLookupByKey("Heat").Select(x =>
                         new SelectListItem()
                         {
                             Text = x.DisplayText.ToString(),
                             Value = x.DataValue.ToString()
                         }).ToList();
            ViewBag.Air = _Util.Facade.LookupFacade.GetLookupByKey("Air").Select(x =>
                         new SelectListItem()
                         {
                             Text = x.DisplayText.ToString(),
                             Value = x.DataValue.ToString()
                         }).ToList();
            ViewBag.BasementDehumidifier = _Util.Facade.LookupFacade.GetLookupByKey("BasementDehumidifier").Select(x =>
                         new SelectListItem()
                         {
                             Text = x.DisplayText.ToString(),
                             Value = x.DataValue.ToString()
                         }).ToList();
            ViewBag.Rating = _Util.Facade.LookupFacade.GetLookupByKey("Rating").Select(x =>
                         new SelectListItem()
                         {
                             Text = x.DisplayText.ToString(),
                             Value = x.DataValue.ToString()
                         }).ToList();
            ViewBag.YesNo = _Util.Facade.LookupFacade.GetLookupByKey("YesNo").Select(x =>
                         new SelectListItem()
                         {
                             Text = x.DisplayText.ToString(),
                             Value = x.DataValue.ToString()
                         }).ToList();
            ViewBag.FoundationType = _Util.Facade.LookupFacade.GetLookupByKey("FoundationType").Select(x =>
                         new SelectListItem()
                         {
                             Text = x.DisplayText.ToString(),
                             Value = x.DataValue.ToString()
                         }).ToList();
            ViewBag.GoDownBasement = _Util.Facade.LookupFacade.GetLookupByKey("GoDownBasement").Select(x =>
                         new SelectListItem()
                         {
                             Text = x.DisplayText.ToString(),
                             Value = x.DataValue.ToString()
                         }).ToList();
            ViewBag.RemoveWater = _Util.Facade.LookupFacade.GetLookupByKey("RemoveWater").Select(x =>
                         new SelectListItem()
                         {
                             Text = x.DisplayText.ToString(),
                             Value = x.DataValue.ToString()
                         }).ToList();
            ViewBag.BasementPlans = _Util.Facade.LookupFacade.GetLookupByKey("BasementPlans").Select(x =>
                         new SelectListItem()
                         {
                             Text = x.DisplayText.ToString(),
                             Value = x.DataValue.ToString()
                         }).ToList();
            ViewBag.LosePower = _Util.Facade.LookupFacade.GetLookupByKey("LosePower").Select(x =>
                         new SelectListItem()
                         {
                             Text = x.DisplayText.ToString(),
                             Value = x.DataValue.ToString()
                         }).ToList();

            return View(model);
        }
        [Authorize]
        [HttpPost]
        public JsonResult AddCustomerInspection(CustomerInspection ci)
        {
            if (!base.IsPermitted(UserPermissions.CustomerPermissions.CustomerInspection))
            {
                return Json(new
                {
                    result = false,
                    customerid = ci.CusId,
                    message = "Access denied."
                });
            }
            var currentLoggedIn = ((HS.Web.UI.Helper.CustomPrincipal)(User));
            ci.LastUpdatedBy = currentLoggedIn.UserId;
            ci.LastUpdatedDate = DateTime.Now.UTCCurrentTime();
            if (!currentLoggedIn.CompanyId.HasValue && currentLoggedIn.UserId == null)
            {
                return Json(new
                {
                    result = false,
                    customerid = ci.CusId,
                    message = "Access denied."
                });
            }
            UserLogin user = _Util.Facade.UserLoginFacade.GetUserLoginByUserId(currentLoggedIn.UserId);

            try
            {
                #region save signature file
                //[NOTE:Null canvas value=data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAASwAAACWCAYAAABkW7XSAAAEYklEQVR4Xu3UAQkAAAwCwdm/9HI83BLIOdw5AgQIRAQWySkmAQIEzmB5AgIEMgIGK1OVoAQIGCw/QIBARsBgZaoSlAABg+UHCBDICBisTFWCEiBgsPwAAQIZAYOVqUpQAgQMlh8gQCAjYLAyVQlKgIDB8gMECGQEDFamKkEJEDBYfoAAgYyAwcpUJSgBAgbLDxAgkBEwWJmqBCVAwGD5AQIEMgIGK1OVoAQIGCw/QIBARsBgZaoSlAABg+UHCBDICBisTFWCEiBgsPwAAQIZAYOVqUpQAgQMlh8gQCAjYLAyVQlKgIDB8gMECGQEDFamKkEJEDBYfoAAgYyAwcpUJSgBAgbLDxAgkBEwWJmqBCVAwGD5AQIEMgIGK1OVoAQIGCw/QIBARsBgZaoSlAABg+UHCBDICBisTFWCEiBgsPwAAQIZAYOVqUpQAgQMlh8gQCAjYLAyVQlKgIDB8gMECGQEDFamKkEJEDBYfoAAgYyAwcpUJSgBAgbLDxAgkBEwWJmqBCVAwGD5AQIEMgIGK1OVoAQIGCw/QIBARsBgZaoSlAABg+UHCBDICBisTFWCEiBgsPwAAQIZAYOVqUpQAgQMlh8gQCAjYLAyVQlKgIDB8gMECGQEDFamKkEJEDBYfoAAgYyAwcpUJSgBAgbLDxAgkBEwWJmqBCVAwGD5AQIEMgIGK1OVoAQIGCw/QIBARsBgZaoSlAABg+UHCBDICBisTFWCEiBgsPwAAQIZAYOVqUpQAgQMlh8gQCAjYLAyVQlKgIDB8gMECGQEDFamKkEJEDBYfoAAgYyAwcpUJSgBAgbLDxAgkBEwWJmqBCVAwGD5AQIEMgIGK1OVoAQIGCw/QIBARsBgZaoSlAABg+UHCBDICBisTFWCEiBgsPwAAQIZAYOVqUpQAgQMlh8gQCAjYLAyVQlKgIDB8gMECGQEDFamKkEJEDBYfoAAgYyAwcpUJSgBAgbLDxAgkBEwWJmqBCVAwGD5AQIEMgIGK1OVoAQIGCw/QIBARsBgZaoSlAABg+UHCBDICBisTFWCEiBgsPwAAQIZAYOVqUpQAgQMlh8gQCAjYLAyVQlKgIDB8gMECGQEDFamKkEJEDBYfoAAgYyAwcpUJSgBAgbLDxAgkBEwWJmqBCVAwGD5AQIEMgIGK1OVoAQIGCw/QIBARsBgZaoSlAABg+UHCBDICBisTFWCEiBgsPwAAQIZAYOVqUpQAgQMlh8gQCAjYLAyVQlKgIDB8gMECGQEDFamKkEJEDBYfoAAgYyAwcpUJSgBAgbLDxAgkBEwWJmqBCVAwGD5AQIEMgIGK1OVoAQIGCw/QIBARsBgZaoSlAABg+UHCBDICBisTFWCEiBgsPwAAQIZAYOVqUpQAgQMlh8gQCAjYLAyVQlKgIDB8gMECGQEDFamKkEJEDBYfoAAgYyAwcpUJSgBAgbLDxAgkBEwWJmqBCVAwGD5AQIEMgIGK1OVoAQIGCw/QIBARsBgZaoSlACBB1YxAJfjJb2jAAAAAElFTkSuQmCC]
                string emptyCanvas = "data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAASwAAACWCAYAAABkW7XSAAAEYklEQVR4Xu3UAQkAAAwCwdm/9HI83BLIOdw5AgQIRAQWySkmAQIEzmB5AgIEMgIGK1OVoAQIGCw/QIBARsBgZaoSlAABg+UHCBDICBisTFWCEiBgsPwAAQIZAYOVqUpQAgQMlh8gQCAjYLAyVQlKgIDB8gMECGQEDFamKkEJEDBYfoAAgYyAwcpUJSgBAgbLDxAgkBEwWJmqBCVAwGD5AQIEMgIGK1OVoAQIGCw/QIBARsBgZaoSlAABg+UHCBDICBisTFWCEiBgsPwAAQIZAYOVqUpQAgQMlh8gQCAjYLAyVQlKgIDB8gMECGQEDFamKkEJEDBYfoAAgYyAwcpUJSgBAgbLDxAgkBEwWJmqBCVAwGD5AQIEMgIGK1OVoAQIGCw/QIBARsBgZaoSlAABg+UHCBDICBisTFWCEiBgsPwAAQIZAYOVqUpQAgQMlh8gQCAjYLAyVQlKgIDB8gMECGQEDFamKkEJEDBYfoAAgYyAwcpUJSgBAgbLDxAgkBEwWJmqBCVAwGD5AQIEMgIGK1OVoAQIGCw/QIBARsBgZaoSlAABg+UHCBDICBisTFWCEiBgsPwAAQIZAYOVqUpQAgQMlh8gQCAjYLAyVQlKgIDB8gMECGQEDFamKkEJEDBYfoAAgYyAwcpUJSgBAgbLDxAgkBEwWJmqBCVAwGD5AQIEMgIGK1OVoAQIGCw/QIBARsBgZaoSlAABg+UHCBDICBisTFWCEiBgsPwAAQIZAYOVqUpQAgQMlh8gQCAjYLAyVQlKgIDB8gMECGQEDFamKkEJEDBYfoAAgYyAwcpUJSgBAgbLDxAgkBEwWJmqBCVAwGD5AQIEMgIGK1OVoAQIGCw/QIBARsBgZaoSlAABg+UHCBDICBisTFWCEiBgsPwAAQIZAYOVqUpQAgQMlh8gQCAjYLAyVQlKgIDB8gMECGQEDFamKkEJEDBYfoAAgYyAwcpUJSgBAgbLDxAgkBEwWJmqBCVAwGD5AQIEMgIGK1OVoAQIGCw/QIBARsBgZaoSlAABg+UHCBDICBisTFWCEiBgsPwAAQIZAYOVqUpQAgQMlh8gQCAjYLAyVQlKgIDB8gMECGQEDFamKkEJEDBYfoAAgYyAwcpUJSgBAgbLDxAgkBEwWJmqBCVAwGD5AQIEMgIGK1OVoAQIGCw/QIBARsBgZaoSlAABg+UHCBDICBisTFWCEiBgsPwAAQIZAYOVqUpQAgQMlh8gQCAjYLAyVQlKgIDB8gMECGQEDFamKkEJEDBYfoAAgYyAwcpUJSgBAgbLDxAgkBEwWJmqBCVAwGD5AQIEMgIGK1OVoAQIGCw/QIBARsBgZaoSlAABg+UHCBDICBisTFWCEiBgsPwAAQIZAYOVqUpQAgQMlh8gQCAjYLAyVQlKgIDB8gMECGQEDFamKkEJEDBYfoAAgYyAwcpUJSgBAgbLDxAgkBEwWJmqBCVAwGD5AQIEMgIGK1OVoAQIGCw/QIBARsBgZaoSlACBB1YxAJfjJb2jAAAAAElFTkSuQmCC";
                string filePathpm = ci.PMSignatureImagePath;
                string filePathhw = ci.HomeOwnerSignatureImagePath;
                string filePathdr = ci.DrawingImagePath;
                if (ci.PMSignatureImagePath != null && ci.PMSignature != emptyCanvas)
                {
                    var oldServerFilepm = Server.MapPath(ci.PMSignatureImagePath);
                    if (System.IO.File.Exists(oldServerFilepm))
                    {
                        System.IO.File.Delete(oldServerFilepm);
                    }
                }
                if (ci.HomeOwnerSignatureImagePath != null && ci.HomeOwnerSignature != emptyCanvas)
                {
                    var oldServerFilehw = Server.MapPath(ci.HomeOwnerSignatureImagePath);
                    if (System.IO.File.Exists(oldServerFilehw))
                    {
                        System.IO.File.Delete(oldServerFilehw);
                    }
                }
                if (ci.DrawingImagePath != null && ci.Drawing != emptyCanvas)
                {
                    var oldServerFiledr = Server.MapPath(ci.DrawingImagePath);
                    if (System.IO.File.Exists(oldServerFiledr))
                    {
                        System.IO.File.Delete(oldServerFiledr);
                    }
                }
                if (ci.PMSignature != emptyCanvas)
                {
                    string[] datasplitpm = ci.PMSignature.Split(',');
                    byte[] bytespm = Convert.FromBase64String(datasplitpm[1]);
                    Image imagepm;
                    using (MemoryStream ms = new MemoryStream(bytespm))
                    {
                        imagepm = Image.FromStream(ms);
                        string tempFolder = ConfigurationManager.AppSettings["File.SupervisorSignatureFile"];
                        var comname = _Util.Facade.CompanyFacade.GetCompanyByComapnyId(currentLoggedIn.CompanyId.Value).CompanyName.ReplaceSpecialChar();
                        var FtempFolderName = string.Format(tempFolder, comname) + user.Id + "Signature";
                        Random rand = new Random();
                        string FileName = rand.Next().ToString();
                        FileName += "-___" + "Signature.png";
                        string tempFolderPath = Server.MapPath("~/" + FtempFolderName);

                        if (FileHelper.CreateFolderIfNeeded(tempFolderPath))
                        {
                            try
                            {
                                imagepm.Save(Path.Combine(tempFolderPath, FileName));
                            }
                            catch (Exception)
                            {

                            }
                        }
                        filePathpm = string.Concat("/", FtempFolderName, "/", FileName);
                    }
                }
                if (ci.HomeOwnerSignature != emptyCanvas)
                {
                    string[] datasplithw = ci.HomeOwnerSignature.Split(',');
                    byte[] byteshw = Convert.FromBase64String(datasplithw[1]);
                    Image imagehw;
                    using (MemoryStream ms = new MemoryStream(byteshw))
                    {
                        imagehw = Image.FromStream(ms);
                        string tempFolder = ConfigurationManager.AppSettings["File.CustomerSignatureFile"];
                        var comname = _Util.Facade.CompanyFacade.GetCompanyByComapnyId(currentLoggedIn.CompanyId.Value).CompanyName.ReplaceSpecialChar();
                        var FtempFolderName = string.Format(tempFolder, comname) + ci.CusId + "Signature";
                        Random rand = new Random();
                        string FileName = rand.Next().ToString();
                        FileName += "-___" + "Signature.png";
                        string tempFolderPath = Server.MapPath("~/" + FtempFolderName);

                        if (FileHelper.CreateFolderIfNeeded(tempFolderPath))
                        {
                            try
                            {
                                imagehw.Save(Path.Combine(tempFolderPath, FileName));
                            }
                            catch (Exception)
                            {

                            }
                        }
                        filePathhw = string.Concat("/", FtempFolderName, "/", FileName);
                    }
                }
                if (ci.Drawing != emptyCanvas)
                {
                    string[] datasplitdr = ci.Drawing.Split(',');
                    byte[] bytesdr = Convert.FromBase64String(datasplitdr[1]);
                    Image imagedr;
                    using (MemoryStream ms = new MemoryStream(bytesdr))
                    {
                        imagedr = Image.FromStream(ms);
                        string tempFolder = ConfigurationManager.AppSettings["File.CustomerBasementDrawingFile"];
                        var comname = _Util.Facade.CompanyFacade.GetCompanyByComapnyId(currentLoggedIn.CompanyId.Value).CompanyName.ReplaceSpecialChar();
                        var FtempFolderName = string.Format(tempFolder, comname) + ci.CusId + "Drawing";
                        Random rand = new Random();
                        string FileName = rand.Next().ToString();
                        FileName += "-___" + "Drawing.png";
                        string tempFolderPath = Server.MapPath("~/" + FtempFolderName);

                        if (FileHelper.CreateFolderIfNeeded(tempFolderPath))
                        {
                            try
                            {
                                imagedr.Save(Path.Combine(tempFolderPath, FileName));
                            }
                            catch (Exception)
                            {

                            }
                        }
                        filePathdr = string.Concat("/", FtempFolderName, "/", FileName);
                    }
                }
                #endregion

                ci.PMSignature = filePathpm;
                ci.HomeOwnerSignature = filePathhw;
                ci.Drawing = filePathdr;
                #region Edit Customer Inspection
                if (ci.Id > 0)
                {
                    _Util.Facade.CustomerInspectionFacade.UpdateCustomerInspection(ci);
                    return Json(new
                    {
                        result = true,
                        customerid = ci.CusId
                    });
                }
                #endregion

                #region Insert New Customer Inspection
                else
                {
                    ci.CreatedDate = DateTime.Now.UTCCurrentTime();
                    ci.CreatedBy = currentLoggedIn.UserId;

                    _Util.Facade.CustomerInspectionFacade.InsertCustomerInspection(ci);
                    return Json(new
                    {
                        result = true,
                        customerid = ci.CusId
                    });
                }
                #endregion

            }
            catch (Exception ex)
            {
                return Json(new
                {
                    result = false,
                    customerid = ci.CusId,
                    message = "Customer inspection added Failed"
                });
            }
        }
        [HttpPost]
        public JsonResult SaveRefundCreditAmount(double? value, Guid customerid, string invid, string note)
        {
            var currentLoggedIn = ((HS.Web.UI.Helper.CustomPrincipal)(User));
            bool result = false;
            if (value.HasValue && value.Value > 0)
            {
                var objtransaction = _Util.Facade.TransactionFacade.GetTransactionByCustomerIdAndInvoiceId(customerid, invid);
                if (objtransaction != null)
                {
                    objtransaction.Status = "Refund";
                    objtransaction.PaymentMethod = "Refund";
                    objtransaction.Amount = -value.Value;
                    objtransaction.Note = note;
                    objtransaction.AddedBy = currentLoggedIn.Identity.Name;
                    objtransaction.AddedDate = DateTime.Now.UTCCurrentTime();
                    objtransaction.CreatedBy = currentLoggedIn.UserId;
                    objtransaction.TransacationDate = DateTime.Now.UTCCurrentTime();
                    result = _Util.Facade.TransactionFacade.InsertTransaction(objtransaction) > 0;
                }
                var objinv = _Util.Facade.InvoiceFacade.GetInvoiceByInvoiceId(invid);
                if (objinv != null)
                {
                    string TempStatus = objinv.Status;

                    if (value.Value == Convert.ToDouble(LabelHelper.FormatAmount(objinv.TotalAmount - objinv.BalanceDue)))
                    {
                        objinv.BalanceDue += value.Value;
                        objinv.Status = LabelHelper.InvoiceStatus.Open;
                        result = _Util.Facade.InvoiceFacade.UpdateInvoice(objinv);

                        #region log
                        int lineNumber = (new System.Diagnostics.StackFrame(0, true)).GetFileLineNumber();
                        string actionName = this.ControllerContext.RouteData.Values["action"].ToString();
                        string controllerName = this.ControllerContext.RouteData.Values["controller"].ToString();
                        bool newBool = objinv.IsARBInvoice ?? false;
                        base.AddUserActivityForCustomer("Invoice Status Changed from " + TempStatus + " To " + objinv.Status + "#InvoiceId: " + objinv.InvoiceId, lineNumber + "," + actionName + "/" + controllerName, objinv.CustomerId, null, null, newBool);
                        #endregion
                    }
                    else
                    {
                        objinv.BalanceDue += value.Value;
                        objinv.Status = LabelHelper.InvoiceStatus.Partial;
                        result = _Util.Facade.InvoiceFacade.UpdateInvoice(objinv);

                        #region log
                        int lineNumber = (new System.Diagnostics.StackFrame(0, true)).GetFileLineNumber();
                        string actionName = this.ControllerContext.RouteData.Values["action"].ToString();
                        string controllerName = this.ControllerContext.RouteData.Values["controller"].ToString();
                        bool newBool = objinv.IsARBInvoice ?? false;
                        base.AddUserActivityForCustomer("Invoice Status Changed from " + TempStatus + " To " + objinv.Status + "#InvoiceId: " + objinv.InvoiceId, lineNumber + "," + actionName + "/" + controllerName, objinv.CustomerId, null, null, newBool);
                        #endregion
                    }
                    TransactionHistory history = new TransactionHistory()
                    {
                        TransactionId = objtransaction.Id,
                        InvoiceId = objinv.Id,
                        Amout = -value.Value,
                        Balance = objinv.TotalAmount.HasValue ? objinv.TotalAmount.Value : 0,
                        ReceivedBy = currentLoggedIn.UserId
                    };
                    _Util.Facade.TransactionFacade.InsertTransactionHistory(history);
                    base.AddUserActivityForCustomer(value.Value + "$ Refunded for " + objinv.InvoiceId, LabelHelper.ActivityAction.RefundOrCredit, customerid, null, null);
                }
            }
            return Json(result);
        }

        [HttpPost]
        public JsonResult SaveAddCreditAmount(double? value, Guid customerid, string invid, string note)
        {
            var currentLoggedIn = ((HS.Web.UI.Helper.CustomPrincipal)(User));
            bool result = false;
            var objinv = _Util.Facade.InvoiceFacade.GetInvoiceByInvoiceId(invid);
            string CustomerCreditNote = "Manually Added";
            if (!string.IsNullOrWhiteSpace(note))
            {
                CustomerCreditNote = note;
            }
            else if (!string.IsNullOrWhiteSpace(invid))
            {
                if (objinv != null)
                {
                    CustomerCreditNote = string.Format(@"Invoice# <a class=""cus-anchor"" href=""javascript:void(0)"" onclick=""OpenInvById('{0}')"">{1}</a>", objinv.Id, objinv.InvoiceId);
                }
                else
                {
                    CustomerCreditNote = "Invoice# " + invid;
                }
            }
            if (value.HasValue && value.Value > 0)
            {
                var objtransaction = _Util.Facade.TransactionFacade.GetTransactionByCustomerIdAndInvoiceId(customerid, invid);
                if (objtransaction != null)
                {
                    objtransaction.Status = "Credit";
                    objtransaction.PaymentMethod = "Credit";
                    objtransaction.Amount = -value.Value;
                    objtransaction.Note = note;
                    objtransaction.AddedBy = currentLoggedIn.Identity.Name;
                    objtransaction.AddedDate = DateTime.Now.UTCCurrentTime();
                    objtransaction.CreatedBy = currentLoggedIn.UserId;
                    objtransaction.TransacationDate = DateTime.Now.UTCCurrentTime();
                    result = _Util.Facade.TransactionFacade.InsertTransaction(objtransaction) > 0;
                }
                else
                {
                    return Json(result);
                }
                CustomerCredit credit = new CustomerCredit()
                {
                    CompanyId = currentLoggedIn.CompanyId.Value,
                    CustomerId = customerid,
                    TransactionId = objtransaction.Id,
                    Type = "Credit",
                    Amount = Math.Round(value.Value, 2),
                    Note = CustomerCreditNote,
                    CreatedBy = currentLoggedIn.UserId,
                    CreatedDate = DateTime.Now.UTCCurrentTime(),
                    IsRefund = false
                };
                result = _Util.Facade.CustomerFacade.InsertCustomerCredit(credit);

                if (objinv != null)
                {
                    string TempStatus = objinv.Status;

                    if (value.Value == Convert.ToDouble(LabelHelper.FormatAmount(objinv.TotalAmount - objinv.BalanceDue)))
                    {
                        objinv.BalanceDue += value.Value;
                        objinv.Status = LabelHelper.InvoiceStatus.Open;
                        result = _Util.Facade.InvoiceFacade.UpdateInvoice(objinv);
                        #region log
                        int lineNumber = (new System.Diagnostics.StackFrame(0, true)).GetFileLineNumber();
                        string actionName = this.ControllerContext.RouteData.Values["action"].ToString();
                        string controllerName = this.ControllerContext.RouteData.Values["controller"].ToString();
                        bool newBool = objinv.IsARBInvoice ?? false;
                        base.AddUserActivityForCustomer("Invoice Status Changed from " + TempStatus + " To " + objinv.Status + "#InvoiceId: " + objinv.InvoiceId, lineNumber + "," + actionName + "/" + controllerName, objinv.CustomerId, null, null, newBool);
                        #endregion
                    }
                    else
                    {
                        objinv.BalanceDue += value.Value;
                        objinv.Status = LabelHelper.InvoiceStatus.Partial;
                        result = _Util.Facade.InvoiceFacade.UpdateInvoice(objinv);
                        #region log
                        int lineNumber = (new System.Diagnostics.StackFrame(0, true)).GetFileLineNumber();
                        string actionName = this.ControllerContext.RouteData.Values["action"].ToString();
                        string controllerName = this.ControllerContext.RouteData.Values["controller"].ToString();
                        bool newBool = objinv.IsARBInvoice ?? false;
                        base.AddUserActivityForCustomer("Invoice Status Changed from " + TempStatus + " To " + objinv.Status + "#InvoiceId: " + objinv.InvoiceId, lineNumber + "," + actionName + "/" + controllerName, objinv.CustomerId, null, null, newBool);
                        #endregion
                    }
                    TransactionHistory history = new TransactionHistory()
                    {
                        TransactionId = objtransaction.Id,
                        InvoiceId = objinv.Id,
                        Amout = -value.Value,
                        Balance = objinv.TotalAmount.HasValue ? objinv.TotalAmount.Value : 0,
                        ReceivedBy = currentLoggedIn.UserId
                    };
                    _Util.Facade.TransactionFacade.InsertTransactionHistory(history);
                    base.AddUserActivityForCustomer(value.Value + "$ Credited for " + objinv.InvoiceId, LabelHelper.ActivityAction.RefundOrCredit, customerid, null, null);
                }
            }
            return Json(result);
        }

        [HttpPost]
        public JsonResult SaveCreditAmount(CustomerCredit model)
        {
            bool result = false;
            var currentLoggedIn = ((HS.Web.UI.Helper.CustomPrincipal)(User));
            CustomerCredit CustomerCredit = new CustomerCredit()
            {
                CompanyId = currentLoggedIn.CompanyId.Value,
                CustomerId = model.CustomerId,
                TransactionId = 0,
                Type = "Credit",
                Amount = Math.Round(model.Amount, 2),
                Note = !string.IsNullOrWhiteSpace(model.Note) ? model.Note : "Manually Added",
                CreatedBy = currentLoggedIn.UserId,
                CreatedDate = DateTime.Now.UTCCurrentTime(),
                IsRefund = false,
                CreditReason = model.CreditReason,
                CreditType=model.CreditType,
                IsRMRCredit = model.IsRMRCredit
            };

            result = _Util.Facade.CustomerFacade.InsertCustomerCredit(CustomerCredit);
            string Title = "General";
            if (CustomerCredit.IsRMRCredit == true) { Title = "RMR"; }
            base.AddUserActivityForCustomer(Title + " customer credit amount $" + CustomerCredit.Amount + " is manually added by " + currentLoggedIn.FirstName + " " + currentLoggedIn.LastName, LabelHelper.ActivityAction.AddPayment, CustomerCredit.CustomerId, null, null);

            return Json(result);
        }
        [Authorize]
        [HttpPost]
        public JsonResult DeleteCreditAmount(int Id)
        {
            var currentLoggedIn = ((HS.Web.UI.Helper.CustomPrincipal)(User));
            bool result = false;
            CustomerCredit Credit = _Util.Facade.CustomerFacade.GetCustomerCreditById(Id);
            if (Credit != null)
            {
                string DeletedAmount = Credit.Amount.ToString("N2");
                string Title = "General";
                if (Credit.IsRMRCredit == true) { Title = "RMR"; }
                if (Credit.Type == "Debit") { DeletedAmount = (Credit.Amount * (-1)).ToString("N2"); }
                base.AddUserActivityForCustomer(Title + " customer credit balance type: " + Credit.Type.ToLower() + " amount: $" + DeletedAmount + " is deleted by " + currentLoggedIn.FirstName + " " + currentLoggedIn.LastName, LabelHelper.ActivityAction.Delete, Credit.CustomerId, null, null);
                Credit.IsDeleted = true;
                Credit.Note = "Manually Deleted";
                result = _Util.Facade.CustomerFacade.UpdateCustomerCredit(Credit);
            }
            return Json(result);
        }
        [Authorize]
        public ActionResult FilterCustomerLeadListGridSettingPartial(string key)
        {
            var currentLoggedIn = ((HS.Web.UI.Helper.CustomPrincipal)(User));
            List<GridSetting> model = _Util.Facade.GridSettingsFacade.GetAllFilterSettingByKeyAndCompanyIdAndIsFilter(key, currentLoggedIn.CompanyId.Value);
            #region multipleselect

            CustomerLiteFilter filter = new CustomerLiteFilter();

            List<string> SalesLocation = new List<string>();

            if (!string.IsNullOrWhiteSpace(filter.SalesLocationText))
            {
                string[] SPList = filter.SalesLocationText.Split(',');
                if (SPList != null)
                {
                    foreach (var item in SPList)
                    {
                        SalesLocation.Add(item);
                    }
                }

            }
            ViewBag.SalesLocationList = SalesLocation;


            List<string> LeadSourceList = new List<string>();

            if (!string.IsNullOrWhiteSpace(filter.LeadSourceText))
            {
                string[] sourceList = filter.LeadSourceText.Split(',');
                if (sourceList != null)
                {
                    foreach (var item in sourceList)
                    {
                        LeadSourceList.Add(item);
                    }
                }

            }
            ViewBag.LeadSourceList = LeadSourceList;

            List<string> SalesPerson = new List<string>();

            if (!string.IsNullOrWhiteSpace(filter.SalesPersonText))
            {
                string[] SPList = filter.SalesPersonText.Split(',');
                if (SPList != null)
                {
                    foreach (var item in SPList)
                    {
                        SalesPerson.Add(item);
                    }
                }

            }
            ViewBag.SalesPersonList = SalesPerson;


            List<string> branch = new List<string>();

            if (!string.IsNullOrWhiteSpace(filter.BranchidText))
            {
                string[] SPList = filter.BranchidText.Split(',');
                if (SPList != null)
                {
                    foreach (var item in SPList)
                    {
                        branch.Add(item);
                    }
                }

            }
            ViewBag.BranchIdList = branch;

            List<string> Status = new List<string>();

            if (!string.IsNullOrWhiteSpace(filter.LeadStatusText))
            {
                string[] SPList = filter.LeadStatusText.Split(',');
                if (SPList != null)
                {
                    foreach (var item in SPList)
                    {
                        Status.Add(item);
                    }
                }

            }
            ViewBag.StatusList = Status;

            List<string> CutomerStatus = new List<string>();

            if (!string.IsNullOrWhiteSpace(filter.StatusText))
            {
                string[] SPList = filter.StatusText.Split(',');
                if (SPList != null)
                {
                    foreach (var item in SPList)
                    {
                        CutomerStatus.Add(item);
                    }
                }

            }
            else if (filter.isLead == false)
            {
                string defaultcustomerstatus = "6,42";
                string[] SPList = defaultcustomerstatus.Split(',');
                if (SPList != null)
                {
                    foreach (var item in SPList)
                    {
                        CutomerStatus.Add(item);
                    }
                }
            }
            ViewBag.CustomerStatusList = CutomerStatus;

            #endregion

            foreach (var item in model)
            {
                string columnname = item.SelectedColumn.ToLower();

                switch (columnname)
                {
                    case "type":
                        List<SelectListItem> CustomerType = new List<SelectListItem>();
                        CustomerType.Add(new SelectListItem()
                        {
                            Text = "Please Select One",
                            Value = "-1"
                        });
                        CustomerType.AddRange(_Util.Facade.LookupFacade.GetLookupByKey("CustomerType").Select(x => new SelectListItem()
                        {
                            Text = x.DisplayText.ToString(),
                            Value = x.DataValue.ToString()
                        }).ToList());
                        ViewBag.CustomerType = CustomerType;
                        break;
                    case "leadsource":
                        List<SelectListItem> SourceLead = new List<SelectListItem>();
                        SourceLead.AddRange(_Util.Facade.LookupFacade.GetLookupByKeyWithParent("LeadSource").OrderBy(x => x.DataValue.ToString() != "-1").ThenBy(x => x.DataOrder).Select(x =>
                           new SelectListItem()
                           {
                               Text = x.DisplayText.ToString(),
                               Value = x.DataValue.ToString()
                           }).ToList());
                        ViewBag.SourceLead = SourceLead;
                        break;
                    case "leadsourcetype":
                        List<SelectListItem> SourceLeadType = new List<SelectListItem>();
                        SourceLeadType.AddRange(_Util.Facade.LookupFacade.GetLookupByKey("LeadSourceType").OrderBy(x => x.DataValue.ToString() != "-1").ThenBy(x => x.DisplayText.ToString()).Select(x =>
                                       new SelectListItem()
                                       {
                                           Text = x.DisplayText.ToString(),
                                           Value = x.DataValue.ToString()
                                       }).ToList());
                        ViewBag.SourceLeadType = SourceLeadType;
                        break;
                    case "carrier":
                        List<SelectListItem> Carrier = new List<SelectListItem>();
                        Carrier.AddRange(_Util.Facade.LookupFacade.GetLookupByKey("Carrier").Select(x => new SelectListItem()
                        {
                            Text = x.DisplayText.ToString(),
                            Value = x.DataValue.ToString()
                        }).ToList());
                        ViewBag.LeadCarrierList = Carrier;
                        break;
                    case "phonetype":
                        List<SelectListItem> typephonelist = new List<SelectListItem>();
                        typephonelist.Add(new SelectListItem()
                        {
                            Text = "Please Select One",
                            Value = "-1"
                        });
                        typephonelist.AddRange(_Util.Facade.LookupFacade.GetLookupByKey("PhoneType").Select(x =>
                                         new SelectListItem()
                                         {
                                             Text = x.DisplayText.ToString(),
                                             Value = x.DataValue.ToString()
                                         }).ToList());
                        ViewBag.PhoneTypeList = typephonelist;

                        break;

                    case "besttimetocall":
                        ViewBag.BestTimeToCallList = _Util.Facade.LookupFacade.GetLookupByKeyForArrivalOrDepartureTimeByMinAndMaxTimeRange("BestTimeToCall", null, null).OrderBy(x => x.DisplayText != "Select One").ThenBy(x => x.DisplayText).Select(x =>
                           new SelectListItem()
                           {
                               Text = x.DisplayText.ToString(),
                               Value = x.DataValue.ToString()
                           }).ToList();

                        break;

                    case "preferredcontactmethod":
                        ViewBag.PreferredContactMethod = _Util.Facade.LookupFacade.GetLookupByKey("PreferredContactMethod").Select(x =>
                        new SelectListItem()
                        {
                            Text = x.DisplayText.ToString(),
                            Value = x.DataValue.ToString()
                        }).ToList();
                        break;
                    case "1":
                        ViewBag.PreferredContactMethod = _Util.Facade.LookupFacade.GetLookupByKey("PreferredContactMethod").Select(x =>
                          new SelectListItem()
                          {
                              Text = x.DisplayText.ToString(),
                              Value = x.DataValue.ToString()
                          }).ToList();
                        break;
                    case "callingtime":
                        ViewBag.TimeToCall = _Util.Facade.LookupFacade.GetLookupByKey("TimeToCall").Select(x =>
                              new SelectListItem()
                              {
                                  Text = x.DisplayText.ToString(),
                                  Value = x.DataValue.ToString()
                              }).ToList();
                        break;
                    case "creditscore":
                        ViewBag.CreditScore = _Util.Facade.LookupFacade.GetLookupByKey("CreditScore").Select(x =>
                             new SelectListItem()
                             {
                                 Text = x.DisplayText.ToString(),
                                 Value = x.DataValue.ToString()
                             }).ToList();
                        break;
                    case "contractteam":
                        List<SelectListItem> ContactTerms = new List<SelectListItem>();
                        ContactTerms.AddRange(_Util.Facade.LookupFacade.GetLookupByKey("ContractTerm").Select(x =>
                                          new SelectListItem()
                                          {
                                              Text = x.DisplayText.ToString(),
                                              Value = x.DataValue.ToString()
                                          }).ToList());
                        ContactTerms.Add(new SelectListItem()
                        {
                            Text = "Custom",
                            Value = "Custom"
                        });
                        ViewBag.ContactTerms = ContactTerms;
                        break;
                    case "fundingcompany":
                        List<SelectListItem> FundingCompany = new List<SelectListItem>();
                        FundingCompany.Add(new SelectListItem() { Text = "Please Select One", Value = "-1" });
                        FundingCompany.AddRange(_Util.Facade.FundFacade.GetAllFundingCompany().Select(x =>
                                         new SelectListItem()
                                         {
                                             Text = x.Name.ToString(),
                                             Value = x.Value.ToString()
                                         }).ToList());
                        ViewBag.FundingCompany = FundingCompany;
                        break;
                    case "paymentmethod":
                        ViewBag.paymentmethodrmr = _Util.Facade.LookupFacade.GetLookupByKey("PaymentMethodRMR").Select(x =>
                                        new SelectListItem()
                                        {
                                            Text = x.DisplayText.ToString(),
                                            Value = x.DataValue.ToString()
                                        }).ToList();

                        break;
                    case "billcycle":
                        GlobalSetting paymentGetway = _Util.Facade.GlobalSettingsFacade.GetGlobalSettingsByKey(currentLoggedIn.CompanyId.Value, "PaymentGetway");
                        if (paymentGetway.Value == LabelHelper.PaymentGetway.Authorize)
                        {
                            ViewBag.BillCycle = _Util.Facade.LookupFacade.GetLookupByKey("BillCycle").Select(x =>
                                   new SelectListItem()
                                   {
                                       Text = x.DisplayText.ToString(),
                                       Value = x.DataValue.ToString()
                                   }).ToList();
                        }
                        else
                        {
                            ViewBag.BillCycle = _Util.Facade.LookupFacade.GetLookupByKey("ForteBillCycle").Select(x =>
                                   new SelectListItem()
                                   {
                                       Text = x.DisplayText.ToString(),
                                       Value = x.DataValue.ToString()
                                   }).ToList();
                        }
                        break;
                    case "billday":
                        ViewBag.BillingDay = _Util.Facade.LookupFacade.GetLookupByKey("BillingDay").Select(x =>
                             new SelectListItem()
                             {
                                 Text = x.DisplayText.ToString(),
                                 Value = x.DataValue.ToString()
                             }).ToList();
                        break;
                    case "billtax":
                        List<SelectListItem> BillYesNo = new List<SelectListItem>();
                        BillYesNo.Add(new SelectListItem()
                        {
                            Text = "Please Select One",
                            Value = "-1"
                        });
                        BillYesNo.AddRange(_Util.Facade.LookupFacade.GetLookupByKey("CustomerTaxYesNo").Select(x =>
                                         new SelectListItem()
                                         {
                                             Text = x.DisplayText.ToString(),
                                             Value = x.DataValue.ToString(),
                                             Selected = x.IsDefaultItem == true
                                         }).ToList());
                        ViewBag.BillYesNo = BillYesNo;
                        break;
                    case "streettype":
                        ViewBag.LeadStreetType = _Util.Facade.LookupFacade.GetLookupByKey("LeadStreetType").OrderBy(x => x.DataValue).Select(x =>
                                      new SelectListItem()
                                      {
                                          Text = x.DisplayText.ToString(),
                                          Value = x.DataValue.ToString()
                                      }).ToList();

                        break;
                    case "isactive":
                        List<SelectListItem> ContractedPrevious = new List<SelectListItem>();
                        ContractedPrevious.AddRange(_Util.Facade.LookupFacade.GetLookupByKey("ContractYesNo").Select(x => new SelectListItem()
                        {
                            Text = x.DisplayText.ToString(),
                            Value = x.DataValue.ToString()
                        }).ToList());
                        ViewBag.ContractedPrevious = ContractedPrevious;
                        break;
                    case "businessaccounttype":

                        List<SelectListItem> BussinessAccountType = new List<SelectListItem>();
                        BussinessAccountType.Add(new SelectListItem()
                        {
                            Text = "Please Select One",
                            Value = "-1"
                        });
                        BussinessAccountType.AddRange(_Util.Facade.LookupFacade.GetLookupByKey("BussinessAccountType").Select(x =>
                                        new SelectListItem()
                                        {
                                            Text = x.DisplayText.ToString(),
                                            Value = x.DataValue.ToString()
                                        }).ToList());
                        ViewBag.BussinessAccountType = BussinessAccountType;
                        break;
                    case "esistingpanel":

                        ViewBag.PanelType = _Util.Facade.PanelTypeFacade.GetAllPanelType().Select(x =>
                                 new SelectListItem()
                                 {
                                     Text = x.Name.ToString(),
                                     Value = x.Id.ToString(),

                                 }).ToList();
                        break;
                    case "market":
                        List<SelectListItem> LeadMarket = new List<SelectListItem>();
                        LeadMarket.AddRange(_Util.Facade.LookupFacade.GetLookupByKey("LeadMarket").Select(x => new SelectListItem()
                        {
                            Text = x.DisplayText.ToString(),
                            Value = x.DataValue.ToString()
                        }).ToList());
                        ViewBag.LeadMarket = LeadMarket;
                        break;
                    case "customeraccounttype":
                        List<SelectListItem> CustomerAccountTypeLookup = new List<SelectListItem>();
                        CustomerAccountTypeLookup.Add(new SelectListItem()
                        {
                            Text = "Please Select One",
                            Value = "-1"
                        });
                        CustomerAccountTypeLookup.AddRange(_Util.Facade.LookupFacade.GetLookupByKey("CustomerAccountType").Where(x => x.DataValue != "-1").Select(x =>
                                       new SelectListItem()
                                       {
                                           Text = x.DisplayText.ToString(),
                                           Value = x.DataValue.ToString()
                                       }).ToList());
                        ViewBag.CustomerAccountTypeLookup = CustomerAccountTypeLookup;
                        break;
                    case "csprovider":
                        ViewBag.CSProviderList = _Util.Facade.LookupFacade.GetDropdownsByKey("CSProvider");
                        break;
                    case "ownership":
                        List<SelectListItem> ownerlist = new List<SelectListItem>();
                        ownerlist.Add(new SelectListItem()
                        {
                            Text = "Please Select One",
                            Value = "-1"
                        });
                        ownerlist.AddRange(_Util.Facade.LookupFacade.GetLookupByKeyForArrivalOrDepartureTimeByMinAndMaxTimeRange("OwnerShip", null, null).OrderBy(x => x.DisplayText != "Ownership").ThenBy(x => x.DisplayText).Select(x =>
                        new SelectListItem()
                        {
                            Text = x.DisplayText.ToString(),
                            Value = x.DataValue.ToString()
                        }).ToList());
                        ViewBag.OwnerShipList = ownerlist;
                        break;
                    case "accessgivento":
                        List<SelectListItem> AccessAssignedPersons = new List<SelectListItem>();
                        AccessAssignedPersons.Add(new SelectListItem()
                        {
                            Text = "Access Assign To",
                            Value = "-1"
                        });
                        List<Employee> EmployeeListDropDown = _Util.Facade.EmployeeFacade.GetAllEmployee(currentLoggedIn.CompanyId.Value);
                        if (EmployeeListDropDown != null && EmployeeListDropDown.Count > 0)
                        {
                            AccessAssignedPersons.AddRange(EmployeeListDropDown.OrderBy(x => x.FirstName).Select(x => new SelectListItem()
                            {
                                Text = x.FirstName.ToString() + " " + x.LastName.ToString(),
                                Value = x.UserId.ToString()
                            }).ToList());
                        }
                        ViewBag.AccessAssignedPersons = AccessAssignedPersons;
                        break;
                    case "lead status":
                        List<SelectListItem> LeadStatus = new List<SelectListItem>();
                        LeadStatus.Add(new SelectListItem()
                        {
                            Text = "Please Select One",
                            Value = "-1"
                        });
                        LeadStatus.AddRange(_Util.Facade.LookupFacade.GetLookupByKey("LeadStatus").Where(x => x.DataValue != "New").OrderBy(x => x.DataValue.ToString() != "-1").ThenBy(x => x.DisplayText).Select(x => new SelectListItem()
                        {
                            Text = x.DisplayText.ToString(),
                            Value = x.DataValue.ToString()
                        }).ToList());
                        ViewBag.LeadStatus = LeadStatus;
                        break;
                    case "saleslocation":
                        ViewBag.SalesLocation = _Util.Facade.LookupFacade.GetLookupByKey("CommissionType").OrderBy(x => x.DataValue.ToString() != "-1").ThenBy(x => x.DisplayText).Select(x =>
                                      new SelectListItem()
                                      {
                                          Text = x.DisplayText.ToString(),
                                          Value = x.DataValue.ToString()
                                      }).ToList();
                        break;
                    case "customerstatus":
                        List<SelectListItem> CustomerStatus = new List<SelectListItem>();
                        CustomerStatus.Add(new SelectListItem()
                        {
                            Text = "Please Select One",
                            Value = "-1"
                        });
                        CustomerStatus.AddRange(_Util.Facade.LookupFacade.GetLookupByKey("CustomerStatus1").OrderBy(x => x.DataValue.ToString() != "-1").ThenBy(x => x.DisplayText).Select(x => new SelectListItem()
                        {
                            Text = x.DisplayText.ToString(),
                            Value = x.DataValue.ToString()
                        }).ToList());
                        ViewBag.CustomerStatus = CustomerStatus;
                        break;
                    case "installedstatus":
                        List<SelectListItem> InstalledStatus = new List<SelectListItem>();
                        InstalledStatus.AddRange(_Util.Facade.LookupFacade.GetLookupByKey("InstalledStatus").Select(x => new SelectListItem()
                        {
                            Text = x.DisplayText.ToString(),
                            Value = x.DataValue.ToString()
                        }).ToList());
                        ViewBag.InstalledStatus = InstalledStatus;
                        break;
                    case "taxexemption":

                        List<SelectListItem> taxexemplist = new List<SelectListItem>();
                        taxexemplist.Add(new SelectListItem()
                        {
                            Text = "Please Select One",
                            Value = "-1"
                        });
                        taxexemplist.AddRange(_Util.Facade.LookupFacade.GetLookupByKey("TaxExemption").Select(x =>
                        new SelectListItem()
                        {
                            Text = x.DisplayText.ToString(),
                            Value = x.DataValue.ToString(),

                        }).ToList());
                        ViewBag.TaxExemptionList = taxexemplist;
                        break;
                    case "appointmentset":
                        ViewBag.AppoinmentSetList = _Util.Facade.LookupFacade.GetLookupByKey("AppoinmentSet").Select(x =>
                             new SelectListItem()
                             {
                                 Text = x.DisplayText.ToString(),
                                 Value = x.DataValue.ToString(),

                             }).ToList();
                        break;
                    case "branchid":
                        UserBranch ub = _Util.Facade.UserCompanyFacade.GetUserBranchByUserId(currentLoggedIn.UserId);
                        List<SelectListItem> BranchList = new List<SelectListItem>();
                        BranchList.Add(new SelectListItem()
                        {
                            Text = "Please Select One",
                            Value = "-1"
                        });
                        BranchList.AddRange(_Util.Facade.CompanyBranchFacade.GetAllCompanyBranchByCompanyId(currentLoggedIn.CompanyId.Value).OrderBy(x => x.Id.ToString() != "-1").ThenBy(x => x.Name).Select(x => new SelectListItem()
                        {
                            Text = x.Name + (string.IsNullOrWhiteSpace(x.Region) ? "" : ">" + x.Region) + (string.IsNullOrWhiteSpace(x.Division) ? "" : ">" + x.Division),
                            Value = x.Id.ToString()
                        }).ToList());
                        ViewBag.BranchList = BranchList.ToList();
                        break;
                    case "soldby":
                        List<SelectListItem> salesPerson = new List<SelectListItem>();
                        if (IsPermitted(UserPermissions.MyCompanyPermissions.ShowAllSalesPerson))
                        {
                            var objcurrentlog = _Util.Facade.EmployeeFacade.GetEmployeeByEmployeeId(currentLoggedIn.UserId);
                            salesPerson.Add(new SelectListItem()
                            {
                                Text = "Please Select One",
                                Value = "-1"
                            });
                            if (objcurrentlog != null)
                            {
                                salesPerson.Add(new SelectListItem()
                                {
                                    Text = objcurrentlog.FirstName + " " + objcurrentlog.LastName,
                                    Value = objcurrentlog.UserId.ToString()
                                });
                            }
                            salesPerson.AddRange(_Util.Facade.EmployeeFacade.GetEmployeeByCompanyIdAndTag(currentLoggedIn.CompanyId.Value, LabelHelper.UserTags.SalesPerson, new Guid()).OrderBy(x => x.FirstName + " " + x.LastName != "Please Select One").ThenBy(x => x.FirstName + " " + x.LastName).Select(x =>
                                  new SelectListItem()
                                  {
                                      Text = x.FirstName.ToString() + " " + x.LastName.ToString(),
                                      Value = x.UserId.ToString()
                                  }).ToList());
                            ViewBag.SalesPerson = salesPerson;
                        }
                        else
                        {
                            var objEmp = _Util.Facade.EmployeeFacade.GetEmployeeByEmployeeId(currentLoggedIn.UserId);
                            if (objEmp != null)
                            {
                                salesPerson.Add(new SelectListItem()
                                {
                                    Text = objEmp.FirstName.ToString() + " " + objEmp.LastName.ToString(),
                                    Value = currentLoggedIn.UserId.ToString()
                                });
                                ViewBag.SalesPerson = salesPerson;
                            }
                        }

                        ViewBag.SalesPerson = salesPerson;
                        break;
                }
            }

            List<SelectListItem> DuplicateCustomerList = new List<SelectListItem>();
            DuplicateCustomerList.Add(new SelectListItem
            {
                Text = LanguageHelper.T("Customer"),
                Value = "00000000-0000-0000-0000-000000000000"
            });
            ViewBag.DuplicateCustomerList = DuplicateCustomerList;
            ViewBag.key = key;

            List<SelectListItem> ChildCustomerList = new List<SelectListItem>();
            ChildCustomerList.Add(new SelectListItem
            {
                Text = LanguageHelper.T("Customer"),
                Value = "00000000-0000-0000-0000-000000000000"
            });
            ViewBag.ChildCustomerList = ChildCustomerList;


            List<SelectListItem> CustomerList = new List<SelectListItem>();
            CustomerList.Add(new SelectListItem
            {
                Text = HS.Web.UI.Helper.LanguageHelper.T("Customer"),
                Value = "00000000-0000-0000-0000-000000000000"
            });
            ViewBag.CustomerList = CustomerList;



            List<SelectListItem> InstallerList = new List<SelectListItem>();
            InstallerList.Add(new SelectListItem()
            {
                Text = "Please Select One",
                Value = "-1"
            });
            //List<Employee> EmployeeDropDownList = _Util.Facade.EmployeeFacade.GetEmployeeByCompanyIdAndTag(currentLoggedIn.CompanyId.Value, LabelHelper.UserTags.Installer, new Guid());
            //if (EmployeeDropDownList != null && EmployeeDropDownList.Count > 0)
            //{
            //    InstallerList.AddRange(EmployeeDropDownList.OrderBy(x => x.FirstName).Select(x =>
            //               new SelectListItem()
            //               {
            //                   Text = x.FirstName + " " + x.LastName,
            //                   Value = x.UserId.ToString()
            //               }).ToList());
            //}

            ViewBag.InstallerList = InstallerList;

            List<SelectListItem> QualityAssuranceList1 = new List<SelectListItem>();
            QualityAssuranceList1.Add(new SelectListItem()
            {
                Text = "Please Select One",
                Value = ""
            });
            //List<Employee> EmployeeDropDownListqa1 = _Util.Facade.EmployeeFacade.GetAllEmployee(currentLoggedIn.CompanyId.Value);
            //if (EmployeeDropDownListqa1 != null && EmployeeDropDownListqa1.Count > 0)
            //{
            //    QualityAssuranceList1.AddRange(EmployeeDropDownListqa1.OrderBy(x => x.FirstName).Select(x =>
            //                      new SelectListItem()
            //                      {
            //                          Text = x.FirstName.ToString() + " " + x.LastName.ToString(),
            //                          Value = x.UserId.ToString()
            //                      }).ToList());
            //}

            ViewBag.QualityAssuranceList1 = QualityAssuranceList1;

            List<SelectListItem> QualityAssuranceList2 = new List<SelectListItem>();
            QualityAssuranceList2.Add(new SelectListItem()
            {
                Text = "Please Select One",
                Value = ""
            });
            //List<Employee> EmployeeDropDownList2 = _Util.Facade.EmployeeFacade.GetAllEmployee(currentLoggedIn.CompanyId.Value);
            //QualityAssuranceList2.AddRange(EmployeeDropDownList2.OrderBy(x => x.FirstName).Select(x =>
            //                      new SelectListItem()
            //                      {
            //                          Text = x.FirstName.ToString() + " " + x.LastName.ToString(),
            //                          Value = x.UserId.ToString()
            //                      }).ToList());
            ViewBag.QualityAssuranceList2 = QualityAssuranceList2;

            return View(model);
        }

        [HttpPost]
        public JsonResult UpdateNoteBoxSort(List<CustomerNote> NoteList)
        {
            bool result = false;
            if (NoteList != null && NoteList.Count > 0)
            {
                foreach (var item in NoteList)
                {
                    CustomerNote model = _Util.Facade.NotesFacade.GetNotesById(item.Id);
                    if (model != null)
                    {
                        model.OrderBy = item.OrderBy;
                        result = _Util.Facade.NotesFacade.UpdateNotes(model);
                    }
                }
            }
            return Json(result);
        }

        public JsonResult AddUccZone(CustomerSecurityZones securityZones)
        {

            bool result = false;
            var CurrentUser = (HS.Web.UI.Helper.CustomPrincipal)User;
            try
            {
                if (securityZones.ID > 0)
                {
                    CustomerSecurityZones cusZone = new CustomerSecurityZones();
                    cusZone = _Util.Facade.CustomerFacade.GetCustomerSecurityZoneById(securityZones.ID);
                    if (cusZone != null)
                    {
                        cusZone.ZoneNumber = securityZones.ZoneNumber;
                        cusZone.EventCode = securityZones.EventCode;

                        cusZone.Location = securityZones.Location;
                        cusZone.EquipmentType = securityZones.EquipmentType;
                        cusZone.ZoneComment = securityZones.ZoneComment;
                        _Util.Facade.CustomerFacade.UpdateCustomerSecurityZone(cusZone);
                    }
                }
                else
                {
                    securityZones.CreatedBy = CurrentUser.UserId;
                    securityZones.CreatedDate = DateTime.Now.UTCCurrentTime();

                    _Util.Facade.CustomerFacade.InsertCustomerSecurityZone(securityZones);
                    result = true;
                }

            }
            catch (Exception ex)
            {

            }


            return Json(new { result = result });
        }

        public ActionResult LoadMoveCustomerServiceEqpBilling(Guid? CustomerId, string type)
        {
            var CurrentUser = (HS.Web.UI.Helper.CustomPrincipal)User;
            CustomerServiceEqpBillingModel model = new CustomerServiceEqpBillingModel();
            if (CustomerId.HasValue && CustomerId.Value != new Guid())
            {
                model.CustomerModel = _Util.Facade.CustomerFacade.GetCustomerByCustomerId(CustomerId.Value);
                model.PackageCustomerModel = _Util.Facade.PackageFacade.GetPackageCustomerByCustomerId(CustomerId.Value);
                model.CustomerPackageServiceModel = _Util.Facade.PackageFacade.GetCustomerPackageServiceByCustomerId(CustomerId.Value);
                model.CustomerPackageEqpModel = _Util.Facade.PackageFacade.GetCustomerPackageEqpByCustomerId(CustomerId.Value);
                model.ListCustomerService = _Util.Facade.CustomerAppoinmentFacade.GetCustomerServiceListByCustomerIdAndCompanyId(CustomerId.Value, CurrentUser.CompanyId.Value);
                model.ListCustomerEquipment = _Util.Facade.CustomerAppoinmentFacade.GetCustomerEquipmentListByCustomerIdAndCompanyId(CustomerId.Value, CurrentUser.CompanyId.Value);
            }
            ViewBag.type = type;
            return View(model);
        }

        [HttpPost]
        public JsonResult SaveMoveCustomerServiceEqp(Guid? CustomerId, List<string> ServiceList, List<string> EquipmentList, bool Billing, string Street, string Zip, string City, string State)
        {
            var CurrentUser = (HS.Web.UI.Helper.CustomPrincipal)User;
            var CurrentLoggedInUser = ((HS.Web.UI.Helper.CustomPrincipal)(User));

            PackageCustomer objpc = new PackageCustomer();
            Ticket ticket = new Ticket();
            string message = "";
            bool result = false;
            string type = "";
            Customer customer = new Customer();
            if (CustomerId.HasValue && CustomerId.Value != new Guid())
            {
                customer = _Util.Facade.CustomerFacade.GetCustomerByCustomerId(CustomerId.Value);
                if (customer != null)
                {
                    #region Add New Lead and Customer
                    customer.MoveCustomerId = customer.CustomerId;
                    customer.CustomerId = Guid.NewGuid();
                    customer.Address = MakeAddress(Street, City, State, Zip, ""); ;
                    customer.Street = Street;
                    customer.City = City;
                    customer.State = State;
                    customer.ZipCode = Zip;
                    customer.County = "";
                    customer.Address2 = "";
                    customer.StreetPrevious = "";
                    customer.CityPrevious = "";
                    customer.StatePrevious = "";
                    customer.ZipCodePrevious = "";
                    customer.SecondCustomerNo = "";
                    customer.JoinDate = DateTime.Now;
                    customer.IsTechCallPassed = false;
                    customer.LastUpdatedDate = DateTime.Now.UTCCurrentTime();
                    customer.LastUpdatedBy = User.Identity.Name;
                    customer.IsDirect = false;
                    customer.IsActive = true;
                    customer.CreatedDate = DateTime.Now;
                    customer.CreatedByUid = CurrentUser.UserId;
                    customer.LastUpdatedByUid = CurrentUser.UserId;
                    customer.EmailVerified = false;
                    customer.Passcode = customer.Passcode;
                    customer.ContractTeam = customer.ContractTeam;
                    customer.CustomerStatus = "6";
                    customer.StreetType = "";
                    customer.Appartment = "";
                    customer.InstallDate = null;
                    customer.Singature = "";
                    customer.AgreementEmail = customer.EmailAddress;
                    customer.Soldby = CurrentUser.UserId.ToString();
                    customer.Soldby1 = CurrentUser.UserId;
                    customer.AccountNo = "";
                    customer.UCCRefId = "";
                    customer.AlarmRefId = "";
                    customer.BrinksRefId = "";
                    customer.CustomerNo = "";
                    customer.OriginalContactDate = null;
                    customer.AgreementPhoneNo = !string.IsNullOrWhiteSpace(customer.PrimaryPhone) ? customer.PrimaryPhone : !string.IsNullOrWhiteSpace(customer.SecondaryPhone) ? customer.SecondaryPhone : !string.IsNullOrWhiteSpace(customer.CellNo) ? customer.CellNo : "";
                    customer.Id = (int)_Util.Facade.CustomerFacade.InsertCustomer(customer);

                    result = customer.Id > 0;
                    if (result != false && EquipmentList == null)
                    {
                        CustomerExtended extended = new CustomerExtended()
                        {
                            CustomerId = customer.CustomerId,
                            IsSignAgrSendToCus = true
                        };
                        _Util.Facade.CustomerFacade.InsertCustomerExtended(extended);

                        CustomerCompany cc = new CustomerCompany()
                        {
                            CompanyId = CurrentUser.CompanyId.Value,
                            CustomerId = customer.CustomerId,
                            IsLead = true,
                            IsActive = true
                        };
                        result = _Util.Facade.CustomerFacade.InsertCustomerCompany(cc) > 0;
                        message = "Moved to lead successfully.";
                        customer.IsAgreement = false;

                        if (ServiceList != null && ServiceList.Count > 0)
                        {
                            var objpackagecustomer = _Util.Facade.PackageFacade.GetPackageCustomerByCustomerId(customer.MoveCustomerId);
                            if (objpackagecustomer != null)
                            {
                                objpc = new PackageCustomer()
                                {
                                    CompanyId = objpackagecustomer.CompanyId,
                                    CustomerId = customer.CustomerId,
                                    PackageId = objpackagecustomer.PackageId,
                                    SmartSystemTypeId = objpackagecustomer.SmartSystemTypeId,
                                    SmartInstallTypeId = objpackagecustomer.SmartInstallTypeId,
                                    ManufacturerId = objpackagecustomer.ManufacturerId,
                                    NonConformingFee = 0.0,
                                    ActivationFee = 0.0,
                                    WarrentyAvailable = objpackagecustomer.WarrentyAvailable
                                };
                                _Util.Facade.PackageFacade.InsertPackageCustomer(objpc);
                            }
                            customer.SmartSetUpStep = 2;
                        }
                        else
                        {
                            customer.SmartSetUpStep = 1;
                        }
                        _Util.Facade.CustomerFacade.UpdateCustomer(customer);
                        type = "lead";
                        base.AddUserActivityForCustomer("Customer is Moved to Lead #" + customer.Id + " by " + CurrentLoggedInUser.FirstName + " " + CurrentLoggedInUser.LastName, LabelHelper.ActivityAction.Move, CustomerId, null, null);

                    }
                    else if (result != false && EquipmentList != null && EquipmentList.Count > 0)
                    {
                        CustomerExtended extended = new CustomerExtended()
                        {
                            CustomerId = customer.CustomerId,
                            IsSignAgrSendToCus=true
                        };
                        _Util.Facade.CustomerFacade.InsertCustomerExtended(extended);
                        CustomerCompany cc = new CustomerCompany()
                        {
                            CompanyId = CurrentUser.CompanyId.Value,
                            CustomerId = customer.CustomerId,
                            IsLead = false,
                            IsActive = true
                        };
                        result = _Util.Facade.CustomerFacade.InsertCustomerCompany(cc) > 0;
                        message = "Moved to customer successfully.";
                        customer.IsAgreement = true;
                        if (ServiceList != null && ServiceList.Count > 0)
                        {
                            var objpackagecustomer = _Util.Facade.PackageFacade.GetPackageCustomerByCustomerId(customer.MoveCustomerId);
                            if (objpackagecustomer != null)
                            {
                                objpc = new PackageCustomer()
                                {
                                    CompanyId = objpackagecustomer.CompanyId,
                                    CustomerId = customer.CustomerId,
                                    PackageId = objpackagecustomer.PackageId,
                                    SmartSystemTypeId = objpackagecustomer.SmartSystemTypeId,
                                    SmartInstallTypeId = objpackagecustomer.SmartInstallTypeId,
                                    ManufacturerId = objpackagecustomer.ManufacturerId,
                                    NonConformingFee = 0.0,
                                    ActivationFee = 0.0,
                                    WarrentyAvailable = objpackagecustomer.WarrentyAvailable
                                };
                                _Util.Facade.PackageFacade.InsertPackageCustomer(objpc);
                            }
                            customer.SmartSetUpStep = 5;
                        }
                        else
                        {
                            customer.SmartSetUpStep = 1;
                        }
                        _Util.Facade.CustomerFacade.UpdateCustomer(customer);
                        type = "customer";
                        base.AddUserActivityForCustomer("Customer is Moved to Customer #" + customer.Id + " by " + CurrentLoggedInUser.FirstName + " " + CurrentLoggedInUser.LastName, LabelHelper.ActivityAction.Move, CustomerId, null, null);

                    }
                    #endregion
                    var objemergency = _Util.Facade.EmergencyContactFacade.GetAllEmergencyContactByCustomerId(customer.MoveCustomerId);
                    if (objemergency != null && objemergency.Count > 0)
                    {
                        foreach (var item in objemergency)
                        {
                            EmergencyContact EmergencyContact = new EmergencyContact()
                            {
                                CompanyId = CurrentUser.CompanyId.Value,
                                CustomerId = customer.CustomerId,
                                CrossSteet = item.CrossSteet,
                                FirstName = item.FirstName,
                                LastName = item.LastName,
                                RelationShip = item.RelationShip,
                                Email = item.Email,
                                Phone = item.Phone,
                                HasKey = item.HasKey,
                                PhoneType = item.PhoneType,
                                OrderBy = item.OrderBy
                            };
                            _Util.Facade.EmergencyContactFacade.InsertEmergencyContact(EmergencyContact);
                        }
                    }
                    #region Ticket and Appointment Equipment
                    if (EquipmentList != null && EquipmentList.Count > 0)
                    {
                        if (type == "customer")
                        {
                            ticket = new Ticket()
                            {
                                TicketId = Guid.NewGuid(),
                                CompanyId = CurrentUser.CompanyId.Value,
                                CustomerId = customer.CustomerId,
                                TicketType = LabelHelper.TicketType.InstallMove,
                                CreatedBy = new Guid(LabelHelper.SystemUser.ID),
                                CreatedDate = DateTime.Now.UTCCurrentTime(),
                                CompletionDate = DateTime.Now.UTCCurrentTime(),
                                Status = LabelHelper.TicketStatus.Created,
                                LastUpdatedBy = new Guid(LabelHelper.SystemUser.ID),
                                LastUpdatedDate = DateTime.Now.UTCCurrentTime(),
                                HasInvoice = false,
                                HasSurvey = false,
                                IsAgreementTicket = true,
                            };
                            ticket.Id = _Util.Facade.TicketFacade.InsertTicket(ticket);
                        }
                        else
                        {
                            ticket = new Ticket()
                            {
                                TicketId = Guid.NewGuid(),
                                CompanyId = CurrentUser.CompanyId.Value,
                                CustomerId = customer.CustomerId,
                                TicketType = LabelHelper.TicketType.InstallMove,
                                CreatedBy = new Guid(LabelHelper.SystemUser.ID),
                                CreatedDate = DateTime.Now.UTCCurrentTime(),
                                CompletionDate = DateTime.Now.UTCCurrentTime(),
                                Status = LabelHelper.TicketStatus.Created,
                                LastUpdatedBy = new Guid(LabelHelper.SystemUser.ID),
                                LastUpdatedDate = DateTime.Now.UTCCurrentTime(),
                                HasInvoice = false,
                                HasSurvey = false,
                                IsAgreementTicket = false,
                            };
                            ticket.Id = _Util.Facade.TicketFacade.InsertTicket(ticket);
                        }
                        TicketUser TU = new TicketUser()
                        {
                            IsPrimary = true,
                            NotificationOnly = false,
                            AddedBy = CurrentUser.UserId,
                            AddedDate = DateTime.Now.UTCCurrentTime(),
                            TiketId = ticket.TicketId,
                            UserId = new Guid(LabelHelper.SystemUser.ID),
                        };
                        TU.Id = _Util.Facade.TicketFacade.InsertTicketUser(TU);
                        CustomerAppointment CustomerAppointment = new CustomerAppointment()
                        {
                            AppointmentId = ticket.TicketId,
                            CustomerId = customer.CustomerId,
                            CompanyId = CurrentUser.CompanyId.Value,
                            EmployeeId = new Guid(),
                            AppointmentType = ticket.TicketType,
                            AppointmentDate = ticket.CompletionDate,
                            AppointmentStartTime = ticket.AppointmentStartTime,
                            AppointmentEndTime = ticket.AppointmentEndTime,
                            IsAllDay = true,
                            Status = false,
                            CreatedBy = CurrentUser.Identity.Name,
                            LastUpdatedBy = CurrentUser.Identity.Name,
                            LastUpdatedDate = DateTime.Now.UTCCurrentTime(),
                        };
                        CustomerAppointment.Id = _Util.Facade.CustomerAppoinmentFacade.InsertAppoinment(CustomerAppointment);
                        if (ServiceList != null && ServiceList.Count > 0)
                        {
                            foreach (var item in ServiceList)
                            {
                                CustomerAppointmentEquipment CustomerAppointmentEquipment = _Util.Facade.CustomerAppoinmentFacade.GetCustomerAppointmentEquipmentById(Convert.ToInt32(item));
                                if (CustomerAppointmentEquipment != null)
                                {
                                    CustomerAppointmentEquipment.AppointmentId = ticket.TicketId;

                                    CustomerAppointmentEquipment.IsBilling = false;
                                    CustomerAppointmentEquipment.IsCopied = false;
                                    CustomerAppointmentEquipment.IsEquipmentRelease = false;
                                    CustomerAppointmentEquipment.IsEquipmentExist = false;
                                    if (type == "customer")
                                    {
                                        CustomerAppointmentEquipment.IsInvoiceCreate = true;
                                    }
                                    else
                                    {
                                        CustomerAppointmentEquipment.IsInvoiceCreate = false;
                                    }
                                    CustomerAppointmentEquipment.CreatedByUid = new Guid(customer.Soldby);
                                    CustomerAppointmentEquipment.Id = _Util.Facade.CustomerAppoinmentFacade.InsertCustomerAppointmentEquipment(CustomerAppointmentEquipment);
                                    if (objpc != null)
                                    {
                                        var objpackageservice = _Util.Facade.PackageFacade.GetPackageCustomerServiceByCustomerIdAndPackageIdAndEquipmentId(objpc.PackageId, customer.CustomerId, CustomerAppointmentEquipment.EquipmentId);
                                        if (objpackageservice != null)
                                        {
                                            CustomerPackageService objcps = new CustomerPackageService()
                                            {
                                                CompanyId = CurrentUser.CompanyId.Value,
                                                CustomerId = customer.CustomerId,
                                                PackageId = objpackageservice.PackageId,
                                                EquipmentId = objpackageservice.EquipmentId,
                                                MonthlyRate = objpackageservice.MonthlyRate,
                                                DiscountRate = objpackageservice.DiscountRate,
                                                Total = objpackageservice.Total,
                                                ManufacturerId = objpackageservice.ManufacturerId,
                                                LocationId = objpackageservice.LocationId,
                                                TypeId = objpackageservice.TypeId,
                                                ModelId = objpackageservice.ModelId,
                                                FinishId = objpackageservice.FinishId,
                                                CapacityId = objpackageservice.CapacityId,
                                                AppointmentIntId = ticket.Id,
                                                AppointmentEquipmentIntId = CustomerAppointmentEquipment.Id
                                            };
                                            _Util.Facade.PackageFacade.InsertCustomerPackageService(objcps);
                                        }
                                        else
                                        {
                                            CustomerPackageService objcps = new CustomerPackageService()
                                            {
                                                CompanyId = CurrentUser.CompanyId.Value,
                                                CustomerId = customer.CustomerId,
                                                PackageId = objpc.PackageId,
                                                EquipmentId = CustomerAppointmentEquipment.EquipmentId,
                                                MonthlyRate = CustomerAppointmentEquipment.UnitPrice,
                                                DiscountRate = 0.0,
                                                Total = CustomerAppointmentEquipment.TotalPrice,
                                                ManufacturerId = new Guid(),
                                                LocationId = new Guid(),
                                                TypeId = new Guid(),
                                                ModelId = new Guid(),
                                                FinishId = new Guid(),
                                                CapacityId = new Guid(),
                                                AppointmentIntId = ticket.Id,
                                                AppointmentEquipmentIntId = CustomerAppointmentEquipment.Id
                                            };
                                            _Util.Facade.PackageFacade.InsertCustomerPackageService(objcps);
                                        }
                                    }
                                }
                            }
                        }
                        if (EquipmentList != null && EquipmentList.Count > 0)
                        {
                            foreach (var item in EquipmentList)
                            {
                                CustomerAppointmentEquipment CustomerAppointmentEquipment = _Util.Facade.CustomerAppoinmentFacade.GetCustomerAppointmentEquipmentById(Convert.ToInt32(item));
                                if (CustomerAppointmentEquipment != null)
                                {
                                    CustomerAppointmentEquipment.AppointmentId = ticket.TicketId;
                                    CustomerAppointmentEquipment.QuantityLeftEquipment = 0;
                                    CustomerAppointmentEquipment.IsBilling = false;
                                    CustomerAppointmentEquipment.IsEquipmentRelease = false;
                                    CustomerAppointmentEquipment.IsEquipmentExist = true;
                                    CustomerAppointmentEquipment.IsCopied = false;
                                    if (type == "customer")
                                    {
                                        CustomerAppointmentEquipment.IsInvoiceCreate = true;
                                    }
                                    else
                                    {
                                        CustomerAppointmentEquipment.IsInvoiceCreate = false;
                                    }
                                    CustomerAppointmentEquipment.CreatedByUid = new Guid(customer.Soldby);
                                    CustomerAppointmentEquipment.Id = _Util.Facade.CustomerAppoinmentFacade.InsertCustomerAppointmentEquipment(CustomerAppointmentEquipment);
                                    if (objpc != null)
                                    {
                                        var objpackageequipment = _Util.Facade.PackageFacade.GetPackageCustomerEqpByCustomerIdAndPackageIdAndEquipmentId(objpc.PackageId, customer.CustomerId, CustomerAppointmentEquipment.EquipmentId);
                                        if (objpackageequipment != null)
                                        {
                                            CustomerPackageEqp objeqp = new CustomerPackageEqp()
                                            {
                                                CompanyId = CurrentUser.CompanyId.Value,
                                                CustomerId = customer.CustomerId,
                                                PackageId = objpc.PackageId,
                                                EquipmentId = objpackageequipment.EquipmentId,
                                                IsIncluded = objpackageequipment.IsIncluded,
                                                IsDevice = objpackageequipment.IsDevice,
                                                IsOptionalEqp = objpackageequipment.IsOptionalEqp,
                                                Quantity = objpackageequipment.Quantity,
                                                UnitPrice = objpackageequipment.UnitPrice,
                                                DiscountUnitPricce = objpackageequipment.DiscountUnitPricce,
                                                DiscountPckage = objpackageequipment.DiscountPckage,
                                                Total = objpackageequipment.Total,
                                                IsServiceEquipment = objpackageequipment.IsServiceEquipment,
                                                ServiceId = objpackageequipment.ServiceId,
                                                IsTransfered = objpackageequipment.IsTransfered,
                                                IsEqpExist = CustomerAppointmentEquipment.IsEquipmentExist,
                                                IsNonCommissionable = CustomerAppointmentEquipment.IsNonCommissionable,
                                                AppointmentIntId = ticket.Id,
                                                AppointmentEquipmentIntId = CustomerAppointmentEquipment.Id
                                            };
                                            _Util.Facade.PackageFacade.InsertCustomerPackageEqp(objeqp);
                                        }
                                        else
                                        {
                                            CustomerPackageEqp objeqp = new CustomerPackageEqp()
                                            {
                                                CompanyId = CurrentUser.CompanyId.Value,
                                                CustomerId = customer.CustomerId,
                                                PackageId = objpc.PackageId,
                                                EquipmentId = CustomerAppointmentEquipment.EquipmentId,
                                                IsIncluded = false,
                                                IsDevice = false,
                                                IsOptionalEqp = false,
                                                Quantity = CustomerAppointmentEquipment.Quantity,
                                                UnitPrice = 0.0,
                                                DiscountUnitPricce = 0.0,
                                                DiscountPckage = 0.0,
                                                Total = 0.0,
                                                IsServiceEquipment = false,
                                                ServiceId = new Guid(),
                                                IsTransfered = false,
                                                IsEqpExist = CustomerAppointmentEquipment.IsEquipmentExist,
                                                IsNonCommissionable = CustomerAppointmentEquipment.IsNonCommissionable,
                                                AppointmentIntId = ticket.Id,
                                                AppointmentEquipmentIntId = CustomerAppointmentEquipment.Id
                                            };
                                            _Util.Facade.PackageFacade.InsertCustomerPackageEqp(objeqp);
                                        }
                                    }
                                }
                            }
                        }
                    }
                    #endregion
                    if (Billing)
                    {
                        var objpayinfocustomer = _Util.Facade.PaymentInfoCustomerFacade.GetAllPaymentInfoCustomerByCustomerId(customer.MoveCustomerId);
                        var objpayprofilecustomer = _Util.Facade.PaymentInfoCustomerFacade.GetAllPaymentProfileCustomerByCustomerId(customer.MoveCustomerId);
                        if (objpayinfocustomer != null && objpayinfocustomer.Count > 0)
                        {
                            foreach (var item in objpayinfocustomer)
                            {
                                PaymentInfoCustomer objinfocustomer = new PaymentInfoCustomer()
                                {
                                    CompanyId = item.CompanyId,
                                    CustomerId = customer.CustomerId,
                                    PaymentInfoId = item.PaymentInfoId,
                                    Type = item.Type,
                                    Payfor = item.Payfor,
                                    IsPaid = false,
                                    PaymentDate = item.PaymentDate,
                                    ForMonths = item.ForMonths,
                                    InvoiceId = ""
                                };
                                _Util.Facade.PaymentInfoCustomerFacade.InsertPaymentInfoCustomer(objinfocustomer);
                            }
                        }
                        if (objpayprofilecustomer != null && objpayprofilecustomer.Count > 0)
                        {
                            foreach (var item in objpayprofilecustomer)
                            {
                                PaymentProfileCustomer objprofile = new PaymentProfileCustomer()
                                {
                                    CompanyId = item.CompanyId,
                                    CustomerId = customer.CustomerId,
                                    PaymentInfoId = item.PaymentInfoId,
                                    Type = item.Type
                                };
                                _Util.Facade.PaymentInfoCustomerFacade.InsertPaymentProfileCustomer(objprofile);
                            }
                        }
                    }
                    SendCancellationAgreement(CustomerId.Value);
                    var objcreditcheck = _Util.Facade.CustomerFacade.GetAllCustomerCreditCheckByCustomerId(customer.MoveCustomerId);
                    if (objcreditcheck != null && objcreditcheck.Count > 0)
                    {
                        foreach (var item in objcreditcheck)
                        {
                            item.CustomerId = customer.CustomerId;
                            item.CompanyId = CurrentUser.CompanyId.Value;
                            _Util.Facade.CustomerFacade.InsertCustomerCreditCheck(item);
                        }
                    }
                }
            }
            return Json(new { result = result, message = message, leadId = customer.Id, type = type });
        }
        //[Authorize]
        //[HttpPost]
        //public JsonResult CheckMonitoringFeeAndStartDate(Guid CustomerId, string MonitoringFee, string BillingStartDate)
        //{
        //    string prorateMsg = "";
        //    Customer cus = _Util.Facade.CustomerFacade.GetCustomerByCustomerGuidId(CustomerId);
        //    if (cus != null)
        //    {
        //        if (cus.MonthlyMonitoringFee != MonitoringFee || cus.FirstBilling.Value.ToString("MM/dd/yy") != BillingStartDate.ToDateTime().ToString("MM/dd/yy"))
        //        {
        //            prorateMsg = "Please update customer information.";
        //        }
        //    }
        //    else
        //    {
        //        cus = new Customer();
        //        prorateMsg = "Customer is not found.";
        //    }
        //    return Json(new { result = true, proratemsg = prorateMsg });
        //}
        [Authorize]
        [HttpPost]
        public JsonResult CheckPreviousProratedBill(Guid CustomerId)
        {
            bool hasProrated = false;
            CustomerProratedBill cpb = _Util.Facade.CustomerFacade.GetCustomerLastProratedBillByCustomerId(CustomerId);
            if (cpb != null && !string.IsNullOrWhiteSpace(cpb.InvoiceId))
            {
                hasProrated = true;
            }
            else
            {
                cpb = new CustomerProratedBill();
                hasProrated = false;
            }
            return Json(new { result = true, hasprorated = hasProrated, invoicenumber = cpb.InvoiceId });
        }
        [Authorize]
        [HttpPost]
        public JsonResult GenerateProratedBill(CustomerProratedBill cpb)
        {
            var currentLoggedIn = ((HS.Web.UI.Helper.CustomPrincipal)(User));
            bool result = false;
            CustomerProratedBill temCpb = _Util.Facade.CustomerFacade.GetCustomerLastProratedBillByCustomerId(cpb.CustomerId);

            #region Rolled over prorated invoice
            if (temCpb != null && !string.IsNullOrWhiteSpace(temCpb.InvoiceId))
            {
                Invoice inv = _Util.Facade.InvoiceFacade.GetByInvoiceId(temCpb.InvoiceId);
                if (inv != null)
                {
                    inv.Status = "Cancel";
                    inv.LastUpdatedDate = DateTime.Now.UTCCurrentTime();
                    inv.LastUpdatedByUid = currentLoggedIn.UserId;
                    _Util.Facade.InvoiceFacade.UpdateInvoice(inv);
                }
            }
            #endregion

            Customer cus = _Util.Facade.CustomerFacade.GetCustomerByCustomerGuidId(cpb.CustomerId);
            if (cus == null)
            {
                return Json(new { result = false });
            }
            #region Invoice
            var GetSalesTax = _Util.Facade.GlobalSettingsFacade.GetSalesTax(currentLoggedIn.CompanyId.Value, cus.CustomerId);
            CreateInvoice model = new CreateInvoice();
            var AddressTemplate = _Util.Facade.GlobalSettingsFacade.GetCustomerAddressFormat(currentLoggedIn.CompanyId.Value);
            model.Invoice = new Invoice()
            {
                CustomerId = cus.CustomerId,
                CustomerName = cus.DisplayName,
                IsEstimate = false,
                IsBill = false,
                InvoiceEmailAddress = cus.EmailAddress,
                CompanyId = currentLoggedIn.CompanyId.Value,
                Amount = Math.Round((cpb.Amount), 2),
                BalanceDue = Math.Round(cpb.Amount, 2) + (cpb.BillTax ? Math.Round(((cpb.Amount) * Convert.ToDouble(GetSalesTax.Value)) / 100, 2) : 0),
                Balance = 0,
                Deposit = 0,
                MonitoringAmount = Math.Round(cpb.MonthlyFee, 2),
                Tax = cpb.BillTax ? Math.Round(((cpb.Amount) * Convert.ToDouble(GetSalesTax.Value)) / 100, 2) : 0,
                LateFee = 0,
                LateAmount = 0,
                Status = "Open",
                Description = cpb.StartDate.DateFormat("day") + " to " + cpb.EndDate.DateFormat("day") + " " + cpb.EndDate.ToString("MMMM"),
                CreatedDate = DateTime.Now.UTCCurrentTime(),
                CreatedBy = User.Identity.Name,
                InvoiceFor = "Others",
                InvoiceDate = DateTime.Now.UTCCurrentTime(),
                TotalAmount = Math.Round(cpb.Amount, 2) + (cpb.BillTax ? Math.Round(((cpb.Amount) * Convert.ToDouble(GetSalesTax.Value)) / 100, 2) : 0),
                DueDate = DateTime.Now.UTCCurrentTime(),
                CreatedByUid = currentLoggedIn.UserId,
                LastUpdatedDate = DateTime.Now.UTCCurrentTime(),
                LastUpdatedByUid = currentLoggedIn.UserId
            };

            model.Invoice.BillingAddress = AddressHelper.MakeCustomerAddress(cus, "BillingAddress", AddressTemplate);
            model.Invoice.ShippingAddress = AddressHelper.MakeCustomerAddress(cus, "ShippingAddress", AddressTemplate);
            model.Invoice.LastUpdatedByUid = currentLoggedIn.UserId;
            model.Invoice.Id = _Util.Facade.InvoiceFacade.InsertInvoice(model.Invoice);
            model.Invoice.InvoiceId = model.Invoice.Id.GenerateInvoiceNo();
            model.Invoice.InvoiceFor = "Invoice";
            _Util.Facade.InvoiceFacade.UpdateInvoice(model.Invoice);

            #endregion

            #region invoice details
            //two equipment list inserted in invoicedetails
            InvoiceDetail InvoiceDeil = new InvoiceDetail();

            InvoiceDeil.InvoiceId = model.Invoice.InvoiceId;
            InvoiceDeil.InventoryId = Guid.Empty;
            InvoiceDeil.EquipmentId = Guid.Empty;
            InvoiceDeil.CreatedBy = User.Identity.Name;
            InvoiceDeil.CreatedDate = DateTime.Now.UTCCurrentTime();
            InvoiceDeil.CompanyId = currentLoggedIn.CompanyId.Value;
            InvoiceDeil.Quantity = 1;
            InvoiceDeil.Taxable = cpb.BillTax;

            #region For this month
            InvoiceDeil.EquipName = "Prorated bill for " + cpb.EndDate.ToString("MMMM") + " " + cpb.EndDate.ToString("yyyy");
            InvoiceDeil.EquipDetail = cpb.StartDate.DateFormat("day") + " to " + cpb.EndDate.DateFormat("day") + " " + cpb.EndDate.ToString("MMMM");
            InvoiceDeil.TotalPrice = Math.Round(cpb.Amount, 2);
            InvoiceDeil.UnitPrice = Math.Round(cpb.Amount, 2);
            _Util.Facade.InvoiceFacade.InsertInvoiceDetails(InvoiceDeil);
            #endregion

            #region For Next month
            //InvoiceDeil.EquipName = "Monthly monitoring fee for " + cpb.EndDate.AddMonths(1).ToString("MMMM") + " " + cpb.EndDate.ToString("yyyy");
            //InvoiceDeil.EquipDetail = "Monthly monitoring fee";
            //InvoiceDeil.TotalPrice = Math.Round(cpb.MonthlyFee, 2);
            //InvoiceDeil.UnitPrice = Math.Round(cpb.MonthlyFee, 2);
            //_Util.Facade.InvoiceFacade.InsertInvoiceDetails(InvoiceDeil);
            #endregion

            #endregion

            #region Customer Prorate bill
            CustomerProratedBill newcpb = new CustomerProratedBill();
            newcpb.CompanyId = currentLoggedIn.CompanyId.Value;
            newcpb.InvoiceId = model.Invoice.InvoiceId;
            newcpb.CreatedBy = currentLoggedIn.UserId;
            newcpb.CreatedDate = DateTime.Now.UTCCurrentTime();
            newcpb.CustomerId = cpb.CustomerId;
            newcpb.StartDate = cpb.StartDate;
            newcpb.EndDate = cpb.EndDate;
            newcpb.Amount = cpb.Amount;
            newcpb.DayCount = cpb.DayCount;
            _Util.Facade.CustomerFacade.InsertCustomerProratedBill(newcpb);
            result = true;
            #endregion

            return Json(new { result = result });
        }
        public ActionResult GetGenerateProrate(Guid CustomerId)
        {
            Customer cus = _Util.Facade.CustomerFacade.GetCustomerByCustomerGuidId(CustomerId);
            if (cus == null)
            {
                cus = new Customer();
            }
            return View(cus);
        }
        [Authorize]
        [HttpPost]
        public JsonResult FileToCustomerPDFMail_V2(int? cusid, string PrefferedEmail, int? fileid)
        {
            #region Checking email adress
            List<string> ValidPrefferedEmail = new List<string>();
            if (!string.IsNullOrWhiteSpace(PrefferedEmail))
            {
                string[] Emailadd = PrefferedEmail.Split(';');
                if (Emailadd != null)
                {
                    foreach (var item in Emailadd)
                    {
                        if (item.IsValidEmailAddress())
                        {
                            ValidPrefferedEmail.Add(item);
                        }
                    }
                }
                if (ValidPrefferedEmail.Count == 0)
                {
                    return Json(new { result = false, message = "Invalid email address." });
                }

            }
            #endregion

            FileTemplateWithCustomerInfo model = new FileTemplateWithCustomerInfo();
            FileTemplate ft = new FileTemplate();
            var CurrentLoggedInUser = ((HS.Web.UI.Helper.CustomPrincipal)(User));
            if (cusid.HasValue)
            {
                //model.customerInfo = _Util.Facade.CustomerFacade.GetCustomerById(cusid.Value);
                model.customerInfo = _Util.Facade.CustomerFacade.GetCustomersById(cusid.Value);
                model.InstallationAddress = MakeAddress(model.customerInfo.Street, model.customerInfo.City, model.customerInfo.State, model.customerInfo.ZipCode, "");
                ViewBag.CustomerId = cusid;
            }
            int term = 0;
            double contract;
            string conterm = "";
            if (model.customerInfo != null)
            {
                bool success = Double.TryParse(model.customerInfo.ContractTeam, out contract);
                if (success)
                {
                    term = Convert.ToInt32(Math.Round(contract * 12));
                    ViewBag.termid = term;
                    if (term > 1)
                    {
                        ViewBag.TermMonth = " month";
                    }
                    else
                    {
                        ViewBag.TermMonth = " month";
                    }
                }
                conterm = string.Concat(ViewBag.termid, ViewBag.TermMonth);
            }
            model.ContractTeam = conterm;
            if (CurrentLoggedInUser.UserId != null)
            {
                model.employeeInfo = _Util.Facade.EmployeeFacade.GetEmployeeByEmployeeId(CurrentLoggedInUser.UserId);
                ViewBag.UserId = CurrentLoggedInUser.UserId;
            }

            if (fileid.HasValue)
            {
                model.cusAgreementTemplate = _Util.Facade.FileFacade.GetCustomerAgreementTemplateById(fileid.Value);
                ViewBag.FileTemplateId = fileid;
            }
            if (model.cusAgreementTemplate != null && model.cusAgreementTemplate.IsFileTemplate == true && model.cusAgreementTemplate.ReferenceTemplateId.HasValue)
            {
                ft = _Util.Facade.FileFacade.GetFileTemplateById(model.cusAgreementTemplate.ReferenceTemplateId.Value);
            }
            #region Signature

            CustomerSignature cs = new CustomerSignature();
            GlobalSetting glbs = _Util.Facade.GlobalSettingsFacade.GetGlobalSettingsByKey(CurrentLoggedInUser.CompanyId.Value, "CompanySignature");
            if (model.customerInfo != null && fileid.HasValue)
            {
                cs = _Util.Facade.CustomerSignatureFacade.GetCustomerSignatureByReferenceIdcharCustomerIdType(model.customerInfo.CustomerId, fileid.ToString(), "File Management");
            }

            if (cs != null)
            {
                model.FileManagementCustomerSignature = cs.Signature;
                if (cs.CreatedDate != null && cs.CreatedDate != new DateTime())
                {
                    model.FileManagementCustomerSignatureDate = cs.CreatedDate.UTCToClientTime().ToString("M/dd/yy");
                }
                if (cs != null && glbs != null && !string.IsNullOrWhiteSpace(glbs.Value) && !string.IsNullOrWhiteSpace(cs.Signature))
                {
                    model.CompanySignature = glbs.Value;
                    if (cs.CreatedDate != null && cs.CreatedDate != new DateTime())
                    {
                        model.CompanySignatureDate = cs.CreatedDate.UTCToClientTime().ToString("M/dd/yy");
                    }

                }
                else if (ft != null && ft.IsCustomerSignRequired == false)
                {
                    model.CompanySignature = glbs != null && !string.IsNullOrWhiteSpace(glbs.Value) ? glbs.Value : "";
                }
            }
            #endregion

            #region PDF
            model.Company = _Util.Facade.CompanyFacade.GetCompanyByComapnyId(CurrentLoggedInUser.CompanyId.Value);
            model.Company.CompanyLogo = _Util.Facade.CompanyBranchFacade.GetCompanyLogoForPDFByCompanyId(CurrentLoggedInUser.CompanyId.Value);
            model.Company.Address = MakeAddress(model.Company.Street, model.Company.City, model.Company.State, model.Company.ZipCode, "");
            //string body = _Util.Facade.FileFacade.MakeFileTemplatePdf(model);
            string body = "";
            CustomerCancellationQueue ccq = new CustomerCancellationQueue();
            ccq = _Util.Facade.CustomerFacade.GetCustomerCancellationQueueByCustomerId(model.customerInfo.CustomerId);
            if (ccq != null && ccq.Id > 0 && ccq.CancellationDate.Value != new DateTime() && ccq.CancellationDate.Value != null)
            {
                model.CancellationDate = ccq.CancellationDate.Value.ToString("M/dd/yy");
            }
            else
            {
                model.CancellationDate = "TERMDATE";
            }
            if (ccq != null && ccq.Id > 0 && ccq.RemainingBalance != null)
            {
                model.RemainingBalance = (float)ccq.RemainingBalance;
            }
            else
            {
                model.RemainingBalance = 0;
            }

            if (model.cusAgreementTemplate.Name == "ISPC Invoice Barry Pyron asd")
            {
                model.AdsLogo = string.Concat(AppConfig.SiteDomain, "/Content/img/ads_logo.PNG");
                model.BrinksLogo = string.Concat(AppConfig.SiteDomain, "/Content/img/brinks_logo.PNG");
            }
            if (model.cusAgreementTemplate.Name == "Finance Terms")
            {
                model.OnitSmartHome = string.Concat(AppConfig.SiteDomain, "/Content/img/onit_smart_home.png");
            }
            if (model.cusAgreementTemplate.Name == "Kazar Commercial Agreement" || model.cusAgreementTemplate.Name == "Kazar Residential Alarm Agreement")
            {
                model.KazarLogo = string.Concat(AppConfig.SiteDomain, "/Content/img/kazar_logo.PNG");
            }
            body = _Util.Facade.FileFacade.MakeFileTemplatePdf(model);

            ViewBag.Body = body;
            ViewAsPdf actionPDF;
            if (model.cusAgreementTemplate.Name == "Residential Security Sale Agmt")
            {
                actionPDF = new Rotativa.ViewAsPdf("~/Views/File/FileInstallation.cshtml")
                {
                    PageSize = Rotativa.Options.Size.Legal,
                    PageOrientation = Rotativa.Options.Orientation.Portrait,
                    PageMargins = { Left = 1, Right = 1 },

                };
            }
            else
            {
                actionPDF = new Rotativa.ViewAsPdf("~/Views/File/FileInstallation.cshtml")
                {
                    PageSize = Rotativa.Options.Size.A4,
                    PageOrientation = Rotativa.Options.Orientation.Portrait,
                    PageMargins = { Left = 1, Right = 1 },

                };
            }

            string EmailAddress = PrefferedEmail;
            if (ValidPrefferedEmail.Count == 0)
            {
                EmailAddress = model.customerInfo.EmailAddress;
            }
            else
            {
                EmailAddress = string.Join(";", ValidPrefferedEmail);
            }

            byte[] applicationPDFData = actionPDF.BuildPdf(ControllerContext);
            Stream stream = new MemoryStream(applicationPDFData);
            #endregion

            string message = "";
            bool result = false;
            string encryptedurl = DESEncryptionDecryption.EncryptPlainTextToCipherText(cusid + "#" + EmailAddress + "#" + CurrentLoggedInUser.CompanyId.Value.ToString() + "#" + fileid + "#" + CurrentLoggedInUser.UserId);
            string fullurl = string.Concat(AppConfig.SiteDomain, "/File-Template/", encryptedurl);

            ShortUrl ShortUrl = _Util.Facade.ShortUrlFacade.GetSortUrlByUrl(fullurl, model.customerInfo.CustomerId);
            string shortUrl = string.Concat(AppConfig.ShortSiteDomain, "/shrt/", ShortUrl.Code);

            #region File Management Body contect
            //string bodyContent = "";
            bool IsFileWithoutCustomerSign = false;
            //if (ft != null)
            //{
            if (ft != null && ft.IsCustomerSignRequired == false)
            {
                //bodyContent = "Please review the attached document.";
                IsFileWithoutCustomerSign = true;
            }
            //    else
            //    {
            //        bodyContent = "Please click the link below to review and sign the file!";
            //        bodyContent += "<br /><br /><a style='line-height: 2.6666666666666665rem; background-color: #2ca01c; color: #333; border: 1px solid #d6d6d6; -webkit-transition: background-color .2s ease-in; transition: background-color .2s ease-in; font-size: 1rem; font-family: Open Sans, Helvetica, Arial, sans-serif; font-weight: 400; display: block; height: 2.8rem; -webkit-box-sizing: border-box; -moz-box-sizing: border-box; -o-box-sizing: border-box; -ms-box-sizing: border-box; box-sizing: border-box; -webkit-border-radius: 4px; -moz-border-radius: 4px; border-radius: 4px; -moz-background-clip: padding; -webkit-background-clip: padding-box; background-clip: padding-box; text-align: center; vertical-align: middle; margin: 0 auto 11px; padding: 0 15px; white-space: nowrap; cursor: pointer; -webkit-user-select: none; -moz-user-select: none; -ms-user-select: none; -o-user-select: none; width: 100%; max-width: 165px; text-decoration:none; color:white; font-weight:600;' href='" + shortUrl + "'>File</a>";
            //    }
            //}
            //else
            //{
            //    bodyContent = "Please click the link below to review and sign the file!";
            //    bodyContent += "<br /><br /><a style='line-height: 2.6666666666666665rem; background-color: #2ca01c; color: #333; border: 1px solid #d6d6d6; -webkit-transition: background-color .2s ease-in; transition: background-color .2s ease-in; font-size: 1rem; font-family: Open Sans, Helvetica, Arial, sans-serif; font-weight: 400; display: block; height: 2.8rem; -webkit-box-sizing: border-box; -moz-box-sizing: border-box; -o-box-sizing: border-box; -ms-box-sizing: border-box; box-sizing: border-box; -webkit-border-radius: 4px; -moz-border-radius: 4px; border-radius: 4px; -moz-background-clip: padding; -webkit-background-clip: padding-box; background-clip: padding-box; text-align: center; vertical-align: middle; margin: 0 auto 11px; padding: 0 15px; white-space: nowrap; cursor: pointer; -webkit-user-select: none; -moz-user-select: none; -ms-user-select: none; -o-user-select: none; width: 100%; max-width: 165px; text-decoration:none; color:white; font-weight:600;' href='" + shortUrl + "'>File</a>";
            //}
            #endregion

            if (model.customerInfo != null)
            {

                if (ValidPrefferedEmail.Count > 0 || (!string.IsNullOrWhiteSpace(model.customerInfo.EmailAddress) && model.customerInfo.EmailAddress.IsValidEmailAddress()))
                {
                    result = true;
                    FileManagement fm = new FileManagement
                    {
                        CustomerNum = model.customerInfo.FirstName + " " + model.customerInfo.LastName,
                        ToEmail = EmailAddress,
                        CompanyName = CurrentLoggedInUser.CompanyName,
                        BodyLink = shortUrl,
                        IsFileWithoutCustomerSign = IsFileWithoutCustomerSign,
                        //Subject = string.Format("REVIEW REQUIRED: See attached document from {0} at {1}", CurrentLoggedInUser.FirstName + " " + CurrentLoggedInUser.LastName, CurrentLoggedInUser.CompanyName),
                        //Body = bodyContent,
                        CustomerId = model.customerInfo.CustomerId.ToString(),
                        EmployeeId = CurrentLoggedInUser.UserId.ToString(),
                        fileManagementpdf = ft != null && ft.IsCustomerSignRequired == false ? new System.Net.Mail.Attachment(stream, model.customerInfo.Id + ".pdf") : null
                    };
                    result = _Util.Facade.MailFacade.EmailFileManagement(fm, CurrentLoggedInUser.CompanyId.Value, null);
                    if (result == false)
                    {
                        message = "Email send failed.";
                    }
                    else
                    {
                        message = "File sent to " + EmailAddress;
                    }
                }
                else
                {
                    result = false;
                    message = "Invalid email address.";
                }
            }

            return Json(new { result = result, message = message });
        }

        public JsonResult FileToCustomerPDFMail(int? cusid, string PrefferedEmail, int? fileid)
        {

            WebClient webClient;
            byte[] fileBytes1;
            string Temp_FileName;

            #region Checking email adress
            List<string> ValidPrefferedEmail = new List<string>();
            if (!string.IsNullOrWhiteSpace(PrefferedEmail))
            {
                string[] Emailadd = PrefferedEmail.Split(';');
                if (Emailadd != null)
                {
                    foreach (var item in Emailadd)
                    {
                        if (item.IsValidEmailAddress())
                        {
                            ValidPrefferedEmail.Add(item);
                        }
                    }
                }
                if (ValidPrefferedEmail.Count == 0)
                {
                    return Json(new { result = false, message = "Invalid email address." });
                }

            }
            #endregion

            FileTemplateWithCustomerInfo model = new FileTemplateWithCustomerInfo();
            FileTemplate ft = new FileTemplate();
            var CurrentLoggedInUser = ((HS.Web.UI.Helper.CustomPrincipal)(User));
            if (cusid.HasValue)
            {
                //model.customerInfo = _Util.Facade.CustomerFacade.GetCustomerById(cusid.Value);
                model.customerInfo = _Util.Facade.CustomerFacade.GetCustomersById(cusid.Value);
                model.InstallationAddress = MakeAddress(model.customerInfo.Street, model.customerInfo.City, model.customerInfo.State, model.customerInfo.ZipCode, "");
                ViewBag.CustomerId = cusid;
            }
            int term = 0;
            double contract;
            string conterm = "";
            if (model.customerInfo != null)
            {
                bool success = Double.TryParse(model.customerInfo.ContractTeam, out contract);
                if (success)
                {
                    term = Convert.ToInt32(Math.Round(contract * 12));
                    ViewBag.termid = term;
                    if (term > 1)
                    {
                        ViewBag.TermMonth = " month";
                    }
                    else
                    {
                        ViewBag.TermMonth = " month";
                    }
                }
                conterm = string.Concat(ViewBag.termid, ViewBag.TermMonth);
            }
            model.ContractTeam = conterm;
            if (CurrentLoggedInUser.UserId != null)
            {
                model.employeeInfo = _Util.Facade.EmployeeFacade.GetEmployeeByEmployeeId(CurrentLoggedInUser.UserId);
                ViewBag.UserId = CurrentLoggedInUser.UserId;
            }

            if (fileid.HasValue)
            {
                model.cusAgreementTemplate = _Util.Facade.FileFacade.GetCustomerAgreementTemplateById(fileid.Value);
                ViewBag.FileTemplateId = fileid;
            }
            if (model.cusAgreementTemplate != null && model.cusAgreementTemplate.IsFileTemplate == true && model.cusAgreementTemplate.ReferenceTemplateId.HasValue)
            {
                ft = _Util.Facade.FileFacade.GetFileTemplateById(model.cusAgreementTemplate.ReferenceTemplateId.Value);
            }
            #region Signature

            CustomerSignature cs = new CustomerSignature();
            GlobalSetting glbs = _Util.Facade.GlobalSettingsFacade.GetGlobalSettingsByKey(CurrentLoggedInUser.CompanyId.Value, "CompanySignature");
            if (model.customerInfo != null && fileid.HasValue)
            {
                cs = _Util.Facade.CustomerSignatureFacade.GetCustomerSignatureByReferenceIdcharCustomerIdType(model.customerInfo.CustomerId, fileid.ToString(), "File Management");
            }

            if (cs != null)
            {
                model.FileManagementCustomerSignature = cs.Signature;
                if (cs.CreatedDate != null && cs.CreatedDate != new DateTime())
                {
                    model.FileManagementCustomerSignatureDate = cs.CreatedDate.UTCToClientTime().ToString("M/dd/yy");
                }
                if (cs != null && glbs != null && !string.IsNullOrWhiteSpace(glbs.Value) && !string.IsNullOrWhiteSpace(cs.Signature))
                {
                    model.CompanySignature = glbs.Value;
                    if (cs.CreatedDate != null && cs.CreatedDate != new DateTime())
                    {
                        model.CompanySignatureDate = cs.CreatedDate.UTCToClientTime().ToString("M/dd/yy");
                    }

                }
                else if (ft != null && ft.IsCustomerSignRequired == false)
                {
                    model.CompanySignature = glbs != null && !string.IsNullOrWhiteSpace(glbs.Value) ? glbs.Value : "";
                }
            }
            #endregion

            #region PDF
            model.Company = _Util.Facade.CompanyFacade.GetCompanyByComapnyId(CurrentLoggedInUser.CompanyId.Value);
            model.Company.CompanyLogo = _Util.Facade.CompanyBranchFacade.GetCompanyLogoForPDFByCompanyId(CurrentLoggedInUser.CompanyId.Value);
            model.Company.Address = MakeAddress(model.Company.Street, model.Company.City, model.Company.State, model.Company.ZipCode, "");
            //string body = _Util.Facade.FileFacade.MakeFileTemplatePdf(model);
            string body = "";
            CustomerCancellationQueue ccq = new CustomerCancellationQueue();
            ccq = _Util.Facade.CustomerFacade.GetCustomerCancellationQueueByCustomerId(model.customerInfo.CustomerId);
            if (ccq != null && ccq.Id > 0 && ccq.CancellationDate.Value != new DateTime() && ccq.CancellationDate.Value != null)
            {
                model.CancellationDate = ccq.CancellationDate.Value.ToString("M/dd/yy");
            }
            else
            {
                model.CancellationDate = "TERMDATE";
            }
            if (ccq != null && ccq.Id > 0 && ccq.RemainingBalance != null)
            {
                model.RemainingBalance = (float)ccq.RemainingBalance;
            }
            else
            {
                model.RemainingBalance = 0;
            }

            if (model.cusAgreementTemplate.Name == "ISPC Invoice Barry Pyron asd")
            {
                model.AdsLogo = string.Concat(AppConfig.SiteDomain, "/Content/img/ads_logo.PNG");
                model.BrinksLogo = string.Concat(AppConfig.SiteDomain, "/Content/img/brinks_logo.PNG");
            }
            if (model.cusAgreementTemplate.Name == "Finance Terms")
            {
                model.OnitSmartHome = string.Concat(AppConfig.SiteDomain, "/Content/img/onit_smart_home.png");
            }
            if (model.cusAgreementTemplate.Name == "Kazar Commercial Agreement" || model.cusAgreementTemplate.Name == "Kazar Residential Alarm Agreement")
            {
                model.KazarLogo = string.Concat(AppConfig.SiteDomain, "/Content/img/kazar_logo.PNG");
            }
            body = _Util.Facade.FileFacade.MakeFileTemplatePdf(model);

            ViewBag.Body = body;
            ViewAsPdf actionPDF;
            if (model.cusAgreementTemplate.Name == "Residential Security Sale Agmt")
            {
                actionPDF = new Rotativa.ViewAsPdf("~/Views/File/FileInstallation.cshtml")
                {
                    PageSize = Rotativa.Options.Size.Legal,
                    PageOrientation = Rotativa.Options.Orientation.Portrait,
                    PageMargins = { Left = 1, Right = 1 },

                };
            }
            else
            {
                actionPDF = new Rotativa.ViewAsPdf("~/Views/File/FileInstallation.cshtml")
                {
                    PageSize = Rotativa.Options.Size.A4,
                    PageOrientation = Rotativa.Options.Orientation.Portrait,
                    PageMargins = { Left = 1, Right = 1 },

                };
            }

            string EmailAddress = PrefferedEmail;
            if (ValidPrefferedEmail.Count == 0)
            {
                EmailAddress = model.customerInfo.EmailAddress;
            }
            else
            {
                EmailAddress = string.Join(";", ValidPrefferedEmail);
            }

            byte[] applicationPDFData = actionPDF.BuildPdf(ControllerContext);
            Stream stream = new MemoryStream(applicationPDFData);
            #endregion

            string message = "";
            bool result = false;
            string encryptedurl = DESEncryptionDecryption.EncryptPlainTextToCipherText(cusid + "#" + EmailAddress + "#" + CurrentLoggedInUser.CompanyId.Value.ToString() + "#" + fileid + "#" + CurrentLoggedInUser.UserId);
            string fullurl = string.Concat(AppConfig.SiteDomain, "/File-Template/", encryptedurl);

            ShortUrl ShortUrl = _Util.Facade.ShortUrlFacade.GetSortUrlByUrl(fullurl, model.customerInfo.CustomerId);
            string shortUrl = string.Concat(AppConfig.ShortSiteDomain, "/shrt/", ShortUrl.Code);

            #region File Management Body contect
            //string bodyContent = "";
            bool IsFileWithoutCustomerSign = false;
            //if (ft != null)
            //{
            if (ft != null && ft.IsCustomerSignRequired == false)
            {
                //bodyContent = "Please review the attached document.";
                IsFileWithoutCustomerSign = true;
            }
            //    else
            //    {
            //        bodyContent = "Please click the link below to review and sign the file!";
            //        bodyContent += "<br /><br /><a style='line-height: 2.6666666666666665rem; background-color: #2ca01c; color: #333; border: 1px solid #d6d6d6; -webkit-transition: background-color .2s ease-in; transition: background-color .2s ease-in; font-size: 1rem; font-family: Open Sans, Helvetica, Arial, sans-serif; font-weight: 400; display: block; height: 2.8rem; -webkit-box-sizing: border-box; -moz-box-sizing: border-box; -o-box-sizing: border-box; -ms-box-sizing: border-box; box-sizing: border-box; -webkit-border-radius: 4px; -moz-border-radius: 4px; border-radius: 4px; -moz-background-clip: padding; -webkit-background-clip: padding-box; background-clip: padding-box; text-align: center; vertical-align: middle; margin: 0 auto 11px; padding: 0 15px; white-space: nowrap; cursor: pointer; -webkit-user-select: none; -moz-user-select: none; -ms-user-select: none; -o-user-select: none; width: 100%; max-width: 165px; text-decoration:none; color:white; font-weight:600;' href='" + shortUrl + "'>File</a>";
            //    }
            //}
            //else
            //{
            //    bodyContent = "Please click the link below to review and sign the file!";
            //    bodyContent += "<br /><br /><a style='line-height: 2.6666666666666665rem; background-color: #2ca01c; color: #333; border: 1px solid #d6d6d6; -webkit-transition: background-color .2s ease-in; transition: background-color .2s ease-in; font-size: 1rem; font-family: Open Sans, Helvetica, Arial, sans-serif; font-weight: 400; display: block; height: 2.8rem; -webkit-box-sizing: border-box; -moz-box-sizing: border-box; -o-box-sizing: border-box; -ms-box-sizing: border-box; box-sizing: border-box; -webkit-border-radius: 4px; -moz-border-radius: 4px; border-radius: 4px; -moz-background-clip: padding; -webkit-background-clip: padding-box; background-clip: padding-box; text-align: center; vertical-align: middle; margin: 0 auto 11px; padding: 0 15px; white-space: nowrap; cursor: pointer; -webkit-user-select: none; -moz-user-select: none; -ms-user-select: none; -o-user-select: none; width: 100%; max-width: 165px; text-decoration:none; color:white; font-weight:600;' href='" + shortUrl + "'>File</a>";
            //}
            #endregion

            if (model.customerInfo != null)
            {

                if (ValidPrefferedEmail.Count > 0 || (!string.IsNullOrWhiteSpace(model.customerInfo.EmailAddress) && model.customerInfo.EmailAddress.IsValidEmailAddress()))
                {
                    result = true;
                    FileManagement fm = new FileManagement
                    {
                        CustomerNum = model.customerInfo.FirstName + " " + model.customerInfo.LastName,
                        ToEmail = EmailAddress,
                        CompanyName = CurrentLoggedInUser.CompanyName,
                        BodyLink = shortUrl,
                        IsFileWithoutCustomerSign = IsFileWithoutCustomerSign,
                        //Subject = string.Format("REVIEW REQUIRED: See attached document from {0} at {1}", CurrentLoggedInUser.FirstName + " " + CurrentLoggedInUser.LastName, CurrentLoggedInUser.CompanyName),
                        //Body = bodyContent,
                        CustomerId = model.customerInfo.CustomerId.ToString(),
                        EmployeeId = CurrentLoggedInUser.UserId.ToString(),
                        fileManagementpdf = ft != null && ft.IsCustomerSignRequired == false ? new System.Net.Mail.Attachment(stream, model.customerInfo.Id + ".pdf") : null
                    };
                    result = _Util.Facade.MailFacade.EmailFileManagement(fm, CurrentLoggedInUser.CompanyId.Value, null);
                    if (result == false)
                    {
                        message = "Email send failed.";
                    }
                    else
                    {
                        message = "File sent to " + EmailAddress;
                    }
                }
                else
                {
                    result = false;
                    message = "Invalid email address.";
                }
            }

            return Json(new { result = result, message = message });
        }
        [HttpPost]
        public JsonResult ChangeContractSigned(int id, string IsSigned)
        {
            bool result = false;
            var CurrentUser = (HS.Web.UI.Helper.CustomPrincipal)User;


            CustomerCancellationQueue cusqueue = _Util.Facade.CustomerFacade.GetCustomerCancellationQueueById(id);

            if (cusqueue != null)
            {
                if (cusqueue.IsSigned == false)
                {
                    cusqueue.IsSigned = true;
                }
                else
                {
                    cusqueue.IsSigned = false;

                }

                _Util.Facade.CustomerFacade.UpdateCustomerCancellationQueue(cusqueue);
                result = true;
            }

            return Json(new { result = result });
        }
        public ActionResult SendContractFromCustomer(Guid CustomerId)
        {
            Customer cus = _Util.Facade.CustomerFacade.GetCustomerByCustomerGuidId(CustomerId);
            CustomerExtended cusExt = _Util.Facade.CustomerFacade.GetCustomerExtendedByCustomerId(CustomerId);
            EContractModel emodel = new EContractModel();
            if (cus != null)
            {
                if (cus.ActivationFee.HasValue)
                {
                    emodel.ActivationFee = cus.ActivationFee.Value;
                }
                else
                {
                    emodel.ActivationFee = 0;
                }
                if (cus.InstallDate.HasValue && cus.InstallDate != new DateTime())
                {
                    emodel.InstallStartDate = cus.InstallDate.Value.Date;
                }
                else
                {
                    emodel.InstallStartDate = DateTime.Now.Date;
                }
                if (!string.IsNullOrEmpty(cus.EcontractId))
                {
                    emodel.EcontractId = cus.EcontractId;
                }

            }
            if (cusExt != null)
            {
                if (cusExt.InstallFinishDate.HasValue && cusExt.InstallFinishDate != new DateTime())
                {
                    emodel.InstallFinishDate = cusExt.InstallFinishDate.Value.Date;
                }
                else
                {
                    emodel.InstallFinishDate = DateTime.Now.Date;
                }
                if (cusExt.PaymentEffectiveDate.HasValue && cusExt.PaymentEffectiveDate != new DateTime())
                {
                    emodel.PaymentEffectiveDate = cusExt.PaymentEffectiveDate.Value.Date;
                }
                else
                {
                    emodel.PaymentEffectiveDate = DateTime.Now.AddMonths(1).Date;
                }
                if (cusExt.PromotionMonth.HasValue)
                {
                    emodel.PromotionMonth = cusExt.PromotionMonth.Value;
                }

                else
                {
                    emodel.PromotionMonth = 0;
                }
                if (cusExt.PrepaidMonth.HasValue)
                {
                    emodel.PrepaidMonth = cusExt.PrepaidMonth.Value;
                }
                else
                {
                    emodel.PrepaidMonth = 1;
                }
            }

            return View(emodel);
        }

        #region QA
        [Authorize]
        public PartialViewResult CustomerQA(Guid id)
        {

            if (!base.IsPermitted(UserPermissions.LeadPermissions.QATab))
            {
                return PartialView("~/Views/Shared/_AccessDenied.cshtml");
            }

            var CurrentUser = (HS.Web.UI.Helper.CustomPrincipal)User;
            //bool result = _Util.Facade.CustomerFacade.CustomerIsInCompany(id, CurrentUser.CompanyId.Value);
            //if (!result)
            //{
            //    return PartialView("~/Views/Shared/_AccessDenied.cshtml");
            //}

            ViewBag.CustomerId = id;
            return PartialView("_CustomerQA");
        }

        [Authorize]
        public PartialViewResult LoadQA1(Guid id)
        {
            if (!base.IsPermitted(UserPermissions.LeadPermissions.QATab))
            {
                return PartialView("~/Views/Shared/_AccessDenied.cshtml");
            }
            List<QA1Script> _qa1List = _Util.Facade.CustomerFacade.GetAllQA1ByCustomerId(id).OrderByDescending(x => x.Id).ToList();
            if (_qa1List == null && _qa1List.Count() < 0)
            {
                _qa1List = new List<QA1Script>();
            }
            ViewBag.CustomerId = id;

            return PartialView("_LoadQA1", _qa1List);
        }

        [Authorize]
        public PartialViewResult LoadQA2(Guid id)
        {
            if (!base.IsPermitted(UserPermissions.LeadPermissions.QATab))
            {
                return PartialView("~/Views/Shared/_AccessDenied.cshtml");
            }
            List<QA2Script> _qa2List = _Util.Facade.CustomerFacade.GetAllQA2ByCustomerId(id).OrderByDescending(x => x.Id).ToList();
            if (_qa2List == null && _qa2List.Count() < 0)
            {
                _qa2List = new List<QA2Script>();
            }
            ViewBag.CustomerId = id;
            return PartialView("_LoadQA2", _qa2List);
        }
        [Authorize]
        public PartialViewResult LoadQAFinance(Guid id)
        {
            if (!base.IsPermitted(UserPermissions.LeadPermissions.QATab))
            {
                return PartialView("~/Views/Shared/_AccessDenied.cshtml");
            }
            List<QAFinance> _qaFinanceList = _Util.Facade.CustomerFacade.GetAllQAFinanceByCustomerId(id).OrderByDescending(x => x.Id).ToList();
            if (_qaFinanceList == null && _qaFinanceList.Count() < 0)
            {
                _qaFinanceList = new List<QAFinance>();
            }
            ViewBag.CustomerId = id;
            return PartialView("_LoadQAFinance", _qaFinanceList);
        }
        [Authorize]
        public ActionResult AddQA1(Guid id, int? qa1Id)
        {
            var currentLoggedIn = ((HS.Web.UI.Helper.CustomPrincipal)(User));
            if (currentLoggedIn == null)
            {
                return PartialView("~/Views/Shared/_AccessDenied.cshtml");
            }
            CreateQA1Model _qa1 = new CreateQA1Model();
            _qa1.NoteList = new List<string>();
            _qa1.MonthlyRate = 0;
            _qa1.EquipmentFee = 0;
            _qa1.DiscountAmount = 0;
            _qa1.customer = _Util.Facade.CustomerFacade.GetCustomerByCustomerId(id);
            _qa1.ticket = _Util.Facade.TicketFacade.GetInstallationTicketByCustomerId(id);
            if (_qa1.customer == null)
            {
                _qa1.customer = new Customer();
            }
            else
            {
                #region Monthly rate,Activation fee and equipment fee from smart pakage
                GlobalSetting GetSalesTax = _Util.Facade.GlobalSettingsFacade.GetSalesTax(currentLoggedIn.CompanyId.Value, _qa1.customer.CustomerId);
                //List<CustomerPackageService> _cps = _Util.Facade.PackageFacade.GetAllPackageServiceByCustomerIdAndCompanyId(_qa2.customer.CustomerId, currentLoggedIn.CompanyId.Value);
                List<CustomerPackageEqp> _cpe = _Util.Facade.PackageFacade.GetAllPackageEqpByCustomerIdAndCompanyId(_qa1.customer.CustomerId, currentLoggedIn.CompanyId.Value);
                PackageCustomer _pc = _Util.Facade.PackageFacade.GetPackageCustomerByCustomerId(_qa1.customer.CustomerId);
                //if (_cps != null && _cps.Count() > 0)
                //{
                //    foreach (var item in _cps)
                //    {
                //        _qa2.MonthlyRate += item.Total.HasValue ? Math.Round(item.Total.Value, 2) : 0;
                //    }
                //}
                #region Monthly fee from contract
                string contractMonthlyFee = _Util.Facade.CustomerFacade.GetMonthlyFeeFromContractByCustomerId(_qa1.customer.CustomerId, currentLoggedIn.CompanyId.Value);
                if (!string.IsNullOrWhiteSpace(contractMonthlyFee) && Convert.ToDouble(contractMonthlyFee) > 0)
                {
                    _qa1.customer.MonthlyMonitoringFee = contractMonthlyFee;
                    _qa1.MonthlyRate = Convert.ToDouble(contractMonthlyFee);
                }
                else
                {
                    _qa1.MonthlyRate = 0.0;
                }
                #endregion
                if (_cpe != null && _cpe.Count() > 0)
                {
                    foreach (var item in _cpe)
                    {
                        _qa1.EquipmentFee += item.Total.HasValue ? Math.Round(item.Total.Value, 2) : 0;
                        _qa1.DiscountAmount += item.DiscountUnitPricce.HasValue ? Math.Round(item.DiscountUnitPricce.Value, 2) : 0;
                    }
                }
                _qa1.ActivationFee = _pc != null && _pc.ActivationFee.HasValue ? Math.Round(_pc.ActivationFee.Value, 2) : 0;
                _qa1.ActivationFee += _pc != null && _pc.NonConformingFee.HasValue ? Math.Round(_pc.NonConformingFee.Value, 2) : 0;
                //if (GetSalesTax != null)
                //{
                //    _qa1.MonthlyRate = Math.Round(_qa1.MonthlyRate + ((_qa1.MonthlyRate * Convert.ToDouble(GetSalesTax.Value)) / 100), 2);
                //    _qa1.EquipmentFee = Math.Round(_qa1.EquipmentFee + ((_qa1.EquipmentFee * Convert.ToDouble(GetSalesTax.Value)) / 100), 2);
                //    _qa1.ActivationFee = Math.Round(_qa1.ActivationFee + ((_qa1.ActivationFee * Convert.ToDouble(GetSalesTax.Value)) / 100), 2);
                //}
                #endregion
                #region Payment Information
                List<PaymentInfo> PaymentInfoList = _Util.Facade.PaymentInfoFacade.GetAllPaymentInfoByCustomerIdAndCompanyId(_qa1.customer.CustomerId, currentLoggedIn.CompanyId.Value);
                var CreditCardInfo = PaymentInfoList.Where(x => x.CardSecurityCode != "" && x.CardNumber != "" && x.CardExpireDate != "" && x.PayFor == "MMR").FirstOrDefault();
                var ACHInfo = PaymentInfoList.Where(x => x.BankAccountType != "" && x.EcheckType != "" && x.RoutingNo != "" && x.AcountNo != "" && x.PayFor == "MMR").FirstOrDefault();
                if (CreditCardInfo != null)
                {
                    _qa1.PaymentType = "Credit card account no ";
                }
                else if (ACHInfo != null && ACHInfo.AcountNo.Length > 4)
                {
                    _qa1.PaymentType = "ACH account no ";
                }
                #endregion 
            }

            if (_qa1.ticket == null)
            {
                _qa1.ticket = new Ticket();
            }
            else
            {
                #region Get Ticket Appoinment Start and End Time 
                CustomerAppointment ca = _Util.Facade.CustomerAppoinmentFacade.GetCustomerAppointmentDetailByAppointmentId(_qa1.ticket.TicketId);
                if (ca != null)
                {
                    _qa1.ticket.AppointmentStartTime = ca.AppointmentStartTime;
                    _qa1.ticket.AppointmentEndTime = ca.AppointmentEndTime;
                }
                #endregion
                #region Equipment list
                _qa1.eqpList = _Util.Facade.CustomerAppoinmentFacade.GetAllCustomerAppointmentEquipListByAppointmentId(_qa1.ticket.TicketId);
                if (_qa1.eqpList == null && _qa1.eqpList.Count() <= 0)
                {
                    _qa1.eqpList = new List<CustomerAppointmentEquipment>();
                }
                #endregion
            }
            if (qa1Id.HasValue)
            {
                _qa1.qa1Script = _Util.Facade.CustomerFacade.GetQA1ByCustomerIdAndId(qa1Id.Value, id);
            }
            if (_qa1.qa1Script == null)
            {
                _qa1.qa1Script = new QA1Script();
            }
            #region Note List added
            if (_qa1.qa1Script != null && !string.IsNullOrWhiteSpace(_qa1.qa1Script.NameUpdateNote))
            {
                _qa1.NoteList.Add(_qa1.qa1Script.NameUpdateNote);
            }
            if (_qa1.qa1Script != null && !string.IsNullOrWhiteSpace(_qa1.qa1Script.AddressUpdateNote))
            {
                _qa1.NoteList.Add(_qa1.qa1Script.AddressUpdateNote);
            }
            if (_qa1.qa1Script != null && !string.IsNullOrWhiteSpace(_qa1.qa1Script.HomeownerNameUpdateNote))
            {
                _qa1.NoteList.Add(_qa1.qa1Script.HomeownerNameUpdateNote);
            }
            if (_qa1.qa1Script != null && !string.IsNullOrWhiteSpace(_qa1.qa1Script.ReponsiblePartyNameUpdateNote))
            {
                _qa1.NoteList.Add(_qa1.qa1Script.ReponsiblePartyNameUpdateNote);
            }
            if (_qa1.qa1Script != null && !string.IsNullOrWhiteSpace(_qa1.qa1Script.PrimaryPhoneUpdateNote))
            {
                _qa1.NoteList.Add(_qa1.qa1Script.PrimaryPhoneUpdateNote);
            }
            if (_qa1.qa1Script != null && !string.IsNullOrWhiteSpace(_qa1.qa1Script.EmailUpdateNote))
            {
                _qa1.NoteList.Add(_qa1.qa1Script.EmailUpdateNote);
            }
            if (_qa1.qa1Script != null && !string.IsNullOrWhiteSpace(_qa1.qa1Script.DateOfBirthUpdateNote))
            {
                _qa1.NoteList.Add(_qa1.qa1Script.DateOfBirthUpdateNote);
            }
            if (_qa1.qa1Script != null && !string.IsNullOrWhiteSpace(_qa1.qa1Script.SSNUpdateNote))
            {
                _qa1.NoteList.Add(_qa1.qa1Script.SSNUpdateNote);
            }
            #endregion

            _qa1.UserName = _Util.Facade.EmployeeFacade.GetEmployeeNumByEmployeeId(currentLoggedIn.UserId);
            ViewBag.CustomerId = id;

            #region ViewBag
            //List<SelectListItem> QA1RepList = new List<SelectListItem>();
            List<Employee> empLsit = _Util.Facade.EmployeeFacade.GetCurrentEmployeeListByCompanyId(currentLoggedIn.CompanyId.Value);
            ViewBag.CurrentUserId = currentLoggedIn.UserId.ToString();
            ViewBag.CurrentEmployeeList = empLsit.ToList();
            //ViewBag.QA1RepList= empLsit.Select(x =>
            //             new SelectListItem()
            //             {
            //                 Text = x.FirstName.ToString() + " "+ x.LastName.ToString(),
            //                 Value = x.UserId.ToString(),
            //                 Selected= _qa1.qa1Script!= null && _qa1.qa1Script.QARep.ToString() != "00000000-0000-0000-0000-000000000000" ? _qa1.qa1Script.QARep.ToString() == x.UserId.ToString() :  x.UserId.ToString() == currentLoggedIn.UserId.ToString() 
            //             }).ToList();
            //ViewBag.CurrentEmployeeList = empLsit.Select(x =>
            //              new SelectListItem()
            //              {
            //                  Text = x.FirstName.ToString() + " " + x.LastName.ToString(),
            //                  Value = x.UserId.ToString(),
            //                  Selected = _qa1.qa1Script != null && _qa1.qa1Script.CreatedByUid.ToString() != "00000000-0000-0000-0000-000000000000" ? _qa1.qa1Script.CreatedByUid.ToString() == x.UserId.ToString() : x.UserId.ToString() == currentLoggedIn.UserId.ToString()
            //              }).ToList();
            //ViewBag.SalesRepList = empLsit.Select(x =>
            //              new SelectListItem()
            //              {
            //                  Text = x.FirstName.ToString() + " " + x.LastName.ToString(),
            //                  Value = x.UserId.ToString(),
            //                  Selected = _qa1.qa1Script != null && _qa1.qa1Script.SalesRep.ToString() != "00000000-0000-0000-0000-000000000000" ? _qa1.qa1Script.SalesRep.ToString() == x.UserId.ToString() : x.UserId.ToString() == _qa1.customer.Soldby.ToString()
            //              }).ToList();
            #endregion

            return View(_qa1);
        }

        [Authorize]
        public ActionResult AddQA2(Guid id, int? qa2Id)
        {
            var currentLoggedIn = ((HS.Web.UI.Helper.CustomPrincipal)(User));

            if (currentLoggedIn == null)
            {
                return PartialView("~/Views/Shared/_AccessDenied.cshtml");
            }
            CreateQA2Model _qa2 = new CreateQA2Model();
            _qa2.NoteList = new List<string>();
            _qa2.MonthlyRate = 0;
            _qa2.EquipmentFee = 0;
            _qa2.customer = _Util.Facade.CustomerFacade.GetCustomerByCustomerId(id);
            _qa2.cusextnd = _Util.Facade.CustomerFacade.GetCustomerExtendedByCustomerId(id);
            _qa2.TicketTech = _Util.Facade.TicketFacade.GetInstallationTicketTechByCustomerId(id);
            if (_qa2.TicketTech == null)
            {
                _qa2.TicketTech = new TicketUser();
            }
            if (_qa2.customer == null)
            {
                _qa2.customer = new Customer();
            }
            if (_qa2.cusextnd == null)
            {
                _qa2.cusextnd = new CustomerExtended();
            }
            else
            {
                #region Monthly rate,Activation fee and equipment fee from smart pakage
                GlobalSetting GetSalesTax = _Util.Facade.GlobalSettingsFacade.GetSalesTax(currentLoggedIn.CompanyId.Value, _qa2.customer.CustomerId);
                //List<CustomerPackageService> _cps = _Util.Facade.PackageFacade.GetAllPackageServiceByCustomerIdAndCompanyId(_qa2.customer.CustomerId, currentLoggedIn.CompanyId.Value);
                List<CustomerPackageEqp> _cpe = _Util.Facade.PackageFacade.GetAllPackageEqpByCustomerIdAndCompanyId(_qa2.customer.CustomerId, currentLoggedIn.CompanyId.Value);
                PackageCustomer _pc = _Util.Facade.PackageFacade.GetPackageCustomerByCustomerId(_qa2.customer.CustomerId);
                //if (_cps != null && _cps.Count() > 0)
                //{
                //    foreach (var item in _cps)
                //    {
                //        _qa2.MonthlyRate += item.Total.HasValue ? Math.Round(item.Total.Value, 2) : 0;
                //    }
                //}
                #region Monthly fee from contract
                string contractMonthlyFee = _Util.Facade.CustomerFacade.GetMonthlyFeeFromContractByCustomerId(_qa2.customer.CustomerId, currentLoggedIn.CompanyId.Value);
                if (!string.IsNullOrWhiteSpace(contractMonthlyFee) && Convert.ToDouble(contractMonthlyFee) > 0)
                {
                    _qa2.customer.MonthlyMonitoringFee = contractMonthlyFee;
                    _qa2.MonthlyRate = Convert.ToDouble(contractMonthlyFee);
                }
                else
                {
                    _qa2.MonthlyRate = 0.0;
                }
                #endregion
                if (_cpe != null && _cpe.Count() > 0)
                {
                    foreach (var item in _cpe)
                    {
                        _qa2.EquipmentFee += item.Total.HasValue ? Math.Round(item.Total.Value, 2) : 0;
                    }
                }
                _qa2.ActivationFee = _pc != null && _pc.ActivationFee.HasValue ? Math.Round(_pc.ActivationFee.Value, 2) : 0;
                if (GetSalesTax != null)
                {
                    _qa2.MonthlyRate = Math.Round(_qa2.MonthlyRate + ((_qa2.MonthlyRate * Convert.ToDouble(GetSalesTax.Value)) / 100), 2);
                    _qa2.EquipmentFee = Math.Round(_qa2.EquipmentFee + ((_qa2.EquipmentFee * Convert.ToDouble(GetSalesTax.Value)) / 100), 2);
                    _qa2.ActivationFee = Math.Round(_qa2.ActivationFee + ((_qa2.ActivationFee * Convert.ToDouble(GetSalesTax.Value)) / 100), 2);
                }
                #endregion
            }
            if (qa2Id.HasValue)
            {
                _qa2.qa2Script = _Util.Facade.CustomerFacade.GetQA2ByCustomerIdAndId(qa2Id.Value, id);
            }
            if (_qa2.qa2Script == null)
            {
                _qa2.qa2Script = new QA2Script();
            }
            #region Note List added
            if (_qa2.qa2Script != null && !string.IsNullOrWhiteSpace(_qa2.qa2Script.AddressUpdateNote))
            {
                _qa2.NoteList.Add(_qa2.qa2Script.AddressUpdateNote);
            }
            if (_qa2.qa2Script != null && !string.IsNullOrWhiteSpace(_qa2.qa2Script.PrimaryPhoneUpdateNote))
            {
                _qa2.NoteList.Add(_qa2.qa2Script.PrimaryPhoneUpdateNote);
            }
            if (_qa2.qa2Script != null && !string.IsNullOrWhiteSpace(_qa2.qa2Script.PassCodeUpdateNote))
            {
                _qa2.NoteList.Add(_qa2.qa2Script.PassCodeUpdateNote);
            }
            if (_qa2.qa2Script != null && !string.IsNullOrWhiteSpace(_qa2.qa2Script.TermAndFeeUpdateNote))
            {
                _qa2.NoteList.Add(_qa2.qa2Script.TermAndFeeUpdateNote);
            }
            #endregion

            _qa2.UserName = _Util.Facade.EmployeeFacade.GetEmployeeNumByEmployeeId(currentLoggedIn.UserId);
            ViewBag.CustomerId = id;

            #region viewbag contract terms
            List<SelectListItem> ContactTerms = new List<SelectListItem>();
            ContactTerms.AddRange(_Util.Facade.LookupFacade.GetDropdownsByKey("ContractTerm"));

            if (_qa2.customer != null && _qa2.customer.CustomerId != null && !string.IsNullOrEmpty(_qa2.customer.ContractTeam) && _qa2.customer.ContractTeam != "3" && _qa2.customer.ContractTeam != "5")
            {
                var packid = _Util.Facade.PackageFacade.GetPackageCustomerByCustomerIdandCompanyId(_qa2.customer.CustomerId, currentLoggedIn.CompanyId.Value);
                if (packid != null)
                {
                    var PackageDetails = _Util.Facade.SmartPackageFacade.GetSmartPackageByPackageId(packid.PackageId);
                    if (PackageDetails != null && PackageDetails.NonConforming == true)
                    {
                        var ContractTeamSet = Convert.ToDouble(_qa2.customer.ContractTeam) * 12;
                        ContactTerms.Add(new SelectListItem() { Value = _qa2.customer.ContractTeam.ToString(), Text = ContractTeamSet.ToString() + " Month" });
                    }
                }
            }
            ViewBag.ContractTerm = ContactTerms;
            #endregion

            #region ViewBag
            List<Employee> empLsit = _Util.Facade.EmployeeFacade.GetCurrentEmployeeListByCompanyId(currentLoggedIn.CompanyId.Value);
            ViewBag.CurrentUserId = currentLoggedIn.UserId.ToString();
            ViewBag.CurrentEmployeeList = empLsit.ToList();
            #endregion

            return View(_qa2);
        }

        [Authorize]
        public ActionResult AddQAFinance(Guid id, int? qaFinanceId)
        {
            var currentLoggedIn = ((HS.Web.UI.Helper.CustomPrincipal)(User));

            if (currentLoggedIn == null)
            {
                return PartialView("~/Views/Shared/_AccessDenied.cshtml");
            }
            CreateQAFinanceModel _qaFinance = new CreateQAFinanceModel();
            _qaFinance.NoteList = new List<string>();
            _qaFinance.MonthlyRate = 0;
            _qaFinance.FinancedAmount = 0;
            //_qa2.EquipmentFee = 0;
            _qaFinance.customer = _Util.Facade.CustomerFacade.GetCustomerByCustomerId(id);
            if (_qaFinance.customer == null)
            {
                _qaFinance.customer = new Customer();
            }
            else
            {
                _qaFinance.customerExtend = _Util.Facade.CustomerFacade.GetCustomerExtendedByCustomerId(_qaFinance.customer.CustomerId);
                if (_qaFinance.customerExtend == null)
                {
                    _qaFinance.customerExtend = new CustomerExtended();
                }
                #region Monthly fee from contract
                string contractMonthlyFee = _Util.Facade.CustomerFacade.GetMonthlyFeeFromContractByCustomerId(_qaFinance.customer.CustomerId, currentLoggedIn.CompanyId.Value);
                if (!string.IsNullOrWhiteSpace(contractMonthlyFee) && Convert.ToDouble(contractMonthlyFee) > 0)
                {
                    _qaFinance.customer.MonthlyMonitoringFee = contractMonthlyFee;
                    _qaFinance.MonthlyRate = Convert.ToDouble(contractMonthlyFee);
                }
                if (_qaFinance.customer.FinancedAmount != null)
                {
                    _qaFinance.FinancedAmount = _qaFinance.customer.FinancedAmount.Value;
                }
                #endregion
            }
            if (qaFinanceId.HasValue)
            {
                _qaFinance.qAFinance = _Util.Facade.CustomerFacade.GetQAFinanceByCustomerIdAndId(qaFinanceId.Value, id);
            }
            if (_qaFinance.qAFinance == null)
            {
                _qaFinance.qAFinance = new QAFinance();
            }
            #region Note List added
            if (_qaFinance.qAFinance != null && !string.IsNullOrWhiteSpace(_qaFinance.qAFinance.UnderstandPaymentReasonNote))
            {
                _qaFinance.NoteList.Add(_qaFinance.qAFinance.UnderstandPaymentReasonNote);
            }
            if (_qaFinance.qAFinance != null && !string.IsNullOrWhiteSpace(_qaFinance.qAFinance.FinancedAmountUpdateNote))
            {
                _qaFinance.NoteList.Add(_qaFinance.qAFinance.FinancedAmountUpdateNote);
            }
            #endregion

            _qaFinance.UserName = _Util.Facade.EmployeeFacade.GetEmployeeNumByEmployeeId(currentLoggedIn.UserId);
            ViewBag.CustomerId = id;
            //#region viewbag contract terms
            //List<SelectListItem> ContactTerms = new List<SelectListItem>();
            //ContactTerms.AddRange(_Util.Facade.LookupFacade.GetDropdownsByKey("ContractTerm"));

            //if (_qa2.customer != null && _qa2.customer.CustomerId != null && !string.IsNullOrEmpty(_qa2.customer.ContractTeam) && _qa2.customer.ContractTeam != "3" && _qa2.customer.ContractTeam != "5")
            //{
            //    var packid = _Util.Facade.PackageFacade.GetPackageCustomerByCustomerIdandCompanyId(_qa2.customer.CustomerId, currentLoggedIn.CompanyId.Value);
            //    if (packid != null)
            //    {
            //        var PackageDetails = _Util.Facade.SmartPackageFacade.GetSmartPackageByPackageId(packid.PackageId);
            //        if (PackageDetails != null && PackageDetails.NonConforming == true)
            //        {
            //            var ContractTeamSet = Convert.ToDouble(_qa2.customer.ContractTeam) * 12;
            //            ContactTerms.Add(new SelectListItem() { Value = _qa2.customer.ContractTeam.ToString(), Text = ContractTeamSet.ToString() + " Month" });
            //        }
            //    }
            //}
            //ViewBag.ContractTerm = ContactTerms;
            //#endregion

            return View(_qaFinance);
        }

        [Authorize]
        [HttpPost]
        public JsonResult AddQA1(QA1Script qa1)
        {
            var currentLoggedIn = ((HS.Web.UI.Helper.CustomPrincipal)(User));
            bool result = false;

            #region QA1 Update
            if (qa1.Id > 0)
            {
                QA1Script _tempQA1 = _Util.Facade.CustomerFacade.GetQA1ById(qa1.Id);
                if (_tempQA1 != null)
                {
                    qa1.CompanyId = _tempQA1.CompanyId;
                    qa1.NameUpdateNote = qa1.NameIsCorrect == "No" ? "Name is changed to " + qa1.FirstName + " " + qa1.LastName : "";
                    qa1.AddressUpdateNote = qa1.AddressIsCorrect == "No" ? "Address is changed to " + MakeAddress(qa1.Street, qa1.City, qa1.State, qa1.ZipCode, "") : "";
                    qa1.PrimaryPhoneUpdateNote = qa1.PrimaryPhoneIsCorrect == "No" ? "Primary contact is changed to " + qa1.PrimaryPhone : "";
                    qa1.DateOfBirthUpdateNote = qa1.DateOfBirthIsCorrect == "No" ? "Date of birth is changed" : "";
                    qa1.SSNUpdateNote = qa1.SSNIsCorrect == "No" ? "SSN is changed" : "";
                    qa1.EmailUpdateNote = qa1.EmailIsCorrect == "No" ? "Email address is changed" : "";
                    qa1.HomeownerNameUpdateNote = qa1.IsHomeRent == "Yes" && !string.IsNullOrWhiteSpace(qa1.HomeownerName) ? "Homeowner name is changed" : "";
                    qa1.ReponsiblePartyNameUpdateNote = qa1.IsResponsibleParty == "Yes" && !string.IsNullOrWhiteSpace(qa1.ResponsiblePartyName) ? "Responsible party name is changed" : "";
                    qa1.CreatedByUid = _tempQA1.CreatedByUid;
                    qa1.CreatedDate = _tempQA1.CreatedDate;
                    //qa1.LastUpdatedByUid = currentLoggedIn.UserId;
                    qa1.LastUpdatedDate = DateTime.UtcNow;

                    result = _Util.Facade.CustomerFacade.UpdateQA1Script(qa1);
                }
            }
            #endregion
            #region QA1 Insert
            else
            {
                qa1.CompanyId = currentLoggedIn.CompanyId.Value;
                qa1.NameUpdateNote = qa1.NameIsCorrect == "No" ? "Name is changed to " + qa1.FirstName + " " + qa1.LastName : "";
                qa1.AddressUpdateNote = qa1.AddressIsCorrect == "No" ? "Address is changed to " + MakeAddress(qa1.Street, qa1.City, qa1.State, qa1.ZipCode, "") : "";
                qa1.PrimaryPhoneUpdateNote = qa1.PrimaryPhoneIsCorrect == "No" ? "Primary contact is changed to " + qa1.PrimaryPhone : "";
                qa1.DateOfBirthUpdateNote = qa1.DateOfBirthIsCorrect == "No" ? "Date of birth is changed" : "";
                qa1.SSNUpdateNote = qa1.SSNIsCorrect == "No" ? "SSN is changed" : "";
                qa1.EmailUpdateNote = qa1.EmailIsCorrect == "No" ? "Email address is changed" : "";
                qa1.HomeownerNameUpdateNote = qa1.IsHomeRent == "Yes" && !string.IsNullOrWhiteSpace(qa1.HomeownerName) ? "Homeowner name is changed" : "";
                qa1.ReponsiblePartyNameUpdateNote = qa1.IsResponsibleParty == "Yes" && !string.IsNullOrWhiteSpace(qa1.ResponsiblePartyName) ? "Responsible party name is changed" : "";
                qa1.CreatedByUid = currentLoggedIn.UserId;
                qa1.CreatedDate = DateTime.UtcNow;
                //qa1.LastUpdatedByUid = currentLoggedIn.UserId;
                qa1.LastUpdatedDate = DateTime.UtcNow;
                result = _Util.Facade.CustomerFacade.InsertQA1Script(qa1) > 0;
            }
            #endregion
            #region Customer Update
            if (qa1.IsCompleted)
            {
                Customer _cus = _Util.Facade.CustomerFacade.GetCustomerByCustomerId(qa1.CustomerId);
                if (_cus != null)
                {
                    _cus.FirstName = qa1.FirstName;
                    _cus.LastName = qa1.LastName;
                    _cus.Street = qa1.Street;
                    _cus.City = qa1.City;
                    _cus.Soldby = qa1.SalesRep.ToString();
                    _cus.SSN = qa1.SSN;
                    _cus.State = qa1.State;
                    _cus.ZipCode = qa1.ZipCode;
                    _cus.Address = MakeAddress(qa1.Street, qa1.City, qa1.State, qa1.ZipCode, "");
                    _cus.PrimaryPhone = qa1.PrimaryPhone;
                    _cus.EmailAddress = qa1.EmailAddress;
                    _cus.DateofBirth = qa1.DateofBirth;
                    _cus.Passcode = qa1.Passcode;
                    _cus.LastUpdatedByUid = currentLoggedIn.UserId;
                    _cus.LastUpdatedDate = DateTime.UtcNow;
                    _Util.Facade.CustomerFacade.UpdateCustomer(_cus);
                }
                string cusNote = "";
                if (!string.IsNullOrWhiteSpace(qa1.NameUpdateNote))
                {
                    cusNote += qa1.NameUpdateNote + ". ";
                }
                if (!string.IsNullOrWhiteSpace(qa1.AddressUpdateNote))
                {
                    cusNote += qa1.AddressUpdateNote + ". ";
                }
                if (!string.IsNullOrWhiteSpace(qa1.PrimaryPhoneUpdateNote))
                {
                    cusNote += qa1.PrimaryPhoneUpdateNote + ". ";
                }
                if (!string.IsNullOrWhiteSpace(qa1.DateOfBirthUpdateNote))
                {
                    cusNote += qa1.DateOfBirthUpdateNote + ". ";
                }
                if (!string.IsNullOrWhiteSpace(qa1.SSNUpdateNote))
                {
                    cusNote += qa1.SSNUpdateNote + ". ";
                }
                if (!string.IsNullOrWhiteSpace(qa1.EmailUpdateNote))
                {
                    cusNote += qa1.EmailUpdateNote + ". ";
                }
                if (!string.IsNullOrWhiteSpace(qa1.HomeownerNameUpdateNote))
                {
                    cusNote += qa1.HomeownerNameUpdateNote + ". ";
                }
                if (!string.IsNullOrWhiteSpace(qa1.ReponsiblePartyNameUpdateNote))
                {
                    cusNote += qa1.ReponsiblePartyNameUpdateNote + ". ";
                }
                if (!string.IsNullOrWhiteSpace(qa1.PermissionGoAheadNote))
                {
                    cusNote += qa1.PermissionGoAheadNote + ". ";
                }
                if (!string.IsNullOrWhiteSpace(qa1.SoundCorrectNote))
                {
                    cusNote += qa1.SoundCorrectNote + ". ";
                }
                if (!string.IsNullOrWhiteSpace(qa1.PassNote))
                {
                    cusNote += qa1.PassNote + ". ";
                }
                if (!string.IsNullOrWhiteSpace(qa1.ManualNote))
                {
                    cusNote += qa1.ManualNote + ".";
                }
                CustomerNote _customerNote = new CustomerNote()
                {
                    Notes = cusNote,
                    CustomerId = qa1.CustomerId,
                    CompanyId = qa1.CompanyId,
                    CreatedDate = DateTime.UtcNow,
                    CreatedBy = currentLoggedIn.FirstName + " " + currentLoggedIn.LastName,
                    CreatedByUid = currentLoggedIn.UserId,
                    NoteType = "General"
                };
                _Util.Facade.NotesFacade.InsertCustomerNote(_customerNote);
            }
            #endregion
            return Json(new { result = result });
        }

        [Authorize]
        [HttpPost]
        public JsonResult AddQA2(QA2Script qa2)
        {
            var currentLoggedIn = ((HS.Web.UI.Helper.CustomPrincipal)(User));
            bool result = false;

            #region QA2 Update
            if (qa2.Id > 0)
            {
                QA2Script _tempQA2 = _Util.Facade.CustomerFacade.GetQA2ById(qa2.Id);
                if (_tempQA2 != null)
                {
                    qa2.CompanyId = _tempQA2.CompanyId;
                    qa2.AddressUpdateNote = qa2.AddressIsCorrect == "No" ? "Address is changed to " + MakeAddress(qa2.Street, qa2.City, qa2.State, qa2.ZipCode, "") : "";
                    qa2.PrimaryPhoneUpdateNote = qa2.PrimaryPhoneIsCorrect == "No" ? "Primary contact is changed to " + qa2.PrimaryPhone : "";
                    qa2.PassCodeUpdateNote = qa2.PasscodeIsCorrect == "No" ? "Passcode is changed to " + qa2.Passcode : "";
                    qa2.TermAndFeeUpdateNote = qa2.TermAndFeeIsCorrect == "No" ? "Contract term and monthly fee changed" : "";
                    qa2.CreatedByUid = _tempQA2.CreatedByUid;
                    qa2.CreatedDate = _tempQA2.CreatedDate;
                    qa2.LastUpdatedByUid = currentLoggedIn.UserId;
                    qa2.LastUpdatedDate = DateTime.UtcNow;

                    result = _Util.Facade.CustomerFacade.UpdateQA2Script(qa2);
                }
            }
            #endregion
            #region QA2 Insert
            else
            {
                qa2.CompanyId = currentLoggedIn.CompanyId.Value;
                qa2.AddressUpdateNote = qa2.AddressIsCorrect == "No" ? "Address is changed to " + MakeAddress(qa2.Street, qa2.City, qa2.State, qa2.ZipCode, "") : "";
                qa2.PrimaryPhoneUpdateNote = qa2.PrimaryPhoneIsCorrect == "No" ? "Primary contact is changed to " + qa2.PrimaryPhone : "";
                qa2.PassCodeUpdateNote = qa2.PasscodeIsCorrect == "No" ? "Passcode is changed to " + qa2.Passcode : "";
                qa2.TermAndFeeUpdateNote = qa2.TermAndFeeIsCorrect == "No" ? "Contract term and monthly fee changed" : "";
                qa2.CreatedByUid = currentLoggedIn.UserId;
                qa2.CreatedDate = DateTime.UtcNow;
                qa2.LastUpdatedByUid = currentLoggedIn.UserId;
                qa2.LastUpdatedDate = DateTime.UtcNow;
                result = _Util.Facade.CustomerFacade.InsertQA2Script(qa2) > 0;
            }
            #endregion
            #region Customer Update
            if (qa2.IsCompleted)
            {
                Customer _cus = _Util.Facade.CustomerFacade.GetCustomerByCustomerId(qa2.CustomerId);
                if (_cus != null)
                {
                    _cus.Street = qa2.Street;
                    _cus.City = qa2.City;
                    _cus.State = qa2.State;
                    _cus.ZipCode = qa2.ZipCode;
                    _cus.Address = MakeAddress(qa2.Street, qa2.City, qa2.State, qa2.ZipCode, "");
                    _cus.PrimaryPhone = qa2.PrimaryPhone;
                    _cus.Passcode = qa2.Passcode;
                    _cus.ContractTeam = qa2.ContractTerm;
                    _cus.MonthlyMonitoringFee = qa2.MonitoringFee;
                    _cus.LastUpdatedByUid = currentLoggedIn.UserId;
                    _cus.LastUpdatedDate = DateTime.UtcNow;
                    _Util.Facade.CustomerFacade.UpdateCustomer(_cus);
                }
                string cusNote = "";
                if (!string.IsNullOrWhiteSpace(qa2.AddressUpdateNote))
                {
                    cusNote += qa2.AddressUpdateNote + ". ";
                }
                if (!string.IsNullOrWhiteSpace(qa2.PrimaryPhoneUpdateNote))
                {
                    cusNote += qa2.PrimaryPhoneUpdateNote + ". ";
                }
                if (!string.IsNullOrWhiteSpace(qa2.PassCodeUpdateNote))
                {
                    cusNote += qa2.PassCodeUpdateNote + ". ";
                }
                if (!string.IsNullOrWhiteSpace(qa2.TermAndFeeUpdateNote))
                {
                    cusNote += qa2.TermAndFeeUpdateNote + ". ";
                }
                if (!string.IsNullOrWhiteSpace(qa2.ManualNote))
                {
                    cusNote += qa2.ManualNote + ".";
                }
                CustomerNote _customerNote = new CustomerNote()
                {
                    Notes = cusNote,
                    CustomerId = qa2.CustomerId,
                    CompanyId = qa2.CompanyId,
                    CreatedDate = DateTime.UtcNow,
                    CreatedBy = currentLoggedIn.FirstName + " " + currentLoggedIn.LastName,
                    CreatedByUid = currentLoggedIn.UserId,
                    NoteType = "General"
                };
                _Util.Facade.NotesFacade.InsertCustomerNote(_customerNote);
            }
            #endregion

            return Json(new { result = result });
        }

        [Authorize]
        [HttpPost]
        public JsonResult AddQAFinance(QAFinance qaFinance)
        {
            var currentLoggedIn = ((HS.Web.UI.Helper.CustomPrincipal)(User));
            bool result = false;

            #region QA Finance Update
            if (qaFinance.Id > 0)
            {
                QAFinance _tempQAFinance = _Util.Facade.CustomerFacade.GetQAFinanceById(qaFinance.Id);
                if (_tempQAFinance != null)
                {
                    qaFinance.CompanyId = _tempQAFinance.CompanyId;
                    qaFinance.UnderstandPaymentReasonNote = qaFinance.IsUnderstandTwoPayment == "No" ? qaFinance.UnderstandPaymentReasonNote : "";
                    qaFinance.FinancedAmountUpdateNote = qaFinance.FinancedAmountIsCorrect == "No" ? "Financed amount is changed to $" + qaFinance.FinancedAmount.ToString() : "";
                    qaFinance.CreatedByUid = _tempQAFinance.CreatedByUid;
                    qaFinance.CreatedDate = _tempQAFinance.CreatedDate;
                    qaFinance.LastUpdatedByUid = currentLoggedIn.UserId;
                    qaFinance.LastUpdatedDate = DateTime.UtcNow;

                    result = _Util.Facade.CustomerFacade.UpdateQAFinance(qaFinance);
                }
            }
            #endregion
            #region QA Finance Insert
            else
            {
                qaFinance.CompanyId = currentLoggedIn.CompanyId.Value;
                qaFinance.UnderstandPaymentReasonNote = qaFinance.IsUnderstandTwoPayment == "No" ? qaFinance.UnderstandPaymentReasonNote : "";
                qaFinance.FinancedAmountUpdateNote = qaFinance.FinancedAmountIsCorrect == "No" ? "Financed amount is changed to $" + qaFinance.FinancedAmount.ToString() : "";
                qaFinance.CreatedByUid = currentLoggedIn.UserId;
                qaFinance.CreatedDate = DateTime.UtcNow;
                qaFinance.LastUpdatedByUid = currentLoggedIn.UserId;
                qaFinance.LastUpdatedDate = DateTime.UtcNow;
                result = _Util.Facade.CustomerFacade.InsertQAFinance(qaFinance) > 0;
            }
            #endregion
            #region Customer Update
            if (qaFinance.IsCompleted)
            {
                Customer _cus = _Util.Facade.CustomerFacade.GetCustomerByCustomerId(qaFinance.CustomerId);
                if (_cus != null)
                {
                    _cus.FinancedAmount = qaFinance.FinancedAmount;
                    _cus.LastUpdatedByUid = currentLoggedIn.UserId;
                    _cus.LastUpdatedDate = DateTime.UtcNow;
                    _Util.Facade.CustomerFacade.UpdateCustomer(_cus);
                }
                string cusNote = "";
                if (!string.IsNullOrWhiteSpace(qaFinance.UnderstandPaymentReasonNote))
                {
                    cusNote += qaFinance.UnderstandPaymentReasonNote + ". ";
                }
                if (!string.IsNullOrWhiteSpace(qaFinance.FinancedAmountUpdateNote))
                {
                    cusNote += qaFinance.FinancedAmountUpdateNote + ". ";
                }

                if (!string.IsNullOrWhiteSpace(qaFinance.ManualNote))
                {
                    cusNote += qaFinance.ManualNote + ".";
                }
                CustomerNote _customerNote = new CustomerNote()
                {
                    Notes = cusNote,
                    CustomerId = qaFinance.CustomerId,
                    CompanyId = qaFinance.CompanyId,
                    CreatedDate = DateTime.UtcNow,
                    CreatedBy = currentLoggedIn.FirstName + " " + currentLoggedIn.LastName,
                    CreatedByUid = currentLoggedIn.UserId,
                    NoteType = "General"
                };
                _Util.Facade.NotesFacade.InsertCustomerNote(_customerNote);
            }
            #endregion
            return Json(new { result = result });
        }
        #endregion
        public void Logmessage(Customer customer, Customer Cusmodel)
        {
            #region customer update log
            string leadsourcevalforlog = "";
            string customerstatusvalforlog = "";
            string refcusvalforlognew = "";
            string refcusvalforlogprev = "";
            string childcusvalforlognew = "";
            string childcusvalforlogprev = "";
            string soldbyvalforlognew = "";
            string soldbyvalforlogprev = "";
            string apptsetbyforlognew = "";
            string apptsetbyforlogprev = "";
            string financerepforlognew = "";
            string financerepforlogprev = "";
            string prevcontacttermvalforlog = "";
            string newcontacttermvalforlog = "";
            string prevbranchnameforlog = "";
            string newbranchnameforlog = "";
            string prevsaleslocationforlog = "";
            string newsaleslocationforlog = "";
            string prevcreditgradeforlog = "";
            string newcreditgradeforlog = "";
            CustomerExtended CusExmodel = _Util.Facade.CustomerFacade.GetCustomerExtendedByCustomerId(customer.CustomerId);

            if (Cusmodel != null)
            {
                if (Cusmodel.DBA == "")
                {
                    Cusmodel.DBA = null;
                }

                if (customer.DBA == "")
                {
                    customer.DBA = null;
                }

                if (customer.Passcode == "")
                {
                    customer.Passcode = null;
                }
                if (Cusmodel.Passcode == "")
                {
                    Cusmodel.Passcode = null;
                }
                if (Cusmodel.CSProvider == "")
                {
                    Cusmodel.CSProvider = null;
                }
                if (customer.CSProvider == "")
                {
                    Cusmodel.CSProvider = null;
                }
                if (Cusmodel.TaxExemption == "")
                {
                    Cusmodel.TaxExemption = null;
                }
                if (customer.TaxExemption == "")
                {
                    customer.TaxExemption = null;
                }
                if (Cusmodel.SalesLocation == "")
                {
                    Cusmodel.SalesLocation = null;
                }
                if (customer.SalesLocation == "")
                {
                    customer.SalesLocation = null;
                }
                if (Cusmodel.LeadSourceType == "")
                {
                    Cusmodel.LeadSourceType = null;
                }
                if (customer.LeadSourceType == "")
                {
                    customer.LeadSourceType = null;
                }
                if (customer.CustomerExtended != null && customer.CustomerExtended.FinanceCompany == "")
                {
                    customer.CustomerExtended.FinanceCompany = null;
                }

                if (customer.CustomerExtended != null && customer.CustomerExtended.Batch == "")
                {
                    customer.CustomerExtended.Batch = null;
                }

                if (Cusmodel.ZipCode == "")
                {
                    Cusmodel.ZipCode = null;
                }
                if (Cusmodel.City == "")
                {
                    Cusmodel.City = null;
                }
                if (Cusmodel.State == "")
                {
                    Cusmodel.State = null;
                }
                if (Cusmodel.Street == "")
                {
                    Cusmodel.Street = null;
                }
                if (Cusmodel.County == "")
                {
                    Cusmodel.County = null;
                }
                if (Cusmodel.Appartment == "")
                {
                    Cusmodel.Appartment = null;
                }
                if (Cusmodel.StreetPrevious == "")
                {
                    Cusmodel.StreetPrevious = null;
                }
                if (Cusmodel.CityPrevious == "")
                {
                    Cusmodel.CityPrevious = null;
                }
                if (Cusmodel.StatePrevious == "")
                {
                    Cusmodel.StatePrevious = null;
                }
                if (Cusmodel.ZipCodePrevious == "")
                {
                    Cusmodel.ZipCodePrevious = null;
                }
                if (customer.ZipCode == "")
                {
                    customer.ZipCode = null;
                }
                if (customer.City == "")
                {
                    customer.City = null;
                }
                if (customer.State == "")
                {
                    customer.State = null;
                }
                if (customer.Street == "")
                {
                    customer.Street = null;
                }
                if (customer.County == "")
                {
                    customer.County = null;
                }
                if (customer.Appartment == "")
                {
                    customer.Appartment = null;
                }
                if (customer.StreetPrevious == "")
                {
                    customer.StreetPrevious = null;
                }
                if (customer.CityPrevious == "")
                {
                    customer.CityPrevious = null;
                }
                if (customer.StatePrevious == "")
                {
                    customer.StatePrevious = null;
                }
                if (customer.ZipCodePrevious == "")
                {
                    customer.ZipCodePrevious = null;
                }
                if (Cusmodel.BillNotes == "")
                {
                    Cusmodel.BillNotes = null;
                }
                if (customer.BillNotes == "")
                {
                    customer.BillNotes = null;
                }
                if (Cusmodel.EmailAddress == "")
                {
                    Cusmodel.EmailAddress = null;
                }
                if (customer.EmailAddress == "")
                {
                    customer.EmailAddress = null;
                }
                if (Cusmodel.BusinessName == "")
                {
                    Cusmodel.BusinessName = null;
                }
                if (customer.BusinessName == "")
                {
                    customer.BusinessName = null;
                }
                if (Cusmodel.CellNo == "")
                {
                    Cusmodel.CellNo = null;
                }
                if (customer.CellNo == "")
                {
                    customer.CellNo = null;
                }
                if (Cusmodel.PrimaryPhone == "")
                {
                    Cusmodel.PrimaryPhone = null;
                }
                if (customer.PrimaryPhone == "")
                {
                    customer.PrimaryPhone = null;
                }
                if (Cusmodel.AdditionalCustomerNo == "")
                {
                    Cusmodel.AdditionalCustomerNo = null;
                }
                if (customer.AdditionalCustomerNo == "")
                {
                    customer.AdditionalCustomerNo = null;
                }

                if (customer.CustomerExtended != null && customer.CustomerExtended.LoanNumber == "")
                {
                    customer.CustomerExtended.LoanNumber = null;
                }
                if (Cusmodel.Note == "")
                {
                    Cusmodel.Note = null;
                }
                if (customer.Note == "")
                {
                    customer.Note = null;
                }
                if (customer.SecondCustomerNo == "")
                {
                    customer.SecondCustomerNo = null;
                }
                if (Cusmodel.SecondCustomerNo == "")
                {
                    Cusmodel.SecondCustomerNo = null;
                }
                if (customer.FirstBilling == new DateTime())
                {
                    customer.FirstBilling = null;
                }
                if (Cusmodel.FirstBilling == new DateTime())
                {
                    Cusmodel.FirstBilling = null;
                }

                if (customer.CustomerExtended != null && customer.CustomerExtended.APR == "")
                {
                    customer.CustomerExtended.APR = null;
                }
                if (Cusmodel.SSN == "")
                {
                    Cusmodel.SSN = null;
                }
                if (customer.SSN == "")
                {
                    customer.SSN = null;
                }
                if (customer.PaymentMethod == "-1")
                {
                    customer.PaymentMethod = "";
                }
                if (Cusmodel.PaymentMethod == "-1")
                {
                    Cusmodel.PaymentMethod = "";
                }
                if (!string.IsNullOrEmpty(customer.LeadSource) && customer.LeadSource != "-1")
                {
                    leadsourcevalforlog = _Util.Facade.LookupFacade.GetDisplayTextByDataValueFromLLookup(customer.LeadSource);
                }
                if (!string.IsNullOrEmpty(customer.CustomerStatus) && customer.CustomerStatus != "-1")
                {
                    customerstatusvalforlog = _Util.Facade.LookupFacade.GetDisplayTextByDataKeyandDataValueFromLLookup("CustomerStatus1", customer.CustomerStatus);
                }
                if (!string.IsNullOrEmpty(customer.ContractTeam) && customer.ContractTeam != "-1")
                {
                    newcontacttermvalforlog = _Util.Facade.LookupFacade.GetDisplayTextByDataKeyandDataValueFromLLookup("ContractTerm", customer.ContractTeam);
                }
                if (!string.IsNullOrEmpty(Cusmodel.ContractTeam) && Cusmodel.ContractTeam != "-1")
                {
                    prevcontacttermvalforlog = _Util.Facade.LookupFacade.GetDisplayTextByDataKeyandDataValueFromLLookup("ContractTerm", Cusmodel.ContractTeam);
                }
                if (!string.IsNullOrEmpty(customer.SalesLocation) && customer.SalesLocation != "-1")
                {
                    newsaleslocationforlog = _Util.Facade.LookupFacade.GetDisplayTextByDataKeyandDataValueFromLLookup("SalesLocation", customer.SalesLocation);
                }
                if (!string.IsNullOrEmpty(Cusmodel.SalesLocation) && Cusmodel.SalesLocation != "-1")
                {
                    prevsaleslocationforlog = _Util.Facade.LookupFacade.GetDisplayTextByDataKeyandDataValueFromLLookup("SalesLocation", Cusmodel.SalesLocation);
                }
                if (customer.ReferringCustomer != new Guid())
                {
                    Customer refcus = _Util.Facade.CustomerFacade.GetCustomerByCustomerId(customer.ReferringCustomer);
                    refcusvalforlognew = refcus.FirstName + " " + refcus.LastName;
                }
                if (Cusmodel.ReferringCustomer != new Guid())
                {
                    Customer refcus = _Util.Facade.CustomerFacade.GetCustomerByCustomerId(Cusmodel.ReferringCustomer);
                    refcusvalforlogprev = refcus.FirstName + " " + refcus.LastName;
                }
                if (customer.ChildOf != new Guid())
                {
                    Customer chcus = _Util.Facade.CustomerFacade.GetCustomerByCustomerId(customer.ChildOf);
                    childcusvalforlognew = chcus.FirstName + " " + chcus.LastName;
                }
                if (Cusmodel.ChildOf != new Guid())
                {
                    Customer chcus = _Util.Facade.CustomerFacade.GetCustomerByCustomerId(Cusmodel.ChildOf);
                    childcusvalforlogprev = chcus.FirstName + " " + chcus.LastName;
                }
                if (!string.IsNullOrEmpty(customer.Soldby))
                {
                    Employee soldbyval = _Util.Facade.EmployeeFacade.GetEmployeeByUserId(new Guid(customer.Soldby));
                    soldbyvalforlognew = soldbyval.FirstName + " " + soldbyval.LastName;
                }
                if (!string.IsNullOrEmpty(Cusmodel.Soldby))
                {
                    Employee soldbyval = _Util.Facade.EmployeeFacade.GetEmployeeByUserId(new Guid(Cusmodel.Soldby));
                    soldbyvalforlogprev = soldbyval.FirstName + " " + soldbyval.LastName;
                }
                if (customer.CustomerExtended != null && customer.CustomerExtended.AppoinmentSetBy != new Guid())
                {
                    Employee apptsetby = _Util.Facade.EmployeeFacade.GetEmployeeByUserId(customer.CustomerExtended.AppoinmentSetBy);
                    apptsetbyforlognew = apptsetby.FirstName + " " + apptsetby.LastName;
                }

                if (customer.CustomerExtended != null && customer.CustomerExtended.FinanceRep != new Guid())
                {
                    Employee financerep = _Util.Facade.EmployeeFacade.GetEmployeeByUserId(customer.CustomerExtended.FinanceRep);
                    financerepforlognew = financerep.FirstName + " " + financerep.LastName;
                }

                if (Cusmodel.BranchId != null && Cusmodel.BranchId != -1)
                {
                    CompanyBranch companyBranch = _Util.Facade.CompanyBranchFacade.GetCompanyBranchById((int)Cusmodel.BranchId);
                    prevbranchnameforlog = companyBranch.Name;
                }
                if (customer.BranchId != null && customer.BranchId != -1)
                {
                    CompanyBranch companyBranch = _Util.Facade.CompanyBranchFacade.GetCompanyBranchById((int)customer.BranchId);
                    newbranchnameforlog = companyBranch.Name;
                }
                if (!string.IsNullOrEmpty(Cusmodel.CreditScore) && Cusmodel.CreditScore != "-1")
                {
                    CreditScoreGrade creditScoreGrade = _Util.Facade.CustomerFacade.GetCreditScoreGradeById(Int32.Parse(Cusmodel.CreditScore));
                    prevcreditgradeforlog = creditScoreGrade.Grade;
                }
                if (!string.IsNullOrEmpty(customer.CreditScore) && customer.CreditScore != "-1")
                {
                    CreditScoreGrade creditScoreGrade = _Util.Facade.CustomerFacade.GetCreditScoreGradeById(Int32.Parse(customer.CreditScore));
                    newcreditgradeforlog = creditScoreGrade.Grade;
                }

                if (CusExmodel != null)
                {
                    if (CusExmodel.FinanceCompany == "")
                    {
                        CusExmodel.FinanceCompany = null;
                    }
                    if (CusExmodel.Batch == "")
                    {
                        CusExmodel.Batch = null;
                    }
                    if (CusExmodel.LoanNumber == "")
                    {
                        CusExmodel.LoanNumber = null;
                    }
                    if (CusExmodel.APR == "")
                    {
                        CusExmodel.APR = null;
                    }
                    if (CusExmodel.FinanceRep != new Guid())
                    {
                        Employee financerep = _Util.Facade.EmployeeFacade.GetEmployeeByUserId(CusExmodel.FinanceRep);
                        financerepforlogprev = financerep.FirstName + " " + financerep.LastName;
                    }
                    if (CusExmodel.AppoinmentSetBy != new Guid())
                    {
                        Employee apptsetby = _Util.Facade.EmployeeFacade.GetEmployeeByUserId(CusExmodel.AppoinmentSetBy);
                        apptsetbyforlogprev = apptsetby.FirstName + " " + apptsetby.LastName;
                    }
                }
            }
            string message = "";

            if (customer.EmailAddress != Cusmodel.EmailAddress)
            {
                message += " Email Updated from " + Cusmodel.EmailAddress + " to " + customer.EmailAddress + "<br>";
            }
            if (customer.CustomerStatus != Cusmodel.CustomerStatus)
            {
                message += " Status Updated from " + Cusmodel.CustomerStatusVal + " to " + customerstatusvalforlog + "<br>";
            }
            if (customer.FirstName != Cusmodel.FirstName)
            {
                message += " FirstName Updated from " + Cusmodel.FirstName + " to " + customer.FirstName + "<br>";
            }
            if (customer.LastName != Cusmodel.LastName)
            {
                message += " LastName Updated from " + Cusmodel.LastName + " to " + customer.LastName + "<br>";
            }
            if (customer.BusinessName != Cusmodel.BusinessName)
            {
                message += " BusinessName Updated from " + Cusmodel.BusinessName + " to " + customer.BusinessName + "<br>";
            }
            if (customer.DBA != Cusmodel.DBA)
            {
                message += " DBA Updated from " + Cusmodel.DBA + " to " + customer.DBA + "<br>";
            }
            if (customer.Passcode != Cusmodel.Passcode)
            {
                message += " Verbal Password Updated from " + Cusmodel.Passcode + " to " + customer.Passcode + "<br>";
            }
            if (customer.LeadSource != Cusmodel.LeadSource)
            {
                message += " Lead Source Updated from " + Cusmodel.LeadSourceVal + " to " + leadsourcevalforlog + "<br>";
            }
            if (customer.ChildOf != Cusmodel.ChildOf)
            {
                message += " Child of Updated from " + childcusvalforlogprev + " to " + childcusvalforlognew + "<br>";
            }
            if (customer.ReferringCustomer != Cusmodel.ReferringCustomer)
            {
                message += " Reffering Customer Updated from " + refcusvalforlogprev + " to " + refcusvalforlognew + "<br>";
            }
            if (customer.Type != Cusmodel.Type)
            {
                if (customer.Type == "-1")
                {
                    customer.Type = "";
                }
                if (Cusmodel.Type == "-1")
                {
                    Cusmodel.Type = "";
                }
                message += " Type Updated from " + Cusmodel.Type + " to " + customer.Type + "<br>";
            }
            if (CusExmodel != null && customer.CustomerExtended != null && customer.CustomerExtended.GrossFundedAmount != CusExmodel.GrossFundedAmount)
            {
                message += " Gross Funded Amount Updated from " + CusExmodel.GrossFundedAmount + "$ to " + customer.CustomerExtended.GrossFundedAmount + "$" + "<br>";
            }
            if (customer.CellNo != Cusmodel.CellNo)
            {
                message += " Contact Phone Updated from " + Cusmodel.CellNo + " to " + customer.CellNo + "<br>";
            }
            if (customer.PrimaryPhone != Cusmodel.PrimaryPhone)
            {
                message += " Land line Updated from " + Cusmodel.PrimaryPhone + " to " + customer.PrimaryPhone + "<br>";
            }
            if (customer.PreferredContactMethod != Cusmodel.PreferredContactMethod)
            {
                if (customer.PreferredContactMethod == "-1")
                {
                    customer.PreferredContactMethod = "";
                }
                if (Cusmodel.PreferredContactMethod == "-1")
                {
                    Cusmodel.PreferredContactMethod = "";
                }
                message += " Preferred Contact Method Updated from " + Cusmodel.PreferredContactMethod + " to " + customer.PreferredContactMethod + "<br>";
            }
            if (customer.SSN != Cusmodel.SSN)
            {
                message += " SSN Updated from " + Cusmodel.SSN + " to " + customer.SSN + "<br>";
            }
            if (customer.DateofBirth != Cusmodel.DateofBirth)
            {
                string prevdateofbirth = "";
                string nextdateofbirth = "";
                if (Cusmodel.DateofBirth != null && Cusmodel.DateofBirth != new DateTime())
                {
                    prevdateofbirth = Cusmodel.DateofBirth.Value.ToString("MM/dd/yyyy");
                }
                if (customer.DateofBirth != null && customer.DateofBirth != new DateTime())
                {
                    nextdateofbirth = customer.DateofBirth.Value.ToString("MM/dd/yyyy");
                }
                message += " Date of Birth Updated from " + prevdateofbirth + " to " + nextdateofbirth + "<br>";
            }
            if (customer.SecondCustomerNo != Cusmodel.SecondCustomerNo)
            {
                message += " Second Customer No Updated from " + Cusmodel.SecondCustomerNo + " to " + customer.SecondCustomerNo + "<br>";
            }
            if (customer.AdditionalCustomerNo != Cusmodel.AdditionalCustomerNo)
            {
                message += " Additional Ac No Updated from " + Cusmodel.AdditionalCustomerNo + " to " + customer.AdditionalCustomerNo + "<br>";
            }
            if (customer.CSProvider != Cusmodel.CSProvider)
            {
                if (customer.CSProvider == "-1")
                {
                    customer.CSProvider = "";
                }
                if (Cusmodel.CSProvider == "-1")
                {
                    Cusmodel.CSProvider = "";
                }
                message += " CS Provider Updated from " + Cusmodel.CSProvider + " to " + customer.CSProvider + "<br>";
            }
            if (customer.BranchId != Cusmodel.BranchId)
            {
                message += " Branch Updated from " + prevbranchnameforlog + " to " + newbranchnameforlog + "<br>";
            }
            if (customer.Ownership != Cusmodel.Ownership)
            {
                if (customer.Ownership == "-1")
                {
                    customer.Ownership = "";
                }
                if (Cusmodel.Ownership == "-1")
                {
                    Cusmodel.Ownership = "";
                }
                message += " Ownership Updated from " + Cusmodel.Ownership + " to " + customer.Ownership + "<br>";
            }
            if (customer.TaxExemption != Cusmodel.TaxExemption)
            {
                message += " Tax Exemption Updated from " + Cusmodel.TaxExemptionVal + " to " + customer.TaxExemption + "<br>";
            }
            if (customer.Soldby != Cusmodel.Soldby)
            {
                message += " Sales Person Updated from " + soldbyvalforlogprev + " to " + soldbyvalforlognew + "<br>";
            }
            if (customer.SalesLocation != Cusmodel.SalesLocation)
            {

                if (customer.SalesLocation == "-1")
                {
                    customer.SalesLocation = "";
                }
                if (Cusmodel.SalesLocation == "-1")
                {
                    Cusmodel.SalesLocation = "";
                }
                message += " Sales Location Updated from " + prevsaleslocationforlog + " to " + newsaleslocationforlog + "<br>";
            }
            if (customer.Status != Cusmodel.Status)
            {

                if (customer.Status == "-1")
                {
                    customer.Status = "";
                }
                if (Cusmodel.Status == "-1")
                {
                    Cusmodel.Status = "";
                }
                message += " Lead Status Updated from " + Cusmodel.Status + " to " + customer.Status + "<br>";
            }
            if (CusExmodel != null && customer.CustomerExtended != null && customer.CustomerExtended.AppoinmentSetBy != CusExmodel.AppoinmentSetBy)
            {
                message += " Appoinment Set By Updated from " + apptsetbyforlogprev + " to " + apptsetbyforlognew + "<br>";
            }

            if (customer.FinancedAmount != Cusmodel.FinancedAmount)
            {
                message += " Financed Amount Updated from " + Cusmodel.FinancedAmount + "$ to " + customer.FinancedAmount + "$" + "<br>";
            }
            if (customer.LeadSourceType != Cusmodel.LeadSourceType)
            {
                if (customer.LeadSourceType == "-1")
                {
                    customer.LeadSourceType = "";
                }
                if (Cusmodel.LeadSourceType == "-1")
                {
                    Cusmodel.LeadSourceType = "";
                }
                message += " Lead Source Type Updated from " + Cusmodel.LeadSourceType + " to " + customer.LeadSourceType + "<br>";
            }
            if (CusExmodel != null && customer.CustomerExtended != null && customer.CustomerExtended.FinanceCompany != CusExmodel.FinanceCompany)
            {
                if (customer.CustomerExtended.FinanceCompany == "-1")
                {
                    customer.CustomerExtended.FinanceCompany = "";
                }
                if (CusExmodel.FinanceCompany == "-1")
                {
                    CusExmodel.FinanceCompany = "";
                }
                message += " Finance Company Updated from " + CusExmodel.FinanceCompany + " to " + customer.CustomerExtended.FinanceCompany + "<br>";
            }
            if (CusExmodel != null && customer.CustomerExtended != null && customer.CustomerExtended.IsFinanced != CusExmodel.IsFinanced)
            {
                message += " Is Financed Updated from " + CusExmodel.IsFinanced + " to " + customer.CustomerExtended.IsFinanced + "<br>";
            }
            if (CusExmodel != null && customer.CustomerExtended != null && customer.CustomerExtended.CustomerPaymentAmount != CusExmodel.CustomerPaymentAmount)
            {
                message += " Customer Payment Amount Updated from " + CusExmodel.CustomerPaymentAmount + "$ to " + customer.CustomerExtended.CustomerPaymentAmount + "$" + "<br>";
            }
            if (CusExmodel != null && customer.CustomerExtended != null && customer.CustomerExtended.FinanceRepCommissionRate != CusExmodel.FinanceRepCommissionRate)
            {
                message += " Finance Commission Rate Updated from " + CusExmodel.FinanceRepCommissionRate + " to " + customer.CustomerExtended.FinanceRepCommissionRate + "<br>";
            }
            if (CusExmodel != null && customer.CustomerExtended != null && customer.CustomerExtended.LoanNumber != CusExmodel.LoanNumber)
            {
                message += " Loan Number Updated from " + CusExmodel.LoanNumber + " to " + customer.CustomerExtended.LoanNumber + "<br>";
            }
            if (CusExmodel != null && customer.CustomerExtended != null && customer.CustomerExtended.Term != CusExmodel.Term)
            {
                if (customer.CustomerExtended.Term == "-1")
                {
                    customer.CustomerExtended.Term = "";
                }
                if (CusExmodel.Term == "-1")
                {
                    CusExmodel.Term = "";
                }
                message += " Term Updated from " + CusExmodel.Term + " to " + customer.CustomerExtended.Term + "<br>";
            }
            if (CusExmodel != null && customer.CustomerExtended != null && customer.CustomerExtended.APR != CusExmodel.APR)
            {
                message += " APR Updated from " + CusExmodel.APR + " to " + customer.CustomerExtended.APR + "<br>";
            }
            if (CusExmodel != null && customer.CustomerExtended != null && customer.CustomerExtended.MaxCreditLimit != CusExmodel.MaxCreditLimit)
            {
                message += " Max Credit Limit Updated from " + CusExmodel.MaxCreditLimit + " to " + customer.CustomerExtended.MaxCreditLimit + "<br>";
            }
            if (CusExmodel != null && customer.CustomerExtended != null && customer.CustomerExtended.ApprovalDate != CusExmodel.ApprovalDate)
            {
                string prevApprovalDate = "";
                string nextApprovalDate = "";
                if (CusExmodel.ApprovalDate != null && CusExmodel.ApprovalDate != new DateTime())
                {
                    prevApprovalDate = CusExmodel.ApprovalDate.Value.ToString("MM/dd/yyyy");
                }
                if (customer.CustomerExtended.ApprovalDate != null && customer.CustomerExtended.ApprovalDate != new DateTime())
                {
                    nextApprovalDate = customer.CustomerExtended.ApprovalDate.Value.ToString("MM/dd/yyyy");
                }
                message += " Approval Date Updated from " + prevApprovalDate + " to " + nextApprovalDate + "<br>";
            }
            if (CusExmodel != null && customer.CustomerExtended != null && customer.CustomerExtended.FinanceRep != CusExmodel.FinanceRep)
            {
                message += " Finance Rep Updated from " + financerepforlogprev + " to " + financerepforlognew + "<br>";
            }
            if (CusExmodel != null && customer.CustomerExtended != null && customer.CustomerExtended.DiscountFundedAmount != CusExmodel.DiscountFundedAmount)
            {
                message += " Discount Funded Amount Updated from " + CusExmodel.DiscountFundedAmount + "$ to " + customer.CustomerExtended.DiscountFundedAmount + "$" + "<br>";
            }
            if (CusExmodel != null && customer.CustomerExtended != null && customer.CustomerExtended.DiscountFundedPercentage != CusExmodel.DiscountFundedPercentage)
            {
                message += " Discount Funded Percentage Updated from " + CusExmodel.DiscountFundedPercentage + " to " + customer.CustomerExtended.DiscountFundedPercentage + "<br>";
            }
            //if (CusExmodel != null && customer.CustomerExtended != null && customer.CustomerExtended.GrossFundedAmount != CusExmodel.GrossFundedAmount)
            //{
            //    message += " Gross Funded Amount Updated from " + CusExmodel.GrossFundedAmount + " to " + customer.CustomerExtended.GrossFundedAmount + "<br>";
            //}
            if (CusExmodel != null && customer.CustomerExtended != null && customer.CustomerExtended.NetFundedAmount != CusExmodel.NetFundedAmount)
            {
                message += " Net Funded Amount Updated from " + CusExmodel.NetFundedAmount + "$ to " + customer.CustomerExtended.NetFundedAmount + "$" + "<br>";
            }
            if (CusExmodel != null && customer.CustomerExtended != null && customer.CustomerExtended.Batch != CusExmodel.Batch)
            {
                message += " Batch Updated from " + CusExmodel.Batch + " to " + customer.CustomerExtended.Batch + "<br>";
            }
            if (customer.Note != Cusmodel.Note)
            {
                message += " Note Updated from " + Cusmodel.Note + " to " + customer.Note + "<br>";
            }
            if (customer.ZipCode != Cusmodel.ZipCode)
            {
                message += " ZipCode Updated from " + Cusmodel.ZipCode + " to " + customer.ZipCode + "<br>";
            }
            if (customer.City != Cusmodel.City)
            {
                message += " City Updated from " + Cusmodel.City + " to " + customer.City + "<br>";
            }
            if (customer.State != Cusmodel.State)
            {
                message += " State Updated from " + Cusmodel.State + " to " + customer.State + "<br>";
            }
            if (customer.Street != Cusmodel.Street)
            {
                message += " Street Updated from " + Cusmodel.Street + " to " + customer.Street + "<br>";
            }
            if (customer.County != Cusmodel.County)
            {
                message += " County Updated from " + Cusmodel.County + " to " + customer.County + "<br>";
            }
            if (customer.Appartment != Cusmodel.Appartment)
            {
                message += " Apt/Suit Updated from " + Cusmodel.Appartment + " to " + customer.Appartment + "<br>";
            }
            if (customer.CityPrevious != Cusmodel.CityPrevious)
            {
                message += " City(Billing Address) Updated from " + Cusmodel.CityPrevious + " to " + customer.CityPrevious + "<br>";
            }
            if (customer.StatePrevious != Cusmodel.StatePrevious)
            {
                message += " State(Billing Address) Updated from " + Cusmodel.StatePrevious + " to " + customer.StatePrevious + "<br>";
            }
            if (customer.StreetPrevious != Cusmodel.StreetPrevious)
            {
                message += " Street(Billing Address) Updated from " + Cusmodel.StreetPrevious + " to " + customer.StreetPrevious + "<br>";
            }
            if (customer.SalesDate != Cusmodel.SalesDate)
            {
                string prevSalesDate = "";
                string nextSalesDate = "";
                if (Cusmodel.SalesDate != null && Cusmodel.SalesDate != new DateTime())
                {
                    prevSalesDate = Cusmodel.SalesDate.Value.ToString("MM/dd/yyyy");
                }
                if (customer.SalesDate != null && customer.SalesDate != new DateTime())
                {
                    nextSalesDate = customer.SalesDate.Value.ToString("MM/dd/yyyy");
                }
                message += " Sales Date Updated from " + prevSalesDate + " to " + nextSalesDate + "<br>";
            }
            if (customer.InstallDate != Cusmodel.InstallDate)
            {
                string prevInstallDate = "";
                string nextInstallDate = "";
                if (Cusmodel.InstallDate != null && Cusmodel.InstallDate != new DateTime())
                {
                    prevInstallDate = Cusmodel.InstallDate.Value.ToString("MM/dd/yyyy");
                }
                if (customer.InstallDate != null && customer.InstallDate != new DateTime())
                {
                    nextInstallDate = customer.InstallDate.Value.ToString("MM/dd/yyyy");
                }
                message += " Install Date Updated from " + prevInstallDate + " to " + nextInstallDate + "<br>";
            }
            if (CusExmodel != null && customer.CustomerExtended != null && customer.CustomerExtended.ContractStartDate != CusExmodel.ContractStartDate)
            {
                string prevContractStartDate = "";
                string nextContractStartDate = "";
                if (CusExmodel.ContractStartDate != null && CusExmodel.ContractStartDate != new DateTime())
                {
                    prevContractStartDate = CusExmodel.ContractStartDate.Value.ToString("MM/dd/yyyy");
                }
                if (customer.CustomerExtended.ContractStartDate != null && customer.CustomerExtended.ContractStartDate != new DateTime())
                {
                    nextContractStartDate = customer.CustomerExtended.ContractStartDate.Value.ToString("MM/dd/yyyy");
                }
                message += " Contract Start Date Updated from " + prevContractStartDate + " to " + nextContractStartDate + "<br>";
            }
            if (customer.OriginalContactDate != Cusmodel.OriginalContactDate)
            {
                string prevOriginalContactDate = "";
                string nextOriginalContactDate = "";
                if (Cusmodel.OriginalContactDate != null && Cusmodel.OriginalContactDate != new DateTime())
                {
                    prevOriginalContactDate = Cusmodel.OriginalContactDate.Value.ToString("MM/dd/yyyy");
                }
                if (customer.OriginalContactDate != null && customer.OriginalContactDate != new DateTime())
                {
                    nextOriginalContactDate = customer.OriginalContactDate.Value.ToString("MM/dd/yyyy");
                }
                message += " Original Contact Date Updated from " + prevOriginalContactDate + " to " + nextOriginalContactDate + "<br>";
            }
            if (CusExmodel != null && customer.CustomerExtended != null && customer.CustomerExtended.CustomerSince != CusExmodel.CustomerSince)
            {
                string prevCustomerSince = "";
                string nextCustomerSince = "";
                if (CusExmodel.CustomerSince != null && CusExmodel.CustomerSince != new DateTime())
                {
                    prevCustomerSince = CusExmodel.CustomerSince.Value.ToString("MM/dd/yyyy");
                }
                if (customer.CustomerExtended.CustomerSince != null && customer.CustomerExtended.CustomerSince != new DateTime())
                {
                    nextCustomerSince = customer.CustomerExtended.CustomerSince.Value.ToString("MM/dd/yyyy");
                }
                message += " Customer Since Updated from " + prevCustomerSince + " to " + nextCustomerSince + "<br>";
            }
            if (CusExmodel != null && customer.CustomerExtended != null && customer.CustomerExtended.ResignDate != CusExmodel.ResignDate)
            {
                string prevResignDate = "";
                string nextResignDate = "";
                if (CusExmodel.ResignDate != null && CusExmodel.ResignDate != new DateTime())
                {
                    prevResignDate = CusExmodel.ResignDate.Value.ToString("MM/dd/yyyy");
                }
                if (customer.CustomerExtended.ResignDate != null && customer.CustomerExtended.ResignDate != new DateTime())
                {
                    nextResignDate = customer.CustomerExtended.ResignDate.Value.ToString("MM/dd/yyyy");
                }
                message += " Resign Date Updated from " + prevResignDate + " to " + nextResignDate + "<br>";
            }
            if (customer.RenewalTerm != Cusmodel.RenewalTerm)
            {
                message += " Renewal Term Updated from " + Cusmodel.RenewalTerm + " to " + customer.RenewalTerm + "<br>";
            }
            //if (customer.FundingDate != Cusmodel.FundingDate)
            //{
            //    message += " Payment Date Updated from " + customer.FundingDate + " to " + Cusmodel.FundingDate + "<br>";
            //}
            if (customer.IsAgreement != Cusmodel.IsAgreement)
            {
                message += " Sign Agreement Updated from " + Cusmodel.IsAgreement + " to " + customer.IsAgreement + "<br>";
            }
            if (customer.IsFireAccount != Cusmodel.IsFireAccount)
            {
                message += " Fire Account Updated from " + Cusmodel.IsFireAccount + " to " + customer.IsFireAccount + "<br>";
            }
            if (customer.CreditScoreValue != Cusmodel.CreditScoreValue)
            {
                message += " Credit Score Updated from " + Cusmodel.CreditScoreValue + " to " + customer.CreditScoreValue + "<br>";
            }
            if (customer.CreditScore != Cusmodel.CreditScore)
            {
                message += " Credit Grade Updated from " + prevcreditgradeforlog + " to " + newcreditgradeforlog + "<br>";
            }
            if (customer.ContractTeam != Cusmodel.ContractTeam)
            {
                if (customer.ContractTeam == "-1")
                {
                    customer.ContractTeam = "";
                }
                if (Cusmodel.ContractTeam == "-1")
                {
                    Cusmodel.ContractTeam = "";
                }
                message += " Contract Term Updated from " + prevcontacttermvalforlog + " to " + newcontacttermvalforlog + "<br>";
            }
            //if (customer.CustomerFunded != Cusmodel.CustomerFunded)
            //{
            //    message += " Customer Funded Updated from " + Cusmodel.CustomerFunded + " to " + customer.CustomerFunded + "<br>";
            //}
            if (customer.BillAmount != Cusmodel.BillAmount)
            {
                message += " Bill Amount Updated from " + Cusmodel.BillAmount + "$ to " + customer.BillAmount + "$" + "<br>";
            }
            if (customer.BillCycle != Cusmodel.BillCycle)
            {
                if (customer.BillCycle == "-1")
                {
                    customer.BillCycle = "";
                }
                if (Cusmodel.BillCycle == "-1")
                {
                    Cusmodel.BillCycle = "";
                }
                message += " Bill Cycle Updated from " + Cusmodel.BillCycle + " to " + customer.BillCycle + "<br>";
            }
            if (customer.BillOutStanding != Cusmodel.BillOutStanding)
            {
                message += " OutStanding Balance Updated from " + Cusmodel.BillOutStanding + " to " + customer.BillOutStanding + "<br>";
            }
            if (customer.MonthlyMonitoringFee != Cusmodel.MonthlyMonitoringFee)
            {
                message += " Monitoring Fee Updated from " + Cusmodel.MonthlyMonitoringFee + "$ to " + customer.MonthlyMonitoringFee + "$" + "<br>";
            }
            if (customer.FirstBilling != Cusmodel.FirstBilling)
            {
                message += " Start Date Updated from " + Cusmodel.FirstBilling + " to " + customer.FirstBilling + "<br>";
            }
            if (customer.PaymentMethod != Cusmodel.PaymentMethod)
            {
                if (customer.PaymentMethod == "-1")
                {
                    customer.PaymentMethod = "";
                }
                if (Cusmodel.PaymentMethod == "-1")
                {
                    Cusmodel.PaymentMethod = "";
                }
                message += " Payment Profile Updated from " + Cusmodel.PaymentMethod + " to " + customer.PaymentMethod + "<br>";
            }
            if (customer.IsReceivePaymentMail != Cusmodel.IsReceivePaymentMail)
            {
                message += " Send Email Updated from " + Cusmodel.IsReceivePaymentMail + " to " + customer.IsReceivePaymentMail + "<br>";
            }
            if (customer.BillNotes != Cusmodel.BillNotes)
            {
                message += " Bill Notes Updated from " + Cusmodel.BillNotes + " to " + customer.BillNotes + "<br>";
            }
            string updatecusid = customer.Id.ToString();
            base.AddUserActivityForCustomer("Customer Information Updated #Ref: Customer#" + customer.Id + "</br>" + message, LabelHelper.ActivityAction.UpdateCustomer, customer.CustomerId, customer.Id, updatecusid);

            #endregion
        }
        public void SendCancellationAgreement(Guid CustomerId)
        {
            var CurrentUser = (HS.Web.UI.Helper.CustomPrincipal)User;
            Customer cus = _Util.Facade.CustomerFacade.GetCustomerByCustomerId(CustomerId); ;
            List<CustomerCancellationQueue> cencellationList = _Util.Facade.CustomerFacade.GetActiveCustomerQueueCancellationByCustomerId(CustomerId);
            if (cencellationList.Count > 0)
            {

                cus.CancellationSignature = "";
                _Util.Facade.CustomerFacade.UpdateCustomer(cus);
                // base.AddUserActivityForCustomer("Customer Information Updated", LabelHelper.ActivityAction.AddCustomer, cus.CustomerId, cus.Id);
                foreach (var item in cencellationList)
                {
                    item.IsActive = false;
                    item.IsSigned = false;
                    _Util.Facade.CustomerFacade.UpdateCustomerCancellationQueue(item);
                }

            }
            try
            {


                DateTime now = DateTime.Now;
                var startDate = new DateTime(now.Year, now.Month, 1);
                var endDate = startDate.AddMonths(1).AddDays(-1);

                CustomerCancellationQueue Model = new CustomerCancellationQueue()
                {
                    CancellationId = Guid.NewGuid(),
                    CustomerId = CustomerId,
                    CreatedBy = CurrentUser.UserId,
                    CreatedDate = DateTime.Now,
                    CancellationDate = endDate,
                    RemainingBalance = 0,
                    Reason = "",
                    IsSigned = false,
                    IsActive = true,
                    EmployeeReason = "Replacement"
                };
                _Util.Facade.CustomerFacade.InsertCustomerCancellationQueue(Model);
                var CustomerDetails = _Util.Facade.CustomerFacade.GetCustomerByCustomerId(CustomerId);
                if (CustomerDetails != null)
                {
                    CustomerDetails.CustomerStatus = "11";
                    _Util.Facade.CustomerFacade.UpdateCustomer(CustomerDetails);
                }
                //string BodyContent = @"<div style='width: 100%; float: left; box-sizing: border-box; padding: 0px 100px; font-size: 12px; font-family: Verdana;'>
                //                    <table style='border-collapse: collapse; width: 100%; float: left; table-layout: fixed;'>
                //                    <tbody>
                //                    <tr>
                //                    <td style='width: 32%; text-align: center;' valign='top'><img style='width: 170px; height: 110px;' src='##CompanyLogo##' alt='Company Logo' /></td>
                //                    </tr>
                //                    <tr>
                //                    <td style='font-size: 20px; box-sizing: border-box; text-align: center; padding-top: 20px;'>2533 E Loop 820 North, Fort Worth, TX 76118 <br />Ph: 877-372-0350 Fax: 817-281-0113 <br />service@dfwsecurity.com <br />Texas License B08964</td>
                //                    </tr>
                //                    <tr>
                //                    <td style='box-sizing: border-box; text-align: left;'>
                //                    <div style='padding: 20px 0px;'>##GenerationDate##</div>
                //                    </td>
                //                    </tr>
                //                    <tr>
                //                    <td style='box-sizing: border-box; text-align: left;'>This letter is to serve as written notification to DFW Security that ##FirstName## ##LastName## wishes to terminate service at ##InstallAddress## at the end of term on ##TermDate##. <br /><br />I understand that the balance remaining on the contract is <br />$##RemainingBalance## and must be paid in full by ##TermDate## in order for the <br />contract to be cancelled.</td>
                //                    </tr>
                //                    <tr>
                //                    <td style='font-size: 20px; font-weight: bold; box-sizing: border-box; text-align: left; padding: 20px 0px;'>Please Select the Reason for cancellation:</td>
                //                    </tr>
                //                    <tr>
                //                    <td style='box-sizing: border-box; text-align: left;'><input type='checkbox' /> &nbsp;Customer service<br /><br /><input type='checkbox' /> &nbsp;Alarm performance<br /><br /><input type='checkbox' /> &nbsp;Cost of service too high<br /><br /><input type='checkbox' /> &nbsp;Sold business<br /><br /><input type='checkbox' /> &nbsp;Moving outside of DFW area<br /><br /><input checked='checked' type='checkbox' /> &nbsp;Moving inside DFW area<br /><br /><input type='checkbox' /> &nbsp;Going with another provider<br /><br /><input type='checkbox' /> &nbsp; Do not use system</td>
                //                    </tr>
                //                    <tr>
                //                    <td style='box-sizing: border-box; text-align: left; padding: 40px 0px; font-size: 20px; font-style: italic; font-family: Tahoma;'>DFW Security is always looking for ways to improve the customer experience. Please list any additional comments below:</td>
                //                    </tr>
                //                    <tr>
                //                    <td style='box-sizing: border-box; text-align: left; padding: 0px 0px 40px; font-size: 20px; font-family: Tahoma;'>&nbsp;</td>
                //                    </tr>
                //                    <tr>
                //                    <td style='box-sizing: border-box; text-align: left;'>Please electronically sign and return this document or print and mail to address above. Cancellation will not be processed without signed request from account holder.</td>
                //                    </tr>
                //                    <tr>
                //                    <td style='padding-top: 30px;'><img style='width: 170px; height: 110px;' src='##CustomerSignature##' alt='' /></td>
                //                    </tr>
                //                    <tr>
                //                    <td style='box-sizing: border-box; text-align: left; padding: 20px 0px; padding-top: 10px;'><span style='border-top: 1px solid #000;'>Please sign here</span></td>
                //                    </tr>
                //                    </tbody>
                //                    </table>
                //                    </div>";
                //CustomerAgreementTemplate tempet = new CustomerAgreementTemplate();
                //tempet.CompanyId = CurrentUser.CompanyId.Value;
                //tempet.ReferenceTemplateId = 35;
                //tempet.CustomerId = CustomerId;
                //tempet.Name = "Cancellation";
                //tempet.IsFileTemplate = true;
                //tempet.BodyContent = BodyContent;
                //tempet.Description = "Cancellation";
                //tempet.CreatedBy = CurrentUser.UserId;
                //tempet.CreatedDate = DateTime.Now.UTCCurrentTime();
                //tempet.LastUpdatedBy = CurrentUser.UserId;
                //tempet.LastUpdatedDate = DateTime.Now.UTCCurrentTime();
                //long temId = _Util.Facade.FileFacade.InsertCustomerAgreementTemplate(tempet);
                //int? fileId = Convert.ToInt32(temId);
                //FileToCustomerPDFMail(cus.Id, cus.EmailAddress, fileId);
            }
            catch (Exception ex)
            {

            }



        }

        protected override void ExecuteCore() { }
        public static string RenderViewToString(string controllerName, string viewName, object viewData)
        {
            using (var writer = new StringWriter())
            {
                var routeData = new RouteData();
                routeData.Values.Add("controller", controllerName);
                var fakeControllerContext = new ControllerContext(new HttpContextWrapper(new HttpContext(new HttpRequest(null, "http://google.com", null), new HttpResponse(null))), routeData, new TemplateController());
                var razorViewEngine = new RazorViewEngine();
                var razorViewResult = razorViewEngine.FindView(fakeControllerContext, viewName, "", false);

                var viewContext = new ViewContext(fakeControllerContext, razorViewResult.View, new ViewDataDictionary(viewData), new TempDataDictionary(), writer);
                razorViewResult.View.Render(viewContext, writer);
                return writer.ToString();

            }
        }

        public bool GenerateCustsomerList()
        {
            var CurrentUser = (HS.Web.UI.Helper.CustomPrincipal)(User);

            List<GridSetting> GridSettings = new List<GridSetting>();
            GridSettings = _Util.Facade.GridSettingsFacade.GetByKey("CustomerGrid", CurrentUser.CompanyId.Value);
            if (GridSettings.Count > 0)
            {
                GridSettings = GridSettings.OrderBy(x => x.OrderBy).Where(x => x.GridActive == true).ToList();
            }
            List<GridSetting> GridGroupSettings = new List<GridSetting>();
            GridGroupSettings = _Util.Facade.GridSettingsFacade.GetByKey("CustomerGridGroup", CurrentUser.CompanyId.Value);
            if (GridGroupSettings.Count > 0)
            {
                GridGroupSettings = GridGroupSettings.OrderBy(x => x.OrderBy).Where(x => x.GridActive == true).ToList();
            }
            FinalGrid fgrid = new FinalGrid();
            fgrid.GridSetting = GridSettings;
            fgrid.GridGroupSetting = GridGroupSettings;
            //string html = this.RenderViewToString("~/Views/Customer/_GenerateCustomerList.cshtml", GridGroupSettings);
            String renderedHTML = RenderViewToString("Template", "~/Views/Customer/_GenerateCustomerList.cshtml", fgrid);
            string path = Server.MapPath(string.Format(AppConfig.CustomerTemplateFile, CurrentUser.CompanyId.ToString()));

            if (!System.IO.File.Exists(path))
            {
                using (FileStream fs = new FileStream(path,
               FileMode.Create,
               FileAccess.ReadWrite,
               FileShare.None))
                {
                    fs.Close();
                    System.IO.File.WriteAllText(path, renderedHTML);
                }
            }
            else if (System.IO.File.Exists(path))
            {
                System.IO.File.WriteAllText(path, renderedHTML);
            }

            return true;
        }

        #region Geese Relief
        public ActionResult CustomerRoutePartial()
        {
            var CurrentUser = ((HS.Web.UI.Helper.CustomPrincipal)(User));
            return View("CustomerRoutePartial");
        }
        public ActionResult CustomerRoutePartialList(int pageno, int pagesize)
        {
            var CurrentUser = ((HS.Web.UI.Helper.CustomPrincipal)(User));
            DateTime StartDate = new DateTime();
            DateTime EndDate = new DateTime();
            string newCookie = "";


            if (Request.Cookies[CookieKeys.DateViewFilter] != null && !string.IsNullOrWhiteSpace(Request.Cookies[CookieKeys.DateViewFilter].Value))
            {
                newCookie = Request.Cookies[CookieKeys.DateViewFilter].Value;
                newCookie = Server.UrlDecode(newCookie);
                var CookieVals = newCookie.Split(',');

                if (CookieVals.Length == 3)
                {
                    StartDate = CookieVals[0].ToDateTime().SetZeroHour();
                    EndDate = CookieVals[1].ToDateTime().SetMaxHour();
                }
            }

            RouteListModel model = new RouteListModel();
            if (CurrentUser.UserRole == "Employee")
            {
                model = _Util.Facade.CustomerFacade.GetAllCustomerRoutes(pageno, pagesize, CurrentUser.UserId);
            }
            else
            {
                model = _Util.Facade.CustomerFacade.GetAllCustomerRoutes(pageno, pagesize, new Guid());
            }


            ViewBag.EmployeeRole = CurrentUser.UserRole;
            ViewBag.PageNumber = pageno;
            ViewBag.OutOfNumber = 0;
            if (model.Total.TotalRecord > 0)
            {
                ViewBag.OutOfNumber = model.Total.TotalRecord;
            }

            if ((int)ViewBag.PageNumber * pagesize > (int)ViewBag.OutOfNumber)
            {
                ViewBag.CurrentNumber = (int)ViewBag.OutOfNumber;
            }
            else
            {
                ViewBag.CurrentNumber = (int)ViewBag.PageNumber * pagesize;
            }
            ViewBag.PageCount = Math.Ceiling((double)ViewBag.OutOfNumber / pagesize);
            return View(model);
        }
        public ActionResult AddRoute(int? Id)
        {
            var CurrentUser = ((HS.Web.UI.Helper.CustomPrincipal)(User));
            GeeseRoute Route = new GeeseRoute();
            if (Id > 0)
            {
                Route = _Util.Facade.CustomerFacade.GetRouteById(Id.Value);
            }
            return View(Route);
        }

        public JsonResult SaveRoute(string Name, int? Id)
        {
            var CurrentUser = ((HS.Web.UI.Helper.CustomPrincipal)(User));
            bool result = false;

            if (CurrentUser == null)
            {
                return Json(result);
            }
            if (!CurrentUser.CompanyId.HasValue)
            {
                return Json(result);
            }
            GeeseRoute Route = new GeeseRoute();
            if (Id > 0)
            {
                Route = _Util.Facade.CustomerFacade.GetRouteById(Id.Value);
                if (Route != null)
                {
                    Route.Name = Name;
                    Route.UpdatedBy = CurrentUser.UserId;
                    Route.UpdatedDate = DateTime.UtcNow;

                    _Util.Facade.CustomerFacade.UpdateRoute(Route);
                    result = _Util.Facade.CustomerFacade.UpdateCustomerRouteByRouteId(Route.RouteId, Name);
                }
            }
            else
            {
                Route = new GeeseRoute()
                {
                    RouteId = Guid.NewGuid(),
                    Name = Name,
                    CreatedBy = CurrentUser.UserId,
                    CreatedDate = DateTime.UtcNow,
                    UpdatedBy = new Guid(),
                    UpdatedDate = DateTime.UtcNow
                };
                Route.Id = (int)_Util.Facade.CustomerFacade.InsertGeeseRoute(Route);
                result = true;
            }

            return Json(result);
        }

        public JsonResult DeleteRoute(Guid RouteId)
        {
            var CurrentUser = ((HS.Web.UI.Helper.CustomPrincipal)(User));
            bool result = false;

            if (CurrentUser == null)
            {
                return Json(result);
            }
            if (!CurrentUser.CompanyId.HasValue)
            {
                return Json(result);
            }
            if (RouteId != null)
            {
                result = _Util.Facade.CustomerFacade.DeleteRouteByRouteId(RouteId);
            }
            return Json(result);
        }

        public ActionResult RouteCustomerList(Guid RouteId)
        {
            var CurrentUser = ((HS.Web.UI.Helper.CustomPrincipal)(User));

            RouteCustomerListModel model = new RouteCustomerListModel();

            model = _Util.Facade.CustomerFacade.GetCustomerByRouteId(RouteId);

            return View(model);
        }

        public ActionResult CustomerMediaNoteDetails(Guid CustomerId)
        {
            var CurrentUser = ((HS.Web.UI.Helper.CustomPrincipal)(User));
            GeeseMediaNoteDetails Model = new GeeseMediaNoteDetails();
            if (CustomerId != null)
            {
                Customer Cus = _Util.Facade.CustomerFacade.GetCustomerByCustomerId(CustomerId);
                ViewBag.CustomerName = Cus.FirstName + ' ' + Cus.LastName;
                ViewBag.CustomerId = Cus.Id;
                if (Cus != null)
                {
                    Model = _Util.Facade.CustomerFileFacade.GetMediaANdNoteListByCustomerId(Cus.CustomerId);
                }
            }

            return PartialView("CustomerMediaNoteDetails", Model);
        }
        public ActionResult GeeseCustomerAddressMap()
        {
            return PartialView("CustomerAddressMap");
        }
        #endregion

        #region RMR Overview
        public ActionResult RMROverview(Guid CustomerId)
        {
            var currentLoggedIn = ((HS.Web.UI.Helper.CustomPrincipal)(User));

            RMROverviewModel model = _Util.Facade.CustomerFacade.GetRMROverview(CustomerId, currentLoggedIn.CompanyId.Value);
            if (model != null)
            {
                DateTime LastPayment = model.LastPayment;
                ViewBag.DayOfPastDue = (DateTime.Now.Date - LastPayment.Date).Days;
                return View(model);
            }

            return View();
        }
        #endregion
    }

}


